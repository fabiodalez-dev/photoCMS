<div class="strip-sparse">
  {% for image in images %}
    {% set href = image.lightbox_url|default(image.url) %}
    {% set img_src = image.fallback_src|default(image.url) %}
    {% set resolved_src = img_src starts with '/' ? base_path ~ img_src : img_src %}
    {% set resolved_href = href starts with '/' ? base_path ~ href : href %}
    <article class="strip-sparse-item" style="--sg-w: {{ image.width|default(3)|e('html_attr') }}; --sg-h: {{ image.height|default(2)|e('html_attr') }};" data-shift>
      <a href="{{ resolved_href|e('html_attr') }}"
         class="pswp-link strip-sparse-link"
         aria-label="{{ image.alt_text|default(image.alt)|default('Open image in lightbox')|e('html_attr') }}"
         data-image-id="{{ image.id|e('html_attr') }}"
         data-pswp-width="{{ image.width|default(1600)|e('html_attr') }}"
         data-pswp-height="{{ image.height|default(1067)|e('html_attr') }}"
         data-pswp-caption="{{ image.caption|default('')|e('html_attr') }}">
        <img src="{{ resolved_src|e('html_attr') }}"
             alt="{{ image.alt_text|default(image.alt)|default('')|e('html_attr') }}"
             width="{{ image.width|default(1600) }}"
             height="{{ image.height|default(1067) }}"
             loading="lazy"
             decoding="async">
      </a>
    </article>
  {% endfor %}
</div>

<script nonce="{{ csp_nonce() }}">
const sparseItems = Array.from(document.querySelectorAll('.strip-sparse-item[data-shift]'));
if (sparseItems.length) {
  const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  const desktopQuery = window.matchMedia('(min-width: 1024px)');
  const applyShift = () => {
    const isDesktop = desktopQuery.matches;
    if (!isDesktop || prefersReduced) {
      sparseItems.forEach((item) => item.style.transform = 'translateX(0px)');
      return;
    }
    const scrollY = window.scrollY || window.pageYOffset || 0;
    sparseItems.forEach((item, index) => {
      const dir = index % 2 === 0 ? 1 : -1;
      const base = 40 + (index % 5) * 18;
      const drift = Math.sin((scrollY + index * 120) / 380) * base;
      item.style.transform = `translateX(${dir * drift}px)`;
    });
  };
  applyShift();
  if (desktopQuery.matches && !prefersReduced) {
    window.addEventListener('scroll', () => window.requestAnimationFrame(applyShift), { passive: true });
  }
  window.addEventListener('resize', applyShift);
}
</script>
