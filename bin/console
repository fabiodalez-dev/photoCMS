#!/usr/bin/env php
<?php
declare(strict_types=1);

require __DIR__ . '/../vendor/autoload.php';

use Symfony\Component\Console\Application;

// Check if we're running the install command
$argv = $_SERVER['argv'];
$isInstallCommand = in_array('install', $argv) || in_array('i', $argv);

if ($isInstallCommand) {
    // For install command, create application without database dependencies
    $cli = new Application('Cimaise CLI', '0.1.0');
    $cli->add(new App\Tasks\InstallCommand());
} else {
    // For other commands, load container with database
    $container = require __DIR__ . '/../app/Config/bootstrap.php';
    
    $cli = new Application('Cimaise CLI', '0.1.0');
    
    $cli->add(new App\Tasks\DbTestCommand($container['db']));
    $cli->add(new App\Tasks\MigrateCommand($container['db'], __DIR__ . '/../database/migrations'));
    $cli->add(new App\Tasks\SeedCommand($container['db'], __DIR__ . '/../database/seeds'));
    $cli->add(new App\Tasks\UserCreateCommand($container['db']));
    $cli->add(new App\Tasks\UserUpdateCommand($container['db']));
    $cli->add(new App\Tasks\ImagesGenerateCommand($container['db']));
    $cli->add(new App\Tasks\ImagesGenerateVariantsCommand($container['db']));
    $cli->add(new App\Tasks\DiagnosticsCommand($container['db']));
    $cli->add(new App\Tasks\SitemapCommand($container['db']));
    $cli->add(new App\Tasks\InitCommand($container['db']));
    $cli->add(new App\Tasks\NormalizeMediaPathsCommand($container['db']));
    $cli->add(new App\Tasks\NsfwBlurGenerateCommand($container['db']));
    $cli->add(new App\Tasks\InstallCommand());
}

$cli->run();
