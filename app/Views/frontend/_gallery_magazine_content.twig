{# Magazine Split gallery content (partial) - Improved Responsive Version #}
{% macro pic(image, base_path, album) %}
  <picture class="block w-full h-full">
    {% if image.sources is defined and image.sources.avif is defined and image.sources.avif|length %}
      <source type="image/avif" srcset="{% for s in image.sources.avif %}{% set p = s|split(' ') %}{{ p[0] starts with('/') ? (base_path ~ p[0]) : p[0] }} {{ p[1]|default('1x') }}{% if not loop.last %}, {% endif %}{% endfor %}" sizes="(min-width:1200px) 33vw, (min-width:768px) 50vw, 100vw">
    {% endif %}
    {% if image.sources is defined and image.sources.webp is defined and image.sources.webp|length %}
      <source type="image/webp" srcset="{% for s in image.sources.webp %}{% set p = s|split(' ') %}{{ p[0] starts with('/') ? (base_path ~ p[0]) : p[0] }} {{ p[1]|default('1x') }}{% if not loop.last %}, {% endif %}{% endfor %}" sizes="(min-width:1200px) 33vw, (min-width:768px) 50vw, 100vw">
    {% endif %}
    {% if image.sources is defined and image.sources.jpg is defined and image.sources.jpg|length %}
      <source type="image/jpeg" srcset="{% for s in image.sources.jpg %}{% set p = s|split(' ') %}{{ p[0] starts with('/') ? (base_path ~ p[0]) : p[0] }} {{ p[1]|default('1x') }}{% if not loop.last %}, {% endif %}{% endfor %}" sizes="(min-width:1200px) 33vw, (min-width:768px) 50vw, 100vw">
    {% endif %}
    {% set img_src = image.fallback_src|default(image.url) %}
    <img src="{{ img_src starts with('/') ? (base_path ~ img_src) : img_src }}" alt="{{ image.alt|e }}" class="w-full h-full object-cover" loading="lazy" decoding="async">
  </picture>
{% endmacro %}

{% import _self as G %}

{# Distribuzione intelligente delle immagini per responsive #}
{% set col1 = [] %}{% set col2 = [] %}{% set col3 = [] %}
{% for i, image in images %}
  {% set indexed_image = image|merge({'original_index': i}) %}
  {% if i % 3 == 0 %}{% set col1 = col1|merge([indexed_image]) %}
  {% elseif i % 3 == 1 %}{% set col2 = col2|merge([indexed_image]) %}
  {% else %}{% set col3 = col3|merge([indexed_image]) %}
  {% endif %}
{% endfor %}

{# Due colonne per tablet #}
{% set tablet_col1 = [] %}{% set tablet_col2 = [] %}
{% for i, image in images %}
  {% set indexed_image = image|merge({'original_index': i}) %}
  {% if i % 2 == 0 %}{% set tablet_col1 = tablet_col1|merge([indexed_image]) %}
  {% else %}{% set tablet_col2 = tablet_col2|merge([indexed_image]) %}
  {% endif %}
{% endfor %}

{% set mag = template_settings.magazine|default({}) %}
{% set durs = mag.durations|default([90,110,130]) %} {# Rallentate per mobile, moderate per desktop #}
{% set gap = mag.gap|default(20) %}

<div class="relative pswp-gallery">
  {# Mobile: Una colonna con tutte le immagini #}
  <div class="m-mobile-wrap" style="--m-duration: {{ durs[0]|default(90) }}s">
    <div class="m-mobile">
      <div class="m-mobile-track">
        {% for image in images %}
          <div class="m-cell">
            <a href="{{ image.lightbox_url|default(image.url) }}" class="pswp-link m-item block overflow-hidden rounded-lg shadow-sm hover:shadow-xl transition-all duration-300 bg-white" data-pswp-width="{{ image.width|default(1600) }}" data-pswp-height="{{ image.height|default(1067) }}" data-pswp-caption="{{ image.caption_html|default(image.caption)|e('html_attr') }}" data-pswp-index="{{ loop.index0 }}">
              {{ G.pic(image, base_path, album) }}
            </a>
          </div>
        {% endfor %}
        {% for image in images %}
          <div class="m-cell">
            <a href="{{ image.lightbox_url|default(image.url) }}" class="pswp-link m-item pswp-is-duplicate block overflow-hidden rounded-lg shadow-sm hover:shadow-xl transition-all duration-300 bg-white" data-pswp-width="{{ image.width|default(1600) }}" data-pswp-height="{{ image.height|default(1067) }}" data-pswp-caption="{{ image.caption_html|default(image.caption)|e('html_attr') }}" data-pswp-index="{{ loop.index0 }}">
              {{ G.pic(image, base_path, album) }}
            </a>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>

  {# Tablet: Due colonne #}
  <div class="m-tablet-wrap gap-4 perspective-tablet" style="gap: {{ gap * 0.7 }}px">
    {% set tablet_cols = [tablet_col1, tablet_col2] %}
    {% for col in tablet_cols %}
      {% set idx = loop.index0 %}
      {% set dur = (durs[idx]|default(50) + 5) ~ 's' %}
      {% set dir = idx == 1 ? 'up' : 'down' %}
      <div class="m-col m-tablet-col" data-direction="{{ dir }}" style="--m-duration: {{ dur }}; --m-delay: 0s;">
        <div class="m-track">
          {% for image in col %}
            <div class="m-cell">
              <a href="{{ image.lightbox_url|default(image.url) }}" class="pswp-link m-item block overflow-hidden rounded-lg shadow-sm hover:shadow-xl transition-all duration-300 bg-white" data-pswp-width="{{ image.width|default(1600) }}" data-pswp-height="{{ image.height|default(1067) }}" data-pswp-caption="{{ image.caption_html|default(image.caption)|e('html_attr') }}" data-pswp-index="{{ image.original_index|default(loop.index0) }}">
                {{ G.pic(image, base_path, album) }}
              </a>
            </div>
          {% endfor %}
          {% for image in col %}
            <div class="m-cell">
              <a href="{{ image.lightbox_url|default(image.url) }}" class="pswp-link m-item pswp-is-duplicate block overflow-hidden rounded-lg shadow-sm hover:shadow-xl transition-all duration-300 bg-white" data-pswp-width="{{ image.width|default(1600) }}" data-pswp-height="{{ image.height|default(1067) }}" data-pswp-caption="{{ image.caption_html|default(image.caption)|e('html_attr') }}" data-pswp-index="{{ image.original_index|default(loop.index0) }}">
                {{ G.pic(image, base_path, album) }}
              </a>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endfor %}
  </div>

  {# Desktop: Tre colonne #}
  <div class="m-desktop-wrap gap-6 perspective" style="gap: {{ gap }}px">
    {% set cols = [col1, col2, col3] %}
    {% for col in cols %}
      {% set idx = loop.index0 %}
      {% set dur = durs[idx]|default(60) ~ 's' %}
      {% set dir = idx == 1 ? 'up' : 'down' %}
      <div class="m-col m-desktop-col" data-direction="{{ dir }}" style="--m-duration: {{ dur }}; --m-delay: 0s;">
        <div class="m-track">
          {% for image in col %}
            <div class="m-cell">
              <a href="{{ image.lightbox_url|default(image.url) }}" class="pswp-link m-item block overflow-hidden rounded-lg shadow-sm hover:shadow-xl transition-all duration-300 bg-white" data-pswp-width="{{ image.width|default(1600) }}" data-pswp-height="{{ image.height|default(1067) }}" data-pswp-caption="{{ image.caption_html|default(image.caption)|e('html_attr') }}" data-pswp-index="{{ image.original_index|default(loop.index0) }}">
                {{ G.pic(image, base_path, album) }}
              </a>
            </div>
          {% endfor %}
          {% for image in col %}
            <div class="m-cell">
              <a href="{{ image.lightbox_url|default(image.url) }}" class="pswp-link m-item pswp-is-duplicate block overflow-hidden rounded-lg shadow-sm hover:shadow-xl transition-all duration-300 bg-white" data-pswp-width="{{ image.width|default(1600) }}" data-pswp-height="{{ image.height|default(1067) }}" data-pswp-caption="{{ image.caption_html|default(image.caption)|e('html_attr') }}" data-pswp-index="{{ image.original_index|default(loop.index0) }}">
                {{ G.pic(image, base_path, album) }}
              </a>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endfor %}
  </div>
  
  {# Veli migliorati per fade effect - positioning più preciso #}
  <div class="pointer-events-none absolute inset-x-0 -top-1 h-40 z-20 masonry-veil-top"></div>
  <div class="pointer-events-none absolute inset-x-0 -bottom-1 h-40 z-20 masonry-veil-bottom"></div>
</div>

<style>
/* Responsive Magazine Layout */
.m-mobile-wrap { display: block; }
.m-tablet-wrap { display: none; }
.m-desktop-wrap { display: none; }

/* Tablet: 768px - 1199px */
@media (min-width: 768px) and (max-width: 1199px) {
  .m-mobile-wrap { display: none !important; }
  .m-tablet-wrap { display: flex !important; }
  .m-desktop-wrap { display: none !important; }
}

/* Desktop: 1200px+ */
@media (min-width: 1200px) {
  .m-mobile-wrap { display: none !important; }
  .m-tablet-wrap { display: none !important; }
  .m-desktop-wrap { display: flex !important; }
}

/* Perspective effects */
.perspective { transform: perspective(1200px) rotateX(0.8deg); }
.perspective-tablet { transform: perspective(1000px) rotateX(0.6deg); }

/* Mobile: singola colonna con tutte le immagini */
.m-mobile { overflow: hidden; height: 200vh; position: relative; }
.m-mobile-track { 
  will-change: transform; 
  animation: mScrollDown var(--m-duration) linear infinite;
  animation-play-state: running;
  position: absolute;
  top: 0;
  width: 100%;
}

/* Base styles per tutte le colonne */
.m-cell { 
  break-inside: avoid; 
  margin-bottom: 1.25rem; 
  position: relative;
}

.m-col { 
  position: relative; 
  flex: 1 1 0; 
  height: 140vh; 
  overflow: hidden; 
}

.m-track { 
  position: absolute; 
  top: 0; 
  left: 0; 
  right: 0; 
  will-change: transform;
}

/* Item styles migliorati */
.m-item { 
  width: 100%; 
  height: 100%; 
  transition: transform .3s cubic-bezier(.25,.8,.25,1), box-shadow .3s ease;
  border-radius: 12px;
  overflow: hidden;
}

.m-item:hover { 
  transform: translateZ(0) scale(1.015); 
  box-shadow: 0 20px 40px rgba(0,0,0,.15);
}

.m-item img { 
  backface-visibility: hidden;
  transition: transform .3s ease;
}

/* Animazioni con partenza immediata */
.m-col[data-direction="down"] .m-track,
.m-mobile-track { 
  animation: mScrollDown var(--m-duration) linear infinite;
  animation-delay: 0s; /* Partenza immediata */
  animation-play-state: running;
}

.m-col[data-direction="up"] .m-track { 
  animation: mScrollUp var(--m-duration) linear infinite;
  animation-delay: 0s; /* Partenza immediata */
  animation-play-state: running;
}

@keyframes mScrollDown { 
  0% { transform: translateY(0); } 
  100% { transform: translateY(-50%); } 
}

@keyframes mScrollUp { 
  0% { transform: translateY(-50%); } 
  100% { transform: translateY(0); } 
}

/* Veli migliorati con gradiente più morbido e visibile su mobile */
.masonry-veil-top {
  background: linear-gradient(180deg, 
    rgba(255,255,255,0.98) 0%,
    rgba(255,255,255,0.92) 25%,
    rgba(255,255,255,0.75) 50%,
    rgba(255,255,255,0.45) 75%,
    rgba(255,255,255,0.15) 90%,
    rgba(255,255,255,0) 100%
  );
  z-index: 30 !important;
}

.masonry-veil-bottom {
  background: linear-gradient(0deg, 
    rgba(255,255,255,0.98) 0%,
    rgba(255,255,255,0.92) 25%,
    rgba(255,255,255,0.75) 50%,
    rgba(255,255,255,0.45) 75%,
    rgba(255,255,255,0.15) 90%,
    rgba(255,255,255,0) 100%
  );
  z-index: 30 !important;
}

/* Veli più evidenti su mobile */
@media (max-width: 767px) {
  .masonry-veil-top {
    height: 60px !important;
    background: linear-gradient(180deg, 
      rgba(255,255,255,1) 0%,
      rgba(255,255,255,0.95) 30%,
      rgba(255,255,255,0.8) 60%,
      rgba(255,255,255,0.4) 80%,
      rgba(255,255,255,0) 100%
    );
  }
  
  .masonry-veil-bottom {
    height: 60px !important;
    background: linear-gradient(0deg, 
      rgba(255,255,255,1) 0%,
      rgba(255,255,255,0.95) 30%,
      rgba(255,255,255,0.8) 60%,
      rgba(255,255,255,0.4) 80%,
      rgba(255,255,255,0) 100%
    );
  }
}

/* Hover effects */
.pswp-gallery:hover .m-track { 
  animation-play-state: paused; 
}

/* Performance optimizations */
.m-track { 
  backface-visibility: hidden; 
  transform-style: preserve-3d; 
}

/* Mobile adjustments */
@media (max-width: 767px) {
  .perspective, .perspective-tablet { transform: none; }
  .m-mobile { height: 100vh; }
  .m-cell { margin-bottom: 1rem; }
}

/* Tablet specific adjustments */
@media (min-width: 768px) and (max-width: 1199px) {
  .m-col { height: 130vh; }
}

/* Accessibility: respect reduced motion */
@media (prefers-reduced-motion: reduce) {
  .m-track, .m-mobile-track {
    animation-duration: 200s !important;
  }
}
</style>

<script>
window.templateSettings = {{ template_settings|json_encode|raw }};

// Responsive Magazine Initialization
document.addEventListener('DOMContentLoaded', function(){
  console.log('Magazine Split: Initializing responsive layout');
  
  // Force immediate animation start for all tracks
  function startAnimations() {
    // Mobile track
    const mobileTrack = document.querySelector('.m-mobile-track');
    if (mobileTrack) {
      const mobileDur = getComputedStyle(mobileTrack.closest('.m-mobile-wrap')).getPropertyValue('--m-duration').trim() || '45s';
      mobileTrack.style.animation = `mScrollDown ${mobileDur} linear infinite`;
      mobileTrack.style.animationPlayState = 'running';
      console.log('Mobile track animated:', mobileDur);
    }
    
    // All column tracks (tablet + desktop)
    document.querySelectorAll('.m-col .m-track').forEach(function(track){
      const col = track.closest('.m-col');
      if (!col) return;
      
      const dir = (col.getAttribute('data-direction') || 'down').toLowerCase();
      const dur = getComputedStyle(col).getPropertyValue('--m-duration').trim() || '60s';
      const anim = (dir === 'up' ? 'mScrollUp' : 'mScrollDown') + ' ' + dur + ' linear infinite';
      
      track.style.animation = anim;
      track.style.animationPlayState = 'running';
      console.log(`${col.classList.contains('m-tablet-col') ? 'Tablet' : 'Desktop'} track animated:`, dir, dur);
    });
  }
  
  // Start animations immediately
  startAnimations();
  
  // Responsive visibility management
  function updateResponsiveDisplay() {
    const isMobile = window.matchMedia('(max-width: 767px)').matches;
    const isTablet = window.matchMedia('(min-width: 768px) and (max-width: 1199px)').matches;
    const isDesktop = window.matchMedia('(min-width: 1200px)').matches;
    
    const mobile = document.querySelector('.m-mobile-wrap');
    const tablet = document.querySelector('.m-tablet-wrap');
    const desktop = document.querySelector('.m-desktop-wrap');
    
    if (mobile) mobile.style.display = isMobile ? 'block' : 'none';
    if (tablet) tablet.style.display = isTablet ? 'flex' : 'none';
    if (desktop) desktop.style.display = isDesktop ? 'flex' : 'none';
    
    console.log('Magazine Split responsive update:', {isMobile, isTablet, isDesktop});
  }
  
  // Initialize responsive display
  updateResponsiveDisplay();
  
  // Listen for resize events
  let resizeTimeout;
  window.addEventListener('resize', function() {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
      updateResponsiveDisplay();
      startAnimations(); // Restart animations after resize
    }, 250);
  });
  
  // Performance optimizations: pause when out of viewport
  if ('IntersectionObserver' in window) {
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        const tracks = entry.target.querySelectorAll('.m-track, .m-mobile-track');
        tracks.forEach(track => {
          track.style.animationPlayState = entry.isIntersecting ? 'running' : 'paused';
        });
      });
    }, { threshold: 0.1 });
    
    const gallery = document.querySelector('.pswp-gallery');
    if (gallery) observer.observe(gallery);
  }
  
  // Custom lightbox initialization to handle duplicate items
  function initCustomLightbox() {
    const links = document.querySelectorAll('.pswp-link:not(.pswp-is-duplicate)'); // Solo i link originali
    if (!links.length) return;
    
    links.forEach((link, index) => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        
        // Build gallery items from non-duplicate links only
        const items = Array.from(links).map(l => ({
          src: l.href,
          width: parseInt(l.dataset.pswpWidth) || 1600,
          height: parseInt(l.dataset.pswpHeight) || 1067,
          title: l.dataset.pswpCaption || ''
        }));
        
        if (typeof PhotoSwipe !== 'undefined') {
          const pswp = new PhotoSwipe({
            gallery: items,
            index: index,
            showHideOpacity: true,
            bgOpacity: 0.8
          });
          pswp.init();
        }
      });
    });
    
    // Handle clicks on duplicate items - redirect to original
    document.querySelectorAll('.pswp-is-duplicate').forEach(duplicate => {
      duplicate.addEventListener('click', function(e) {
        e.preventDefault();
        const originalIndex = parseInt(this.dataset.pswpIndex);
        const originalLink = document.querySelector(`.pswp-link:not(.pswp-is-duplicate)[data-pswp-index="${originalIndex}"]`);
        if (originalLink) {
          originalLink.click();
        }
      });
    });
  }
  
  // Initialize custom lightbox
  try { 
    if (typeof PhotoSwipe !== 'undefined') {
      initCustomLightbox();
    } else if (typeof initLightbox === 'function') {
      initLightbox(); 
    }
  } catch(e) { 
    console.error('PhotoSwipe init error:', e); 
  }
});
</script>
