{% extends "frontend/_layout.twig" %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Hero section -->
    <div class="text-center py-12 md:py-20">
        <h1 class="text-4xl md:text-6xl font-light text-black mb-6">
            Portfolio
        </h1>
        <p class="text-lg md:text-xl text-neutral-600 max-w-2xl mx-auto leading-relaxed">
            A collection of analog and digital photography exploring light, form, and the beauty of everyday moments.
        </p>
    </div>

    {% if all_images|length > 0 %}
    <!-- Floating Gallery - Organic & Elegant -->
    <section class="home-infinite-section relative mb-32 overflow-hidden" style="height: 120vh;">
        <!-- Soft white veils (top/bottom) to fade into nothingness -->
        <div class="pointer-events-none absolute inset-x-0 top-0 h-16 z-20 home-veil-top"></div>
        <div class="pointer-events-none absolute inset-x-0 bottom-0 h-16 z-20 home-veil-bottom"></div>

        {% macro home_pic(image, base_path, priority=false) %}
            <picture class="block w-full h-full">
                {% if image.sources is defined and image.sources.avif is defined and image.sources.avif|length %}
                    <source type="image/avif" srcset="{% for s in image.sources.avif %}{% set p = s|split(' ') %}{{ p[0] starts with('/') ? (base_path ~ p[0]) : p[0] }} {{ p[1]|default('1x') }}{% if not loop.last %}, {% endif %}{% endfor %}" sizes="(min-width:1024px) 33vw, (min-width:640px) 50vw, 100vw">
                {% endif %}
                {% if image.sources is defined and image.sources.webp is defined and image.sources.webp|length %}
                    <source type="image/webp" srcset="{% for s in image.sources.webp %}{% set p = s|split(' ') %}{{ p[0] starts with('/') ? (base_path ~ p[0]) : p[0] }} {{ p[1]|default('1x') }}{% if not loop.last %}, {% endif %}{% endfor %}" sizes="(min-width:1024px) 33vw, (min-width:640px) 50vw, 100vw">
                {% endif %}
                {% if image.sources is defined and image.sources.jpg is defined and image.sources.jpg|length %}
                    <source type="image/jpeg" srcset="{% for s in image.sources.jpg %}{% set p = s|split(' ') %}{{ p[0] starts with('/') ? (base_path ~ p[0]) : p[0] }} {{ p[1]|default('1x') }}{% if not loop.last %}, {% endif %}{% endfor %}" sizes="(min-width:1024px) 33vw, (min-width:640px) 50vw, 100vw">
                {% endif %}
                {% set img_src = image.fallback_src|default(image.url) %}
                <img src="{{ img_src starts with('/') ? (base_path ~ img_src) : img_src }}"
                     alt="{{ image.alt|default(image.album_title)|e }}"
                     width="{{ image.width|default(1600) }}" height="{{ image.height|default(1067) }}"
                     {% if priority %}loading="eager" fetchpriority="high"{% else %}loading="lazy"{% endif %}
                     decoding="async" class="w-full h-full object-cover block">
            </picture>
        {% endmacro %}

        {% macro home_item(image, base_path, priority=false) %}
            {% set w = image.width|default(1600) %}
            {% set h = image.height|default(1067) %}
            <div class="home-item group rounded-xl overflow-hidden shadow-sm relative transition-transform hover:scale-105 duration-300" style="aspect-ratio: {{ w }} / {{ h }};">
                <a href="{{ base_path }}/album/{{ image.album_slug }}" class="block w-full h-full relative z-10">
                    {{ _self.home_pic(image, base_path, priority) }}
                    <!-- Full overlay from bottom to top on hover -->
                    <div class="absolute inset-0 bg-black/70 text-white flex items-center justify-center transform translate-y-full group-hover:translate-y-0 transition-transform duration-300">
                        <span class="px-4 text-base md:text-lg lg:text-xl font-medium tracking-tight text-center">{{ image.album_title|e }}</span>
                    </div>
                </a>
            </div>
        {% endmacro %}

        {% import _self as H %}

        {# All photos in all columns (wall), but with different start offsets to avoid identical first row #}
        {% set totalImages = all_images|length %}
        {% set o1 = 0 %}
        {% set o2 = (totalImages / 3)|round(0, 'floor') %}
        {% set o3 = (totalImages * 2 / 3)|round(0, 'floor') %}
        {% set col1 = all_images %}
        {% set col2 = all_images|slice(o2, totalImages - o2)|merge(all_images|slice(0, o2)) %}
        {% set col3 = all_images|slice(o3, totalImages - o3)|merge(all_images|slice(0, o3)) %}

        <div id="home-infinite-gallery" class="relative h-full">
            <!-- Mobile: masonry via columns -->
            <div class="home-mobile-wrap">
                <div class="home-mobile">
                    {% for image in all_images %}
                        <div class="home-cell">{{ H.home_item(image, base_path, loop.index0 < 3) }}</div>
                    {% endfor %}
                </div>
            </div>

            <!-- Desktop: 3 columns with CSS autoscroll -->
            <div class="home-desktop-wrap gap-6 perspective h-full">
                {% set cols = [col1, col2, col3] %}
                {% for col in cols %}
                    {% set idx = loop.index0 %}
                    {% set dur = idx == 0 ? '420s' : (idx == 1 ? '540s' : '660s') %}
                    {% set dir = idx == 1 ? 'up' : 'down' %}
                    <div class="home-col" data-direction="{{ dir }}" style="--home-duration: {{ dur }}; --home-delay: 0s;" data-col-index="{{ idx }}">
                        <div class="home-track">
                            {# Build a tall loop: first half (K repeats) + identical second half #}
                            {% set repeat_times = 6 %}
                            {% for r in 1..repeat_times %}
                                {% for image in col %}
                                    <div class="home-cell">{{ H.home_item(image, base_path, loop.parent.loop.index0 == 0 and loop.index0 == 0) }}</div>
                                {% endfor %}
                            {% endfor %}
                            {% for r in 1..repeat_times %}
                                {% for image in col %}
                                    <div class="home-cell">{{ H.home_item(image, base_path, false) }}</div>
                                {% endfor %}
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </section>
    
    <!-- Spacer -->
    <div class="home-infinite-spacer h-24"></div>
    {% endif %}

    <!-- Albums Horizontal Infinite Carousel -->
    <section class="pt-8 pb-16">
        <div class="text-center mb-12">
            <h2 class="text-3xl md:text-4xl font-light text-black mb-4">
                Latest Albums
            </h2>
            <p class="text-lg text-neutral-600 max-w-xl mx-auto">
                Discover my recent photographic work, from analog experiments to digital explorations.
            </p>
        </div>
        
        {% if albums|length > 0 %}
        <!-- Horizontal Infinite Carousel -->
        <div class="albums-carousel-container relative overflow-hidden">
            <div class="albums-carousel-track cursor-grab active:cursor-grabbing" id="albums-carousel">
                {% for album in albums %}
                    <div class="album-carousel-item flex-shrink-0 w-80 md:w-96 mx-4">
                        {% include "frontend/_album_card.twig" %}
                    </div>
                {% endfor %}
                <!-- Duplicate items for seamless infinite scroll -->
                {% for album in albums %}
                    <div class="album-carousel-item flex-shrink-0 w-80 md:w-96 mx-4">
                        {% include "frontend/_album_card.twig" %}
                    </div>
                {% endfor %}
            </div>
            
            <!-- Edge fade effects -->
            <div class="albums-edge-left"></div>
            <div class="albums-edge-right"></div>
        </div>
        {% else %}
        <div class="text-center py-20">
            <h2 class="text-2xl font-light text-neutral-600 mb-4">No albums yet</h2>
            <p class="text-neutral-500">Check back soon for new work.</p>
        </div>
        {% endif %}
    </section>

</div>
{% endblock %}

{% block scripts %}
<script type="module" src="{{ base_path }}/assets/js/home.js"></script>
<script type="module">
// Initialize Lenis if available via Vite's global exposure
if (window.Lenis) {
  const lenis = new window.Lenis({
    lerp: 0.1,
    wheelMultiplier: 1,
    infinite: false,
    gestureOrientation: 'vertical',
    normalizeWheel: false,
    smoothTouch: false,
  });
  if (typeof gsap !== 'undefined' && gsap.ticker) {
    lenis.on('scroll', gsap.updateRoot);
    gsap.ticker.add((time) => { lenis.raf(time * 1000); });
    gsap.ticker.lagSmoothing(0);
  } else {
    function raf(time) { lenis.raf(time); requestAnimationFrame(raf); }
    requestAnimationFrame(raf);
  }
}

// Global base path for API calls
window.basePath = '{{ base_path }}';

// Legacy album loading removed - now using horizontal infinite carousel
</script>

<style>
/* Home Infinite Scroll Styles - container always visible */
.perspective { transform: perspective(1200px) rotateX(1deg); }

/* Mobile masonry via CSS columns */
.home-mobile-wrap { display:block; }
.home-desktop-wrap { display:none; }
@media (min-width:768px){
  .home-mobile-wrap { display:none !important; }
  .home-desktop-wrap { display:flex !important; }
  /* Tablet: show only first 2 columns */
  .home-desktop-wrap .home-col:nth-child(3) { display:none; }
}
@media (min-width:1024px){
  /* Desktop: show all 3 columns */
  .home-desktop-wrap .home-col:nth-child(3) { display:block; }
}
.home-mobile { column-count: 1; column-gap: 1.5rem; }
@media (min-width: 640px) { .home-mobile { column-count: 2; } }
.home-cell { break-inside: avoid; margin-bottom: 1.5rem; }

/* Desktop columns autoscroll */
.home-col { position: relative; flex: 1 1 0; height: 100%; overflow: hidden; }
.home-track { position: absolute; top: 0; left: 0; right: 0; will-change: transform; }
.home-col .home-cell { margin-bottom: 1.5rem; }

.home-col[data-direction="down"] .home-track { 
  animation: homeScrollDown var(--home-duration) linear infinite; 
  animation-delay: var(--home-delay); 
}
.home-col[data-direction="up"] .home-track { 
  animation: homeScrollUp var(--home-duration) linear infinite; 
  animation-delay: var(--home-delay); 
}
@keyframes homeScrollDown { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(0, -50%, 0); } }
@keyframes homeScrollUp { 0% { transform: translate3d(0, -50%, 0); } 100% { transform: translate3d(0, 0, 0); } }

/* Pause on hover */
.perspective:hover .home-track { animation-play-state: paused; cursor: grab; }
.perspective:active .home-track { cursor: grabbing; }

/* Veils */
.home-veil-top { background: radial-gradient(140% 80% at 50% -30%, rgba(255,255,255,.45) 0%, rgba(255,255,255,.15) 50%, rgba(255,255,255,0) 80%); }
.home-veil-bottom { background: radial-gradient(140% 80% at 50% 130%, rgba(255,255,255,.45) 0%, rgba(255,255,255,.15) 50%, rgba(255,255,255,0) 80%); }

/* Item hover effects & overlay */
.home-item { width: 100%; height: 100%; transition: transform .3s cubic-bezier(.25,.8,.25,1), box-shadow .3s; }
.home-item:hover { transform: translateY(-4px) scale(1.02); box-shadow: 0 12px 32px rgba(0,0,0,.15); }
.home-item img { backface-visibility: hidden; }

/* Albums Horizontal Infinite Carousel */
.albums-carousel-container {
  height: 400px;
  margin: 0 -2rem;
  padding: 0 2rem;
  display: flex;
  align-items: center; /* Center the carousel vertically */
}

.albums-carousel-track {
  display: flex;
  height: 100%;
  will-change: transform;
  transition: transform 0.1s ease-out;
  align-items: center; /* Center items vertically within track */
}

.album-carousel-item {
  min-width: 320px;
  user-select: none;
  flex-shrink: 0;
}

@media (min-width: 768px) {
  .album-carousel-item {
    min-width: 384px;
  }
}

/* Fix drag preview stretching */
.album-carousel-item img {
  pointer-events: none;
  max-width: 100%;
  height: auto;
  object-fit: cover;
}

.album-carousel-item * {
  pointer-events: none;
}

/* Edge fade effects */
.albums-edge-left,
.albums-edge-right {
  position: absolute;
  top: 0;
  bottom: 0;
  width: 100px;
  pointer-events: none;
  z-index: 10;
}

.albums-edge-left {
  left: 0;
  background: linear-gradient(to right, rgba(255,255,255,1) 0%, rgba(255,255,255,0.8) 30%, rgba(255,255,255,0) 100%);
}

.albums-edge-right {
  right: 0;
  background: linear-gradient(to left, rgba(255,255,255,1) 0%, rgba(255,255,255,0.8) 30%, rgba(255,255,255,0) 100%);
}

/* Enhanced carousel grabbing */
.albums-carousel-track.dragging {
  transition: none;
  cursor: grabbing;
}

/* Scrolling Columns Layout - Back to Original */
.home-col { 
  position: relative; 
  flex: 1 1 0; 
  height: 100%; 
  overflow: hidden;
}

.home-track { 
  position: absolute; 
  top: 0; 
  left: 0; 
  right: 0; 
  will-change: transform;
}

.home-cell {
  break-inside: avoid;
  margin-bottom: 1.5rem;
}

/* Modern photo styling */
.home-item {
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
  transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(8px);
}

.home-item:hover {
  transform: translateY(-4px) scale(1.02);
  box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15);
}

.home-item img {
  transition: transform 0.4s ease;
  backface-visibility: hidden;
}

.home-item:hover img {
  transform: scale(1.05);
}

/* Scroll exit animation class */
.gallery-exiting .wheel-item {
  animation: wheelSpinOut 0.8s cubic-bezier(0.25, 0.8, 0.25, 1) forwards;
}
.home-col .home-cell { margin-bottom: 1.5rem; }

/* smooth scroll columns (no CSS animations) */
.home-col .home-track { 
  transition: transform 0.1s ease-out;
  will-change: transform;
}

/* Soft elegant gradient veils */
.home-veil-top {
  background: linear-gradient(180deg, 
    rgba(255,255,255,0.9) 0%, 
    rgba(255,255,255,0.7) 30%, 
    rgba(255,255,255,0.3) 70%, 
    rgba(255,255,255,0) 100%);
  backdrop-filter: blur(1px);
}
.home-veil-bottom {
  background: linear-gradient(0deg, 
    rgba(255,255,255,0.9) 0%, 
    rgba(255,255,255,0.7) 30%, 
    rgba(255,255,255,0.3) 70%, 
    rgba(255,255,255,0) 100%);
  backdrop-filter: blur(1px);
}

/* performance optimizations */
.home-track { backface-visibility: hidden; transform-style: preserve-3d; transform: translateZ(0); will-change: transform; contain: content; }

@media (max-width: 767px) {
  .perspective { transform: none; }
}

/* Optimized responsive behavior for smooth loading */

/* Mobile first approach - show static grid by default */
.home-mobile-wrap {
  display: grid !important;
}

.home-desktop-wrap {
  display: none !important;
}

/* Desktop - show infinite scroll columns on larger screens */
@media (min-width: 768px) {
  .home-mobile-wrap {
    display: none !important;
  }
  
  .home-desktop-wrap {
    display: flex !important;
  }
  
  .home-infinite-section {
    height: 150vh !important;
  }
}

@media (min-width: 1024px) {
  .home-infinite-section {
    height: 200vh !important;
  }
}
</style>

<script>
/* Scrolling Gallery with Entry Animation */
document.addEventListener('DOMContentLoaded', function(){
  const homeCols = document.querySelectorAll('.home-col');
  if (homeCols.length) {
    // Pause animation when out of viewport for performance
    if ('IntersectionObserver' in window) {
      const io = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          const track = entry.target.querySelector('.home-track');
          if (!track) return;
          track.style.animationPlayState = entry.isIntersecting ? 'running' : 'paused';
        });
      }, { threshold: 0.05 });
      homeCols.forEach(col => io.observe(col));
    }

    // Respect reduced motion preferences
    if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
      document.querySelectorAll('.home-col .home-track').forEach(track => {
        track.style.animationDuration = '200s';
      });
    }
  }

  // Drag-to-scroll per column (vertical grab)
  homeCols.forEach((col) => {
    const track = col.querySelector('.home-track');
    if (!track) return;

    let isDragging = false;
    let startY = 0;
    let startTranslate = 0;

    const getTranslateY = (el) => {
      const st = getComputedStyle(el).transform;
      if (!st || st === 'none') return 0;
      const m = st.match(/matrix\(([^)]+)\)/);
      if (m) {
        const vals = m[1].split(',').map(parseFloat);
        return vals[5] || 0;
      }
      const m3 = st.match(/matrix3d\(([^)]+)\)/);
      if (m3) {
        const vals = m3[1].split(',').map(parseFloat);
        return vals[13] || 0;
      }
      return 0;
    };

    const clampLoop = (y) => {
      const half = track.scrollHeight / 2;
      if (half <= 0) return y;
      while (y <= -half) y += half;
      while (y > 0) y -= half;
      return y;
    };

    const onDown = (e) => {
      isDragging = true;
      startY = (e.touches ? e.touches[0].clientY : e.clientY);
      startTranslate = getTranslateY(track);
      track.style.animationPlayState = 'paused';
      col.classList.add('dragging');
      e.preventDefault();
    };

    const onMove = (e) => {
      if (!isDragging) return;
      const y = (e.touches ? e.touches[0].clientY : e.clientY);
      let next = startTranslate + (y - startY);
      next = clampLoop(next);
      track.style.transform = `translateY(${next}px)`;
      e.preventDefault();
    };

    const onUp = () => {
      if (!isDragging) return;
      isDragging = false;
      col.classList.remove('dragging');
      // Keep paused while hovering; resume on mouseleave
    };

    col.addEventListener('mousedown', onDown);
    col.addEventListener('mousemove', onMove);
    window.addEventListener('mouseup', onUp);

    col.addEventListener('touchstart', onDown, { passive: false });
    col.addEventListener('touchmove', onMove, { passive: false });
    col.addEventListener('touchend', onUp);

    let pauseTimer = null, resumeTimer = null;
    col.addEventListener('mouseenter', () => {
      clearTimeout(resumeTimer);
      pauseTimer = setTimeout(() => {
        track.style.animationPlayState = 'paused';
      }, 100);
    });
    col.addEventListener('mouseleave', () => {
      if (isDragging) return;
      clearTimeout(pauseTimer);
      const dir = (col.getAttribute('data-direction') || 'down').toLowerCase();
      const half = track.offsetHeight / 2;
      const curr = getTranslateY(track);
      const durVar = getComputedStyle(col).getPropertyValue('--home-duration').trim() || '420s';
      const durSec = parseFloat(durVar);
      const pxPerSec = half / durSec; // base speed in px/s
      const sign = (dir === 'up') ? -1 : 1; // up increases Y towards 0

      const rampMs = 2500; // slow acceleration
      let last = performance.now();
      const start = last;

      const easeIn = (t) => 1 - Math.cos((t * Math.PI) / 2); // easeInSine

      // Fully take over from CSS animation to avoid any jump
      track.style.animation = 'none';
      track.style.animationPlayState = '';
      // Freeze at current position exactly
      track.style.transform = `translate3d(0, ${curr}px, 0)`;

      const rafStep = (now) => {
        const dt = Math.max(0, now - last) / 1000;
        const p = Math.min(1, (now - start) / rampMs);
        const vfactor = easeIn(p); // 0 -> 1
        const dy = sign * pxPerSec * vfactor * dt * -1; // down is negative direction overall
        const currentY = getTranslateY(track);
        let next = clampLoop(currentY + dy);
        track.style.transform = `translate3d(0, ${next}px, 0)`;
        last = now;
        if (p < 1) {
          requestAnimationFrame(rafStep);
        } else {
          // hand back to CSS animation without a visual jump
          let progress = 0;
          if (dir === 'down') {
            progress = Math.max(0, Math.min(1, -next / half));
          } else {
            progress = Math.max(0, Math.min(1, (next + half) / half));
          }
          const animName = (dir === 'up') ? 'homeScrollUp' : 'homeScrollDown';
          // Apply animation with exact phase, while still showing last RAF frame
          track.style.animation = `${animName} ${durSec}s linear infinite`;
          track.style.animationDelay = `-${(progress * durSec).toFixed(3)}s`;
          track.style.animationPlayState = 'running';
          // Next frame: remove inline transform so animation continues seamlessly
          requestAnimationFrame(() => {
            track.style.transform = '';
          });
        }
      };
      requestAnimationFrame(rafStep);
    });
  });

  // Albums Horizontal Infinite Carousel
  initAlbumsCarousel();
});

function initAlbumsCarousel() {
  const carousel = document.getElementById('albums-carousel');
  if (!carousel) return;
  
  const container = carousel.parentElement;
  const items = carousel.querySelectorAll('.album-carousel-item');
  if (items.length === 0) return;
  
  let currentTranslate = 0;
  let previousTranslate = 0;
  let animationId = 0;
  let isDragging = false;
  let startPos = 0;
  let currentIndex = 0;
  let autoPlayId = null;
  
  // Get item width including margins
  const getItemWidth = () => {
    const item = items[0];
    const styles = getComputedStyle(item);
    const width = item.offsetWidth;
    const marginLeft = parseFloat(styles.marginLeft);
    const marginRight = parseFloat(styles.marginRight);
    return width + marginLeft + marginRight;
  };
  
  const itemWidth = getItemWidth();
  const totalWidth = itemWidth * (items.length / 2); // Half because we duplicated items
  
  // Auto-play functionality
  const autoPlay = () => {
    currentTranslate -= 1; // Smooth continuous scroll
    
    // Reset position when we reach the duplicate section
    if (Math.abs(currentTranslate) >= totalWidth) {
      currentTranslate = 0;
    }
    
    setSliderPosition();
    autoPlayId = requestAnimationFrame(autoPlay);
  };
  
  // Start auto-play
  autoPlayId = requestAnimationFrame(autoPlay);
  
  // Set slider position
  const setSliderPosition = () => {
    carousel.style.transform = `translate3d(${currentTranslate}px, 0, 0)`;
  };
  
  // Mouse and touch events
  const getPositionX = (event) => {
    return event.type.includes('mouse') ? event.clientX : event.touches[0].clientX;
  };
  
  const dragStart = (event) => {
    // Prevent default behavior including image dragging
    event.preventDefault();
    event.stopPropagation();
    
    isDragging = true;
    startPos = getPositionX(event);
    previousTranslate = currentTranslate;
    
    // Pause auto-play while dragging
    if (autoPlayId) {
      cancelAnimationFrame(autoPlayId);
      autoPlayId = null;
    }
    
    carousel.classList.add('dragging');
    document.body.style.userSelect = 'none'; // Prevent text selection during drag
  };
  
  const dragMove = (event) => {
    if (!isDragging) return;
    
    event.preventDefault();
    event.stopPropagation();
    
    const currentPosition = getPositionX(event);
    const diff = currentPosition - startPos;
    currentTranslate = previousTranslate + diff;
    
    setSliderPosition();
  };
  
  const dragEnd = () => {
    if (!isDragging) return;
    
    isDragging = false;
    carousel.classList.remove('dragging');
    document.body.style.userSelect = ''; // Restore text selection
    
    // Handle infinite loop positioning
    if (Math.abs(currentTranslate) >= totalWidth) {
      currentTranslate = currentTranslate % totalWidth;
    } else if (currentTranslate > 0) {
      currentTranslate = -totalWidth + (currentTranslate % totalWidth);
    }
    
    setSliderPosition();
    
    // Resume auto-play after a delay
    setTimeout(() => {
      if (!autoPlayId) {
        autoPlayId = requestAnimationFrame(autoPlay);
      }
    }, 2000);
  };
  
  // Event listeners
  carousel.addEventListener('mousedown', dragStart);
  carousel.addEventListener('mousemove', dragMove);
  carousel.addEventListener('mouseup', dragEnd);
  carousel.addEventListener('mouseleave', dragEnd);
  
  carousel.addEventListener('touchstart', dragStart, { passive: false });
  carousel.addEventListener('touchmove', dragMove, { passive: false });
  carousel.addEventListener('touchend', dragEnd);
  
  // Prevent browser's default drag behavior on images
  carousel.addEventListener('dragstart', (e) => e.preventDefault());
  carousel.addEventListener('selectstart', (e) => e.preventDefault());
  
  // Pause on hover
  container.addEventListener('mouseenter', () => {
    if (autoPlayId) {
      cancelAnimationFrame(autoPlayId);
      autoPlayId = null;
    }
  });
  
  container.addEventListener('mouseleave', () => {
    if (!autoPlayId && !isDragging) {
      autoPlayId = requestAnimationFrame(autoPlay);
    }
  });
  
  // Handle resize
  let resizeTimer;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => {
      const newItemWidth = getItemWidth();
      if (newItemWidth !== itemWidth) {
        location.reload(); // Simple solution for resize handling
      }
    }, 250);
  });
}
</script>
{% endblock %}
