{% if all_images|length > 0 %}
{% set scroll_direction = home_settings.gallery_scroll_direction|default('vertical') %}
<section class="home-infinite-section relative mb-32 overflow-hidden {{ scroll_direction == 'horizontal' ? 'home-horizontal' : 'home-vertical' }}"
         data-scroll-direction="{{ scroll_direction }}"
         style="{{ scroll_direction == 'horizontal' ? 'height: auto;' : 'height: 120vh;' }}">
  {% if scroll_direction == 'vertical' %}
  <div class="pointer-events-none absolute inset-x-0 top-0 h-10 z-20 home-veil-top"></div>
  <div class="pointer-events-none absolute inset-x-0 bottom-0 h-10 z-20 home-veil-bottom"></div>
  {% else %}
  <div class="pointer-events-none absolute inset-y-0 left-0 w-10 z-20 home-veil-left"></div>
  <div class="pointer-events-none absolute inset-y-0 right-0 w-10 z-20 home-veil-right"></div>
  {% endif %}

  {% macro home_pic(image, base_path, priority=false) %}
    <picture class="block w-full h-full">
      {% if image.sources is defined and image.sources.avif is defined and image.sources.avif|length %}
        <source type="image/avif" srcset="{% for s in image.sources.avif %}{% set p = s|split(' ') %}{{ p[0] starts with('/') ? (base_path ~ p[0]) : p[0] }} {{ p[1]|default('1x') }}{% if not loop.last %}, {% endif %}{% endfor %}" sizes="(min-width:1024px) 33vw, (min-width:640px) 50vw, 100vw">
      {% endif %}
      {% if image.sources is defined and image.sources.webp is defined and image.sources.webp|length %}
        <source type="image/webp" srcset="{% for s in image.sources.webp %}{% set p = s|split(' ') %}{{ p[0] starts with('/') ? (base_path ~ p[0]) : p[0] }} {{ p[1]|default('1x') }}{% if not loop.last %}, {% endif %}{% endfor %}" sizes="(min-width:1024px) 33vw, (min-width:640px) 50vw, 100vw">
      {% endif %}
      {% if image.sources is defined and image.sources.jpg is defined and image.sources.jpg|length %}
        <source type="image/jpeg" srcset="{% for s in image.sources.jpg %}{% set p = s|split(' ') %}{{ p[0] starts with('/') ? (base_path ~ p[0]) : p[0] }} {{ p[1]|default('1x') }}{% if not loop.last %}, {% endif %}{% endfor %}" sizes="(min-width:1024px) 33vw, (min-width:640px) 50vw, 100vw">
      {% endif %}
      {% set img_src = image.fallback_src|default(image.url) %}
      <img src="{{ img_src starts with('/') ? (base_path ~ img_src) : img_src }}"
           alt="{{ image.alt|default(image.album_title)|e }}"
           width="{{ image.width|default(1600) }}" height="{{ image.height|default(1067) }}"
           {% if priority %}loading="eager" fetchpriority="high"{% else %}loading="lazy"{% endif %}
           decoding="async" class="w-full h-full object-cover block">
    </picture>
  {% endmacro %}

  {% macro home_item(image, base_path, priority=false) %}
    {% set w = image.width|default(1600) %}
    {% set h = image.height|default(1067) %}
    <div class="home-item group rounded-xl overflow-hidden shadow-sm relative transition-transform hover:scale-105 duration-300" style="aspect-ratio: {{ w }} / {{ h }};">
      <a href="{{ base_path }}/album/{{ image.album_slug }}" class="block w-full h-full relative z-10">
        {{ _self.home_pic(image, base_path, priority) }}
        <div class="absolute inset-0 bg-black/70 text-white flex items-center justify-center transform translate-y-full group-hover:translate-y-0 transition-transform duration-300">
          <span class="px-4 text-base md:text-lg lg:text-xl font-medium tracking-tight text-center">{{ image.album_title|e }}</span>
        </div>
      </a>
    </div>
  {% endmacro %}

  {% import _self as H %}

  {% set totalImages = all_images|length %}
  {% set o1 = 0 %}
  {% set o2 = (totalImages / 3)|round(0, 'floor') %}
  {% set o3 = (totalImages * 2 / 3)|round(0, 'floor') %}
  {% set col1 = all_images %}
  {% set col2 = all_images|slice(o2, totalImages - o2)|merge(all_images|slice(0, o2)) %}
  {% set col3 = all_images|slice(o3, totalImages - o3)|merge(all_images|slice(0, o3)) %}

  <div id="home-infinite-gallery" class="relative h-full entry-init" style="opacity:0;">
    <div class="home-mobile-wrap">
      <div class="home-mobile">
        {% for image in all_images %}
          <div class="home-cell">{{ H.home_item(image, base_path, loop.index0 < 3) }}</div>
        {% endfor %}
      </div>
    </div>

    {% if scroll_direction == 'horizontal' %}
    {# Horizontal layout: 3 rows - row 1 & 3 scroll right, row 2 scrolls left #}
    <div class="home-desktop-wrap home-desktop-horizontal gap-6 h-full">
      {% set rows = [col1, col2, col3] %}
      {% for row in rows %}
        {% set idx = loop.index0 %}
        {% set dur = idx == 0 ? '380s' : (idx == 1 ? '420s' : '480s') %}
        {% set dir = idx == 1 ? 'left' : 'right' %}
        <div class="home-row" data-direction="{{ dir }}" style="--home-duration: {{ dur }}; --home-delay: 0s;" data-row-index="{{ idx }}">
          <div class="home-track-h">
            {% set repeat_times = 6 %}
            {% for r in 1..repeat_times %}
              {% for image in row %}
                {# First repeat of each row: eager load first 6 images #}
                <div class="home-cell-h">{{ H.home_item(image, base_path, loop.parent.loop.index0 == 0 and loop.index0 < 6) }}</div>
              {% endfor %}
            {% endfor %}
            {% for r in 1..repeat_times %}
              {% for image in row %}
                <div class="home-cell-h">{{ H.home_item(image, base_path, false) }}</div>
              {% endfor %}
            {% endfor %}
          </div>
        </div>
      {% endfor %}
    </div>
    {% else %}
    {# Vertical layout: 3 columns scrolling up/down #}
    <div class="home-desktop-wrap home-desktop-vertical gap-6 perspective h-full">
      {% set cols = [col1, col2, col3] %}
      {% for col in cols %}
        {% set idx = loop.index0 %}
        {% set dur = idx == 0 ? '420s' : (idx == 1 ? '540s' : '660s') %}
        {% set dir = idx == 1 ? 'up' : 'down' %}
        <div class="home-col" data-direction="{{ dir }}" style="--home-duration: {{ dur }}; --home-delay: 0s;" data-col-index="{{ idx }}">
          <div class="home-track">
            {% set repeat_times = 6 %}
            {% for r in 1..repeat_times %}
              {% for image in col %}
                <div class="home-cell">{{ H.home_item(image, base_path, loop.parent.loop.index0 == 0 and loop.index0 == 0) }}</div>
              {% endfor %}
            {% endfor %}
            {% for r in 1..repeat_times %}
              {% for image in col %}
                <div class="home-cell">{{ H.home_item(image, base_path, false) }}</div>
              {% endfor %}
            {% endfor %}
          </div>
        </div>
      {% endfor %}
    </div>
    {% endif %}
  </div>
</section>
{% endif %}
