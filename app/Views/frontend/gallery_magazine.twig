{% extends "frontend/_layout.twig" %}

{% block content %}
{# =========================
   HERO (immutato)
   ========================= #}
<section class="relative" style="min-height:50vh">
  {% set hero_url = '' %}
  {% if album.cover_image is defined and album.cover_image %}
    {% set candidate = album.cover_image.preview_path ?? album.cover_image.original_path ?? album.cover_image.path ?? null %}
    {% if candidate %}
      {% set hero_url = candidate starts with '/' ? (base_path ~ candidate) : candidate %}
    {% endif %}
  {% endif %}
  {% if not hero_url and album.cover is defined and album.cover %}
    {% if album.cover.variants is defined and album.cover.variants|length %}
      {% set max_w = 0 %}
      {% for v in album.cover.variants %}
        {% if v.path is defined and v.path and v.width is defined and v.width > max_w and not (v.path starts with '/storage/') %}
          {% set hero_url = v.path starts with '/' ? (base_path ~ v.path) : v.path %}
          {% set max_w = v.width %}
        {% endif %}
      {% endfor %}
    {% endif %}
    {% if not hero_url %}
      {% set cand2 = album.cover.path ?? album.cover.url ?? null %}
      {% if cand2 %}{% set hero_url = cand2 starts with '/' ? (base_path ~ cand2) : cand2 %}{% endif %}
    {% endif %}
  {% endif %}
  {% if not hero_url and images is defined and images|length %}
    {% set firstImg = images[0] %}
    {% set cand4 = firstImg.fallback_src ?? firstImg.url ?? null %}
    {% if cand4 %}{% set hero_url = cand4 starts with '/' ? (base_path ~ cand4) : cand4 %}{% endif %}
  {% endif %}

  {% set hero_has_image = hero_url is not empty %}
  <div class="relative overflow-hidden bg-neutral-900" style="min-height:50vh">
    {% if hero_has_image %}
      <img src="{{ hero_url }}" alt="{{ album.title|e }}" class="absolute inset-0 w-full h-full object-cover object-center select-none blur-sm md:blur md:scale-105" loading="eager" fetchpriority="high" decoding="async">
    {% endif %}
    <div class="absolute inset-0 z-10 pointer-events-none backdrop-blur-[1px]" style="background: linear-gradient(180deg, rgba(255,255,255,0.85) 0%, rgba(255,255,255,0.70) 45%, rgba(255,255,255,0.55) 100%);"></div>
    <div class="relative z-20 flex items-center justify-center px-4 sm:px-6 lg:px-8" style="min-height:50vh; padding-top:3rem; padding-bottom:3rem">
      <div class="max-w-5xl w-full text-center text-black px-4 md:px-8">
        <div class="mb-3 flex flex-wrap justify-center gap-2">
          {% if album.categories is defined and album.categories|length > 0 %}
            {% for cat in album.categories %}
              <a href="{{ base_path }}/category/{{ cat.slug }}" class="inline-flex items-center gap-2 text-[11px] font-medium px-2.5 py-1 rounded-full border border-neutral-300 bg-white/80 text-neutral-800 hover:bg-white transition-colors" title="{{ cat.name|e }}">
                <span class="inline-block w-1.5 h-1.5 rounded-full bg-neutral-800"></span>{{ cat.name|e }}
              </a>
            {% endfor %}
          {% endif %}
          {% if album.tags is defined and album.tags|length > 0 %}
            {% for tag in album.tags %}
              <span class="inline-flex items-center gap-2 text-[11px] font-medium px-2.5 py-1 rounded-full border border-blue-300 bg-blue-50 text-blue-700" title="{{ tag.name|e }}">
                <span class="inline-block w-1.5 h-1.5 rounded-full bg-blue-600"></span>{{ tag.name|e }}
              </span>
            {% endfor %}
          {% endif %}
        </div>
        <h1 class="text-3xl md:text-5xl font-light tracking-tight leading-tight">{{ album.title|e }}</h1>
        <div class="mt-3 text-sm md:text-base text-neutral-700 flex flex-col sm:flex-row items-center justify-center gap-3">
          {% if album.shoot_date and album.show_date == 1 %}
            <span class="inline-flex items-center gap-2 px-2.5 py-1.5 rounded-full bg-white/80 text-black text-xs md:text-sm">
              <i class="fas fa-calendar-alt text-xs text-neutral-700"></i>
              <time datetime="{{ album.shoot_date }}">{{ album.shoot_date|date('d M Y') }}</time>
            </span>
          {% endif %}
          {% if album.equipment.locations|length > 0 %}
            <span class="inline-flex items-center gap-2 px-2.5 py-1.5 rounded-full bg-white/80 text-black text-xs md:text-sm">
              <i class="fas fa-map-marker-alt text-xs text-neutral-700"></i>
              {{ album.equipment.locations|join(', ') }}
            </span>
          {% endif %}
        </div>
        {% if album.excerpt %}
          <p class="mt-3 text-neutral-700 leading-relaxed text-base md:text-lg max-w-3xl mx-auto">{{ album.excerpt|e }}</p>
        {% endif %}
      </div>
    </div>
  </div>
</section>

{# Descrizione #}
{% if album.body %}
<section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-16 pb-10">
  <div class="max-w-3xl mx-auto prose prose-neutral">
    {{ album.body|raw }}
  </div>
</section>
{% endif %}

{# =========================
   MACRO IMMAGINI
   ========================= #}
{% macro m_picture(image, base_path, album) %}
  <picture class="block w-full h-full">
    {% if image.sources is defined and image.sources.avif is defined and image.sources.avif|length %}
      <source type="image/avif" srcset="{% for src in image.sources.avif %}{% set p = src|split(' ') %}{{ p[0] starts with('/') ? (base_path ~ p[0]) : p[0] }} {{ p[1]|default('1x') }}{% if not loop.last %}, {% endif %}{% endfor %}" sizes="(min-width:1024px) 33vw, (min-width:640px) 50vw, 100vw">
    {% endif %}
    {% if image.sources is defined and image.sources.webp is defined and image.sources.webp|length %}
      <source type="image/webp" srcset="{% for src in image.sources.webp %}{% set p = src|split(' ') %}{{ p[0] starts with('/') ? (base_path ~ p[0]) : p[0] }} {{ p[1]|default('1x') }}{% if not loop.last %}, {% endif %}{% endfor %}" sizes="(min-width:1024px) 33vw, (min-width:640px) 50vw, 100vw">
    {% endif %}
    {% if image.sources is defined and image.sources.jpg is defined and image.sources.jpg|length %}
      <source type="image/jpeg" srcset="{% for src in image.sources.jpg %}{% set p = src|split(' ') %}{{ p[0] starts with('/') ? (base_path ~ p[0]) : p[0] }} {{ p[1]|default('1x') }}{% if not loop.last %}, {% endif %}{% endfor %}" sizes="(min-width:1024px) 33vw, (min-width:640px) 50vw, 100vw">
    {% endif %}
    {% set img_src = image.fallback_src|default(image.url) %}
    <img
      src="{{ img_src starts with('/') ? (base_path ~ img_src) : img_src }}"
      alt="{{ image.alt|default(album.title)|e }}"
      width="{{ image.width|default(1600) }}"
      height="{{ image.height|default(1067) }}"
      loading="lazy"
      decoding="async"
      class="w-full h-full object-cover block"
    >
  </picture>
{% endmacro %}

{% macro m_item(image, clickable, base_path, album) %}
  {% set w = image.width|default(1600) %}
  {% set h = image.height|default(1067) %}
  {% set href_src = image.lightbox_url|default(image.url) %}
  <div class="m-item group rounded-xl overflow-hidden shadow-sm relative" style="aspect-ratio: {{ w }} / {{ h }};">
    {% if clickable %}
      <a
        href="{{ href_src starts with('/') ? (base_path ~ href_src) : href_src }}"
        class="pswp-link block w-full h-full"
        data-pswp-width="{{ w }}"
        data-pswp-height="{{ h }}"
        data-pswp-caption="{{ image.caption_html|default(image.caption)|e('html_attr') }}"
        style="display:block;width:100%;height:100%;"
      >
        {{ _self.m_picture(image, base_path, album) }}
      </a>
    {% else %}
      {{ _self.m_picture(image, base_path, album) }}
    {% endif %}

    <div class="absolute inset-0 bg-gradient-to-t from-black/22 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>

    {% if image.caption %}
      <div class="absolute bottom-3 left-3 right-3 flex items-center gap-2 bg-black/60 backdrop-blur-sm text-white rounded px-2.5 py-1.5 text-xs opacity-0 group-hover:opacity-100 transition-all duration-300 translate-y-2 group-hover:translate-y-0">
        <i class="fas fa-expand-alt text-white/80"></i>
        <span class="truncate">{{ image.caption }}</span>
      </div>
    {% endif %}
  </div>
{% endmacro %}

{% import _self as M %}

{# Split 3 colonne #}
{% set col1 = [] %}{% set col2 = [] %}{% set col3 = [] %}
{% for i, image in images %}
  {% if i % 3 == 0 %}
    {% set col1 = col1|merge([image]) %}
  {% elseif i % 3 == 1 %}
    {% set col2 = col2|merge([image]) %}
  {% else %}
    {% set col3 = col3|merge([image]) %}
  {% endif %}
{% endfor %}

{# =========================
   GALLERIA (con id #images-gallery per PhotoSwipe)
   ========================= #}
<section class="relative mt-10">
  <div class="pointer-events-none absolute inset-x-0 top-0 h-40 z-20 masonry-veil-top"></div>
  <div class="pointer-events-none absolute inset-x-0 bottom-0 h-40 z-20 masonry-veil-bottom"></div>

  <div id="images-gallery" class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    {# MOBILE: 1 col senza autoscroll #}
    <div class="m-mobile-wrap">
      <div class="m-mobile">
        {% for image in images %}
          <div class="m-cell">
            {{ M.m_item(image, true, base_path, album) }}
          </div>
        {% endfor %}
      </div>
    </div>

    {# DESKTOP: 3 colonne autoscroll con velocità/direzioni diverse #}
    <div class="m-desktop-wrap gap-6 perspective">
      {% set cols = [col1, col2, col3] %}
      {% for col in cols %}
        {% set idx = loop.index0 %}
        <div
          class="m-col"
          data-direction="{{ idx == 1 ? 'up' : 'down' }}"
          data-speed="{{ idx == 0 ? 26 : (idx == 1 ? 20 : 32) }}"
          data-delay="{{ idx == 0 ? 0 : (idx == 1 ? 1.2 : 2.4) }}"
        >
          <div class="m-track">
            {# passata 1 (cliccabile) #}
            {% for image in col %}
              <div class="m-cell">
                {{ M.m_item(image, true, base_path, album) }}
              </div>
            {% endfor %}
            {# passata 2 (non cliccabile) #}
            {% for image in col %}
              <div class="m-cell">
                {{ M.m_item(image, false, base_path, album) }}
              </div>
            {% endfor %}
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</section>

<style>
/* --- Toggle mobile/desktop SENZA Tailwind --- */
.m-mobile-wrap { display:block; }
.m-desktop-wrap { display:none; }
@media (min-width:768px){
  .m-mobile-wrap { display:none !important; }
  .m-desktop-wrap { display:flex !important; }
}

/* prospettiva soft */
.perspective { transform: perspective(1100px) rotateX(0.6deg); }

/* mobile masonry (columns) */
.m-mobile { column-count: 1; column-gap: 1.25rem; }
.m-cell { break-inside: avoid; margin-bottom: 1.25rem; }

/* desktop colonne auto-scroll */
.m-col { position: relative; flex: 1 1 0; height: 140vh; overflow: hidden; }
.m-track { position: absolute; top: 0; left: 0; right: 0; will-change: transform; }
.m-col .m-cell { margin-bottom: 1.25rem; }

/* item */
.m-item { width: 100%; height: 100%; transition: transform .32s cubic-bezier(.25,.8,.25,1), box-shadow .32s; }
.m-item:hover { transform: translateZ(0) scale(1.015); box-shadow: 0 12px 28px rgba(0,0,0,.15); }
.m-item img { backface-visibility: hidden; }

/* autoscroll */
.m-col[data-direction="down"] .m-track { animation: mScrollDown var(--m-duration, 26s) linear infinite; animation-delay: var(--m-delay, 0s); }
.m-col[data-direction="up"] .m-track   { animation: mScrollUp   var(--m-duration, 26s) linear infinite; animation-delay: var(--m-delay, 0s); }
@keyframes mScrollDown { 0% { transform: translateY(0); } 100% { transform: translateY(-50%); } }
@keyframes mScrollUp   { 0% { transform: translateY(-50%); } 100% { transform: translateY(0); } }

/* pausa on hover */
.perspective:hover .m-track { animation-play-state: paused; }

/* veli curvi bianchi */
.masonry-veil-top {
  background:
    radial-gradient(120% 80% at 50% -20%, rgba(255,255,255,.98) 0%, rgba(255,255,255,.82) 40%, transparent 70%);
}
.masonry-veil-bottom {
  background:
    radial-gradient(120% 80% at 50% 120%, rgba(255,255,255,.98) 0%, rgba(255,255,255,.82) 40%, transparent 70%);
}

/* perf */
.m-track { backface-visibility: hidden; transform-style: preserve-3d; }

/* optional: su mobile niente prospettiva/animazione colonne desktop (già nascoste comunque) */
@media (max-width: 767px) {
  .perspective { transform: none; }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Init (o re-init) PhotoSwipe Lightbox – stesso pattern dell’altra pagina
  if (typeof window.initLightbox !== 'function') {
    window.initLightbox = function initLightbox() {
      try {
        if (window._galleryLightbox && typeof window._galleryLightbox.destroy === 'function') {
          window._galleryLightbox.destroy();
          window._galleryLightbox = null;
        }
        if (typeof PhotoSwipeLightbox === 'undefined') {
          console.warn('PhotoSwipeLightbox non trovato: assicurati di includere JS/CSS come nell’altra pagina.');
          return;
        }
        // Se hai il core global (UMD)
        var cfg = {
          gallery: '#images-gallery',
          children: 'a.pswp-link',
          pswpModule: (typeof PhotoSwipe !== 'undefined') ? PhotoSwipe : undefined
        };
        // Se usi ESM dinamico e hai un path globale, scommenta e imposta il tuo path:
        // cfg.pswpModule = () => import('{{ base_path }}/assets/js/photoswipe.esm.js');

        var lb = new PhotoSwipeLightbox(cfg);
        lb.init();
        window._galleryLightbox = lb;
      } catch(e){ console.error('initLightbox error:', e); }
    }
  }

  // chiama sempre
  try { window.initLightbox(); } catch(e){ console.log(e); }

  // Imposta durate/delay per colonna
  const cols = document.querySelectorAll('.m-col');
  cols.forEach(col => {
    const speed = parseFloat(col.getAttribute('data-speed')) || 26; // seconds
    const delay = parseFloat(col.getAttribute('data-delay')) || 0;
    col.style.setProperty('--m-duration', speed + 's');
    col.style.setProperty('--m-delay', delay + 's');
  });

  // Pausa animazioni fuori viewport
  if ('IntersectionObserver' in window) {
    const io = new IntersectionObserver(entries => {
      entries.forEach(entry => {
        const track = entry.target.querySelector('.m-track');
        if (!track) return;
        track.style.animationPlayState = entry.isIntersecting ? 'running' : 'paused';
      });
    }, { threshold: 0.1 });
    cols.forEach(c => io.observe(c));
  }

  // Accessibilità: reduce motion
  if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
    cols.forEach(c => {
      const track = c.querySelector('.m-track');
      if (track) track.style.animationDuration = '120s';
    });
  }
});
</script>
{% endblock %}
