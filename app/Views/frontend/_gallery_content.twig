{% set layout = template_settings.layout|default('grid') %}
{% set masonry = template_settings.masonry|default(false) %}

{# Handle potentially nested columns structure #}
{% set cols = template_settings.columns is defined ? template_settings.columns : {'desktop': 3, 'tablet': 2, 'mobile': 1} %}

{# Extract desktop columns - handle nested structure #}
{% if cols.desktop is iterable and cols.desktop.desktop is defined %}
  {% set desktop_cols = cols.desktop.desktop %}
{% elseif cols.desktop is defined %}
  {% set desktop_cols = cols.desktop %}
{% else %}
  {% set desktop_cols = 3 %}
{% endif %}

{# Extract tablet columns - handle nested structure #}
{% if cols.tablet is iterable and cols.tablet.tablet is defined %}
  {% set tablet_cols = cols.tablet.tablet %}
{% elseif cols.tablet is defined %}
  {% set tablet_cols = cols.tablet %}
{% else %}
  {% set tablet_cols = 2 %}
{% endif %}

{# Extract mobile columns - handle nested structure #}
{% if cols.mobile is iterable and cols.mobile.mobile is defined %}
  {% set mobile_cols = cols.mobile.mobile %}
{% elseif cols.mobile is defined %}
  {% set mobile_cols = cols.mobile %}
{% else %}
  {% set mobile_cols = 1 %}
{% endif %}

{# Ensure values are numbers #}
{% set desktop_cols = desktop_cols|round %}
{% set tablet_cols = tablet_cols|round %}
{% set mobile_cols = mobile_cols|round %}

{% if layout == 'slideshow' %}
  <div class="swiper-wrapper">
    {% for image in images %}
    <div class="swiper-slide">
      {% set caption_parts = [] %}
      {% if image.caption %}
        {% set caption_parts = caption_parts|merge([image.caption]) %}
      {% endif %}
      {% if image.custom_camera or image.camera_name %}
        {% set caption_parts = caption_parts|merge(['Camera: ' ~ (image.custom_camera|default(image.camera_name))]) %}
      {% endif %}
      {% if image.custom_lens or image.lens_name %}
        {% set caption_parts = caption_parts|merge(['Lens: ' ~ (image.custom_lens|default(image.lens_name))]) %}
      {% endif %}
      {% if image.custom_film or image.film_name %}
        {% set caption_parts = caption_parts|merge(['Film: ' ~ (image.custom_film|default(image.film_name))]) %}
      {% endif %}
      {% set full_caption = caption_parts|join(' • ') %}
      <a href="{{ image.lightbox_url|default(image.url) }}" 
         class="pswp-link image-item aspect-[4/3] bg-neutral-100 rounded-lg overflow-hidden shadow-sm hover:shadow-lg transition-shadow cursor-pointer block"
         data-pswp-width="{{ image.width|default(1600) }}"
         data-pswp-height="{{ image.height|default(1067) }}"
         data-pswp-caption="{{ full_caption|e('html_attr') }}">
        <img src="{{ image.url }}" alt="{{ image.alt|default('Image')|e }}" class="w-full h-full object-cover">
      </a>
    </div>
    {% endfor %}
  </div>
  <div class="swiper-button-next"></div>
  <div class="swiper-button-prev"></div>
  <div class="swiper-pagination"></div>
{% else %}
  {% for image in images %}
  <div class="masonry-item">
    {% set caption_parts = [] %}
    {% if image.caption %}
      {% set caption_parts = caption_parts|merge([image.caption]) %}
    {% endif %}
    {% if image.custom_camera or image.camera_name %}
      {% set caption_parts = caption_parts|merge(['Camera: ' ~ (image.custom_camera|default(image.camera_name))]) %}
    {% endif %}
    {% if image.custom_lens or image.lens_name %}
      {% set caption_parts = caption_parts|merge(['Lens: ' ~ (image.custom_lens|default(image.lens_name))]) %}
    {% endif %}
    {% if image.custom_film or image.film_name %}
      {% set caption_parts = caption_parts|merge(['Film: ' ~ (image.custom_film|default(image.film_name))]) %}
    {% endif %}
    {% set full_caption = caption_parts|join(' • ') %}
    <a href="{{ image.lightbox_url|default(image.url) }}" 
       class="pswp-link image-item {% if layout == 'masonry' %}bg-neutral-100 rounded-lg overflow-hidden shadow-sm hover:shadow-lg transition-shadow cursor-pointer mb-4 group relative block{% else %}aspect-[4/3] bg-neutral-100 rounded-lg overflow-hidden shadow-sm hover:shadow-lg transition-shadow cursor-pointer group relative block{% endif %}"
       data-pswp-width="{{ image.width|default(1600) }}"
       data-pswp-height="{{ image.height|default(1067) }}"
       data-pswp-caption="{{ full_caption|e('html_attr') }}">
      <img src="{{ image.url }}" alt="{{ image.alt|e }}" class="{% if layout == 'masonry' %}w-full h-auto object-cover{% else %}w-full h-full object-cover{% endif %}">
    </a>
  </div>
  {% endfor %}
{% endif %}

<script>
// Update template settings for the new content
window.templateSettings = {{ template_settings ? template_settings|json_encode|raw : '{}' }};
</script>