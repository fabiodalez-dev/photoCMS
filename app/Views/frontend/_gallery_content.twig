{# Template content for AJAX gallery switching #}
{% set layout = template_settings.layout|default('grid') %}
{% set masonry = template_settings.masonry|default(false) %}

{# Handle potentially nested columns structure #}
{% set cols = template_settings.columns is defined ? template_settings.columns : {'desktop': 3, 'tablet': 2, 'mobile': 1} %}

{# Extract column values for grid layout #}
{% if cols.desktop is iterable and cols.desktop.desktop is defined %}
  {% set desktop_cols = cols.desktop.desktop %}
{% elseif cols.desktop is defined %}
  {% set desktop_cols = cols.desktop %}
{% else %}
  {% set desktop_cols = 3 %}
{% endif %}

{% if cols.tablet is iterable and cols.tablet.tablet is defined %}
  {% set tablet_cols = cols.tablet.tablet %}
{% elseif cols.tablet is defined %}
  {% set tablet_cols = cols.tablet %}
{% else %}
  {% set tablet_cols = 2 %}
{% endif %}

{% if cols.mobile is iterable and cols.mobile.mobile is defined %}
  {% set mobile_cols = cols.mobile.mobile %}
{% elseif cols.mobile is defined %}
  {% set mobile_cols = cols.mobile %}
{% else %}
  {% set mobile_cols = 1 %}
{% endif %}

{# Ensure values are numbers #}
{% set desktop_cols = desktop_cols|round %}
{% set tablet_cols = tablet_cols|round %}
{% set mobile_cols = mobile_cols|round %}

{# Render content based on layout type #}
{% import 'frontend/_caption.twig' as Caption %}
{% import 'frontend/_seo_macros.twig' as Seo %}
{% if layout == 'slideshow' %}
  <div class="swiper-wrapper">
    {% for image in images %}
    <div class="swiper-slide">
    {% set seo_title = Seo.seo_title(image, album, site_title)|trim %}
    <a href="{% set lightbox_url = image.lightbox_url|default(image.url) %}{% if lightbox_url starts with '/' %}{{ base_path }}{{ lightbox_url }}{% else %}{{ lightbox_url }}{% endif %}" 
       class="pswp-link image-item aspect-[4/3] bg-neutral-100 rounded-lg overflow-hidden shadow-sm hover:shadow-lg transition-shadow cursor-pointer block"
       title="{{ seo_title|e('html_attr') }}"
       data-pswp-width="{{ image.width|default(1600) }}"
       data-pswp-height="{{ image.height|default(1067) }}"
       data-pswp-caption="{{ Caption.build(image)|e('html_attr') }}"
       data-title="{{ image.caption|default('')|e }}"
       data-alt="{{ image.alt|default('')|e }}"
       data-camera="{{ image.camera|default(image.camera_name)|default(image.custom_camera)|default('')|e }}"
       data-lens="{{ image.lens|default(image.lens_name)|default(image.custom_lens)|default('')|e }}"
       data-film="{{ image.film_display|default(image.custom_film)|default(image.film_name)|default('')|e }}"
       data-developer="{{ image.developer_name|default('')|e }}"
       data-lab="{{ image.lab_name|default('')|e }}"
       data-location="{{ image.location_name|default('')|e }}"
       data-iso="{{ image.iso|default('') }}"
       data-shutter="{{ image.shutter_speed|default('')|e }}"
       data-aperture="{{ image.aperture|default('') }}"
       data-process="{{ image.process|default('')|e }}"
    >
      <picture>
        {% if image.sources.avif|length %}
          <source type="image/avif" srcset="{% for src in image.sources.avif %}{% set src_url = src|split(' ')|first %}{% if src_url starts with '/' %}{{ base_path }}{{ src_url }}{% else %}{{ src_url }}{% endif %} {{ src|split(' ')|slice(1)|join(' ') }}{% if not loop.last %}, {% endif %}{% endfor %}" sizes="100vw">
        {% endif %}
        {% if image.sources.webp|length %}
          <source type="image/webp" srcset="{% for src in image.sources.webp %}{% set src_url = src|split(' ')|first %}{% if src_url starts with '/' %}{{ base_path }}{{ src_url }}{% else %}{{ src_url }}{% endif %} {{ src|split(' ')|slice(1)|join(' ') }}{% if not loop.last %}, {% endif %}{% endfor %}" sizes="100vw">
        {% endif %}
        {% if image.sources.jpg|length %}
          <source type="image/jpeg" srcset="{% for src in image.sources.jpg %}{% set src_url = src|split(' ')|first %}{% if src_url starts with '/' %}{{ base_path }}{{ src_url }}{% else %}{{ src_url }}{% endif %} {{ src|split(' ')|slice(1)|join(' ') }}{% if not loop.last %}, {% endif %}{% endfor %}" sizes="100vw">
        {% endif %}
        <img src="{% set img_src = image.fallback_src|default(image.url) %}{% if img_src starts with '/' %}{{ base_path }}{{ img_src }}{% else %}{{ img_src }}{% endif %}" alt="{{ image.alt|default('Image')|e }}" title="{{ seo_title|e('html_attr') }}" class="w-full h-full object-cover" loading="lazy" decoding="async">
      </picture>
    </a>
    </div>
    {% endfor %}
  </div>
  <div class="swiper-button-next"></div>
  <div class="swiper-button-prev"></div>
  <div class="swiper-pagination"></div>
{% elseif layout == 'fullscreen' %}
  {% for image in images %}
  <div class="masonry-item">
    {% set seo_title = Seo.seo_title(image, album, site_title)|trim %}
    <a href="{% set lightbox_url = image.lightbox_url|default(image.url) %}{% if lightbox_url starts with '/' %}{{ base_path }}{{ lightbox_url }}{% else %}{{ lightbox_url }}{% endif %}" 
       class="pswp-link image-item aspect-[4/3] bg-neutral-100 rounded-lg overflow-hidden shadow-sm hover:shadow-lg transition-shadow cursor-pointer group relative block"
       title="{{ seo_title|e('html_attr') }}"
       data-pswp-width="{{ image.width|default(1600) }}"
       data-pswp-height="{{ image.height|default(1067) }}"
       data-pswp-caption="{{ Caption.build(image)|e('html_attr') }}"
       data-title="{{ image.caption|default('')|e }}"
       data-alt="{{ image.alt|default('')|e }}"
       data-camera="{{ image.camera|default(image.camera_name)|default(image.custom_camera)|default('')|e }}"
       data-lens="{{ image.lens|default(image.lens_name)|default(image.custom_lens)|default('')|e }}"
       data-film="{{ image.film_display|default(image.custom_film)|default(image.film_name)|default('')|e }}"
       data-developer="{{ image.developer_name|default('')|e }}"
       data-lab="{{ image.lab_name|default('')|e }}"
       data-location="{{ image.location_name|default('')|e }}"
       data-iso="{{ image.iso|default('') }}"
       data-shutter="{{ image.shutter_speed|default('')|e }}"
       data-aperture="{{ image.aperture|default('') }}"
       data-process="{{ image.process|default('')|e }}"
    >
      <picture>
        {% if image.sources.avif|length %}
          <source type="image/avif" srcset="{% for src in image.sources.avif %}{% set src_url = src|split(' ')|first %}{% if src_url starts with '/' %}{{ base_path }}{{ src_url }}{% else %}{{ src_url }}{% endif %} {{ src|split(' ')|slice(1)|join(' ') }}{% if not loop.last %}, {% endif %}{% endfor %}" sizes="100vw">
        {% endif %}
        {% if image.sources.webp|length %}
          <source type="image/webp" srcset="{% for src in image.sources.webp %}{% set src_url = src|split(' ')|first %}{% if src_url starts with '/' %}{{ base_path }}{{ src_url }}{% else %}{{ src_url }}{% endif %} {{ src|split(' ')|slice(1)|join(' ') }}{% if not loop.last %}, {% endif %}{% endfor %}" sizes="100vw">
        {% endif %}
        {% if image.sources.jpg|length %}
          <source type="image/jpeg" srcset="{% for src in image.sources.jpg %}{% set src_url = src|split(' ')|first %}{% if src_url starts with '/' %}{{ base_path }}{{ src_url }}{% else %}{{ src_url }}{% endif %} {{ src|split(' ')|slice(1)|join(' ') }}{% if not loop.last %}, {% endif %}{% endfor %}" sizes="100vw">
        {% endif %}
        <img src="{% set img_src = image.fallback_src|default(image.url) %}{% if img_src starts with '/' %}{{ base_path }}{{ img_src }}{% else %}{{ img_src }}{% endif %}" alt="{{ image.alt|e }}" title="{{ seo_title|e('html_attr') }}" class="w-full h-full object-cover" loading="lazy" decoding="async">
      </picture>
    </a>
  </div>
  {% endfor %}
{% elseif masonry %}
  {% for image in images %}
  <div class="masonry-item">
    {% set seo_title = Seo.seo_title(image, album, site_title)|trim %}
    <a href="{% set lightbox_url = image.lightbox_url|default(image.url) %}{% if lightbox_url starts with '/' %}{{ base_path }}{{ lightbox_url }}{% else %}{{ lightbox_url }}{% endif %}" 
       class="pswp-link image-item bg-neutral-100 rounded-lg overflow-hidden shadow-sm hover:shadow-lg transition-shadow cursor-pointer mb-4 group relative block"
       title="{{ seo_title|e('html_attr') }}"
       data-pswp-width="{{ image.width|default(1600) }}"
       data-pswp-height="{{ image.height|default(1067) }}"
       data-pswp-caption="{{ Caption.build(image)|e('html_attr') }}"
       data-title="{{ image.caption|default('')|e }}"
       data-alt="{{ image.alt|default('')|e }}"
       data-camera="{{ image.camera|default(image.camera_name)|default(image.custom_camera)|default('')|e }}"
       data-lens="{{ image.lens|default(image.lens_name)|default(image.custom_lens)|default('')|e }}"
       data-film="{{ image.film_display|default(image.custom_film)|default(image.film_name)|default('')|e }}"
       data-developer="{{ image.developer_name|default('')|e }}"
       data-lab="{{ image.lab_name|default('')|e }}"
       data-location="{{ image.location_name|default('')|e }}"
       data-iso="{{ image.iso|default('') }}"
       data-shutter="{{ image.shutter_speed|default('')|e }}"
       data-aperture="{{ image.aperture|default('') }}"
       data-process="{{ image.process|default('')|e }}"
    >
      <picture>
        {% if image.sources.avif|length %}
          <source type="image/avif" srcset="{% for src in image.sources.avif %}{% set src_url = src|split(' ')|first %}{% if src_url starts with '/' %}{{ base_path }}{{ src_url }}{% else %}{{ src_url }}{% endif %} {{ src|split(' ')|slice(1)|join(' ') }}{% if not loop.last %}, {% endif %}{% endfor %}" sizes="100vw">
        {% endif %}
        {% if image.sources.webp|length %}
          <source type="image/webp" srcset="{% for src in image.sources.webp %}{% set src_url = src|split(' ')|first %}{% if src_url starts with '/' %}{{ base_path }}{{ src_url }}{% else %}{{ src_url }}{% endif %} {{ src|split(' ')|slice(1)|join(' ') }}{% if not loop.last %}, {% endif %}{% endfor %}" sizes="100vw">
        {% endif %}
        {% if image.sources.jpg|length %}
          <source type="image/jpeg" srcset="{% for src in image.sources.jpg %}{% set src_url = src|split(' ')|first %}{% if src_url starts with '/' %}{{ base_path }}{{ src_url }}{% else %}{{ src_url }}{% endif %} {{ src|split(' ')|slice(1)|join(' ') }}{% if not loop.last %}, {% endif %}{% endfor %}" sizes="100vw">
        {% endif %}
        <img src="{% set img_src = image.fallback_src|default(image.url) %}{% if img_src starts with '/' %}{{ base_path }}{{ img_src }}{% else %}{{ img_src }}{% endif %}" alt="{{ image.alt|e }}" title="{{ seo_title|e('html_attr') }}" class="w-full h-auto object-cover" loading="lazy" decoding="async">
      </picture>
    </a>
  </div>
  {% endfor %}
{% else %}
  {# Regular grid layout #}
  {% for image in images %}
  <div class="image-item group relative">
    {% set seo_title = Seo.seo_title(image, album, site_title)|trim %}
    <a href="{% set lightbox_url = image.lightbox_url|default(image.url) %}{% if lightbox_url starts with '/' %}{{ base_path }}{{ lightbox_url }}{% else %}{{ lightbox_url }}{% endif %}" 
       class="pswp-link aspect-square bg-neutral-100 rounded-lg overflow-hidden shadow-sm hover:shadow-lg transition-shadow cursor-pointer block"
       title="{{ seo_title|e('html_attr') }}"
       data-pswp-width="{{ image.width|default(1600) }}"
       data-pswp-height="{{ image.height|default(1067) }}"
       data-pswp-caption=""
       data-title="{{ image.caption|default('')|e }}"
       data-alt="{{ image.alt|default('')|e }}"
       data-camera="{{ image.camera|default(image.camera_name)|default(image.custom_camera)|default('')|e }}"
       data-lens="{{ image.lens|default(image.lens_name)|default(image.custom_lens)|default('')|e }}"
       data-film="{{ image.film_name|default(image.custom_film)|default('')|e }}"
       data-developer="{{ image.developer_name|default('')|e }}"
       data-lab="{{ image.lab_name|default('')|e }}"
       data-location="{{ image.location_name|default('')|e }}"
       data-iso="{{ image.iso|default('') }}"
       data-shutter="{{ image.shutter_speed|default('')|e }}"
       data-aperture="{{ image.aperture|default('') }}"
       data-process="{{ image.process|default('')|e }}"
    >
      <picture>
        {% if image.sources.avif|length %}
          <source type="image/avif" srcset="{% for src in image.sources.avif %}{% set src_url = src|split(' ')|first %}{% if src_url starts with '/' %}{{ base_path }}{{ src_url }}{% else %}{{ src_url }}{% endif %} {{ src|split(' ')|slice(1)|join(' ') }}{% if not loop.last %}, {% endif %}{% endfor %}" sizes="100vw">
        {% endif %}
        {% if image.sources.webp|length %}
          <source type="image/webp" srcset="{% for src in image.sources.webp %}{% set src_url = src|split(' ')|first %}{% if src_url starts with '/' %}{{ base_path }}{{ src_url }}{% else %}{{ src_url }}{% endif %} {{ src|split(' ')|slice(1)|join(' ') }}{% if not loop.last %}, {% endif %}{% endfor %}" sizes="100vw">
        {% endif %}
        {% if image.sources.jpg|length %}
          <source type="image/jpeg" srcset="{% for src in image.sources.jpg %}{% set src_url = src|split(' ')|first %}{% if src_url starts with '/' %}{{ base_path }}{{ src_url }}{% else %}{{ src_url }}{% endif %} {{ src|split(' ')|slice(1)|join(' ') }}{% if not loop.last %}, {% endif %}{% endfor %}" sizes="100vw">
        {% endif %}
        <img src="{% set img_src = image.fallback_src|default(image.url) %}{% if img_src starts with '/' %}{{ base_path }}{{ img_src }}{% else %}{{ img_src }}{% endif %}" alt="{{ image.alt|e }}" title="{{ seo_title|e('html_attr') }}" class="w-full h-full object-cover" loading="lazy" decoding="async">
      </picture>
      <div class="hidden-caption-content">
        {% if image.caption %}<div class="mb-1">{{ image.caption }}</div>{% endif %}
        {% if image.custom_camera or image.camera_name or image.custom_lens or image.lens_name or image.custom_film or image.film_name or image.location_name or image.developer_name or image.lab_name or image.iso or image.shutter_speed or image.aperture %}
        <div class="mt-1 flex flex-wrap gap-x-3 gap-y-1 items-center text-sm">
          {% if image.custom_camera or image.camera_name %}<span class="inline-flex items-center"><i class="fas fa-camera mr-1"></i>{{ image.custom_camera|default(image.camera_name) }}</span>{% endif %}
          {% if image.custom_lens or image.lens_name %}<span class="inline-flex items-center"><i class="fas fa-dot-circle mr-1"></i>{{ image.custom_lens|default(image.lens_name) }}</span>{% endif %}
          {% if image.custom_film or image.film_name %}<span class="inline-flex items-center"><i class="fas fa-film mr-1"></i>{{ image.custom_film|default(image.film_name) }}</span>{% endif %}
          {% if image.location_name %}<span class="inline-flex items-center"><i class="fas fa-map-marker-alt mr-1"></i>{{ image.location_name }}</span>{% endif %}
          {% if image.developer_name %}<span class="inline-flex items-center"><i class="fas fa-flask mr-1"></i>{{ image.developer_name }}</span>{% endif %}
          {% if image.lab_name %}<span class="inline-flex items-center"><i class="fas fa-industry mr-1"></i>{{ image.lab_name }}</span>{% endif %}
          {% if image.iso %}<span class="inline-flex items-center"><i class="fas fa-signal mr-1"></i>ISO {{ image.iso }}</span>{% endif %}
          {% if image.shutter_speed %}<span class="inline-flex items-center"><i class="far fa-clock mr-1"></i>{{ image.shutter_speed }}</span>{% endif %}
          {% if image.aperture %}<span class="inline-flex items-center"><i class="fas fa-circle-half-stroke mr-1"></i>f/{{ image.aperture }}</span>{% endif %}
        </div>
        {% endif %}
      </div>
    </a>
  </div>
  {% endfor %}
{% endif %}

{# Include template settings for JavaScript #}
<script nonce="{{ csp_nonce() }}">
window.templateSettings = JSON.parse('{{ template_settings|json_encode|e('js') }}');
</script>
