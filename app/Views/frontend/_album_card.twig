<article class="album-card group cursor-pointer" data-album-id="{{ album.id }}"{% if album.is_nsfw and not is_admin %} data-nsfw="1"{% endif %}>
  <a href="{{ base_path }}/album/{{ album.slug }}" class="block">
    <div class="aspect-[3/2] overflow-hidden bg-neutral-100 rounded-sm relative">
      {% if album.cover %}
        {# Find blur variant if album is NSFW #}
        {% set blur_path = null %}
        {% if album.is_nsfw and not is_admin %}
          {% for variant in album.cover.variants %}
            {% if variant.variant == 'blur' %}
              {% set blur_path = variant.path starts with '/' ? base_path ~ variant.path : variant.path %}
            {% endif %}
          {% endfor %}
        {% endif %}

        <picture>
          {# SECURITY: For NSFW albums, only show blur image - never expose real URLs in srcset or data-src #}
          {% if album.is_nsfw and not is_admin and blur_path %}
          <img src="{{ blur_path }}"
               alt="{{ album.cover.alt_text|e }}"
               width="{{ album.cover.width }}"
               height="{{ album.cover.height }}"
               loading="lazy"
               decoding="async"
               class="nsfw-card-image w-full h-full object-cover transition-transform duration-200 group-hover:scale-105">
          {% elseif album.is_nsfw and not is_admin %}
          {# NSFW without blur variant - show placeholder, DO NOT expose real image URL #}
          <div class="w-full h-full bg-gradient-to-br from-neutral-300 to-neutral-400 flex items-center justify-center aspect-[3/2]">
            <i class="fas fa-eye-slash text-3xl text-neutral-500"></i>
          </div>
          {% else %}
          {% set variants_avif = [] %}
          {% set variants_webp = [] %}
          {% set variants_jpg = [] %}
          {% for variant in album.cover.variants %}
            {% set variant_url = variant.path starts with '/' ? base_path ~ variant.path : variant.path %}
            {% if variant.format == 'avif' %}
              {% set variants_avif = variants_avif|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
            {% elseif variant.format == 'webp' %}
              {% set variants_webp = variants_webp|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
            {% elseif variant.format == 'jpg' %}
              {% set variants_jpg = variants_jpg|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
            {% endif %}
          {% endfor %}

          {# Sizes ottimizzate per album cards grid:
             - Desktop (1280px+): 3-4 colonne = 30vw
             - Laptop (1024px+): 3 colonne = 32vw
             - Tablet (768px+): 2 colonne = 48vw
             - Mobile (640px+): 1 colonna = 95vw
             - Mobile small: full width = 100vw #}
          {% if variants_avif %}
            <source type="image/avif" srcset="{{ variants_avif|join(', ') }}" sizes="(min-width: 1280px) 28vw, (min-width: 1024px) 30vw, (min-width: 768px) 46vw, (min-width: 640px) 95vw, 100vw">
          {% endif %}
          {% if variants_webp %}
            <source type="image/webp" srcset="{{ variants_webp|join(', ') }}" sizes="(min-width: 1280px) 28vw, (min-width: 1024px) 30vw, (min-width: 768px) 46vw, (min-width: 640px) 95vw, 100vw">
          {% endif %}

          {% set card_img_url = album.cover.variants[0].path ?? album.cover.original_path %}
          {% set original_url = card_img_url starts with '/' ? base_path ~ card_img_url : card_img_url %}

          <img src="{{ original_url }}"
               alt="{{ (album.cover.alt_text ?? album.title)|e }}"
               width="{{ album.cover.width }}"
               height="{{ album.cover.height }}"
               loading="lazy"
               decoding="async"
               class="w-full h-full object-cover transition-transform duration-200 group-hover:scale-105">
          {% endif %}
        </picture>

        {# NSFW Overlay (skip for admins) - pointer-events-none to allow clicks through #}
        {% if album.is_nsfw and not is_admin %}
        <div class="absolute inset-0 bg-black/50 flex flex-col items-center justify-center text-white backdrop-blur-sm pointer-events-none z-10" role="img" aria-label="{{ trans('album.nsfw_warning_short') }}">
          <i class="fas fa-eye-slash text-2xl mb-1" aria-hidden="true"></i>
          <span class="text-xs font-medium">{{ trans('album.nsfw_warning_short') }}</span>
        </div>
        {% endif %}

        {# Password Protected Badge #}
        {% if album.is_password_protected or album.password_hash %}
        <div class="absolute top-2 right-2 text-white z-20 drop-shadow-[0_2px_4px_rgba(0,0,0,0.5)]" title="{{ trans('album.password_protected') }}">
          <i class="fas fa-lock text-lg"></i>
        </div>
        {% endif %}

        {# Category Badge - above NSFW overlay #}
        {% if album.category_name %}
        <div class="absolute top-2 left-2 z-20">
          {% if album.category_slug %}
          <a href="{{ base_path }}/category/{{ album.category_slug }}" class="inline-flex items-center gap-2 text-xs font-medium px-2.5 py-1 rounded-full border border-neutral-300 bg-white text-neutral-700 hover:bg-neutral-100 hover:text-black transition-colors" title="{{ album.category_name|e }}">
            <span class="w-1.5 h-1.5 rounded-full bg-neutral-700"></span>{{ album.category_name|e }}
          </a>
          {% else %}
          <span class="inline-flex items-center gap-2 text-xs font-medium px-2.5 py-1 rounded-full border border-neutral-300 bg-white text-neutral-700" title="{{ album.category_name|e }}">
            <span class="w-1.5 h-1.5 rounded-full bg-neutral-700"></span>{{ album.category_name|e }}
          </span>
          {% endif %}
        </div>
        {% endif %}

      {% else %}
        <div class="w-full h-full bg-neutral-200 flex items-center justify-center">
          <span class="text-neutral-400 text-sm">{{ trans('general.no_cover') }}</span>
        </div>
      {% endif %}
    </div>
    
    <div class="pt-3 pb-2">
      <h3 class="text-lg font-medium text-black group-hover:text-neutral-700 transition-colors">
        {{ album.title|e }}
      </h3>
      
      <div class="flex flex-wrap items-center gap-1 mt-1 text-sm text-neutral-600">
        {% if album.tags %}
          {% for tag in album.tags %}
            <span class="tag">#{{ tag.name|e }}</span>{% if not loop.last %},{% endif %}
          {% endfor %}
        {% endif %}
        {% if album.shoot_date %}
          {% if album.tags %}<span class="text-neutral-400">â€¢</span>{% endif %}
          <time datetime="{{ album.shoot_date }}">{{ album.shoot_date|date('Y') }}</time>
        {% endif %}
      </div>
      
{% if album.excerpt %}
        <p class="mt-2 text-sm text-neutral-600 line-clamp-2">
          {{ album.excerpt|e }}
        </p>
      {% endif %}
    </div>
  </a>
</article>
