{% extends "frontend/_layout.twig" %}

{% block styles %}
<style nonce="{{ csp_nonce() }}">
body {
  overflow-x: hidden;
}

/* Ensure mobile search toggle hidden on desktop (reinforce Tailwind md:hidden) */
@media (min-width: 768px) {
  #mobile-search-toggle {
    display: none !important;
  }
}

/* Reset only for parallax gallery */
.gallery, .gallery * {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

.gallery-track {
  position: fixed;
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 0.25rem;
  padding: 0.25rem;
  will-change: transform;
  z-index: 1;
}

.card {
  height: 400px;
  overflow: hidden;
}

.card .card-image-wrapper {
  height: 135%;
  will-change: transform;
}

.card .card-image-wrapper img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.card-link {
  display: block;
  width: 100%;
  height: 100%;
  position: relative;
}

.card-overlay {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  padding: 1rem;
  background: linear-gradient(transparent, rgba(0,0,0,0.7));
  color: white;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.card:hover .card-overlay {
  opacity: 1;
}

.card-overlay h3 {
  font-size: 0.875rem;
  font-weight: 600;
  margin: 0 0 0.25rem 0;
}

.card-overlay p {
  font-size: 0.75rem;
  opacity: 0.8;
  margin: 0;
}

@media (width < 800px) {
  .gallery-track {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (width < 550px) {
  .gallery-track {
    grid-template-columns: repeat(1, 1fr);
  }
}
</style>
{% endblock %}

{% block content %}
{# Hook: frontend_home_before - Before all home page content #}
{{ do_action('frontend_home_before', {base_path: base_path}) }}

{# WebSite JSON-LD for home page #}
<script type="application/ld+json" nonce="{{ csp_nonce() }}">
{
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": {{ site_title|default('Portfolio')|json_encode|raw }},
  "url": {{ (canonical_url|default(current_url))|json_encode|raw }},
  {% if meta_description %}
  "description": {{ meta_description|json_encode|raw }},
  {% endif %}
  "potentialAction": {
    "@type": "SearchAction",
    "target": {
      "@type": "EntryPoint",
      "urlTemplate": "{{ base_path }}/{{ galleries_slug|default('galleries') }}?q={search_term_string}"
    },
    "query-input": "required name=search_term_string"
  }
}
</script>

{% if all_images|length > 0 %}
<main class="gallery" data-parallax-gallery>
  <div class="gallery-track" data-parallax-track>
    {% for image in all_images %}
    <div class="card" data-parallax-card>
      {% set album_url = '/album/' ~ image.album_slug %}
      <a href="{% if album_url starts with '/' %}{{ base_path }}{{ album_url }}{% else %}{{ album_url }}{% endif %}" class="card-link">
        <div class="card-image-wrapper">
          {% set raw_path = image.fallback_src|default(image.original_path) %}
          {% set img_src = raw_path starts with '/' ? base_path ~ raw_path : raw_path %}
          {% set variants_avif = [] %}
          {% set variants_webp = [] %}
          {% set variants_jpg = [] %}
          {% set best_jpg_path = img_src %}
          {% set best_jpg_w = 0 %}
          {% for variant in image.variants|default([]) %}
            {% set variant_url = variant.path starts with '/' ? base_path ~ variant.path : variant.path %}
            {% if variant.format == 'avif' %}
              {% set variants_avif = variants_avif|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
            {% elseif variant.format == 'webp' %}
              {% set variants_webp = variants_webp|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
            {% elseif variant.format == 'jpg' %}
              {% set variants_jpg = variants_jpg|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
              {% if variant.width > best_jpg_w %}
                {% set best_jpg_path = variant_url %}
                {% set best_jpg_w = variant.width %}
              {% endif %}
            {% endif %}
          {% endfor %}
          <picture>
            {% if variants_avif %}
              <source type="image/avif" srcset="{{ variants_avif|join(', ') }}" sizes="(min-width: 1200px) 33vw, (min-width: 768px) 50vw, 100vw">
            {% endif %}
            {% if variants_webp %}
              <source type="image/webp" srcset="{{ variants_webp|join(', ') }}" sizes="(min-width: 1200px) 33vw, (min-width: 768px) 50vw, 100vw">
            {% endif %}
            <img
              src="{{ best_jpg_path|e('html_attr') }}"
              alt="{{ image.title|default(image.album_title)|e('html_attr') }}"
              loading="lazy"
              decoding="async"
              data-fallback="hide"
              data-parallax-image
            >
          </picture>
        </div>
        <div class="card-overlay">
          <h3>{{ image.album_title|e }}</h3>
          <p>{{ image.category_name|e }}</p>
        </div>
      </a>
    </div>
    {% endfor %}
  </div>
</main>
{% else %}
{# Empty state #}
<div class="min-h-screen flex items-center justify-center">
  <div class="text-center px-4">
    <i class="fas fa-images text-6xl text-gray-300 mb-6"></i>
    <h2 class="text-2xl font-semibold text-gray-800 mb-2">{{ home_settings.empty_title|default(trans('home.empty_title'))|e }}</h2>
    <p class="text-gray-600">{{ home_settings.empty_text|default(trans('home.empty_text'))|e }}</p>
  </div>
</div>
{% endif %}

{# Hook: frontend_home_after - After all home page content #}
{{ do_action('frontend_home_after', {base_path: base_path}) }}
{% endblock %}

{% block scripts %}
<script nonce="{{ csp_nonce() }}">
(function() {
  'use strict';

  const gallery = document.querySelector('[data-parallax-gallery]');
  const track = document.querySelector('[data-parallax-track]');
  const cards = document.querySelectorAll('[data-parallax-card]');

  if (!gallery || !track || !cards.length) return;

  const easing = 0.05;
  let startY = 0;
  let endY = 0;
  let raf;

  const lerp = (start, end, t) => start * (1 - t) + end * t;

  function updateScroll() {
    startY = lerp(startY, endY, easing);
    gallery.style.height = `${track.clientHeight}px`;
    track.style.transform = `translateY(-${startY}px)`;
    activateParallax();
    raf = requestAnimationFrame(updateScroll);
    if (startY.toFixed(1) === window.scrollY.toFixed(1)) cancelAnimationFrame(raf);
  }

  function startScroll() {
    endY = window.scrollY;
    cancelAnimationFrame(raf);
    raf = requestAnimationFrame(updateScroll);
  }

  function parallax(card) {
    const wrapper = card.querySelector('.card-image-wrapper');
    const diff = card.offsetHeight - wrapper.offsetHeight;
    const { top } = card.getBoundingClientRect();
    const progress = top / window.innerHeight;
    const yPos = diff * progress;
    wrapper.style.transform = `translateY(${yPos}px)`;
  }

  const activateParallax = () => cards.forEach(parallax);

  function init() {
    activateParallax();
    startScroll();
  }

  window.addEventListener('load', updateScroll, false);
  window.addEventListener('scroll', init, false);
  window.addEventListener('resize', updateScroll, false);
})();
</script>
{% endblock %}
