{% extends 'frontend/_layout.twig' %}
{% import 'frontend/_seo_macros.twig' as Seo %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
  {% include 'frontend/_breadcrumbs.twig' %}
</div>
<div class="min-h-screen bg-gradient-to-br from-gray-50 to-white">
  <!-- Hero Section -->
  <div class="relative bg-white border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
      <div class="text-center">
        <h1 class="text-4xl md:text-5xl font-light text-black mb-6 tracking-tight" data-gsap="title">
          {{ page_texts.title|default(trans('galleries.title'))|e }}
        </h1>
        <p class="text-xl text-gray-600 max-w-3xl mx-auto leading-relaxed" data-gsap="subtitle">
          {{ page_texts.subtitle|default(trans('galleries.subtitle'))|e }}
        </p>
      </div>
    </div>
  </div>

  <!-- Advanced Filters Panel -->
  {# Check if there are any actual filter options to show #}
  {% set has_filter_options =
    (filter_settings.show_categories and filter_options.categories|length > 0) or
    (filter_settings.show_tags and filter_options.tags|length > 0) or
    (filter_settings.show_cameras and filter_options.cameras|length > 0) or
    (filter_settings.show_lenses and filter_options.lenses|length > 0) or
    (filter_settings.show_films and filter_options.films|length > 0) or
    (filter_settings.show_locations and filter_options.locations|length > 0) or
    (filter_settings.show_year and filter_options.years|length > 0)
  %}
  {% if filter_settings.enabled and has_filter_options %}
  <div id="filters-section" class="bg-white/95 backdrop-blur-sm border-b border-gray-200 sticky top-0 z-40 shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
      <!-- Filter Toggle Button -->
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <button id="toggle-filters" class="flex items-center gap-3 px-4 py-2 bg-black text-white rounded-lg hover:bg-gray-800 transition-colors duration-150" data-gsap="filter-toggle">
            <i class="fas fa-filter"></i>
            <span class="font-medium">{{ trans('filter.filters') }}</span>
            <i class="fas fa-chevron-down transition-transform duration-300" id="filter-chevron"></i>
          </button>
          
          <div id="active-filters" class="flex items-center gap-2 opacity-0" data-gsap="active-filters">
            <!-- Active filters will be populated here -->
          </div>
        </div>
        
        <div class="flex items-center gap-4">
          <div class="text-sm text-gray-600 font-medium" id="results-count">
            {% if albums|length == 1 %}
              {{ trans('filter.gallery_count') }}
            {% else %}
              {{ trans('filter.galleries_count', {count: albums|length}) }}
            {% endif %}
          </div>

          <button id="clear-filters" class="text-sm text-gray-500 hover:text-red-600 transition-colors opacity-0 px-3 py-1 rounded hover:bg-gray-100" data-gsap="clear-filters">
            <i class="fas fa-times mr-1"></i>
            {{ trans('filter.clear') }}
          </button>
        </div>
      </div>
      
      <!-- Filters Grid with proper spacing -->
      <div id="filters-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4 opacity-0 max-h-0 overflow-hidden" data-gsap="filters-grid">
        
        <!-- Categories Filter -->
        {% if filter_settings.show_categories and filter_options.categories|length > 0 %}
        <div class="filter-group" data-gsap="filter-category">
          <label class="block text-xs font-semibold text-gray-900 mb-2">
            <i class="fas fa-folder-open mr-1 text-gray-600"></i>
            {{ trans('filter.categories') }}
          </label>
          <div class="relative mb-3">
            <label for="filter-categories-search" class="sr-only">{{ trans('filter.search') }}</label>
            <input type="search"
                   id="filter-categories-search"
                   class="w-full px-3 py-2 pl-8 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent transition-colors duration-150 text-sm"
                   placeholder="{{ trans('filter.search') }}"
                   autocomplete="off">
            <i class="fas fa-search absolute left-2.5 top-1/2 transform -translate-y-1/2 text-gray-400 text-xs"></i>
          </div>
          <div id="filter-categories" class="flex flex-wrap gap-2 max-h-40 overflow-auto pr-1">
            {% for category in filter_options.categories %}
            {% set is_active = category.id in active_filters.category|default([]) %}
            <button type="button"
                    class="filter-chip{{ is_active ? ' is-active' : '' }}"
                    data-category-id="{{ category.id }}"
                    data-category-name="{{ category.name|e('html_attr') }}"
                    data-category-search="{{ category.name|lower|e('html_attr') }}"
                    aria-pressed="{{ is_active ? 'true' : 'false' }}">
              <span class="filter-chip-label">{{ category.name|e }}</span>
              <span class="filter-chip-count">({{ category.albums_count }})</span>
            </button>
            {% endfor %}
          </div>
        </div>
        {% endif %}
        
        <!-- Tags Filter -->
        {% if filter_settings.show_tags and filter_options.tags|length > 0 %}
        <div class="filter-group hidden md:block" data-gsap="filter-tags">
          <label for="filter-tags" class="block text-xs font-semibold text-gray-900 mb-2">
            <i class="fas fa-tags mr-1 text-gray-600"></i>
            {{ trans('filter.tags') }}
          </label>
          <select id="filter-tags" class="filter-select" multiple data-placeholder="{{ trans('filter.select_tags') }}">
            {% for tag in filter_options.tags %}
            <option value="{{ tag.id }}" {% if tag.id in active_filters.tags|default([]) %}selected{% endif %}>
              {{ tag.name }} ({{ tag.albums_count }})
            </option>
            {% endfor %}
          </select>
        </div>
        {% endif %}
        
        <!-- Cameras Filter -->
        {% if filter_settings.show_cameras and filter_options.cameras|length > 0 %}
        <div class="filter-group hidden md:block" data-gsap="filter-cameras">
          <label for="filter-cameras" class="block text-xs font-semibold text-gray-900 mb-2">
            <i class="fas fa-camera mr-1 text-gray-600"></i>
            {{ trans('album.camera') }}
          </label>
          <select id="filter-cameras" class="filter-select" multiple data-placeholder="{{ trans('filter.select_cameras') }}">
            {% for camera in filter_options.cameras %}
            <option value="{{ camera.id }}" {% if camera.id in active_filters.cameras|default([]) %}selected{% endif %}>
              {{ camera.make }} {{ camera.model }} ({{ camera.albums_count }})
            </option>
            {% endfor %}
          </select>
        </div>
        {% endif %}
        
        <!-- Lenses Filter -->
        {% if filter_settings.show_lenses and filter_options.lenses|length > 0 %}
        <div class="filter-group hidden md:block" data-gsap="filter-lenses">
          <label for="filter-lenses" class="block text-xs font-semibold text-gray-900 mb-2">
            <i class="fas fa-eye mr-1 text-gray-600"></i>
            {{ trans('album.lens') }}
          </label>
          <select id="filter-lenses" class="filter-select" multiple data-placeholder="{{ trans('filter.select_lenses') }}">
            {% for lens in filter_options.lenses %}
            <option value="{{ lens.id }}" {% if lens.id in active_filters.lenses|default([]) %}selected{% endif %}>
              {{ lens.brand }} {{ lens.model }} ({{ lens.albums_count }})
            </option>
            {% endfor %}
          </select>
        </div>
        {% endif %}
        
        <!-- Films Filter -->
        {% if filter_settings.show_films and filter_options.films|length > 0 %}
        <div class="filter-group hidden md:block" data-gsap="filter-films">
          <label for="filter-films" class="block text-xs font-semibold text-gray-900 mb-2">
            <i class="fas fa-film mr-1 text-gray-600"></i>
            {{ trans('filter.film') }}
          </label>
          <select id="filter-films" class="filter-select" multiple data-placeholder="{{ trans('filter.select_films') }}">
            {% for film in filter_options.films %}
            <option value="{{ film.id }}" {% if film.id in active_filters.films|default([]) %}selected{% endif %}>
              {{ film.brand }} {{ film.name }} ({{ film.albums_count }})
            </option>
            {% endfor %}
          </select>
        </div>
        {% endif %}
        
        <!-- Locations Filter -->
        {% if filter_settings.show_locations and filter_options.locations|length > 0 %}
        <div class="filter-group hidden md:block" data-gsap="filter-locations">
          <label for="filter-locations" class="block text-xs font-semibold text-gray-900 mb-2">
            <i class="fas fa-map-marker-alt mr-1 text-gray-600"></i>
            {{ trans('filter.location') }}
          </label>
          <select id="filter-locations" class="filter-select" multiple data-placeholder="{{ trans('filter.select_locations') }}">
            {% for location in filter_options.locations %}
            <option value="{{ location.id }}" {% if location.id in active_filters.locations|default([]) %}selected{% endif %}>
              {{ location.name }} ({{ location.albums_count }})
            </option>
            {% endfor %}
          </select>
        </div>
        {% endif %}
        
        <!-- Year Filter -->
        {% if filter_settings.show_year and filter_options.years|length > 0 %}
        <div class="filter-group hidden md:block" data-gsap="filter-year">
          <label for="filter-year" class="block text-xs font-semibold text-gray-900 mb-2">
            <i class="fas fa-calendar mr-1 text-gray-600"></i>
            {{ trans('filter.year') }}
          </label>
          <select id="filter-year" class="filter-select" data-placeholder="{{ trans('filter.select_year') }}">
            <option value="">{{ trans('filter.all') }}</option>
            {% for year in filter_options.years %}
            <option value="{{ year.year }}" {% if year.year == active_filters.year|default('') %}selected{% endif %}>
              {{ year.year }} ({{ year.albums_count }})
            </option>
            {% endfor %}
          </select>
        </div>
        {% endif %}
        
        <!-- Search Filter -->
        <div class="filter-group md:col-span-2" data-gsap="filter-search">
          <label for="filter-search" class="block text-xs font-semibold text-gray-900 mb-2">
            <i class="fas fa-search mr-1 text-gray-600"></i>
            {{ trans('filter.search') }}
          </label>
          <div class="relative">
            <input type="text" id="filter-search" class="w-full px-3 py-2 pl-8 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent transition-colors duration-150 text-sm" placeholder="{{ trans('search.placeholder') }}" value="{{ active_filters.search|default('') }}">
            <i class="fas fa-search absolute left-2.5 top-1/2 transform -translate-y-1/2 text-gray-400 text-xs"></i>
          </div>
        </div>
        
        <!-- Sort Filter -->
        <div class="filter-group" data-gsap="filter-sort">
          <label for="filter-sort" class="block text-xs font-semibold text-gray-900 mb-2">
            <i class="fas fa-sort mr-1 text-gray-600"></i>
            {{ trans('filter.sort') }}
          </label>
          <select id="filter-sort" class="filter-select">
            <option value="published_desc" {% if active_filters.sort == 'published_desc' %}selected{% endif %}>{{ trans('filter.sort_latest') }}</option>
            <option value="published_asc" {% if active_filters.sort == 'published_asc' %}selected{% endif %}>{{ trans('filter.sort_oldest') }}</option>
            <option value="title_asc" {% if active_filters.sort == 'title_asc' %}selected{% endif %}>{{ trans('filter.sort_title_asc') }}</option>
            <option value="title_desc" {% if active_filters.sort == 'title_desc' %}selected{% endif %}>{{ trans('filter.sort_title_desc') }}</option>
            <option value="shoot_date_desc" {% if active_filters.sort == 'shoot_date_desc' %}selected{% endif %}>{{ trans('filter.sort_date_new') }}</option>
            <option value="shoot_date_asc" {% if active_filters.sort == 'shoot_date_asc' %}selected{% endif %}>{{ trans('filter.sort_date_old') }}</option>
          </select>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
  
  <!-- Loading Overlay -->
  <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
    <div class="text-center">
      <div class="animate-spin w-12 h-12 border-4 border-gray-200 border-t-black rounded-full mb-4"></div>
      <p class="text-gray-600 font-medium">{{ trans('general.loading') }}</p>
    </div>
  </div>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <!-- Galleries Grid -->
    <div id="galleries-grid" class="grid gap-8"
         style="grid-template-columns: repeat({{ filter_settings.grid_columns_mobile }}, 1fr); gap: {{ filter_settings.grid_gap == 'small' ? '1rem' : (filter_settings.grid_gap == 'large' ? '2rem' : '1.5rem') }};"
         data-desktop-cols="{{ filter_settings.grid_columns_desktop }}"
         data-tablet-cols="{{ filter_settings.grid_columns_tablet }}"
         data-mobile-cols="{{ filter_settings.grid_columns_mobile }}"
         data-gap="{{ filter_settings.grid_gap }}">
      
      {% for album in albums %}
      {% set seo_title = Seo.seo_title({'alt': album.cover_image.alt_text|default('')}, album, site_title)|trim %}
      <article class="gallery-card group flex flex-col h-full cursor-pointer overflow-hidden rounded-2xl bg-white shadow-md hover:shadow-lg transition-shadow duration-300 ease-out"
               data-gsap="gallery-card"
               data-album-id="{{ album.id }}"
               data-nsfw="{{ album.is_nsfw and not is_admin ? '1' : '0' }}"
               data-password-protected="{{ album.is_password_protected ? '1' : '0' }}"
               data-album-url="{{ base_path }}/album/{{ album.slug }}"
               data-action="open-album"
               aria-label="{{ seo_title|e('html_attr') }}">
        {% set can_show_nsfw = (nsfw_consent|default(false)) or (is_admin|default(false)) %}
        {% set is_nsfw_unconfirmed = album.is_nsfw and not can_show_nsfw %}

        <!-- Cover Image -->
        <div class="relative aspect-[4/3] overflow-hidden bg-gray-100">
          {% if album.cover_image %}
            {% if is_nsfw_unconfirmed %}
              {% set blur_path = album.cover_image.blur_path|default(null) %}
              {% if blur_path %}
              <img src="{% if blur_path starts with '/' %}{{ base_path }}{{ blur_path }}{% else %}{{ blur_path }}{% endif %}"
                   alt="{{ album.cover_image.alt_text|default(album.title)|e }}"
                   title="{{ seo_title|e('html_attr') }}"
                   class="nsfw-blur w-full h-full object-cover transition-transform duration-300 ease-out group-hover:scale-[1.03]"
                   loading="lazy"
                   data-fallback="hide">
              {% else %}
              <div class="w-full h-full bg-gradient-to-br from-gray-300 to-gray-400 flex items-center justify-center">
                <i class="fas fa-eye-slash text-4xl text-gray-500"></i>
              </div>
              {% endif %}
            {% else %}
              {% if album.cover_image.preview_path or album.cover_image.original_path %}
                {% set cover_path = album.cover_image.preview_path|default(album.cover_image.original_path) %}
                <img src="{% if cover_path starts with '/' %}{{ base_path }}{{ cover_path }}{% else %}{{ cover_path }}{% endif %}"
                     alt="{{ album.cover_image.alt_text|default(album.title)|e }}"
                     title="{{ seo_title|e('html_attr') }}"
                     class="w-full h-full object-cover transition-transform duration-300 ease-out group-hover:scale-[1.03]"
                     loading="lazy"
                     data-fallback="hide">
              {% else %}
                <div class="w-full h-full flex items-center justify-center text-gray-400">
                  <i class="fas fa-images text-4xl"></i>
                </div>
              {% endif %}
            {% endif %}
          {% else %}
            <div class="w-full h-full flex items-center justify-center text-gray-400">
              <i class="fas fa-images text-4xl"></i>
            </div>
          {% endif %}

          <!-- NSFW Overlay (skip for admins) - pointer-events-none to allow clicks through -->
          {% if is_nsfw_unconfirmed %}
          <div class="nsfw-overlay absolute inset-0 bg-black/60 flex flex-col items-center justify-center text-white backdrop-blur-sm pointer-events-none z-10">
            <i class="fas fa-eye-slash text-3xl mb-2"></i>
            <span class="text-sm font-medium">{{ trans('album.nsfw_warning_short') }}</span>
          </div>
          {% endif %}

          <!-- Top Right Badges (lock + count) -->
          <div class="absolute top-4 right-4 flex items-center gap-2 z-20">
            {% if album.is_password_protected %}
            <div class="text-white drop-shadow-[0_2px_4px_rgba(0,0,0,0.5)]" title="{{ trans('album.password_protected') }}">
              <i class="fas fa-lock text-lg"></i>
            </div>
            {% endif %}
            {% if album.images_count > 0 %}
            <div class="bg-black/70 text-white px-3 py-1.5 rounded-full text-sm font-medium backdrop-blur-sm">
              <i class="fas fa-images mr-1"></i>
              {{ album.images_count }}
            </div>
            {% endif %}
          </div>

          <!-- Category Badge -->
          {% if album.category_name %}
          <div class="absolute top-4 left-4 bg-white/90 text-black px-3 py-1.5 rounded-full text-xs font-semibold backdrop-blur-sm z-20">
            {{ album.category_name }}
          </div>
          {% endif %}
        </div>
        
        <!-- Content -->
        <div class="p-6 flex flex-col flex-1">
          <h3 class="text-xl font-semibold text-black mb-3 group-hover:text-gray-700 transition-colors duration-200 line-clamp-2">
            {{ album.title|e }}
          </h3>
          
          {% if album.excerpt %}
          <p class="text-gray-600 mb-4 line-clamp-3 leading-relaxed">
            {{ album.excerpt|e }}
          </p>
          {% endif %}
          
          <!-- Tags -->
          {% if album.tags|length > 0 %}
          <div class="flex flex-wrap gap-2 mt-4 mb-4 pt-4 border-t border-gray-100">
            {% for tag in album.tags|slice(0, 3) %}
            <a href="{{ base_path }}/tag/{{ tag.slug }}" class="inline-block bg-gray-100 text-gray-700 text-xs px-2 py-1 rounded-full hover:bg-gray-200 transition-colors" data-action="tag-link">
              #{{ tag.name|e }}
            </a>
            {% endfor %}
            {% if album.tags|length > 3 %}
            <span class="inline-block text-gray-400 text-xs px-2 py-1">
              {{ trans('general.more_count', {count: album.tags|length - 3}) }}
            </span>
            {% endif %}
          </div>
          {% endif %}

          <!-- Meta Info -->
          <div class="mt-auto flex items-center justify-between text-sm text-gray-500">
            <div class="flex items-center gap-4">
              {% if album.shoot_date %}
              <span class="flex items-center gap-1">
                <i class="fas fa-calendar text-xs"></i>
                {{ album.shoot_date|date_format }}
              </span>
              {% endif %}
              
              {% if album.tags|length > 0 %}
              <span class="flex items-center gap-1">
                <i class="fas fa-tag text-xs"></i>
                {% if album.tags|length == 1 %}
                  {{ trans('album.tag_count') }}
                {% else %}
                  {{ trans('album.tags_count', {count: album.tags|length}) }}
                {% endif %}
              </span>
              {% endif %}
            </div>
            
            <div class="flex items-center text-black group-hover:translate-x-1 transition-transform duration-200">
              <span class="text-xs font-medium mr-1">{{ trans('general.view') }}</span>
              <i class="fas fa-arrow-right text-xs"></i>
            </div>
          </div>
        </div>
      </article>
      {% endfor %}
    </div>
    
    <!-- Empty State -->
    {% if albums|length == 0 %}
    <div class="text-center py-24" id="empty-state" data-gsap="empty-state">
      <div class="max-w-md mx-auto">
        <i class="fas fa-search text-6xl text-gray-300 mb-6"></i>
        <h3 class="text-2xl font-semibold text-gray-900 mb-4">{{ trans('filter.no_galleries_title') }}</h3>
        <p class="text-gray-600 mb-8 leading-relaxed">
          {{ trans('filter.no_galleries_text') }}
        </p>
        <button data-action="clear-filters" class="inline-flex items-center gap-2 px-6 py-3 bg-black text-white rounded-xl hover:bg-gray-800 transition-colors duration-200">
          <i class="fas fa-times"></i>
          {{ trans('filter.clear') }}
        </button>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<!-- Select2 for advanced dropdowns -->
<link href="{{ base_path }}/assets/vendor/select2/select2.min.css" rel="stylesheet" />
<script nonce="{{ csp_nonce() }}" src="{{ base_path }}/assets/vendor/jquery/jquery.min.js"></script>
<script nonce="{{ csp_nonce() }}" src="{{ base_path }}/assets/vendor/select2/select2.min.js"></script>

{# CollectionPage JSON-LD for SEO #}
<script type="application/ld+json" nonce="{{ csp_nonce() }}">
{
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": {{ page_texts.title|default(trans('galleries.title'))|json_encode|raw }},
  "url": {{ (canonical_url|default(current_url))|json_encode|raw }},
  "description": {{ meta_description|default('')|json_encode|raw }},
  "numberOfItems": {{ albums|length }},
  "hasPart": [
    {% for album in albums|slice(0, 20) %}
    {
      "@type": "ImageGallery",
      "name": {{ album.title|json_encode|raw }},
      "url": "{{ base_path }}/album/{{ album.slug }}"
      {% if album.images_count %},
      "numberOfItems": {{ album.images_count }}
      {% endif %}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
  ]
}
</script>

<script nonce="{{ csp_nonce() }}">
// Galleries Page JavaScript with GSAP Animations
$(document).ready(function() {
    // Global base path for API calls
    window.basePath = '{{ base_path }}';
    
    // Animation settings from backend
    const animationEnabled = {{ filter_settings.animation_enabled ? 'true' : 'false' }};
    const animationDuration = {{ filter_settings.animation_duration }};
    
    // Page texts from translations
    window.pageTexts = {
        resultsText: '{{ trans('nav.galleries')|e('js') }}',
        clearFiltersText: '{{ trans('filter.clear')|e('js') }}',
        noResultsTitle: '{{ trans('filter.no_galleries_title')|e('js') }}',
        noResultsText: '{{ trans('filter.no_galleries_text')|e('js') }}',
        viewButtonText: '{{ trans('album.view_gallery')|e('js') }}',
        tagCount: '{{ trans('album.tag_count')|e('js') }}',
        tagsCount: '{{ trans('album.tags_count', {count: '{count}'})|e('js') }}',
        moreCount: '{{ trans('general.more_count', {count: '{count}'})|e('js') }}',
        passwordProtected: '{{ trans('album.password_protected')|e('js') }}',
        nsfwWarningShort: '{{ trans('album.nsfw_warning_short')|e('js') }}',
        categoriesLabel: '{{ trans('filter.categories')|e('js') }}'
    };
    window.siteTitle = '{{ site_title|default('Portfolio')|e('js') }}';

    // Date format from settings
    window.dateFormat = '{{ date_format|default("Y-m-d")|e('js') }}';

    // Admin status (skip NSFW restrictions for admins)
    window.isAdmin = {{ is_admin ? 'true' : 'false' }};

    // Ensure UI elements are always visible first
    ensureUIVisibility();
    
    // Initialize page animations
    if (animationEnabled) {
        initPageAnimations();
    }
    
    // Initialize filter functionality
    initFilters();
    
    // Initialize responsive grid
    initResponsiveGrid();
    
    // Safety check every 2 seconds
    setInterval(ensureUIVisibility, 2000);
});

function ensureUIVisibility() {
    const grid = document.getElementById('galleries-grid');
    const isAnimating = document.body.classList.contains('gsap-intro-animating')
        || (grid && grid.classList.contains('gsap-grid-animating'));
    // Ensure critical UI elements are always visible
    const criticalElements = [
        '#toggle-filters',
        '[data-gsap="title"]',
        '[data-gsap="subtitle"]',
        '#galleries-grid .gallery-card'
    ];
    
    criticalElements.forEach(selector => {
        const elements = document.querySelectorAll(selector);
        elements.forEach(el => {
            if (el.style.opacity === '0' && !isAnimating) {
                el.style.opacity = '1';
                el.style.visibility = 'visible';
            }
        });
    });
}

function initPageAnimations() {
    if (document.body.dataset.gsapIntroDone === '1') {
        return;
    }
    // Ensure all elements are visible by default
    gsap.set('[data-gsap="title"], [data-gsap="subtitle"], [data-gsap="filter-toggle"]', { opacity: 1, clearProps: 'transform' });
    
    // Only animate if animation is enabled
    if (!{{ filter_settings.animation_enabled ? 'true' : 'false' }}) {
        return;
    }
    
    // Add animation class temporarily
    document.body.classList.add('gsap-intro-animating');
    document.body.dataset.gsapIntroDone = '1';
    
    // Timeline for page load with safety measures
    const tl = gsap.timeline({
        onComplete: function() {
            // Remove animation class when done
            document.body.classList.remove('gsap-intro-animating');
            // Ensure all elements are visible
            gsap.set('[data-gsap="title"], [data-gsap="subtitle"], [data-gsap="filter-toggle"]', { opacity: 1, clearProps: 'all' });
            gsap.set('#galleries-grid .gallery-card', { opacity: 1, clearProps: 'all' });
        }
    });
    
    // Animate hero section with safer approach
    tl.from('[data-gsap="title"]', {
        y: 30,
        opacity: 0,
        duration: {{ filter_settings.animation_duration }},
        ease: 'power2.out'
    })
    .from('[data-gsap="subtitle"]', {
        y: 20,
        opacity: 0,
        duration: {{ filter_settings.animation_duration }},
        ease: 'power2.out'
    }, '-=0.4');
    
    // Animate gallery cards with safer approach
    if (document.querySelectorAll('#galleries-grid .gallery-card').length > 0) {
        tl.from('#galleries-grid .gallery-card', {
            y: 30,
            opacity: 0,
            duration: {{ filter_settings.animation_duration }},
            stagger: 0.08,
            ease: 'power2.out'
        }, '-=0.2');
    }
    
    // Safety timeout to ensure all elements are visible
    setTimeout(() => {
        document.body.classList.remove('gsap-intro-animating');
        gsap.set('[data-gsap="title"], [data-gsap="subtitle"], [data-gsap="filter-toggle"]', { opacity: 1, clearProps: 'all' });
        gsap.set('#galleries-grid .gallery-card', { opacity: 1, clearProps: 'all' });
    }, 2000);
}

function initFilters() {
    const debouncedApply = debounce(applyFilters, 60);
    window.applyFiltersDebounced = debouncedApply;

    // Initialize Select2 for multi-select filters (if available)
    if ($.fn.select2) {
        $('.filter-select[multiple]').select2({
            theme: 'default',
            placeholder: function() {
                return $(this).data('placeholder');
            },
            allowClear: false,
            width: '100%'
        });
    }
    
    // Filter toggle functionality
    $('#toggle-filters').click(function() {
        const filtersGrid = $('#filters-grid');
        const chevron = $('#filter-chevron');
        const isOpen = filtersGrid.hasClass('filters-open');
        
        if (isOpen) {
            // Close filters
            gsap.to(filtersGrid, {
                opacity: 0,
                maxHeight: 0,
                duration: {{ filter_settings.animation_duration }},
                ease: 'power2.inOut',
                onComplete: function() {
                    filtersGrid.removeClass('filters-open');
                }
            });
            gsap.to(chevron, {
                rotation: 0,
                duration: {{ filter_settings.animation_duration }},
                ease: 'power2.inOut'
            });
        } else {
            // Open filters
            filtersGrid.addClass('filters-open');
            const targetHeight = filtersGrid[0]
                ? (filtersGrid[0].scrollHeight + 16)
                : Math.min(window.innerHeight * 0.6, 800);
            gsap.to(filtersGrid, {
                opacity: 1,
                maxHeight: targetHeight,
                duration: {{ filter_settings.animation_duration }},
                ease: 'power2.inOut'
            });
            gsap.to(chevron, {
                rotation: 180,
                duration: {{ filter_settings.animation_duration }},
                ease: 'power2.inOut'
            });
            
            // Animate filter groups with safety check
            setTimeout(() => {
                const filterGroups = document.querySelectorAll('.filter-group');
                if (filterGroups.length > 0) {
                    gsap.from('.filter-group', {
                        y: 15,
                        opacity: 0,
                        duration: {{ filter_settings.animation_duration }},
                        stagger: 0.05,
                        ease: 'power2.out'
                    });
                }
            }, 100);
        }
    });
    
    // Category chips
    const categoryContainer = document.getElementById('filter-categories');
    if (categoryContainer) {
        categoryContainer.addEventListener('click', function(event) {
            const chip = event.target.closest('.filter-chip');
            if (!chip) return;
            chip.classList.toggle('is-active');
            chip.setAttribute('aria-pressed', chip.classList.contains('is-active') ? 'true' : 'false');
            applyFilters();
        });
    }

    // Category chips search
    const categorySearch = document.getElementById('filter-categories-search');
    if (categorySearch && categoryContainer) {
        categorySearch.addEventListener('input', function() {
            const q = this.value.trim().toLowerCase();
            categoryContainer.querySelectorAll('.filter-chip').forEach((chip) => {
                const name = chip.dataset.categorySearch || '';
                const match = q === '' || name.indexOf(q) !== -1;
                chip.style.display = match ? '' : 'none';
            });
        });
    }
    
    // Filter change handlers
    $('#filter-search').on('input', debouncedApply);
    $('.filter-select, #filter-sort').on('change', applyFilters);
    
    // Clear filters button
    $('#clear-filters').click(clearAllFilters);
}

let activeFilterRequest = null;
let isUpdatingGalleries = false;

function getSelectedCategoryIds() {
    const chips = document.querySelectorAll('#filter-categories .filter-chip.is-active');
    return Array.from(chips).map(chip => chip.dataset.categoryId).filter(Boolean);
}

function getSelectedCategoryNames() {
    const chips = document.querySelectorAll('#filter-categories .filter-chip.is-active');
    return Array.from(chips).map(chip => chip.dataset.categoryName).filter(Boolean);
}

function applyFilters() {
    // Collect filter values
    const filters = {
        category: getSelectedCategoryIds(),
        tags: $('#filter-tags').val() || [],
        cameras: $('#filter-cameras').val() || [],
        lenses: $('#filter-lenses').val() || [],
        films: $('#filter-films').val() || [],
        locations: $('#filter-locations').val() || [],
        year: $('#filter-year').val() || '',
        search: $('#filter-search').val() || '',
        sort: $('#filter-sort').val() || 'published_desc'
    };
    
    // Make AJAX request
    if (activeFilterRequest && activeFilterRequest.readyState !== 4) {
        activeFilterRequest.abort();
    }

    activeFilterRequest = $.ajax({
        url: window.basePath + '/galleries/filter',
        method: 'GET',
        data: filters,
        dataType: 'json',
        cache: false,
        success: function(response) {
            updateGalleries(response.albums, false);
            updateActiveFilters(filters);
            updateResultsCount(response.total);
            hideLoading();
        },
        error: function(xhr, status) {
            hideLoading();
            if (status !== 'abort') {
                console.error('Failed to apply filters', status);
            }
        }
    });
}

window.applyFilters = applyFilters;

function updateGalleries(albums, animate = false) {
    const grid = $('#galleries-grid');
    if (!animate) {
        if (albums.length === 0) {
            grid.html(`
                <div class="col-span-full text-center py-24" id="empty-state">
                    <div class="max-w-md mx-auto">
                        <i class="fas fa-search text-6xl text-gray-300 mb-6"></i>
                        <h3 class="text-2xl font-semibold text-gray-900 mb-4">${window.pageTexts.noResultsTitle}</h3>
                        <p class="text-gray-600 mb-8 leading-relaxed">
                            ${window.pageTexts.noResultsText}
                        </p>
                        <button data-action="clear-filters" class="inline-flex items-center gap-2 px-6 py-3 bg-black text-white rounded-xl hover:bg-gray-800 transition-colors duration-200">
                            <i class="fas fa-times"></i>
                            ${window.pageTexts.clearFiltersText}
                        </button>
                    </div>
                </div>
            `);
        } else {
            let html = '';
            albums.forEach(album => {
                html += generateGalleryCard(album);
            });
            grid.html(html);
        }
        if (grid[0]) {
            grid[0].classList.remove('gsap-grid-animating');
        }
        isUpdatingGalleries = false;
        hideLoading();
        return;
    }
    if (isUpdatingGalleries) {
        gsap.killTweensOf('#galleries-grid .gallery-card');
    }
    isUpdatingGalleries = true;
    
    // Add animation class
    if (grid[0]) {
        grid[0].classList.add('gsap-grid-animating');
    }
    
    // Animate out current galleries with specific selector
    gsap.to('#galleries-grid .gallery-card', {
        y: -20,
        opacity: 0,
        duration: {{ filter_settings.animation_duration }},
        stagger: 0.05,
        ease: 'power3.in',
        onComplete: function() {
            // Update grid content
            if (albums.length === 0) {
                grid.html(`
                    <div class="col-span-full text-center py-24" id="empty-state">
                        <div class="max-w-md mx-auto">
                            <i class="fas fa-search text-6xl text-gray-300 mb-6"></i>
                            <h3 class="text-2xl font-semibold text-gray-900 mb-4">${window.pageTexts.noResultsTitle}</h3>
                            <p class="text-gray-600 mb-8 leading-relaxed">
                                ${window.pageTexts.noResultsText}
                            </p>
                            <button data-action="clear-filters" class="inline-flex items-center gap-2 px-6 py-3 bg-black text-white rounded-xl hover:bg-gray-800 transition-colors duration-200">
                                <i class="fas fa-times"></i>
                                ${window.pageTexts.clearFiltersText}
                            </button>
                        </div>
                    </div>
                `);
                if (grid[0]) {
                    grid[0].classList.remove('gsap-grid-animating');
                }
                isUpdatingGalleries = false;
            } else {
                // Generate new gallery cards HTML
                let html = '';
                albums.forEach(album => {
                    html += generateGalleryCard(album);
                });
                grid.html(html);
                
                // Animate in new galleries with specific selector
                gsap.from('#galleries-grid .gallery-card', {
                    y: 40,
                    opacity: 0,
                    duration: {{ filter_settings.animation_duration }},
                    stagger: 0.1,
                    ease: 'power3.out',
                    onComplete: function() {
                        if (grid[0]) {
                            grid[0].classList.remove('gsap-grid-animating');
                        }
                        gsap.set('#galleries-grid .gallery-card', { clearProps: 'all' });
                        isUpdatingGalleries = false;
                    }
                });
            }
        }
    });
}

// Date formatting helper based on settings
function formatDateByPattern(dateStr) {
    if (!dateStr) return '';
    // Parse date string directly to avoid timezone issues
    // Expected format: YYYY-MM-DD or YYYY-MM-DDTHH:MM:SS
    const match = String(dateStr).match(/^(\d{4})-(\d{2})-(\d{2})/);
    if (!match) return dateStr;

    const year = match[1];
    const month = match[2];
    const day = match[3];

    // Support multiple date formats based on window.dateFormat setting
    switch (window.dateFormat) {
        case 'd-m-Y':  // European: 15-01-2025
            return `${day}-${month}-${year}`;
        case 'd/m/Y':  // European with slashes: 15/01/2025
            return `${day}/${month}/${year}`;
        case 'm/d/Y':  // US: 01/15/2025
            return `${month}/${day}/${year}`;
        case 'Y-m-d':  // ISO: 2025-01-15
        default:
            return `${year}-${month}-${day}`;
    }
}

function generateGalleryCard(album) {
    const esc = (s)=> String(s==null?'':s)
        .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
        .replace(/\"/g,'&quot;').replace(/'/g,'&#039;');
    const coverImage = album.cover_image || {};
    const tags = Array.isArray(album.tags) ? album.tags : [];
    const imgPath = (coverImage.preview_path || coverImage.original_path || '');
    const blurPath = coverImage.blur_path || '';
    const safeSrc = imgPath.startsWith('/') && window.basePath ? (window.basePath + imgPath) : imgPath;
    const safeBlurSrc = blurPath.startsWith('/') && window.basePath ? (window.basePath + blurPath) : blurPath;
    const title = esc(album.title);
    const excerpt = esc(album.excerpt || '');
    const category = esc(album.category_name || '');
    const alt = esc(coverImage.alt_text || album.title || '');
    const slug = encodeURIComponent(album.slug || '');
    // Skip NSFW restrictions for admins
    const isNsfw = (album.is_nsfw && !window.isAdmin) ? true : false;
    const canShowNsfw = !isNsfw || hasConfirmedNsfw();
    const albumUrl = window.basePath + '/album/' + slug;
    const seoTitle = [window.siteTitle || '', album.title || ''].filter(Boolean).join(' â€” ');

    const wrapper = document.createElement('article');
    wrapper.className = 'gallery-card group flex flex-col h-full cursor-pointer overflow-hidden rounded-2xl bg-white shadow-md hover:shadow-lg transition-shadow duration-300 ease-out';
    wrapper.setAttribute('data-album-id', String(album.id||''));
    wrapper.setAttribute('data-nsfw', isNsfw ? '1' : '0');
    wrapper.setAttribute('data-password-protected', album.is_password_protected ? '1' : '0');
    wrapper.setAttribute('data-album-url', albumUrl);
    wrapper.setAttribute('data-action', 'open-album');
    if (seoTitle) {
        wrapper.setAttribute('aria-label', seoTitle);
    }

    const rel = document.createElement('div');
    rel.className = 'relative aspect-[4/3] overflow-hidden bg-gray-100';
    if (isNsfw && !canShowNsfw) {
        if (safeBlurSrc) {
            const img = document.createElement('img');
            img.src = safeBlurSrc;
            img.alt = alt;
            if (seoTitle) img.title = seoTitle;
            img.className = 'nsfw-blur w-full h-full object-cover transition-transform duration-300 ease-out group-hover:scale-[1.03]';
            img.loading = 'lazy';
            rel.appendChild(img);
        } else {
            const ph = document.createElement('div');
            ph.className = 'w-full h-full bg-gradient-to-br from-gray-300 to-gray-400 flex items-center justify-center';
            ph.innerHTML = '<i class="fas fa-eye-slash text-4xl text-gray-500"></i>';
            rel.appendChild(ph);
        }
    } else if (safeSrc) {
        const img = document.createElement('img');
        img.src = safeSrc;
        img.alt = alt;
        if (seoTitle) img.title = seoTitle;
        img.className = 'w-full h-full object-cover transition-transform duration-300 ease-out group-hover:scale-[1.03]';
        img.loading = 'lazy';
        rel.appendChild(img);
    } else {
        const ph = document.createElement('div');
        ph.className = 'w-full h-full flex items-center justify-center text-gray-400';
        ph.innerHTML = '<i class="fas fa-images text-4xl"></i>';
        rel.appendChild(ph);
    }
    // NSFW Overlay
    if (isNsfw && !canShowNsfw) {
        const nsfwOverlay = document.createElement('div');
        nsfwOverlay.className = 'nsfw-overlay absolute inset-0 bg-black/60 flex flex-col items-center justify-center text-white backdrop-blur-sm';
        nsfwOverlay.innerHTML = '<i class="fas fa-eye-slash text-3xl mb-2"></i><span class="text-sm font-medium">' + esc(window.pageTexts.nsfwWarningShort || '18+') + '</span>';
        rel.appendChild(nsfwOverlay);
    }
    // Top right badges container (lock + count)
    const badgesContainer = document.createElement('div');
    badgesContainer.className = 'absolute top-4 right-4 flex items-center gap-2 z-20';

    if (album.is_password_protected){
        const lock = document.createElement('div');
        lock.className = 'text-white drop-shadow-[0_2px_4px_rgba(0,0,0,0.5)]';
        lock.title = window.pageTexts.passwordProtected || 'Password Protected';
        lock.innerHTML = '<i class="fas fa-lock text-lg"></i>';
        badgesContainer.appendChild(lock);
    }
    if ((album.images_count||0) > 0){
        const badge = document.createElement('div');
        badge.className = 'bg-black/70 text-white px-3 py-1.5 rounded-full text-sm font-medium backdrop-blur-sm';
        badge.innerHTML = '<i class="fas fa-images mr-1"></i>' + esc(album.images_count);
        badgesContainer.appendChild(badge);
    }
    if (album.is_password_protected || (album.images_count||0) > 0) {
        rel.appendChild(badgesContainer);
    }
    if (category){
        const cat = document.createElement('div');
        cat.className = 'absolute top-4 left-4 bg-white/90 text-black px-3 py-1.5 rounded-full text-xs font-semibold backdrop-blur-sm';
        cat.textContent = category;
        rel.appendChild(cat);
    }

    const content = document.createElement('div');
    content.className = 'p-6 flex flex-col flex-1';
    const h3 = document.createElement('h3');
    h3.className = 'text-xl font-semibold text-black mb-3 group-hover:text-gray-700 transition-colors duration-200 line-clamp-2';
    h3.textContent = title; content.appendChild(h3);
    if (excerpt){
        const p = document.createElement('p');
        p.className = 'text-gray-600 mb-4 line-clamp-3 leading-relaxed';
        p.textContent = excerpt; content.appendChild(p);
    }

    if (tags.length){
        const wrap = document.createElement('div'); wrap.className='flex flex-wrap gap-2 mt-4 mb-4 pt-4 border-t border-gray-100';
        tags.slice(0,3).forEach(t=>{ const a=document.createElement('a'); a.href=window.basePath+'/tag/'+(t && t.slug ? t.slug : ''); a.className='inline-block bg-gray-100 text-gray-700 text-xs px-2 py-1 rounded-full hover:bg-gray-200 transition-colors'; a.dataset.action='tag-link'; a.textContent = '#' + (t && t.name ? t.name : ''); wrap.appendChild(a); });
        if (tags.length>3){ const more=document.createElement('span'); more.className='inline-block text-gray-400 text-xs px-2 py-1'; more.textContent = window.pageTexts.moreCount.replace('{count}', tags.length-3); wrap.appendChild(more); }
        content.appendChild(wrap);
    }

    const meta = document.createElement('div');
    meta.className = 'mt-auto flex items-center justify-between text-sm text-gray-500';
    const left = document.createElement('div'); left.className = 'flex items-center gap-4';
    if (album.shoot_date){
        const span = document.createElement('span'); span.className='flex items-center gap-1';
        span.innerHTML = '<i class="fas fa-calendar text-xs"></i>' + formatDateByPattern(album.shoot_date);
        left.appendChild(span);
    }
    if (tags.length){
        const span = document.createElement('span'); span.className='flex items-center gap-1';
        const tagText = tags.length === 1 ? window.pageTexts.tagCount : window.pageTexts.tagsCount.replace('{count}', tags.length);
        span.innerHTML = '<i class="fas fa-tag text-xs"></i>' + esc(tagText);
        left.appendChild(span);
    }
    meta.appendChild(left);
    const right = document.createElement('div'); right.className = 'flex items-center text-black group-hover:translate-x-1 transition-transform duration-200';
    const viewTxt = document.createElement('span'); viewTxt.className='text-xs font-medium mr-1'; viewTxt.textContent = window.pageTexts.viewButtonText; right.appendChild(viewTxt);
    const arrow = document.createElement('i'); arrow.className='fas fa-arrow-right text-xs'; right.appendChild(arrow);
    meta.appendChild(right);
    content.appendChild(meta);

    wrapper.appendChild(rel); wrapper.appendChild(content);
    const div = document.createElement('div');
    div.appendChild(wrapper);
    return div.innerHTML;
}

function updateActiveFilters(filters) {
    const activeFiltersContainer = $('#active-filters');
    const clearButton = $('#clear-filters');
    let activeFiltersHtml = '';
    let hasActiveFilters = false;
    const escapeHtml = (s)=> String(s==null?'':s)
        .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
        .replace(/\"/g,'&quot;').replace(/'/g,'&#039;');

    const categoryNames = getSelectedCategoryNames();
    if (categoryNames.length > 0) {
        hasActiveFilters = true;
        const label = window.pageTexts.categoriesLabel || 'Categories';
        activeFiltersHtml += `<span class="active-filter-badge">${escapeHtml(label)}: ${categoryNames.map(escapeHtml).join(', ')}</span>`;
    }
    
    // Check each filter type
    Object.keys(filters).forEach(key => {
        if (key === 'category') {
            return;
        }
        if (filters[key] && filters[key].length > 0 && key !== 'sort') {
            hasActiveFilters = true;
            if (Array.isArray(filters[key])) {
                activeFiltersHtml += `<span class="active-filter-badge">${key}: ${filters[key].length}</span>`;
            } else {
                activeFiltersHtml += `<span class="active-filter-badge">${key}: ${filters[key]}</span>`;
            }
        }
    });
    
    if (hasActiveFilters) {
        activeFiltersContainer.html(activeFiltersHtml);
        gsap.to(activeFiltersContainer, { opacity: 1, duration: 0.3 });
        gsap.to(clearButton, { opacity: 1, duration: 0.3 });
    } else {
        gsap.to([activeFiltersContainer, clearButton], { opacity: 0, duration: 0.3 });
    }
}

function updateResultsCount(count) {
    $('#results-count').text(`${count} ${window.pageTexts.resultsText}`);
}

function clearAllFilters() {
    // Reset all filter inputs
    document.querySelectorAll('#filter-categories .filter-chip.is-active').forEach(chip => {
        chip.classList.remove('is-active');
        chip.setAttribute('aria-pressed', 'false');
    });

    // Reset category search input and show all chips
    const categorySearch = document.getElementById('filter-categories-search');
    if (categorySearch) {
        categorySearch.value = '';
        document.querySelectorAll('#filter-categories .filter-chip').forEach(chip => {
            chip.style.display = '';
        });
    }

    $('.filter-select').val(null).trigger('change');
    $('#filter-search').val('');
    $('#filter-sort').val('published_desc');

    // Apply filters (which will be empty now)
    applyFilters();
}

function showLoading() {
    gsap.to('#loading-overlay', {
        opacity: 1,
        pointerEvents: 'auto',
        duration: 0.3
    });
}

function hideLoading() {
    gsap.to('#loading-overlay', {
        opacity: 0,
        pointerEvents: 'none',
        duration: 0.3
    });
}

function initResponsiveGrid() {
    const grid = $('#galleries-grid');
    const desktopCols = grid.data('desktop-cols');
    const tabletCols = grid.data('tablet-cols');
    const mobileCols = grid.data('mobile-cols');
    const gap = grid.data('gap');
    
    function updateGridColumns() {
        const width = $(window).width();
        let cols;
        
        if (width >= 1024) {
            cols = desktopCols;
        } else if (width >= 768) {
            cols = tabletCols;
        } else {
            cols = mobileCols;
        }
        
        const gapSize = gap === 'small' ? '1rem' : (gap === 'large' ? '2rem' : '1.5rem');
        
        grid.css({
            'grid-template-columns': `repeat(${cols}, 1fr)`,
            'gap': gapSize
        });
    }
    
    // Update on resize
    $(window).resize(debounce(updateGridColumns, 250));
    updateGridColumns();
}

// Utility function for debouncing
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}
</script>

<style nonce="{{ csp_nonce() }}">
/* Custom Select2 styling */
.select2-container--default .select2-selection--multiple {
    border: 1px solid #d1d5db;
    border-radius: 0.5rem;
    padding: 0.25rem;
    min-height: 2.5rem;
    font-size: 0.875rem;
}

.select2-container--default .select2-selection--single {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border: 1px solid #d1d5db;
    border-radius: 0.5rem;
    height: 2.5rem;
    line-height: 1.25rem;
    font-size: 0.875rem;
}

.select2-container--default .select2-selection--single .select2-selection__rendered {
    flex: 1;
    padding-left: 0.75rem;
    padding-right: 2rem;
    line-height: 1.25rem;
}

.select2-container--default .select2-selection--single .select2-selection__clear {
    align-self: center;
    margin-right: 0.25rem;
}

.select2-container--default .select2-selection--single .select2-selection__arrow {
    position: absolute;
    right: 0.5rem;
    top: 0;
    height: 100%;
    display: flex;
    align-items: center;
}

.select2-container--default.select2-container--focus .select2-selection--multiple,
.select2-container--default.select2-container--focus .select2-selection--single {
    border-color: #000;
    box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
}

.select2-container--default .select2-selection--multiple .select2-selection__choice {
    background-color: #f3f4f6;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    padding: 0.125rem 1.375rem;
    margin: 0.125rem;
    font-size: 0.75rem;
}

.select2-dropdown {
    border: 1px solid #d1d5db;
    border-radius: 0.5rem;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    font-size: 0.875rem;
}

/* Category filter chips */
.filter-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.35rem 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 9999px;
    background-color: #fff;
    color: #111827;
    font-size: 0.75rem;
    font-weight: 600;
    transition: background-color 0.15s ease, color 0.15s ease, border-color 0.15s ease;
}

.filter-chip.is-active {
    background-color: #111827;
    color: #fff;
    border-color: #111827;
}

.filter-chip:focus-visible {
    outline: 2px solid #111827;
    outline-offset: 2px;
}

.filter-chip-count {
    color: #6b7280;
    font-weight: 500;
}

.filter-chip.is-active .filter-chip-count {
    color: rgba(255, 255, 255, 0.85);
}

#filter-categories-search::-webkit-search-cancel-button {
    -webkit-appearance: none;
    appearance: none;
}

/* Active filter badges */
.active-filter-badge {
    display: inline-block;
    background-color: #000;
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
}

/* Grid responsive classes */
@media (min-width: 768px) {
    #galleries-grid[data-tablet-cols="2"] {
        grid-template-columns: repeat(2, 1fr);
    }
    #galleries-grid[data-tablet-cols="3"] {
        grid-template-columns: repeat(3, 1fr);
    }
}

@media (min-width: 1024px) {
    #galleries-grid[data-desktop-cols="2"] {
        grid-template-columns: repeat(2, 1fr);
    }
    #galleries-grid[data-desktop-cols="3"] {
        grid-template-columns: repeat(3, 1fr);
    }
    #galleries-grid[data-desktop-cols="4"] {
        grid-template-columns: repeat(4, 1fr);
    }
    #galleries-grid[data-desktop-cols="5"] {
        grid-template-columns: repeat(5, 1fr);
    }
}

/* CSS Protection for Gallery Cards and UI elements */
#galleries-grid .gallery-card {
    opacity: 1 !important;
}
[data-gsap="filter-toggle"],
[data-gsap="title"],
[data-gsap="subtitle"] {
    opacity: 1;
}

/* Only allow GSAP to control opacity during specific animations */
#galleries-grid.gsap-grid-animating .gallery-card {
    opacity: 0;
}
.gsap-intro-animating [data-gsap="filter-toggle"],
.gsap-intro-animating [data-gsap="title"],
.gsap-intro-animating [data-gsap="subtitle"] {
    opacity: 0;
}

/* Ensure images in gallery cards are always visible */
#galleries-grid .gallery-card img {
    opacity: 1 !important;
}

/* Filter toggle button protection */
#toggle-filters {
    opacity: 1 !important;
    visibility: visible !important;
}

/* Better filter grid spacing - no padding when collapsed */
#filters-grid {
    padding: 0;
    margin: 0;
}

#filters-grid.filters-open {
    margin-top: 1rem;
    padding-bottom: 0.5rem;
}

/* Improved filter bar styling */
#filters-section {
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}

.active-filter-badge {
    animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* NSFW Content Styles */
.nsfw-blur {
    filter: blur(20px);
    transition: filter 0.3s ease;
}

.nsfw-confirmed .nsfw-blur {
    filter: none;
}

.nsfw-confirmed .nsfw-overlay {
    display: none;
}

.nsfw-overlay {
    transition: opacity 0.3s ease;
}

/* NSFW Modal Styles */
#nsfw-modal {
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
}

#nsfw-modal .modal-content {
    animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
    from { opacity: 0; transform: scale(0.95) translateY(-20px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
}
</style>

<!-- NSFW Age Confirmation Modal -->
<div id="nsfw-modal" class="fixed inset-0 bg-black/70 z-50 hidden items-center justify-center p-4">
  <div class="modal-content bg-white rounded-2xl max-w-md w-full p-8 text-center shadow-2xl">
    <div class="w-16 h-16 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-6">
      <i class="fas fa-exclamation-triangle text-amber-600 text-3xl"></i>
    </div>
    <h3 class="text-2xl font-semibold text-gray-900 mb-4">{{ trans('album.nsfw_title') }}</h3>
    <p class="text-gray-600 mb-6 leading-relaxed">
      {{ trans('album.nsfw_message') }}
    </p>
    <div class="flex flex-col sm:flex-row gap-3 justify-center">
      <button data-action="confirm-nsfw" class="px-6 py-3 bg-black text-white rounded-xl hover:bg-gray-800 transition-colors font-medium">
        {{ trans('album.nsfw_confirm') }}
      </button>
      <button data-action="cancel-nsfw" class="px-6 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-colors font-medium">
        {{ trans('album.nsfw_cancel') }}
      </button>
    </div>
    <p id="nsfw-error" class="text-sm text-red-600 mt-4 hidden">
      {{ trans('album.nsfw_error')|default('Verification failed. Please try again.') }}
    </p>
    <p class="text-xs text-gray-400 mt-6">
      {{ trans('album.nsfw_remember') }}
    </p>
  </div>
</div>

<script nonce="{{ csp_nonce() }}">
// NSFW Content Handling
let pendingNsfwUrl = null;
const basePath = window.basePath || '{{ base_path|e('js') }}';
const csrfToken = '{{ csrf|e('js') }}';

function safeLocalStorageGet(key) {
    try {
        return window.localStorage ? window.localStorage.getItem(key) : null;
    } catch (e) {
        return null;
    }
}

function safeLocalStorageSet(key, value) {
    try {
        if (window.localStorage) {
            window.localStorage.setItem(key, value);
        }
    } catch (e) {}
}

function hasConfirmedNsfw() {
    if (window.nsfwConsent === true) return true;
    if (safeLocalStorageGet('nsfw_confirmed') === 'true') return true;
    return false;
}

function handleGalleryCardClick(event, card) {
    event.preventDefault();
    event.stopPropagation();

    const isNsfw = card.dataset.nsfw === '1';
    const isPasswordProtected = card.dataset.passwordProtected === '1';
    const albumUrl = card.dataset.albumUrl;

    // If album has password protection, skip NSFW modal here
    // (NSFW confirmation will be handled in the password page)
    if (isNsfw && !isPasswordProtected && !hasConfirmedNsfw()) {
        pendingNsfwUrl = albumUrl;
        showNsfwModal();
    } else {
        window.location.href = albumUrl;
    }
}

function showNsfwModal() {
    const modal = document.getElementById('nsfw-modal');
    const error = document.getElementById('nsfw-error');
    if (error) {
        error.classList.add('hidden');
    }
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    document.body.style.overflow = 'hidden';
}

function hideNsfwModal() {
    const modal = document.getElementById('nsfw-modal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    document.body.style.overflow = '';
}

function confirmNsfwAge() {
    if (!csrfToken) {
        const error = document.getElementById('nsfw-error');
        if (error) {
            error.classList.remove('hidden');
        }
        return;
    }
    fetch(`${basePath}/nsfw/confirm`, {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `csrf=${encodeURIComponent(csrfToken)}&nsfw_confirmed=1`
    }).then((resp) => {
        if (!resp.ok) {
            throw new Error('NSFW confirm failed');
        }
        safeLocalStorageSet('nsfw_confirmed', 'true');
        window.nsfwConsent = true;
        hideNsfwModal();

        // Navigate to the pending URL if any
        if (pendingNsfwUrl) {
            window.location.href = pendingNsfwUrl;
            pendingNsfwUrl = null;
        } else {
            applyFilters();
        }
    }).catch((err) => {
        console.warn('NSFW confirmation failed:', err);
        const error = document.getElementById('nsfw-error');
        if (error) {
            error.classList.remove('hidden');
        }
    });
}

function cancelNsfw() {
    hideNsfwModal();
    pendingNsfwUrl = null;
}

// Delegated actions for CSP-safe event handling
document.addEventListener('click', function(event) {
    const target = event.target.closest('[data-action]');
    if (!target) return;

    const action = target.dataset.action;
    if (action === 'open-album') {
        handleGalleryCardClick(event, target);
    } else if (action === 'clear-filters') {
        event.preventDefault();
        clearAllFilters();
    } else if (action === 'confirm-nsfw') {
        event.preventDefault();
        confirmNsfwAge();
    } else if (action === 'cancel-nsfw') {
        event.preventDefault();
        cancelNsfw();
    } else if (action === 'download-image') {
        event.preventDefault();
        event.stopPropagation();
        const url = target.dataset.downloadUrl;
        if (url) {
            window.location.href = url;
        }
    }
});

// Close modal on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        hideNsfwModal();
    }
});

// Close modal on backdrop click
document.getElementById('nsfw-modal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        hideNsfwModal();
    }
});

// On page load, if user has confirmed, swap blurred images with real ones
document.addEventListener('DOMContentLoaded', function() {
    if (hasConfirmedNsfw()) {
        safeLocalStorageSet('nsfw_confirmed', 'true');
    }
});
</script>
{% endblock %}
