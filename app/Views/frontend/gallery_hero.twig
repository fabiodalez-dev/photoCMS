{% extends "frontend/_layout.twig" %}

{% block content %}
{# Hero cover with overlay, title, meta and body; gallery below #}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
  {% include 'frontend/_breadcrumbs.twig' %}
</div>
<section class="relative" style="min-height:50vh">
  {# --- Robust hero image selection (cover_image -> cover.variants -> cover.path/url -> first album image) --- #}
  {% set hero_url = '' %}

  {# 1) cover_image (admin uses img.preview_path in the grid) #}
  {% if album.cover_image is defined and album.cover_image %}
    {% set candidate = album.cover_image.preview_path ?? album.cover_image.original_path ?? album.cover_image.path ?? null %}
    {% if candidate %}
      {% if candidate starts with '/' %}
        {% set hero_url = base_path ~ candidate %}
      {% else %}
        {% set hero_url = candidate %}
      {% endif %}
    {% endif %}
  {% endif %}

  {# 2) album.cover.variants (original template style) #}
  {% if not hero_url and album.cover is defined and album.cover %}
    {% if album.cover.variants is defined and album.cover.variants|length %}
      {% set max_w = 0 %}
      {% for v in album.cover.variants %}
        {% if v.path is defined and v.path and v.width is defined and v.width > max_w and not (v.path starts with '/storage/') %}
          {% set cand = v.path %}
          {% if cand starts with '/' %}
            {% set hero_url = base_path ~ cand %}
          {% else %}
            {% set hero_url = cand %}
          {% endif %}
          {% set max_w = v.width %}
        {% endif %}
      {% endfor %}
    {% endif %}
    {# fallback to cover.path or cover.url #}
    {% if not hero_url %}
      {% set cand2 = album.cover.path ?? album.cover.url ?? null %}
      {% if cand2 %}
        {% if cand2 starts with '/' %}
          {% set hero_url = base_path ~ cand2 %}
        {% else %}
          {% set hero_url = cand2 %}
        {% endif %}
      {% endif %}
    {% endif %}
  {% endif %}

  {# 3) last resort: first image in album.images (if injected) or from images collection #}
  {% if not hero_url and album.images is defined and album.images|length %}
    {% set firstImg = album.images[0] %}
    {% set cand3 = firstImg.preview_path ?? firstImg.original_path ?? firstImg.path ?? null %}
    {% if cand3 %}
      {% set hero_url = cand3 starts with '/' ? (base_path ~ cand3) : cand3 %}
    {% endif %}
  {% endif %}
  {% if not hero_url and images is defined and images|length %}
    {% set firstImg = images[0] %}
    {% set cand4 = firstImg.fallback_src ?? firstImg.url ?? null %}
    {% if cand4 %}
      {% set hero_url = cand4 starts with '/' ? (base_path ~ cand4) : cand4 %}
    {% endif %}
  {% endif %}

  {% set hero_has_image = hero_url is not empty %}

  {# --- HERO WRAPPER: much taller, content centered, padding added --- #}
  <div class="relative overflow-hidden bg-neutral-900" style="min-height:50vh">
    {% if hero_has_image %}
      <img src="{{ hero_url }}" alt="{{ album.title|e }}" class="js-hero-parallax absolute inset-0 w-full h-full object-cover object-center select-none blur-sm md:blur md:scale-105" loading="eager" fetchpriority="high" decoding="async">
    {% else %}
      <div class="absolute inset-0 w-full h-full bg-gradient-to-br from-neutral-800 to-neutral-900"></div>
    {% endif %}

    {# Subtle light overlay for readability on top of blurred image #}
    <div class="absolute inset-0 z-10 pointer-events-none backdrop-blur-[1px]" style="background: linear-gradient(180deg, rgba(255,255,255,0.86) 0%, rgba(255,255,255,0.90) 83%, rgba(255,255,255,0.95) 100%);"></div>

    <div class="relative z-20 flex flex-col items-center max-w-5xl w-full mx-auto px-4 sm:px-6 lg:px-8 text-center text-black preserve-light-text" style="min-height:50vh; padding-top:3rem; padding-bottom:3rem">
      <div class="flex-grow flex flex-col items-center justify-center">
        <div class="mb-3 flex flex-wrap justify-center gap-2">
          {% if album.categories is defined and album.categories|length > 0 %}
            {% for cat in album.categories %}
              <a href="{{ base_path }}/category/{{ cat.slug }}" class="inline-flex items-center gap-2 text-[11px] font-medium px-2.5 py-1 rounded-full border border-neutral-300 bg-white/80 text-neutral-800 hover:bg-white dark:border-neutral-600 dark:bg-neutral-800/80 dark:text-neutral-200 dark:hover:bg-neutral-700 transition-colors" title="{{ cat.name|e }}">
                <span class="inline-block w-1.5 h-1.5 rounded-full bg-neutral-800 dark:bg-neutral-300"></span>{{ cat.name|e }}
              </a>
            {% endfor %}
          {% endif %}
          {% if album.tags is defined and album.tags|length > 0 %}
            {% for tag in album.tags %}
            <a href="{{ base_path }}/tag/{{ tag.slug }}" class="inline-flex items-center gap-2 text-[11px] font-medium px-2.5 py-1 rounded-full border border-blue-300 bg-blue-50 text-blue-700 hover:bg-blue-100 hover:text-blue-800 dark:border-blue-600 dark:bg-blue-900/50 dark:text-blue-200 dark:hover:bg-blue-800/50 transition-colors" title="{{ tag.name|e }}">
              <span class="inline-block w-1.5 h-1.5 rounded-full bg-blue-600 dark:bg-blue-400"></span>{{ tag.name|e }}
            </a>
            {% endfor %}
          {% endif %}
        </div>
        <h1 class="text-3xl md:text-5xl font-light tracking-tight leading-tight">{{ album.title|e }}</h1>
        <div class="mt-3 text-sm md:text-base text-neutral-700 flex flex-col sm:flex-row items-center justify-center gap-3">
          {% if album.shoot_date and album.show_date == 1 %}
            <span class="inline-flex items-center gap-2 px-2.5 py-1.5 rounded-full bg-white/80 text-black text-xs md:text-sm">
              <i class="fas fa-calendar-alt text-xs text-neutral-700"></i>
              <time datetime="{{ album.shoot_date }}">{{ album.shoot_date|date_format }}</time>
            </span>
          {% endif %}
          {% if album.equipment.locations is defined and album.equipment.locations|length > 0 %}
            <span class="inline-flex items-center gap-2 px-2.5 py-1.5 rounded-full bg-white/80 text-black text-xs md:text-sm">
              <i class="fas fa-map-marker-alt text-xs text-neutral-700"></i>
              {{ album.equipment.locations|join(', ') }}
            </span>
          {% endif %}
        </div>

        {% if album.excerpt %}
          <p class="mt-3 text-neutral-700 leading-relaxed text-base md:text-lg max-w-3xl mx-auto">{{ album.excerpt|e }}</p>
        {% endif %}
        
        {% if album.body %}
          <div class="max-w-3xl mx-auto prose prose-neutral mt-6">{{ album.body|safe_html }}</div>
        {% endif %}
      </div>
      
      {# Equipment pinned to bottom of hero content #}
      {# Count custom fields that should show in gallery #}
      {% set custom_fields_for_gallery = [] %}
      {% if album_custom_fields is defined %}
        {% for typeId, field in album_custom_fields %}
          {% if field.show_in_gallery and field.values|length > 0 %}
            {% set custom_fields_for_gallery = custom_fields_for_gallery|merge([field]) %}
          {% endif %}
        {% endfor %}
      {% endif %}

      {% if album.equipment.cameras|length > 0 or album.equipment.lenses|length > 0 or album.equipment.film|length > 0 or album.equipment.developers|length > 0 or album.equipment.labs|length > 0 or custom_fields_for_gallery|length > 0 %}
      {% set equipment_items = [] %}
      {% if album.equipment.cameras is defined and album.equipment.cameras|length > 0 %}
        {% set equipment_items = equipment_items|merge([1]) %}
      {% endif %}
      {% if album.equipment.lenses is defined and album.equipment.lenses|length > 0 %}
        {% set equipment_items = equipment_items|merge([1]) %}
      {% endif %}
      {% if album.equipment.film is defined and album.equipment.film|length > 0 %}
        {% set equipment_items = equipment_items|merge([1]) %}
      {% endif %}
      {% if album.equipment.developers is defined and album.equipment.developers|length > 0 %}
        {% set equipment_items = equipment_items|merge([1]) %}
      {% endif %}
      {% if album.equipment.labs is defined and album.equipment.labs|length > 0 %}
        {% set equipment_items = equipment_items|merge([1]) %}
      {% endif %}
      {% for cf in custom_fields_for_gallery %}
        {% set equipment_items = equipment_items|merge([1]) %}
      {% endfor %}
      
      {% set equipment_count = equipment_items|length %}
      
      <div class="mt-auto pt-3 pb-2 flex flex-wrap justify-center gap-3 md:gap-x-8 md:gap-y-2 text-[11px] md:text-xs text-neutral-800">
        {% if album.equipment.cameras|length > 0 %}
        <div class="flex items-center gap-2 min-w-[80px]">
          <i class="fas fa-camera fa-xs text-neutral-700"></i>
          <span>{% for camera in album.equipment.cameras %}{{ camera }}{% if not loop.last %} • {% endif %}{% endfor %}</span>
        </div>
        {% endif %}
        {% if album.equipment.lenses|length > 0 %}
        <div class="flex items-center gap-2 min-w-[80px]">
          <i class="fas fa-dot-circle fa-xs text-neutral-700"></i>
          <span>{% for lens in album.equipment.lenses %}{{ lens }}{% if not loop.last %} • {% endif %}{% endfor %}</span>
        </div>
        {% endif %}
        {% if album.equipment.film|length > 0 %}
        <div class="flex items-center gap-2 min-w-[80px]">
          <i class="fas fa-film fa-xs text-neutral-700"></i>
          <span>{% for film in album.equipment.film %}{% if film.name is defined %}{{ film.name }}{% if film.iso or film.format %} ({% if film.iso %}ISO {{ film.iso }}{% endif %}{% if film.iso and film.format %} - {% endif %}{% if film.format %}{{ film.format }}{% endif %}){% endif %}{% else %}{{ film }}{% endif %}{% if not loop.last %} • {% endif %}{% endfor %}</span>
        </div>
        {% endif %}
        {% if album.equipment.developers|length > 0 %}
        <div class="flex items-center gap-2 min-w-[80px]">
          <i class="fas fa-flask fa-xs text-neutral-700"></i>
          <span>{% for dev in album.equipment.developers %}{{ dev }}{% if not loop.last %} • {% endif %}{% endfor %}</span>
        </div>
        {% endif %}
        {% if album.equipment.labs|length > 0 %}
        <div class="flex items-center gap-2 min-w-[80px]">
          <i class="fas fa-industry fa-xs text-neutral-700"></i>
          <span>{% for lab in album.equipment.labs %}{{ lab }}{% if not loop.last %} • {% endif %}{% endfor %}</span>
        </div>
        {% endif %}
        {# Custom fields #}
        {% for field in custom_fields_for_gallery %}
        <div class="flex items-center gap-2 min-w-[80px]">
          <i class="fas {{ field.icon|default('fa-tag')|e('html_attr') }} fa-xs text-neutral-700"></i>
          <span>{% for valueData in field.values %}{{ valueData.value|e }}{% if not loop.last %} • {% endif %}{% endfor %}</span>
        </div>
        {% endfor %}
      </div>
      {% endif %}
    </div>
  </div>
</section>

<section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-28 lg:pt-48 pb-24 md:pb-32 lg:pb-40">
  {% if album.body %}
    <div class="max-w-3xl mx-auto prose prose-neutral py-12 md:py-16 lg:py-20">
      {{ album.body|safe_html }}
    </div>
  {% endif %}

  {# Social Sharing #}
  {% include 'frontend/_social_sharing.twig' %}

  {# Template switcher (same behavior as gallery.twig) #}
  {% if available_templates|length > 0 %}
  <div class="mt-8 mb-4 flex justify-end">
    <div id="template-switcher" class="hidden md:inline-flex items-center gap-1 bg-white/90 backdrop-blur-sm border border-neutral-200 rounded-md p-1 shadow-sm" style="opacity: 0; transform: translateX(20px);">
      {% for template in available_templates %}
        <button type="button" class="tpl-switch px-2 py-1 rounded {{ template.id == current_template_id ? 'bg-black text-white' : 'text-neutral-700 hover:bg-neutral-100' }}" data-template-id="{{ template.id }}" data-album-ref="{{ album_ref }}" title="{{ template.name }}" aria-label="{{ template.name }}">
          {% if template.slug == 'gallery-wall-scroll' %}
            <i class="fas fa-arrows-left-right"></i>
          {% elseif template.settings.layout == 'masonry_fit' %}
            <i class="fas fa-expand-arrows-alt"></i>
          {% elseif template.settings.layout == 'slideshow' and 'swiper' in template.libs %}
            <i class="fas fa-play-circle"></i>
          {% elseif template.settings.layout == 'slideshow' %}
            <i class="fas fa-images"></i>
          {% elseif template.settings.layout == 'grid' and template.settings.spacing == 'large' %}
            <i class="fas fa-border-none"></i>
          {% elseif template.settings.layout == 'mosaic' %}
            <i class="fas fa-puzzle-piece"></i>
          {% elseif template.settings.layout == 'carousel' %}
            <i class="fas fa-arrows-alt-h"></i>
          {% elseif template.settings.layout == 'polaroid' %}
            <i class="fas fa-camera-retro"></i>
          {% elseif template.settings.layout == 'fullscreen' %}
            <i class="fas fa-expand"></i>
          {% elseif template.settings.layout == 'grid' %}
            {% if template.settings.masonry %}
              <i class="fas fa-grip-vertical"></i>
            {% else %}
              {% set tpl_desktop_cols = template.settings.columns.desktop|default(3) %}
              {% if tpl_desktop_cols <= 2 %}
                <i class="fas fa-pause"></i>
              {% elseif tpl_desktop_cols == 3 %}
                <i class="fas fa-th"></i>
              {% elseif tpl_desktop_cols >= 5 %}
                <i class="fas fa-grip-horizontal"></i>
              {% else %}
                <i class="fas fa-th"></i>
              {% endif %}
            {% endif %}
          {% else %}
            <i class="fas fa-th"></i>
          {% endif %}
        </button>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  {# Gallery container. We reuse the same dynamic partial and JS contract #}
  {# Hero cover defaults to masonry_fit layout for better presentation #}
  {% set custom_template_twig = template_custom_twig|default('') %}
  {% set layout = template_settings.layout|default('masonry_fit') %}
  {% set masonry = template_settings.masonry|default(false) %}
  {% set cols = template_settings.columns is defined ? template_settings.columns : {'desktop':3,'tablet':2,'mobile':1} %}
  {% set gap_h = template_settings.gap.horizontal|default(16) %}
  {% set gap_v = template_settings.gap.vertical|default(16) %}
  {% set desktop_cols = (cols.desktop|default(3))|round %}
  {% set tablet_cols = (cols.tablet|default(2))|round %}
  {% set mobile_cols = (cols.mobile|default(1))|round %}

  {% set mobile_class = mobile_cols >= 6 ? 'grid-cols-6' : (mobile_cols == 5 ? 'grid-cols-5' : (mobile_cols == 4 ? 'grid-cols-4' : (mobile_cols == 3 ? 'grid-cols-3' : (mobile_cols == 2 ? 'grid-cols-2' : 'grid-cols-1')))) %}
  {% set tablet_class = tablet_cols >= 6 ? 'md:grid-cols-6' : (tablet_cols == 5 ? 'md:grid-cols-5' : (tablet_cols == 4 ? 'md:grid-cols-4' : (tablet_cols == 3 ? 'md:grid-cols-3' : (tablet_cols == 2 ? 'md:grid-cols-2' : 'md:grid-cols-1')))) %}
  {% set desktop_class = desktop_cols >= 6 ? 'lg:grid-cols-6' : (desktop_cols == 5 ? 'lg:grid-cols-5' : (desktop_cols == 4 ? 'lg:grid-cols-4' : (desktop_cols == 3 ? 'lg:grid-cols-3' : (desktop_cols == 2 ? 'lg:grid-cols-2' : 'lg:grid-cols-1')))) %}

  {% set style = template_settings.style|default({rounded: false, shadow: false, hover_scale: true, hover_fade: true}) %}

  {% if custom_template_twig %}
    <div id="images-gallery" class="pswp-gallery" data-layout="custom">
      {% include custom_template_twig %}
    </div>
  {% elseif layout == 'magazine' %}
    <div id="images-gallery" class="mt-10" data-hover-fade="{{ style.hover_fade is not defined or style.hover_fade ? '1' : '0' }}">
      {% include 'frontend/_gallery_magazine_content.twig' with { images: images, template_settings: template_settings, album: album } %}
    </div>
  {% elseif layout == 'gallery_wall' or template_settings.template_slug|default('') == 'gallery-wall-scroll' %}
    {% include 'frontend/_gallery_wall_scroll.twig' with { images: images, template_settings: template_settings, album: album, base_path: base_path, site_title: site_title } %}
  {% elseif layout == 'masonry_fit' %}
    {# Modern Masonry layout using balanced flexbox columns - full images, no cropping #}
    <link rel="stylesheet" href="{{ base_path }}/assets/css/masonry-fit.css">
    <div id="images-gallery" class="masonry-fit-grid pswp-gallery" data-layout="masonry_fit" data-gap="{{ gap_h }}" data-gap-v="{{ gap_v }}" data-cols-desktop="{{ desktop_cols }}" data-cols-tablet="{{ tablet_cols }}" data-cols-mobile="{{ mobile_cols }}" data-hover-fade="{{ style.hover_fade is not defined or style.hover_fade ? '1' : '0' }}">
      {% for image in images %}
        {% include "frontend/_image_item_masonry.twig" %}
      {% endfor %}
    </div>
  {% else %}
    <div id="images-gallery" class="{{ layout == 'slideshow' ? 'swiper slideshow-pro max-w-6xl mx-auto' : (layout == 'fullscreen' ? 'grid grid-cols-1 lg:grid-cols-2 gap-2' : (masonry ? 'masonry-grid' : 'grid ' ~ mobile_class ~ ' ' ~ tablet_class ~ ' ' ~ desktop_class ~ ' gap-6')) }}"
         {% if masonry %}style="--cols-desktop: {{ desktop_cols }}; --cols-tablet: {{ tablet_cols }}; --cols-mobile: {{ mobile_cols }};"{% endif %}
         data-hover-fade="{{ style.hover_fade is not defined or style.hover_fade ? '1' : '0' }}">
      {% include 'frontend/_gallery_content.twig' with { images: images, template_settings: template_settings } %}
    </div>
  {% endif %}
</section>

<script nonce="{{ csp_nonce() }}">
  var basePath = '{{ base_path }}';

  // Store template settings for JS access
  window.templateSettings = JSON.parse('{{ template_settings ? template_settings|json_encode|e('js') : '{}' }}');

  // Reusable masonry_fit initialization helper - Balanced Flexbox Columns approach
  window.initAlbumMasonryFit = function(container, options) {
    if (!container) return null;
    if (container._masonryFitInstance && container._masonryFitInstance.destroy) {
      container._masonryFitInstance.destroy();
    }
    const gap = options.gap || 16;
    const colsDesktop = options.colsDesktop || 3;
    const colsTablet = options.colsTablet || 2;
    const colsMobile = options.colsMobile || 1;
    let columnWrappers = [];
    const originalItems = Array.from(container.querySelectorAll('.masonry-item'));
    function getColumnCount() {
      const width = window.innerWidth;
      if (width >= 1024) return colsDesktop;
      if (width >= 768) return colsTablet;
      return colsMobile;
    }
    function createColumnStructure(numCols) {
      columnWrappers.forEach(w => w.remove());
      columnWrappers = [];
      container.style.display = 'flex';
      container.style.flexWrap = 'nowrap';
      container.style.gap = gap + 'px';
      container.style.alignItems = 'flex-start';
      for (let i = 0; i < numCols; i++) {
        const col = document.createElement('div');
        col.className = 'masonry-column';
        col.style.flex = '1';
        col.style.display = 'flex';
        col.style.flexDirection = 'column';
        col.style.gap = gap + 'px';
        col.style.minWidth = '0';
        columnWrappers.push(col);
        container.appendChild(col);
      }
    }
    function distributeItems() {
      const numCols = getColumnCount();
      createColumnStructure(numCols);
      const columnHeights = new Array(numCols).fill(0);
      const colWidth = container.offsetWidth / numCols - gap * (numCols - 1) / numCols;
      const itemHeights = originalItems.map(item => {
        const img = item.querySelector('img');
        if (img && img.dataset.aspectRatio) return colWidth * parseFloat(img.dataset.aspectRatio);
        return item.offsetHeight || colWidth * 0.75;
      });
      const heightThreshold = colWidth * 0.15;
      originalItems.forEach((item, idx) => {
        const shortestHeight = Math.min(...columnHeights);
        let targetIdx = 0;
        for (let i = 0; i < numCols; i++) {
          if (columnHeights[i] <= shortestHeight + heightThreshold) { targetIdx = i; break; }
        }
        item.style.width = '100%';
        item.style.marginBottom = '0';
        columnWrappers[targetIdx].appendChild(item);
        columnHeights[targetIdx] += itemHeights[idx] + gap;
      });
    }
    let viewportObserver = null;
    const preloadedItems = new WeakSet();
    if ('IntersectionObserver' in window) {
      viewportObserver = new IntersectionObserver(function(entries) {
        entries.forEach(function(entry) {
          if (entry.isIntersecting) {
            entry.target.classList.add('in-viewport');
            const img = entry.target.querySelector('img');
            if (img && !preloadedItems.has(entry.target)) { preloadedItems.add(entry.target); img.loading = 'eager'; }
          } else { entry.target.classList.remove('in-viewport'); }
        });
      }, { rootMargin: '200% 0px 200% 0px', threshold: 0 });
    }
    distributeItems();
    if (viewportObserver) { originalItems.forEach(function(item) { viewportObserver.observe(item); }); }
    function destroy() {
      if (viewportObserver) { viewportObserver.disconnect(); viewportObserver = null; }
      columnWrappers.forEach(w => w.remove());
      columnWrappers = [];
    }
    const instance = { distributeItems, viewportObserver, destroy, msnry: { layout: distributeItems }, updateItemWidths: distributeItems };
    container._masonryFitInstance = instance;
    return instance;
  };

  // Helper to setup masonry_fit layout with options extraction and resize handling
  window.setupMasonryFitLayout = function(container) {
    if (!container) return;
    const options = {
      gap: parseInt(container.dataset.gap) || 16,
      colsDesktop: parseInt(container.dataset.colsDesktop) || 3,
      colsTablet: parseInt(container.dataset.colsTablet) || 2,
      colsMobile: parseInt(container.dataset.colsMobile) || 1
    };
    // Setup resize handler with debounce
    let resizeTimer = null;
    const resizeHandler = function() {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(function() {
        const instance = container._masonryFitInstance;
        if (instance) { instance.updateItemWidths(); instance.msnry.layout(); }
      }, 150);
    };
    if (container._masonryFitResizeHandler) { window.removeEventListener('resize', container._masonryFitResizeHandler); }
    container._masonryFitResizeHandler = resizeHandler;
    window.addEventListener('resize', resizeHandler);
    // Initialize with imagesLoaded if available
    const initMasonryFit = () => {
      window.initAlbumMasonryFit(container, options);
      if (window.lenisResize) window.lenisResize();
    };
    if (typeof imagesLoaded !== 'undefined') { imagesLoaded(container, initMasonryFit); }
    else { initMasonryFit(); }
  };

  // Trigger same init used in gallery.twig after load
  window.addEventListener('DOMContentLoaded', function(){
    if (typeof initializeGalleryLayout === 'function') { try { initializeGalleryLayout(); } catch(e){} }

    // Initialize masonry_fit layout
    const layout = window.templateSettings?.layout || 'masonry_fit';
    if (layout === 'masonry_fit') {
      const container = document.getElementById('images-gallery');
      if (container) { window.setupMasonryFitLayout(container); }
    }

    // If magazine is active on first render, ensure autoscroll
    try {
      if (window.templateSettings?.layout === 'magazine') {
        if (typeof initMagazineAutoscroll === 'function') {
          setTimeout(() => { initMagazineAutoscroll(); }, 100);
        } else {
          // Inline fallback with better reinitialization
          setTimeout(() => {
            document.querySelectorAll('.m-col').forEach(function(col){
              var track = col.querySelector('.m-track'); if (!track) return;
              track.style.animation = 'none';
              track.offsetHeight; // Force reflow
              var dir = (col.getAttribute('data-direction')||'down').toLowerCase();
              var dur = (getComputedStyle(col).getPropertyValue('--m-duration')||'60s').trim() || '60s';
              track.style.transform = dir === 'up' ? 'translateY(-50%)' : 'translateY(0)';
              track.style.animation = (dir==='up'?'mScrollUp':'mScrollDown') + ' ' + dur + ' linear infinite';
              track.style.animationPlayState = '';
            });
            document.querySelectorAll('.m-mobile-wrap').forEach(function(mwrap){
              var track = mwrap.querySelector('.m-mobile-track'); if (!track) return;
              track.style.animation = 'none';
              track.offsetHeight; // Force reflow
              var dur = (getComputedStyle(mwrap).getPropertyValue('--m-duration')||'60s').trim() || '60s';
              track.style.animation = 'mScrollDown ' + dur + ' linear infinite';
              track.style.animationPlayState = '';
            });
          }, 100);
        }
      }
    } catch(e){}

    // Template switcher animation (hidden initially, animate to visible)
    const templateSwitcher = document.getElementById('template-switcher');
    if (templateSwitcher && typeof gsap !== 'undefined') {
      gsap.to(templateSwitcher, {
        opacity: 1,
        x: 0,
        duration: 0.5,
        delay: 0.6,
        ease: 'power2.out'
      });
    }
  });
  // Layout initializer copied from classic template (slideshow/masonry/carousel support)
  function initMasonryPortfolio(containerOrSelector) {
    const grid = typeof containerOrSelector === 'string'
      ? document.querySelector(containerOrSelector)
      : containerOrSelector || document.querySelector('.masonry-portfolio-grid');

    if (!grid || typeof Masonry === 'undefined' || typeof imagesLoaded === 'undefined') return null;
    if (grid._masonryPortfolioInitialized) return grid._masonryPortfolioInstance;

    const gapH = parseInt(grid.dataset.gapH || '16', 10);
    const mpType = (window.templateSettings?.masonry_portfolio?.type || 'balanced');
    const horizontalOrder = mpType === 'regular';

    if (grid._masonryPortfolioInstance) {
      grid._masonryPortfolioInstance.destroy();
      grid._masonryPortfolioInstance = null;
    }

    grid._masonryPortfolioInitialized = true;
    grid._masonryPortfolioInstance = new Masonry(grid, {
      itemSelector: '.photo-item',
      columnWidth: '.grid-sizer',
      gutter: gapH,
      percentPosition: true,
      horizontalOrder: horizontalOrder,
      transitionDuration: '0.3s'
    });

    imagesLoaded(grid).on('progress', function(instance, image) {
      const img = image.img || null;
      if (img) {
        img.classList.add('is-loaded');
        const item = img.closest('.photo-item');
        if (item) item.classList.add('is-loaded');
      }
      grid._masonryPortfolioInstance.layout();
    });

    return grid._masonryPortfolioInstance;
  }

  function initCreativeLayout(containerOrSelector) {
    const container = typeof containerOrSelector === 'string'
      ? document.querySelector(containerOrSelector)
      : containerOrSelector || document.querySelector('.creative-gallery');

    if (!container) return;
    const images = container.querySelectorAll('img');
    images.forEach((img) => {
      if (img.complete) {
        img.classList.add('loaded');
        const loading = img.closest('.img-container')?.querySelector('.loading');
        if (loading) loading.remove();
      } else {
        img.addEventListener('load', function() {
          img.classList.add('loaded');
          const loading = img.closest('.img-container')?.querySelector('.loading');
          if (loading) loading.remove();
        }, { once: true });
      }
    });

    if (!container._creativeHoverBound) {
      container._creativeHoverBound = true;
      document.addEventListener('mousemove', function(e) {
        const hovers = container.querySelectorAll('.img-content-hover');
        hovers.forEach(function(element) {
          if (element.style.display === 'block' || window.getComputedStyle(element).display === 'block') {
            const x = e.pageX + 20;
            const y = e.pageY + 20;
            element.style.transform = `translate3d(${x}px, ${y}px, 0)`;
          }
        });
      });
    }
  }

    function initGalleryWallScroll(containerOrSelector) {
        const container = typeof containerOrSelector === 'string'
          ? document.querySelector(containerOrSelector)
          : containerOrSelector || document.querySelector('.gallery-wall');

        if (!container) return;

    document.body.classList.add('gallery-wall-page');

    const section = container.querySelector('#galleryWallSection') || container.querySelector('.gallery-wall-section');
    const track = container.querySelector('#galleryWallTrack') || container.querySelector('.gallery-wall-track');
    if (!section || !track) return;

        if (container._wallScrollCleanup) {
          container._wallScrollCleanup();
        }

        let maxScroll = 0;
        const isMobile = () => window.matchMedia('(max-width: 768px)').matches;

        function updateMetrics() {
          const trackWidth = track.scrollWidth;
          const windowWidth = window.innerWidth;
          const windowHeight = window.innerHeight;
          maxScroll = Math.max(0, trackWidth - windowWidth);
          const sectionHeight = maxScroll + windowHeight;
          section.style.height = sectionHeight + 'px';
        }

        function updateTrack() {
          if (isMobile()) {
            track.style.transform = 'translateX(0px)';
            return;
          }
          const rect = section.getBoundingClientRect();
          const sectionScrollHeight = section.offsetHeight - window.innerHeight;
          const scrollInSection = Math.max(0, -rect.top);
          const progress = sectionScrollHeight > 0 ? Math.min(1, scrollInSection / sectionScrollHeight) : 0;
          track.style.transform = `translateX(${-progress * maxScroll}px)`;
        }

        const onScroll = () => requestAnimationFrame(updateTrack);
        const onResize = () => {
          updateMetrics();
          updateTrack();
          if (window.lenisResize) setTimeout(window.lenisResize, 100);
        };
        let dragActive = false;
        let dragStartX = 0;
        let dragStartScroll = 0;
        let dragSectionStart = 0;
        const startDrag = (clientX) => {
          if (isMobile() || maxScroll === 0) return;
          dragActive = true;
          dragStartX = clientX;
          dragSectionStart = window.scrollY + section.getBoundingClientRect().top;
          dragStartScroll = Math.max(0, window.scrollY - dragSectionStart);
          section.style.cursor = 'grabbing';
        };
        const moveDrag = (clientX, evt) => {
          if (!dragActive || isMobile() || maxScroll === 0) return;
          const dx = clientX - dragStartX;
          const nextScroll = Math.max(0, Math.min(maxScroll, dragStartScroll - dx));
          if (nextScroll !== dragStartScroll) {
            if (evt) evt.preventDefault();
            window.scrollTo({ top: dragSectionStart + nextScroll, left: 0, behavior: 'auto' });
            updateTrack();
          }
        };
        const endDrag = () => {
          if (!dragActive) return;
          dragActive = false;
          section.style.cursor = '';
        };
        const onMouseDown = (e) => {
          if (e.button !== 0) return;
          startDrag(e.clientX);
        };
        const onMouseMove = (e) => {
          if (!dragActive) return;
          moveDrag(e.clientX, e);
        };
        const onMouseUp = () => endDrag();
        const onTouchStart = (e) => {
          if (!e.touches || e.touches.length !== 1) return;
          startDrag(e.touches[0].clientX);
        };
        const onTouchMove = (e) => {
          if (!e.touches || e.touches.length !== 1) return;
          moveDrag(e.touches[0].clientX, e);
        };
        const onTouchEnd = () => endDrag();

        updateMetrics();
        updateTrack();
        window.addEventListener('scroll', onScroll, { passive: true });
        window.addEventListener('resize', onResize);
        section.addEventListener('mousedown', onMouseDown);
        section.addEventListener('mousemove', onMouseMove);
        window.addEventListener('mouseup', onMouseUp);
        section.addEventListener('touchstart', onTouchStart, { passive: true });
        section.addEventListener('touchmove', onTouchMove, { passive: false });
        section.addEventListener('touchend', onTouchEnd);
        section.addEventListener('touchcancel', onTouchEnd);

        container._wallScrollCleanup = () => {
          window.removeEventListener('scroll', onScroll);
          window.removeEventListener('resize', onResize);
          section.removeEventListener('mousedown', onMouseDown);
          section.removeEventListener('mousemove', onMouseMove);
          window.removeEventListener('mouseup', onMouseUp);
          section.removeEventListener('touchstart', onTouchStart);
          section.removeEventListener('touchmove', onTouchMove);
          section.removeEventListener('touchend', onTouchEnd);
          section.removeEventListener('touchcancel', onTouchEnd);
        };
      }

  function initializeGalleryLayout() {
    const layout = window.templateSettings?.layout || 'grid';
    const templateSlug = window.templateSettings?.template_slug || '';
    const masonry = window.templateSettings?.masonry || false;
    if (layout === 'slideshow' && typeof Swiper !== 'undefined') {
      let slideshowThumbs = null;
      const thumbsEl = document.querySelector('.slideshow-thumbs');
      if (thumbsEl) {
        slideshowThumbs = new Swiper(thumbsEl, { spaceBetween: 10, slidesPerView: 'auto', freeMode: true, watchSlidesProgress: true });
      }
      window.gallerySwiper = new Swiper('.slideshow-pro', {
        spaceBetween: 10,
        navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev' },
        pagination: { el: '.swiper-pagination', clickable: true },
        thumbs: slideshowThumbs ? { swiper: slideshowThumbs } : undefined,
        loop: true,
        autoplay: window.templateSettings?.slideshow?.autoplay ? { delay: window.templateSettings?.slideshow?.delay || 5000, disableOnInteraction: false } : false,
        effect: 'fade', fadeEffect: { crossFade: true }
      });
    } else if (layout === 'carousel' && typeof Swiper !== 'undefined') {
      window.gallerySwiper = new Swiper('.carousel-flow', { slidesPerView: 'auto', spaceBetween: 20, centeredSlides: true, freeMode: true, grabCursor: true, mousewheel: { thresholdDelta: 70, forceToAxis: true }, breakpoints: { 640:{spaceBetween:30}, 1024:{spaceBetween:40} } });
    } else if (layout === 'polaroid') {
      const polaroidItems = document.querySelectorAll('.polaroid-item');
      if (window.innerWidth > 768) {
        polaroidItems.forEach((item) => {
          const randomX = Math.random() * 80 + 5; const randomY = Math.random() * 60 + 10; const randomRotation = (Math.random() - 0.5) * 16;
          item.style.left = randomX + '%'; item.style.top = randomY + '%'; item.style.transform = `rotate(${randomRotation}deg)`; item.style.zIndex = Math.floor(Math.random() * 10) + 1;
        });
      }
    } else if (templateSlug === 'grid-ampia') {
      const container = document.getElementById('images-gallery');
      if (container) {
        initCreativeLayout(container);
      }
    } else if (templateSlug === 'gallery-wall-scroll') {
      const container = document.getElementById('images-gallery');
      if (container) {
        initGalleryWallScroll(container);
      }
    } else if (templateSlug === 'masonry-portfolio') {
      const container = document.getElementById('images-gallery');
      if (container) {
        initMasonryPortfolio(container);
      }
    } else if (masonry && (layout === 'masonry' || window.templateSettings?.masonry_js === true) && typeof Masonry !== 'undefined') {
      const container = document.getElementById('images-gallery');
      if (container) {
        imagesLoaded(container, function(){
          window.galleryMasonry = new Masonry(container, { itemSelector: '.masonry-item', percentPosition: true });
          setTimeout(() => {
            container.querySelectorAll('img').forEach(img => { img.style.opacity = '1'; img.style.transition = 'none'; });
            container.querySelectorAll('.image-item').forEach(item => { item.style.opacity = '1'; item.style.transform = 'scale(1)'; item.style.transition = 'none'; });
          }, 50);
        });
      }
    }
    setTimeout(() => { const gc = document.getElementById('images-gallery'); if (gc) { gc.querySelectorAll('.image-item').forEach(item => { item.style.opacity = '1'; item.style.transform = 'scale(1)'; item.style.transition = 'none'; }); } }, 100);
  }
  function initMagazineAutoscroll() {
    try {
      var container = document.getElementById('images-gallery') || document;

      // Responsive display management
      var isMobile = window.matchMedia('(max-width: 767px)').matches;
      var isTablet = window.matchMedia('(min-width: 768px) and (max-width: 1199px)').matches;
      var isDesktop = window.matchMedia('(min-width: 1200px)').matches;

      var mob = container.querySelector('.m-mobile-wrap');
      var tablet = container.querySelector('.m-tablet-wrap');
      var desk = container.querySelector('.m-desktop-wrap');
      
      // Set appropriate display for each wrapper
      if (mob) mob.style.display = isMobile ? 'block' : 'none';
      if (tablet) tablet.style.display = isTablet ? 'flex' : 'none';
      if (desk) desk.style.display = isDesktop ? 'flex' : 'none';

      var trackOriginals = new WeakMap();
      var ensureTrackFill = function(track, colHeight) {
        if (!track || !colHeight) return;
        var originals = trackOriginals.get(track);
        if (!originals) {
          originals = Array.from(track.children);
          trackOriginals.set(track, originals);
        }
        if (!originals.length) return;
        var minHeight = colHeight * 2;
        var loops = 0;
        while (track.scrollHeight < minHeight && loops < 12) {
          var frag = document.createDocumentFragment();
          originals.forEach(function(node) {
            var clone = node.cloneNode(true);
            var link = clone.querySelector && clone.querySelector('a.pswp-link');
            if (link) link.classList.add('pswp-is-duplicate');
            frag.appendChild(clone);
          });
          track.appendChild(frag);
          loops += 1;
        }
      };
      var forceEager = function(scope) {
        if (!scope) return;
        scope.querySelectorAll('img[loading=\"lazy\"]').forEach(function(img) {
          img.setAttribute('loading', 'eager');
        });
      };

      var activeWrap = isMobile ? mob : (isTablet ? tablet : desk);
      if (activeWrap) {
        activeWrap.querySelectorAll('source[data-srcset]').forEach(function(source) {
          source.setAttribute('srcset', source.getAttribute('data-srcset'));
          source.removeAttribute('data-srcset');
        });
        activeWrap.querySelectorAll('img[data-src]').forEach(function(img) {
          img.setAttribute('src', img.getAttribute('data-src'));
          img.removeAttribute('data-src');
        });
      }
      
      // Force setup column styles for all columns
      container.querySelectorAll('.m-col').forEach(function(col){
        if (!col.style.height) {
          if (col.classList.contains('m-tablet-col')) {
            col.style.height = '130vh';
          } else {
            col.style.height = '140vh';
          }
        }
        col.style.overflow = 'hidden';
        col.style.position = 'relative';
      });
      
      // Reset and restart mobile track animation
      var mobileTrack = container.querySelector('.m-mobile-track');
      if (mobileTrack) {
        mobileTrack.style.animation = 'none';
        mobileTrack.offsetHeight; // Force reflow
        
        var mobileDur = getComputedStyle(mobileTrack.closest('.m-mobile-wrap')).getPropertyValue('--m-duration').trim() || '45s';
        mobileTrack.style.animation = 'mScrollDown ' + mobileDur + ' linear infinite';
        mobileTrack.style.animationPlayState = '';
      }
      
      // Reset and restart all column animations (tablet + desktop)
      container.querySelectorAll('.m-col .m-track').forEach(function(track){
        var col = track.closest('.m-col');
        if (!col) return;

        ensureTrackFill(track, col.clientHeight || window.innerHeight);
        forceEager(track);

        // Clear existing animation first
        track.style.animation = 'none';
        track.offsetHeight; // Force reflow
        
        var dir = (col.getAttribute('data-direction') || 'down').toLowerCase();
        var dur = (getComputedStyle(col).getPropertyValue('--m-duration') || '60s').trim();
        if (!dur) dur = '60s';
        
        var anim = (dir === 'up' ? 'mScrollUp' : 'mScrollDown') + ' ' + dur + ' linear infinite';
        track.style.transform = dir === 'up' ? 'translateY(-50%)' : 'translateY(0)';
        track.style.animation = anim;
        track.style.animationPlayState = '';
      });

      var mobileTrack = container.querySelector('.m-mobile-track');
      if (mobileTrack) {
        var mobWrap = mobileTrack.closest('.m-mobile') || mobileTrack.parentElement;
        ensureTrackFill(mobileTrack, (mobWrap && mobWrap.clientHeight) || window.innerHeight);
        forceEager(mobileTrack);
      }
      var rerun = function() {
        container.querySelectorAll('.m-col .m-track').forEach(function(track){
          var col = track.closest('.m-col');
          if (!col) return;
          ensureTrackFill(track, col.clientHeight || window.innerHeight);
        });
        var mobTrack = container.querySelector('.m-mobile-track');
        if (mobTrack) {
          var wrap = mobTrack.closest('.m-mobile') || mobTrack.parentElement;
          ensureTrackFill(mobTrack, (wrap && wrap.clientHeight) || window.innerHeight);
        }
      };
      setTimeout(rerun, 200);
      setTimeout(rerun, 800);

      if (!container._magazineDragBound) {
        container._magazineDragBound = true;
        var dragState = { active: false, moved: false, startX: 0, startY: 0, startScroll: 0, sectionTop: 0, col: null };
        var startDrag = function(clientX, clientY, target) {
          dragState.active = true;
          dragState.moved = false;
          dragState.col = target;
          dragState.sectionTop = container.getBoundingClientRect().top + window.scrollY;
          dragState.startX = clientX;
          dragState.startY = clientY;
          dragState.startScroll = window.scrollY;
          target.style.cursor = 'grabbing';
        };
        var moveDrag = function(clientX, clientY, ev) {
          if (!dragState.active) return;
          var dx = clientX - dragState.startX;
          var dy = clientY - dragState.startY;
          if (Math.abs(dy) > Math.abs(dx)) return;
          if (Math.abs(dx) <= 8) return;
          if (!dragState.moved) {
            dragState.moved = true;
            document.body.classList.add('magazine-dragging');
          }
          if (ev) ev.preventDefault();
          var nextTop = dragState.startScroll - dx;
          var maxTop = dragState.sectionTop + Math.max(0, container.offsetHeight - window.innerHeight);
          if (nextTop < dragState.sectionTop) nextTop = dragState.sectionTop;
          if (nextTop > maxTop) nextTop = maxTop;
          window.scrollTo({ top: nextTop, left: 0, behavior: 'auto' });
        };
        var endDrag = function() {
          if (!dragState.active) return;
          dragState.active = false;
          if (dragState.col) dragState.col.style.cursor = '';
          dragState.col = null;
          document.body.classList.remove('magazine-dragging');
          if (dragState.moved) {
            var guard = function(clickEv) {
              if (container.contains(clickEv.target)) {
                clickEv.preventDefault();
                clickEv.stopPropagation();
              }
              container.removeEventListener('click', guard, true);
            };
            container.addEventListener('click', guard, true);
          }
        };
        var onMouseDown = function(ev) {
          if (ev.button !== 0) return;
          var target = ev.target.closest ? ev.target.closest('.m-col') : null;
          if (!target) return;
          ev.preventDefault();
          startDrag(ev.clientX, ev.clientY, target);
        };
        var onMouseMove = function(ev) { moveDrag(ev.clientX, ev.clientY, ev); };
        var onMouseUp = function() { endDrag(); };
        var onTouchStart = function(ev) {
          if (!ev.touches || ev.touches.length !== 1) return;
          var target = ev.target.closest ? ev.target.closest('.m-col') : null;
          if (!target) return;
          startDrag(ev.touches[0].clientX, ev.touches[0].clientY, target);
        };
        var onTouchMove = function(ev) {
          if (!ev.touches || ev.touches.length !== 1) return;
          moveDrag(ev.touches[0].clientX, ev.touches[0].clientY, ev);
        };
        var onTouchEnd = function() { endDrag(); };
        var onDragStart = function(ev) { ev.preventDefault(); };
        var onWindowBlur = function() { endDrag(); };
        var onVisibility = function() { if (document.hidden) endDrag(); };
        container.addEventListener('mousedown', onMouseDown);
        window.addEventListener('mousemove', onMouseMove);
        window.addEventListener('mouseup', onMouseUp);
        container.addEventListener('touchstart', onTouchStart, { passive: true });
        window.addEventListener('touchmove', onTouchMove, { passive: false });
        window.addEventListener('touchend', onTouchEnd);
        window.addEventListener('touchcancel', onTouchEnd);
        container.addEventListener('dragstart', onDragStart);
        window.addEventListener('blur', onWindowBlur);
        document.addEventListener('visibilitychange', onVisibility);
        container._magazineDragCleanup = function() {
          container.removeEventListener('mousedown', onMouseDown);
          window.removeEventListener('mousemove', onMouseMove);
          window.removeEventListener('mouseup', onMouseUp);
          container.removeEventListener('touchstart', onTouchStart);
          window.removeEventListener('touchmove', onTouchMove);
          window.removeEventListener('touchend', onTouchEnd);
          window.removeEventListener('touchcancel', onTouchEnd);
          container.removeEventListener('dragstart', onDragStart);
          window.removeEventListener('blur', onWindowBlur);
          document.removeEventListener('visibilitychange', onVisibility);
        };
      }
    } catch(e) {
      // Silently fail - magazine layout will show without animation
    }
  }
  function loadTemplateAssets(assets) {
    if (!assets) return;
    const cssList = Array.isArray(assets.css) ? assets.css : [];
    const jsList = Array.isArray(assets.js) ? assets.js : [];

    cssList.forEach(href => {
      if (!href || document.querySelector(`link[data-template-asset="${href}"]`)) return;
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = href;
      link.setAttribute('data-template-asset', href);
      document.head.appendChild(link);
    });

    jsList.forEach(src => {
      if (!src || document.querySelector(`script[data-template-asset="${src}"]`)) return;
      const script = document.createElement('script');
      script.src = src;
      script.defer = true;
      script.setAttribute('data-template-asset', src);
      document.body.appendChild(script);
    });
  }
  // Delegated handler for template switches (AJAX) with class update
  document.addEventListener('click', function(event) {
    const el = event.target.closest('.tpl-switch');
    if (!el) return;
    event.preventDefault();
    if (el.dataset.switchInProgress === '1') return;
    el.dataset.switchInProgress = '1';
    const galleryContainer = document.getElementById('images-gallery');
    const templateId = el.getAttribute('data-template-id') || (new URL(el.href, window.location.origin)).searchParams.get('template');
    const albumRef = el.getAttribute('data-album-ref') || window.location.pathname.split('/').pop();
    if (!galleryContainer || !templateId || !albumRef) { delete el.dataset.switchInProgress; return; }
    const original = galleryContainer.innerHTML;
    galleryContainer.classList.add('tpl-switching');
    galleryContainer.innerHTML = '<div class="flex justify-center py-12"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-black"></div></div>';
    document.querySelectorAll('.tpl-switch').forEach(btn => { btn.classList.remove('bg-black','text-white'); btn.classList.add('text-neutral-700','hover:bg-neutral-100'); });
    el.classList.remove('text-neutral-700','hover:bg-neutral-100'); el.classList.add('bg-black','text-white');
    const fetchUrl = `${basePath}/api/gallery/template?album=${encodeURIComponent(albumRef)}&template=${encodeURIComponent(templateId)}`;
    fetch(fetchUrl, { headers: { 'Accept': 'text/html', 'X-Requested-With': 'XMLHttpRequest' } })
      .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.text(); })
      .then(html => {
        let parsedHtml = html;
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const settingsScript = doc.querySelector('script');
        if (settingsScript && settingsScript.textContent) {
          const match = settingsScript.textContent.match(/window\.templateSettings\s*=\s*(\{[\s\S]*?\});/);
          if (match) {
            try { window.templateSettings = JSON.parse(match[1]); }
            catch(e) { console.error('Failed to parse templateSettings:', e); }
          }
          const assetsMatch = settingsScript.textContent.match(/window\.templateAssets\s*=\s*(\{[\s\S]*?\});/);
          if (assetsMatch) {
            try { window.templateAssets = JSON.parse(assetsMatch[1]); }
            catch(e) { console.error('Failed to parse templateAssets:', e); window.templateAssets = { css: [], js: [] }; }
          }
          settingsScript.remove();
        }
        parsedHtml = doc.body ? doc.body.innerHTML : html;
        loadTemplateAssets(window.templateAssets);
        galleryContainer.innerHTML = parsedHtml;
        // Match direct object assignment from _gallery_content.twig
        // Update container classes based on new template settings
        const templateSlug = window.templateSettings?.template_slug || '';
        const isCustomTemplate = window.templateSettings?.layout === 'custom';
        const newLayout = templateSlug === 'masonry-portfolio'
          ? 'masonry_portfolio'
          : (templateSlug === 'grid-ampia'
            ? 'creative_layout'
            : (templateSlug === 'gallery-wall-scroll'
              ? 'gallery_wall'
              : (window.templateSettings?.layout || 'grid')));
        const newMasonry = !!window.templateSettings?.masonry;
        const idKeep = galleryContainer.id;
        galleryContainer.className = '';
        if (newLayout !== 'gallery_wall') {
          document.body.classList.remove('gallery-wall-page');
        }

        if (isCustomTemplate) {
          galleryContainer.className = 'pswp-gallery';
          galleryContainer.dataset.layout = 'custom';
        } else if (newLayout === 'magazine') {
          galleryContainer.className = 'mt-10';
        } else if (newLayout === 'gallery_wall') {
          const wall = window.templateSettings?.gallery_wall || {};
          const wallDesktop = wall.desktop || {};
          const wallTablet = wall.tablet || {};
          const wallMobile = wall.mobile || {};
          const hRatio = wallDesktop.horizontal_ratio ?? 1.5;
          const vRatio = wallDesktop.vertical_ratio ?? 0.67;
          const hRatioT = wallTablet.horizontal_ratio ?? 1.3;
          const vRatioT = wallTablet.vertical_ratio ?? 0.6;
          const divider = wall.divider ?? 2;
          const mobileCols = wallMobile.columns ?? 2;
          const mobileGap = wallMobile.gap ?? 8;
          const mobileWideEvery = wallMobile.wide_every ?? 5;
          galleryContainer.className = 'gallery-wall pswp-gallery';
          galleryContainer.dataset.layout = 'gallery_wall';
          galleryContainer.dataset.wallInit = '1';
          galleryContainer.style.setProperty('--wall-h-ratio', hRatio);
          galleryContainer.style.setProperty('--wall-v-ratio', vRatio);
          galleryContainer.style.setProperty('--wall-h-ratio-tablet', hRatioT);
          galleryContainer.style.setProperty('--wall-v-ratio-tablet', vRatioT);
          galleryContainer.style.setProperty('--wall-divider', `${divider}px`);
          galleryContainer.style.setProperty('--wall-mobile-cols', mobileCols);
          galleryContainer.style.setProperty('--wall-mobile-gap', `${mobileGap}px`);
          galleryContainer.style.setProperty('--wall-mobile-wide-every', mobileWideEvery);
          if (!document.getElementById('gallery-wall-switcher-style')) {
            const wallStyle = document.createElement('style');
            wallStyle.id = 'gallery-wall-switcher-style';
            wallStyle.textContent = `
              .gallery-wall, .gallery-wall * { margin: 0; padding: 0; box-sizing: border-box; }
              .gallery-wall-section { position: relative; }
              .gallery-wall-container { position: sticky; top: var(--header-height, 80px); height: calc(100vh - var(--header-height, 80px)); display: flex; align-items: center; overflow: hidden; background: #ffffff; z-index: 10; }
              html.dark .gallery-wall-container { background: #0a0a0a; }
              .gallery-wall-track { display: flex; gap: 0; will-change: transform; }
              .gallery-wall-item { flex-shrink: 0; height: calc(100vh - var(--header-height, 80px)); position: relative; }
              .gallery-wall-item.horizontal { width: calc((100vh - var(--header-height, 80px)) * var(--wall-h-ratio, 1.5)); }
              .gallery-wall-item.vertical { width: calc((100vh - var(--header-height, 80px)) * var(--wall-v-ratio, 0.67)); }
              .gallery-wall-item a { display: block; width: 100%; height: 100%; }
              .gallery-wall-item picture, .gallery-wall-item img { width: 100%; height: 100%; object-fit: cover; display: block; }
              .gallery-wall-item::after { content: ''; position: absolute; right: 0; top: 0; bottom: 0; width: var(--wall-divider, 2px); background: #fff; }
              html.dark .gallery-wall-item::after { background: #171717; }
              .gallery-wall-overlay { position: absolute; bottom: 0; left: 0; right: 0; padding: 1.5rem; background: linear-gradient(transparent, rgba(0,0,0,0.7)); color: white; opacity: 0; transition: opacity 0.3s ease; }
              .gallery-wall-item:hover .gallery-wall-overlay { opacity: 1; }
              .gallery-wall-overlay h3 { font-size: 1rem; font-weight: 500; margin: 0 0 0.25rem 0; }
              .gallery-wall-overlay p { font-size: 0.85rem; opacity: 0.8; margin: 0; }
              .gallery-mobile-grid { display: none; }
              @media (max-width: 1024px) {
                .gallery-wall-item.horizontal { width: calc((100vh - var(--header-height, 80px)) * var(--wall-h-ratio-tablet, 1.3)); }
                .gallery-wall-item.vertical { width: calc((100vh - var(--header-height, 80px)) * var(--wall-v-ratio-tablet, 0.6)); }
              }
              @media (max-width: 768px) {
                .gallery-wall-section { display: none; }
                .gallery-mobile-grid { display: block; padding: var(--wall-mobile-gap, 8px); }
                .gallery-mobile-grid-inner { display: grid; grid-template-columns: repeat(var(--wall-mobile-cols, 2), minmax(0, 1fr)); gap: var(--wall-mobile-gap, 8px); }
                .gallery-mobile-item { aspect-ratio: 1; overflow: hidden; position: relative; background: #f5f5f5; }
                .gallery-mobile-item.wide { grid-column: span 2; aspect-ratio: 16/9; }
                .gallery-mobile-item a, .gallery-mobile-item picture, .gallery-mobile-item img { display: block; width: 100%; height: 100%; object-fit: cover; }
              }
              @media (max-width: 480px) { .gallery-mobile-grid { padding: 0.5rem; } }
            `;
            document.head.appendChild(wallStyle);
          }
        } else if (newLayout === 'creative_layout') {
          const creative = window.templateSettings?.creative_layout || {};
          const gap = Math.round(creative.gap ?? 15);
          const hoverTooltip = creative.hover_tooltip === false ? '0' : '1';
          const hoverScale = window.templateSettings?.style?.hover_scale === false ? '0' : '1';
          galleryContainer.className = 'creative-gallery pswp-gallery';
          galleryContainer.dataset.layout = 'creative_layout';
          galleryContainer.dataset.hoverTooltip = hoverTooltip;
          galleryContainer.dataset.hoverScale = hoverScale;
          galleryContainer.dataset.gap = String(gap);
        } else if (newLayout === 'masonry_portfolio') {
          const mp = window.templateSettings?.masonry_portfolio || {};
          const mpCols = mp.columns || window.templateSettings?.columns || {desktop:4, tablet:3, mobile:1};
          const mpGapH = mp.gap_h ?? window.templateSettings?.gap?.horizontal ?? 16;
          const mpGapV = mp.gap_v ?? window.templateSettings?.gap?.vertical ?? 16;
          const layoutMode = mp.layout_mode || 'fullwidth';
          const mpStyle = window.templateSettings?.style || {};
          galleryContainer.className = `masonry-portfolio-grid pswp-gallery${layoutMode === 'boxed' ? ' is-boxed' : ''}`;
          galleryContainer.dataset.layout = 'masonry_portfolio';
          galleryContainer.dataset.gapH = mpGapH;
          galleryContainer.dataset.gapV = mpGapV;
          galleryContainer.dataset.colsDesktop = Math.round(mpCols.desktop || 4);
          galleryContainer.dataset.colsTablet = Math.round(mpCols.tablet || 3);
          galleryContainer.dataset.colsMobile = Math.round(mpCols.mobile || 1);
          galleryContainer.dataset.rounded = mpStyle.rounded ? '1' : '0';
          galleryContainer.dataset.shadow = mpStyle.shadow ? '1' : '0';
          galleryContainer.dataset.hoverScale = mpStyle.hover_scale === false ? '0' : '1';
        } else if (newLayout === 'masonry_fit') {
          galleryContainer.className = 'masonry-fit-grid pswp-gallery';
          const cols = window.templateSettings?.columns || {desktop:3, tablet:2, mobile:1};
          const gap = window.templateSettings?.gap?.horizontal || 16;
          const gapV = window.templateSettings?.gap?.vertical || 16;
          galleryContainer.dataset.layout = 'masonry_fit';
          galleryContainer.dataset.gap = gap;
          galleryContainer.dataset.gapV = gapV;
          galleryContainer.dataset.colsDesktop = Math.round(cols.desktop || 3);
          galleryContainer.dataset.colsTablet = Math.round(cols.tablet || 2);
          galleryContainer.dataset.colsMobile = Math.round(cols.mobile || 1);
        } else if (newLayout === 'slideshow') {
          galleryContainer.className = 'swiper slideshow-pro max-w-6xl mx-auto';
        } else if (newLayout === 'fullscreen') {
          galleryContainer.className = 'grid grid-cols-1 lg:grid-cols-2 gap-2';
        } else if (newMasonry) {
          galleryContainer.className = 'masonry-grid';
          try {
            const cols = window.templateSettings?.columns || {desktop:3, tablet:2, mobile:1};
            let d = Math.round(cols.desktop || 3), t = Math.round(cols.tablet || 2), mcols = Math.round(cols.mobile || 1);
            galleryContainer.style.setProperty('--cols-desktop', d);
            galleryContainer.style.setProperty('--cols-tablet', t);
            galleryContainer.style.setProperty('--cols-mobile', mcols);
          } catch(e) { console.warn('Failed to set masonry column vars (hero)', e); }
        } else {
          const cols = window.templateSettings?.columns || {desktop:3, tablet:2, mobile:1};
          let d = Math.round(cols.desktop || 3), t = Math.round(cols.tablet || 2), mcols = Math.round(cols.mobile || 1);
          const mc = mcols>=6?'grid-cols-6':mcols==5?'grid-cols-5':mcols==4?'grid-cols-4':mcols==3?'grid-cols-3':mcols==2?'grid-cols-2':'grid-cols-1';
          const tc = t>=6?'md:grid-cols-6':t==5?'md:grid-cols-5':t==4?'md:grid-cols-4':t==3?'md:grid-cols-3':t==2?'md:grid-cols-2':'md:grid-cols-1';
          const dc = d>=6?'lg:grid-cols-6':d==5?'lg:grid-cols-5':d==4?'lg:grid-cols-4':d==3?'lg:grid-cols-3':d==2?'lg:grid-cols-2':'lg:grid-cols-1';
          galleryContainer.className = `grid ${mc} ${tc} ${dc} gap-6`;
        }
        galleryContainer.classList.add('tpl-switching');
        galleryContainer.id = idKeep;
        // Update URL
        try { history.pushState(null, '', `${basePath}/album/${albumRef}?template=${templateId}`); } catch(e){}
        // Re-init
        setTimeout(() => {
          if (typeof initLightbox === 'function') initLightbox();
          if (window.gallerySwiper?.destroy) { window.gallerySwiper.destroy(true,true); window.gallerySwiper = null; }
          if (window.galleryMasonry?.destroy) { window.galleryMasonry.destroy(); window.galleryMasonry = null; }
          // Clean up previous masonry_fit instance if exists
          if (galleryContainer._masonryFitInstance?.destroy) {
            galleryContainer._masonryFitInstance.destroy();
            galleryContainer._masonryFitInstance = null;
          }
          if (newLayout === 'magazine') {
            console.log('Initializing Magazine Split template');
            setTimeout(() => { try { initMagazineAutoscroll(); } catch(e){ console.error('Magazine init error:', e); } }, 100);
          } else if (newLayout === 'gallery_wall') {
            initGalleryWallScroll(galleryContainer);
          } else if (newLayout === 'creative_layout') {
            initCreativeLayout(galleryContainer);
          } else if (newLayout === 'masonry_portfolio') {
            initMasonryPortfolio(galleryContainer);
          } else if (newLayout === 'masonry_fit') {
            console.log('Initializing Masonry Fit template');
            if (typeof window.setupMasonryFitLayout === 'function') {
              window.setupMasonryFitLayout(galleryContainer);
            }
          } else if (typeof initializeGalleryLayout === 'function') initializeGalleryLayout();
          // Trigger entrance animation for new gallery items (run before container shows)
          if (typeof window.animateGalleryOnce === 'function') {
            try { window.animateGalleryOnce(); } catch(e) {}
          }
          // Show container after animation starts
          setTimeout(() => {
            galleryContainer.classList.remove('tpl-switching');
            galleryContainer.style.transition = 'none';
            // Fallback: force items visible if animation failed
            galleryContainer.querySelectorAll('.masonry-item, .image-item, .photo-item').forEach(el => {
              if (!el.hasAttribute('data-animated')) {
                el.style.opacity = '1';
                el.style.transform = 'scale(1)';
              }
            });
          }, 80);
        }, 50);
      })
      .catch(err => { console.error('Template switch failed', err); galleryContainer.innerHTML = original; galleryContainer.classList.remove('tpl-switching'); })
      .finally(() => { delete el.dataset.switchInProgress; });
  });
  </script>
  {# JSON-LD: ImageGallery + Breadcrumbs #}
  <script type="application/ld+json" nonce="{{ csp_nonce() }}">
  {
    "@context": "https://schema.org",
    "@type": "ImageGallery",
    "name": {{ album.title|json_encode|raw }},
    {% if album.excerpt %}"about": {{ album.excerpt|striptags|json_encode|raw }},{% endif %}
    "url": {{ (canonical_url|default(current_url))|json_encode|raw }},
    "image": [
      {% for image in images|slice(0,10) %}
        {% set src = image.fallback_src|default(image.url) %}
        {% if src starts with 'http' %}
          {{ src|json_encode|raw }}
        {% else %}
          {{ ((canonical_base|default('')) ~ (src starts with '/' ? src : '/' ~ src))|json_encode|raw }}
        {% endif %}{% if not loop.last %},{% endif %}
      {% endfor %}
    ]
  }
  </script>
  <script type="application/ld+json" nonce="{{ csp_nonce() }}">
  {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      {"@type":"ListItem","position":1,"name":"Home","item": {{ (canonical_base|default('') ~ '/')|json_encode|raw }} }{% if album.category is defined and album.category.slug is defined %},
      {"@type":"ListItem","position":2,"name": {{ album.category.name|json_encode|raw }}, "item": {{ (canonical_base|default('') ~ '/category/' ~ album.category.slug)|json_encode|raw }} },
      {"@type":"ListItem","position":3,"name": {{ album.title|json_encode|raw }}, "item": {{ (canonical_url|default(current_url))|json_encode|raw }} }
      {% else %},
      {"@type":"ListItem","position":2,"name": {{ album.title|json_encode|raw }}, "item": {{ (canonical_url|default(current_url))|json_encode|raw }} }
      {% endif %}
    ]
  }
  </script>
{% endblock %}

{% block styles %}
  {{ parent() }}
{% endblock %}

{% block scripts %}
  {{ parent() }}
  <script nonce="{{ csp_nonce() }}" type="module" src="{{ base_path }}/assets/js/hero.js"></script>
{% endblock %}
