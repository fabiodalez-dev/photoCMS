{# Load @masonry-grid/vanilla as ES module and expose globally #}
{% if layout == 'masonry' and tpl_slug != 'masonry-portfolio' %}
<script type="module" nonce="{{ csp_nonce() }}">
import { BalancedMasonryGrid, RegularMasonryGrid } from '{{ base_path }}/assets/vendor/masonry-grid/index.js';
window.BalancedMasonryGrid = BalancedMasonryGrid;
window.RegularMasonryGrid = RegularMasonryGrid;
window._masonryGridReady = true; // Flag for sync check
// Dispatch event when library is ready
window.dispatchEvent(new CustomEvent('masonry-grid-ready'));
if (window.DEBUG_GALLERY) {
    console.log('masonry-grid module loaded and exposed globally');
}
</script>
{% endif %}
<script nonce="{{ csp_nonce() }}">
// Global base path for API calls
window.basePath = '{{ base_path }}';
window.DEBUG_GALLERY = false;

// Template settings (also expose globally for template switcher)
const templateSettings = {{ template_settings ? template_settings|json_encode|raw : '{}' }};
window.templateSettings = templateSettings;
const layout = templateSettings.layout || 'grid';
const templateSlug = templateSettings.template_slug || '';
const DEBUG_GALLERY = window.DEBUG_GALLERY === true;
const debugLog = (...args) => { if (DEBUG_GALLERY) console.log(...args); };
const debugWarn = (...args) => { if (DEBUG_GALLERY) console.warn(...args); };

/**
 * Masonry Portfolio initialization using Masonry + imagesLoaded
 */
function initMasonryPortfolio(containerOrSelector) {
    const grid = typeof containerOrSelector === 'string'
        ? document.querySelector(containerOrSelector)
        : containerOrSelector || document.querySelector('.masonry-portfolio-grid');

    if (!grid || typeof Masonry === 'undefined' || typeof imagesLoaded === 'undefined') return null;
    if (grid._masonryPortfolioInitialized) return grid._masonryPortfolioInstance;

    const gapH = parseInt(grid.dataset.gapH || '16', 10);
    const mpType = (window.templateSettings?.masonry_portfolio?.type || 'balanced');
    const horizontalOrder = mpType === 'regular';

    if (grid._masonryPortfolioInstance) {
        grid._masonryPortfolioInstance.destroy();
        grid._masonryPortfolioInstance = null;
    }

    grid._masonryPortfolioInitialized = true;
    grid._masonryPortfolioInstance = new Masonry(grid, {
        itemSelector: '.photo-item',
        columnWidth: '.grid-sizer',
        gutter: gapH,
        percentPosition: true,
        horizontalOrder: horizontalOrder,
        transitionDuration: '0.3s'
    });

    imagesLoaded(grid).on('progress', function(instance, image) {
        const img = image.img || null;
        if (img) {
            img.classList.add('is-loaded');
            const item = img.closest('.photo-item');
            if (item) item.classList.add('is-loaded');
        }
        grid._masonryPortfolioInstance.layout();
    });

    if (!grid._masonryPortfolioResizeHandler) {
        grid._masonryPortfolioResizeHandler = function() {
            clearTimeout(grid._masonryPortfolioResizeTimer);
            grid._masonryPortfolioResizeTimer = setTimeout(() => {
                if (grid._masonryPortfolioInstance) {
                    grid._masonryPortfolioInstance.layout();
                }
            }, 200);
        };
        window.addEventListener('resize', grid._masonryPortfolioResizeHandler);
    }

    return grid._masonryPortfolioInstance;
}

window.initMasonryPortfolio = initMasonryPortfolio;

function initCreativeLayout(containerOrSelector) {
    const container = typeof containerOrSelector === 'string'
        ? document.querySelector(containerOrSelector)
        : containerOrSelector || document.querySelector('.creative-gallery');

    if (!container) return;
    const images = container.querySelectorAll('img');
    images.forEach((img) => {
        if (img.complete) {
            img.classList.add('loaded');
            const loading = img.closest('.img-container')?.querySelector('.loading');
            if (loading) loading.remove();
        } else {
            img.addEventListener('load', function() {
                img.classList.add('loaded');
                const loading = img.closest('.img-container')?.querySelector('.loading');
                if (loading) loading.remove();
            }, { once: true });
        }
    });

    if (!container._creativeHoverBound) {
        container._creativeHoverBound = true;
        document.addEventListener('mousemove', function(e) {
            const hovers = container.querySelectorAll('.img-content-hover');
            hovers.forEach(function(element) {
                if (element.style.display === 'block' || window.getComputedStyle(element).display === 'block') {
                    const x = e.pageX + 20;
                    const y = e.pageY + 20;
                    element.style.transform = `translate3d(${x}px, ${y}px, 0)`;
                }
            });
        });
    }
}

window.initCreativeLayout = initCreativeLayout;

function initGalleryWallScroll(containerOrSelector) {
    const container = typeof containerOrSelector === 'string'
        ? document.querySelector(containerOrSelector)
        : containerOrSelector || document.querySelector('.gallery-wall');

    if (!container) return;

    document.body.classList.add('gallery-wall-page');

    const section = container.querySelector('#galleryWallSection') || container.querySelector('.gallery-wall-section');
    const track = container.querySelector('#galleryWallTrack') || container.querySelector('.gallery-wall-track');
    if (!section || !track) return;

    if (container._wallScrollCleanup) {
        container._wallScrollCleanup();
    }

    let maxScroll = 0;
    const isMobile = () => window.matchMedia('(max-width: 768px)').matches;

    function updateMetrics() {
        const trackWidth = track.scrollWidth;
        const windowWidth = window.innerWidth;
        const windowHeight = window.innerHeight;
        maxScroll = Math.max(0, trackWidth - windowWidth);
        const sectionHeight = maxScroll + windowHeight;
        section.style.height = sectionHeight + 'px';
    }

    function updateTrack() {
        if (isMobile()) {
            track.style.transform = 'translateX(0px)';
            return;
        }
        const rect = section.getBoundingClientRect();
        const sectionScrollHeight = section.offsetHeight - window.innerHeight;
        const scrollInSection = Math.max(0, -rect.top);
        const progress = sectionScrollHeight > 0 ? Math.min(1, scrollInSection / sectionScrollHeight) : 0;
        track.style.transform = `translateX(${-progress * maxScroll}px)`;
    }

    const onScroll = () => requestAnimationFrame(updateTrack);
    const onResize = () => {
        updateMetrics();
        updateTrack();
        if (window.lenisResize) setTimeout(window.lenisResize, 100);
    };
    let dragActive = false;
    let dragStartX = 0;
    let dragStartScroll = 0;
    let dragSectionStart = 0;
    const startDrag = (clientX) => {
        if (isMobile() || maxScroll === 0) return;
        dragActive = true;
        dragStartX = clientX;
        dragSectionStart = window.scrollY + section.getBoundingClientRect().top;
        dragStartScroll = Math.max(0, window.scrollY - dragSectionStart);
        section.style.cursor = 'grabbing';
    };
    const moveDrag = (clientX, evt) => {
        if (!dragActive || isMobile() || maxScroll === 0) return;
        const dx = clientX - dragStartX;
        const nextScroll = Math.max(0, Math.min(maxScroll, dragStartScroll - dx));
        if (nextScroll !== dragStartScroll) {
            if (evt) evt.preventDefault();
            window.scrollTo({ top: dragSectionStart + nextScroll, left: 0, behavior: 'auto' });
            updateTrack();
        }
    };
    const endDrag = () => {
        if (!dragActive) return;
        dragActive = false;
        section.style.cursor = '';
    };
    const onMouseDown = (e) => {
        if (e.button !== 0) return;
        startDrag(e.clientX);
    };
    const onMouseMove = (e) => {
        if (!dragActive) return;
        moveDrag(e.clientX, e);
    };
    const onMouseUp = () => endDrag();
    const onTouchStart = (e) => {
        if (!e.touches || e.touches.length !== 1) return;
        startDrag(e.touches[0].clientX);
    };
    const onTouchMove = (e) => {
        if (!e.touches || e.touches.length !== 1) return;
        moveDrag(e.touches[0].clientX, e);
    };
    const onTouchEnd = () => endDrag();

    updateMetrics();
    updateTrack();
    window.addEventListener('scroll', onScroll, { passive: true });
    window.addEventListener('resize', onResize);
    section.addEventListener('mousedown', onMouseDown);
    section.addEventListener('mousemove', onMouseMove);
    window.addEventListener('mouseup', onMouseUp);
    section.addEventListener('touchstart', onTouchStart, { passive: true });
    section.addEventListener('touchmove', onTouchMove, { passive: false });
    section.addEventListener('touchend', onTouchEnd);
    section.addEventListener('touchcancel', onTouchEnd);

    container._wallScrollCleanup = () => {
        window.removeEventListener('scroll', onScroll);
        window.removeEventListener('resize', onResize);
        section.removeEventListener('mousedown', onMouseDown);
        section.removeEventListener('mousemove', onMouseMove);
        window.removeEventListener('mouseup', onMouseUp);
        section.removeEventListener('touchstart', onTouchStart);
        section.removeEventListener('touchmove', onTouchMove);
        section.removeEventListener('touchend', onTouchEnd);
        section.removeEventListener('touchcancel', onTouchEnd);
    };
}

window.initGalleryWallScroll = initGalleryWallScroll;

/**
 * Modern Masonry initialization using @masonry-grid/vanilla
 * Uses CSS Grid + percentage-based transforms for efficient layout
 * No pixel calculations needed - browser handles responsiveness natively
 */
function initGalleryMasonry(containerOrSelector) {
    const grid = typeof containerOrSelector === 'string'
        ? document.querySelector(containerOrSelector)
        : containerOrSelector || document.querySelector('.gallery-masonry');

    if (!grid) {
        debugWarn('Masonry: No grid container found');
        return null;
    }
    if (grid._masonryInitialized) return grid._masonryInstance;

    // Check if masonry classes are available
    if (typeof BalancedMasonryGrid === 'undefined' && typeof RegularMasonryGrid === 'undefined') {
        debugWarn('Masonry library not loaded, using CSS Grid fallback');
        grid.classList.add('masonry-ready');
        return null;
    }

    // Determine which masonry class to use based on settings
    const masonryType = window.templateSettings?.masonry?.type || 'balanced';
    const MasonryClass = masonryType === 'regular' ? RegularMasonryGrid : BalancedMasonryGrid;
    const className = masonryType === 'regular' ? 'RegularMasonryGrid' : 'BalancedMasonryGrid';

    debugLog(`Masonry: Using ${className} on grid with ${grid.children.length} children`);

    // Debug: Check item dimensions
    const items = grid.querySelectorAll('.masonry-frame');
    debugLog(`Masonry: Found ${items.length} .masonry-frame items`);
    if (items.length > 0) {
        const firstItem = items[0];
        const rect = firstItem.getBoundingClientRect();
        const style = getComputedStyle(firstItem);
        debugLog(`Masonry: First item dimensions: ${rect.width}x${rect.height}, aspect-ratio: ${style.aspectRatio}`);
    }

    grid._masonryInitialized = true;

    // Destroy existing instance if any
    if (grid._masonryInstance) {
        grid._masonryInstance.destroy();
        grid._masonryInstance = null;
    }

    // Create masonry instance
    try {
        grid._masonryInstance = new MasonryClass(grid);
        debugLog(`Masonry: ${className} instance created successfully`);

        // Debug: Check if transforms are applied after a short delay
        setTimeout(() => {
            const transformedItems = Array.from(items).filter(item => item.style.transform);
            debugLog(`Masonry: ${transformedItems.length}/${items.length} items have transforms`);
            if (transformedItems.length > 0) {
                debugLog('Masonry: First transform:', transformedItems[0].style.transform);
            }
        }, 100);
    } catch (e) {
        console.error(`Masonry: Failed to create ${className}:`, e);
        grid.classList.add('masonry-ready');
        return null;
    }

    // Show the grid with smooth fade-in
    requestAnimationFrame(() => {
        grid.classList.add('masonry-ready');
        if (window.lenisResize) setTimeout(window.lenisResize, 100);
    });

    return grid._masonryInstance;
}

// Make initGalleryMasonry globally available for template switcher
window.initGalleryMasonry = initGalleryMasonry;

// Dense Grid is now CSS-only - no JavaScript initialization needed
// Classes (.wide, .tall, .big) are calculated server-side in Twig

/**
 * Cleanup function - destroys all layout instances before reinitializing
 */
function cleanupGalleryInstances() {
    // Destroy masonry-grid instance
    const masonryGrid = document.querySelector('.gallery-masonry');
    if (masonryGrid && masonryGrid._masonryInstance) {
        try {
            masonryGrid._masonryInstance.destroy();
        } catch(e) {}
        masonryGrid._masonryInstance = null;
        masonryGrid._masonryInitialized = false;
    }

    // Destroy masonry-portfolio instance
    const portfolioGrid = document.querySelector('.masonry-portfolio-grid');
    if (portfolioGrid && portfolioGrid._masonryPortfolioInstance) {
        try {
            portfolioGrid._masonryPortfolioInstance.destroy();
        } catch(e) {}
        portfolioGrid._masonryPortfolioInstance = null;
        portfolioGrid._masonryPortfolioInitialized = false;
        if (portfolioGrid._masonryPortfolioResizeHandler) {
            window.removeEventListener('resize', portfolioGrid._masonryPortfolioResizeHandler);
            portfolioGrid._masonryPortfolioResizeHandler = null;
        }
    }

    // Dense grid is CSS-only, no cleanup needed

    // Cleanup gallery wall scroll handlers
    const wallContainer = document.querySelector('.gallery-wall');
    if (wallContainer && wallContainer._wallScrollCleanup) {
        wallContainer._wallScrollCleanup();
        wallContainer._wallScrollCleanup = null;
    }

    // Remove dynamic styles
    document.querySelectorAll('[id$="-dynamic-style"]').forEach(el => el.remove());
}

// Make cleanup globally available
window.cleanupGalleryInstances = cleanupGalleryInstances;

// Initialize layout on page load
if (templateSlug === 'grid-ampia') {
    if (document.readyState === 'complete') {
        initCreativeLayout();
    } else {
        window.addEventListener('load', () => initCreativeLayout());
    }
} else if (templateSlug === 'gallery-wall-scroll') {
    if (document.readyState === 'complete') {
        initGalleryWallScroll();
    } else {
        window.addEventListener('load', () => initGalleryWallScroll());
    }
} else if (templateSlug === 'masonry-portfolio') {
    if (document.readyState === 'complete') {
        initMasonryPortfolio();
    } else {
        window.addEventListener('load', () => initMasonryPortfolio());
    }
} else if (layout === 'masonry') {
    // Wait for ES module to load and expose BalancedMasonryGrid
    function tryInitMasonry() {
        if (typeof BalancedMasonryGrid !== 'undefined') {
            debugLog('BalancedMasonryGrid available, initializing masonry');
            initGalleryMasonry();
        } else if (window._masonryGridReady) {
            // Module fired event but we missed it, try again
            debugLog('Module ready flag set, retrying...');
            setTimeout(tryInitMasonry, 10);
        } else {
            // Library not ready yet, wait for the event
            debugLog('Waiting for masonry-grid module...');
            window.addEventListener('masonry-grid-ready', () => {
                debugLog('masonry-grid-ready event received');
                initGalleryMasonry();
            }, { once: true });
        }
    }
    if (document.readyState === 'complete') {
        tryInitMasonry();
    } else {
        window.addEventListener('load', tryInitMasonry);
    }
}
// dense_grid is CSS-only, no JS initialization needed

// Magazine Split autoscroll initializer
function initMagazineAutoscroll() {
    try {
        var container = document.getElementById('images-gallery') || document;
        var isMobile = window.matchMedia('(max-width: 767px)').matches;
        var isTablet = window.matchMedia('(min-width: 768px) and (max-width: 1199px)').matches;
        var isDesktop = window.matchMedia('(min-width: 1200px)').matches;

        var mob = container.querySelector('.m-mobile-wrap');
        var tablet = container.querySelector('.m-tablet-wrap');
        var desk = container.querySelector('.m-desktop-wrap');

        if (mob) mob.style.display = isMobile ? 'block' : 'none';
        if (tablet) tablet.style.display = isTablet ? 'flex' : 'none';
        if (desk) desk.style.display = isDesktop ? 'flex' : 'none';

        var trackOriginals = new WeakMap();
        var ensureTrackFill = function(track, colHeight) {
            if (!track || !colHeight) return;
            var originals = trackOriginals.get(track);
            if (!originals) {
                originals = Array.from(track.children);
                trackOriginals.set(track, originals);
            }
            if (!originals.length) return;
            var minHeight = colHeight * 2;
            var loops = 0;
            while (track.scrollHeight < minHeight && loops < 12) {
                var frag = document.createDocumentFragment();
                originals.forEach(function(node) {
                    var clone = node.cloneNode(true);
                    var link = clone.querySelector && clone.querySelector('a.pswp-link');
                    if (link) link.classList.add('pswp-is-duplicate');
                    frag.appendChild(clone);
                });
                track.appendChild(frag);
                loops += 1;
            }
        };
        var forceEager = function(scope) {
            if (!scope) return;
            scope.querySelectorAll('img[loading="lazy"]').forEach(function(img) {
                img.setAttribute('loading', 'eager');
            });
        };

        var activeWrap = isMobile ? mob : (isTablet ? tablet : desk);
        if (activeWrap) {
            activeWrap.querySelectorAll('source[data-srcset]').forEach(function(source) {
                source.setAttribute('srcset', source.getAttribute('data-srcset'));
                source.removeAttribute('data-srcset');
            });
            activeWrap.querySelectorAll('img[data-src]').forEach(function(img) {
                img.setAttribute('src', img.getAttribute('data-src'));
                img.removeAttribute('data-src');
            });
        }

        container.querySelectorAll('.m-col').forEach(function(col) {
            var track = col.querySelector('.m-track'); if (!track) return;
            ensureTrackFill(track, col.clientHeight || window.innerHeight);
            forceEager(track);
            track.style.animation = 'none';
            track.offsetHeight;
            var dir = (col.getAttribute('data-direction') || 'down').toLowerCase();
            var dur = (getComputedStyle(col).getPropertyValue('--m-duration') || '60s').trim() || '60s';
            var anim = (dir === 'up' ? 'mScrollUp' : 'mScrollDown') + ' ' + dur + ' linear infinite';
            track.style.transform = dir === 'up' ? 'translateY(-50%)' : 'translateY(0)';
            track.style.animation = anim;
            track.style.animationPlayState = '';
        });

        var mobileTrack = container.querySelector('.m-mobile-track');
        if (mobileTrack) {
            var mobWrap = mobileTrack.closest('.m-mobile') || mobileTrack.parentElement;
            ensureTrackFill(mobileTrack, (mobWrap && mobWrap.clientHeight) || window.innerHeight);
            forceEager(mobileTrack);
        }
        var rerun = function() {
            container.querySelectorAll('.m-col').forEach(function(col) {
                var track = col.querySelector('.m-track'); if (!track) return;
                ensureTrackFill(track, col.clientHeight || window.innerHeight);
            });
            var mobTrack = container.querySelector('.m-mobile-track');
            if (mobTrack) {
                var wrap = mobTrack.closest('.m-mobile') || mobTrack.parentElement;
                ensureTrackFill(mobTrack, (wrap && wrap.clientHeight) || window.innerHeight);
            }
        };
        setTimeout(rerun, 200);
        setTimeout(rerun, 800);

        if (!container._magazineDragBound) {
            container._magazineDragBound = true;
            var dragState = { active: false, moved: false, startX: 0, startY: 0, startScroll: 0, sectionTop: 0, col: null };
            var startDrag = function(clientX, clientY, target) {
                dragState.active = true;
                dragState.moved = false;
                dragState.col = target;
                dragState.sectionTop = container.getBoundingClientRect().top + window.scrollY;
                dragState.startX = clientX;
                dragState.startY = clientY;
                dragState.startScroll = window.scrollY;
                target.style.cursor = 'grabbing';
            };
            var moveDrag = function(clientX, clientY, ev) {
                if (!dragState.active) return;
                var dx = clientX - dragState.startX;
                var dy = clientY - dragState.startY;
                if (Math.abs(dy) > Math.abs(dx)) return;
                if (Math.abs(dx) <= 8) return;
                if (!dragState.moved) {
                    dragState.moved = true;
                    document.body.classList.add('magazine-dragging');
                }
                if (ev) ev.preventDefault();
                var nextTop = dragState.startScroll - dx;
                var maxTop = dragState.sectionTop + Math.max(0, container.offsetHeight - window.innerHeight);
                if (nextTop < dragState.sectionTop) nextTop = dragState.sectionTop;
                if (nextTop > maxTop) nextTop = maxTop;
                window.scrollTo({ top: nextTop, left: 0, behavior: 'auto' });
            };
            var endDrag = function() {
                if (!dragState.active) return;
                dragState.active = false;
                if (dragState.col) dragState.col.style.cursor = '';
                dragState.col = null;
                document.body.classList.remove('magazine-dragging');
                if (dragState.moved) {
                    var guard = function(clickEv) {
                        if (container.contains(clickEv.target)) {
                            clickEv.preventDefault();
                            clickEv.stopPropagation();
                        }
                        container.removeEventListener('click', guard, true);
                    };
                    container.addEventListener('click', guard, true);
                }
            };
            var onMouseDown = function(ev) {
                if (ev.button !== 0) return;
                var target = ev.target.closest ? ev.target.closest('.m-col') : null;
                if (!target) return;
                ev.preventDefault();
                startDrag(ev.clientX, ev.clientY, target);
            };
            var onMouseMove = function(ev) { moveDrag(ev.clientX, ev.clientY, ev); };
            var onMouseUp = function() { endDrag(); };
            var onTouchStart = function(ev) {
                if (!ev.touches || ev.touches.length !== 1) return;
                var target = ev.target.closest ? ev.target.closest('.m-col') : null;
                if (!target) return;
                startDrag(ev.touches[0].clientX, ev.touches[0].clientY, target);
            };
            var onTouchMove = function(ev) {
                if (!ev.touches || ev.touches.length !== 1) return;
                moveDrag(ev.touches[0].clientX, ev.touches[0].clientY, ev);
            };
            var onTouchEnd = function() { endDrag(); };
            var onDragStart = function(ev) { ev.preventDefault(); };
            var onWindowBlur = function() { endDrag(); };
            var onVisibility = function() { if (document.hidden) endDrag(); };
            container.addEventListener('mousedown', onMouseDown);
            window.addEventListener('mousemove', onMouseMove);
            window.addEventListener('mouseup', onMouseUp);
            container.addEventListener('touchstart', onTouchStart, { passive: true });
            window.addEventListener('touchmove', onTouchMove, { passive: false });
            window.addEventListener('touchend', onTouchEnd);
            window.addEventListener('touchcancel', onTouchEnd);
            container.addEventListener('dragstart', onDragStart);
            window.addEventListener('blur', onWindowBlur);
            document.addEventListener('visibilitychange', onVisibility);
            container._magazineDragCleanup = function() {
                container.removeEventListener('mousedown', onMouseDown);
                window.removeEventListener('mousemove', onMouseMove);
                window.removeEventListener('mouseup', onMouseUp);
                container.removeEventListener('touchstart', onTouchStart);
                window.removeEventListener('touchmove', onTouchMove);
                window.removeEventListener('touchend', onTouchEnd);
                window.removeEventListener('touchcancel', onTouchEnd);
                container.removeEventListener('dragstart', onDragStart);
                window.removeEventListener('blur', onWindowBlur);
                document.removeEventListener('visibilitychange', onVisibility);
            };
        }
    } catch(e) {
        console.error('initMagazineAutoscroll error:', e);
    }
}

// Initialize magazine if active
if (layout === 'magazine') {
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(initMagazineAutoscroll, 100);
    });
}

// Template switcher - aggressive reinitialization handler
function loadTemplateAssets(assets) {
    if (!assets) return;
    const cssList = Array.isArray(assets.css) ? assets.css : [];
    const jsList = Array.isArray(assets.js) ? assets.js : [];
    const basePath = (window.basePath || '').replace(/\/$/, '');
    const allowedPrefix = `${basePath}/plugins/custom-templates-pro/`;
    const cspNonce = document.querySelector('script[nonce]')?.getAttribute('nonce');
    const isValidAssetPath = (path) => {
        try {
            const url = new URL(path, window.location.origin);
            const normalized = url.pathname;
            if (normalized.includes('/../')) return false;
            if (normalized.startsWith('/plugins/custom-templates-pro/')) return true;
            if (basePath && normalized.startsWith(`${basePath}/plugins/custom-templates-pro/`)) return true;
            return false;
        } catch {
            return false;
        }
    };

    document.querySelectorAll('[data-template-asset]').forEach((node) => {
        node.parentNode?.removeChild(node);
    });

    cssList.forEach(href => {
        if (!href || document.querySelector(`link[data-template-asset="${href}"]`)) return;
        if (!isValidAssetPath(href) || (!href.startsWith(allowedPrefix) && !href.startsWith('/plugins/custom-templates-pro/'))) {
            debugWarn('Asset CSS blocked: invalid path', href);
            return;
        }
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = href;
        link.setAttribute('data-template-asset', href);
        link.onerror = () => console.error('Errore caricamento CSS:', href);
        document.head.appendChild(link);
    });

    jsList.forEach(src => {
        if (!src || document.querySelector(`script[data-template-asset="${src}"]`)) return;
        if (!isValidAssetPath(src) || (!src.startsWith(allowedPrefix) && !src.startsWith('/plugins/custom-templates-pro/'))) {
            debugWarn('Asset JS blocked: invalid path', src);
            return;
        }
        const script = document.createElement('script');
        script.src = src;
        script.defer = true;
        if (cspNonce) script.setAttribute('nonce', cspNonce);
        script.setAttribute('data-template-asset', src);
        script.onerror = () => console.error('Errore caricamento JS:', src);
        document.body.appendChild(script);
    });
}

document.addEventListener('click', function(event) {
    const el = event.target.closest('.tpl-switch');
    if (!el) return;
    if (el.tagName === 'A') event.preventDefault();
    if (el.dataset.switchInProgress === '1') return;
    el.dataset.switchInProgress = '1';

    const galleryContainer = document.getElementById('images-gallery');
    const scrollY = window.scrollY;
    const templateId = el.getAttribute('data-template-id');
    const albumRef = el.getAttribute('data-album-ref') || window.location.pathname.split('/').pop();
    if (!galleryContainer || !templateId || !albumRef) {
        delete el.dataset.switchInProgress;
        return;
    }

    // STEP 1: Full cleanup before switching
    if (typeof cleanupGalleryInstances === 'function') {
        cleanupGalleryInstances();
    }

    const originalContent = galleryContainer.innerHTML;
    const originalClasses = galleryContainer.className;

    // Smooth transition while switching templates
    galleryContainer.classList.add('tpl-switching');

    // Update button states immediately
    document.querySelectorAll('.tpl-switch').forEach(btn => {
        btn.classList.remove('bg-black', 'text-white');
        btn.classList.add('text-neutral-700', 'hover:bg-neutral-100');
    });
    el.classList.remove('text-neutral-700', 'hover:bg-neutral-100');
    el.classList.add('bg-black', 'text-white');

    const fetchUrl = `${window.basePath}/api/gallery/template?album=${encodeURIComponent(albumRef)}&template=${encodeURIComponent(templateId)}`;

    fetch(fetchUrl, { headers: { 'Accept': 'text/html', 'X-Requested-With': 'XMLHttpRequest' } })
        .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.text(); })
        .then(html => {
            // STEP 2: Parse settings and strip script tag from response HTML
            let parsedHtml = html;
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const settingsScript = doc.querySelector('script');
            if (settingsScript && settingsScript.textContent) {
                const match = settingsScript.textContent.match(/window\.templateSettings\s*=\s*(\{[\s\S]*?\});/);
                if (match) {
                    try {
                        window.templateSettings = JSON.parse(match[1]);
                    } catch(e) {
                        console.error('Failed to parse templateSettings:', e);
                        window.templateSettings = {};
                    }
                }
                const assetsMatch = settingsScript.textContent.match(/window\.templateAssets\s*=\s*(\{[\s\S]*?\});/);
                if (assetsMatch) {
                    try {
                        window.templateAssets = JSON.parse(assetsMatch[1]);
                    } catch (e) {
                        console.error('Failed to parse templateAssets:', e);
                        debugWarn('templateAssets JSON invalid, using default:', assetsMatch[1].substring(0, 100));
                        window.templateAssets = { css: [], js: [] };
                    }
                } else {
                    debugLog('templateAssets not found in response, using default');
                    window.templateAssets = { css: [], js: [] };
                }
                settingsScript.remove();
            }
            parsedHtml = doc.body ? doc.body.innerHTML : html;

            loadTemplateAssets(window.templateAssets);

            const rawLayout = window.templateSettings?.layout || 'grid';
            const templateSlug = window.templateSettings?.template_slug || '';
            const isCustomTemplate = window.templateSettings?.layout === 'custom';
            const newLayout = templateSlug === 'masonry-portfolio'
                ? 'masonry_portfolio'
                : (templateSlug === 'grid-ampia'
                    ? 'creative_layout'
                    : (templateSlug === 'gallery-wall-scroll'
                        ? 'gallery_wall'
                        : (rawLayout === 'masonry_fit' ? 'masonry' : rawLayout)));
            const cols = window.templateSettings?.columns || {desktop: 3, tablet: 2, mobile: 1};
            const gap = window.templateSettings?.gap || {horizontal: 16, vertical: 16};
            const dense = window.templateSettings?.dense_grid || {};

            // STEP 3: Remove all dynamic styles first
            document.querySelectorAll('[id$="-dynamic-style"]').forEach(s => s.remove());

            // STEP 4: Completely reset the container
            const containerId = galleryContainer.id;
            galleryContainer.className = '';
            galleryContainer.removeAttribute('style');
            galleryContainer.innerHTML = '';
            galleryContainer.classList.add('tpl-switching');

            // STEP 5: Inject new layout-specific styles
            const styleEl = document.createElement('style');
            styleEl.id = `gallery-${newLayout}-dynamic-style`;

            if (newLayout !== 'gallery_wall') {
                document.body.classList.remove('gallery-wall-page');
            }

            if (isCustomTemplate) {
                styleEl.textContent = '';
                galleryContainer.className = 'pswp-gallery';
                galleryContainer.setAttribute('data-layout', 'custom');
            } else if (newLayout === 'dense_grid') {
                const minCell = dense.minCellDesktop || 250;
                const rowHeight = dense.rowHeight || 200;
                const gridGap = dense.gap || 10;

                styleEl.textContent = `
                    .dense-grid { display: grid; grid-gap: ${gridGap}px; grid-template-columns: repeat(auto-fit, minmax(${minCell}px, 1fr)); grid-auto-rows: ${rowHeight}px; grid-auto-flow: dense; padding: ${gridGap}px; }
                    .dense-grid > div { display: flex; justify-content: center; align-items: center; position: relative; overflow: hidden; }
                    .dense-grid > div > a { display: block; width: 100%; height: 100%; }
                    .dense-grid > div > a > picture { display: block; width: 100%; height: 100%; }
                    .dense-grid > div > a > picture > img { width: 100%; height: 100%; object-fit: cover; border-radius: 5px; transition: transform 0.3s ease; }
                    .dense-grid > div:hover > a > picture > img { transform: scale(1.03); }
                    .dense-grid .wide { grid-column: span 2; }
                    .dense-grid .tall { grid-row: span 2; }
                    .dense-grid .big { grid-column: span 2; grid-row: span 2; }
                    @media (max-width: 640px) { .dense-grid { grid-template-columns: repeat(2, 1fr); grid-auto-rows: 150px; } .dense-grid .wide, .dense-grid .tall, .dense-grid .big { grid-column: span 1; grid-row: span 1; } }
                `;
                galleryContainer.className = 'dense-grid pswp-gallery';
                galleryContainer.setAttribute('data-layout', 'dense_grid');

            } else if (newLayout === 'magazine') {
                styleEl.textContent = ''; // Magazine has its own embedded styles
                galleryContainer.className = 'mt-6';
                galleryContainer.setAttribute('data-layout', 'magazine');

            } else if (newLayout === 'gallery_wall') {
                const wall = window.templateSettings?.gallery_wall || {};
                const wallDesktop = wall.desktop || {};
                const wallTablet = wall.tablet || {};
                const wallMobile = wall.mobile || {};
                const hRatio = wallDesktop.horizontal_ratio ?? 1.5;
                const vRatio = wallDesktop.vertical_ratio ?? 0.67;
                const hRatioT = wallTablet.horizontal_ratio ?? 1.3;
                const vRatioT = wallTablet.vertical_ratio ?? 0.6;
                const divider = wall.divider ?? 2;
                const mobileCols = wallMobile.columns ?? 2;
                const mobileGap = wallMobile.gap ?? 8;
                const mobileWideEvery = wallMobile.wide_every ?? 5;

                styleEl.textContent = `
                    .gallery-wall, .gallery-wall * { margin: 0; padding: 0; box-sizing: border-box; }
                    .gallery-wall-section { position: relative; }
                    .gallery-wall-container { position: sticky; top: var(--header-height, 80px); height: calc(100vh - var(--header-height, 80px)); display: flex; align-items: center; overflow: hidden; background: #ffffff; z-index: 10; }
                    html.dark .gallery-wall-container { background: #0a0a0a; }
                    .gallery-wall-track { display: flex; gap: 0; will-change: transform; }
                    .gallery-wall-item { flex-shrink: 0; height: calc(100vh - var(--header-height, 80px)); position: relative; }
                    .gallery-wall-item.horizontal { width: calc((100vh - var(--header-height, 80px)) * var(--wall-h-ratio, 1.5)); }
                    .gallery-wall-item.vertical { width: calc((100vh - var(--header-height, 80px)) * var(--wall-v-ratio, 0.67)); }
                    .gallery-wall-item a { display: block; width: 100%; height: 100%; }
                    .gallery-wall-item picture, .gallery-wall-item img { width: 100%; height: 100%; object-fit: cover; display: block; }
                    .gallery-wall-item::after { content: ''; position: absolute; right: 0; top: 0; bottom: 0; width: var(--wall-divider, 2px); background: #fff; }
                    html.dark .gallery-wall-item::after { background: #171717; }
                    .gallery-wall-overlay { position: absolute; bottom: 0; left: 0; right: 0; padding: 1.5rem; background: linear-gradient(transparent, rgba(0,0,0,0.7)); color: white; opacity: 0; transition: opacity 0.3s ease; }
                    .gallery-wall-item:hover .gallery-wall-overlay { opacity: 1; }
                    .gallery-wall-overlay h3 { font-size: 1rem; font-weight: 500; margin: 0 0 0.25rem 0; }
                    .gallery-wall-overlay p { font-size: 0.85rem; opacity: 0.8; margin: 0; }
                    .gallery-mobile-grid { display: none; }
                    @media (max-width: 1024px) {
                        .gallery-wall-item.horizontal { width: calc((100vh - var(--header-height, 80px)) * var(--wall-h-ratio-tablet, 1.3)); }
                        .gallery-wall-item.vertical { width: calc((100vh - var(--header-height, 80px)) * var(--wall-v-ratio-tablet, 0.6)); }
                    }
                    @media (max-width: 768px) {
                        .gallery-wall-section { display: none; }
                        .gallery-mobile-grid { display: block; padding: var(--wall-mobile-gap, 8px); }
                        .gallery-mobile-grid-inner { display: grid; grid-template-columns: repeat(var(--wall-mobile-cols, 2), minmax(0, 1fr)); gap: var(--wall-mobile-gap, 8px); }
                        .gallery-mobile-item { aspect-ratio: 1; overflow: hidden; position: relative; background: #f5f5f5; }
                        .gallery-mobile-item.wide { grid-column: span 2; aspect-ratio: 16/9; }
                        .gallery-mobile-item a, .gallery-mobile-item picture, .gallery-mobile-item img { display: block; width: 100%; height: 100%; object-fit: cover; }
                    }
                    @media (max-width: 480px) { .gallery-mobile-grid { padding: 0.5rem; } }
                `;
                galleryContainer.className = 'gallery-wall pswp-gallery';
                galleryContainer.setAttribute('data-layout', 'gallery_wall');
                galleryContainer.setAttribute('data-wall-init', '1');
                galleryContainer.style.setProperty('--wall-h-ratio', hRatio);
                galleryContainer.style.setProperty('--wall-v-ratio', vRatio);
                galleryContainer.style.setProperty('--wall-h-ratio-tablet', hRatioT);
                galleryContainer.style.setProperty('--wall-v-ratio-tablet', vRatioT);
                galleryContainer.style.setProperty('--wall-divider', `${divider}px`);
                galleryContainer.style.setProperty('--wall-mobile-cols', mobileCols);
                galleryContainer.style.setProperty('--wall-mobile-gap', `${mobileGap}px`);
                galleryContainer.style.setProperty('--wall-mobile-wide-every', mobileWideEvery);

            } else if (newLayout === 'masonry_portfolio') {
                const mp = window.templateSettings?.masonry_portfolio || {};
                const mpCols = mp.columns || window.templateSettings?.columns || {desktop: 4, tablet: 3, mobile: 1};
                const mpGapH = mp.gap_h ?? window.templateSettings?.gap?.horizontal ?? 16;
                const mpGapV = mp.gap_v ?? window.templateSettings?.gap?.vertical ?? 16;
                const layoutMode = mp.layout_mode || 'fullwidth';
                const mpStyle = window.templateSettings?.style || {};
                const d = Math.round(mpCols.desktop || 4);
                const t = Math.round(mpCols.tablet || 3);
                const m = Math.round(mpCols.mobile || 1);

                styleEl.textContent = `
                    .masonry-portfolio-grid { --mp-gap-h: ${mpGapH}px; --mp-gap-v: ${mpGapV}px; --mp-cols-desktop: ${d}; --mp-cols-tablet: ${t}; --mp-cols-mobile: ${m}; width: 100%; margin: 0 auto; position: relative; }
                    .masonry-portfolio-grid.is-boxed { max-width: 1400px; padding: 0 20px; }
                    .masonry-portfolio-grid .grid-sizer,
                    .masonry-portfolio-grid .photo-item { width: calc((100% - (var(--mp-cols-mobile) - 1) * var(--mp-gap-h)) / var(--mp-cols-mobile)); }
                    .masonry-portfolio-grid .photo-item.landscape { width: calc((2 * ((100% - (var(--mp-cols-mobile) - 1) * var(--mp-gap-h)) / var(--mp-cols-mobile))) + var(--mp-gap-h)); }
                    .masonry-portfolio-grid .photo-item { position: relative; margin-bottom: var(--mp-gap-v); background: #f5f5f5; overflow: hidden; cursor: pointer; transition: opacity 0.3s ease, box-shadow 0.3s ease; opacity: 0; }
                    .masonry-portfolio-grid .photo-item.is-loaded { opacity: 1; }
                    .masonry-portfolio-grid[data-rounded=\"1\"] .photo-item,
                    .masonry-portfolio-grid[data-rounded=\"1\"] .photo-item img { border-radius: 12px; }
                    .masonry-portfolio-grid[data-shadow=\"1\"] .photo-item { box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); }
                    .masonry-portfolio-grid[data-hover-scale=\"1\"] .photo-item:hover { box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15); z-index: 2; }
                    .masonry-portfolio-grid .photo-item img { display: block; width: 100%; height: auto; opacity: 0; transform: scale(1); transition: opacity 0.3s ease, transform 0.3s ease; }
                    .masonry-portfolio-grid[data-hover-scale=\"1\"] .photo-item:hover img { transform: scale(1.02); }
                    .masonry-portfolio-grid .photo-item.is-loaded img { opacity: 1; }
                    .masonry-portfolio-grid .photo-loading { position: absolute; top: 50%; left: 50%; width: 36px; height: 36px; margin: -18px 0 0 -18px; border: 3px solid rgba(0, 0, 0, 0.1); border-top-color: #333; border-radius: 50%; animation: mp-spin 1s linear infinite; }
                    .masonry-portfolio-grid .photo-item.is-loaded .photo-loading { display: none; }
                    @keyframes mp-spin { to { transform: rotate(360deg); } }
                    @media (min-width: 768px) {
                        .masonry-portfolio-grid .grid-sizer,
                        .masonry-portfolio-grid .photo-item { width: calc((100% - (var(--mp-cols-tablet) - 1) * var(--mp-gap-h)) / var(--mp-cols-tablet)); }
                        .masonry-portfolio-grid .photo-item.landscape { width: calc((2 * ((100% - (var(--mp-cols-tablet) - 1) * var(--mp-gap-h)) / var(--mp-cols-tablet))) + var(--mp-gap-h)); }
                    }
                    @media (min-width: 1200px) {
                        .masonry-portfolio-grid .grid-sizer,
                        .masonry-portfolio-grid .photo-item { width: calc((100% - (var(--mp-cols-desktop) - 1) * var(--mp-gap-h)) / var(--mp-cols-desktop)); }
                        .masonry-portfolio-grid .photo-item.landscape { width: calc((2 * ((100% - (var(--mp-cols-desktop) - 1) * var(--mp-gap-h)) / var(--mp-cols-desktop))) + var(--mp-gap-h)); }
                    }
                    @media (max-width: 480px) {
                        .masonry-portfolio-grid.is-boxed { padding: 0 10px; }
                        .masonry-portfolio-grid[data-hover-scale=\"1\"] .photo-item:hover { box-shadow: none; }
                        .masonry-portfolio-grid[data-hover-scale=\"1\"] .photo-item:hover img { transform: scale(1); }
                    }
                `;

                galleryContainer.className = `masonry-portfolio-grid pswp-gallery${layoutMode === 'boxed' ? ' is-boxed' : ''}`;
                galleryContainer.setAttribute('data-layout', 'masonry_portfolio');
                galleryContainer.setAttribute('data-gap-h', mpGapH);
                galleryContainer.setAttribute('data-gap-v', mpGapV);
                galleryContainer.setAttribute('data-cols-desktop', d);
                galleryContainer.setAttribute('data-cols-tablet', t);
                galleryContainer.setAttribute('data-cols-mobile', m);
                galleryContainer.setAttribute('data-rounded', mpStyle.rounded ? '1' : '0');
                galleryContainer.setAttribute('data-shadow', mpStyle.shadow ? '1' : '0');
                galleryContainer.setAttribute('data-hover-scale', mpStyle.hover_scale === false ? '0' : '1');

            } else if (newLayout === 'creative_layout') {
                const creative = window.templateSettings?.creative_layout || {};
                const gap = Math.round(creative.gap ?? 15);
                const hoverTooltip = creative.hover_tooltip === false ? '0' : '1';
                const hoverScale = window.templateSettings?.style?.hover_scale === false ? '0' : '1';

                styleEl.textContent = `
                    .creative-gallery { padding: 0 0 4rem 0; }
                    .creative-gallery .photo-grid { display: flex; flex-wrap: wrap; gap: ${gap}px; }
                    .creative-gallery .img-container { position: relative; overflow: hidden; cursor: pointer; background: #f5f5f5; flex-shrink: 0; }
                    .creative-gallery .img-container img { width: 100%; height: 100%; object-fit: cover; transform: scale(1); transition: transform 0.3s ease-in-out, opacity 0.3s ease; display: block; opacity: 0; }
                    .creative-gallery[data-hover-scale=\"1\"] .img-container:hover img { transform: scale(1.05); }
                    .creative-gallery .img-container img.loaded { opacity: 1; }
                    .creative-gallery .img-content { display: none; }
                    .creative-gallery[data-hover-tooltip=\"1\"] .img-content-hover { z-index: 1000; position: fixed; pointer-events: none; white-space: nowrap; display: none; padding: 1rem; background: #fff; font-weight: 400; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }
                    .creative-gallery[data-hover-tooltip=\"1\"] .img-container:hover .img-content-hover { display: block; }
                    .creative-gallery .title { color: #2e2e2e; font-size: 1.5rem; font-weight: 700; margin: 0; }
                    .creative-gallery .category { font-size: 1rem; color: #787878; margin: 0; }
                    .creative-gallery .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 40px; height: 40px; border: 3px solid #e0e0e0; border-top-color: #333; border-radius: 50%; animation: creative-spin 1s linear infinite; }
                    @keyframes creative-spin { to { transform: translate(-50%, -50%) rotate(360deg); } }
                    .creative-gallery .w-25 { width: calc(25% - 12px); }
                    .creative-gallery .w-33 { width: calc(33.333% - 11px); }
                    .creative-gallery .w-50 { width: calc(50% - 8px); }
                    .creative-gallery .w-66 { width: calc(66.666% - 6px); }
                    .creative-gallery .w-100 { width: 100%; }
                    .creative-gallery .h-300 { height: 300px; }
                    .creative-gallery .h-400 { height: 400px; }
                    .creative-gallery .h-500 { height: 500px; }
                    .creative-gallery .h-600 { height: 600px; }
                    .creative-gallery .h-700 { height: 700px; }
                    @media (max-width: 768px) {
                        .creative-gallery .w-25 { width: calc(50% - 8px); }
                        .creative-gallery .w-33 { width: calc(50% - 8px); }
                        .creative-gallery .w-50 { width: calc(50% - 8px); }
                        .creative-gallery .w-66 { width: 100%; }
                        .creative-gallery .w-100 { width: 100%; }
                        .creative-gallery .h-600, .creative-gallery .h-700 { height: 500px; }
                    }
                    @media (max-width: 1024px) {
                        .creative-gallery[data-hover-scale=\"1\"] .img-container:hover img { transform: none; }
                        .creative-gallery[data-hover-tooltip=\"1\"] .img-container:hover .img-content-hover { display: none; }
                        .creative-gallery .img-content { display: block; padding: 1rem 0; }
                    }
                    @media (max-width: 480px) {
                        .creative-gallery .photo-grid { gap: 10px; }
                        .creative-gallery .w-25, .creative-gallery .w-33, .creative-gallery .w-50, .creative-gallery .w-66, .creative-gallery .w-100 { width: 100%; }
                        .creative-gallery .h-300, .creative-gallery .h-400, .creative-gallery .h-500, .creative-gallery .h-600, .creative-gallery .h-700 { height: 300px; }
                    }
                `;

                galleryContainer.className = 'creative-gallery pswp-gallery';
                galleryContainer.setAttribute('data-layout', 'creative_layout');
                galleryContainer.setAttribute('data-hover-tooltip', hoverTooltip);
                galleryContainer.setAttribute('data-hover-scale', hoverScale);
                galleryContainer.setAttribute('data-gap', String(gap));

            } else if (newLayout === 'masonry') {
                const gH = gap.horizontal || 16;
                const gV = gap.vertical || 16;
                const d = Math.round(cols.desktop || 3);
                const t = Math.round(cols.tablet || 2);
                const m = Math.round(cols.mobile || 1);

                // Using CSS variables and inset for gaps per @masonry-grid/vanilla docs
                // translateY% ignores margins, so we use inset on inner container instead
                styleEl.textContent = `
                    .gallery-masonry { --masonry-gap-v: ${gV}px; --masonry-gap-h: ${gH}px; display: grid; column-gap: var(--masonry-gap-h); grid-template-columns: repeat(${m}, 1fr); align-items: start; opacity: 0; transition: opacity 0.3s ease-in-out; }
                    .gallery-masonry.masonry-ready { opacity: 1; }
                    @media (min-width: 768px) { .gallery-masonry { grid-template-columns: repeat(${t}, 1fr); } }
                    @media (min-width: 1024px) { .gallery-masonry { grid-template-columns: repeat(${d}, 1fr); } }
                    .gallery-masonry .masonry-frame { position: relative; aspect-ratio: var(--width) / var(--height); min-width: 0; }
                    .gallery-masonry .masonry-frame > .frame-content { position: absolute; inset: calc(var(--masonry-gap-v) / 2) 0; overflow: hidden; }
                    .gallery-masonry .masonry-frame img { display: block; width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease; }
                    .gallery-masonry .masonry-frame:hover img { transform: scale(1.03); }
                `;
                galleryContainer.className = 'gallery-masonry pswp-gallery';
                galleryContainer.setAttribute('data-layout', 'masonry');
                galleryContainer.setAttribute('data-gap-h', gH);
                galleryContainer.setAttribute('data-gap-v', gV);
                galleryContainer.setAttribute('data-cols-desktop', d);
                galleryContainer.setAttribute('data-cols-tablet', t);
                galleryContainer.setAttribute('data-cols-mobile', m);

            } else {
                // Grid layout
                const d = Math.round(cols.desktop || 3);
                const t = Math.round(cols.tablet || 2);
                const m = Math.round(cols.mobile || 1);
                const gH = gap.horizontal || 16;
                const gV = gap.vertical || 16;

                styleEl.textContent = `
                    .gallery-grid { display: grid; gap: ${gV}px ${gH}px; }
                    @media (min-width: 1024px) { .gallery-grid { grid-template-columns: repeat(${d}, 1fr); } }
                    @media (min-width: 768px) and (max-width: 1023px) { .gallery-grid { grid-template-columns: repeat(${t}, 1fr); } }
                    @media (max-width: 767px) { .gallery-grid { grid-template-columns: repeat(${m}, 1fr); } }
                `;
                galleryContainer.className = 'gallery-grid pswp-gallery';
                galleryContainer.setAttribute('data-layout', 'grid');
                galleryContainer.setAttribute('data-gap-h', gH);
                galleryContainer.setAttribute('data-gap-v', gV);
                galleryContainer.setAttribute('data-cols-desktop', d);
                galleryContainer.setAttribute('data-cols-tablet', t);
                galleryContainer.setAttribute('data-cols-mobile', m);
            }

            // Set hover-fade attribute based on template style settings
            const hoverFade = window.templateSettings?.style?.hover_fade !== false ? '1' : '0';
            galleryContainer.setAttribute('data-hover-fade', hoverFade);
            galleryContainer.classList.add('tpl-switching');

            document.head.appendChild(styleEl);
            galleryContainer.id = containerId;

            // STEP 6: Inject the new HTML content
            galleryContainer.innerHTML = parsedHtml;

            // STEP 7: Update URL without scrolling
            const newUrl = `${window.basePath}/album/${albumRef}?template=${templateId}`;
            history.replaceState(null, '', newUrl);

            // STEP 8: Force layout recalculation
            galleryContainer.offsetHeight; // Force reflow

            // STEP 9: Initialize the new layout with aggressive timing
            requestAnimationFrame(() => {
                // Re-initialize lightbox first
                if (typeof initLightbox === 'function') {
                    try { initLightbox(); } catch(e) {}
                }

                // Initialize layout-specific code (dense_grid is CSS-only, no JS needed)
                if (newLayout === 'magazine') {
                    setTimeout(() => {
                        if (typeof initMagazineAutoscroll === 'function') {
                            try { initMagazineAutoscroll(); } catch(e) { console.error('Magazine init:', e); }
                        }
                    }, 50);
                } else if (newLayout === 'gallery_wall') {
                    initGalleryWallScroll(galleryContainer);
                } else if (newLayout === 'creative_layout') {
                    initCreativeLayout(galleryContainer);
                } else if (newLayout === 'masonry_portfolio') {
                    initMasonryPortfolio(galleryContainer);
                } else if (newLayout === 'masonry') {
                    // Reset initialized flag and reinit
                    galleryContainer._masonryInitialized = false;
                    // Use dynamic import if module not loaded yet
                    if (typeof window.BalancedMasonryGrid !== 'undefined') {
                        window.galleryMasonry = initGalleryMasonry(galleryContainer);
                    } else {
                        // Dynamic import the module
                        import(`${window.basePath}/assets/vendor/masonry-grid/index.js`)
                            .then(module => {
                                window.BalancedMasonryGrid = module.BalancedMasonryGrid;
                                window.RegularMasonryGrid = module.RegularMasonryGrid;
                                window._masonryGridReady = true;
                                window.galleryMasonry = initGalleryMasonry(galleryContainer);
                            })
                            .catch(err => console.error('Failed to load masonry module:', err));
                    }
                }

            // STEP 10: Make visible and animate items
            setTimeout(() => {
                galleryContainer.classList.remove('tpl-switching');

                // Force visibility on all items as fallback
                // But DON'T touch masonry-frame transforms - the masonry library manages those!
                const allItems = galleryContainer.querySelectorAll('.gallery-item, .masonry-frame, .dense-grid-item, .photo-item');
                allItems.forEach((item) => {
                    if (!item.hasAttribute('data-animated')) {
                        item.style.opacity = '1';
                        // Only reset transform for non-masonry items
                        // Masonry library uses translateY(%) for positioning
                        if (!item.classList.contains('masonry-frame') && !item.classList.contains('photo-item')) {
                            item.style.transform = 'none';
                        }
                    }
                });

                // Trigger gallery animation if available
                if (typeof window.animateGalleryOnce === 'function') {
                    window.animateGalleryOnce();
                }

                // Update Lenis scroll
                if (window.lenisResize) {
                    setTimeout(window.lenisResize, 100);
                }
                // Restore scroll position (template 2 was jumping to top)
                window.scrollTo({ top: scrollY, left: 0, behavior: 'auto' });
            }, 50);
            });
        })
        .catch(err => {
            console.error('Template switch failed:', err);
            galleryContainer.className = originalClasses;
            galleryContainer.innerHTML = originalContent;
            galleryContainer.classList.remove('tpl-switching');
        })
        .finally(() => { delete el.dataset.switchInProgress; });
});

// Download button handler
document.addEventListener('click', function(event) {
    const downloadBtn = event.target.closest('[data-action="download-image"]');
    if (downloadBtn) {
        event.preventDefault();
        event.stopPropagation();
        const url = downloadBtn.dataset.downloadUrl;
        if (url) {
            window.location.href = url;
        }
    }
});

// GSAP Animations
document.addEventListener('DOMContentLoaded', function() {
    if (document.body.dataset.gsapGalleryIntroDone === '1') {
        return;
    }
    document.body.dataset.gsapGalleryIntroDone = '1';

    const allHeaderEls = document.querySelectorAll('[data-gsap="categories"], [data-gsap="title"], [data-gsap="meta"], [data-gsap="excerpt"], [data-gsap="body"], [data-gsap="equipment"]');
    allHeaderEls.forEach(el => {
        el.setAttribute('data-animated', '1');
        el.style.opacity = '1';
        el.style.transform = 'none';
    });
    if (typeof gsap !== 'undefined') {
        gsap.set(allHeaderEls, { clearProps: 'all', opacity: 1 });
    }

    // Template switcher fade in
    const templateSwitcher = document.getElementById('template-switcher');
    if (templateSwitcher && typeof gsap !== 'undefined') {
        gsap.to(templateSwitcher, {
            opacity: 1,
            x: 0,
            duration: 0.5,
            delay: 0.6,
            ease: 'power2.out'
        });
    }

    // Subtle hover enhancement for image items
    const allImageItems = document.querySelectorAll('.gallery-link');
    allImageItems.forEach(item => {
        item.addEventListener('mouseenter', function() {
            if (typeof gsap !== 'undefined') {
                gsap.to(this, {
                    scale: 1.015,
                    duration: 0.3,
                    ease: 'power2.out'
                });
            }
        });
        item.addEventListener('mouseleave', function() {
            if (typeof gsap !== 'undefined') {
                gsap.to(this, {
                    scale: 1,
                    duration: 0.3,
                    ease: 'power2.out'
                });
            }
        });
    });
});

// Handle bfcache restoration
window.addEventListener('pageshow', function(event) {
    if (event.persisted) {
        const animatedElements = document.querySelectorAll('[data-gsap]');
        animatedElements.forEach(function(el) {
            el.style.opacity = '1';
            el.style.transform = 'none';
            el.setAttribute('data-animated', '1');
        });
        if (typeof gsap !== 'undefined') {
            gsap.set(animatedElements, { clearProps: 'all', opacity: 1 });
        }
    }
});
</script>
