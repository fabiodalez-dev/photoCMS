{% extends "frontend/_layout.twig" %}

{% block styles %}
<style nonce="{{ csp_nonce() }}">
/* Reset only for gallery wall */
.gallery-wall, .gallery-wall * {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

/* Ensure mobile search toggle hidden on desktop (reinforce Tailwind md:hidden) */
@media (min-width: 768px) {
  #mobile-search-toggle {
    display: none !important;
  }
}

/* Override layout footer margin */
body > footer.border-t {
  margin-top: 0;
}

/* === GALLERY SECTION === */
.gallery-wall-section {
  position: relative;
  /* Height calculated by JS */
}

.gallery-wall-container {
  position: sticky;
  top: var(--header-height, 80px);
  height: calc(100vh - var(--header-height, 80px));
  display: flex;
  align-items: center;
  overflow: hidden;
  background: #ffffff;
  z-index: 10;
}

html.dark .gallery-wall-container {
  background: #0a0a0a;
}

.gallery-wall-track {
  display: flex;
  gap: 0;
  will-change: transform;
}

.gallery-wall-item {
  flex-shrink: 0;
  height: calc(100vh - var(--header-height, 80px));
  position: relative;
}

.gallery-wall-item.horizontal {
  width: calc((100vh - var(--header-height, 80px)) * 1.5);
}

.gallery-wall-item.vertical {
  width: calc((100vh - var(--header-height, 80px)) * 0.67);
}

.gallery-wall-item a {
  display: block;
  width: 100%;
  height: 100%;
}

.gallery-wall-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

/* Thin border between photos */
.gallery-wall-item::after {
  content: '';
  position: absolute;
  right: 0;
  top: 0;
  bottom: 0;
  width: 2px;
  background: #fff;
}

html.dark .gallery-wall-item::after {
  background: #171717;
}

/* Hover overlay */
.gallery-wall-overlay {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  padding: 1.5rem;
  background: linear-gradient(transparent, rgba(0,0,0,0.7));
  color: white;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.gallery-wall-item:hover .gallery-wall-overlay {
  opacity: 1;
}

.gallery-wall-overlay h3 {
  font-size: 1rem;
  font-weight: 500;
  margin: 0 0 0.25rem 0;
}

.gallery-wall-overlay p {
  font-size: 0.85rem;
  opacity: 0.8;
  margin: 0;
}

/* === MOBILE LAYOUT === */
.gallery-mobile-grid {
  display: none;
}

/* ============================================
   TABLET: max-width 1024px
   ============================================ */
@media (max-width: 1024px) {
  .gallery-wall-item.horizontal {
    width: calc((100vh - var(--header-height, 80px)) * 1.3);
  }

  .gallery-wall-item.vertical {
    width: calc((100vh - var(--header-height, 80px)) * 0.6);
  }
}

/* ============================================
   MOBILE: max-width 768px
   Vertical classic gallery
   ============================================ */
@media (max-width: 768px) {
  /* Hide desktop gallery */
  .gallery-wall-section {
    display: none;
  }

  /* Show mobile gallery */
  .gallery-mobile-grid {
    display: block;
    padding: 1rem;
  }

  .gallery-mobile-grid-inner {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.5rem;
  }

  .gallery-mobile-item {
    aspect-ratio: 1;
    overflow: hidden;
    position: relative;
  }

  .gallery-mobile-item.wide {
    grid-column: span 2;
    aspect-ratio: 16/9;
  }

  .gallery-mobile-item a {
    display: block;
    width: 100%;
    height: 100%;
  }

  .gallery-mobile-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

}

/* ============================================
   SMALL MOBILE: max-width 480px
   ============================================ */
@media (max-width: 480px) {
  .gallery-mobile-grid {
    padding: 0.5rem;
  }

  .gallery-mobile-grid-inner {
    gap: 0.3rem;
  }
}
</style>
{% endblock %}

{% block content %}
{# Hook: frontend_home_before - Before all home page content #}
{{ do_action('frontend_home_before', {base_path: base_path}) }}

{# WebSite JSON-LD for home page #}
<script type="application/ld+json" nonce="{{ csp_nonce() }}">
{
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": {{ site_title|default('Portfolio')|json_encode|raw }},
  "url": {{ (canonical_url|default(current_url))|json_encode|raw }},
  {% if meta_description %}
  "description": {{ meta_description|json_encode|raw }},
  {% endif %}
  "potentialAction": {
    "@type": "SearchAction",
    "target": {
      "@type": "EntryPoint",
      "urlTemplate": "{{ base_path }}/{{ galleries_slug|default('galleries') }}?q={search_term_string}"
    },
    "query-input": "required name=search_term_string"
  }
}
</script>

{% if all_images|length > 0 %}
<div class="gallery-wall">
  <!-- DESKTOP/TABLET: Horizontal Gallery -->
  <section class="gallery-wall-section" id="galleryWallSection">
    <div class="gallery-wall-container">
      <div class="gallery-wall-track" id="galleryWallTrack">
        {% for image in all_images %}
        {% set isHorizontal = (image.width|default(1600) / image.height|default(1000)) > 1.2 %}
        <div class="gallery-wall-item {{ isHorizontal ? 'horizontal' : 'vertical' }}">
          <a href="{{ base_path }}/album/{{ image.album_slug|e('html_attr') }}">
            {% set imgSrc = image.fallback_src|default(image.original_path) %}
            {% set imgUrl = imgSrc starts with '/' ? base_path ~ imgSrc : imgSrc %}
            <img src="{{ imgUrl|e('html_attr') }}" alt="{{ image.title|default(image.album_title)|e('html_attr') }}" loading="lazy" decoding="async" data-fallback="hide">
            <div class="gallery-wall-overlay">
              <h3>{{ image.album_title|e }}</h3>
              <p>{{ image.category_name|e }}</p>
            </div>
          </a>
        </div>
        {% endfor %}
      </div>
    </div>
  </section>

  <!-- MOBILE: Grid Gallery -->
  <div class="gallery-mobile-grid">
    <div class="gallery-mobile-grid-inner">
      {% for image in all_images|slice(0, 50) %}
      {% set isHorizontal = (image.width|default(1600) / image.height|default(1000)) > 1.2 %}
      <div class="gallery-mobile-item {{ isHorizontal and loop.index % 5 == 1 ? 'wide' : '' }}">
        <a href="{{ base_path }}/album/{{ image.album_slug|e('html_attr') }}">
          {% set imgSrc = image.fallback_src|default(image.original_path) %}
          {% set imgUrl = imgSrc starts with '/' ? base_path ~ imgSrc : imgSrc %}
          <img src="{{ imgUrl|e('html_attr') }}" alt="{{ image.title|default(image.album_title)|e('html_attr') }}" loading="lazy" decoding="async" data-fallback="hide">
        </a>
      </div>
      {% endfor %}
    </div>
  </div>
</div>
{% else %}
{# Empty state #}
<div class="min-h-screen flex items-center justify-center">
  <div class="text-center px-4">
    <i class="fas fa-images text-6xl text-gray-300 mb-6"></i>
    <h2 class="text-2xl font-semibold text-gray-800 mb-2">{{ home_settings.empty_title|default(trans('home_gallery.empty_title'))|default('No photos yet')|e }}</h2>
    <p class="text-gray-600">{{ home_settings.empty_text|default(trans('home_gallery.empty_text'))|default('Check back soon for new content.')|e }}</p>
  </div>
</div>
{% endif %}

{# Hook: frontend_home_after - After all home page content #}
{{ do_action('frontend_home_after', {base_path: base_path}) }}
{% endblock %}

{% block scripts %}
  <script nonce="{{ csp_nonce() }}" type="module" src="{{ base_path }}/assets/js/home-gallery.js"></script>
<script nonce="{{ csp_nonce() }}">
// Disable header hide on scroll for gallery wall
document.body.classList.add('gallery-wall-page');
</script>
{% endblock %}
