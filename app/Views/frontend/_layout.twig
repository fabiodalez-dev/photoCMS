<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title|e }}</title>
    
    {% if meta_description %}
    <meta name="description" content="{{ meta_description|e }}">
    {% endif %}
    
    <!-- Open Graph -->
    <meta property="og:title" content="{{ page_title|e }}">
    {% if meta_description %}
    <meta property="og:description" content="{{ meta_description|e }}">
    {% endif %}
    {% if meta_image %}
    <meta property="og:image" content="{{ meta_image }}">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    {% endif %}
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ current_url }}">
    
    <!-- Fonts: use system stack to comply with CSP -->
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['ui-sans-serif','system-ui','-apple-system','Segoe UI','Roboto','Helvetica Neue','Arial','Noto Sans','Liberation Sans','sans-serif']
                    }
                }
            }
        }
    </script>
    
    <!-- PhotoSwipe CSS (local) -->
    <link rel="stylesheet" href="/assets/photoswipe/photoswipe.css">
    
    <!-- Swiper CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css">

    <!-- Font Awesome (icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- Custom styles -->
    <style>
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* Template-specific styles */
        .masonry-grid {
            column-count: 3;
            column-gap: 1rem;
        }
        .masonry-item {
            break-inside: avoid;
            margin-bottom: 1rem;
        }
        @media (max-width: 768px) {
            .masonry-grid {
                column-count: 2;
            }
        }
        @media (max-width: 480px) {
            .masonry-grid {
                column-count: 1;
            }
        }
        
        /* Swiper custom styles */
        .gallery-swiper .swiper-button-next,
        .gallery-swiper .swiper-button-prev {
            color: #000;
        }
        .gallery-swiper .swiper-pagination-bullet-active {
            background: #000;
        }

        /* Simple tooltip for template buttons */
        .tpl-switch { position: relative; }
        .tpl-switch[data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute; bottom: 125%; left: 50%; transform: translateX(-50%);
            background: rgba(17,17,17,.95); color: #fff; padding: 6px 8px; border-radius: 4px; white-space: nowrap;
            font-size: 12px; line-height: 1; z-index: 50;
            box-shadow: 0 6px 12px rgba(0,0,0,.2);
        }
        .tpl-switch[data-tooltip]:hover::before {
            content: ''; position: absolute; bottom: 115%; left: 50%; transform: translateX(-50%);
            width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 6px solid rgba(17,17,17,.95);
            z-index: 51;
        }



        /* Simple Lightbox fallback */
        #slb-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.95); color:#fff; display:none; align-items:center; justify-content:center; z-index: 10000; }
        #slb-overlay.active { display:flex; }
        #slb-content { max-width: 96vw; max-height: 92vh; position: relative; display:flex; flex-direction:column; align-items:center; justify-content:center; }
        #slb-content .slb-media { width: min(60%, 1200px); }
        #slb-img { width: 100%; height: auto; max-height: 72vh; object-fit: contain; display:block; margin: 0 auto; }
        #slb-caption { margin-top: .9rem; text-align: center; color:#ddd; font-size: .9rem; }
        .slb-btn { position:absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.22); color:#fff; width: 44px; height: 44px; border-radius: 9999px; display:flex; align-items:center; justify-content:center; cursor:pointer; z-index: 10001; }
        .slb-prev { left: 2%; }
        .slb-next { right: 2%; }
        .slb-close { position: absolute; top: 10px; right: 10px; width: 40px; height: 40px; border-radius: 9999px; background: rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.2); display:flex; align-items:center; justify-content:center; cursor:pointer; }
        @media (max-width: 1024px) { #slb-content .slb-media { width: min(80%, 1200px); } }
        @media (max-width: 640px)  { #slb-content .slb-media { width: 92%; } .slb-prev { left: 8px; } .slb-next { right: 8px; } }
        /* PhotoSwipe custom caption inside overlay */
        .pswp__custom-caption {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 24px;
            max-width: 92vw;
            color: #fff;
            text-align: center;
            font-size: 14px;
            line-height: 1.3;
            z-index: 2;
            background: rgba(0,0,0,0.6);
            padding: 8px 16px;
            border-radius: 4px;
        }
        
        /* Position navigation arrows outside the image */
        .pswp__button--arrow--prev,
        .pswp__button--arrow--next {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 60px;
            height: 60px;
            margin: 0;
            padding: 10px;
        }
        
        .pswp__button--arrow--prev {
            left: 20px;
        }
        
        .pswp__button--arrow--next {
            right: 20px;
        }
    </style>
</head>
<body class="min-h-full bg-white text-black font-sans antialiased">
    
    <!-- Header -->
    <header class="border-b border-neutral-200 sticky top-0 bg-white/90 backdrop-blur z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center gap-6">
                    <h1 class="text-xl font-semibold">
                        <a href="/" class="hover:text-neutral-700 transition-colors">Portfolio</a>
                    </h1>
                    
                    <!-- Desktop nav with dropdown -->
                    <nav class="hidden md:flex items-center gap-4 relative">
                        <a href="/" class="text-sm hover:text-neutral-700 transition-colors">Home</a>
                        <a href="{{ about_url }}" class="text-sm hover:text-neutral-700 transition-colors">About</a>
                        <div class="relative" id="cats-wrapper">
                            <button id="cats-toggle" class="text-sm inline-flex items-center gap-1 hover:text-neutral-700 transition-colors">
                                Categories
                                <i class="fas fa-chevron-down text-[10px] transition-transform" id="cats-icon"></i>
                            </button>
                            <div id="cats-menu" class="hidden absolute left-0 mt-3 w-[900px] bg-white border border-neutral-200 shadow-2xl rounded-lg z-50 overflow-hidden">
                                <div class="p-6">
                                    <!-- Parent categories with images -->
                                    <div class="grid grid-cols-3 gap-6 mb-6" id="parent-categories">
                                        {% for category in parent_categories|default([]) %}
                                        <div class="group cursor-pointer" data-category-id="{{ category.id }}">
                                            <div class="aspect-[4/3] overflow-hidden rounded-lg mb-3 bg-neutral-100">
                                                {% if category.image_path %}
                                                    <img src="{{ category.image_path }}" alt="{{ category.name|e }}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">
                                                {% else %}
                                                    <div class="w-full h-full flex items-center justify-center text-neutral-400">
                                                        <i class="fas fa-image text-2xl"></i>
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <h3 class="font-medium text-sm group-hover:text-neutral-600 transition-colors">{{ category.name|e }}</h3>
                                            {% if category.children|length > 0 %}
                                                <p class="text-xs text-neutral-500">{{ category.children|length }} subcategories</p>
                                            {% endif %}
                                        </div>
                                        {% endfor %}
                                    </div>
                                    
                                    <!-- Subcategories (shown when parent is selected) -->
                                    <div id="subcategories" class="hidden border-t pt-4">
                                        <div class="flex items-center gap-2 mb-3">
                                            <button id="back-btn" class="text-xs text-neutral-500 hover:text-black transition-colors">
                                                <i class="fas fa-arrow-left mr-1"></i> Back
                                            </button>
                                            <span id="current-parent" class="text-sm font-medium"></span>
                                        </div>
                                        <div id="subcategories-list" class="grid grid-cols-4 gap-2">
                                            <!-- Populated by JavaScript -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </nav>
                </div>
                
                <div class="flex items-center space-x-4">
                    <!-- Search/filters toggle -->
                    <button id="filters-toggle" class="text-sm hover:text-neutral-700 transition-colors">
                        Filters
                    </button>
                    
                    <!-- Mobile menu toggle -->
                    <button id="mobile-menu-toggle" class="md:hidden">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Mobile menu -->
        <div id="mobile-menu" class="md:hidden hidden border-t border-neutral-200 bg-white">
            <div class="px-4 py-4 space-y-4">
                <a href="/" class="block text-sm hover:text-neutral-700 transition-colors">Home</a>
                <a href="{{ about_url }}" class="block text-sm hover:text-neutral-700 transition-colors">About</a>
                <div>
                    <div class="text-xs uppercase tracking-wide text-neutral-500 mb-2">Categories</div>
                    <div class="space-y-2">
                        {% for category in parent_categories|default([]) %}
                        <div>
                            <button class="mobile-category-toggle text-sm font-medium text-left w-full flex items-center justify-between hover:text-neutral-600 transition-colors" data-category-id="{{ category.id }}">
                                <span>{{ category.name|e }}</span>
                                {% if category.children|length > 0 %}
                                    <i class="fas fa-chevron-right text-[10px] transition-transform"></i>
                                {% endif %}
                            </button>
                            {% if category.children|length > 0 %}
                                <div class="mobile-subcategories hidden pl-4 mt-2 space-y-1" data-parent="{{ category.id }}">
                                    {% for child in category.children %}
                                        <a href="/category/{{ child.slug }}" class="block text-xs text-neutral-600 hover:text-black transition-colors">
                                            {{ child.name|e }}
                                        </a>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Filters panel -->
        <div id="filters-panel" class="hidden border-t border-neutral-200 bg-neutral-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex flex-wrap gap-4 items-center text-sm">
                    <div class="flex items-center space-x-2">
                        <label class="font-medium">Process:</label>
                        <select id="filter-process" class="border border-neutral-300 rounded px-2 py-1 text-xs">
                            <option value="">All</option>
                            <option value="analog">Analog</option>
                            <option value="digital">Digital</option>
                            <option value="hybrid">Hybrid</option>
                        </select>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <label class="font-medium">Sort:</label>
                        <select id="filter-sort" class="border border-neutral-300 rounded px-2 py-1 text-xs">
                            <option value="published_desc">Latest</option>
                            <option value="published_asc">Oldest</option>
                            <option value="title_asc">Title A-Z</option>
                            <option value="title_desc">Title Z-A</option>
                        </select>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <input type="text" id="filter-search" placeholder="Search camera, film..." 
                               class="border border-neutral-300 rounded px-2 py-1 text-xs w-48">
                    </div>
                    
                    <button id="apply-filters" class="bg-black text-white px-3 py-1 text-xs rounded hover:bg-neutral-800 transition-colors">
                        Apply
                    </button>
                    
                    <button id="clear-filters" class="text-neutral-600 hover:text-black px-2 py-1 text-xs">
                        Clear
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main content -->
    <main>
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="border-t border-neutral-200 mt-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="text-sm text-neutral-600">
                    © {{ "now"|date("Y") }} Portfolio. All rights reserved.
                </div>
                
                {% if tags|default([])|length > 0 %}
                <div class="flex flex-wrap gap-2 mt-4 md:mt-0">
                    {% for tag in tags|slice(0, 10) %}
                    <a href="/tag/{{ tag.slug }}" class="text-xs text-neutral-500 hover:text-black border border-neutral-200 rounded px-2 py-1 transition-colors">
                        #{{ tag.name|e }}
                    </a>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
    </footer>

    <!-- PhotoSwipe lightbox (local) loaded dynamically in JS -->
    
    <!-- Swiper.js -->
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    
    <!-- GSAP -->
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/ScrollTrigger.min.js"></script>
    
    <!-- imagesLoaded + Masonry -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/5.0.0/imagesloaded.pkgd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/masonry/4.2.2/masonry.pkgd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <!-- App JS -->
    <script>
        // Mobile menu toggle
        document.getElementById('mobile-menu-toggle')?.addEventListener('click', function() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        });
        
        // Mobile category toggles
        document.querySelectorAll('.mobile-category-toggle').forEach(button => {
            button.addEventListener('click', () => {
                const categoryId = button.dataset.categoryId;
                const subcategories = document.querySelector(`[data-parent="${categoryId}"]`);
                const icon = button.querySelector('i');
                
                if (subcategories) {
                    subcategories.classList.toggle('hidden');
                    if (icon) {
                        icon.style.transform = subcategories.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(90deg)';
                    }
                }
            });
        });
        
        // Desktop mega menu
        const megaMenuData = {
            {% for category in parent_categories|default([]) %}
            {{ category.id }}: {
                name: "{{ category.name|e }}",
                children: [
                    {% for child in category.children %}
                    { name: "{{ child.name|e }}", slug: "{{ child.slug }}" }{% if not loop.last %},{% endif %}
                    {% endfor %}
                ]
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        };
        
        // Desktop categories dropdown with subcategory support
        (function(){
            const toggle = document.getElementById('cats-toggle');
            const menu = document.getElementById('cats-menu');
            const icon = document.getElementById('cats-icon');
            const parentCats = document.getElementById('parent-categories');
            const subcatsDiv = document.getElementById('subcategories');
            const subcatsList = document.getElementById('subcategories-list');
            const currentParent = document.getElementById('current-parent');
            const backBtn = document.getElementById('back-btn');
            
            if (!toggle || !menu) return;
            
            let isOpen = false;
            
            function closeMenu() {
                menu.classList.add('hidden');
                icon?.style.setProperty('transform', 'rotate(0deg)');
                showParentCategories();
                isOpen = false;
            }
            
            function openMenu() {
                menu.classList.remove('hidden');
                icon?.style.setProperty('transform', 'rotate(180deg)');
                isOpen = true;
            }
            
            function showParentCategories() {
                parentCats?.classList.remove('hidden');
                subcatsDiv?.classList.add('hidden');
            }
            
            function showSubcategories(categoryId) {
                const category = megaMenuData[categoryId];
                if (!category || !category.children.length) return;
                
                parentCats?.classList.add('hidden');
                subcatsDiv?.classList.remove('hidden');
                
                if (currentParent) currentParent.textContent = category.name;
                
                if (subcatsList) {
                    subcatsList.innerHTML = category.children.map(child => 
                        `<a href="/category/${child.slug}" class="block text-sm px-3 py-2 rounded-md hover:bg-neutral-100 transition-colors">${child.name}</a>`
                    ).join('');
                }
            }
            
            toggle.addEventListener('click', (e) => {
                e.preventDefault();
                isOpen ? closeMenu() : openMenu();
            });
            
            // Handle parent category clicks
            parentCats?.addEventListener('click', (e) => {
                const categoryDiv = e.target.closest('[data-category-id]');
                if (categoryDiv) {
                    e.preventDefault();
                    const categoryId = categoryDiv.dataset.categoryId;
                    const category = megaMenuData[categoryId];
                    
                    if (category?.children.length > 0) {
                        showSubcategories(categoryId);
                    } else {
                        // Navigate to parent category if no children
                        window.location.href = `/category/${categoryDiv.querySelector('h3').textContent.toLowerCase().replace(/\s+/g, '-')}`;
                    }
                }
            });
            
            backBtn?.addEventListener('click', showParentCategories);
            
            document.addEventListener('click', (e) => {
                if (!isOpen) return;
                const wrapper = document.getElementById('cats-wrapper');
                if (wrapper && !wrapper.contains(e.target)) closeMenu();
            });
        })();
        
        // Filters toggle
        document.getElementById('filters-toggle')?.addEventListener('click', function() {
            const panel = document.getElementById('filters-panel');
            panel.classList.toggle('hidden');
        });

        // Desktop categories dropdown (click to open, click outside to close)
        (function(){
            const toggle = document.getElementById('cats-toggle');
            const menu = document.getElementById('cats-menu');
            if (!toggle || !menu) return;
            let open = false;
            function close(){ menu.classList.add('hidden'); open=false; }
            function openMenu(){ menu.classList.remove('hidden'); open=true; }
            toggle.addEventListener('click', (e)=>{ e.preventDefault(); open ? close() : openMenu(); });
            document.addEventListener('click', (e)=>{
                if (!open) return;
                const w = document.getElementById('cats-wrapper');
                if (w && !w.contains(e.target)) close();
            });
        })();
        
        // Smooth animations
        gsap.registerPlugin(ScrollTrigger);
        
        // Animate elements on scroll
        gsap.utils.toArray('.album-card, .image-item').forEach(el => {
            gsap.from(el, {
                opacity: 0,
                y: 20,
                duration: 0.6,
                scrollTrigger: {
                    trigger: el,
                    start: "top 90%",
                    end: "bottom 10%",
                    toggleActions: "play none none none"
                }
            });
        });
        
        // Header scroll behavior
        let lastScroll = 0;
        const header = document.querySelector('header');
        
        window.addEventListener('scroll', () => {
            const currentScroll = window.pageYOffset;
            
            if (currentScroll > lastScroll && currentScroll > 100) {
                header.style.transform = 'translateY(-100%)';
            } else {
                header.style.transform = 'translateY(0)';
            }
            
            lastScroll = currentScroll;
        });
        
        // Lazy loader for PhotoSwipe (handles CDN not yet loaded)
        let __psLoading = false;
        // Respect CSP: only use allowed sources (jsDelivr, cdnjs)
        const __psSources = [
          'https://cdn.jsdelivr.net/npm/photoswipe@5.4.4/dist/photoswipe.min.js',
          'https://cdnjs.cloudflare.com/ajax/libs/photoswipe/5.4.4/photoswipe.min.js'
        ];
        // Local PhotoSwipe loader: try actual local paths (core + lightbox), then fallback
        let __psWarned = false;
        function loadScriptSequential(urls, done) {
          let idx = 0;
          const next = () => {
            if (idx >= urls.length) return done(false);
            const s = document.createElement('script');
            s.src = urls[idx++];
            s.async = true;
            s.onload = () => done(true);
            s.onerror = next;
            document.head.appendChild(s);
          };
          next();
        }
        function loadPhotoSwipe() {
            return new Promise((resolve, reject) => {
                if (window.PhotoSwipe) return resolve();
                // Prefer UMD builds under /dist/umd (your current files)
                const coreCandidates = [
                  '/assets/photoswipe/dist/umd/photoswipe.umd.min.js',
                  '/assets/photoswipe/dist/umd/photoswipe.umd.js',
                  // fallbacks if structure changes
                  '/assets/photoswipe/dist/photoswipe.umd.min.js',
                  '/assets/photoswipe/dist/photoswipe.umd.js'
                ];
                loadScriptSequential(coreCandidates, (okCore) => {
                  if (!okCore && !window.PhotoSwipe) return reject(new Error('PhotoSwipe unavailable'));
                  const lbCandidates = [
                    '/assets/photoswipe/dist/umd/photoswipe-lightbox.umd.min.js',
                    '/assets/photoswipe/dist/umd/photoswipe-lightbox.umd.js'
                  ];
                  loadScriptSequential(lbCandidates, () => resolve());
                });
            });
        }

        // Build PS items from anchors in current gallery
        function buildItemsFromAnchors(){
            const anchors = Array.from(document.querySelectorAll('#images-gallery a.pswp-link'));
            return anchors.map(x=>({
              src: x.getAttribute('href'),
              width: parseInt(x.getAttribute('data-pswp-width')||'1600',10),
              height: parseInt(x.getAttribute('data-pswp-height')||'1067',10),
              caption_html: x.getAttribute('data-pswp-caption')||''
            }));
        }
        function destroyLightbox(){
            if (window.__pswpLightbox && typeof window.__pswpLightbox.destroy === 'function') {
                try { window.__pswpLightbox.destroy(); } catch(e){}
                window.__pswpLightbox = null;
            }
        }
        // Initialize PhotoSwipe Lightbox bound to gallery anchors
        function initLightbox() {
            // Check if there are any pswp-link elements before initializing
            const galleryElement = document.getElementById('images-gallery');
            if (!galleryElement || !galleryElement.querySelectorAll('a.pswp-link').length) {
                return;
            }
            
            loadPhotoSwipe().then(()=>{
                destroyLightbox();
                if (window.PhotoSwipeLightbox) {
                    const psCfg = (window.templateSettings && window.templateSettings.photoswipe) || {};
                    const lb = new PhotoSwipeLightbox({
                        gallery: '#images-gallery',
                        children: 'a.pswp-link',
                        pswpModule: PhotoSwipe,
                        showHideAnimationType: 'fade',
                        bgOpacity: typeof psCfg.bgOpacity === 'number' ? psCfg.bgOpacity : 0.85,
                        wheelToZoom: true,
                        loop: !!psCfg.loop
                    });
                    // Caption UI
                    lb.on('uiRegister', () => {
                        lb.pswp.ui.registerElement({
                            name: 'custom-caption', order: 9, isButton: false, appendTo: 'root',
                            onInit: (el, pswp) => {
                                el.className = 'pswp__custom-caption';
                                pswp.on('change', () => {
                                    const currEl = pswp.currSlide && pswp.currSlide.data && pswp.currSlide.data.element;
                                    const cap = currEl ? currEl.getAttribute('data-pswp-caption') : '';
                                    el.innerHTML = cap || '';
                                });
                            }
                        });
                    });
                    // Show images in a container with fixed max size
                    lb.on('open', () => {
                        const pswp = lb.pswp;
                        const fitToContainer = () => {
                            const s = pswp.currSlide;
                            if (!s || !s.width || !s.height) return;
                            
                            // Define max dimensions for the container
                            const maxWidth = Math.min(1200, pswp.viewportSize.x * 0.6);
                            const maxHeight = Math.min(800, pswp.viewportSize.y * 0.7);
                            
                            // Calculate scale to fit within container
                            const scaleW = maxWidth / s.width;
                            const scaleH = maxHeight / s.height;
                            const scale = Math.min(scaleW, scaleH, 1); // Don't upscale
                            
                            // Center the image
                            const x = (pswp.viewportSize.x - (s.width * scale)) / 2;
                            const y = (pswp.viewportSize.y - (s.height * scale)) / 2;
                            
                            // Apply zoom and pan
                            s.zoomLevels.initial = scale;
                            s.zoomLevels.secondary = scale;
                            s.zoomLevels.max = scale;
                            s.zoomLevels.min = scale;
                            s.pan.x = x;
                            s.pan.y = y;
                            
                            // Update content
                            s.updateContentSize(true);
                        };
                        fitToContainer();
                        pswp.on('change', fitToContainer);
                        pswp.on('resize', fitToContainer);
                        
                        // Ensure arrows are positioned correctly
                        setTimeout(() => {
                            const prevArrow = pswp.element.querySelector('.pswp__button--arrow--prev');
                            const nextArrow = pswp.element.querySelector('.pswp__button--arrow--next');
                            if (prevArrow) prevArrow.style.left = '20px';
                            if (nextArrow) nextArrow.style.right = '20px';
                        }, 50);
                    });
                    lb.init();
                    window.__pswpLightbox = lb;
                }
            }).catch((err)=>{
                console.warn('Failed to initialize PhotoSwipe:', err);
            });
        }
        function openLightboxAt(index) {
            const items = buildItemsFromAnchors();
            const startIndex = Math.max(0, Math.min(index, items.length-1));

            loadPhotoSwipe().then(() => {
                const psCfg = (window.templateSettings && window.templateSettings.photoswipe) || {};
                // If PhotoSwipeLightbox is available, use it to get full UI features
                if (window.PhotoSwipeLightbox) {
                  const lb = new PhotoSwipeLightbox({
                    dataSource: items,
                    pswpModule: PhotoSwipe,
                    showHideAnimationType: 'fade',
                    bgOpacity: typeof psCfg.bgOpacity === 'number' ? psCfg.bgOpacity : 0.85,
                    wheelToZoom: true,
                    loop: !!psCfg.loop,
                    // Force images to be centered and properly sized
                    imageClickAction: 'close',
                    tapAction: 'close'
                  });
                  let psCaptionEl;
                  lb.on('open', () => {
                    const pswp = lb.pswp;
                    psCaptionEl = document.createElement('div');
                    psCaptionEl.style.cssText = 'position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); color:white; padding:10px 15px; border-radius:5px; z-index:10001; text-align:center; font-size:14px; max-width:80%;';
                    pswp.on('change', () => {
                      const it = items[pswp.currIndex];
                      if (!it) return;
                      
                      // Debug: log caption data
                      console.log('Caption data for image:', it);
                      
                      // Remove previous caption
                      if (psCaptionEl.parentNode) psCaptionEl.parentNode.removeChild(psCaptionEl);
                      
                      // Set caption content
                      const captionContent = it.caption_html || (it.caption ? `<div>${it.caption}</div>` : '');
                      if (captionContent) {
                        psCaptionEl.innerHTML = captionContent;
                        document.body.appendChild(psCaptionEl);
                      }
                    });
                    pswp.on('close', () => { if (psCaptionEl && psCaptionEl.parentNode) psCaptionEl.parentNode.removeChild(psCaptionEl); });
                  });
                  lb.init();
                  // Manually open at index
                  lb.loadAndOpen(startIndex);
                } else {
                  // Fallback to base PhotoSwipe class (still local JS)
                  const lightbox = new PhotoSwipe({
                      dataSource: items,
                      index: startIndex,
                      showHideAnimationType: 'fade',
                      allowPanToNext: !!psCfg.allowPanToNext,
                      bgOpacity: typeof psCfg.bgOpacity === 'number' ? psCfg.bgOpacity : 0.85,
                      loop: !!psCfg.loop
                  });
                  // Custom caption overlay for PhotoSwipe
                  let psCaptionEl = document.createElement('div');
                  psCaptionEl.style.cssText = 'position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); color:white; padding:10px 15px; border-radius:5px; z-index:10001; text-align:center; font-size:14px; max-width:80%;';
                  function updatePsCaption(){
                    const it = items[lightbox.currIndex];
                    if (!it) return;
                    
                    // Debug: log caption data
                    console.log('Fallback caption data for image:', it);
                    
                    // Remove previous caption
                    if (psCaptionEl.parentNode) psCaptionEl.parentNode.removeChild(psCaptionEl);
                    
                    // Set caption content
                    const captionContent = it.caption_html || (it.caption ? `<div>${it.caption}</div>` : '');
                    if (captionContent) {
                      psCaptionEl.innerHTML = captionContent;
                      document.body.appendChild(psCaptionEl);
                    }
                  }
                  lightbox.on('change', updatePsCaption);
                  lightbox.on('close', ()=>{ if (psCaptionEl.parentNode) psCaptionEl.parentNode.removeChild(psCaptionEl); });
                  lightbox.init();
                  updatePsCaption();
                  
                  // Adjust image to fit in a container
                  const fitToContainer = () => {
                    const pswp = lightbox;
                    const s = pswp.currSlide;
                    if (!s || !s.width || !s.height) return;
                    
                    // Define max dimensions for the container
                    const maxWidth = Math.min(1200, pswp.viewportSize.x * 0.6);
                    const maxHeight = Math.min(800, pswp.viewportSize.y * 0.7);
                    
                    // Calculate scale to fit within container
                    const scaleW = maxWidth / s.width;
                    const scaleH = maxHeight / s.height;
                    const scale = Math.min(scaleW, scaleH, 1); // Don't upscale
                    
                    // Center the image
                    const x = (pswp.viewportSize.x - (s.width * scale)) / 2;
                    const y = (pswp.viewportSize.y - (s.height * scale)) / 2;
                    
                    // Apply zoom and pan
                    s.zoomLevels.initial = scale;
                    s.zoomLevels.secondary = scale;
                    s.zoomLevels.max = scale;
                    s.zoomLevels.min = scale;
                    s.pan.x = x;
                    s.pan.y = y;
                    
                    // Update content
                    s.updateContentSize(true);
                  };
                  lightbox.on('change', fitToContainer);
                  lightbox.on('resize', fitToContainer);
                  
                  // Ensure arrows are positioned correctly
                  setTimeout(() => {
                    const prevArrow = lightbox.element.querySelector('.pswp__button--arrow--prev');
                    const nextArrow = lightbox.element.querySelector('.pswp__button--arrow--next');
                    if (prevArrow) prevArrow.style.left = '20px';
                    if (nextArrow) nextArrow.style.right = '20px';
                  }, 50);
                  
                  setTimeout(fitToContainer, 100); // Initial sizing
                }
            }).catch((err) => {
                if (!__psWarned) {
                  console.warn('PhotoSwipe not available:', err);
                  __psWarned = true;
                }
            });
        }

        // Delegated click for anchors: open PhotoSwipe
        document.addEventListener('click', (e) => {
            const a = e.target.closest('a.pswp-link');
            if (!a) return;
            e.preventDefault();
            const anchors = Array.from(document.querySelectorAll('#images-gallery a.pswp-link'));
            const idx = Math.max(0, anchors.indexOf(a));
            if (window.__pswpLightbox && typeof window.__pswpLightbox.loadAndOpen === 'function') {
                window.__pswpLightbox.loadAndOpen(idx);
            } else {
                // Fallback if lightbox isn't initialized properly
                const items = anchors.map(anchor => ({
                    src: anchor.getAttribute('href'),
                    width: parseInt(anchor.getAttribute('data-pswp-width') || '1600', 10),
                    height: parseInt(anchor.getAttribute('data-pswp-height') || '1067', 10),
                    caption_html: anchor.getAttribute('data-pswp-caption') || ''
                }));
                openLightboxAt(idx);
            }
        });
        // Initialize PhotoSwipe on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Small delay to ensure DOM is fully ready
            setTimeout(initLightbox, 100);
        });

        // Simple Lightbox fallback implementation
        let __slbItems = []; let __slbIndex = 0;
        function ensureSlbDom() {
            if (document.getElementById('slb-overlay')) return;
            const wrap = document.createElement('div');
            wrap.id = 'slb-overlay';
            wrap.innerHTML = `
              <div id="slb-content">
                <button class="slb-close" aria-label="Close">✕</button>
                <button class="slb-btn slb-prev" aria-label="Prev">‹</button>
                <img id="slb-img" alt="" />
                <button class="slb-btn slb-next" aria-label="Next">›</button>
                <div id="slb-caption"></div>
              </div>`;
            document.body.appendChild(wrap);
            wrap.addEventListener('click', (e)=>{ if (e.target.id === 'slb-overlay') fallbackClose(); });
            wrap.querySelector('.slb-close').addEventListener('click', fallbackClose);
            wrap.querySelector('.slb-prev').addEventListener('click', ()=> fallbackShowIndex(__slbIndex-1));
            wrap.querySelector('.slb-next').addEventListener('click', ()=> fallbackShowIndex(__slbIndex+1));
            document.addEventListener('keydown', (e)=>{
              if (!wrap.classList.contains('active')) return;
              if (e.key === 'Escape') fallbackClose();
              if (e.key === 'ArrowLeft') fallbackShowIndex(__slbIndex-1);
              if (e.key === 'ArrowRight') fallbackShowIndex(__slbIndex+1);
            });
        }
        function fallbackOpenLightbox(items, startIndex){
            ensureSlbDom(); __slbItems = items || []; __slbIndex = Math.max(0, startIndex||0);
            document.getElementById('slb-overlay').classList.add('active');
            fallbackShowIndex(__slbIndex);
        }
        function fallbackShowIndex(idx){
            if (!__slbItems.length) return; __slbIndex = (idx + __slbItems.length) % __slbItems.length;
            const it = __slbItems[__slbIndex];
            const img = document.getElementById('slb-img'); img.src = it.src; img.alt = it.alt || '';
            const cap = document.getElementById('slb-caption');
            cap.innerHTML = it.caption_html || (it.caption ? '<div>' + it.caption + '</div>' : '');
        }
        function fallbackClose(){ const o = document.getElementById('slb-overlay'); if (o) o.classList.remove('active'); }
        
        {% block scripts %}{% endblock %}
    </script>
</body>
</html>
