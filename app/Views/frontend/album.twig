{% extends "frontend/_layout.twig" %}

{% block content %}
{# NSFW Age Gate - shown if album is NSFW and user hasn't confirmed (skip for admins) #}
{% if album.is_nsfw and not is_admin %}
<div id="nsfw-gate" class="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4 hidden"
     role="dialog" aria-modal="true" aria-labelledby="nsfw-gate-title">
  <div class="bg-white rounded-2xl max-w-lg w-full p-8 text-center shadow-2xl">
    <div class="w-20 h-20 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-6">
      <i class="fas fa-exclamation-triangle text-amber-600 text-4xl" aria-hidden="true"></i>
    </div>
    <h2 id="nsfw-gate-title" class="text-2xl font-semibold text-gray-900 mb-4">{{ trans('album.nsfw_title') }}</h2>
    <p class="text-gray-600 mb-6 leading-relaxed">
      {{ trans('album.nsfw_album_message') }}
    </p>
    <div class="flex flex-col sm:flex-row gap-3 justify-center">
      <button id="nsfw-confirm-btn" data-action="confirm-nsfw-album" class="px-6 py-3 bg-black text-white rounded-xl hover:bg-gray-800 transition-colors font-medium">
        {{ trans('album.nsfw_confirm') }}
      </button>
      <a href="{{ base_path }}/galleries" class="px-6 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-colors font-medium inline-block">
        {{ trans('album.nsfw_go_back') }}
      </a>
    </div>
    <p class="text-xs text-gray-400 mt-6">
      {{ trans('album.nsfw_remember') }}
    </p>
  </div>
</div>

<style nonce="{{ csp_nonce() }}">
  .nsfw-hidden { display: none !important; }
  #nsfw-gate.active { display: flex !important; }
</style>

<script nonce="{{ csp_nonce() }}">
const csrfToken = '{{ csrf|e('js') }}';
const albumSlug = '{{ album.slug|e('js') }}';
const basePath = '{{ base_path|e('js') }}';
const serverConsent = {{ nsfw_consent ? 'true' : 'false' }};

function safeLocalStorageGet(key) {
  try {
    return window.localStorage ? window.localStorage.getItem(key) : null;
  } catch (e) {
    return null;
  }
}

function safeLocalStorageSet(key, value) {
  try {
    if (window.localStorage) {
      window.localStorage.setItem(key, value);
    }
  } catch (e) {}
}

(function() {
  const localConfirmed = safeLocalStorageGet('nsfw_confirmed') === 'true';
  const gate = document.getElementById('nsfw-gate');
  const mainContent = document.getElementById('album-main-content');

  if (localConfirmed && !serverConsent && albumSlug && csrfToken) {
    if (gate) gate.style.display = 'none';
    const loader = document.createElement('div');
    loader.className = 'fixed inset-0 bg-black/60 z-50 flex items-center justify-center';
    const loaderText = document.createElement('div');
    loaderText.className = 'text-white text-sm';
    loaderText.textContent = '{{ trans("album.nsfw_syncing")|default("Verifica in corso...")|e('js') }}';
    loader.appendChild(loaderText);
    document.body.appendChild(loader);
    fetch(`${basePath}/album/${albumSlug}/nsfw-confirm`, {
      method: 'POST',
      credentials: 'same-origin',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: `csrf=${encodeURIComponent(csrfToken)}&nsfw_confirmed=1`
    }).then((resp) => {
      if (!resp.ok) {
        throw new Error('NSFW confirm failed');
      }
      window.location.reload();
    }).catch((err) => {
      console.warn('NSFW consent sync failed:', err);
      if (loader.parentNode) {
        loader.parentNode.removeChild(loader);
      }
      // Fully restore gate state on error
      if (gate) {
        gate.style.display = '';
        gate.classList.add('active');
      }
      document.body.style.overflow = 'hidden';
      if (mainContent) {
        mainContent.classList.add('nsfw-hidden');
        mainContent.setAttribute('aria-hidden', 'true');
      }
    });
    return;
  }

  if (serverConsent && !localConfirmed) {
    safeLocalStorageSet('nsfw_confirmed', 'true');
    if (window.applyNsfwConsentState) window.applyNsfwConsentState();
  }

  if (!serverConsent && gate) {
    gate.classList.add('active');
    document.body.style.overflow = 'hidden';
    if (mainContent) {
      mainContent.classList.add('nsfw-hidden');
      mainContent.setAttribute('aria-hidden', 'true');
    }
    // Focus the confirm button for accessibility
    const confirmBtn = document.getElementById('nsfw-confirm-btn');
    if (confirmBtn) setTimeout(() => confirmBtn.focus(), 100);
  }
})();

function confirmNsfwAndShow() {
  if (!albumSlug || !csrfToken) {
    return;
  }
  const confirmBtn = document.getElementById('nsfw-confirm-btn');
  if (confirmBtn) {
    confirmBtn.disabled = true;
  }
  fetch(`${basePath}/album/${albumSlug}/nsfw-confirm`, {
    method: 'POST',
    credentials: 'same-origin',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: `csrf=${encodeURIComponent(csrfToken)}&nsfw_confirmed=1`
  }).then((resp) => {
    if (!resp.ok) {
      throw new Error('NSFW confirm failed');
    }
    safeLocalStorageSet('nsfw_confirmed', 'true');
    window.nsfwConsent = true;
    if (window.applyNsfwConsentState) window.applyNsfwConsentState();
    window.location.reload();
  }).catch((err) => {
    console.warn('NSFW confirmation failed:', err);
    if (confirmBtn) {
      confirmBtn.disabled = false;
      const errorMsg = document.createElement('p');
      errorMsg.className = 'text-red-500 text-sm mt-2';
      errorMsg.textContent = '{{ trans("album.nsfw_error")|default("Verification failed. Please try again.")|e('js') }}';
      confirmBtn.parentNode.appendChild(errorMsg);
      setTimeout(() => errorMsg.remove(), 5000);
    }
  });
}

document.getElementById('nsfw-confirm-btn')?.addEventListener('click', function(event) {
  event.preventDefault();
  confirmNsfwAndShow();
});

// Delegated handler for CSP-safe actions (downloads, etc.)
document.addEventListener('click', function(event) {
  const downloadBtn = event.target.closest('[data-action="download-image"]');
  if (downloadBtn) {
    event.preventDefault();
    event.stopPropagation();
    const url = downloadBtn.dataset.downloadUrl;
    if (url) {
      window.location.href = url;
    }
    return;
  }
});
</script>
{% endif %}

{# Hook: frontend_album_before - Before entire album page #}
{{ do_action('frontend_album_before', {album: album, images: images, base_path: base_path}) }}

{# ImageGallery Schema for SEO #}
{% if images|length > 0 %}
<script type="application/ld+json" nonce="{{ csp_nonce() }}">
{
  "@context": "https://schema.org",
  "@type": "ImageGallery",
  "name": {{ album.title|json_encode|raw }},
  {% if album.excerpt %}"description": {{ album.excerpt|json_encode|raw }},{% endif %}
  {% if canonical_url %}"url": {{ canonical_url|json_encode|raw }},{% endif %}
  {% if album.shoot_date %}"datePublished": {{ album.shoot_date|json_encode|raw }},{% endif %}
  {% if album.updated_at %}"dateModified": {{ album.updated_at|json_encode|raw }},{% endif %}
  {% if schema is defined and schema.author_name %}"author": {
    "@type": "Person",
    "name": {{ schema.author_name|json_encode|raw }}
  },{% endif %}
  "associatedMedia": [
    {% for image in images %}
    {
      "@type": "ImageObject",
      "contentUrl": "{% if image.original_path starts with '/' %}{{ base_path }}{{ image.original_path }}{% else %}{{ image.original_path }}{% endif %}",
      {% if image.alt_text %}"description": {{ image.alt_text|json_encode|raw }},{% endif %}
      {% if image.caption %}"caption": {{ image.caption|json_encode|raw }},{% endif %}
      {% if image.width and image.height %}"width": {{ image.width }},
      "height": {{ image.height }},{% endif %}
      "encodingFormat": "image/jpeg",
      {% if image.exif_date_taken %}"datePublished": {{ image.exif_date_taken|json_encode|raw }},{% endif %}
      {% if schema is defined and schema.author_name %}"creator": {
        "@type": "Person",
        "name": {{ schema.author_name|json_encode|raw }}
      },{% endif %}
      {% if schema is defined and schema.image_copyright_notice %}"copyrightNotice": {{ schema.image_copyright_notice|replace_year|json_encode|raw }},{% endif %}
      {% if schema is defined and schema.image_license_url %}"license": {{ schema.image_license_url|json_encode|raw }},{% endif %}
      {% if schema is defined and schema.image_acquire_license_page %}"acquireLicensePage": {{ schema.image_acquire_license_page|json_encode|raw }},{% endif %}
      "thumbnailUrl": "{% if image.original_path starts with '/' %}{{ base_path }}{{ image.original_path }}{% else %}{{ image.original_path }}{% endif %}"
    }{% if not loop.last %},{% endif %}
    {% endfor %}
  ]
}
</script>
{% endif %}
<style nonce="{{ csp_nonce() }}">
/* Keep content visible; no intro hides to avoid flicker */
[data-gsap] { opacity: 1; transform: none; }
</style>
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
  {% include 'frontend/_breadcrumbs.twig' %}
</div>
<div id="album-main-content">
<!-- Template Album 2 - Hero Header -->
{% if template_settings.hero|default(false) and template_settings.coverBackground|default(false) %}
<div class="relative w-full h-screen flex items-center justify-center overflow-hidden">
    <!-- Background Image -->
    {% if album.cover %}
    <div class="absolute inset-0 z-0">
        {% set cover_url = album.cover.variants|length > 0 ? (album.cover.variants|last.path) : album.cover.original_path %}
        <img src="{% if cover_url starts with '/' %}{{ base_path }}{{ cover_url }}{% else %}{{ cover_url }}{% endif %}" alt="{{ album.title|e }}" class="w-full h-full object-cover">
    </div>
    {% endif %}
    
    <!-- Dark Overlay -->
    {% if template_settings.darkOverlay|default(false) %}
    <div class="absolute inset-0 bg-black bg-opacity-60 z-10"></div>
    {% endif %}
    
    <!-- Content Overlay -->
    <div class="relative z-20 text-center text-white max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Breadcrumbs -->
        <nav class="mb-6" aria-label="Breadcrumb" data-gsap="breadcrumb">
            <ol class="flex flex-wrap items-center justify-center gap-x-4 gap-y-2 text-sm opacity-80">
                <li><a href="{{ base_path }}/" class="hover:text-white transition-colors">{{ trans('nav.home') }}</a></li>
                <li><span class="mx-2">/</span></li>
                <li><a href="{{ base_path }}/category/{{ album.category_slug }}" class="hover:text-white transition-colors">{{ album.category_name|e }}</a></li>
                <li><span class="mx-2">/</span></li>
                <li class="text-white font-medium" aria-current="page">{{ album.title|e }}</li>
            </ol>
        </nav>

        <h1 class="text-4xl md:text-6xl font-light mb-6" data-gsap="hero-title">
            {{ album.title|e }}
        </h1>

        {% if album.excerpt %}
        <p class="text-xl md:text-2xl mb-8 opacity-90 leading-relaxed" data-gsap="hero-excerpt">
            {{ album.excerpt|e }}
        </p>
        {% endif %}

        <!-- Categories, Tags, Location in hero -->
        <div class="flex flex-wrap justify-center gap-6 text-sm mb-6 opacity-80" data-gsap="hero-meta">
            {% if album.categories is defined and album.categories|length > 0 %}
            <div class="flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                </svg>
                {% for cat in album.categories %}
                    <a href="{{ base_path }}/category/{{ cat.slug }}" class="hover:text-white transition-colors mr-2">{{ cat.name }}</a>{% if not loop.last %}<span class="text-gray-300">•</span>{% endif %}
                {% endfor %}
            </div>
            {% endif %}
            
            {% if album.locations is defined and album.locations|length > 0 %}
            <div class="flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm0 0c-4.418 0-8 3.582-8 8 2.5-2 5.333-3 8-3s5.5 1 8 3c0-4.418-3.582-8-8-8z"/>
                </svg>
                {% for loc in album.locations %}
                  <span class="mr-1">{{ loc.name }}</span>{% if not loop.last %}<span class="text-gray-300">•</span>{% endif %}
                {% endfor %}
            </div>
            {% endif %}
            
            {% if album.shoot_date %}
            <div class="flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <time datetime="{{ album.shoot_date }}">{{ album.shoot_date|date('F Y') }}</time>
            </div>
            {% endif %}
            
            <div class="flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                {{ trans('album.photo_count', {count: album.images_count}) }}
            </div>
        </div>

        {% if album.tags %}
        <div class="flex flex-wrap justify-center gap-2" data-gsap="hero-tags">
            {% for tag in album.tags %}
            <a href="{{ base_path }}/tag/{{ tag.slug }}" class="text-xs text-white hover:text-gray-300 border border-white border-opacity-30 rounded px-2 py-1 transition-colors hover:border-opacity-50">
                #{{ tag.name|e }}
            </a>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Regular content below hero -->
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
{% else %}
<!-- Template Album 1 - Classic Header -->
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Breadcrumbs -->
    <nav class="mb-6" aria-label="Breadcrumb">
        <ol class="flex flex-wrap items-center gap-x-4 gap-y-2 text-sm text-gray-600">
            <li><a href="{{ base_path }}/" class="hover:text-black transition-colors">{{ trans('nav.home') }}</a></li>
            <li><span class="mx-2 text-gray-400">/</span></li>
            <li><a href="{{ base_path }}/category/{{ album.category_slug }}" class="hover:text-black transition-colors">{{ album.category_name|e }}</a></li>
            <li><span class="mx-2 text-gray-400">/</span></li>
            <li class="text-gray-900 font-medium" aria-current="page">{{ album.title|e }}</li>
        </ol>
    </nav>
    
    <!-- Album header -->
    <div class="max-w-4xl mx-auto text-center pb-12">
        <div class="mb-4" data-gsap="category">
            <a href="{{ base_path }}/category/{{ album.category_slug }}" class="text-sm text-neutral-600 hover:text-black transition-colors">
                {{ album.category_name|e }}
            </a>
        </div>

        <h1 class="text-3xl md:text-4xl font-light text-black mb-6" data-gsap="title">
            {{ album.title|e }}
        </h1>

        {% if album.excerpt %}
        <p class="text-lg text-neutral-600 leading-relaxed mb-6" data-gsap="excerpt">
            {{ album.excerpt|e }}
        </p>
        {% endif %}

        <div class="flex flex-wrap justify-center gap-4 text-sm text-neutral-500 mb-6" data-gsap="meta">
            {% if album.shoot_date %}
            <div class="flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <time datetime="{{ album.shoot_date }}">{{ album.shoot_date|date('F Y') }}</time>
            </div>
            {% endif %}
            {% if album.locations is defined and album.locations|length > 0 %}
            <div class="flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm0 0c-4.418 0-8 3.582-8 8 2.5-2 5.333-3 8-3s5.5 1 8 3c0-4.418-3.582-8-8-8z"/>
                </svg>
                {% for loc in album.locations %}
                  <span class="mr-1">{{ loc.name }}</span>{% if not loop.last %}<span class="text-neutral-400">•</span>{% endif %}
                {% endfor %}
            </div>
            {% endif %}
            
            <div class="flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                {{ trans('album.photo_count', {count: album.images_count}) }}
            </div>
        </div>

        {% if album.tags %}
        <div class="flex flex-wrap justify-center gap-2" data-gsap="tags">
            {% for tag in album.tags %}
            <a href="{{ base_path }}/tag/{{ tag.slug }}" class="text-xs text-neutral-500 hover:text-black border border-neutral-200 rounded px-2 py-1 transition-colors">
                #{{ tag.name|e }}
            </a>
            {% endfor %}
        </div>
        {% endif %}

        {# Custom fields display (show_in_gallery=1) #}
        {% if album_custom_fields is defined and album_custom_fields|length > 0 %}
        <div class="flex flex-wrap justify-center gap-3 mt-4 text-sm text-neutral-600" data-gsap="custom-fields">
            {% for typeId, field in album_custom_fields %}
                {% if field.show_in_gallery and field.values|length > 0 %}
                    <span class="inline-flex items-center">
                        <i class="fas {{ field.icon|default('fa-tag') }} mr-1 text-neutral-400"></i>
                        {% for valueData in field.values %}
                            {{ valueData.value|e }}{% if not loop.last %}, {% endif %}
                        {% endfor %}
                    </span>
                {% endif %}
            {% endfor %}
        </div>
        {% endif %}

        {# Hook: frontend_album_header_meta - Add custom metadata to album header (e.g., equipment, film info) #}
        {{ do_action('frontend_album_header_meta', {album: album, base_path: base_path}) }}
    </div>
{% endif %}

    {# Hook: frontend_album_header_after - After album header section #}
    {{ do_action('frontend_album_header_after', {album: album, base_path: base_path}) }}

    <!-- Album body -->
    {% if album.body %}
    <div class="max-w-3xl mx-auto prose prose-neutral mb-12" data-gsap="body">
        {{ album.body|safe_html }}
    </div>
    {% endif %}

    {# Hook: frontend_album_content_after - After album body content (add custom sections like equipment details) #}
    {{ do_action('frontend_album_content_after', {album: album, base_path: base_path}) }}

    {# Hook: frontend_album_gallery_before - Before images gallery #}
    {{ do_action('frontend_album_gallery_before', {album: album, images: images, base_path: base_path}) }}

    <!-- Images gallery -->
    {% import 'frontend/_seo_macros.twig' as Seo %}
    {% import 'frontend/_caption.twig' as Caption %}

    {% set tpl_slug = template_settings.template_slug|default('') %}
    {% set layout = template_settings.layout|default('grid') %}
    {% set cols = template_settings.columns|default({desktop: 3, tablet: 2, mobile: 1}) %}
    {% set gap = template_settings.gap|default({horizontal: 16, vertical: 16}) %}
    {% set aspect_ratio = template_settings.aspect_ratio|default('1:1') %}
    {% set style = template_settings.style|default({rounded: false, shadow: false, hover_scale: true}) %}

    {# Normalize column values #}
    {% set desktop_cols = cols.desktop|default(3)|round %}
    {% set tablet_cols = cols.tablet|default(2)|round %}
    {% set mobile_cols = cols.mobile|default(1)|round %}
    {% set gap_h = gap.horizontal|default(16)|round %}
    {% set gap_v = gap.vertical|default(16)|round %}

    {# Aspect ratio class for grid layout #}
    {% set aspect_class = 'aspect-square' %}
    {% if aspect_ratio == '4:3' %}
        {% set aspect_class = 'aspect-[4/3]' %}
    {% elseif aspect_ratio == '16:9' %}
        {% set aspect_class = 'aspect-video' %}
    {% elseif aspect_ratio == '3:2' %}
        {% set aspect_class = 'aspect-[3/2]' %}
    {% endif %}

    {# Style classes #}
    {% set rounded_class = style.rounded ? 'rounded-lg' : '' %}
    {% set shadow_class = style.shadow ? 'shadow-md hover:shadow-xl' : '' %}
    {% set hover_class = style.hover_scale ? 'group-hover:scale-105' : '' %}

    {# Creative Layout (template 6) #}
    {% if tpl_slug == 'grid-ampia' %}
        {% include 'frontend/_gallery_creative_layout.twig' with { images: images, template_settings: template_settings, album: album, base_path: base_path, site_title: site_title } %}

    {# Gallery Wall Scroll layout #}
    {% elseif tpl_slug == 'gallery-wall-scroll' %}
        {% include 'frontend/_gallery_wall_scroll.twig' with { images: images, template_settings: template_settings, album: album, base_path: base_path, site_title: site_title } %}

    {# Masonry Portfolio layout (template 2) - dedicated Masonry setup #}
    {% elseif tpl_slug == 'masonry-portfolio' %}
        {% include 'frontend/_gallery_masonry_portfolio.twig' with { images: images, template_settings: template_settings, album: album, base_path: base_path, site_title: site_title } %}

    {# Magazine layout - special handling, NOT unified #}
    {% elseif layout == 'magazine' %}
        <div id="images-gallery" class="mt-6" data-layout="magazine" data-hover-fade="{{ style.hover_fade is not defined or style.hover_fade ? '1' : '0' }}">
            {% include 'frontend/_gallery_magazine_content.twig' with { images: images, template_settings: template_settings, album: album } %}
        </div>

    {# Dense Grid layout - CSS Grid with auto-flow dense (fills gaps automatically) #}
    {% elseif layout == 'dense_grid' %}
        {% set dense = template_settings.dense_grid|default({}) %}
        {% set minCell = dense.minCellDesktop|default(250) %}
        {% set rowHeight = dense.rowHeight|default(200) %}
        {% set gridGap = dense.gap|default(10) %}

        <style nonce="{{ csp_nonce() }}">
        /* Dense Grid - CSS Grid with auto-flow dense */
        .dense-grid {
            display: grid;
            grid-gap: {{ gridGap }}px;
            grid-template-columns: repeat(auto-fit, minmax({{ minCell }}px, 1fr));
            grid-auto-rows: {{ rowHeight }}px;
            grid-auto-flow: dense;
            padding: {{ gridGap }}px;
        }
        .dense-grid > div {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }
        .dense-grid > div > a {
            display: block;
            width: 100%;
            height: 100%;
        }
        .dense-grid > div > a > picture {
            display: block;
            width: 100%;
            height: 100%;
        }
        .dense-grid > div > a > picture > img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 5px;
            transition: transform 0.3s ease;
        }
        .dense-grid > div:hover > a > picture > img {
            transform: scale(1.03);
        }
        /* Spanning classes based on aspect ratio */
        .dense-grid .wide { grid-column: span 2; }
        .dense-grid .tall { grid-row: span 2; }
        .dense-grid .big { grid-column: span 2; grid-row: span 2; }
        /* Mobile - disable spanning */
        @media (max-width: 640px) {
            .dense-grid { grid-template-columns: repeat(2, 1fr); grid-auto-rows: 150px; }
            .dense-grid .wide, .dense-grid .tall, .dense-grid .big { grid-column: span 1; grid-row: span 1; }
        }
        </style>

        <div id="images-gallery" class="dense-grid pswp-gallery" data-layout="dense_grid" data-hover-fade="{{ style.hover_fade is not defined or style.hover_fade ? '1' : '0' }}">
            {% for image in images %}
            {# Calculate aspect ratio and assign class server-side #}
            {% set w = image.width|default(1) %}
            {% set h = image.height|default(1) %}
            {% set ratio = w / h %}
            {% set sizeClass = '' %}
            {# wide: landscape > 1.5, tall: portrait < 0.67, big: every 7th large image #}
            {% if ratio > 1.6 %}
                {% set sizeClass = 'wide' %}
            {% elseif ratio < 0.625 %}
                {% set sizeClass = 'tall' %}
            {% elseif loop.index % 7 == 0 and w > 1500 %}
                {% set sizeClass = 'big' %}
            {% endif %}
            <div class="{{ sizeClass }}">
                {% set lightbox_href = image.lightbox_url|default(image.original_path) %}
                {% set seo_title = Seo.seo_title(image, album, site_title)|trim %}
                <a href="{% if lightbox_href starts with '/' %}{{ base_path }}{{ lightbox_href }}{% else %}{{ lightbox_href }}{% endif %}"
                   class="pswp-link"
                   title="{{ seo_title|e('html_attr') }}"
                   data-image-id="{{ image.id }}"
                   data-pswp-width="{{ image.width }}"
                   data-pswp-height="{{ image.height }}"
                   data-pswp-caption="{{ Caption.build(image)|e('html_attr') }}"
                   data-title="{{ image.caption|default('')|e }}"
                   data-alt="{{ image.alt_text|default(image.alt)|default('')|e }}"
                   data-camera="{{ image.custom_camera|default(image.camera_name)|default('')|e }}"
                   data-lens="{{ image.custom_lens|default(image.lens_name)|default('')|e }}"
                   data-film="{{ image.custom_film|default(image.film_name)|default('')|e }}"
                   data-developer="{{ image.developer_name|default('')|e }}"
                   data-lab="{{ image.lab_name|default('')|e }}"
                   data-location="{{ image.location_name|default('')|e }}"
                   data-iso="{{ image.iso|default('') }}"
                   data-shutter="{{ image.shutter_speed|default('')|e }}"
                   data-aperture="{{ image.aperture|default('') }}"
                   data-focal-length="{{ image.focal_length|default('') }}"
                   {% if image.custom_fields is defined and image.custom_fields|length > 0 %}data-custom-fields="{{ image.custom_fields|json_encode|e('html_attr') }}"{% endif %}>
                    <picture>
                        {% set variants_avif = [] %}
                        {% set variants_webp = [] %}
                        {% set variants_jpg = [] %}
                        {% set best_jpg_path = image.original_path starts with '/' ? base_path ~ image.original_path : image.original_path %}
                        {% set best_jpg_w = 0 %}
                        {% for variant in image.variants %}
                            {% set variant_url = variant.path starts with '/' ? base_path ~ variant.path : variant.path %}
                            {% if variant.format == 'avif' %}
                                {% set variants_avif = variants_avif|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
                            {% elseif variant.format == 'webp' %}
                                {% set variants_webp = variants_webp|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
                            {% elseif variant.format == 'jpg' %}
                                {% set variants_jpg = variants_jpg|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
                                {% if variant.width > best_jpg_w %}
                                    {% set best_jpg_path = variant_url %}
                                    {% set best_jpg_w = variant.width %}
                                {% endif %}
                            {% endif %}
                        {% endfor %}

                        {% if variants_avif %}
                            <source type="image/avif" srcset="{{ variants_avif|join(', ') }}" sizes="(min-width: 1200px) 33vw, (min-width: 768px) 50vw, 100vw">
                        {% endif %}
                        {% if variants_webp %}
                            <source type="image/webp" srcset="{{ variants_webp|join(', ') }}" sizes="(min-width: 1200px) 33vw, (min-width: 768px) 50vw, 100vw">
                        {% endif %}

                        <img src="{{ best_jpg_path }}"
                             alt="{{ image.alt_text|default(image.alt)|default('')|e }}"
                             title="{{ seo_title|e('html_attr') }}"
                             loading="lazy"
                             decoding="async"
                             data-fallback="hide">
                    </picture>
                </a>
            </div>
            {% endfor %}
        </div>

    {# Masonry layout - uses @masonry-grid/vanilla for Pinterest-style waterfall #}
    {% elseif layout == 'masonry' %}
        <style nonce="{{ csp_nonce() }}">
        /* Modern Masonry Grid using @masonry-grid/vanilla */
        /* The library uses translateY(%) for positioning - margin doesn't work! */
        /* Gaps are created via inset on the inner container per library docs */
        .gallery-masonry {
            --masonry-gap-v: {{ gap_v }}px;
            --masonry-gap-h: {{ gap_h }}px;
            display: grid;
            column-gap: var(--masonry-gap-h);
            grid-template-columns: repeat({{ mobile_cols }}, 1fr);
            align-items: start; /* Required: items need natural height for masonry transforms */
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .gallery-masonry.masonry-ready {
            opacity: 1;
        }
        @media (min-width: 768px) {
            .gallery-masonry {
                grid-template-columns: repeat({{ tablet_cols }}, 1fr);
            }
        }
        @media (min-width: 1024px) {
            .gallery-masonry {
                grid-template-columns: repeat({{ desktop_cols }}, 1fr);
            }
        }
        /* Frame: NO overflow:hidden per library docs (breaks aspect-ratio calc) */
        .gallery-masonry .masonry-frame {
            position: relative;
            aspect-ratio: var(--width) / var(--height);
            /* No margin-bottom - translateY% ignores margins */
        }
        /* Inner container uses inset to create vertical gaps */
        /* Each item has gap/2 on top and bottom = gap between items */
        .gallery-masonry .masonry-frame > .frame-content {
            position: absolute;
            inset: calc(var(--masonry-gap-v) / 2) 0;
            overflow: hidden;
        }
        .gallery-masonry .masonry-frame img {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        .gallery-masonry .masonry-frame:hover img {
            transform: scale(1.03);
        }
        .no-js .gallery-masonry {
            opacity: 1 !important;
        }
        @media (prefers-reduced-motion: reduce) {
            .gallery-masonry { opacity: 1 !important; transition: none !important; }
            .gallery-masonry .masonry-frame img { transition: none !important; }
        }
        </style>

        <div id="images-gallery"
             class="gallery-masonry pswp-gallery"
             data-layout="masonry"
             data-gap-h="{{ gap_h }}"
             data-gap-v="{{ gap_v }}"
             data-cols-desktop="{{ desktop_cols }}"
             data-cols-tablet="{{ tablet_cols }}"
             data-cols-mobile="{{ mobile_cols }}"
             data-rounded="{{ style.rounded ? '1' : '0' }}"
             data-shadow="{{ style.shadow ? '1' : '0' }}"
             data-hover-fade="{{ style.hover_fade is not defined or style.hover_fade ? '1' : '0' }}">
            {% for image in images %}
                {# Calculate aspect ratio for CSS variable #}
                {% set imgW = image.width|default(4) %}
                {% set imgH = image.height|default(3) %}
                <div class="masonry-frame" style="--width: {{ imgW }}; --height: {{ imgH }};">
                    <div class="frame-content group {{ rounded_class }} {{ shadow_class }}">
                        {% set lightbox_href = image.lightbox_url|default(image.original_path) %}
                        {% set seo_title = Seo.seo_title(image, album, site_title)|trim %}
                        <a href="{% if lightbox_href starts with '/' %}{{ base_path }}{{ lightbox_href }}{% else %}{{ lightbox_href }}{% endif %}"
                           class="pswp-link gallery-link block w-full h-full overflow-hidden bg-neutral-100 cursor-pointer {{ rounded_class }}"
                           title="{{ seo_title|e('html_attr') }}"
                           data-image-id="{{ image.id }}"
                           data-pswp-width="{{ image.width }}"
                           data-pswp-height="{{ image.height }}"
                           data-pswp-caption="{{ Caption.build(image)|e('html_attr') }}"
                           data-title="{{ image.caption|default('')|e }}"
                           data-alt="{{ image.alt_text|default(image.alt)|default('')|e }}"
                           data-camera="{{ image.custom_camera|default(image.camera_name)|default('')|e }}"
                           data-lens="{{ image.custom_lens|default(image.lens_name)|default('')|e }}"
                           data-film="{{ image.custom_film|default(image.film_name)|default('')|e }}"
                           data-developer="{{ image.developer_name|default('')|e }}"
                           data-lab="{{ image.lab_name|default('')|e }}"
                           data-location="{{ image.location_name|default('')|e }}"
                           data-iso="{{ image.iso|default('') }}"
                           data-shutter="{{ image.shutter_speed|default('')|e }}"
                           data-aperture="{{ image.aperture|default('') }}"
                           data-focal-length="{{ image.focal_length|default('') }}"
                           {% if image.custom_fields is defined and image.custom_fields|length > 0 %}data-custom-fields="{{ image.custom_fields|json_encode|e('html_attr') }}"{% endif %}>
                            <picture>
                                {% set variants_avif = [] %}
                                {% set variants_webp = [] %}
                                {% set variants_jpg = [] %}
                                {% set best_jpg_path = image.original_path starts with '/' ? base_path ~ image.original_path : image.original_path %}
                                {% set best_jpg_w = 0 %}
                                {% for variant in image.variants %}
                                    {% set variant_url = variant.path starts with '/' ? base_path ~ variant.path : variant.path %}
                                    {% if variant.format == 'avif' %}
                                        {% set variants_avif = variants_avif|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
                                    {% elseif variant.format == 'webp' %}
                                        {% set variants_webp = variants_webp|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
                                    {% elseif variant.format == 'jpg' %}
                                        {% set variants_jpg = variants_jpg|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
                                        {% if variant.width > best_jpg_w %}
                                            {% set best_jpg_path = variant_url %}
                                            {% set best_jpg_w = variant.width %}
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}

                                {% if variants_avif %}
                                    <source type="image/avif" srcset="{{ variants_avif|join(', ') }}" sizes="(min-width: 1200px) 33vw, (min-width: 768px) 50vw, 100vw">
                                {% endif %}
                                {% if variants_webp %}
                                    <source type="image/webp" srcset="{{ variants_webp|join(', ') }}" sizes="(min-width: 1200px) 33vw, (min-width: 768px) 50vw, 100vw">
                                {% endif %}

                                <img src="{{ best_jpg_path }}"
                                     alt="{{ image.alt_text|default(image.alt)|default('')|e }}"
                                     title="{{ seo_title|e('html_attr') }}"
                                     loading="lazy"
                                     decoding="async"
                                     data-fallback="hide">
                            </picture>
                            {% if album.allow_downloads %}
                                <button type="button"
                                        class="absolute top-3 right-3 bg-black/60 text-white p-2.5 opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-10 cursor-pointer {{ rounded_class }}"
                                        title="{{ trans('image.download') }}"
                                        data-action="download-image"
                                        data-download-url="{{ base_path }}/download/image/{{ image.id }}">
                                    <i class="fa-solid fa-arrow-down text-sm"></i>
                                </button>
                            {% endif %}
                            {% if image.caption %}
                                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent text-white text-sm p-4 pt-8 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                    {{ image.caption|e }}
                                </div>
                            {% endif %}
                        </a>
                    </div>
                </div>
            {% endfor %}
            {# Empty div for masonry-grid internal calculations #}
            <div></div>
        </div>

    {# Grid layout - CSS Grid with fixed aspect ratios #}
    {% else %}
        <style nonce="{{ csp_nonce() }}">
        .gallery-grid {
            display: grid;
            gap: {{ gap_v }}px {{ gap_h }}px;
        }
        @media (min-width: 1024px) {
            .gallery-grid { grid-template-columns: repeat({{ desktop_cols }}, 1fr); }
        }
        @media (min-width: 768px) and (max-width: 1023px) {
            .gallery-grid { grid-template-columns: repeat({{ tablet_cols }}, 1fr); }
        }
        @media (max-width: 767px) {
            .gallery-grid { grid-template-columns: repeat({{ mobile_cols }}, 1fr); }
        }
        </style>

        <div id="images-gallery"
             class="gallery-grid pswp-gallery"
             data-layout="grid"
             data-gap-h="{{ gap_h }}"
             data-gap-v="{{ gap_v }}"
             data-cols-desktop="{{ desktop_cols }}"
             data-cols-tablet="{{ tablet_cols }}"
             data-cols-mobile="{{ mobile_cols }}"
             data-aspect-ratio="{{ aspect_ratio }}"
             data-hover-fade="{{ style.hover_fade is not defined or style.hover_fade ? '1' : '0' }}">
            {% for image in images %}
                <div class="gallery-item">
                    {% set lightbox_href = image.lightbox_url|default(image.original_path) %}
                    {% set seo_title = Seo.seo_title(image, album, site_title)|trim %}
                    <a href="{% if lightbox_href starts with '/' %}{{ base_path }}{{ lightbox_href }}{% else %}{{ lightbox_href }}{% endif %}"
                       class="pswp-link gallery-link group block overflow-hidden bg-neutral-100 cursor-pointer {{ aspect_class }} {{ rounded_class }} {{ shadow_class }}"
                       title="{{ seo_title|e('html_attr') }}"
                       data-image-id="{{ image.id }}"
                       data-pswp-width="{{ image.width }}"
                       data-pswp-height="{{ image.height }}"
                       data-pswp-caption="{{ Caption.build(image)|e('html_attr') }}"
                       data-title="{{ image.caption|default('')|e }}"
                       data-alt="{{ image.alt_text|default(image.alt)|default('')|e }}"
                       data-camera="{{ image.custom_camera|default(image.camera_name)|default('')|e }}"
                       data-lens="{{ image.custom_lens|default(image.lens_name)|default('')|e }}"
                       data-film="{{ image.custom_film|default(image.film_name)|default('')|e }}"
                       data-developer="{{ image.developer_name|default('')|e }}"
                       data-lab="{{ image.lab_name|default('')|e }}"
                       data-location="{{ image.location_name|default('')|e }}"
                       data-iso="{{ image.iso|default('') }}"
                       data-shutter="{{ image.shutter_speed|default('')|e }}"
                       data-aperture="{{ image.aperture|default('') }}"
                       data-focal-length="{{ image.focal_length|default('') }}"
                       {% if image.custom_fields is defined and image.custom_fields|length > 0 %}data-custom-fields="{{ image.custom_fields|json_encode|e('html_attr') }}"{% endif %}>
                        <picture>
                            {% set variants_avif = [] %}
                            {% set variants_webp = [] %}
                            {% set variants_jpg = [] %}
                            {% set best_jpg_path = image.original_path starts with '/' ? base_path ~ image.original_path : image.original_path %}
                            {% set best_jpg_w = 0 %}
                            {% for variant in image.variants %}
                                {% set variant_url = variant.path starts with '/' ? base_path ~ variant.path : variant.path %}
                                {% if variant.format == 'avif' %}
                                    {% set variants_avif = variants_avif|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
                                {% elseif variant.format == 'webp' %}
                                    {% set variants_webp = variants_webp|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
                                {% elseif variant.format == 'jpg' %}
                                    {% set variants_jpg = variants_jpg|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
                                    {% if variant.width > best_jpg_w %}
                                        {% set best_jpg_path = variant_url %}
                                        {% set best_jpg_w = variant.width %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}

                            {% if variants_avif %}
                                <source type="image/avif" srcset="{{ variants_avif|join(', ') }}" sizes="(min-width: 1200px) 33vw, (min-width: 768px) 50vw, 100vw">
                            {% endif %}
                            {% if variants_webp %}
                                <source type="image/webp" srcset="{{ variants_webp|join(', ') }}" sizes="(min-width: 1200px) 33vw, (min-width: 768px) 50vw, 100vw">
                            {% endif %}

                            <img src="{{ best_jpg_path }}"
                                 alt="{{ image.alt_text|default(image.alt)|default('')|e }}"
                                 title="{{ seo_title|e('html_attr') }}"
                                 width="{{ image.width }}"
                                 height="{{ image.height }}"
                                 loading="lazy"
                                 decoding="async"
                                 data-fallback="hide"
                                 class="w-full h-full object-cover transition-transform duration-300 {{ hover_class }}">
                        </picture>
                        {% if album.allow_downloads %}
                            <button type="button"
                                    class="absolute top-3 right-3 bg-black/60 text-white p-2.5 opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-10 cursor-pointer {{ rounded_class }}"
                                    title="{{ trans('image.download') }}"
                                    data-action="download-image"
                                    data-download-url="{{ base_path }}/download/image/{{ image.id }}">
                                <i class="fa-solid fa-arrow-down text-sm"></i>
                            </button>
                        {% endif %}
                        {% if image.caption %}
                            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent text-white text-sm p-4 pt-8 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                {{ image.caption|e }}
                            </div>
                        {% endif %}
                    </a>
                </div>
            {% endfor %}
        </div>
    {% endif %}
    
    {% if images|length == 0 %}
    <div class="text-center py-20">
        <h2 class="text-2xl font-light text-neutral-600 mb-4">{{ trans('album.empty') }}</h2>
        <p class="text-neutral-500">{{ trans('album.empty_message') }}</p>
    </div>
    {% endif %}
    
    <!-- Image filters (if multiple formats/processes) -->
    {# processes and cameras are computed in controller for compatibility #}
    {% if processes|length > 1 or cameras|length > 1 %}
    <div class="mt-8 p-4 bg-neutral-50 rounded">
        <h3 class="text-sm font-medium mb-3">{{ trans('filter.filter_images') }}</h3>
        <div class="flex flex-wrap gap-4 text-sm">
            {% if processes|length > 1 %}
            <div class="flex items-center space-x-2">
                <label for="image-filter-process">{{ trans('filter.process') }}:</label>
                <select id="image-filter-process" class="border border-neutral-300 rounded px-2 py-1 text-xs">
                    <option value="">{{ trans('filter.all') }}</option>
                    {% for process in processes %}
                    <option value="{{ process }}">{{ process|title }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            
            {% if cameras|length > 1 %}
            <div class="flex items-center space-x-2">
                <label for="image-filter-camera">{{ trans('album.camera') }}:</label>
                <select id="image-filter-camera" class="border border-neutral-300 rounded px-2 py-1 text-xs">
                    <option value="">{{ trans('filter.all') }}</option>
                    {% for camera in cameras %}
                    <option value="{{ camera }}">{{ camera }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            
            <button id="apply-image-filters" class="bg-black text-white px-3 py-1 text-xs rounded hover:bg-neutral-800">
                {{ trans('filter.apply') }}
            </button>
        </div>
    </div>
    {% endif %}

    {# Hook: frontend_album_gallery_after - After images gallery (add custom content below images) #}
    {{ do_action('frontend_album_gallery_after', {album: album, images: images, base_path: base_path}) }}

</div>

{# Hook: frontend_album_related_before - Before related albums section #}
{{ do_action('frontend_album_related_before', {album: album, related_albums: related_albums, base_path: base_path}) }}

<!-- Related albums -->
{% if related_albums|length > 0 %}
<section class="border-t border-neutral-200 mt-16 pt-16" data-gsap="related-section">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h2 class="text-2xl font-light text-center mb-12" data-gsap="related-title">{{ trans('album.more_from', {category: album.category_name}) }}</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" data-gsap="related-grid">
            {% for related in related_albums %}
                {% include "frontend/_album_card.twig" with {'album': related} %}
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

{# Hook: frontend_album_related_after - After related albums section #}
{{ do_action('frontend_album_related_after', {album: album, related_albums: related_albums, base_path: base_path}) }}

{# Hook: frontend_album_after - After entire album page (for modals, scripts, etc.) #}
{{ do_action('frontend_album_after', {album: album, images: images, base_path: base_path}) }}
</div>{# End album-main-content #}

{% endblock %}

{% block scripts %}
<script nonce="{{ csp_nonce() }}">
// Global base path for API calls
window.basePath = '{{ base_path }}';

// Template settings (also expose globally for template switcher)
const templateSettings = {{ template_settings ? template_settings|json_encode|raw : '{}' }};
window.templateSettings = templateSettings;
const layout = templateSettings.layout || 'grid';
const templateSlug = templateSettings.template_slug || '';

/**
 * Masonry Portfolio initialization using Masonry + imagesLoaded
 */
function initMasonryPortfolio(containerOrSelector) {
    const grid = typeof containerOrSelector === 'string'
        ? document.querySelector(containerOrSelector)
        : containerOrSelector || document.querySelector('.masonry-portfolio-grid');

    if (!grid || typeof Masonry === 'undefined' || typeof imagesLoaded === 'undefined') return null;
    if (grid._masonryPortfolioInitialized) return grid._masonryPortfolioInstance;

    const gapH = parseInt(grid.dataset.gapH || '16', 10);
    const mpType = (window.templateSettings?.masonry_portfolio?.type || 'balanced');
    const horizontalOrder = mpType === 'regular';

    if (grid._masonryPortfolioInstance) {
        grid._masonryPortfolioInstance.destroy();
        grid._masonryPortfolioInstance = null;
    }

    grid._masonryPortfolioInitialized = true;
    grid._masonryPortfolioInstance = new Masonry(grid, {
        itemSelector: '.photo-item',
        columnWidth: '.grid-sizer',
        gutter: gapH,
        percentPosition: true,
        horizontalOrder: horizontalOrder,
        transitionDuration: '0.3s'
    });

    imagesLoaded(grid).on('progress', function(instance, image) {
        const img = image.img || null;
        if (img) {
            img.classList.add('is-loaded');
            const item = img.closest('.photo-item');
            if (item) item.classList.add('is-loaded');
        }
        grid._masonryPortfolioInstance.layout();
    });

    if (!grid._masonryPortfolioResizeHandler) {
        grid._masonryPortfolioResizeHandler = function() {
            clearTimeout(grid._masonryPortfolioResizeTimer);
            grid._masonryPortfolioResizeTimer = setTimeout(() => {
                if (grid._masonryPortfolioInstance) {
                    grid._masonryPortfolioInstance.layout();
                }
            }, 200);
        };
        window.addEventListener('resize', grid._masonryPortfolioResizeHandler);
    }

    return grid._masonryPortfolioInstance;
}

window.initMasonryPortfolio = initMasonryPortfolio;

function initCreativeLayout(containerOrSelector) {
    const container = typeof containerOrSelector === 'string'
        ? document.querySelector(containerOrSelector)
        : containerOrSelector || document.querySelector('.creative-gallery');

    if (!container) return;
    const images = container.querySelectorAll('img');
    images.forEach((img) => {
        if (img.complete) {
            img.classList.add('loaded');
            const loading = img.closest('.img-container')?.querySelector('.loading');
            if (loading) loading.remove();
        } else {
            img.addEventListener('load', function() {
                img.classList.add('loaded');
                const loading = img.closest('.img-container')?.querySelector('.loading');
                if (loading) loading.remove();
            }, { once: true });
        }
    });

    if (!container._creativeHoverBound) {
        container._creativeHoverBound = true;
        document.addEventListener('mousemove', function(e) {
            const hovers = container.querySelectorAll('.img-content-hover');
            hovers.forEach(function(element) {
                if (element.style.display === 'block' || window.getComputedStyle(element).display === 'block') {
                    const x = e.pageX + 20;
                    const y = e.pageY + 20;
                    element.style.transform = `translate3d(${x}px, ${y}px, 0)`;
                }
            });
        });
    }
}

window.initCreativeLayout = initCreativeLayout;

function initGalleryWallScroll(containerOrSelector) {
    const container = typeof containerOrSelector === 'string'
        ? document.querySelector(containerOrSelector)
        : containerOrSelector || document.querySelector('.gallery-wall');

    if (!container) return;

    document.body.classList.add('gallery-wall-page');

    const section = container.querySelector('#galleryWallSection') || container.querySelector('.gallery-wall-section');
    const track = container.querySelector('#galleryWallTrack') || container.querySelector('.gallery-wall-track');
    if (!section || !track) return;

    if (container._wallScrollCleanup) {
        container._wallScrollCleanup();
    }

    let maxScroll = 0;
    const isMobile = () => window.matchMedia('(max-width: 768px)').matches;

    function updateMetrics() {
        const trackWidth = track.scrollWidth;
        const windowWidth = window.innerWidth;
        const windowHeight = window.innerHeight;
        maxScroll = Math.max(0, trackWidth - windowWidth);
        const sectionHeight = maxScroll + windowHeight;
        section.style.height = sectionHeight + 'px';
    }

    function updateTrack() {
        if (isMobile()) {
            track.style.transform = 'translateX(0px)';
            return;
        }
        const rect = section.getBoundingClientRect();
        const sectionScrollHeight = section.offsetHeight - window.innerHeight;
        const scrollInSection = Math.max(0, -rect.top);
        const progress = sectionScrollHeight > 0 ? Math.min(1, scrollInSection / sectionScrollHeight) : 0;
        track.style.transform = `translateX(${-progress * maxScroll}px)`;
    }

    const onScroll = () => requestAnimationFrame(updateTrack);
    const onResize = () => {
        updateMetrics();
        updateTrack();
        if (window.lenisResize) setTimeout(window.lenisResize, 100);
    };
    let dragActive = false;
    let dragStartX = 0;
    let dragStartScroll = 0;
    let dragSectionStart = 0;
    const startDrag = (clientX) => {
        if (isMobile() || maxScroll === 0) return;
        dragActive = true;
        dragStartX = clientX;
        dragSectionStart = window.scrollY + section.getBoundingClientRect().top;
        dragStartScroll = Math.max(0, window.scrollY - dragSectionStart);
        section.style.cursor = 'grabbing';
    };
    const moveDrag = (clientX, evt) => {
        if (!dragActive || isMobile() || maxScroll === 0) return;
        const dx = clientX - dragStartX;
        const nextScroll = Math.max(0, Math.min(maxScroll, dragStartScroll - dx));
        if (nextScroll !== dragStartScroll) {
            if (evt) evt.preventDefault();
            window.scrollTo({ top: dragSectionStart + nextScroll, left: 0, behavior: 'auto' });
            updateTrack();
        }
    };
    const endDrag = () => {
        if (!dragActive) return;
        dragActive = false;
        section.style.cursor = '';
    };
    const onMouseDown = (e) => {
        if (e.button !== 0) return;
        startDrag(e.clientX);
    };
    const onMouseMove = (e) => {
        if (!dragActive) return;
        moveDrag(e.clientX, e);
    };
    const onMouseUp = () => endDrag();
    const onTouchStart = (e) => {
        if (!e.touches || e.touches.length !== 1) return;
        startDrag(e.touches[0].clientX);
    };
    const onTouchMove = (e) => {
        if (!e.touches || e.touches.length !== 1) return;
        moveDrag(e.touches[0].clientX, e);
    };
    const onTouchEnd = () => endDrag();

    updateMetrics();
    updateTrack();
    window.addEventListener('scroll', onScroll, { passive: true });
    window.addEventListener('resize', onResize);
    section.addEventListener('mousedown', onMouseDown);
    section.addEventListener('mousemove', onMouseMove);
    window.addEventListener('mouseup', onMouseUp);
    section.addEventListener('touchstart', onTouchStart, { passive: true });
    section.addEventListener('touchmove', onTouchMove, { passive: false });
    section.addEventListener('touchend', onTouchEnd);
    section.addEventListener('touchcancel', onTouchEnd);

    container._wallScrollCleanup = () => {
        window.removeEventListener('scroll', onScroll);
        window.removeEventListener('resize', onResize);
        section.removeEventListener('mousedown', onMouseDown);
        section.removeEventListener('mousemove', onMouseMove);
        window.removeEventListener('mouseup', onMouseUp);
        section.removeEventListener('touchstart', onTouchStart);
        section.removeEventListener('touchmove', onTouchMove);
        section.removeEventListener('touchend', onTouchEnd);
        section.removeEventListener('touchcancel', onTouchEnd);
    };
}

window.initGalleryWallScroll = initGalleryWallScroll;

/**
 * Modern Masonry initialization using @masonry-grid/vanilla
 * Uses CSS Grid + percentage-based transforms for efficient layout
 * No pixel calculations needed - browser handles responsiveness natively
 */
function initGalleryMasonry(containerOrSelector) {
    const grid = typeof containerOrSelector === 'string'
        ? document.querySelector(containerOrSelector)
        : containerOrSelector || document.querySelector('.gallery-masonry');

    if (!grid) return null;
    if (grid._masonryInitialized) return grid._masonryInstance;

    // Check if masonry classes are available
    if (typeof BalancedMasonryGrid === 'undefined' && typeof RegularMasonryGrid === 'undefined') {
        console.warn('Masonry classes not loaded, using CSS Grid fallback');
        grid.classList.add('masonry-ready');
        return null;
    }

    grid._masonryInitialized = true;

    // Destroy existing instance if any
    if (grid._masonryInstance) {
        grid._masonryInstance.destroy();
        grid._masonryInstance = null;
    }

    // Choose masonry class based on template settings
    // 'balanced' = BalancedMasonryGrid (reorders items to minimize height)
    // 'regular' = RegularMasonryGrid (maintains DOM order, uses translateY)
    const masonryType = window.templateSettings?.masonry?.type || 'balanced';
    const MasonryClass = masonryType === 'regular' ? RegularMasonryGrid : BalancedMasonryGrid;

    // Create masonry instance - it handles everything!
    // The library uses ResizeObserver and MutationObserver internally
    grid._masonryInstance = new MasonryClass(grid);

    // Show the grid with smooth fade-in
    requestAnimationFrame(() => {
        grid.classList.add('masonry-ready');
        if (window.lenisResize) setTimeout(window.lenisResize, 100);
    });

    return grid._masonryInstance;
}

// Make initGalleryMasonry globally available for template switcher
window.initGalleryMasonry = initGalleryMasonry;

/**
 * Dense Grid initialization - CSS Grid with auto-flow dense
 * Handles adaptive sizing based on image aspect ratios
 */
function initDenseGrid(containerOrSelector) {
    const grid = typeof containerOrSelector === 'string'
        ? document.querySelector(containerOrSelector)
        : containerOrSelector || document.querySelector('.dense-grid');

    if (!grid) return;
    if (grid._denseGridInitialized) return;
    grid._denseGridInitialized = true;

    const adaptive = grid.dataset.adaptive === 'true';

    // Process all items and apply adaptive sizing classes
    const items = grid.querySelectorAll('.dense-grid-item');
    items.forEach(item => {
        const w = parseInt(item.dataset.width, 10) || 0;
        const h = parseInt(item.dataset.height, 10) || 0;

        if (w > 0 && h > 0 && adaptive) {
            const ratio = w / h;
            // Remove existing classes
            item.classList.remove('landscape', 'portrait-tall', 'square-large');

            if (ratio > 1.5) {
                // Wide landscape - span 2 columns
                item.classList.add('landscape');
            } else if (ratio < 0.6) {
                // Tall portrait - span 2 rows
                item.classList.add('portrait-tall');
            } else if (w > 2000 && h > 2000) {
                // Large square-ish - span 2x2
                item.classList.add('square-large');
            }
        }

        // Handle image load event
        const img = item.querySelector('.dense-grid-img');
        if (img) {
            if (img.complete) {
                img.classList.add('loaded');
            } else {
                img.addEventListener('load', function() {
                    img.classList.add('loaded');
                });
                img.addEventListener('error', function() {
                    // No-op: allow broken images to settle without spinner
                });
            }
        }
    });

    // Staggered fade-in animation
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    if (!prefersReducedMotion) {
        items.forEach((item, index) => {
            item.style.opacity = '0';
            item.style.transform = 'translateY(20px)';
            setTimeout(() => {
                item.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
                item.style.opacity = '1';
                item.style.transform = 'translateY(0)';
            }, index * 30);
        });
    }

    if (window.lenisResize) setTimeout(window.lenisResize, 100);
}

// Make initDenseGrid globally available
window.initDenseGrid = initDenseGrid;

// Initialize layout on page load
if (templateSlug === 'grid-ampia') {
    if (document.readyState === 'complete') {
        initCreativeLayout();
    } else {
        window.addEventListener('load', () => initCreativeLayout());
    }
} else if (templateSlug === 'gallery-wall-scroll') {
    if (document.readyState === 'complete') {
        initGalleryWallScroll();
    } else {
        window.addEventListener('load', () => initGalleryWallScroll());
    }
} else if (templateSlug === 'masonry-portfolio') {
    if (document.readyState === 'complete') {
        initMasonryPortfolio();
    } else {
        window.addEventListener('load', () => initMasonryPortfolio());
    }
} else if (layout === 'masonry') {
    if (document.readyState === 'complete') {
        initGalleryMasonry();
    } else {
        window.addEventListener('load', () => initGalleryMasonry());
    }
} else if (layout === 'dense_grid') {
    if (document.readyState === 'complete') {
        initDenseGrid();
    } else {
        window.addEventListener('load', () => initDenseGrid());
    }
}

// Magazine Split autoscroll initializer
function initMagazineAutoscroll() {
    try {
        var container = document.getElementById('images-gallery') || document;
        var isMobile = window.matchMedia('(max-width: 767px)').matches;
        var isTablet = window.matchMedia('(min-width: 768px) and (max-width: 1199px)').matches;
        var isDesktop = window.matchMedia('(min-width: 1200px)').matches;

        var mob = container.querySelector('.m-mobile-wrap');
        var tablet = container.querySelector('.m-tablet-wrap');
        var desk = container.querySelector('.m-desktop-wrap');

        if (mob) mob.style.display = isMobile ? 'block' : 'none';
        if (tablet) tablet.style.display = isTablet ? 'flex' : 'none';
        if (desk) desk.style.display = isDesktop ? 'flex' : 'none';

        var activeWrap = isMobile ? mob : (isTablet ? tablet : desk);
        if (activeWrap) {
            activeWrap.querySelectorAll('source[data-srcset]').forEach(function(source) {
                source.setAttribute('srcset', source.getAttribute('data-srcset'));
                source.removeAttribute('data-srcset');
            });
            activeWrap.querySelectorAll('img[data-src]').forEach(function(img) {
                img.setAttribute('src', img.getAttribute('data-src'));
                img.removeAttribute('data-src');
            });
        }

        var trackOriginals = new WeakMap();
        var ensureTrackFill = function(track, colHeight) {
            if (!track || !colHeight) return;
            var originals = trackOriginals.get(track);
            if (!originals) {
                originals = Array.from(track.children);
                trackOriginals.set(track, originals);
            }
            if (!originals.length) return;
            var minHeight = colHeight * 2;
            var loops = 0;
            while (track.scrollHeight < minHeight && loops < 12) {
                var frag = document.createDocumentFragment();
                originals.forEach(function(node) {
                    var clone = node.cloneNode(true);
                    var link = clone.querySelector && clone.querySelector('a.pswp-link');
                    if (link) link.classList.add('pswp-is-duplicate');
                    frag.appendChild(clone);
                });
                track.appendChild(frag);
                loops += 1;
            }
        };
        var forceEager = function(scope) {
            if (!scope) return;
            scope.querySelectorAll('img[loading="lazy"]').forEach(function(img) {
                img.setAttribute('loading', 'eager');
            });
        };

        container.querySelectorAll('.m-col').forEach(function(col) {
            var track = col.querySelector('.m-track'); if (!track) return;
            ensureTrackFill(track, col.clientHeight || window.innerHeight);
            forceEager(track);
            track.style.animation = 'none';
            track.offsetHeight;
            var dir = (col.getAttribute('data-direction') || 'down').toLowerCase();
            var dur = (getComputedStyle(col).getPropertyValue('--m-duration') || '60s').trim() || '60s';
            var anim = (dir === 'up' ? 'mScrollUp' : 'mScrollDown') + ' ' + dur + ' linear infinite';
            track.style.animation = anim;
            track.style.animationPlayState = '';
        });

        var mobileTrack = container.querySelector('.m-mobile-track');
        if (mobileTrack) {
            var mobWrap = mobileTrack.closest('.m-mobile') || mobileTrack.parentElement;
            ensureTrackFill(mobileTrack, (mobWrap && mobWrap.clientHeight) || window.innerHeight);
            forceEager(mobileTrack);
        }

        var rerun = function() {
            container.querySelectorAll('.m-col').forEach(function(col) {
                var track = col.querySelector('.m-track'); if (!track) return;
                ensureTrackFill(track, col.clientHeight || window.innerHeight);
            });
            var mobTrack = container.querySelector('.m-mobile-track');
            if (mobTrack) {
                var wrap = mobTrack.closest('.m-mobile') || mobTrack.parentElement;
                ensureTrackFill(mobTrack, (wrap && wrap.clientHeight) || window.innerHeight);
            }
        };
        setTimeout(rerun, 200);
        setTimeout(rerun, 800);

        if (!container._magazineDragBound) {
            container._magazineDragBound = true;
            var dragState = { active: false, moved: false, startX: 0, startY: 0, startScroll: 0, sectionTop: 0, col: null };
            var startDrag = function(clientX, clientY, target) {
                dragState.active = true;
                dragState.moved = false;
                dragState.col = target;
                dragState.sectionTop = container.getBoundingClientRect().top + window.scrollY;
                dragState.startX = clientX;
                dragState.startY = clientY;
                dragState.startScroll = window.scrollY;
                target.style.cursor = 'grabbing';
            };
            var moveDrag = function(clientX, clientY, ev) {
                if (!dragState.active) return;
                var dx = clientX - dragState.startX;
                var dy = clientY - dragState.startY;
                if (Math.abs(dy) > Math.abs(dx)) return;
                if (Math.abs(dx) <= 8) return;
                if (!dragState.moved) {
                    dragState.moved = true;
                    document.body.classList.add('magazine-dragging');
                }
                if (ev) ev.preventDefault();
                var nextTop = dragState.startScroll - dx;
                var maxTop = dragState.sectionTop + Math.max(0, container.offsetHeight - window.innerHeight);
                if (nextTop < dragState.sectionTop) nextTop = dragState.sectionTop;
                if (nextTop > maxTop) nextTop = maxTop;
                window.scrollTo({ top: nextTop, left: 0, behavior: 'auto' });
            };
            var endDrag = function() {
                if (!dragState.active) return;
                dragState.active = false;
                if (dragState.col) dragState.col.style.cursor = '';
                dragState.col = null;
                document.body.classList.remove('magazine-dragging');
                if (dragState.moved) {
                    var guard = function(clickEv) {
                        if (container.contains(clickEv.target)) {
                            clickEv.preventDefault();
                            clickEv.stopPropagation();
                        }
                        container.removeEventListener('click', guard, true);
                    };
                    container.addEventListener('click', guard, true);
                }
            };
            var onMouseDown = function(ev) {
                if (ev.button !== 0) return;
                var target = ev.target.closest ? ev.target.closest('.m-col') : null;
                if (!target) return;
                ev.preventDefault();
                startDrag(ev.clientX, ev.clientY, target);
            };
            var onMouseMove = function(ev) { moveDrag(ev.clientX, ev.clientY, ev); };
            var onMouseUp = function() { endDrag(); };
            var onTouchStart = function(ev) {
                if (!ev.touches || ev.touches.length !== 1) return;
                var target = ev.target.closest ? ev.target.closest('.m-col') : null;
                if (!target) return;
                startDrag(ev.touches[0].clientX, ev.touches[0].clientY, target);
            };
            var onTouchMove = function(ev) {
                if (!ev.touches || ev.touches.length !== 1) return;
                moveDrag(ev.touches[0].clientX, ev.touches[0].clientY, ev);
            };
            var onTouchEnd = function() { endDrag(); };
            var onDragStart = function(ev) { ev.preventDefault(); };
            var onWindowBlur = function() { endDrag(); };
            var onVisibility = function() { if (document.hidden) endDrag(); };
            container.addEventListener('mousedown', onMouseDown);
            window.addEventListener('mousemove', onMouseMove);
            window.addEventListener('mouseup', onMouseUp);
            container.addEventListener('touchstart', onTouchStart, { passive: true });
            window.addEventListener('touchmove', onTouchMove, { passive: false });
            window.addEventListener('touchend', onTouchEnd);
            window.addEventListener('touchcancel', onTouchEnd);
            container.addEventListener('dragstart', onDragStart);
            window.addEventListener('blur', onWindowBlur);
            document.addEventListener('visibilitychange', onVisibility);
            container._magazineDragCleanup = function() {
                container.removeEventListener('mousedown', onMouseDown);
                window.removeEventListener('mousemove', onMouseMove);
                window.removeEventListener('mouseup', onMouseUp);
                container.removeEventListener('touchstart', onTouchStart);
                window.removeEventListener('touchmove', onTouchMove);
                window.removeEventListener('touchend', onTouchEnd);
                window.removeEventListener('touchcancel', onTouchEnd);
                container.removeEventListener('dragstart', onDragStart);
                window.removeEventListener('blur', onWindowBlur);
                document.removeEventListener('visibilitychange', onVisibility);
            };
        }
    } catch(e) {
        console.error('initMagazineAutoscroll error:', e);
    }
}

// Initialize magazine if active
if (layout === 'magazine') {
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(initMagazineAutoscroll, 100);
    });
}

// Image filtering
document.getElementById('apply-image-filters')?.addEventListener('click', async function() {
    const albumId = {{ album.id }};
    const process = document.getElementById('image-filter-process')?.value || '';
    const camera = document.getElementById('image-filter-camera')?.value || '';

    const params = new URLSearchParams();
    if (process) params.set('process', process);
    if (camera) params.set('camera', camera);

    try {
        const response = await fetch(`${window.basePath}/api/album/${albumId}/images?${params}`);
        const data = await response.json();

        const gallery = document.getElementById('images-gallery');
        gallery.innerHTML = data.itemsHtml;

        // Re-initialize masonry layout after filter if needed
        if (templateSlug === 'grid-ampia') {
            initCreativeLayout(gallery);
        } else if (templateSlug === 'gallery-wall-scroll') {
            initGalleryWallScroll(gallery);
        } else if (templateSlug === 'masonry-portfolio') {
            initMasonryPortfolio(gallery);
        } else if (layout === 'masonry') {
            initGalleryMasonry(gallery);
        }

        // Animate filtered results
        if (typeof gsap !== 'undefined') {
            const newItems = Array.from(gallery.querySelectorAll('.gallery-item, .photo-item')).filter(n => !n.hasAttribute('data-animated'));
            if (newItems.length > 0) {
                gsap.fromTo(newItems,
                    { opacity: 0, scale: 0.9 },
                    {
                        opacity: 1,
                        scale: 1,
                        duration: 0.35,
                        stagger: { amount: Math.min(0.25, newItems.length * 0.02), from: 'start' },
                        ease: 'power3.out',
                        onComplete: () => newItems.forEach(n => n.setAttribute('data-animated', '1'))
                    }
                );
            }
        }

        if (window.lenisResize) window.lenisResize();

    } catch (error) {
        console.error('Failed to filter images:', error);
    }
});

// Initialize PhotoSwipe lightbox (handled by main layout)

// Handle bfcache (back-forward cache) restoration
// When user navigates with back/forward, page is restored from cache
// but JavaScript re-runs which can cause flickering
window.addEventListener('pageshow', function(event) {
    if (event.persisted) {
        // Page was restored from bfcache - immediately show all animated elements
        const animatedElements = document.querySelectorAll('[data-gsap]');
        animatedElements.forEach(function(el) {
            el.style.opacity = '1';
            el.style.transform = 'none';
            el.setAttribute('data-animated', '1');
        });

        // Clear any GSAP inline styles
        if (typeof gsap !== 'undefined') {
            gsap.set(animatedElements, { clearProps: 'all', opacity: 1 });
        }
    }
});

// Track early scroll to avoid hiding content mid-scroll
let albumIntroUserScrolled = false;
let albumIntroElements = [];
let albumIntroTween = null;
window.addEventListener('scroll', () => {
    albumIntroUserScrolled = true;
    document.body.classList.remove('gsap-armed');
    if (albumIntroElements.length > 0) {
        albumIntroElements.forEach(el => {
            el.style.opacity = '1';
            el.style.transform = 'none';
            el.setAttribute('data-animated', '1');
        });
        if (typeof gsap !== 'undefined') {
            gsap.killTweensOf(albumIntroElements);
            gsap.set(albumIntroElements, { clearProps: 'all', opacity: 1 });
        }
    }
    if (albumIntroTween) {
        albumIntroTween.kill();
        albumIntroTween = null;
    }
}, { passive: true, once: true });

// GSAP Animations for album header/meta elements - runs ONCE on load
document.addEventListener('DOMContentLoaded', function() {
    const allHeaderElements = document.querySelectorAll('[data-gsap="breadcrumb"], [data-gsap="category"], [data-gsap="hero-title"], [data-gsap="title"], [data-gsap="hero-excerpt"], [data-gsap="excerpt"], [data-gsap="hero-meta"], [data-gsap="meta"], [data-gsap="hero-tags"], [data-gsap="tags"], [data-gsap="body"]');
    allHeaderElements.forEach(el => {
        el.setAttribute('data-animated', '1');
        el.style.opacity = '1';
        el.style.transform = 'none';
    });
    if (typeof gsap !== 'undefined') {
        gsap.set(allHeaderElements, { clearProps: 'all', opacity: 1 });
    }

    // NOTE: #images-gallery animation is handled by _layout.twig animateGalleryOnce()

    // Related albums section with scroll trigger - use fromTo to prevent flicker
    const relatedTitle = document.querySelector('[data-gsap="related-title"]');
    if (relatedTitle && !relatedTitle.hasAttribute('data-animated') && typeof ScrollTrigger !== 'undefined') {
        relatedTitle.setAttribute('data-animated', '1');
        gsap.fromTo(relatedTitle,
            { opacity: 0, y: 20 },
            {
                opacity: 1,
                y: 0,
                duration: 0.6,
                ease: 'power2.out',
                scrollTrigger: {
                    trigger: relatedTitle,
                    start: 'top 90%',
                    once: true
                }
            }
        );
    }

    // Related album cards with stagger - use fromTo to prevent flicker
    const relatedGrid = document.querySelector('[data-gsap="related-grid"]');
    if (relatedGrid && typeof ScrollTrigger !== 'undefined') {
        const cards = Array.from(relatedGrid.querySelectorAll('.album-card:not([data-animated])'));
        if (cards.length > 0) {
            cards.forEach(c => c.setAttribute('data-animated', '1'));
            gsap.fromTo(cards,
                { opacity: 0, y: 30 },
                {
                    opacity: 1,
                    y: 0,
                    duration: 0.7,
                    stagger: 0.1,
                    ease: 'power2.out',
                    scrollTrigger: {
                        trigger: relatedGrid,
                        start: 'top 85%',
                        once: true
                    }
                }
            );
        }
    }

    // Subtle hover enhancement for image items (optional, GPU-accelerated)
    const allImageItems = document.querySelectorAll('.image-item');
    allImageItems.forEach(item => {
        item.addEventListener('mouseenter', function() {
            if (typeof gsap !== 'undefined') {
                gsap.to(this, {
                    scale: 1.02,
                    duration: 0.3,
                    ease: 'power2.out'
                });
            }
        });

        item.addEventListener('mouseleave', function() {
            if (typeof gsap !== 'undefined') {
                gsap.to(this, {
                    scale: 1,
                    duration: 0.3,
                    ease: 'power2.out'
                });
            }
        });
    });
});
</script>

{# Load masonry-grid library for masonry layout #}
{% if layout == 'masonry' and tpl_slug != 'masonry-portfolio' %}
<script type="module" nonce="{{ csp_nonce() }}">
import { BalancedMasonryGrid, RegularMasonryGrid } from '{{ base_path }}/assets/vendor/masonry-grid/index.js';
window.BalancedMasonryGrid = BalancedMasonryGrid;
window.RegularMasonryGrid = RegularMasonryGrid;
window._masonryGridReady = true;
window.dispatchEvent(new CustomEvent('masonry-grid-ready'));

// Re-initialize masonry now that library is loaded
if (document.readyState === 'complete') {
    window.initGalleryMasonry && window.initGalleryMasonry();
} else {
    window.addEventListener('load', () => window.initGalleryMasonry && window.initGalleryMasonry());
}
</script>
{% endif %}

{% endblock %}
