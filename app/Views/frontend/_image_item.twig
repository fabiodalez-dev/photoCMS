  {# Use lightbox_url for best quality, fallback to original_path #}
  {% set lightbox_href = image.lightbox_url|default(image.original_path) %}
  <a href="{% if lightbox_href starts with '/' %}{{ base_path }}{{ lightbox_href }}{% else %}{{ lightbox_href }}{% endif %}"
     class="pswp-link image-item group block"
     data-image-id="{{ image.id }}"
     data-pswp-width="{{ image.width }}"
     data-pswp-height="{{ image.height }}"
     data-title="{{ image.caption|default('')|e }}"
     data-alt="{{ image.alt_text|default('')|e }}"
     data-camera="{{ image.custom_camera|default(image.camera_name)|default('')|e }}"
     data-lens="{{ image.custom_lens|default(image.lens_name)|default('')|e }}"
     data-film="{{ image.custom_film|default(image.film_name)|default('')|e }}"
     data-developer="{{ image.developer_name|default('')|e }}"
     data-lab="{{ image.lab_name|default('')|e }}"
     data-location="{{ image.location_name|default('')|e }}"
     data-iso="{{ image.iso|default('') }}"
     data-shutter="{{ image.shutter_speed|default('')|e }}"
     data-aperture="{{ image.aperture|default('') }}">
  <div class="relative aspect-[4/3] md:aspect-[3/2] overflow-hidden bg-neutral-100 rounded-sm cursor-pointer">
    <picture>
      {% set variants_avif = [] %}
      {% set variants_webp = [] %}
      {% set variants_jpg = [] %}
      {% set best_jpg_path = image.original_path starts with '/' ? base_path ~ image.original_path : image.original_path %}
      {% set best_jpg_w = 0 %}
      {% for variant in image.variants %}
        {% set variant_url = variant.path starts with '/' ? base_path ~ variant.path : variant.path %}
        {% if variant.format == 'avif' %}
          {% set variants_avif = variants_avif|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
        {% elseif variant.format == 'webp' %}
          {% set variants_webp = variants_webp|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
        {% elseif variant.format == 'jpg' %}
          {% set variants_jpg = variants_jpg|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
          {% if variant.width > best_jpg_w %}
            {% set best_jpg_path = variant_url %}
            {% set best_jpg_w = variant.width %}
          {% endif %}
        {% endif %}
      {% endfor %}
      
      {# Sizes ottimizzate per grid responsive:
         - Desktop XL (1536px+): 3 colonne = 33vw
         - Desktop (1280px+): 3 colonne = 40vw
         - Laptop (1024px+): 2-3 colonne = 48vw
         - Tablet (768px+): 2 colonne = 50vw
         - Mobile L (640px+): 1 colonna = 95vw (con padding)
         - Mobile: full width = 100vw #}
      {% if variants_avif %}
        <source type="image/avif" srcset="{{ variants_avif|join(', ') }}" sizes="(min-width: 1536px) 30vw, (min-width: 1280px) 35vw, (min-width: 1024px) 45vw, (min-width: 768px) 48vw, (min-width: 640px) 95vw, 100vw">
      {% endif %}
      {% if variants_webp %}
        <source type="image/webp" srcset="{{ variants_webp|join(', ') }}" sizes="(min-width: 1536px) 30vw, (min-width: 1280px) 35vw, (min-width: 1024px) 45vw, (min-width: 768px) 48vw, (min-width: 640px) 95vw, 100vw">
      {% endif %}
      
      <img src="{{ best_jpg_path }}"
           alt="{{ image.alt_text|default('')|e }}"
           width="{{ image.width }}" 
           height="{{ image.height }}"
           loading="lazy" 
           decoding="async"
           class="w-full h-full object-cover transition-transform duration-200 group-hover:scale-105">
    </picture>
    {% if album.allow_downloads %}
      <a href="{{ base_path }}/download/image/{{ image.id }}" class="absolute top-2 right-2 bg-black/70 text-white p-2 rounded opacity-0 group-hover:opacity-100 transition z-10" title="Download" onclick="event.stopPropagation(); event.preventDefault();" download>
        <i class="fa-solid fa-arrow-down"></i>
      </a>
    {% endif %}
    
    {% if image.caption %}
      <div class="absolute bottom-0 left-0 right-0 bg-black/60 text-white text-xs p-2 opacity-0 group-hover:opacity-100 transition-opacity">
        {{ image.caption|e }}
      </div>
    {% endif %}
  </div>
</a>
