{% extends "frontend/_layout.twig" %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="max-w-4xl mx-auto text-center pb-12">
    <div class="mb-4 flex flex-wrap gap-2 justify-center">
      {% if album.categories is defined and album.categories|length > 0 %}
        {% for cat in album.categories %}
        <a href="{{ base_path }}/category/{{ cat.slug }}" class="inline-flex items-center gap-2 text-xs font-medium px-2.5 py-1 rounded-full border border-neutral-300 bg-neutral-50 text-neutral-700 hover:bg-neutral-100 hover:text-black transition-colors" title="{{ cat.name|e }}">
          <span class="w-1.5 h-1.5 rounded-full bg-neutral-700"></span>{{ cat.name|e }}
        </a>
        {% endfor %}
      {% endif %}
      {% if album.tags is defined and album.tags|length > 0 %}
        {% for tag in album.tags %}
        <span class="inline-flex items-center gap-2 text-xs font-medium px-2.5 py-1 rounded-full border border-blue-300 bg-blue-50 text-blue-700" title="{{ tag.name|e }}">
          <span class="w-1.5 h-1.5 rounded-full bg-blue-700"></span>{{ tag.name|e }}
        </span>
        {% endfor %}
      {% endif %}
    </div>
    <h1 class="text-3xl md:text-4xl font-light text-black mb-6">{{ album.title|e }}</h1>
    
    {# Album metadata: date and locations #}
    {% if album.shoot_date or album.equipment.locations|length > 0 %}
    <div class="flex items-center justify-center gap-6 text-sm text-neutral-600 mb-6">
      {% if album.shoot_date and album.show_date == 1 %}
        <div class="flex items-center gap-2">
          <i class="fas fa-calendar-alt text-neutral-500"></i>
          <time datetime="{{ album.shoot_date }}">{{ album.shoot_date|date('d M Y') }}</time>
        </div>
      {% endif %}
      
      {% if album.equipment.locations|length > 0 %}
        <div class="flex items-center gap-2">
          <i class="fas fa-map-marker-alt text-neutral-500"></i>
          <span>{{ album.equipment.locations|join(', ') }}</span>
        </div>
      {% endif %}
    </div>
    {% endif %}
    
    <p class="text-lg text-neutral-600 leading-relaxed mb-6">{{ album.excerpt|e }}</p>
  </div>

  <div class="max-w-3xl mx-auto prose prose-neutral mb-12">{{ album.body|raw }}</div>

  <div class="max-w-5xl mx-auto mb-8 p-4 bg-neutral-50 rounded-lg">
    <h3 class="text-sm font-medium mb-3 text-center">Equipment</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 text-xs text-neutral-600">
      <div><div class="font-medium mb-1 flex items-center gap-2"><i class="fas fa-camera"></i> Cameras</div>
        <div class="space-y-1">{% for camera in album.equipment.cameras %}<div>{{ camera }}</div>{% else %}<div class="text-neutral-400">—</div>{% endfor %}</div>
      </div>
      <div><div class="font-medium mb-1 flex items-center gap-2"><i class="fas fa-dot-circle"></i> Lenses</div>
        <div class="space-y-1">{% for lens in album.equipment.lenses %}<div>{{ lens }}</div>{% else %}<div class="text-neutral-400">—</div>{% endfor %}</div>
      </div>
      <div><div class="font-medium mb-1 flex items-center gap-2"><i class="fas fa-film"></i> Film</div>
        <div class="space-y-1">{% for film in album.equipment.film %}<div>{{ film }}</div>{% else %}<div class="text-neutral-400">—</div>{% endfor %}</div>
      </div>
      <div><div class="font-medium mb-1 flex items-center gap-2"><i class="fas fa-flask"></i> Developers</div>
        <div class="space-y-1">{% for dev in album.equipment.developers %}<div>{{ dev }}</div>{% else %}<div class="text-neutral-400">—</div>{% endfor %}</div>
      </div>
      <div><div class="font-medium mb-1 flex items-center gap-2"><i class="fas fa-industry"></i> Labs</div>
        <div class="space-y-1">{% for lab in album.equipment.labs %}<div>{{ lab }}</div>{% else %}<div class="text-neutral-400">—</div>{% endfor %}</div>
      </div>
    </div>
  </div>

  {% set layout = template_settings.layout|default('grid') %}
  {% set masonry = template_settings.masonry|default(false) %}
  
  {# Handle potentially nested columns structure #}
  {% set cols = template_settings.columns is defined ? template_settings.columns : {'desktop': 3, 'tablet': 2, 'mobile': 1} %}
  
  {# Extract desktop columns - handle nested structure #}
  {% if cols.desktop is iterable and cols.desktop.desktop is defined %}
    {% set desktop_cols = cols.desktop.desktop %}
  {% elseif cols.desktop is defined %}
    {% set desktop_cols = cols.desktop %}
  {% else %}
    {% set desktop_cols = 3 %}
  {% endif %}
  
  {# Extract tablet columns - handle nested structure #}
  {% if cols.tablet is iterable and cols.tablet.tablet is defined %}
    {% set tablet_cols = cols.tablet.tablet %}
  {% elseif cols.tablet is defined %}
    {% set tablet_cols = cols.tablet %}
  {% else %}
    {% set tablet_cols = 2 %}
  {% endif %}
  
  {# Extract mobile columns - handle nested structure #}
  {% if cols.mobile is iterable and cols.mobile.mobile is defined %}
    {% set mobile_cols = cols.mobile.mobile %}
  {% elseif cols.mobile is defined %}
    {% set mobile_cols = cols.mobile %}
  {% else %}
    {% set mobile_cols = 1 %}
  {% endif %}
  
  {# Ensure values are numbers #}
  {% set desktop_cols = desktop_cols|round %}
  {% set tablet_cols = tablet_cols|round %}
  {% set mobile_cols = mobile_cols|round %}
  

  {% if available_templates|length > 0 %}
  <div class="max-w-7xl mx-auto mb-2">
    <div class="flex justify-end">
      <div class="inline-flex items-center gap-1 bg-white/90 backdrop-blur-sm border border-neutral-200 rounded-md p-1 shadow-sm">
        {% for template in available_templates %}
        <a class="tpl-switch px-2 py-1 rounded {{ template.id == current_template_id ? 'bg-black text-white' : 'text-neutral-700 hover:bg-neutral-100' }}" href="{{ base_path }}/album/{{ album_ref }}?template={{ template.id }}" title="{{ template.name }}">
          {% if template.settings.layout == 'masonry_fit' %}
            <i class="fas fa-expand-arrows-alt"></i>
          {% elseif template.settings.layout == 'slideshow' and 'swiper' in template.libs %}
            <i class="fas fa-play-circle"></i>
          {% elseif template.settings.layout == 'slideshow' %}
            <i class="fas fa-images"></i>
          {% elseif template.settings.layout == 'grid' and template.settings.spacing == 'large' %}
            <i class="fas fa-border-none"></i>
          {% elseif template.settings.layout == 'mosaic' %}
            <i class="fas fa-puzzle-piece"></i>
          {% elseif template.settings.layout == 'carousel' %}
            <i class="fas fa-arrows-alt-h"></i>
          {% elseif template.settings.layout == 'polaroid' %}
            <i class="fas fa-camera-retro"></i>
          {% elseif template.settings.layout == 'fullscreen' %}
            <i class="fas fa-expand"></i>
          {% elseif template.settings.layout == 'grid' %}
            {% if template.settings.masonry %}
              <i class="fas fa-th-large"></i>
            {% else %}
              {% set tpl_desktop_cols = template.settings.columns.desktop|default(3) %}
              {% if tpl_desktop_cols <= 2 %}
                <i class="fas fa-pause"></i>
              {% elseif tpl_desktop_cols == 3 %}
                <i class="fas fa-th"></i>
              {% elseif tpl_desktop_cols >= 5 %}
                <i class="fas fa-border-all"></i>
              {% else %}
                <i class="fas fa-th"></i>
              {% endif %}
            {% endif %}
          {% else %}
            <i class="fas fa-th"></i>
          {% endif %}
        </a>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}

  {# 1. MASONRY FIT - Rispetta proporzioni originali #}
  {% if layout == 'masonry_fit' %}
    <div id="images-gallery" class="masonry-fit-container">
      {% for image in images %}
      <div class="masonry-fit-item" style="--aspect-ratio: {{ image.width / image.height }}">
        <a href="{{ image.lightbox_url|default(image.url) }}" 
           class="pswp-link image-item block overflow-hidden rounded-lg shadow-sm hover:shadow-xl transition-all duration-300 hover:scale-[1.02] bg-white"
           data-pswp-width="{{ image.width|default(1600) }}"
           data-pswp-height="{{ image.height|default(1067) }}"
           data-pswp-caption="{{ image.caption_html|default(image.caption)|e('html_attr') }}">
          <img src="{{ image.url }}" alt="{{ image.alt|e }}" class="w-full h-auto object-contain" style="aspect-ratio: var(--aspect-ratio)">
        </a>
      </div>
      {% endfor %}
    </div>

  {# 2. SLIDESHOW PRO - Con controlli avanzati #}
  {% elseif layout == 'slideshow' %}
    <div id="images-gallery" class="max-w-6xl mx-auto">
      <div class="swiper slideshow-pro" data-autoplay="{{ template_settings.slideshow.autoplay|default(true) }}" data-delay="{{ template_settings.slideshow.delay|default(5000) }}">
        <div class="swiper-wrapper">
          {% for image in images %}
          <div class="swiper-slide relative">
            <a href="{{ image.lightbox_url|default(image.url) }}" 
               class="pswp-link image-item block h-[70vh] bg-neutral-100 rounded-xl overflow-hidden flex items-center justify-center"
               data-pswp-width="{{ image.width|default(1600) }}"
               data-pswp-height="{{ image.height|default(1067) }}"
               data-pswp-caption="{{ image.caption_html|default(image.caption)|e('html_attr') }}">
              <img src="{{ image.url }}" alt="{{ image.alt|default('Image')|e }}" class="max-w-full max-h-full object-contain" style="aspect-ratio: {{ image.width|default(4) }} / {{ image.height|default(3) }};">
            </a>
            {% if image.caption %}
            <div class="absolute bottom-4 left-4 right-4 bg-black/70 text-white p-4 rounded-lg backdrop-blur-sm">
              <p class="text-sm">{{ image.caption|e }}</p>
            </div>
            {% endif %}
          </div>
          {% endfor %}
        </div>
        <div class="swiper-button-next !text-white !bg-black/30 !rounded-full !w-12 !h-12"></div>
        <div class="swiper-button-prev !text-white !bg-black/30 !rounded-full !w-12 !h-12"></div>
        <div class="swiper-pagination !bottom-2"></div>
        {% if template_settings.slideshow.showProgress|default(true) %}
        <div class="swiper-scrollbar !bg-white/20"></div>
        {% endif %}
      </div>
      {% if template_settings.slideshow.showThumbs|default(true) %}
      <div class="swiper slideshow-thumbs mt-4">
        <div class="swiper-wrapper">
          {% for image in images %}
          <div class="swiper-slide !w-20 !h-16 cursor-pointer opacity-60 hover:opacity-100 transition-opacity">
            <img src="{{ image.url }}" alt="" class="w-full h-full object-contain rounded">
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>

  {# 3. GRID MINIMAL - Design pulito #}
  {% elseif layout == 'grid' and template_settings.spacing == 'large' %}
    <div id="images-gallery" class="grid {{ mobile_class|default('grid-cols-1') }} {{ tablet_class|default('md:grid-cols-2') }} {{ desktop_class|default('lg:grid-cols-3') }} gap-8">
      {% for image in images %}
      <div class="grid-minimal-item group">
        <a href="{{ image.lightbox_url|default(image.url) }}" 
           class="pswp-link image-item block aspect-square bg-neutral-50 rounded-2xl overflow-hidden shadow-lg hover:shadow-2xl transition-all duration-500 hover:-translate-y-2"
           data-pswp-width="{{ image.width|default(1600) }}"
           data-pswp-height="{{ image.height|default(1067) }}"
           data-pswp-caption="{{ image.caption_html|default(image.caption)|e('html_attr') }}">
          <div class="relative w-full h-full">
            <img src="{{ image.url }}" alt="{{ image.alt|e }}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700">
            <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
          </div>
        </a>
      </div>
      {% endfor %}
    </div>

  {# 4. MOSAIC PRO - Dimensioni variabili #}
  {% elseif layout == 'mosaic' %}
    <div id="images-gallery" class="mosaic-container">
      {% for image in images %}
      {% set featured = loop.index0 % 6 == 0 or loop.index0 % 6 == 3 %}
      <div class="mosaic-item {{ featured ? 'mosaic-featured' : 'mosaic-normal' }}" data-index="{{ loop.index0 }}">
        <a href="{{ image.lightbox_url|default(image.url) }}" 
           class="pswp-link image-item block w-full h-full bg-neutral-100 rounded-lg overflow-hidden shadow-md hover:shadow-xl transition-all duration-300 hover:scale-[1.02] hover:z-10 {{ featured ? 'flex items-center justify-center' : '' }}"
           data-pswp-width="{{ image.width|default(1600) }}"
           data-pswp-height="{{ image.height|default(1067) }}"
           data-pswp-caption="{{ image.caption_html|default(image.caption)|e('html_attr') }}">
          <img src="{{ image.url }}" alt="{{ image.alt|e }}" class="w-full h-full {{ featured ? 'object-contain max-w-full max-h-full' : 'object-cover' }}">
        </a>
      </div>
      {% endfor %}
    </div>

  {# 5. CAROUSEL FLOW - Scroll orizzontale #}
  {% elseif layout == 'carousel' %}
    <div id="images-gallery" class="carousel-flow-container overflow-hidden">
      <div class="swiper carousel-flow" data-centered="true" data-free-mode="true">
        <div class="swiper-wrapper">
          {% for image in images %}
          <div class="swiper-slide !w-auto !h-[80vh] px-2">
            <a href="{{ image.lightbox_url|default(image.url) }}" 
               class="pswp-link image-item block h-full bg-neutral-100 rounded-2xl overflow-hidden shadow-lg hover:shadow-2xl transition-all duration-500 relative flex items-center justify-center"
               data-pswp-width="{{ image.width|default(1600) }}"
               data-pswp-height="{{ image.height|default(1067) }}"
               data-pswp-caption="{{ image.caption_html|default(image.caption)|e('html_attr') }}">
              <img src="{{ image.url }}" alt="{{ image.alt|e }}" class="max-h-full max-w-full object-contain" style="aspect-ratio: {{ image.width|default(4) }} / {{ image.height|default(3) }};">
            </a>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

  {# 6. POLAROID VINTAGE - Stile retrò #}
  {% elseif layout == 'polaroid' %}
    <div id="images-gallery" class="polaroid-container relative p-8" style="background: linear-gradient(45deg, #8b4513, #a0522d); min-height: 60vh;">
      {% for image in images %}
      {% set rotation_values = [-8, -6, -4, -2, 0, 2, 4, 6, 8] %}
      {% set rotation = rotation_values[loop.index0 % 9] %}
      <div class="polaroid-item absolute" 
           style="--rotation: {{ rotation }}deg; transform: rotate(var(--rotation)); top: {{ (loop.index0 * 15) % 60 + 10 }}%; left: {{ (loop.index0 * 20) % 80 + 5 }}%;">
        <a href="{{ image.lightbox_url|default(image.url) }}" 
           class="pswp-link image-item block bg-white p-3 pb-12 shadow-2xl hover:shadow-3xl transition-all duration-300 hover:scale-110 hover:z-50 relative"
           data-pswp-width="{{ image.width|default(1600) }}"
           data-pswp-height="{{ image.height|default(1067) }}"
           data-pswp-caption="{{ image.caption_html|default(image.caption)|e('html_attr') }}"
           style="width: 200px; filter: sepia(0.2) contrast(1.1) brightness(1.05);">
          <img src="{{ image.url }}" alt="{{ image.alt|e }}" class="w-full aspect-square object-cover">
          {% if image.caption %}
          <div class="absolute bottom-2 left-3 right-3 text-center text-xs font-handwriting text-gray-700">
            {{ image.caption|e|slice(0, 40) }}{% if image.caption|length > 40 %}...{% endif %}
          </div>
          {% endif %}
          <div class="absolute -top-2 left-1/2 transform -translate-x-1/2 w-8 h-4 bg-yellow-100/80 rounded-sm shadow-sm"></div>
        </a>
      </div>
      {% endfor %}
    </div>

  {# DEFAULT: Standard masonry #}
  {% elseif masonry %}
    <div id="images-gallery" class="masonry-grid">
      {% for image in images %}
      <div class="masonry-item">
        <a href="{{ image.lightbox_url|default(image.url) }}" 
           class="pswp-link image-item bg-neutral-100 rounded-lg overflow-hidden shadow-sm hover:shadow-lg transition-shadow cursor-pointer mb-4 group relative block"
           data-pswp-width="{{ image.width|default(1600) }}"
           data-pswp-height="{{ image.height|default(1067) }}"
           data-pswp-caption="{{ image.caption_html|default(image.caption)|e('html_attr') }}">
          <img src="{{ image.url }}" alt="{{ image.alt|e }}" class="w-full h-auto object-cover">
        </a>
      </div>
      {% endfor %}
    </div>
  {% else %}
    {% if mobile_cols == 1 %}{% set mobile_class = 'grid-cols-1' %}
    {% elseif mobile_cols == 2 %}{% set mobile_class = 'grid-cols-2' %}
    {% elseif mobile_cols == 3 %}{% set mobile_class = 'grid-cols-3' %}
    {% elseif mobile_cols == 4 %}{% set mobile_class = 'grid-cols-4' %}
    {% elseif mobile_cols == 5 %}{% set mobile_class = 'grid-cols-5' %}
    {% else %}{% set mobile_class = 'grid-cols-6' %}{% endif %}
    
    {% if tablet_cols == 1 %}{% set tablet_class = 'md:grid-cols-1' %}
    {% elseif tablet_cols == 2 %}{% set tablet_class = 'md:grid-cols-2' %}
    {% elseif tablet_cols == 3 %}{% set tablet_class = 'md:grid-cols-3' %}
    {% elseif tablet_cols == 4 %}{% set tablet_class = 'md:grid-cols-4' %}
    {% elseif tablet_cols == 5 %}{% set tablet_class = 'md:grid-cols-5' %}
    {% else %}{% set tablet_class = 'md:grid-cols-6' %}{% endif %}
    
    {% if desktop_cols == 1 %}{% set desktop_class = 'lg:grid-cols-1' %}
    {% elseif desktop_cols == 2 %}{% set desktop_class = 'lg:grid-cols-2' %}
    {% elseif desktop_cols == 3 %}{% set desktop_class = 'lg:grid-cols-3' %}
    {% elseif desktop_cols == 4 %}{% set desktop_class = 'lg:grid-cols-4' %}
    {% elseif desktop_cols == 5 %}{% set desktop_class = 'lg:grid-cols-5' %}
    {% else %}{% set desktop_class = 'lg:grid-cols-6' %}{% endif %}
    <div id="images-gallery" class="grid {{ mobile_class }} {{ tablet_class }} {{ desktop_class }} gap-4">
      {% for image in images %}
      <div class="masonry-item">
        <a href="{{ image.lightbox_url|default(image.url) }}" 
           class="pswp-link image-item aspect-[4/3] bg-neutral-100 rounded-lg overflow-hidden shadow-sm hover:shadow-lg transition-shadow cursor-pointer group relative block"
           data-pswp-width="{{ image.width|default(1600) }}"
           data-pswp-height="{{ image.height|default(1067) }}"
           data-pswp-caption="{{ image.caption_html|default(image.caption)|e('html_attr') }}">
          <img src="{{ image.url }}" alt="{{ image.alt|e }}" class="w-full h-full object-cover">
        </a>
      </div>
      {% endfor %}
    </div>
  {% endif %}

</div>
{% endblock %}

{% block scripts %}
<script>
// Global base path for API calls
window.basePath = '{{ base_path }}';

// Store template settings globally for AJAX reloads
window.templateSettings = {{ template_settings ? template_settings|json_encode|raw : '{}' }};

const layout = window.templateSettings.layout || 'grid';
const masonry = window.templateSettings.masonry || false;

// Initialize layouts based on template settings
document.addEventListener('DOMContentLoaded', function() {
  initializeGalleryLayout();
  
  // Ensure images are visible without animation to prevent flickering
  setTimeout(() => {
    const galleryContainer = document.getElementById('images-gallery');
    if (galleryContainer) {
      // Show content directly without fade-in animation
      galleryContainer.style.opacity = '1';
      galleryContainer.style.transition = 'none';
      
      // Ensure all images are visible
      const images = galleryContainer.querySelectorAll('img');
      images.forEach(img => {
        img.style.opacity = '1';
        img.style.transition = 'none';
      });
      
      // Ensure all image items are visible
      const imageItems = galleryContainer.querySelectorAll('.image-item');
      imageItems.forEach(item => {
        item.style.opacity = '1';
        item.style.transform = 'scale(1)';
        item.style.transition = 'none';
      });
    }
  }, 100);
});

function initializeGalleryLayout() {
  const layout = window.templateSettings?.layout || 'grid';
  const masonry = window.templateSettings?.masonry || false;
  
  // 1. MASONRY FIT - No special JS needed, pure CSS Grid
  
  // 2. SLIDESHOW PRO - Enhanced slideshow with thumbnails
  if (layout === 'slideshow' && typeof Swiper !== 'undefined') {
    const slideshowThumbs = new Swiper('.slideshow-thumbs', {
      spaceBetween: 10,
      slidesPerView: 'auto',
      freeMode: true,
      watchSlidesProgress: true,
    });
    
    window.gallerySwiper = new Swiper('.slideshow-pro', {
      spaceBetween: 10,
      navigation: {
        nextEl: '.swiper-button-next',
        prevEl: '.swiper-button-prev',
      },
      pagination: {
        el: '.swiper-pagination',
        clickable: true,
      },
      thumbs: {
        swiper: slideshowThumbs,
      },
      loop: true,
      autoplay: window.templateSettings?.slideshow?.autoplay ? {
        delay: window.templateSettings?.slideshow?.delay || 5000,
        disableOnInteraction: false,
      } : false,
      effect: 'fade',
      fadeEffect: {
        crossFade: true
      }
    });
  }
  
  // 3. GRID MINIMAL - No special JS needed, pure CSS with hover effects
  
  // 4. MOSAIC PRO - No special JS needed, pure CSS Grid
  
  // 5. CAROUSEL FLOW - Horizontal scrolling carousel
  else if (layout === 'carousel' && typeof Swiper !== 'undefined') {
    window.gallerySwiper = new Swiper('.carousel-flow', {
      slidesPerView: 'auto',
      spaceBetween: 20,
      centeredSlides: true,
      freeMode: true,
      grabCursor: true,
      mousewheel: {
        thresholdDelta: 70,
        forceToAxis: true,
      },
      breakpoints: {
        640: {
          spaceBetween: 30,
        },
        1024: {
          spaceBetween: 40,
        },
      }
    });
  }
  
  // 6. POLAROID VINTAGE - Add random positioning for desktop
  else if (layout === 'polaroid') {
    const polaroidItems = document.querySelectorAll('.polaroid-item');
    
    // Only apply random positioning on desktop
    if (window.innerWidth > 768) {
      polaroidItems.forEach((item, index) => {
        const randomX = Math.random() * 80 + 5; // 5-85%
        const randomY = Math.random() * 60 + 10; // 10-70%
        const randomRotation = (Math.random() - 0.5) * 16; // -8 to +8 degrees
        
        item.style.left = randomX + '%';
        item.style.top = randomY + '%';
        item.style.transform = `rotate(${randomRotation}deg)`;
        item.style.zIndex = Math.floor(Math.random() * 10) + 1;
      });
    }
  }
  
  // DEFAULT: Standard masonry for backward compatibility
  else if (masonry && typeof Masonry !== 'undefined') {
    const container = document.getElementById('images-gallery');
    if (container) {
      imagesLoaded(container, function(){ 
        window.galleryMasonry = new Masonry(container, { 
          itemSelector: '.masonry-item', 
          percentPosition: true 
        }); 
        
        // Ensure images are visible after masonry initialization
        setTimeout(() => {
          const images = container.querySelectorAll('img');
          images.forEach(img => {
            img.style.opacity = '1';
            img.style.transition = 'none';
          });
          
          // Ensure image items are also visible
          const imageItems = container.querySelectorAll('.image-item');
          imageItems.forEach(item => {
            item.style.opacity = '1';
            item.style.transform = 'scale(1)';
            item.style.transition = 'none';
          });
        }, 50);
      });
    }
  }
  
  // Ensure images are visible after layout initialization
  setTimeout(() => {
    const galleryContainer = document.getElementById('images-gallery');
    if (galleryContainer) {
      const imageItems = galleryContainer.querySelectorAll('.image-item');
      imageItems.forEach(item => {
        // Ensure images are visible without animation
        item.style.opacity = '1';
        item.style.transform = 'scale(1)';
        item.style.transition = 'none';
      });
    }
  }, 100);
}

// Template switcher functionality
document.querySelectorAll('.tpl-switch')?.forEach(a => {
  a.addEventListener('click', (e) => {
    e.preventDefault();
    
    // Get the template ID from the URL
    const url = new URL(a.getAttribute('href'), window.location.origin);
    const templateId = url.searchParams.get('template');
    
    if (!templateId) {
      // If no template ID, follow the link normally
      window.location.href = a.getAttribute('href');
      return;
    }
    
    // Get album reference (slug or ID)
    const albumRef = url.searchParams.get('album');
    
    // Get the gallery container
    const galleryContainer = document.getElementById('images-gallery');
    if (!galleryContainer) {
      // Fallback to normal navigation if container not found
      window.location.href = a.getAttribute('href');
      return;
    }
    
    // Store original content for error recovery
    const originalContent = galleryContainer.innerHTML;
    
    // Add loading state
    galleryContainer.innerHTML = '<div class="flex justify-center py-12"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-black"></div></div>';
    
    // Update active state in template switcher
    document.querySelectorAll('.tpl-switch').forEach(el => {
      el.classList.remove('bg-black', 'text-white');
      el.classList.add('text-neutral-700', 'hover:bg-neutral-100');
    });
    a.classList.remove('text-neutral-700', 'hover:bg-neutral-100');
    a.classList.add('bg-black', 'text-white');
    
    // Build the AJAX URL for fetching only the gallery content using SEO-friendly format
    const urlPath = url.pathname; // e.g., "/album/street-photography-portfolio"
    const albumSlug = urlPath.split('/').pop(); // Extract "street-photography-portfolio"
    const fetchUrl = `${window.basePath}/api/album/${albumSlug}/template?template=${templateId}`;
    console.log('Fetching from SEO-friendly URL:', fetchUrl);
    
    // Fetch the full page and extract the gallery content
    fetch(fetchUrl, {
      headers: {
        'Accept': 'text/html',
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => {
      if (!response.ok) throw new Error('Network response was not ok');
      return response.text();
    })
    .then(html => {
      console.log('=== AJAX TEMPLATE SWITCH DEBUG ===');
      console.log('Received HTML response, length:', html.length);
      console.log('Raw HTML response:', html.substring(0, 500) + '...');
      
      // Hide the gallery container before updating content
      galleryContainer.style.opacity = '0';
      
      // The API endpoint returns the gallery content directly, not a full HTML page
      // So we can directly use the response as the new gallery content
      galleryContainer.innerHTML = html;
      
      console.log('Updated gallery innerHTML');
      
      // CRITICAL: Extract template settings from the script tag in the response
      const scriptMatch = html.match(/<script>[\s\S]*?window\.templateSettings\s*=\s*({[\s\S]*?});[\s\S]*?<\/script>/);
      if (scriptMatch) {
        try {
          const settingsJson = scriptMatch[1];
          console.log('Found template settings JSON:', settingsJson);
          window.templateSettings = JSON.parse(settingsJson);
          console.log('Parsed template settings:', window.templateSettings);
        } catch (e) {
          console.error('Error parsing template settings:', e);
        }
      } else {
        console.error('Template settings script not found in response!');
      }
      
      // Update container classes based on new template settings
      const newLayout = window.templateSettings?.layout || 'grid';
      const newMasonry = window.templateSettings?.masonry || false;
      
      console.log('=== APPLYING CLASSES ===');
      console.log('Current window.templateSettings:', window.templateSettings);
      console.log('New layout:', newLayout, 'New masonry:', newMasonry);
      console.log('Container before class update:', galleryContainer.className);
      
      // Store the ID attribute and remove all classes
      const containerId = galleryContainer.id;
      galleryContainer.className = '';
      
      console.log('Container after clearing classes:', galleryContainer.className);
      
      // Apply new layout classes based on template
      if (newLayout === 'slideshow') {
        galleryContainer.className = 'swiper gallery-swiper max-w-4xl mx-auto';
        // For slideshow, we need to wrap the content in a swiper structure
        // The AJAX response already contains swiper-wrapper content
      } else if (newLayout === 'fullscreen') {
        galleryContainer.className = 'grid grid-cols-1 lg:grid-cols-2 gap-2';
      } else if (newMasonry) {
        galleryContainer.className = 'masonry-grid';
      } else {
        // Regular grid layout - apply column classes exactly like original template
        const cols = window.templateSettings?.columns || {desktop: 3, tablet: 2, mobile: 1};
        
        console.log('=== GRID CLASS GENERATION ===');
        console.log('Columns from template settings:', cols);
        
        // Extract column values (handle nested structure like original)
        let desktop_cols = 3, tablet_cols = 2, mobile_cols = 1;
        
        if (cols.desktop && typeof cols.desktop === 'object' && cols.desktop.desktop) {
          desktop_cols = cols.desktop.desktop;
        } else if (cols.desktop) {
          desktop_cols = cols.desktop;
        }
        
        if (cols.tablet && typeof cols.tablet === 'object' && cols.tablet.tablet) {
          tablet_cols = cols.tablet.tablet;
        } else if (cols.tablet) {
          tablet_cols = cols.tablet;
        }
        
        if (cols.mobile && typeof cols.mobile === 'object' && cols.mobile.mobile) {
          mobile_cols = cols.mobile.mobile;
        } else if (cols.mobile) {
          mobile_cols = cols.mobile;
        }
        
        // Ensure values are numbers (like original)
        desktop_cols = Math.round(desktop_cols);
        tablet_cols = Math.round(tablet_cols);
        mobile_cols = Math.round(mobile_cols);
        
        console.log('Extracted columns - Desktop:', desktop_cols, 'Tablet:', tablet_cols, 'Mobile:', mobile_cols);
        
        // Build grid classes exactly like the original template
        let mobile_class = 'grid-cols-1';
        if (mobile_cols == 2) mobile_class = 'grid-cols-2';
        else if (mobile_cols == 3) mobile_class = 'grid-cols-3';
        else if (mobile_cols == 4) mobile_class = 'grid-cols-4';
        else if (mobile_cols == 5) mobile_class = 'grid-cols-5';
        else if (mobile_cols >= 6) mobile_class = 'grid-cols-6';
        
        let tablet_class = 'md:grid-cols-1';
        if (tablet_cols == 2) tablet_class = 'md:grid-cols-2';
        else if (tablet_cols == 3) tablet_class = 'md:grid-cols-3';
        else if (tablet_cols == 4) tablet_class = 'md:grid-cols-4';
        else if (tablet_cols == 5) tablet_class = 'md:grid-cols-5';
        else if (tablet_cols >= 6) tablet_class = 'md:grid-cols-6';
        
        let desktop_class = 'lg:grid-cols-1';
        if (desktop_cols == 2) desktop_class = 'lg:grid-cols-2';
        else if (desktop_cols == 3) desktop_class = 'lg:grid-cols-3';
        else if (desktop_cols == 4) desktop_class = 'lg:grid-cols-4';
        else if (desktop_cols == 5) desktop_class = 'lg:grid-cols-5';
        else if (desktop_cols >= 6) desktop_class = 'lg:grid-cols-6';
        
        console.log('Generated classes - Mobile:', mobile_class, 'Tablet:', tablet_class, 'Desktop:', desktop_class);
        
        const finalClasses = `grid ${mobile_class} ${tablet_class} ${desktop_class} gap-4`;
        console.log('Final class string:', finalClasses);
        
        galleryContainer.className = finalClasses;
      }
      
      // Restore the ID
      galleryContainer.id = containerId;
      
      console.log('=== FINAL CONTAINER STATE ===');
      console.log('Final container classes:', galleryContainer.className);
      console.log('Final container ID:', galleryContainer.id);
      console.log('Container element:', galleryContainer);
      
      console.log('Updated gallery content successfully');
      
      // Update the page URL without reloading
      history.pushState(null, '', a.getAttribute('href'));
      
      // Reinitialize components based on new template settings
      setTimeout(() => {
        // Re-initialize PhotoSwipe
        if (typeof initLightbox === 'function') {
          initLightbox();
        }
        
        // Destroy existing Swiper instances
        if (window.gallerySwiper && typeof window.gallerySwiper.destroy === 'function') {
          window.gallerySwiper.destroy(true, true);
          window.gallerySwiper = null;
        }
        
        // Destroy existing Masonry instances
        if (window.galleryMasonry && typeof window.galleryMasonry.destroy === 'function') {
          window.galleryMasonry.destroy();
          window.galleryMasonry = null;
        }
        
        // Re-initialize the gallery layout
        initializeGalleryLayout();
        
        // Wait for components to initialize, then show content directly without animation
        setTimeout(() => {
          // Show content directly without fade-in animation to prevent flickering
          galleryContainer.style.opacity = '1';
          galleryContainer.style.transition = 'none';
          
          // Ensure individual images are also visible
          const imageItems = galleryContainer.querySelectorAll('.image-item');
          imageItems.forEach(item => {
            item.style.opacity = '1';
            item.style.transform = 'scale(1)';
            item.style.transition = 'none';
          });
        }, 50);
      }, 100);
    })
    .catch(error => {
      console.error('Error loading template:', error);
      console.error('Failed URL:', fetchUrl);
      console.error('Error details:', {
        message: error.message,
        stack: error.stack
      });
      
      // Restore original content and button state on error
      galleryContainer.innerHTML = originalContent;
      galleryContainer.style.opacity = '1'; // Ensure opacity is restored
      galleryContainer.style.transition = ''; // Reset any transition
      
      // Restore button states
      document.querySelectorAll('.tpl-switch').forEach(el => {
        el.classList.remove('bg-black', 'text-white');
        el.classList.add('text-neutral-700', 'hover:bg-neutral-100');
      });
      
      // Find and restore the previously active button
      const currentUrl = window.location.href;
      document.querySelectorAll('.tpl-switch').forEach(btn => {
        if (btn.href === currentUrl || btn.classList.contains('bg-black')) {
          btn.classList.remove('text-neutral-700', 'hover:bg-neutral-100');
          btn.classList.add('bg-black', 'text-white');
        }
      });
      
      // Show more specific error message
      const errorMsg = error.message.includes('Gallery content not found') 
        ? 'Template content not found. Please refresh the page and try again.'
        : 'Error loading template. Please check your connection and try again.';
      alert(errorMsg);
    });
  });
});
{% endblock %}
