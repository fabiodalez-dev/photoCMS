{% extends "frontend/_layout.twig" %}

{% import 'frontend/_seo_macros.twig' as Seo %}

{% block content %}
<style nonce="{{ csp_nonce() }}">
/* Hide GSAP-animated elements initially to prevent flicker */
[data-gsap="categories"],
[data-gsap="title"],
[data-gsap="meta"],
[data-gsap="excerpt"],
[data-gsap="body"],
[data-gsap="equipment"] {
    opacity: 0;
    transform: translateY(20px);
}
/* Fallback: show elements if GSAP hasn't animated them after 1.5s */
/* Only apply to elements NOT yet animated by GSAP */
.gsap-ready [data-gsap="categories"]:not([data-animated]),
.gsap-ready [data-gsap="title"]:not([data-animated]),
.gsap-ready [data-gsap="meta"]:not([data-animated]),
.gsap-ready [data-gsap="excerpt"]:not([data-animated]),
.gsap-ready [data-gsap="body"]:not([data-animated]),
.gsap-ready [data-gsap="equipment"]:not([data-animated]) {
    opacity: 1;
    transform: translateY(0);
}
/* Equipment section title should use body font, not heading font */
[data-gsap="equipment"] h3 {
    font-family: var(--font-body), system-ui, sans-serif !important;
    font-weight: 500 !important;
}
</style>
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  {% include 'frontend/_breadcrumbs.twig' %}
  <div class="max-w-4xl mx-auto text-center pb-12">
    <div class="mt-4 mb-4 flex flex-wrap gap-2 justify-center" data-gsap="categories">
      {% if album.categories is defined and album.categories|length > 0 %}
        {% for cat in album.categories %}
        <a href="{{ base_path }}/category/{{ cat.slug }}" class="inline-flex items-center gap-2 text-xs font-medium px-2.5 py-1 rounded-full border border-neutral-300 bg-neutral-50 text-neutral-700 hover:bg-neutral-100 hover:text-black transition-colors" title="{{ cat.name|e }}">
          <span class="w-1.5 h-1.5 rounded-full bg-neutral-700"></span>{{ cat.name|e }}
        </a>
        {% endfor %}
      {% endif %}
      {% if album.tags is defined and album.tags|length > 0 %}
        {% for tag in album.tags %}
        <a href="{{ base_path }}/tag/{{ tag.slug }}" class="inline-flex items-center gap-2 text-xs font-medium px-2.5 py-1 rounded-full border border-blue-300 bg-blue-50 text-blue-700 hover:bg-blue-100 hover:text-blue-800 transition-colors" title="{{ tag.name|e }}">
          <span class="w-1.5 h-1.5 rounded-full bg-blue-700"></span>{{ tag.name|e }}
        </a>
        {% endfor %}
      {% endif %}
    </div>
    <h1 class="text-3xl md:text-4xl font-light text-black mb-6" data-gsap="title">{{ album.title|e }}</h1>

    {# Album metadata: date and locations #}
    {% if album.shoot_date or album.equipment.locations|length > 0 %}
    <div class="flex items-center justify-center gap-6 text-sm text-neutral-600 mb-6" data-gsap="meta">
      {% if album.shoot_date and album.show_date == 1 %}
        <div class="flex items-center gap-2">
          <i class="fas fa-calendar-alt text-neutral-500"></i>
          <time datetime="{{ album.shoot_date }}">{{ album.shoot_date|date_format }}</time>
        </div>
      {% endif %}
      
      {% if album.equipment.locations|length > 0 %}
        <div class="flex items-center gap-2">
          <i class="fas fa-map-marker-alt text-neutral-500"></i>
          <span>{{ album.equipment.locations|join(', ') }}</span>
        </div>
      {% endif %}
    </div>
    {% endif %}

    <p class="text-lg text-neutral-600 leading-relaxed mb-6" data-gsap="excerpt">{{ album.excerpt|e }}</p>
  </div>

  {% if album.body %}
    <div class="max-w-3xl mx-auto prose prose-neutral mb-12" data-gsap="body">{{ album.body|safe_html }}</div>
  {% endif %}
  
  {# Social Sharing #}
  {% include 'frontend/_social_sharing.twig' %}

  {# Count custom fields that should show in gallery #}
  {% set custom_fields_for_gallery = [] %}
  {% if album_custom_fields is defined %}
    {% for typeId, field in album_custom_fields %}
      {% if field.show_in_gallery and field.values|length > 0 %}
        {% set custom_fields_for_gallery = custom_fields_for_gallery|merge([field]) %}
      {% endif %}
    {% endfor %}
  {% endif %}

  {% if album.equipment.cameras|length > 0 or album.equipment.lenses|length > 0 or album.equipment.film|length > 0 or album.equipment.developers|length > 0 or album.equipment.labs|length > 0 or custom_fields_for_gallery|length > 0 %}
  {% set equipment_items = [] %}
  {% if album.equipment.cameras is defined and album.equipment.cameras|length > 0 %}
    {% set equipment_items = equipment_items|merge([1]) %}
  {% endif %}
  {% if album.equipment.lenses is defined and album.equipment.lenses|length > 0 %}
    {% set equipment_items = equipment_items|merge([1]) %}
  {% endif %}
  {% if album.equipment.film is defined and album.equipment.film|length > 0 %}
    {% set equipment_items = equipment_items|merge([1]) %}
  {% endif %}
  {% if album.equipment.developers is defined and album.equipment.developers|length > 0 %}
    {% set equipment_items = equipment_items|merge([1]) %}
  {% endif %}
  {% if album.equipment.labs is defined and album.equipment.labs|length > 0 %}
    {% set equipment_items = equipment_items|merge([1]) %}
  {% endif %}
  {# Add custom fields count to equipment items #}
  {% for cf in custom_fields_for_gallery %}
    {% set equipment_items = equipment_items|merge([1]) %}
  {% endfor %}
  
  {% set equipment_count = equipment_items|length %}
  {% set grid_cols = equipment_count <= 3 ? equipment_count : 3 %}

  <div class="max-w-5xl mx-auto mb-8 p-4 bg-neutral-50 rounded-lg" data-gsap="equipment">
    <h3 class="text-sm font-medium mb-3 text-center">{{ trans('album.equipment') }}</h3>
    <div class="grid grid-cols-1 {% if equipment_count > 1 %}md:grid-cols-{{ equipment_count <= 2 ? equipment_count : 2 }}{% endif %} {% if equipment_count > 2 %}lg:grid-cols-{{ grid_cols }}{% endif %} gap-4 text-xs text-neutral-600">
      {% if album.equipment.cameras is defined and album.equipment.cameras|length > 0 %}
      <div class="flex flex-col items-center text-center">
        <i class="fas fa-camera mb-1 text-neutral-500"></i>
        <div class="space-y-1">
          {% for camera in album.equipment.cameras %}<div>{{ camera }}</div>{% endfor %}
        </div>
      </div>
      {% endif %}
      {% if album.equipment.lenses is defined and album.equipment.lenses|length > 0 %}
      <div class="flex flex-col items-center text-center">
        <i class="fas fa-dot-circle mb-1 text-neutral-500"></i>
        <div class="space-y-1">
          {% for lens in album.equipment.lenses %}<div>{{ lens }}</div>{% endfor %}
        </div>
      </div>
      {% endif %}
      {% if album.equipment.film is defined and album.equipment.film|length > 0 %}
      <div class="flex flex-col items-center text-center">
        <i class="fas fa-film mb-1 text-neutral-500"></i>
        <div class="space-y-1">
          {% for film in album.equipment.film %}<div>{% if film.name is defined %}{{ film.name }}{% if film.iso or film.format %} ({% if film.iso %}ISO {{ film.iso }}{% endif %}{% if film.iso and film.format %} - {% endif %}{% if film.format %}{{ film.format }}{% endif %}){% endif %}{% else %}{{ film }}{% endif %}</div>{% endfor %}
        </div>
      </div>
      {% endif %}
      {% if album.equipment.developers is defined and album.equipment.developers|length > 0 %}
      <div class="flex flex-col items-center text-center">
        <i class="fas fa-flask mb-1 text-neutral-500"></i>
        <div class="space-y-1">
          {% for dev in album.equipment.developers %}<div>{{ dev }}</div>{% endfor %}
        </div>
      </div>
      {% endif %}
      {% if album.equipment.labs is defined and album.equipment.labs|length > 0 %}
      <div class="flex flex-col items-center text-center">
        <i class="fas fa-industry mb-1 text-neutral-500"></i>
        <div class="space-y-1">
          {% for lab in album.equipment.labs %}<div>{{ lab }}</div>{% endfor %}
        </div>
      </div>
      {% endif %}
      {# Custom fields #}
      {% for field in custom_fields_for_gallery %}
      <div class="flex flex-col items-center text-center">
        <i class="fas {{ field.icon|default('fa-tag') }} mb-1 text-neutral-500"></i>
        <div class="space-y-1">
          {% for valueData in field.values %}<div>{{ valueData.value|e }}</div>{% endfor %}
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}
  {# --- Template switcher: show ABOVE the gallery content --- #}
  {% if available_templates|length > 0 %}
  <div class="max-w-7xl mx-auto mb-2">
    <div class="flex justify-end">
      <div id="template-switcher" class="inline-flex items-center gap-1 bg-white/90 backdrop-blur-sm border border-neutral-200 rounded-md p-1 shadow-sm max-md:hidden">
        {% for template in available_templates %}
        <button type="button" class="tpl-switch px-2 py-1 rounded {{ template.id == current_template_id ? 'bg-black text-white' : 'text-neutral-700 hover:bg-neutral-100' }}" data-template-id="{{ template.id }}" data-album-ref="{{ album_ref }}" title="{{ template.name }}" aria-label="{{ template.name }}">
          {% if template.settings.layout == 'masonry_fit' %}
            <i class="fas fa-expand-arrows-alt"></i>
          {% elseif template.settings.layout == 'slideshow' and 'swiper' in template.libs %}
            <i class="fas fa-play-circle"></i>
          {% elseif template.settings.layout == 'slideshow' %}
            <i class="fas fa-images"></i>
          {% elseif template.settings.layout == 'grid' and template.settings.spacing == 'large' %}
            <i class="fas fa-border-none"></i>
          {% elseif template.settings.layout == 'mosaic' %}
            <i class="fas fa-puzzle-piece"></i>
          {% elseif template.settings.layout == 'carousel' %}
            <i class="fas fa-arrows-alt-h"></i>
          {% elseif template.settings.layout == 'polaroid' %}
            <i class="fas fa-camera-retro"></i>
          {% elseif template.settings.layout == 'fullscreen' %}
            <i class="fas fa-expand"></i>
          {% elseif template.settings.layout == 'grid' %}
            {% if template.settings.masonry %}
              <i class="fas fa-grip-vertical"></i>
            {% else %}
              {% set tpl_desktop_cols = template.settings.columns.desktop|default(3) %}
              {% if tpl_desktop_cols <= 2 %}
                <i class="fas fa-pause"></i>
              {% elseif tpl_desktop_cols == 3 %}
                <i class="fas fa-th"></i>
              {% elseif tpl_desktop_cols >= 5 %}
                <i class="fas fa-grip-horizontal"></i>
              {% else %}
                <i class="fas fa-th"></i>
              {% endif %}
            {% endif %}
          {% else %}
            <i class="fas fa-th"></i>
          {% endif %}
        </button>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}

  {% set layout = template_settings.layout|default('grid') %}

  {% if layout == 'magazine' %}
    <div id="images-gallery" class="mt-6">
      {% include 'frontend/_gallery_magazine_content.twig' with { images: images, template_settings: template_settings, album: album } %}
    </div>
  {% endif %}
  {% set masonry = template_settings.masonry|default(false) %}
  
  {# Usa direttamente la struttura semplificata #}
  {% set cols = template_settings.columns is defined ? template_settings.columns : {'desktop': 3, 'tablet': 2, 'mobile': 1} %}
  
  {# Estrai direttamente i valori #}
  {% set desktop_cols = cols.desktop %}
  {% set tablet_cols = cols.tablet %}
  {% set mobile_cols = cols.mobile %}
  
  {# Assicurati che siano numeri #}
  {% set desktop_cols = desktop_cols|round %}
  {% set tablet_cols = tablet_cols|round %}
  {% set mobile_cols = mobile_cols|round %}
  


  {% if layout != 'magazine' %}
  {# 1. MASONRY FIT / MASONRY - Rispetta proporzioni originali con CSS columns #}
  {% if layout == 'masonry_fit' or layout == 'masonry' %}
    {% set gap_h = template_settings.gap.horizontal|default(16) %}
    {% set gap_v = template_settings.gap.vertical|default(16) %}
    <div id="images-gallery" class="masonry-fit-container pswp-gallery" data-layout="masonry_fit">
      {% for image in images %}
      <div class="masonry-fit-item">
        {% set seo_title = Seo.seo_title(image, album, site_title)|trim %}
        <a href="{% set href_src = image.lightbox_url|default(image.url) %}{% if href_src starts with '/' %}{{ base_path }}{{ href_src }}{% else %}{{ href_src }}{% endif %}"
           class="pswp-link image-item block overflow-hidden bg-neutral-50 cursor-pointer"
           title="{{ seo_title|e('html_attr') }}"
           data-image-id="{{ image.id }}"
           data-pswp-width="{{ image.width|default(1600) }}"
           data-pswp-height="{{ image.height|default(1067) }}"
           data-pswp-caption="{{ image.caption_html|default(image.caption)|e('html_attr') }}"
           data-title="{{ image.caption|default('')|e }}"
           data-alt="{{ image.alt|default('')|e }}"
           data-camera="{{ image.camera_name|default(image.custom_camera)|default('')|e }}"
           data-lens="{{ image.lens_name|default(image.custom_lens)|default('')|e }}"
           data-film="{{ image.film_name|default(image.custom_film)|default('')|e }}"
           data-developer="{{ image.developer_name|default('')|e }}"
           data-lab="{{ image.lab_name|default('')|e }}"
           data-location="{{ image.location_name|default('')|e }}"
           data-iso="{{ image.iso|default('') }}"
           data-shutter="{{ image.shutter_speed|default('')|e }}"
           data-aperture="{{ image.aperture|default('') }}"
           data-focal-length="{{ image.focal_length|default('') }}"
           data-exif-make="{{ image.exif_make|default('')|e }}"
           data-exif-model="{{ image.exif_model|default('')|e }}"
           data-exif-lens="{{ image.exif_lens_model|default('')|e }}"
           data-gps-lat="{{ image.gps_lat|default('') }}"
           data-gps-lng="{{ image.gps_lng|default('') }}"
           data-date-original="{{ image.date_original|default('')|e }}"
           data-artist="{{ image.artist|default('')|e }}"
           data-copyright="{{ image.copyright|default('')|e }}"
           data-process="{{ image.process|default('')|e }}"
           {% if image.custom_fields is defined and image.custom_fields|length > 0 %}data-custom-fields="{{ image.custom_fields|json_encode|e('html_attr') }}"{% endif %}
        >
          <picture>
            {% if image.sources and image.sources.avif|length %}
              <source type="image/avif" srcset="{% for src in image.sources.avif %}{% set src_url = src|split(' ')[0] %}{{ base_path }}{{ src_url }} {{ src|split(' ')[1] }}{% if not loop.last %}, {% endif %}{% endfor %}" sizes="(min-width: 1024px) 33vw, (min-width: 768px) 50vw, 100vw">
            {% endif %}
            {% if image.sources and image.sources.webp|length %}
              <source type="image/webp" srcset="{% for src in image.sources.webp %}{% set src_url = src|split(' ')[0] %}{{ base_path }}{{ src_url }} {{ src|split(' ')[1] }}{% if not loop.last %}, {% endif %}{% endfor %}" sizes="(min-width: 1024px) 33vw, (min-width: 768px) 50vw, 100vw">
            {% endif %}
            {% if image.sources and image.sources.jpg|length %}
              <source type="image/jpeg" srcset="{% for src in image.sources.jpg %}{% set src_url = src|split(' ')[0] %}{{ base_path }}{{ src_url }} {{ src|split(' ')[1] }}{% if not loop.last %}, {% endif %}{% endfor %}" sizes="(min-width: 1024px) 33vw, (min-width: 768px) 50vw, 100vw">
            {% endif %}
            <img src="{% set img_src = image.fallback_src|default(image.url) %}{% if img_src starts with '/' %}{{ base_path }}{{ img_src }}{% else %}{{ img_src }}{% endif %}" alt="{{ image.alt|e }}" title="{{ seo_title|e('html_attr') }}" class="w-full h-auto block" loading="lazy" decoding="async">
          </picture>
        </a>
      </div>
      {% endfor %}
    </div>
    <style nonce="{{ csp_nonce() }}">
    .masonry-fit-container {
        column-gap: {{ gap_h }}px;
    }
    .masonry-fit-container .masonry-fit-item {
        margin-bottom: {{ gap_v }}px;
    }
    @media (min-width: 1024px) {
        .masonry-fit-container { column-count: {{ desktop_cols }}; }
    }
    @media (min-width: 768px) and (max-width: 1023px) {
        .masonry-fit-container { column-count: {{ tablet_cols }}; }
    }
    @media (max-width: 767px) {
        .masonry-fit-container { column-count: {{ mobile_cols }}; }
    }
    </style>

  {# 2. SLIDESHOW PRO - Con controlli avanzati #}
  {% elseif layout == 'slideshow' %}
    <div id="images-gallery" class="max-w-6xl mx-auto">
      <div class="swiper slideshow-pro" data-autoplay="{{ template_settings.slideshow.autoplay|default(true) }}" data-delay="{{ template_settings.slideshow.delay|default(5000) }}">
        <div class="swiper-wrapper">
          {% for image in images %}
          <div class="swiper-slide relative">
            {% set seo_title = Seo.seo_title(image, album, site_title)|trim %}
            <a href="{% set href_src = image.lightbox_url|default(image.url) %}{% if href_src starts with '/' %}{{ base_path }}{{ href_src }}{% else %}{{ href_src }}{% endif %}" 
               class="pswp-link image-item block h-[70vh] bg-neutral-100 rounded-xl overflow-hidden flex items-center justify-center"
               title="{{ seo_title|e('html_attr') }}"
               data-image-id="{{ image.id }}"
               data-pswp-width="{{ image.width|default(1600) }}"
               data-pswp-height="{{ image.height|default(1067) }}"
               data-pswp-caption="{{ image.caption_html|default(image.caption)|e('html_attr') }}"
               data-title="{{ image.caption|default('')|e }}"
               data-alt="{{ image.alt|default('')|e }}"
               data-camera="{{ image.camera|default(image.camera_name)|default(image.custom_camera)|default('')|e }}"
               data-lens="{{ image.lens|default(image.lens_name)|default(image.custom_lens)|default('')|e }}"
               data-film="{{ image.film_name|default(image.custom_film)|default('')|e }}"
               data-developer="{{ image.developer_name|default('')|e }}"
               data-lab="{{ image.lab_name|default('')|e }}"
               data-location="{{ image.location_name|default('')|e }}"
               data-iso="{{ image.iso|default('') }}"
               data-shutter="{{ image.shutter_speed|default('')|e }}"
               data-aperture="{{ image.aperture|default('') }}"
               data-focal-length="{{ image.focal_length|default('') }}"
               data-exif-make="{{ image.exif_make|default('')|e }}"
               data-exif-model="{{ image.exif_model|default('')|e }}"
               data-exif-lens="{{ image.exif_lens_model|default('')|e }}"
               data-gps-lat="{{ image.gps_lat|default('') }}"
               data-gps-lng="{{ image.gps_lng|default('') }}"
               data-date-original="{{ image.date_original|default('')|e }}"
               data-artist="{{ image.artist|default('')|e }}"
               data-copyright="{{ image.copyright|default('')|e }}"
               data-process="{{ image.process|default('')|e }}"
            >
              <picture>
                {% if image.sources and image.sources.avif|length %}
                  <source type="image/avif" srcset="{% for src in image.sources.avif %}{% set src_url = src|split(' ')[0] %}{{ base_path }}{{ src_url }} {{ src|split(' ')[1] }}{% if not loop.last %}, {% endif %}{% endfor %}" sizes="100vw">
                {% endif %}
                {% if image.sources and image.sources.webp|length %}
                  <source type="image/webp" srcset="{% for src in image.sources.webp %}{% set src_url = src|split(' ')[0] %}{{ base_path }}{{ src_url }} {{ src|split(' ')[1] }}{% if not loop.last %}, {% endif %}{% endfor %}" sizes="100vw">
                {% endif %}
                {% if image.sources and image.sources.jpg|length %}
                  <source type="image/jpeg" srcset="{% for src in image.sources.jpg %}{% set src_url = src|split(' ')[0] %}{{ base_path }}{{ src_url }} {{ src|split(' ')[1] }}{% if not loop.last %}, {% endif %}{% endfor %}" sizes="100vw">
                {% endif %}
                <img src="{% set img_src = image.fallback_src|default(image.url) %}{% if img_src starts with '/' %}{{ base_path }}{{ img_src }}{% else %}{{ img_src }}{% endif %}" alt="{{ image.alt|default('Image')|e }}" title="{{ seo_title|e('html_attr') }}" class="max-w-full max-h-full object-contain" style="aspect-ratio: {{ image.width|default(4) }} / {{ image.height|default(3) }};" loading="lazy" decoding="async">
              </picture>
            </a>
            {% if image.caption %}
            <div class="absolute bottom-4 left-4 right-4 bg-black/70 text-white p-4 rounded-lg backdrop-blur-sm">
              <p class="text-sm">{{ image.caption|e }}</p>
            </div>
            {% endif %}
          </div>
          {% endfor %}
        </div>
        <div class="swiper-button-next !text-white !bg-black/30 !rounded-full !w-12 !h-12"></div>
        <div class="swiper-button-prev !text-white !bg-black/30 !rounded-full !w-12 !h-12"></div>
        <div class="swiper-pagination !bottom-2"></div>
        {% if template_settings.slideshow.showProgress|default(true) %}
        <div class="swiper-scrollbar !bg-white/20"></div>
        {% endif %}
      </div>
      {% if template_settings.slideshow.showThumbs|default(true) %}
      <div class="swiper slideshow-thumbs mt-4">
        <div class="swiper-wrapper">
          {% for image in images %}
          <div class="swiper-slide !w-20 !h-16 cursor-pointer opacity-60 hover:opacity-100 transition-opacity">
            <img src="{% if image.url starts with '/' %}{{ base_path }}{{ image.url }}{% else %}{{ image.url }}{% endif %}" alt="" class="w-full h-full object-contain rounded">
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>

  {# 3. GRID MINIMAL - Design pulito #}
  {% elseif layout == 'grid' and template_settings.spacing == 'large' %}
    <div id="images-gallery" class="grid {{ mobile_class|default('grid-cols-1') }} {{ tablet_class|default('md:grid-cols-2') }} {{ desktop_class|default('lg:grid-cols-3') }} gap-8">
      {% for image in images %}
      <div class="grid-minimal-item group">
        {% set seo_title = Seo.seo_title(image, album, site_title)|trim %}
        <a href="{% set href_src = image.lightbox_url|default(image.url) %}{% if href_src starts with '/' %}{{ base_path }}{{ href_src }}{% else %}{{ href_src }}{% endif %}" 
           class="pswp-link image-item block aspect-square bg-neutral-50 rounded-2xl overflow-hidden shadow-lg hover:shadow-xl transition-shadow duration-300 ease-out"
           title="{{ seo_title|e('html_attr') }}"
           data-image-id="{{ image.id }}"
           data-pswp-width="{{ image.width|default(1600) }}"
           data-pswp-height="{{ image.height|default(1067) }}"
           data-pswp-caption="{{ image.caption_html|default(image.caption)|e('html_attr') }}"
           data-title="{{ image.caption|default('')|e }}"
           data-alt="{{ image.alt|default('')|e }}"
           data-camera="{{ image.camera_name|default(image.custom_camera)|default('')|e }}"
           data-lens="{{ image.lens_name|default(image.custom_lens)|default('')|e }}"
           data-film="{{ image.film_name|default(image.custom_film)|default('')|e }}"
           data-developer="{{ image.developer_name|default('')|e }}"
           data-lab="{{ image.lab_name|default('')|e }}"
           data-location="{{ image.location_name|default('')|e }}"
           data-iso="{{ image.iso|default('') }}"
           data-shutter="{{ image.shutter_speed|default('')|e }}"
           data-aperture="{{ image.aperture|default('') }}"
           data-focal-length="{{ image.focal_length|default('') }}"
           data-exif-make="{{ image.exif_make|default('')|e }}"
           data-exif-model="{{ image.exif_model|default('')|e }}"
           data-exif-lens="{{ image.exif_lens_model|default('')|e }}"
           data-gps-lat="{{ image.gps_lat|default('') }}"
           data-gps-lng="{{ image.gps_lng|default('') }}"
           data-date-original="{{ image.date_original|default('')|e }}"
           data-artist="{{ image.artist|default('')|e }}"
           data-copyright="{{ image.copyright|default('')|e }}"
           data-process="{{ image.process|default('')|e }}"
           {% if image.custom_fields is defined and image.custom_fields|length > 0 %}data-custom-fields="{{ image.custom_fields|json_encode|e('html_attr') }}"{% endif %}
        >
          <div class="relative w-full h-full">
            <picture>
              {% if image.sources and image.sources.avif|length %}
                <source type="image/avif" srcset="{% for src in image.sources.avif %}{% set src_url = src|split(' ')[0] %}{{ base_path }}{{ src_url }} {{ src|split(' ')[1] }}{% if not loop.last %}, {% endif %}{% endfor %}" sizes="100vw">
              {% endif %}
              {% if image.sources and image.sources.webp|length %}
                <source type="image/webp" srcset="{% for src in image.sources.webp %}{% set src_url = src|split(' ')[0] %}{{ base_path }}{{ src_url }} {{ src|split(' ')[1] }}{% if not loop.last %}, {% endif %}{% endfor %}" sizes="100vw">
              {% endif %}
              {% if image.sources and image.sources.jpg|length %}
                <source type="image/jpeg" srcset="{% for src in image.sources.jpg %}{% set src_url = src|split(' ')[0] %}{{ base_path }}{{ src_url }} {{ src|split(' ')[1] }}{% if not loop.last %}, {% endif %}{% endfor %}" sizes="100vw">
              {% endif %}
              <img src="{% set img_src = image.fallback_src|default(image.url) %}{% if img_src starts with '/' %}{{ base_path }}{{ img_src }}{% else %}{{ img_src }}{% endif %}" alt="{{ image.alt|e }}" title="{{ seo_title|e('html_attr') }}" class="w-full h-full object-cover group-hover:scale-[1.03] transition-transform duration-300 ease-out" loading="lazy" decoding="async">
            </picture>
            <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
          </div>
        </a>
      </div>
      {% endfor %}
    </div>

  {# 4. MOSAIC PRO - Dimensioni variabili #}
  {% elseif layout == 'mosaic' %}
    <div id="images-gallery" class="mosaic-container">
      {% for image in images %}
      {% set featured = loop.index0 % 6 == 0 or loop.index0 % 6 == 3 %}
      <div class="mosaic-item {{ featured ? 'mosaic-featured' : 'mosaic-normal' }}" data-index="{{ loop.index0 }}">
        {% set seo_title = Seo.seo_title(image, album, site_title)|trim %}
        <a href="{% set href_src = image.lightbox_url|default(image.url) %}{% if href_src starts with '/' %}{{ base_path }}{{ href_src }}{% else %}{{ href_src }}{% endif %}"
           class="pswp-link image-item block w-full h-full bg-neutral-100 rounded-lg overflow-hidden shadow-md hover:shadow-lg transition-shadow duration-300 ease-out hover:z-10 {{ featured ? 'flex items-center justify-center' : '' }}"
           title="{{ seo_title|e('html_attr') }}"
           data-image-id="{{ image.id }}"
           data-pswp-width="{{ image.width|default(1600) }}"
           data-pswp-height="{{ image.height|default(1067) }}"
           data-pswp-caption="{{ image.caption_html|default(image.caption)|e('html_attr') }}"
           data-title="{{ image.caption|default('')|e }}"
           data-alt="{{ image.alt|default('')|e }}"
           data-camera="{{ image.camera_name|default(image.custom_camera)|default('')|e }}"
           data-lens="{{ image.lens_name|default(image.custom_lens)|default('')|e }}"
           data-film="{{ image.film_name|default(image.custom_film)|default('')|e }}"
           data-developer="{{ image.developer_name|default('')|e }}"
           data-lab="{{ image.lab_name|default('')|e }}"
           data-location="{{ image.location_name|default('')|e }}"
           data-iso="{{ image.iso|default('') }}"
           data-shutter="{{ image.shutter_speed|default('')|e }}"
           data-aperture="{{ image.aperture|default('') }}"
           data-focal-length="{{ image.focal_length|default('') }}"
           data-exif-make="{{ image.exif_make|default('')|e }}"
           data-exif-model="{{ image.exif_model|default('')|e }}"
           data-exif-lens="{{ image.exif_lens_model|default('')|e }}"
           data-gps-lat="{{ image.gps_lat|default('') }}"
           data-gps-lng="{{ image.gps_lng|default('') }}"
           data-date-original="{{ image.date_original|default('')|e }}"
           data-artist="{{ image.artist|default('')|e }}"
           data-copyright="{{ image.copyright|default('')|e }}"
           data-process="{{ image.process|default('')|e }}"
           {% if image.custom_fields is defined and image.custom_fields|length > 0 %}data-custom-fields="{{ image.custom_fields|json_encode|e('html_attr') }}"{% endif %}>
          <img src="{% if image.url starts with '/' %}{{ base_path }}{{ image.url }}{% else %}{{ image.url }}{% endif %}" alt="{{ image.alt|e }}" title="{{ seo_title|e('html_attr') }}" class="w-full h-full {{ featured ? 'object-contain max-w-full max-h-full' : 'object-cover' }}">
        </a>
      </div>
      {% endfor %}
    </div>

  {# 5. CAROUSEL FLOW - Scroll orizzontale #}
  {% elseif layout == 'carousel' %}
    <div id="images-gallery" class="carousel-flow-container overflow-hidden">
      <div class="swiper carousel-flow" data-centered="true" data-free-mode="true">
        <div class="swiper-wrapper">
          {% for image in images %}
          <div class="swiper-slide !w-auto !h-[80vh] px-2">
            {% set seo_title = Seo.seo_title(image, album, site_title)|trim %}
            <a href="{% set href_src = image.lightbox_url|default(image.url) %}{% if href_src starts with '/' %}{{ base_path }}{{ href_src }}{% else %}{{ href_src }}{% endif %}"
               class="pswp-link image-item block h-full bg-neutral-100 rounded-2xl overflow-hidden shadow-lg hover:shadow-xl transition-shadow duration-300 ease-out relative flex items-center justify-center"
               title="{{ seo_title|e('html_attr') }}"
               data-image-id="{{ image.id }}"
               data-pswp-width="{{ image.width|default(1600) }}"
               data-pswp-height="{{ image.height|default(1067) }}"
               data-pswp-caption="{{ image.caption_html|default(image.caption)|e('html_attr') }}"
               data-title="{{ image.caption|default('')|e }}"
               data-alt="{{ image.alt|default('')|e }}"
               data-camera="{{ image.camera|default(image.camera_name)|default(image.custom_camera)|default('')|e }}"
               data-lens="{{ image.lens|default(image.lens_name)|default(image.custom_lens)|default('')|e }}"
               data-film="{{ image.film_name|default(image.custom_film)|default('')|e }}"
               data-developer="{{ image.developer_name|default('')|e }}"
               data-lab="{{ image.lab_name|default('')|e }}"
               data-location="{{ image.location_name|default('')|e }}"
               data-iso="{{ image.iso|default('') }}"
               data-shutter="{{ image.shutter_speed|default('')|e }}"
               data-aperture="{{ image.aperture|default('') }}"
               data-focal-length="{{ image.focal_length|default('') }}"
               data-exif-make="{{ image.exif_make|default('')|e }}"
               data-exif-model="{{ image.exif_model|default('')|e }}"
               data-exif-lens="{{ image.exif_lens_model|default('')|e }}"
               data-gps-lat="{{ image.gps_lat|default('') }}"
               data-gps-lng="{{ image.gps_lng|default('') }}"
               data-date-original="{{ image.date_original|default('')|e }}"
               data-artist="{{ image.artist|default('')|e }}"
               data-copyright="{{ image.copyright|default('')|e }}"
               data-process="{{ image.process|default('')|e }}">
              <img src="{% if image.url starts with '/' %}{{ base_path }}{{ image.url }}{% else %}{{ image.url }}{% endif %}" alt="{{ image.alt|e }}" title="{{ seo_title|e('html_attr') }}" class="max-h-full max-w-full object-contain" style="aspect-ratio: {{ image.width|default(4) }} / {{ image.height|default(3) }};">
            </a>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

  {# 6. POLAROID VINTAGE - Stile retr√≤ #}
  {% elseif layout == 'polaroid' %}
    <div id="images-gallery" class="polaroid-container relative p-8" style="background: linear-gradient(45deg, #8b4513, #a0522d); min-height: 60vh;">
      {% for image in images %}
      {% set rotation_values = [-8, -6, -4, -2, 0, 2, 4, 6, 8] %}
      {% set rotation = rotation_values[loop.index0 % 9] %}
      <div class="polaroid-item absolute"
           style="--rotation: {{ rotation }}deg; transform: rotate(var(--rotation)); top: {{ (loop.index0 * 15) % 60 + 10 }}%; left: {{ (loop.index0 * 20) % 80 + 5 }}%;">
        {% set seo_title = Seo.seo_title(image, album, site_title)|trim %}
        <a href="{% set href_src = image.lightbox_url|default(image.url) %}{% if href_src starts with '/' %}{{ base_path }}{{ href_src }}{% else %}{{ href_src }}{% endif %}"
           class="pswp-link image-item block bg-white p-3 pb-12 shadow-2xl hover:shadow-3xl transition-shadow duration-300 ease-out hover:z-50 relative"
           title="{{ seo_title|e('html_attr') }}"
           data-image-id="{{ image.id }}"
           data-pswp-width="{{ image.width|default(1600) }}"
           data-pswp-height="{{ image.height|default(1067) }}"
           data-pswp-caption="{{ image.caption_html|default(image.caption)|e('html_attr') }}"
           data-title="{{ image.caption|default('')|e }}"
           data-alt="{{ image.alt|default('')|e }}"
           data-camera="{{ image.camera_name|default(image.custom_camera)|default('')|e }}"
           data-lens="{{ image.lens_name|default(image.custom_lens)|default('')|e }}"
           data-film="{{ image.film_name|default(image.custom_film)|default('')|e }}"
           data-developer="{{ image.developer_name|default('')|e }}"
           data-lab="{{ image.lab_name|default('')|e }}"
           data-location="{{ image.location_name|default('')|e }}"
           data-iso="{{ image.iso|default('') }}"
           data-shutter="{{ image.shutter_speed|default('')|e }}"
           data-aperture="{{ image.aperture|default('') }}"
           data-focal-length="{{ image.focal_length|default('') }}"
           data-exif-make="{{ image.exif_make|default('')|e }}"
           data-exif-model="{{ image.exif_model|default('')|e }}"
           data-exif-lens="{{ image.exif_lens_model|default('')|e }}"
           data-gps-lat="{{ image.gps_lat|default('') }}"
           data-gps-lng="{{ image.gps_lng|default('') }}"
           data-date-original="{{ image.date_original|default('')|e }}"
           data-artist="{{ image.artist|default('')|e }}"
           data-copyright="{{ image.copyright|default('')|e }}"
           data-process="{{ image.process|default('')|e }}"
           {% if image.custom_fields is defined and image.custom_fields|length > 0 %}data-custom-fields="{{ image.custom_fields|json_encode|e('html_attr') }}"{% endif %}
           style="width: 200px; filter: sepia(0.2) contrast(1.1) brightness(1.05);">
          <img src="{% if image.url starts with '/' %}{{ base_path }}{{ image.url }}{% else %}{{ image.url }}{% endif %}" alt="{{ image.alt|e }}" title="{{ seo_title|e('html_attr') }}" class="w-full aspect-square object-cover">
          {% if image.caption %}
          <div class="absolute bottom-2 left-3 right-3 text-center text-xs font-handwriting text-gray-700">
            {{ image.caption|e|slice(0, 40) }}{% if image.caption|length > 40 %}...{% endif %}
          </div>
          {% endif %}
          <div class="absolute -top-2 left-1/2 transform -translate-x-1/2 w-8 h-4 bg-yellow-100/80 rounded-sm shadow-sm"></div>
        </a>
      </div>
      {% endfor %}
    </div>

  {# DEFAULT: Standard masonry with CSS columns #}
  {% elseif masonry %}
    <div id="images-gallery" class="masonry-grid pswp-gallery" data-layout="masonry">
      {% for image in images %}
      <div class="masonry-item">
        {% set seo_title = Seo.seo_title(image, album, site_title)|trim %}
        <a href="{% set href_src = image.lightbox_url|default(image.url) %}{% if href_src starts with '/' %}{{ base_path }}{{ href_src }}{% else %}{{ href_src }}{% endif %}"
           class="pswp-link image-item bg-neutral-100 rounded-lg overflow-hidden shadow-sm hover:shadow-lg transition-shadow cursor-pointer mb-4 group relative block"
           title="{{ seo_title|e('html_attr') }}"
           data-image-id="{{ image.id }}"
           data-pswp-width="{{ image.width|default(1600) }}"
           data-pswp-height="{{ image.height|default(1067) }}"
           data-pswp-caption="{{ image.caption_html|default(image.caption)|e('html_attr') }}"
           data-title="{{ image.caption|default('')|e }}"
           data-alt="{{ image.alt|default('')|e }}"
           data-camera="{{ image.camera_name|default(image.custom_camera)|default('')|e }}"
           data-lens="{{ image.lens_name|default(image.custom_lens)|default('')|e }}"
           data-film="{{ image.film_name|default(image.custom_film)|default('')|e }}"
           data-developer="{{ image.developer_name|default('')|e }}"
           data-lab="{{ image.lab_name|default('')|e }}"
           data-location="{{ image.location_name|default('')|e }}"
           data-iso="{{ image.iso|default('') }}"
           data-shutter="{{ image.shutter_speed|default('')|e }}"
           data-aperture="{{ image.aperture|default('') }}"
           data-focal-length="{{ image.focal_length|default('') }}"
           data-exif-make="{{ image.exif_make|default('')|e }}"
           data-exif-model="{{ image.exif_model|default('')|e }}"
           data-exif-lens="{{ image.exif_lens_model|default('')|e }}"
           data-gps-lat="{{ image.gps_lat|default('') }}"
           data-gps-lng="{{ image.gps_lng|default('') }}"
           data-date-original="{{ image.date_original|default('')|e }}"
           data-artist="{{ image.artist|default('')|e }}"
           data-copyright="{{ image.copyright|default('')|e }}"
           data-process="{{ image.process|default('')|e }}"
           {% if image.custom_fields is defined and image.custom_fields|length > 0 %}data-custom-fields="{{ image.custom_fields|json_encode|e('html_attr') }}"{% endif %}>
          <img src="{% if image.url starts with '/' %}{{ base_path }}{{ image.url }}{% else %}{{ image.url }}{% endif %}" alt="{{ image.alt|e }}" title="{{ seo_title|e('html_attr') }}" class="w-full h-auto object-cover">
        </a>
      </div>
      {% endfor %}
    </div>
    <style nonce="{{ csp_nonce() }}">
    .masonry-grid {
        column-gap: 1rem;
    }
    .masonry-grid .masonry-item {
        break-inside: avoid;
        margin-bottom: 1rem;
    }
    @media (min-width: 1024px) {
        .masonry-grid { column-count: {{ desktop_cols }}; }
    }
    @media (min-width: 768px) and (max-width: 1023px) {
        .masonry-grid { column-count: {{ tablet_cols }}; }
    }
    @media (max-width: 767px) {
        .masonry-grid { column-count: {{ mobile_cols }}; }
    }
    </style>
  {% else %}
    {% if mobile_cols == 1 %}{% set mobile_class = 'grid-cols-1' %}
    {% elseif mobile_cols == 2 %}{% set mobile_class = 'grid-cols-2' %}
    {% elseif mobile_cols == 3 %}{% set mobile_class = 'grid-cols-3' %}
    {% elseif mobile_cols == 4 %}{% set mobile_class = 'grid-cols-4' %}
    {% elseif mobile_cols == 5 %}{% set mobile_class = 'grid-cols-5' %}
    {% else %}{% set mobile_class = 'grid-cols-6' %}{% endif %}
    
    {% if tablet_cols == 1 %}{% set tablet_class = 'md:grid-cols-1' %}
    {% elseif tablet_cols == 2 %}{% set tablet_class = 'md:grid-cols-2' %}
    {% elseif tablet_cols == 3 %}{% set tablet_class = 'md:grid-cols-3' %}
    {% elseif tablet_cols == 4 %}{% set tablet_class = 'md:grid-cols-4' %}
    {% elseif tablet_cols == 5 %}{% set tablet_class = 'md:grid-cols-5' %}
    {% else %}{% set tablet_class = 'md:grid-cols-6' %}{% endif %}
    
    {% if desktop_cols == 1 %}{% set desktop_class = 'lg:grid-cols-1' %}
    {% elseif desktop_cols == 2 %}{% set desktop_class = 'lg:grid-cols-2' %}
    {% elseif desktop_cols == 3 %}{% set desktop_class = 'lg:grid-cols-3' %}
    {% elseif desktop_cols == 4 %}{% set desktop_class = 'lg:grid-cols-4' %}
    {% elseif desktop_cols == 5 %}{% set desktop_class = 'lg:grid-cols-5' %}
    {% else %}{% set desktop_class = 'lg:grid-cols-6' %}{% endif %}
    <div id="images-gallery" class="grid {{ mobile_class }} {{ tablet_class }} {{ desktop_class }} gap-4">
      {% for image in images %}
      <div class="masonry-item">
        {% set seo_title = Seo.seo_title(image, album, site_title)|trim %}
        <a href="{% set href_src = image.lightbox_url|default(image.url) %}{% if href_src starts with '/' %}{{ base_path }}{{ href_src }}{% else %}{{ href_src }}{% endif %}"
           class="pswp-link image-item aspect-[4/3] bg-neutral-100 rounded-lg overflow-hidden shadow-sm hover:shadow-lg transition-shadow cursor-pointer group relative block"
           title="{{ seo_title|e('html_attr') }}"
           data-image-id="{{ image.id }}"
           data-pswp-width="{{ image.width|default(1600) }}"
           data-pswp-height="{{ image.height|default(1067) }}"
           data-pswp-caption="{{ image.caption_html|default(image.caption)|e('html_attr') }}"
           data-title="{{ image.caption|default('')|e }}"
           data-alt="{{ image.alt|default('')|e }}"
           data-camera="{{ image.camera_name|default(image.custom_camera)|default('')|e }}"
           data-lens="{{ image.lens_name|default(image.custom_lens)|default('')|e }}"
           data-film="{{ image.film_name|default(image.custom_film)|default('')|e }}"
           data-developer="{{ image.developer_name|default('')|e }}"
           data-lab="{{ image.lab_name|default('')|e }}"
           data-location="{{ image.location_name|default('')|e }}"
           data-iso="{{ image.iso|default('') }}"
           data-shutter="{{ image.shutter_speed|default('')|e }}"
           data-aperture="{{ image.aperture|default('') }}"
           data-focal-length="{{ image.focal_length|default('') }}"
           data-exif-make="{{ image.exif_make|default('')|e }}"
           data-exif-model="{{ image.exif_model|default('')|e }}"
           data-exif-lens="{{ image.exif_lens_model|default('')|e }}"
           data-gps-lat="{{ image.gps_lat|default('') }}"
           data-gps-lng="{{ image.gps_lng|default('') }}"
           data-date-original="{{ image.date_original|default('')|e }}"
           data-artist="{{ image.artist|default('')|e }}"
           data-copyright="{{ image.copyright|default('')|e }}"
           data-process="{{ image.process|default('')|e }}"
           {% if image.custom_fields is defined and image.custom_fields|length > 0 %}data-custom-fields="{{ image.custom_fields|json_encode|e('html_attr') }}"{% endif %}>
          <picture>
            {% if image.sources and image.sources.avif|length %}
              <source type="image/avif" srcset="{% for src in image.sources.avif %}{% set src_url = src|split(' ')[0] %}{{ base_path }}{{ src_url }} {{ src|split(' ')[1] }}{% if not loop.last %}, {% endif %}{% endfor %}" sizes="100vw">
            {% endif %}
            {% if image.sources and image.sources.webp|length %}
              <source type="image/webp" srcset="{% for src in image.sources.webp %}{% set src_url = src|split(' ')[0] %}{{ base_path }}{{ src_url }} {{ src|split(' ')[1] }}{% if not loop.last %}, {% endif %}{% endfor %}" sizes="100vw">
            {% endif %}
               {% if image.sources and image.sources.jpg|length %}
                 <source type="image/jpeg" srcset="{% for src in image.sources.jpg %}{% set src_url = src|split(' ')[0] %}{{ base_path }}{{ src_url }} {{ src|split(' ')[1] }}{% if not loop.last %}, {% endif %}{% endfor %}" sizes="100vw">
               {% endif %}
                <img src="{% set img_src = image.fallback_src|default(image.url) %}{% if img_src starts with '/' %}{{ base_path }}{{ img_src }}{% else %}{{ img_src }}{% endif %}" alt="{{ image.alt|e }}" title="{{ seo_title|e('html_attr') }}" class="w-full h-full object-cover" loading="lazy" decoding="async">
          </picture>
        </a>
      </div>
      {% endfor %}
    </div>
  {% endif %}
  {% endif %}

</div>
{% endblock %}

{% block scripts %}
<script nonce="{{ csp_nonce() }}">
// Global base path for API calls
window.basePath = '{{ base_path }}';

// Store template settings globally for AJAX reloads
window.templateSettings = {{ template_settings ? template_settings|json_encode|raw : '{}' }};

const layout = window.templateSettings.layout || 'grid';
const masonry = window.templateSettings.masonry || false;

// Initialize layouts based on template settings
document.addEventListener('DOMContentLoaded', function() {
  initializeGalleryLayout();
  // If magazine is active on first render, ensure autoscroll
  try {
    if (window.templateSettings?.layout === 'magazine') {
      if (typeof initMagazineAutoscroll === 'function') {
        setTimeout(() => { initMagazineAutoscroll(); }, 100);
      } else {
        // Inline fallback
        (function(){
          try {
            document.querySelectorAll('.m-col').forEach(function(col){
              var track = col.querySelector('.m-track'); if (!track) return;
              var dir = (col.getAttribute('data-direction')||'down').toLowerCase();
              var dur = (getComputedStyle(col).getPropertyValue('--m-duration')||'60s').trim() || '60s';
              track.style.animation = (dir==='up'?'mScrollUp':'mScrollDown') + ' ' + dur + ' linear infinite';
              track.style.animationPlayState = 'running';
            });
            document.querySelectorAll('.m-mobile-wrap').forEach(function(mwrap){
              var track = mwrap.querySelector('.m-mobile-track'); if (!track) return;
              var dur = (getComputedStyle(mwrap).getPropertyValue('--m-duration')||'60s').trim() || '60s';
              track.style.animation = 'mScrollDown ' + dur + ' linear infinite';
              track.style.animationPlayState = 'running';
            });
          } catch(e) { console.error(e); }
        })();
      }
    }
  } catch(e){}
  
  // Gallery animation handled by animateGalleryOnce in _layout.twig
  // DO NOT manually set opacity here to avoid double animation
});

function initializeGalleryLayout() {
  const layout = window.templateSettings?.layout || 'grid';
  const masonry = window.templateSettings?.masonry || false;
  
  // 1. MASONRY FIT - No special JS needed, pure CSS Grid
  
  // 2. SLIDESHOW PRO - Enhanced slideshow with thumbnails
  if (layout === 'slideshow' && typeof Swiper !== 'undefined') {
    const slideshowThumbs = new Swiper('.slideshow-thumbs', {
      spaceBetween: 10,
      slidesPerView: 'auto',
      freeMode: true,
      watchSlidesProgress: true,
    });
    
    window.gallerySwiper = new Swiper('.slideshow-pro', {
      spaceBetween: 10,
      navigation: {
        nextEl: '.swiper-button-next',
        prevEl: '.swiper-button-prev',
      },
      pagination: {
        el: '.swiper-pagination',
        clickable: true,
      },
      thumbs: {
        swiper: slideshowThumbs,
      },
      loop: true,
      autoplay: window.templateSettings?.slideshow?.autoplay ? {
        delay: window.templateSettings?.slideshow?.delay || 5000,
        disableOnInteraction: false,
      } : false,
      effect: 'fade',
      fadeEffect: {
        crossFade: true
      }
    });
  }
  
  // 3. GRID MINIMAL - No special JS needed, pure CSS with hover effects
  
  // 4. MOSAIC PRO - No special JS needed, pure CSS Grid
  
  // 5. CAROUSEL FLOW - Horizontal scrolling carousel
  else if (layout === 'carousel' && typeof Swiper !== 'undefined') {
    window.gallerySwiper = new Swiper('.carousel-flow', {
      slidesPerView: 'auto',
      spaceBetween: 20,
      centeredSlides: true,
      freeMode: true,
      grabCursor: true,
      mousewheel: {
        thresholdDelta: 70,
        forceToAxis: true,
      },
      breakpoints: {
        640: {
          spaceBetween: 30,
        },
        1024: {
          spaceBetween: 40,
        },
      }
    });
  }
  
  // 6. POLAROID VINTAGE - Add random positioning for desktop
  else if (layout === 'polaroid') {
    const polaroidItems = document.querySelectorAll('.polaroid-item');
    
    // Only apply random positioning on desktop
    if (window.innerWidth > 768) {
      polaroidItems.forEach((item, index) => {
        const randomX = Math.random() * 80 + 5; // 5-85%
        const randomY = Math.random() * 60 + 10; // 10-70%
        const randomRotation = (Math.random() - 0.5) * 16; // -8 to +8 degrees
        
        item.style.left = randomX + '%';
        item.style.top = randomY + '%';
        item.style.transform = `rotate(${randomRotation}deg)`;
        item.style.zIndex = Math.floor(Math.random() * 10) + 1;
      });
    }
  }
  
  // DEFAULT: Standard masonry for backward compatibility
  // Only use Masonry JS when layout explicitly needs JS masonry (not grid+columns)
  else if (masonry && (layout === 'masonry' || window.templateSettings?.masonry_js === true) && typeof Masonry !== 'undefined') {
    const container = document.getElementById('images-gallery');
    if (container) {
      imagesLoaded(container, function(){
        window.galleryMasonry = new Masonry(container, {
          itemSelector: '.masonry-item',
          percentPosition: true
        });
        // Animation handled by animateGalleryOnce in _layout.twig
      });
    }
  }
  // Animation handled by animateGalleryOnce in _layout.twig - DO NOT set opacity here
}

// Magazine Split autoscroll initializer - Enhanced responsive version
function initMagazineAutoscroll() {
  try {
    console.log('initMagazineAutoscroll called - Enhanced responsive version');
    var container = document.getElementById('images-gallery') || document;
    
    // Responsive display management
    var isMobile = window.matchMedia('(max-width: 767px)').matches;
    var isTablet = window.matchMedia('(min-width: 768px) and (max-width: 1199px)').matches;
    var isDesktop = window.matchMedia('(min-width: 1200px)').matches;
    
    var mob = container.querySelector('.m-mobile-wrap');
    var tablet = container.querySelector('.m-tablet-wrap');
    var desk = container.querySelector('.m-desktop-wrap');
    
    console.log('Found wrappers - Mobile:', !!mob, 'Tablet:', !!tablet, 'Desktop:', !!desk);
    console.log('Screen size - Mobile:', isMobile, 'Tablet:', isTablet, 'Desktop:', isDesktop);
    
    // Set appropriate display for each wrapper
    if (mob) mob.style.display = isMobile ? 'block' : 'none';
    if (tablet) tablet.style.display = isTablet ? 'flex' : 'none';
    if (desk) desk.style.display = isDesktop ? 'flex' : 'none';
    
    // Force setup column styles for all columns
    container.querySelectorAll('.m-col').forEach(function(col){
      if (!col.style.height) {
        if (col.classList.contains('m-tablet-col')) {
          col.style.height = '130vh';
        } else {
          col.style.height = '140vh';
        }
      }
      col.style.overflow = 'hidden';
      col.style.position = 'relative';
    });
    
    // Reset and restart mobile track animation
    var mobileTrack = container.querySelector('.m-mobile-track');
    if (mobileTrack) {
      mobileTrack.style.animation = 'none';
      mobileTrack.offsetHeight; // Force reflow
      
      var mobileDur = getComputedStyle(mobileTrack.closest('.m-mobile-wrap')).getPropertyValue('--m-duration').trim() || '45s';
      mobileTrack.style.animation = 'mScrollDown ' + mobileDur + ' linear infinite';
      mobileTrack.style.animationPlayState = 'running';
      console.log('Mobile track animated:', mobileDur);
    }
    
    // Reset and restart all column animations (tablet + desktop)
    container.querySelectorAll('.m-col .m-track').forEach(function(track){
      var col = track.closest('.m-col');
      if (!col) return;
      
      // Clear existing animation first
      track.style.animation = 'none';
      track.offsetHeight; // Force reflow
      
      var dir = (col.getAttribute('data-direction') || 'down').toLowerCase();
      var dur = (getComputedStyle(col).getPropertyValue('--m-duration') || '60s').trim();
      if (!dur) dur = '60s';
      
      var anim = (dir === 'up' ? 'mScrollUp' : 'mScrollDown') + ' ' + dur + ' linear infinite';
      track.style.animation = anim;
      track.style.animationPlayState = 'running';
      
      var colType = col.classList.contains('m-tablet-col') ? 'Tablet' : 'Desktop';
      console.log(colType + ' column animated:', dir, dur);
    });
    
    console.log('Enhanced Magazine autoscroll initialization complete');
  } catch(e) { 
    console.error('initMagazineAutoscroll error:', e); 
  }
}

// Template switcher functionality removed - using delegated handler below

// Fallback: delegated handler to intercept clicks even if buttons are re-rendered
// HARD INTERCEPT: handle both <button.tpl-switch> and <a.tpl-switch>
document.addEventListener('click', function(event) {
  const el = event.target.closest('.tpl-switch');
  if (!el) return;
  // Block native navigation for anchors
  if (el.tagName === 'A') event.preventDefault();
  if (el.dataset.switchInProgress === '1') return;
  el.dataset.switchInProgress = '1';

  const galleryContainer = document.getElementById('images-gallery');
  const templateId = el.getAttribute('data-template-id') || (el.tagName === 'A' ? (new URL(el.href, window.location.origin)).searchParams.get('template') : '');
  const albumRef = el.getAttribute('data-album-ref') || window.location.pathname.split('/').pop();
  if (!galleryContainer || !templateId || !albumRef) { delete el.dataset.switchInProgress; return; }

  const originalContent = galleryContainer.innerHTML;
  galleryContainer.innerHTML = '<div class="flex justify-center py-12"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-black"></div></div>';

  document.querySelectorAll('.tpl-switch').forEach(btn => {
    btn.classList.remove('bg-black', 'text-white');
    btn.classList.add('text-neutral-700', 'hover:bg-neutral-100');
  });
  el.classList.remove('text-neutral-700', 'hover:bg-neutral-100');
  el.classList.add('bg-black', 'text-white');

  const fetchUrl = `${window.basePath}/api/gallery/template?album=${encodeURIComponent(albumRef)}&template=${encodeURIComponent(templateId)}`;
  fetch(fetchUrl, { headers: { 'Accept': 'text/html', 'X-Requested-With': 'XMLHttpRequest' } })
    .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.text(); })
    .then(html => {
      galleryContainer.style.opacity = '0';
      galleryContainer.innerHTML = html;
      // Match direct object assignment from _gallery_content.twig
      const m = html.match(/window\.templateSettings\s*=\s*(\{[\s\S]*?\});/);
      if (m) { try { window.templateSettings = JSON.parse(m[1]); } catch(e) { console.error('Failed to parse templateSettings:', e); } }
      const newLayout = window.templateSettings?.layout || 'grid';
      const newMasonry = !!window.templateSettings?.masonry;
      const idKeep = galleryContainer.id;
      galleryContainer.className = '';
      // Remove any previous dynamic styles
      const prevMasonryFitStyle = document.getElementById('masonry-fit-dynamic-style');
      if (prevMasonryFitStyle) prevMasonryFitStyle.remove();
      const prevMasonryGridStyle = document.getElementById('masonry-grid-dynamic-style');
      if (prevMasonryGridStyle) prevMasonryGridStyle.remove();
      if (newLayout === 'magazine') {
        galleryContainer.className = 'mt-6';
      } else if (newLayout === 'slideshow') {
        galleryContainer.className = 'swiper slideshow-pro max-w-6xl mx-auto';
      } else if (newLayout === 'fullscreen') {
        galleryContainer.className = 'grid grid-cols-1 lg:grid-cols-2 gap-2';
      } else if (newLayout === 'masonry_fit' || newLayout === 'masonry') {
        // Masonry Full layout with CSS columns (full images)
        galleryContainer.className = 'masonry-fit-container pswp-gallery';
        galleryContainer.setAttribute('data-layout', newLayout);
        const cols = window.templateSettings?.columns || {desktop:3, tablet:2, mobile:1};
        const gap = window.templateSettings?.gap || {horizontal:16, vertical:16};
        const d = Math.round(cols.desktop || 3), t = Math.round(cols.tablet || 2), mob = Math.round(cols.mobile || 1);
        const gH = gap.horizontal || 16, gV = gap.vertical || 16;
        // Inject dynamic CSS for masonry_fit columns
        const styleEl = document.createElement('style');
        styleEl.id = 'masonry-fit-dynamic-style';
        styleEl.textContent = `
          .masonry-fit-container { column-gap: ${gH}px; }
          .masonry-fit-container .masonry-fit-item { margin-bottom: ${gV}px; }
          @media (min-width: 1024px) { .masonry-fit-container { column-count: ${d}; } }
          @media (min-width: 768px) and (max-width: 1023px) { .masonry-fit-container { column-count: ${t}; } }
          @media (max-width: 767px) { .masonry-fit-container { column-count: ${mob}; } }
        `;
        document.head.appendChild(styleEl);
      } else if (newMasonry) {
        // Standard masonry with CSS columns
        galleryContainer.className = 'masonry-grid pswp-gallery';
        galleryContainer.setAttribute('data-layout', 'masonry');
        const cols = window.templateSettings?.columns || {desktop:3, tablet:2, mobile:1};
        const d = Math.round(cols.desktop || 3), t = Math.round(cols.tablet || 2), mob = Math.round(cols.mobile || 1);
        // Remove previous masonry-grid dynamic style if exists
        const prevMasonryGridStyle = document.getElementById('masonry-grid-dynamic-style');
        if (prevMasonryGridStyle) prevMasonryGridStyle.remove();
        // Inject dynamic CSS for masonry columns
        const masonryStyleEl = document.createElement('style');
        masonryStyleEl.id = 'masonry-grid-dynamic-style';
        masonryStyleEl.textContent = `
          .masonry-grid { column-gap: 1rem; }
          .masonry-grid .masonry-item { break-inside: avoid; margin-bottom: 1rem; }
          @media (min-width: 1024px) { .masonry-grid { column-count: ${d}; } }
          @media (min-width: 768px) and (max-width: 1023px) { .masonry-grid { column-count: ${t}; } }
          @media (max-width: 767px) { .masonry-grid { column-count: ${mob}; } }
        `;
        document.head.appendChild(masonryStyleEl);
      } else {
        const cols = window.templateSettings?.columns || {desktop:3, tablet:2, mobile:1};
        let d = Math.round(cols.desktop || 3), t = Math.round(cols.tablet || 2), m = Math.round(cols.mobile || 1);
        const mc = m>=6?'grid-cols-6':m==5?'grid-cols-5':m==4?'grid-cols-4':m==3?'grid-cols-3':m==2?'grid-cols-2':'grid-cols-1';
        const tc = t>=6?'md:grid-cols-6':t==5?'md:grid-cols-5':t==4?'md:grid-cols-4':t==3?'md:grid-cols-3':t==2?'md:grid-cols-2':'md:grid-cols-1';
        const dc = d>=6?'lg:grid-cols-6':d==5?'lg:grid-cols-5':d==4?'lg:grid-cols-4':d==3?'lg:grid-cols-3':d==2?'lg:grid-cols-2':'lg:grid-cols-1';
        galleryContainer.className = `grid ${mc} ${tc} ${dc} gap-4`;
      }
      galleryContainer.id = idKeep;
      const newUrl = `${window.basePath}/album/${albumRef}?template=${templateId}`;
      history.pushState(null, '', newUrl);
      setTimeout(() => {
        if (typeof initLightbox === 'function') initLightbox();
        if (window.gallerySwiper?.destroy) { window.gallerySwiper.destroy(true, true); window.gallerySwiper = null; }
        if (window.galleryMasonry?.destroy) { window.galleryMasonry.destroy(); window.galleryMasonry = null; }
        if (newLayout === 'magazine') {
          console.log('Initializing Magazine Split in delegated handler');
          setTimeout(() => { try { initMagazineAutoscroll(); } catch(e){ console.error('Magazine init error in delegated handler:', e); } }, 100);
        } else {
          initializeGalleryLayout();
        }
        // Trigger entrance animation for new gallery items (run before container shows)
        if (typeof window.animateGalleryOnce === 'function') {
          window.animateGalleryOnce();
        }
        // Show container after animation starts
        setTimeout(() => {
          galleryContainer.style.opacity = '1';
          galleryContainer.style.transition = 'none';
          // Fallback: force items visible if animation failed
          galleryContainer.querySelectorAll('.masonry-item, .image-item').forEach(el => {
            if (!el.hasAttribute('data-animated')) {
              el.style.opacity = '1';
              el.style.transform = 'scale(1)';
            }
          });
        }, 80);
      }, 50);
    })
    .catch(err => {
      console.error('Template switch failed', err);
      galleryContainer.innerHTML = originalContent;
      galleryContainer.style.opacity = '1';
    })
    .finally(() => { delete el.dataset.switchInProgress; });
});

// Elegant GSAP Animations for Gallery
document.addEventListener('DOMContentLoaded', function() {
    // Check for reduced motion preference
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    // Fallback: if no GSAP or reduced motion, show elements immediately
    if (prefersReducedMotion || typeof gsap === 'undefined') {
        document.body.classList.add('gsap-ready');
        return;
    }

    // Register ScrollTrigger
    if (typeof ScrollTrigger !== 'undefined') {
        gsap.registerPlugin(ScrollTrigger);
    }

    // Header entrance animations with stagger - animate TO visible
    const headerElements = [
        '[data-gsap="categories"]',
        '[data-gsap="title"]',
        '[data-gsap="meta"]',
        '[data-gsap="excerpt"]',
        '[data-gsap="body"]'
    ];

    headerElements.forEach((selector, index) => {
        const el = document.querySelector(selector);
        if (el && !el.hasAttribute('data-animated')) {
            el.setAttribute('data-animated', '1'); // Mark immediately to prevent re-animation
            gsap.fromTo(el,
                { opacity: 0, y: 20 },
                {
                    opacity: 1,
                    y: 0,
                    duration: 0.6,
                    delay: index * 0.1,
                    ease: 'power2.out'
                }
            );
        }
    });

    // Equipment section
    const equipment = document.querySelector('[data-gsap="equipment"]');
    if (equipment && !equipment.hasAttribute('data-animated')) {
        equipment.setAttribute('data-animated', '1'); // Mark immediately to prevent re-animation
        gsap.fromTo(equipment,
            { opacity: 0, y: 20 },
            {
                opacity: 1,
                y: 0,
                duration: 0.6,
                delay: 0.5,
                ease: 'power2.out'
            }
        );
    }

    // Fallback timeout: if animations haven't run, show elements
    setTimeout(() => {
        document.body.classList.add('gsap-ready');
    }, 1500);

    // Template switcher buttons (hidden initially, animate to visible)
    const templateSwitcher = document.getElementById('template-switcher');
    if (templateSwitcher) {
        gsap.to(templateSwitcher, {
            opacity: 1,
            x: 0,
            duration: 0.5,
            delay: 0.6,
            ease: 'power2.out'
        });
    }

    // Gallery animation handled by animateGalleryOnce in _layout.twig
    // DO NOT add duplicate animation here

    // Subtle hover enhancement for image items (GPU-accelerated)
    const allImageItems = document.querySelectorAll('.image-item, .pswp-link');
    allImageItems.forEach(item => {
        item.addEventListener('mouseenter', function() {
            if (!this.classList.contains('polaroid-item')) {
                gsap.to(this, {
                    scale: 1.015,
                    duration: 0.3,
                    ease: 'power2.out'
                });
            }
        });

        item.addEventListener('mouseleave', function() {
            gsap.to(this, {
                scale: 1,
                duration: 0.3,
                ease: 'power2.out'
            });
        });
    });
});

// JSON-LD will be appended below
</script>
<script type="application/ld+json" nonce="{{ csp_nonce() }}">
{
  "@context": "https://schema.org",
  "@type": "ImageGallery",
  "name": {{ album.title|json_encode|raw }},
  {% if album.excerpt %}"about": {{ album.excerpt|striptags|json_encode|raw }},{% endif %}
  "url": {{ (canonical_url|default(current_url))|json_encode|raw }},
  "image": [
    {% for image in images|slice(0,10) %}
      {% set src = image.fallback_src|default(image.url) %}
      {% if src starts with 'http' %}
        {{ src|json_encode|raw }}
      {% else %}
        {{ ((canonical_base|default('')) ~ (src starts with '/' ? src : '/' ~ src))|json_encode|raw }}
      {% endif %}{% if not loop.last %},{% endif %}
    {% endfor %}
  ]
}
</script>
<script type="application/ld+json" nonce="{{ csp_nonce() }}">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {"@type":"ListItem","position":1,"name":"Home","item": {{ (canonical_base|default('') ~ '/')|json_encode|raw }} }{% if album.category is defined and album.category.slug is defined %},
    {"@type":"ListItem","position":2,"name": {{ album.category.name|json_encode|raw }}, "item": {{ (canonical_base|default('') ~ '/category/' ~ album.category.slug)|json_encode|raw }} },
    {"@type":"ListItem","position":3,"name": {{ album.title|json_encode|raw }}, "item": {{ (canonical_url|default(current_url))|json_encode|raw }} }
    {% else %},
    {"@type":"ListItem","position":2,"name": {{ album.title|json_encode|raw }}, "item": {{ (canonical_url|default(current_url))|json_encode|raw }} }
    {% endif %}
  ]
}
</script>
{% endblock %}
