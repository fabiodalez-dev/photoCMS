{% extends "frontend/_layout.twig" %}

{% import 'frontend/_seo_macros.twig' as Seo %}
{% import 'frontend/_caption.twig' as Caption %}

{% block content %}
<style nonce="{{ csp_nonce() }}">
/* Keep content visible; no intro hides to avoid flicker */
[data-gsap="categories"],
[data-gsap="title"],
[data-gsap="meta"],
[data-gsap="excerpt"],
[data-gsap="body"],
[data-gsap="equipment"] {
    opacity: 1;
    transform: none;
}
/* Equipment section title should use body font, not heading font */
[data-gsap="equipment"] h3 {
    font-family: var(--font-body), system-ui, sans-serif !important;
    font-weight: 500 !important;
}
</style>
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  {% include 'frontend/_breadcrumbs.twig' %}
  <div class="max-w-4xl mx-auto text-center pb-12">
    <div class="mt-4 mb-4 flex flex-wrap gap-2 justify-center" data-gsap="categories">
      {% if album.categories is defined and album.categories|length > 0 %}
        {% for cat in album.categories %}
        <a href="{{ base_path }}/category/{{ cat.slug }}" class="inline-flex items-center gap-2 text-xs font-medium px-2.5 py-1 rounded-full border border-neutral-300 bg-neutral-50 text-neutral-700 hover:bg-neutral-100 hover:text-black dark:border-neutral-600 dark:bg-neutral-800 dark:text-neutral-200 dark:hover:bg-neutral-700 transition-colors" title="{{ cat.name|e }}">
          <span class="w-1.5 h-1.5 rounded-full bg-neutral-700 dark:bg-neutral-300"></span>{{ cat.name|e }}
        </a>
        {% endfor %}
      {% endif %}
      {% if album.tags is defined and album.tags|length > 0 %}
        {% for tag in album.tags %}
        <a href="{{ base_path }}/tag/{{ tag.slug }}" class="inline-flex items-center gap-2 text-xs font-medium px-2.5 py-1 rounded-full border border-blue-300 bg-blue-50 text-blue-700 hover:bg-blue-100 hover:text-blue-800 dark:border-blue-600 dark:bg-blue-900/50 dark:text-blue-200 dark:hover:bg-blue-800/50 transition-colors" title="{{ tag.name|e }}">
          <span class="w-1.5 h-1.5 rounded-full bg-blue-700 dark:bg-blue-400"></span>{{ tag.name|e }}
        </a>
        {% endfor %}
      {% endif %}
    </div>
    <h1 class="text-3xl md:text-4xl font-light text-black mb-6" data-gsap="title">{{ album.title|e }}</h1>

    {# Album metadata: date and locations #}
    {% if album.shoot_date or album.equipment.locations|length > 0 %}
    <div class="flex items-center justify-center gap-6 text-sm text-neutral-600 mb-6" data-gsap="meta">
      {% if album.shoot_date and album.show_date == 1 %}
        <div class="flex items-center gap-2">
          <i class="fas fa-calendar-alt text-neutral-500"></i>
          <time datetime="{{ album.shoot_date }}">{{ album.shoot_date|date_format }}</time>
        </div>
      {% endif %}

      {% if album.equipment.locations|length > 0 %}
        <div class="flex items-center gap-2">
          <i class="fas fa-map-marker-alt text-neutral-500"></i>
          <span>{{ album.equipment.locations|join(', ') }}</span>
        </div>
      {% endif %}
    </div>
    {% endif %}

    <p class="text-lg text-neutral-600 leading-relaxed mb-6" data-gsap="excerpt">{{ album.excerpt|e }}</p>
  </div>

  {% if album.body %}
    <div class="max-w-3xl mx-auto prose prose-neutral mb-12" data-gsap="body">{{ album.body|safe_html }}</div>
  {% endif %}

  {# Social Sharing #}
  {% include 'frontend/_social_sharing.twig' %}

  {# Count custom fields that should show in gallery #}
  {% set custom_fields_for_gallery = [] %}
  {% if album_custom_fields is defined %}
    {% for typeId, field in album_custom_fields %}
      {% if field.show_in_gallery and field.values|length > 0 %}
        {% set custom_fields_for_gallery = custom_fields_for_gallery|merge([field]) %}
      {% endif %}
    {% endfor %}
  {% endif %}

  {% if album.equipment.cameras|length > 0 or album.equipment.lenses|length > 0 or album.equipment.film|length > 0 or album.equipment.developers|length > 0 or album.equipment.labs|length > 0 or custom_fields_for_gallery|length > 0 %}
  <div class="max-w-5xl mx-auto mb-8 p-6 bg-neutral-50 dark:bg-neutral-800 rounded-lg border border-transparent dark:border-neutral-700" data-gsap="equipment">
    <h3 class="text-sm font-medium mb-3 text-left">{{ trans('album.equipment') }}</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 xl:grid-cols-5 gap-2 text-xs text-neutral-600">
      {% if album.equipment.cameras is defined and album.equipment.cameras|length > 0 %}
      <div class="flex flex-col items-start text-left">
        <i class="fas fa-camera mb-1 text-neutral-500"></i>
        <div class="space-y-1">
          {% for camera in album.equipment.cameras %}<div>{{ camera }}</div>{% endfor %}
        </div>
      </div>
      {% endif %}
      {% if album.equipment.lenses is defined and album.equipment.lenses|length > 0 %}
      <div class="flex flex-col items-start text-left">
        <i class="fas fa-dot-circle mb-1 text-neutral-500"></i>
        <div class="space-y-1">
          {% for lens in album.equipment.lenses %}<div>{{ lens }}</div>{% endfor %}
        </div>
      </div>
      {% endif %}
      {% if album.equipment.film is defined and album.equipment.film|length > 0 %}
      <div class="flex flex-col items-start text-left">
        <i class="fas fa-film mb-1 text-neutral-500"></i>
        <div class="space-y-1">
          {% for film in album.equipment.film %}<div>{% if film.name is defined %}{{ film.name }}{% if film.iso or film.format %} ({% if film.iso %}ISO {{ film.iso }}{% endif %}{% if film.iso and film.format %} - {% endif %}{% if film.format %}{{ film.format }}{% endif %}){% endif %}{% else %}{{ film }}{% endif %}</div>{% endfor %}
        </div>
      </div>
      {% endif %}
      {% if album.equipment.developers is defined and album.equipment.developers|length > 0 %}
      <div class="flex flex-col items-start text-left">
        <i class="fas fa-flask mb-1 text-neutral-500"></i>
        <div class="space-y-1">
          {% for dev in album.equipment.developers %}<div>{{ dev }}</div>{% endfor %}
        </div>
      </div>
      {% endif %}
      {% if album.equipment.labs is defined and album.equipment.labs|length > 0 %}
      <div class="flex flex-col items-start text-left">
        <i class="fas fa-industry mb-1 text-neutral-500"></i>
        <div class="space-y-1">
          {% for lab in album.equipment.labs %}<div>{{ lab }}</div>{% endfor %}
        </div>
      </div>
      {% endif %}
      {# Custom fields #}
      {% for field in custom_fields_for_gallery %}
      <div class="flex flex-col items-start text-left">
        <i class="fas {{ field.icon|default('fa-tag') }} mb-1 text-neutral-500"></i>
        <div class="space-y-1">
          {% for valueData in field.values %}<div>{{ valueData.value|e }}</div>{% endfor %}
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  {# --- Template switcher: show ABOVE the gallery content --- #}
  {% if available_templates|length > 0 %}
  <div class="max-w-7xl mx-auto mb-2">
    <div class="flex justify-end">
      <div id="template-switcher" class="inline-flex items-center gap-1 bg-white/90 backdrop-blur-sm border border-neutral-200 rounded-md p-1 shadow-sm max-md:hidden">
        {% for template in available_templates %}
        <button type="button" class="tpl-switch px-2 py-1 rounded {{ template.id == current_template_id ? 'bg-black text-white' : 'text-neutral-700 hover:bg-neutral-100' }}" data-template-id="{{ template.id }}" data-album-ref="{{ album_ref }}" title="{{ template.name }}" aria-label="{{ template.name }}">
          {% set tpl_layout = template.settings.layout|default('grid') %}
          {% set tpl_slug = template.slug|default('') %}
  {% if tpl_layout == 'magazine' %}
    <i class="fas fa-newspaper"></i>
  {% elseif tpl_layout == 'dense_grid' %}
    <i class="fas fa-th-large"></i>
  {% elseif tpl_layout == 'masonry' or tpl_slug == 'masonry-full' %}
    <i class="fas fa-columns"></i>
  {% elseif tpl_slug == 'masonry-portfolio' %}
    <i class="fas fa-border-all"></i>
  {% elseif tpl_slug == 'grid-ampia' %}
    <i class="fas fa-puzzle-piece"></i>
  {% elseif tpl_slug == 'gallery-wall-scroll' %}
    <i class="fas fa-arrows-left-right"></i>
  {% elseif tpl_slug == 'grid-compatta' or (tpl_layout == 'grid' and template.settings.columns.desktop|default(3) >= 5) %}
    <i class="fas fa-grip-horizontal"></i>
  {% elseif tpl_layout == 'grid' and template.settings.columns.desktop|default(3) <= 2 %}
    <i class="fas fa-square"></i>
  {% else %}
    <i class="fas fa-th"></i>
  {% endif %}
        </button>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}

  {# Extract unified template settings #}
  {% set custom_template_twig = template_custom_twig|default('') %}
  {% set tpl_slug = template_settings.template_slug|default('') %}
  {% set layout = template_settings.layout|default('grid') %}
  {% set cols = template_settings.columns|default({desktop: 3, tablet: 2, mobile: 1}) %}
  {% set gap = template_settings.gap|default({horizontal: 16, vertical: 16}) %}
  {% set aspect_ratio = template_settings.aspect_ratio|default('1:1') %}
  {% set style = template_settings.style|default({rounded: false, shadow: false, hover_scale: true}) %}

  {# Normalize column values #}
  {% set desktop_cols = cols.desktop|default(3)|round %}
  {% set tablet_cols = cols.tablet|default(2)|round %}
  {% set mobile_cols = cols.mobile|default(1)|round %}
  {% set gap_h = gap.horizontal|default(16)|round %}
  {% set gap_v = gap.vertical|default(16)|round %}

  {# Aspect ratio class for grid layout #}
  {% set aspect_class = 'aspect-square' %}
  {% if aspect_ratio == '4:3' %}
      {% set aspect_class = 'aspect-[4/3]' %}
  {% elseif aspect_ratio == '16:9' %}
      {% set aspect_class = 'aspect-video' %}
  {% elseif aspect_ratio == '3:2' %}
      {% set aspect_class = 'aspect-[3/2]' %}
  {% endif %}

  {# Style classes #}
  {% set rounded_class = style.rounded ? 'rounded-lg' : '' %}
  {% set shadow_class = style.shadow ? 'shadow-md hover:shadow-xl' : '' %}
  {% set hover_class = style.hover_scale ? 'group-hover:scale-105' : '' %}

  {# Custom gallery template (uploaded) #}
  {% if custom_template_twig %}
      <div id="images-gallery" class="pswp-gallery" data-layout="custom">
          {% include custom_template_twig %}
      </div>

  {# Creative Layout (template 6) #}
  {% elseif tpl_slug == 'grid-ampia' %}
      {% include 'frontend/_gallery_creative_layout.twig' with { images: images, template_settings: template_settings, album: album, base_path: base_path, site_title: site_title } %}

  {# Gallery Wall Scroll layout #}
  {% elseif tpl_slug == 'gallery-wall-scroll' %}
      {% include 'frontend/_gallery_wall_scroll.twig' with { images: images, template_settings: template_settings, album: album, base_path: base_path, site_title: site_title } %}

  {# Masonry Portfolio layout (template 2) - dedicated Masonry setup #}
  {% elseif tpl_slug == 'masonry-portfolio' %}
      {% include 'frontend/_gallery_masonry_portfolio.twig' with { images: images, template_settings: template_settings, album: album, base_path: base_path, site_title: site_title } %}

  {# Magazine layout - special handling, NOT unified #}
  {% elseif layout == 'magazine' %}
      <div id="images-gallery" class="mt-6" data-layout="magazine" data-hover-fade="{{ style.hover_fade is not defined or style.hover_fade ? '1' : '0' }}">
          {% include 'frontend/_gallery_magazine_content.twig' with { images: images, template_settings: template_settings, album: album } %}
      </div>

  {# Dense Grid layout - CSS Grid with auto-flow dense (fills gaps automatically) #}
  {% elseif layout == 'dense_grid' %}
      {% set dense = template_settings.dense_grid|default({}) %}
      {% set minDesktop = dense.minCellDesktop|default(250) %}
      {% set minTablet = dense.minCellTablet|default(150) %}
      {% set rowHeight = dense.rowHeight|default(250) %}
      {% set rowHeightTablet = dense.rowHeightTablet|default(180) %}
      {% set rowHeightMobile = dense.rowHeightMobile|default(300) %}
      {% set gridGap = dense.gap|default(8) %}
      {% set maxWidth = dense.maxWidth|default(1600) %}
      {% set adaptive = dense.adaptiveSizing|default(true) %}

      <style nonce="{{ csp_nonce() }}">
      /* Dense Grid Layout - CSS Grid with auto-flow dense */
      .dense-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax({{ minDesktop }}px, 1fr));
          grid-auto-rows: {{ rowHeight }}px;
          gap: {{ gridGap }}px;
          grid-auto-flow: dense;
          max-width: {{ maxWidth }}px;
          margin: 0 auto;
          padding: 0 {{ gridGap }}px;
          /* Establish stacking context to contain hover z-index */
          position: relative;
          z-index: 1;
          isolation: isolate;
      }
      .dense-grid-item {
          position: relative;
          overflow: hidden;
          background: #f5f5f5;
          cursor: pointer;
          transition: transform 0.3s ease, box-shadow 0.3s ease;
          z-index: 1;
      }
      .dense-grid-item:hover {
          transform: scale(1.02);
          box-shadow: 0 10px 30px rgba(0,0,0,0.15);
          z-index: 2;
      }
      .dense-grid-link {
          display: block;
          width: 100%;
          height: 100%;
      }
      .dense-grid-img {
          width: 100%;
          height: 100%;
          object-fit: cover;
          display: block;
          transition: opacity 0.3s ease;
      }
      /* Adaptive sizing classes - images span based on aspect ratio */
      .dense-grid-item.landscape {
          grid-column: span 2;
      }
      .dense-grid-item.portrait-tall {
          grid-row: span 2;
      }
      .dense-grid-item.square-large {
          grid-column: span 2;
          grid-row: span 2;
      }
      /* Tablet responsive */
      @media (max-width: 1023px) {
          .dense-grid {
              grid-template-columns: repeat(auto-fill, minmax({{ minTablet }}px, 1fr));
              grid-auto-rows: {{ rowHeightTablet }}px;
              gap: 6px;
              padding: 0 6px;
          }
      }
      /* Mobile - single/double column, no adaptive spans */
      @media (max-width: 640px) {
          .dense-grid {
              grid-template-columns: repeat(2, 1fr);
              grid-auto-rows: {{ rowHeightMobile }}px;
              gap: 4px;
              padding: 0 4px;
          }
          .dense-grid-item.landscape,
          .dense-grid-item.portrait-tall,
          .dense-grid-item.square-large {
              grid-column: span 1;
              grid-row: span 1;
          }
          .dense-grid-item:hover {
              transform: none;
              box-shadow: none;
          }
      }
      </style>

      <div id="images-gallery" class="dense-grid pswp-gallery" data-layout="dense_grid" data-adaptive="{{ adaptive ? 'true' : 'false' }}" data-hover-fade="{{ style.hover_fade is not defined or style.hover_fade ? '1' : '0' }}">
          {% for image in images %}
          <div class="dense-grid-item" data-image-id="{{ image.id }}" data-width="{{ image.width|default(0) }}" data-height="{{ image.height|default(0) }}">
              {% set lightbox_href = image.lightbox_url|default(image.original_path) %}
              {% set seo_title = Seo.seo_title(image, album, site_title)|trim %}
              <a href="{% if lightbox_href starts with '/' %}{{ base_path }}{{ lightbox_href }}{% else %}{{ lightbox_href }}{% endif %}"
                 class="pswp-link dense-grid-link"
                 title="{{ seo_title|e('html_attr') }}"
                 data-image-id="{{ image.id }}"
                 data-pswp-width="{{ image.width }}"
                 data-pswp-height="{{ image.height }}"
                 data-pswp-caption="{{ Caption.build(image)|e('html_attr') }}"
                 data-title="{{ image.caption|default('')|e }}"
                 data-alt="{{ image.alt_text|default(image.alt)|default('')|e }}"
                 data-camera="{{ image.custom_camera|default(image.camera_name)|default('')|e }}"
                 data-lens="{{ image.custom_lens|default(image.lens_name)|default('')|e }}"
                 data-film="{{ image.custom_film|default(image.film_name)|default('')|e }}"
                 data-developer="{{ image.developer_name|default('')|e }}"
                 data-lab="{{ image.lab_name|default('')|e }}"
                 data-location="{{ image.location_name|default('')|e }}"
                 data-iso="{{ image.iso|default('') }}"
                 data-shutter="{{ image.shutter_speed|default('')|e }}"
                 data-aperture="{{ image.aperture|default('') }}"
                 data-focal-length="{{ image.focal_length|default('') }}"
                 {% if image.custom_fields is defined and image.custom_fields|length > 0 %}data-custom-fields="{{ image.custom_fields|json_encode|e('html_attr') }}"{% endif %}>
                  <picture>
                      {% set variants_avif = [] %}
                      {% set variants_webp = [] %}
                      {% set variants_jpg = [] %}
                      {% set best_jpg_path = image.original_path starts with '/' ? base_path ~ image.original_path : image.original_path %}
                      {% set best_jpg_w = 0 %}
                      {% for variant in image.variants %}
                          {% set variant_url = variant.path starts with '/' ? base_path ~ variant.path : variant.path %}
                          {% if variant.format == 'avif' %}
                              {% set variants_avif = variants_avif|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
                          {% elseif variant.format == 'webp' %}
                              {% set variants_webp = variants_webp|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
                          {% elseif variant.format == 'jpg' %}
                              {% set variants_jpg = variants_jpg|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
                              {% if variant.width > best_jpg_w %}
                                  {% set best_jpg_path = variant_url %}
                                  {% set best_jpg_w = variant.width %}
                              {% endif %}
                          {% endif %}
                      {% endfor %}

                      {% if variants_avif %}
                          <source type="image/avif" srcset="{{ variants_avif|join(', ') }}" sizes="(min-width: 1200px) 33vw, (min-width: 768px) 50vw, 100vw">
                      {% endif %}
                      {% if variants_webp %}
                          <source type="image/webp" srcset="{{ variants_webp|join(', ') }}" sizes="(min-width: 1200px) 33vw, (min-width: 768px) 50vw, 100vw">
                      {% endif %}

                      <img src="{{ best_jpg_path }}"
                           alt="{{ image.alt_text|default(image.alt)|default('')|e }}"
                           title="{{ seo_title|e('html_attr') }}"
                           class="dense-grid-img"
                           loading="lazy"
                           decoding="async"
                           data-fallback="hide">
                  </picture>
              </a>
          </div>
          {% endfor %}
      </div>

  {# Masonry layout - uses @masonry-grid/vanilla for Pinterest-style waterfall #}
  {% elseif layout == 'masonry' %}
      <style nonce="{{ csp_nonce() }}">
      /* Modern Masonry Grid using @masonry-grid/vanilla */
      /* The library uses translateY(%) for positioning - margin doesn't work! */
      /* Gaps are created via inset on the inner container per library docs */
      .gallery-masonry {
          --masonry-gap-v: {{ gap_v }}px;
          --masonry-gap-h: {{ gap_h }}px;
          display: grid;
          column-gap: var(--masonry-gap-h);
          grid-template-columns: repeat({{ mobile_cols }}, 1fr);
          align-items: start; /* Required: items need natural height for masonry transforms */
          width: 100%;
          max-width: 100%;
          opacity: 0;
          transition: opacity 0.3s ease-in-out;
      }
      .gallery-masonry.masonry-ready {
          opacity: 1;
      }
      @media (min-width: 768px) {
          .gallery-masonry {
              grid-template-columns: repeat({{ tablet_cols }}, 1fr);
          }
      }
      @media (min-width: 1024px) {
          .gallery-masonry {
              grid-template-columns: repeat({{ desktop_cols }}, 1fr);
          }
      }
      /* Frame: NO overflow:hidden per library docs (breaks aspect-ratio calc) */
      .gallery-masonry .masonry-frame {
          position: relative;
          aspect-ratio: var(--width) / var(--height);
          min-width: 0; /* Prevent grid blowout */
          /* No margin-bottom - translateY% ignores margins */
      }
      /* Inner container uses inset to create vertical gaps */
      /* Each item has gap/2 on top and bottom = gap between items */
      .gallery-masonry .masonry-frame > .frame-content {
          position: absolute;
          inset: calc(var(--masonry-gap-v) / 2) 0;
          overflow: hidden;
      }
      .gallery-masonry .masonry-frame img {
          display: block;
          width: 100%;
          height: 100%;
          object-fit: cover;
          transition: transform 0.3s ease;
      }
      .gallery-masonry .masonry-frame:hover img {
          transform: scale(1.03);
      }
      .no-js .gallery-masonry {
          opacity: 1 !important;
      }
      @media (prefers-reduced-motion: reduce) {
          .gallery-masonry { opacity: 1 !important; transition: none !important; }
          .gallery-masonry .masonry-frame img { transition: none !important; }
      }
      </style>

      <div id="images-gallery"
           class="gallery-masonry pswp-gallery"
           data-layout="masonry"
           data-gap-h="{{ gap_h }}"
           data-gap-v="{{ gap_v }}"
           data-cols-desktop="{{ desktop_cols }}"
           data-cols-tablet="{{ tablet_cols }}"
           data-cols-mobile="{{ mobile_cols }}"
           data-rounded="{{ style.rounded ? '1' : '0' }}"
           data-shadow="{{ style.shadow ? '1' : '0' }}"
           data-hover-fade="{{ style.hover_fade is not defined or style.hover_fade ? '1' : '0' }}">
          {% for image in images %}
              {# Calculate aspect ratio for CSS variable #}
              {% set imgW = image.width|default(4) %}
              {% set imgH = image.height|default(3) %}
              <div class="masonry-frame" style="--width: {{ imgW }}; --height: {{ imgH }};">
                  <div class="frame-content group {{ rounded_class }} {{ shadow_class }}">
                      {% set lightbox_href = image.lightbox_url|default(image.original_path) %}
                      {% set seo_title = Seo.seo_title(image, album, site_title)|trim %}
                      <a href="{% if lightbox_href starts with '/' %}{{ base_path }}{{ lightbox_href }}{% else %}{{ lightbox_href }}{% endif %}"
                         class="pswp-link gallery-link block w-full h-full overflow-hidden bg-neutral-100 cursor-pointer {{ rounded_class }}"
                         title="{{ seo_title|e('html_attr') }}"
                         data-image-id="{{ image.id }}"
                         data-pswp-width="{{ image.width }}"
                         data-pswp-height="{{ image.height }}"
                         data-pswp-caption="{{ Caption.build(image)|e('html_attr') }}"
                         data-title="{{ image.caption|default('')|e }}"
                         data-alt="{{ image.alt_text|default(image.alt)|default('')|e }}"
                         data-camera="{{ image.custom_camera|default(image.camera_name)|default('')|e }}"
                         data-lens="{{ image.custom_lens|default(image.lens_name)|default('')|e }}"
                         data-film="{{ image.custom_film|default(image.film_name)|default('')|e }}"
                         data-developer="{{ image.developer_name|default('')|e }}"
                         data-lab="{{ image.lab_name|default('')|e }}"
                         data-location="{{ image.location_name|default('')|e }}"
                         data-iso="{{ image.iso|default('') }}"
                         data-shutter="{{ image.shutter_speed|default('')|e }}"
                         data-aperture="{{ image.aperture|default('') }}"
                         data-focal-length="{{ image.focal_length|default('') }}"
                         {% if image.custom_fields is defined and image.custom_fields|length > 0 %}data-custom-fields="{{ image.custom_fields|json_encode|e('html_attr') }}"{% endif %}>
                          <picture>
                              {% set variants_avif = [] %}
                              {% set variants_webp = [] %}
                              {% set variants_jpg = [] %}
                              {% set best_jpg_path = image.original_path starts with '/' ? base_path ~ image.original_path : image.original_path %}
                              {% set best_jpg_w = 0 %}
                              {% for variant in image.variants %}
                                  {% set variant_url = variant.path starts with '/' ? base_path ~ variant.path : variant.path %}
                                  {% if variant.format == 'avif' %}
                                      {% set variants_avif = variants_avif|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
                                  {% elseif variant.format == 'webp' %}
                                      {% set variants_webp = variants_webp|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
                                  {% elseif variant.format == 'jpg' %}
                                      {% set variants_jpg = variants_jpg|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
                                      {% if variant.width > best_jpg_w %}
                                          {% set best_jpg_path = variant_url %}
                                          {% set best_jpg_w = variant.width %}
                                      {% endif %}
                                  {% endif %}
                              {% endfor %}

                              {% if variants_avif %}
                                  <source type="image/avif" srcset="{{ variants_avif|join(', ') }}" sizes="(min-width: 1200px) 33vw, (min-width: 768px) 50vw, 100vw">
                              {% endif %}
                              {% if variants_webp %}
                                  <source type="image/webp" srcset="{{ variants_webp|join(', ') }}" sizes="(min-width: 1200px) 33vw, (min-width: 768px) 50vw, 100vw">
                              {% endif %}

                              <img src="{{ best_jpg_path }}"
                                   alt="{{ image.alt_text|default(image.alt)|default('')|e }}"
                                   title="{{ seo_title|e('html_attr') }}"
                                   loading="lazy"
                                   decoding="async"
                                   data-fallback="hide">
                          </picture>
                          {% if album.allow_downloads %}
                              <button type="button"
                                      class="absolute top-3 right-3 bg-black/60 text-white p-2.5 opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-10 cursor-pointer {{ rounded_class }}"
                                      title="{{ trans('image.download') }}"
                                      data-action="download-image"
                                      data-download-url="{{ base_path }}/download/image/{{ image.id }}">
                                  <i class="fa-solid fa-arrow-down text-sm"></i>
                              </button>
                          {% endif %}
                          {% if image.caption %}
                              <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent text-white text-sm p-4 pt-8 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                  {{ image.caption|e }}
                              </div>
                          {% endif %}
                      </a>
                  </div>
              </div>
          {% endfor %}
      </div>

  {# Grid layout - CSS Grid with fixed aspect ratios #}
  {% else %}
      <style nonce="{{ csp_nonce() }}">
      .gallery-grid {
          display: grid;
          gap: {{ gap_v }}px {{ gap_h }}px;
      }
      @media (min-width: 1024px) {
          .gallery-grid { grid-template-columns: repeat({{ desktop_cols }}, 1fr); }
      }
      @media (min-width: 768px) and (max-width: 1023px) {
          .gallery-grid { grid-template-columns: repeat({{ tablet_cols }}, 1fr); }
      }
      @media (max-width: 767px) {
          .gallery-grid { grid-template-columns: repeat({{ mobile_cols }}, 1fr); }
      }
      </style>

      <div id="images-gallery"
           class="gallery-grid pswp-gallery"
           data-layout="grid"
           data-gap-h="{{ gap_h }}"
           data-gap-v="{{ gap_v }}"
           data-cols-desktop="{{ desktop_cols }}"
           data-cols-tablet="{{ tablet_cols }}"
           data-cols-mobile="{{ mobile_cols }}"
           data-aspect-ratio="{{ aspect_ratio }}"
           data-hover-fade="{{ style.hover_fade is not defined or style.hover_fade ? '1' : '0' }}">
          {% for image in images %}
              <div class="gallery-item">
                  {% set lightbox_href = image.lightbox_url|default(image.original_path) %}
                  {% set seo_title = Seo.seo_title(image, album, site_title)|trim %}
                  <a href="{% if lightbox_href starts with '/' %}{{ base_path }}{{ lightbox_href }}{% else %}{{ lightbox_href }}{% endif %}"
                     class="pswp-link gallery-link group block overflow-hidden bg-neutral-100 cursor-pointer {{ aspect_class }} {{ rounded_class }} {{ shadow_class }}"
                     title="{{ seo_title|e('html_attr') }}"
                     data-image-id="{{ image.id }}"
                     data-pswp-width="{{ image.width }}"
                     data-pswp-height="{{ image.height }}"
                     data-pswp-caption="{{ Caption.build(image)|e('html_attr') }}"
                     data-title="{{ image.caption|default('')|e }}"
                     data-alt="{{ image.alt_text|default(image.alt)|default('')|e }}"
                     data-camera="{{ image.custom_camera|default(image.camera_name)|default('')|e }}"
                     data-lens="{{ image.custom_lens|default(image.lens_name)|default('')|e }}"
                     data-film="{{ image.custom_film|default(image.film_name)|default('')|e }}"
                     data-developer="{{ image.developer_name|default('')|e }}"
                     data-lab="{{ image.lab_name|default('')|e }}"
                     data-location="{{ image.location_name|default('')|e }}"
                     data-iso="{{ image.iso|default('') }}"
                     data-shutter="{{ image.shutter_speed|default('')|e }}"
                     data-aperture="{{ image.aperture|default('') }}"
                     data-focal-length="{{ image.focal_length|default('') }}"
                     {% if image.custom_fields is defined and image.custom_fields|length > 0 %}data-custom-fields="{{ image.custom_fields|json_encode|e('html_attr') }}"{% endif %}>
                      <picture>
                          {% set variants_avif = [] %}
                          {% set variants_webp = [] %}
                          {% set variants_jpg = [] %}
                          {% set best_jpg_path = image.original_path starts with '/' ? base_path ~ image.original_path : image.original_path %}
                          {% set best_jpg_w = 0 %}
                          {% for variant in image.variants %}
                              {% set variant_url = variant.path starts with '/' ? base_path ~ variant.path : variant.path %}
                              {% if variant.format == 'avif' %}
                                  {% set variants_avif = variants_avif|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
                              {% elseif variant.format == 'webp' %}
                                  {% set variants_webp = variants_webp|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
                              {% elseif variant.format == 'jpg' %}
                                  {% set variants_jpg = variants_jpg|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
                                  {% if variant.width > best_jpg_w %}
                                      {% set best_jpg_path = variant_url %}
                                      {% set best_jpg_w = variant.width %}
                                  {% endif %}
                              {% endif %}
                          {% endfor %}

                          {% if variants_avif %}
                              <source type="image/avif" srcset="{{ variants_avif|join(', ') }}" sizes="(min-width: 1200px) 33vw, (min-width: 768px) 50vw, 100vw">
                          {% endif %}
                          {% if variants_webp %}
                              <source type="image/webp" srcset="{{ variants_webp|join(', ') }}" sizes="(min-width: 1200px) 33vw, (min-width: 768px) 50vw, 100vw">
                          {% endif %}

                          <img src="{{ best_jpg_path }}"
                               alt="{{ image.alt_text|default(image.alt)|default('')|e }}"
                               title="{{ seo_title|e('html_attr') }}"
                               width="{{ image.width }}"
                               height="{{ image.height }}"
                               loading="lazy"
                               decoding="async"
                               data-fallback="hide"
                               class="w-full h-full object-cover transition-transform duration-300 {{ hover_class }}">
                      </picture>
                      {% if album.allow_downloads %}
                          <button type="button"
                                  class="absolute top-3 right-3 bg-black/60 text-white p-2.5 opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-10 cursor-pointer {{ rounded_class }}"
                                  title="{{ trans('image.download') }}"
                                  data-action="download-image"
                                  data-download-url="{{ base_path }}/download/image/{{ image.id }}">
                              <i class="fa-solid fa-arrow-down text-sm"></i>
                          </button>
                      {% endif %}
                      {% if image.caption %}
                          <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent text-white text-sm p-4 pt-8 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                              {{ image.caption|e }}
                          </div>
                      {% endif %}
                  </a>
              </div>
          {% endfor %}
      </div>
  {% endif %}

{% if images|length == 0 %}
  <div class="text-center py-20">
      <h2 class="text-2xl font-light text-neutral-600 mb-4">{{ trans('album.empty') }}</h2>
      <p class="text-neutral-500">{{ trans('album.empty_message') }}</p>
  </div>
  {% endif %}

</div>
{% endblock %}

{% block styles %}
{{ parent() }}
{% if template_custom_css is defined and template_custom_css %}
{{ template_custom_css|raw }}
{% endif %}
{% endblock %}

{% block scripts %}
{# Load @masonry-grid/vanilla as ES module and expose globally #}
{% if layout == 'masonry' and tpl_slug != 'masonry-portfolio' %}
<script type="module" nonce="{{ csp_nonce() }}">
import { BalancedMasonryGrid, RegularMasonryGrid } from '{{ base_path }}/assets/vendor/masonry-grid/index.js';
window.BalancedMasonryGrid = BalancedMasonryGrid;
window.RegularMasonryGrid = RegularMasonryGrid;
window._masonryGridReady = true; // Flag for sync check
// Dispatch event when library is ready
window.dispatchEvent(new CustomEvent('masonry-grid-ready'));
console.log('masonry-grid module loaded and exposed globally');
</script>
{% endif %}
<script nonce="{{ csp_nonce() }}">
// Global base path for API calls
window.basePath = '{{ base_path }}';

// Template settings (also expose globally for template switcher)
const templateSettings = {{ template_settings ? template_settings|json_encode|raw : '{}' }};
window.templateSettings = templateSettings;
const layout = templateSettings.layout || 'grid';
const templateSlug = templateSettings.template_slug || '';

/**
 * Masonry Portfolio initialization using Masonry + imagesLoaded
 */
function initMasonryPortfolio(containerOrSelector) {
    const grid = typeof containerOrSelector === 'string'
        ? document.querySelector(containerOrSelector)
        : containerOrSelector || document.querySelector('.masonry-portfolio-grid');

    if (!grid || typeof Masonry === 'undefined' || typeof imagesLoaded === 'undefined') return null;
    if (grid._masonryPortfolioInitialized) return grid._masonryPortfolioInstance;

    const gapH = parseInt(grid.dataset.gapH || '16', 10);
    const mpType = (window.templateSettings?.masonry_portfolio?.type || 'balanced');
    const horizontalOrder = mpType === 'regular';

    if (grid._masonryPortfolioInstance) {
        grid._masonryPortfolioInstance.destroy();
        grid._masonryPortfolioInstance = null;
    }

    grid._masonryPortfolioInitialized = true;
    grid._masonryPortfolioInstance = new Masonry(grid, {
        itemSelector: '.photo-item',
        columnWidth: '.grid-sizer',
        gutter: gapH,
        percentPosition: true,
        horizontalOrder: horizontalOrder,
        transitionDuration: '0.3s'
    });

    imagesLoaded(grid).on('progress', function(instance, image) {
        const img = image.img || null;
        if (img) {
            img.classList.add('is-loaded');
            const item = img.closest('.photo-item');
            if (item) item.classList.add('is-loaded');
        }
        grid._masonryPortfolioInstance.layout();
    });

    if (!grid._masonryPortfolioResizeHandler) {
        grid._masonryPortfolioResizeHandler = function() {
            clearTimeout(grid._masonryPortfolioResizeTimer);
            grid._masonryPortfolioResizeTimer = setTimeout(() => {
                if (grid._masonryPortfolioInstance) {
                    grid._masonryPortfolioInstance.layout();
                }
            }, 200);
        };
        window.addEventListener('resize', grid._masonryPortfolioResizeHandler);
    }

    return grid._masonryPortfolioInstance;
}

window.initMasonryPortfolio = initMasonryPortfolio;

function initCreativeLayout(containerOrSelector) {
    const container = typeof containerOrSelector === 'string'
        ? document.querySelector(containerOrSelector)
        : containerOrSelector || document.querySelector('.creative-gallery');

    if (!container) return;
    const images = container.querySelectorAll('img');
    images.forEach((img) => {
        if (img.complete) {
            img.classList.add('loaded');
            const loading = img.closest('.img-container')?.querySelector('.loading');
            if (loading) loading.remove();
        } else {
            img.addEventListener('load', function() {
                img.classList.add('loaded');
                const loading = img.closest('.img-container')?.querySelector('.loading');
                if (loading) loading.remove();
            }, { once: true });
        }
    });

    if (!container._creativeHoverBound) {
        container._creativeHoverBound = true;
        document.addEventListener('mousemove', function(e) {
            const hovers = container.querySelectorAll('.img-content-hover');
            hovers.forEach(function(element) {
                if (element.style.display === 'block' || window.getComputedStyle(element).display === 'block') {
                    const x = e.pageX + 20;
                    const y = e.pageY + 20;
                    element.style.transform = `translate3d(${x}px, ${y}px, 0)`;
                }
            });
        });
    }
}

window.initCreativeLayout = initCreativeLayout;

function initGalleryWallScroll(containerOrSelector) {
    const container = typeof containerOrSelector === 'string'
        ? document.querySelector(containerOrSelector)
        : containerOrSelector || document.querySelector('.gallery-wall');

    if (!container) return;

    document.body.classList.add('gallery-wall-page');

    const section = container.querySelector('#galleryWallSection') || container.querySelector('.gallery-wall-section');
    const track = container.querySelector('#galleryWallTrack') || container.querySelector('.gallery-wall-track');
    if (!section || !track) return;

    if (container._wallScrollCleanup) {
        container._wallScrollCleanup();
    }

    let maxScroll = 0;
    const isMobile = () => window.matchMedia('(max-width: 768px)').matches;

    function updateMetrics() {
        const trackWidth = track.scrollWidth;
        const windowWidth = window.innerWidth;
        const windowHeight = window.innerHeight;
        maxScroll = Math.max(0, trackWidth - windowWidth);
        const sectionHeight = maxScroll + windowHeight;
        section.style.height = sectionHeight + 'px';
    }

    function updateTrack() {
        if (isMobile()) {
            track.style.transform = 'translateX(0px)';
            return;
        }
        const rect = section.getBoundingClientRect();
        const sectionScrollHeight = section.offsetHeight - window.innerHeight;
        const scrollInSection = Math.max(0, -rect.top);
        const progress = sectionScrollHeight > 0 ? Math.min(1, scrollInSection / sectionScrollHeight) : 0;
        track.style.transform = `translateX(${-progress * maxScroll}px)`;
    }

    const onScroll = () => requestAnimationFrame(updateTrack);
    const onResize = () => {
        updateMetrics();
        updateTrack();
        if (window.lenisResize) setTimeout(window.lenisResize, 100);
    };
    let dragActive = false;
    let dragStartX = 0;
    let dragStartScroll = 0;
    let dragSectionStart = 0;
    const startDrag = (clientX) => {
        if (isMobile() || maxScroll === 0) return;
        dragActive = true;
        dragStartX = clientX;
        dragSectionStart = window.scrollY + section.getBoundingClientRect().top;
        dragStartScroll = Math.max(0, window.scrollY - dragSectionStart);
        section.style.cursor = 'grabbing';
    };
    const moveDrag = (clientX, evt) => {
        if (!dragActive || isMobile() || maxScroll === 0) return;
        const dx = clientX - dragStartX;
        const nextScroll = Math.max(0, Math.min(maxScroll, dragStartScroll - dx));
        if (nextScroll !== dragStartScroll) {
            if (evt) evt.preventDefault();
            window.scrollTo({ top: dragSectionStart + nextScroll, left: 0, behavior: 'auto' });
            updateTrack();
        }
    };
    const endDrag = () => {
        if (!dragActive) return;
        dragActive = false;
        section.style.cursor = '';
    };
    const onMouseDown = (e) => {
        if (e.button !== 0) return;
        startDrag(e.clientX);
    };
    const onMouseMove = (e) => {
        if (!dragActive) return;
        moveDrag(e.clientX, e);
    };
    const onMouseUp = () => endDrag();
    const onTouchStart = (e) => {
        if (!e.touches || e.touches.length !== 1) return;
        startDrag(e.touches[0].clientX);
    };
    const onTouchMove = (e) => {
        if (!e.touches || e.touches.length !== 1) return;
        moveDrag(e.touches[0].clientX, e);
    };
    const onTouchEnd = () => endDrag();

    updateMetrics();
    updateTrack();
    window.addEventListener('scroll', onScroll, { passive: true });
    window.addEventListener('resize', onResize);
    section.addEventListener('mousedown', onMouseDown);
    section.addEventListener('mousemove', onMouseMove);
    window.addEventListener('mouseup', onMouseUp);
    section.addEventListener('touchstart', onTouchStart, { passive: true });
    section.addEventListener('touchmove', onTouchMove, { passive: false });
    section.addEventListener('touchend', onTouchEnd);
    section.addEventListener('touchcancel', onTouchEnd);

    container._wallScrollCleanup = () => {
        window.removeEventListener('scroll', onScroll);
        window.removeEventListener('resize', onResize);
        section.removeEventListener('mousedown', onMouseDown);
        section.removeEventListener('mousemove', onMouseMove);
        window.removeEventListener('mouseup', onMouseUp);
        section.removeEventListener('touchstart', onTouchStart);
        section.removeEventListener('touchmove', onTouchMove);
        section.removeEventListener('touchend', onTouchEnd);
        section.removeEventListener('touchcancel', onTouchEnd);
    };
}

window.initGalleryWallScroll = initGalleryWallScroll;

/**
 * Modern Masonry initialization using @masonry-grid/vanilla
 * Uses CSS Grid + percentage-based transforms for efficient layout
 * No pixel calculations needed - browser handles responsiveness natively
 */
function initGalleryMasonry(containerOrSelector) {
    const grid = typeof containerOrSelector === 'string'
        ? document.querySelector(containerOrSelector)
        : containerOrSelector || document.querySelector('.gallery-masonry');

    if (!grid) {
        console.warn('Masonry: No grid container found');
        return null;
    }
    if (grid._masonryInitialized) return grid._masonryInstance;

    // Check if masonry classes are available
    if (typeof BalancedMasonryGrid === 'undefined' && typeof RegularMasonryGrid === 'undefined') {
        console.warn('Masonry library not loaded, using CSS Grid fallback');
        grid.classList.add('masonry-ready');
        return null;
    }

    // Determine which masonry class to use based on settings
    const masonryType = window.templateSettings?.masonry?.type || 'balanced';
    const MasonryClass = masonryType === 'regular' ? RegularMasonryGrid : BalancedMasonryGrid;
    const className = masonryType === 'regular' ? 'RegularMasonryGrid' : 'BalancedMasonryGrid';

    console.log(`Masonry: Using ${className} on grid with ${grid.children.length} children`);

    // Debug: Check item dimensions
    const items = grid.querySelectorAll('.masonry-frame');
    console.log(`Masonry: Found ${items.length} .masonry-frame items`);
    if (items.length > 0) {
        const firstItem = items[0];
        const rect = firstItem.getBoundingClientRect();
        const style = getComputedStyle(firstItem);
        console.log(`Masonry: First item dimensions: ${rect.width}x${rect.height}, aspect-ratio: ${style.aspectRatio}`);
    }

    grid._masonryInitialized = true;

    // Destroy existing instance if any
    if (grid._masonryInstance) {
        grid._masonryInstance.destroy();
        grid._masonryInstance = null;
    }

    // Create masonry instance
    try {
        grid._masonryInstance = new MasonryClass(grid);
        console.log(`Masonry: ${className} instance created successfully`);

        // Debug: Check if transforms are applied after a short delay
        setTimeout(() => {
            const transformedItems = Array.from(items).filter(item => item.style.transform);
            console.log(`Masonry: ${transformedItems.length}/${items.length} items have transforms`);
            if (transformedItems.length > 0) {
                console.log('Masonry: First transform:', transformedItems[0].style.transform);
            }
        }, 100);
    } catch (e) {
        console.error(`Masonry: Failed to create ${className}:`, e);
        grid.classList.add('masonry-ready');
        return null;
    }

    // Show the grid with smooth fade-in
    requestAnimationFrame(() => {
        grid.classList.add('masonry-ready');
        if (window.lenisResize) setTimeout(window.lenisResize, 100);
    });

    return grid._masonryInstance;
}

// Make initGalleryMasonry globally available for template switcher
window.initGalleryMasonry = initGalleryMasonry;

// Dense Grid is now CSS-only - no JavaScript initialization needed
// Classes (.wide, .tall, .big) are calculated server-side in Twig

/**
 * Cleanup function - destroys all layout instances before reinitializing
 */
function cleanupGalleryInstances() {
    // Destroy masonry-grid instance
    const masonryGrid = document.querySelector('.gallery-masonry');
    if (masonryGrid && masonryGrid._masonryInstance) {
        try {
            masonryGrid._masonryInstance.destroy();
        } catch(e) {}
        masonryGrid._masonryInstance = null;
        masonryGrid._masonryInitialized = false;
    }

    // Destroy masonry-portfolio instance
    const portfolioGrid = document.querySelector('.masonry-portfolio-grid');
    if (portfolioGrid && portfolioGrid._masonryPortfolioInstance) {
        try {
            portfolioGrid._masonryPortfolioInstance.destroy();
        } catch(e) {}
        portfolioGrid._masonryPortfolioInstance = null;
        portfolioGrid._masonryPortfolioInitialized = false;
        if (portfolioGrid._masonryPortfolioResizeHandler) {
            window.removeEventListener('resize', portfolioGrid._masonryPortfolioResizeHandler);
            portfolioGrid._masonryPortfolioResizeHandler = null;
        }
    }

    // Dense grid is CSS-only, no cleanup needed

    // Cleanup gallery wall scroll handlers
    const wallContainer = document.querySelector('.gallery-wall');
    if (wallContainer && wallContainer._wallScrollCleanup) {
        wallContainer._wallScrollCleanup();
        wallContainer._wallScrollCleanup = null;
    }

    // Remove dynamic styles
    document.querySelectorAll('[id$="-dynamic-style"]').forEach(el => el.remove());
}

// Make cleanup globally available
window.cleanupGalleryInstances = cleanupGalleryInstances;

// Initialize layout on page load
if (templateSlug === 'grid-ampia') {
    if (document.readyState === 'complete') {
        initCreativeLayout();
    } else {
        window.addEventListener('load', () => initCreativeLayout());
    }
} else if (templateSlug === 'gallery-wall-scroll') {
    if (document.readyState === 'complete') {
        initGalleryWallScroll();
    } else {
        window.addEventListener('load', () => initGalleryWallScroll());
    }
} else if (templateSlug === 'masonry-portfolio') {
    if (document.readyState === 'complete') {
        initMasonryPortfolio();
    } else {
        window.addEventListener('load', () => initMasonryPortfolio());
    }
} else if (layout === 'masonry') {
    // Wait for ES module to load and expose BalancedMasonryGrid
    function tryInitMasonry() {
        if (typeof BalancedMasonryGrid !== 'undefined') {
            console.log('BalancedMasonryGrid available, initializing masonry');
            initGalleryMasonry();
        } else if (window._masonryGridReady) {
            // Module fired event but we missed it, try again
            console.log('Module ready flag set, retrying...');
            setTimeout(tryInitMasonry, 10);
        } else {
            // Library not ready yet, wait for the event
            console.log('Waiting for masonry-grid module...');
            window.addEventListener('masonry-grid-ready', () => {
                console.log('masonry-grid-ready event received');
                initGalleryMasonry();
            }, { once: true });
        }
    }
    if (document.readyState === 'complete') {
        tryInitMasonry();
    } else {
        window.addEventListener('load', tryInitMasonry);
    }
}
// dense_grid is CSS-only, no JS initialization needed

// Magazine Split autoscroll initializer
function initMagazineAutoscroll() {
    try {
        var container = document.getElementById('images-gallery') || document;
        var isMobile = window.matchMedia('(max-width: 767px)').matches;
        var isTablet = window.matchMedia('(min-width: 768px) and (max-width: 1199px)').matches;
        var isDesktop = window.matchMedia('(min-width: 1200px)').matches;

        var mob = container.querySelector('.m-mobile-wrap');
        var tablet = container.querySelector('.m-tablet-wrap');
        var desk = container.querySelector('.m-desktop-wrap');

        if (mob) mob.style.display = isMobile ? 'block' : 'none';
        if (tablet) tablet.style.display = isTablet ? 'flex' : 'none';
        if (desk) desk.style.display = isDesktop ? 'flex' : 'none';

        var trackOriginals = new WeakMap();
        var ensureTrackFill = function(track, colHeight) {
            if (!track || !colHeight) return;
            var originals = trackOriginals.get(track);
            if (!originals) {
                originals = Array.from(track.children);
                trackOriginals.set(track, originals);
            }
            if (!originals.length) return;
            var minHeight = colHeight * 2;
            var loops = 0;
            while (track.scrollHeight < minHeight && loops < 12) {
                var frag = document.createDocumentFragment();
                originals.forEach(function(node) {
                    var clone = node.cloneNode(true);
                    var link = clone.querySelector && clone.querySelector('a.pswp-link');
                    if (link) link.classList.add('pswp-is-duplicate');
                    frag.appendChild(clone);
                });
                track.appendChild(frag);
                loops += 1;
            }
        };
        var forceEager = function(scope) {
            if (!scope) return;
            scope.querySelectorAll('img[loading="lazy"]').forEach(function(img) {
                img.setAttribute('loading', 'eager');
            });
        };

        var activeWrap = isMobile ? mob : (isTablet ? tablet : desk);
        if (activeWrap) {
            activeWrap.querySelectorAll('source[data-srcset]').forEach(function(source) {
                source.setAttribute('srcset', source.getAttribute('data-srcset'));
                source.removeAttribute('data-srcset');
            });
            activeWrap.querySelectorAll('img[data-src]').forEach(function(img) {
                img.setAttribute('src', img.getAttribute('data-src'));
                img.removeAttribute('data-src');
            });
        }

        container.querySelectorAll('.m-col').forEach(function(col) {
            var track = col.querySelector('.m-track'); if (!track) return;
            ensureTrackFill(track, col.clientHeight || window.innerHeight);
            forceEager(track);
            track.style.animation = 'none';
            track.offsetHeight;
            var dir = (col.getAttribute('data-direction') || 'down').toLowerCase();
            var dur = (getComputedStyle(col).getPropertyValue('--m-duration') || '60s').trim() || '60s';
            var anim = (dir === 'up' ? 'mScrollUp' : 'mScrollDown') + ' ' + dur + ' linear infinite';
            track.style.transform = dir === 'up' ? 'translateY(-50%)' : 'translateY(0)';
            track.style.animation = anim;
            track.style.animationPlayState = '';
        });

        var mobileTrack = container.querySelector('.m-mobile-track');
        if (mobileTrack) {
            var mobWrap = mobileTrack.closest('.m-mobile') || mobileTrack.parentElement;
            ensureTrackFill(mobileTrack, (mobWrap && mobWrap.clientHeight) || window.innerHeight);
            forceEager(mobileTrack);
        }
        var rerun = function() {
            container.querySelectorAll('.m-col').forEach(function(col) {
                var track = col.querySelector('.m-track'); if (!track) return;
                ensureTrackFill(track, col.clientHeight || window.innerHeight);
            });
            var mobTrack = container.querySelector('.m-mobile-track');
            if (mobTrack) {
                var wrap = mobTrack.closest('.m-mobile') || mobTrack.parentElement;
                ensureTrackFill(mobTrack, (wrap && wrap.clientHeight) || window.innerHeight);
            }
        };
        setTimeout(rerun, 200);
        setTimeout(rerun, 800);

        if (!container._magazineDragBound) {
            container._magazineDragBound = true;
            var dragState = { active: false, moved: false, startX: 0, startY: 0, startScroll: 0, sectionTop: 0, col: null };
            var startDrag = function(clientX, clientY, target) {
                dragState.active = true;
                dragState.moved = false;
                dragState.col = target;
                dragState.sectionTop = container.getBoundingClientRect().top + window.scrollY;
                dragState.startX = clientX;
                dragState.startY = clientY;
                dragState.startScroll = window.scrollY;
                target.style.cursor = 'grabbing';
            };
            var moveDrag = function(clientX, clientY, ev) {
                if (!dragState.active) return;
                var dx = clientX - dragState.startX;
                var dy = clientY - dragState.startY;
                if (Math.abs(dy) > Math.abs(dx)) return;
                if (Math.abs(dx) <= 8) return;
                if (!dragState.moved) {
                    dragState.moved = true;
                    document.body.classList.add('magazine-dragging');
                }
                if (ev) ev.preventDefault();
                var nextTop = dragState.startScroll - dx;
                var maxTop = dragState.sectionTop + Math.max(0, container.offsetHeight - window.innerHeight);
                if (nextTop < dragState.sectionTop) nextTop = dragState.sectionTop;
                if (nextTop > maxTop) nextTop = maxTop;
                window.scrollTo({ top: nextTop, left: 0, behavior: 'auto' });
            };
            var endDrag = function() {
                if (!dragState.active) return;
                dragState.active = false;
                if (dragState.col) dragState.col.style.cursor = '';
                dragState.col = null;
                document.body.classList.remove('magazine-dragging');
                if (dragState.moved) {
                    var guard = function(clickEv) {
                        if (container.contains(clickEv.target)) {
                            clickEv.preventDefault();
                            clickEv.stopPropagation();
                        }
                        container.removeEventListener('click', guard, true);
                    };
                    container.addEventListener('click', guard, true);
                }
            };
            var onMouseDown = function(ev) {
                if (ev.button !== 0) return;
                var target = ev.target.closest ? ev.target.closest('.m-col') : null;
                if (!target) return;
                ev.preventDefault();
                startDrag(ev.clientX, ev.clientY, target);
            };
            var onMouseMove = function(ev) { moveDrag(ev.clientX, ev.clientY, ev); };
            var onMouseUp = function() { endDrag(); };
            var onTouchStart = function(ev) {
                if (!ev.touches || ev.touches.length !== 1) return;
                var target = ev.target.closest ? ev.target.closest('.m-col') : null;
                if (!target) return;
                startDrag(ev.touches[0].clientX, ev.touches[0].clientY, target);
            };
            var onTouchMove = function(ev) {
                if (!ev.touches || ev.touches.length !== 1) return;
                moveDrag(ev.touches[0].clientX, ev.touches[0].clientY, ev);
            };
            var onTouchEnd = function() { endDrag(); };
            var onDragStart = function(ev) { ev.preventDefault(); };
            var onWindowBlur = function() { endDrag(); };
            var onVisibility = function() { if (document.hidden) endDrag(); };
            container.addEventListener('mousedown', onMouseDown);
            window.addEventListener('mousemove', onMouseMove);
            window.addEventListener('mouseup', onMouseUp);
            container.addEventListener('touchstart', onTouchStart, { passive: true });
            window.addEventListener('touchmove', onTouchMove, { passive: false });
            window.addEventListener('touchend', onTouchEnd);
            window.addEventListener('touchcancel', onTouchEnd);
            container.addEventListener('dragstart', onDragStart);
            window.addEventListener('blur', onWindowBlur);
            document.addEventListener('visibilitychange', onVisibility);
            container._magazineDragCleanup = function() {
                container.removeEventListener('mousedown', onMouseDown);
                window.removeEventListener('mousemove', onMouseMove);
                window.removeEventListener('mouseup', onMouseUp);
                container.removeEventListener('touchstart', onTouchStart);
                window.removeEventListener('touchmove', onTouchMove);
                window.removeEventListener('touchend', onTouchEnd);
                window.removeEventListener('touchcancel', onTouchEnd);
                container.removeEventListener('dragstart', onDragStart);
                window.removeEventListener('blur', onWindowBlur);
                document.removeEventListener('visibilitychange', onVisibility);
            };
        }
    } catch(e) {
        console.error('initMagazineAutoscroll error:', e);
    }
}

// Initialize magazine if active
if (layout === 'magazine') {
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(initMagazineAutoscroll, 100);
    });
}

// Template switcher - aggressive reinitialization handler
function loadTemplateAssets(assets) {
    if (!assets) return;
    const cssList = Array.isArray(assets.css) ? assets.css : [];
    const jsList = Array.isArray(assets.js) ? assets.js : [];
    const basePath = (window.basePath || '').replace(/\/$/, '');
    const allowedPrefix = `${basePath}/plugins/custom-templates-pro/`;
    const cspNonce = document.querySelector('script[nonce]')?.getAttribute('nonce');
    const isValidAssetPath = (path) => {
        try {
            const url = new URL(path, window.location.origin);
            const normalized = url.pathname;
            if (normalized.includes('/../')) return false;
            if (normalized.startsWith('/plugins/custom-templates-pro/')) return true;
            if (basePath && normalized.startsWith(`${basePath}/plugins/custom-templates-pro/`)) return true;
            return false;
        } catch {
            return false;
        }
    };

    document.querySelectorAll('[data-template-asset]').forEach((node) => {
        node.parentNode?.removeChild(node);
    });

    cssList.forEach(href => {
        if (!href || document.querySelector(`link[data-template-asset="${href}"]`)) return;
        if (!isValidAssetPath(href) || (!href.startsWith(allowedPrefix) && !href.startsWith('/plugins/custom-templates-pro/'))) {
            console.warn('Asset CSS bloccato: percorso non valido', href);
            return;
        }
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = href;
        link.setAttribute('data-template-asset', href);
        link.onerror = () => console.error('Errore caricamento CSS:', href);
        document.head.appendChild(link);
    });

    jsList.forEach(src => {
        if (!src || document.querySelector(`script[data-template-asset="${src}"]`)) return;
        if (!isValidAssetPath(src) || (!src.startsWith(allowedPrefix) && !src.startsWith('/plugins/custom-templates-pro/'))) {
            console.warn('Asset JS bloccato: percorso non valido', src);
            return;
        }
        const script = document.createElement('script');
        script.src = src;
        script.defer = true;
        if (cspNonce) script.setAttribute('nonce', cspNonce);
        script.setAttribute('data-template-asset', src);
        script.onerror = () => console.error('Errore caricamento JS:', src);
        document.body.appendChild(script);
    });
}

document.addEventListener('click', function(event) {
    const el = event.target.closest('.tpl-switch');
    if (!el) return;
    if (el.tagName === 'A') event.preventDefault();
    if (el.dataset.switchInProgress === '1') return;
    el.dataset.switchInProgress = '1';

    const galleryContainer = document.getElementById('images-gallery');
    const scrollY = window.scrollY;
    const templateId = el.getAttribute('data-template-id');
    const albumRef = el.getAttribute('data-album-ref') || window.location.pathname.split('/').pop();
    if (!galleryContainer || !templateId || !albumRef) {
        delete el.dataset.switchInProgress;
        return;
    }

    // STEP 1: Full cleanup before switching
    if (typeof cleanupGalleryInstances === 'function') {
        cleanupGalleryInstances();
    }

    const originalContent = galleryContainer.innerHTML;
    const originalClasses = galleryContainer.className;

    // Show loading state
    galleryContainer.style.opacity = '0.5';
    galleryContainer.style.pointerEvents = 'none';

    // Update button states immediately
    document.querySelectorAll('.tpl-switch').forEach(btn => {
        btn.classList.remove('bg-black', 'text-white');
        btn.classList.add('text-neutral-700', 'hover:bg-neutral-100');
    });
    el.classList.remove('text-neutral-700', 'hover:bg-neutral-100');
    el.classList.add('bg-black', 'text-white');

    const fetchUrl = `${window.basePath}/api/gallery/template?album=${encodeURIComponent(albumRef)}&template=${encodeURIComponent(templateId)}`;

    fetch(fetchUrl, { headers: { 'Accept': 'text/html', 'X-Requested-With': 'XMLHttpRequest' } })
        .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.text(); })
        .then(html => {
            // STEP 2: Parse settings and strip script tag from response HTML
            let parsedHtml = html;
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const settingsScript = doc.querySelector('script');
            if (settingsScript && settingsScript.textContent) {
                const match = settingsScript.textContent.match(/window\.templateSettings\s*=\s*(\{[\s\S]*?\});/);
                if (match) {
                    try {
                        window.templateSettings = JSON.parse(match[1]);
                    } catch(e) {
                        console.error('Failed to parse templateSettings:', e);
                        window.templateSettings = {};
                    }
                }
                const assetsMatch = settingsScript.textContent.match(/window\.templateAssets\s*=\s*(\{[\s\S]*?\});/);
                if (assetsMatch) {
                    try {
                        window.templateAssets = JSON.parse(assetsMatch[1]);
                    } catch (e) {
                        console.error('Failed to parse templateAssets:', e);
                        console.warn('templateAssets JSON malformato, uso default:', assetsMatch[1].substring(0, 100));
                        window.templateAssets = { css: [], js: [] };
                    }
                } else {
                    console.debug('templateAssets non trovato nella risposta, uso default');
                    window.templateAssets = { css: [], js: [] };
                }
                settingsScript.remove();
            }
            parsedHtml = doc.body ? doc.body.innerHTML : html;

            loadTemplateAssets(window.templateAssets);

            const rawLayout = window.templateSettings?.layout || 'grid';
            const templateSlug = window.templateSettings?.template_slug || '';
            const isCustomTemplate = window.templateSettings?.layout === 'custom';
            const newLayout = templateSlug === 'masonry-portfolio'
                ? 'masonry_portfolio'
                : (templateSlug === 'grid-ampia'
                    ? 'creative_layout'
                    : (templateSlug === 'gallery-wall-scroll'
                        ? 'gallery_wall'
                        : (rawLayout === 'masonry_fit' ? 'masonry' : rawLayout)));
            const cols = window.templateSettings?.columns || {desktop: 3, tablet: 2, mobile: 1};
            const gap = window.templateSettings?.gap || {horizontal: 16, vertical: 16};
            const dense = window.templateSettings?.dense_grid || {};

            // STEP 3: Remove all dynamic styles first
            document.querySelectorAll('[id$="-dynamic-style"]').forEach(s => s.remove());

            // STEP 4: Completely reset the container
            const containerId = galleryContainer.id;
            galleryContainer.className = '';
            galleryContainer.removeAttribute('style');
            galleryContainer.innerHTML = '';

            // STEP 5: Inject new layout-specific styles
            const styleEl = document.createElement('style');
            styleEl.id = `gallery-${newLayout}-dynamic-style`;

            if (newLayout !== 'gallery_wall') {
                document.body.classList.remove('gallery-wall-page');
            }

            if (isCustomTemplate) {
                styleEl.textContent = '';
                galleryContainer.className = 'pswp-gallery';
                galleryContainer.setAttribute('data-layout', 'custom');
            } else if (newLayout === 'dense_grid') {
                const minCell = dense.minCellDesktop || 250;
                const rowHeight = dense.rowHeight || 200;
                const gridGap = dense.gap || 10;

                styleEl.textContent = `
                    .dense-grid { display: grid; grid-gap: ${gridGap}px; grid-template-columns: repeat(auto-fit, minmax(${minCell}px, 1fr)); grid-auto-rows: ${rowHeight}px; grid-auto-flow: dense; padding: ${gridGap}px; }
                    .dense-grid > div { display: flex; justify-content: center; align-items: center; position: relative; overflow: hidden; }
                    .dense-grid > div > a { display: block; width: 100%; height: 100%; }
                    .dense-grid > div > a > picture { display: block; width: 100%; height: 100%; }
                    .dense-grid > div > a > picture > img { width: 100%; height: 100%; object-fit: cover; border-radius: 5px; transition: transform 0.3s ease; }
                    .dense-grid > div:hover > a > picture > img { transform: scale(1.03); }
                    .dense-grid .wide { grid-column: span 2; }
                    .dense-grid .tall { grid-row: span 2; }
                    .dense-grid .big { grid-column: span 2; grid-row: span 2; }
                    @media (max-width: 640px) { .dense-grid { grid-template-columns: repeat(2, 1fr); grid-auto-rows: 150px; } .dense-grid .wide, .dense-grid .tall, .dense-grid .big { grid-column: span 1; grid-row: span 1; } }
                `;
                galleryContainer.className = 'dense-grid pswp-gallery';
                galleryContainer.setAttribute('data-layout', 'dense_grid');

            } else if (newLayout === 'magazine') {
                styleEl.textContent = ''; // Magazine has its own embedded styles
                galleryContainer.className = 'mt-6';
                galleryContainer.setAttribute('data-layout', 'magazine');

            } else if (newLayout === 'gallery_wall') {
                const wall = window.templateSettings?.gallery_wall || {};
                const wallDesktop = wall.desktop || {};
                const wallTablet = wall.tablet || {};
                const wallMobile = wall.mobile || {};
                const hRatio = wallDesktop.horizontal_ratio ?? 1.5;
                const vRatio = wallDesktop.vertical_ratio ?? 0.67;
                const hRatioT = wallTablet.horizontal_ratio ?? 1.3;
                const vRatioT = wallTablet.vertical_ratio ?? 0.6;
                const divider = wall.divider ?? 2;
                const mobileCols = wallMobile.columns ?? 2;
                const mobileGap = wallMobile.gap ?? 8;
                const mobileWideEvery = wallMobile.wide_every ?? 5;

                styleEl.textContent = `
                    .gallery-wall, .gallery-wall * { margin: 0; padding: 0; box-sizing: border-box; }
                    .gallery-wall-section { position: relative; }
                    .gallery-wall-container { position: sticky; top: var(--header-height, 80px); height: calc(100vh - var(--header-height, 80px)); display: flex; align-items: center; overflow: hidden; background: #ffffff; z-index: 10; }
                    html.dark .gallery-wall-container { background: #0a0a0a; }
                    .gallery-wall-track { display: flex; gap: 0; will-change: transform; }
                    .gallery-wall-item { flex-shrink: 0; height: calc(100vh - var(--header-height, 80px)); position: relative; }
                    .gallery-wall-item.horizontal { width: calc((100vh - var(--header-height, 80px)) * var(--wall-h-ratio, 1.5)); }
                    .gallery-wall-item.vertical { width: calc((100vh - var(--header-height, 80px)) * var(--wall-v-ratio, 0.67)); }
                    .gallery-wall-item a { display: block; width: 100%; height: 100%; }
                    .gallery-wall-item picture, .gallery-wall-item img { width: 100%; height: 100%; object-fit: cover; display: block; }
                    .gallery-wall-item::after { content: ''; position: absolute; right: 0; top: 0; bottom: 0; width: var(--wall-divider, 2px); background: #fff; }
                    html.dark .gallery-wall-item::after { background: #171717; }
                    .gallery-wall-overlay { position: absolute; bottom: 0; left: 0; right: 0; padding: 1.5rem; background: linear-gradient(transparent, rgba(0,0,0,0.7)); color: white; opacity: 0; transition: opacity 0.3s ease; }
                    .gallery-wall-item:hover .gallery-wall-overlay { opacity: 1; }
                    .gallery-wall-overlay h3 { font-size: 1rem; font-weight: 500; margin: 0 0 0.25rem 0; }
                    .gallery-wall-overlay p { font-size: 0.85rem; opacity: 0.8; margin: 0; }
                    .gallery-mobile-grid { display: none; }
                    @media (max-width: 1024px) {
                        .gallery-wall-item.horizontal { width: calc((100vh - var(--header-height, 80px)) * var(--wall-h-ratio-tablet, 1.3)); }
                        .gallery-wall-item.vertical { width: calc((100vh - var(--header-height, 80px)) * var(--wall-v-ratio-tablet, 0.6)); }
                    }
                    @media (max-width: 768px) {
                        .gallery-wall-section { display: none; }
                        .gallery-mobile-grid { display: block; padding: var(--wall-mobile-gap, 8px); }
                        .gallery-mobile-grid-inner { display: grid; grid-template-columns: repeat(var(--wall-mobile-cols, 2), minmax(0, 1fr)); gap: var(--wall-mobile-gap, 8px); }
                        .gallery-mobile-item { aspect-ratio: 1; overflow: hidden; position: relative; background: #f5f5f5; }
                        .gallery-mobile-item.wide { grid-column: span 2; aspect-ratio: 16/9; }
                        .gallery-mobile-item a, .gallery-mobile-item picture, .gallery-mobile-item img { display: block; width: 100%; height: 100%; object-fit: cover; }
                    }
                    @media (max-width: 480px) { .gallery-mobile-grid { padding: 0.5rem; } }
                `;
                galleryContainer.className = 'gallery-wall pswp-gallery';
                galleryContainer.setAttribute('data-layout', 'gallery_wall');
                galleryContainer.setAttribute('data-wall-init', '1');
                galleryContainer.style.setProperty('--wall-h-ratio', hRatio);
                galleryContainer.style.setProperty('--wall-v-ratio', vRatio);
                galleryContainer.style.setProperty('--wall-h-ratio-tablet', hRatioT);
                galleryContainer.style.setProperty('--wall-v-ratio-tablet', vRatioT);
                galleryContainer.style.setProperty('--wall-divider', `${divider}px`);
                galleryContainer.style.setProperty('--wall-mobile-cols', mobileCols);
                galleryContainer.style.setProperty('--wall-mobile-gap', `${mobileGap}px`);
                galleryContainer.style.setProperty('--wall-mobile-wide-every', mobileWideEvery);

            } else if (newLayout === 'masonry_portfolio') {
                const mp = window.templateSettings?.masonry_portfolio || {};
                const mpCols = mp.columns || window.templateSettings?.columns || {desktop: 4, tablet: 3, mobile: 1};
                const mpGapH = mp.gap_h ?? window.templateSettings?.gap?.horizontal ?? 16;
                const mpGapV = mp.gap_v ?? window.templateSettings?.gap?.vertical ?? 16;
                const layoutMode = mp.layout_mode || 'fullwidth';
                const mpStyle = window.templateSettings?.style || {};
                const d = Math.round(mpCols.desktop || 4);
                const t = Math.round(mpCols.tablet || 3);
                const m = Math.round(mpCols.mobile || 1);

                styleEl.textContent = `
                    .masonry-portfolio-grid { --mp-gap-h: ${mpGapH}px; --mp-gap-v: ${mpGapV}px; --mp-cols-desktop: ${d}; --mp-cols-tablet: ${t}; --mp-cols-mobile: ${m}; width: 100%; margin: 0 auto; position: relative; }
                    .masonry-portfolio-grid.is-boxed { max-width: 1400px; padding: 0 20px; }
                    .masonry-portfolio-grid .grid-sizer,
                    .masonry-portfolio-grid .photo-item { width: calc((100% - (var(--mp-cols-mobile) - 1) * var(--mp-gap-h)) / var(--mp-cols-mobile)); }
                    .masonry-portfolio-grid .photo-item.landscape { width: calc((2 * ((100% - (var(--mp-cols-mobile) - 1) * var(--mp-gap-h)) / var(--mp-cols-mobile))) + var(--mp-gap-h)); }
                    .masonry-portfolio-grid .photo-item { position: relative; margin-bottom: var(--mp-gap-v); background: #f5f5f5; overflow: hidden; cursor: pointer; transition: opacity 0.3s ease, box-shadow 0.3s ease; opacity: 0; }
                    .masonry-portfolio-grid .photo-item.is-loaded { opacity: 1; }
                    .masonry-portfolio-grid[data-rounded=\"1\"] .photo-item,
                    .masonry-portfolio-grid[data-rounded=\"1\"] .photo-item img { border-radius: 12px; }
                    .masonry-portfolio-grid[data-shadow=\"1\"] .photo-item { box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); }
                    .masonry-portfolio-grid[data-hover-scale=\"1\"] .photo-item:hover { box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15); z-index: 2; }
                    .masonry-portfolio-grid .photo-item img { display: block; width: 100%; height: auto; opacity: 0; transform: scale(1); transition: opacity 0.3s ease, transform 0.3s ease; }
                    .masonry-portfolio-grid[data-hover-scale=\"1\"] .photo-item:hover img { transform: scale(1.02); }
                    .masonry-portfolio-grid .photo-item.is-loaded img { opacity: 1; }
                    .masonry-portfolio-grid .photo-loading { position: absolute; top: 50%; left: 50%; width: 36px; height: 36px; margin: -18px 0 0 -18px; border: 3px solid rgba(0, 0, 0, 0.1); border-top-color: #333; border-radius: 50%; animation: mp-spin 1s linear infinite; }
                    .masonry-portfolio-grid .photo-item.is-loaded .photo-loading { display: none; }
                    @keyframes mp-spin { to { transform: rotate(360deg); } }
                    @media (min-width: 768px) {
                        .masonry-portfolio-grid .grid-sizer,
                        .masonry-portfolio-grid .photo-item { width: calc((100% - (var(--mp-cols-tablet) - 1) * var(--mp-gap-h)) / var(--mp-cols-tablet)); }
                        .masonry-portfolio-grid .photo-item.landscape { width: calc((2 * ((100% - (var(--mp-cols-tablet) - 1) * var(--mp-gap-h)) / var(--mp-cols-tablet))) + var(--mp-gap-h)); }
                    }
                    @media (min-width: 1200px) {
                        .masonry-portfolio-grid .grid-sizer,
                        .masonry-portfolio-grid .photo-item { width: calc((100% - (var(--mp-cols-desktop) - 1) * var(--mp-gap-h)) / var(--mp-cols-desktop)); }
                        .masonry-portfolio-grid .photo-item.landscape { width: calc((2 * ((100% - (var(--mp-cols-desktop) - 1) * var(--mp-gap-h)) / var(--mp-cols-desktop))) + var(--mp-gap-h)); }
                    }
                    @media (max-width: 480px) {
                        .masonry-portfolio-grid.is-boxed { padding: 0 10px; }
                        .masonry-portfolio-grid[data-hover-scale=\"1\"] .photo-item:hover { box-shadow: none; }
                        .masonry-portfolio-grid[data-hover-scale=\"1\"] .photo-item:hover img { transform: scale(1); }
                    }
                `;

                galleryContainer.className = `masonry-portfolio-grid pswp-gallery${layoutMode === 'boxed' ? ' is-boxed' : ''}`;
                galleryContainer.setAttribute('data-layout', 'masonry_portfolio');
                galleryContainer.setAttribute('data-gap-h', mpGapH);
                galleryContainer.setAttribute('data-gap-v', mpGapV);
                galleryContainer.setAttribute('data-cols-desktop', d);
                galleryContainer.setAttribute('data-cols-tablet', t);
                galleryContainer.setAttribute('data-cols-mobile', m);
                galleryContainer.setAttribute('data-rounded', mpStyle.rounded ? '1' : '0');
                galleryContainer.setAttribute('data-shadow', mpStyle.shadow ? '1' : '0');
                galleryContainer.setAttribute('data-hover-scale', mpStyle.hover_scale === false ? '0' : '1');

            } else if (newLayout === 'creative_layout') {
                const creative = window.templateSettings?.creative_layout || {};
                const gap = Math.round(creative.gap ?? 15);
                const hoverTooltip = creative.hover_tooltip === false ? '0' : '1';
                const hoverScale = window.templateSettings?.style?.hover_scale === false ? '0' : '1';

                styleEl.textContent = `
                    .creative-gallery { padding: 0 0 4rem 0; }
                    .creative-gallery .photo-grid { display: flex; flex-wrap: wrap; gap: ${gap}px; }
                    .creative-gallery .img-container { position: relative; overflow: hidden; cursor: pointer; background: #f5f5f5; flex-shrink: 0; }
                    .creative-gallery .img-container img { width: 100%; height: 100%; object-fit: cover; transform: scale(1); transition: transform 0.3s ease-in-out, opacity 0.3s ease; display: block; opacity: 0; }
                    .creative-gallery[data-hover-scale=\"1\"] .img-container:hover img { transform: scale(1.05); }
                    .creative-gallery .img-container img.loaded { opacity: 1; }
                    .creative-gallery .img-content { display: none; }
                    .creative-gallery[data-hover-tooltip=\"1\"] .img-content-hover { z-index: 1000; position: fixed; pointer-events: none; white-space: nowrap; display: none; padding: 1rem; background: #fff; font-weight: 400; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }
                    .creative-gallery[data-hover-tooltip=\"1\"] .img-container:hover .img-content-hover { display: block; }
                    .creative-gallery .title { color: #2e2e2e; font-size: 1.5rem; font-weight: 700; margin: 0; }
                    .creative-gallery .category { font-size: 1rem; color: #787878; margin: 0; }
                    .creative-gallery .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 40px; height: 40px; border: 3px solid #e0e0e0; border-top-color: #333; border-radius: 50%; animation: creative-spin 1s linear infinite; }
                    @keyframes creative-spin { to { transform: translate(-50%, -50%) rotate(360deg); } }
                    .creative-gallery .w-25 { width: calc(25% - 12px); }
                    .creative-gallery .w-33 { width: calc(33.333% - 11px); }
                    .creative-gallery .w-50 { width: calc(50% - 8px); }
                    .creative-gallery .w-66 { width: calc(66.666% - 6px); }
                    .creative-gallery .w-100 { width: 100%; }
                    .creative-gallery .h-300 { height: 300px; }
                    .creative-gallery .h-400 { height: 400px; }
                    .creative-gallery .h-500 { height: 500px; }
                    .creative-gallery .h-600 { height: 600px; }
                    .creative-gallery .h-700 { height: 700px; }
                    @media (max-width: 768px) {
                        .creative-gallery .w-25 { width: calc(50% - 8px); }
                        .creative-gallery .w-33 { width: calc(50% - 8px); }
                        .creative-gallery .w-50 { width: calc(50% - 8px); }
                        .creative-gallery .w-66 { width: 100%; }
                        .creative-gallery .w-100 { width: 100%; }
                        .creative-gallery .h-600, .creative-gallery .h-700 { height: 500px; }
                    }
                    @media (max-width: 1024px) {
                        .creative-gallery[data-hover-scale=\"1\"] .img-container:hover img { transform: none; }
                        .creative-gallery[data-hover-tooltip=\"1\"] .img-container:hover .img-content-hover { display: none; }
                        .creative-gallery .img-content { display: block; padding: 1rem 0; }
                    }
                    @media (max-width: 480px) {
                        .creative-gallery .photo-grid { gap: 10px; }
                        .creative-gallery .w-25, .creative-gallery .w-33, .creative-gallery .w-50, .creative-gallery .w-66, .creative-gallery .w-100 { width: 100%; }
                        .creative-gallery .h-300, .creative-gallery .h-400, .creative-gallery .h-500, .creative-gallery .h-600, .creative-gallery .h-700 { height: 300px; }
                    }
                `;

                galleryContainer.className = 'creative-gallery pswp-gallery';
                galleryContainer.setAttribute('data-layout', 'creative_layout');
                galleryContainer.setAttribute('data-hover-tooltip', hoverTooltip);
                galleryContainer.setAttribute('data-hover-scale', hoverScale);
                galleryContainer.setAttribute('data-gap', String(gap));

            } else if (newLayout === 'masonry') {
                const gH = gap.horizontal || 16;
                const gV = gap.vertical || 16;
                const d = Math.round(cols.desktop || 3);
                const t = Math.round(cols.tablet || 2);
                const m = Math.round(cols.mobile || 1);

                // Using CSS variables and inset for gaps per @masonry-grid/vanilla docs
                // translateY% ignores margins, so we use inset on inner container instead
                styleEl.textContent = `
                    .gallery-masonry { --masonry-gap-v: ${gV}px; --masonry-gap-h: ${gH}px; display: grid; column-gap: var(--masonry-gap-h); grid-template-columns: repeat(${m}, 1fr); align-items: start; opacity: 0; transition: opacity 0.3s ease-in-out; }
                    .gallery-masonry.masonry-ready { opacity: 1; }
                    @media (min-width: 768px) { .gallery-masonry { grid-template-columns: repeat(${t}, 1fr); } }
                    @media (min-width: 1024px) { .gallery-masonry { grid-template-columns: repeat(${d}, 1fr); } }
                    .gallery-masonry .masonry-frame { position: relative; aspect-ratio: var(--width) / var(--height); min-width: 0; }
                    .gallery-masonry .masonry-frame > .frame-content { position: absolute; inset: calc(var(--masonry-gap-v) / 2) 0; overflow: hidden; }
                    .gallery-masonry .masonry-frame img { display: block; width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease; }
                    .gallery-masonry .masonry-frame:hover img { transform: scale(1.03); }
                `;
                galleryContainer.className = 'gallery-masonry pswp-gallery';
                galleryContainer.setAttribute('data-layout', 'masonry');
                galleryContainer.setAttribute('data-gap-h', gH);
                galleryContainer.setAttribute('data-gap-v', gV);
                galleryContainer.setAttribute('data-cols-desktop', d);
                galleryContainer.setAttribute('data-cols-tablet', t);
                galleryContainer.setAttribute('data-cols-mobile', m);

            } else {
                // Grid layout
                const d = Math.round(cols.desktop || 3);
                const t = Math.round(cols.tablet || 2);
                const m = Math.round(cols.mobile || 1);
                const gH = gap.horizontal || 16;
                const gV = gap.vertical || 16;

                styleEl.textContent = `
                    .gallery-grid { display: grid; gap: ${gV}px ${gH}px; }
                    @media (min-width: 1024px) { .gallery-grid { grid-template-columns: repeat(${d}, 1fr); } }
                    @media (min-width: 768px) and (max-width: 1023px) { .gallery-grid { grid-template-columns: repeat(${t}, 1fr); } }
                    @media (max-width: 767px) { .gallery-grid { grid-template-columns: repeat(${m}, 1fr); } }
                `;
                galleryContainer.className = 'gallery-grid pswp-gallery';
                galleryContainer.setAttribute('data-layout', 'grid');
                galleryContainer.setAttribute('data-gap-h', gH);
                galleryContainer.setAttribute('data-gap-v', gV);
                galleryContainer.setAttribute('data-cols-desktop', d);
                galleryContainer.setAttribute('data-cols-tablet', t);
                galleryContainer.setAttribute('data-cols-mobile', m);
            }

            // Set hover-fade attribute based on template style settings
            const hoverFade = window.templateSettings?.style?.hover_fade !== false ? '1' : '0';
            galleryContainer.setAttribute('data-hover-fade', hoverFade);

            document.head.appendChild(styleEl);
            galleryContainer.id = containerId;

            // STEP 6: Inject the new HTML content
            galleryContainer.innerHTML = parsedHtml;

            // STEP 7: Update URL without scrolling
            const newUrl = `${window.basePath}/album/${albumRef}?template=${templateId}`;
            history.replaceState(null, '', newUrl);

            // STEP 8: Force layout recalculation
            galleryContainer.offsetHeight; // Force reflow

            // STEP 9: Initialize the new layout with aggressive timing
            requestAnimationFrame(() => {
                // Re-initialize lightbox first
                if (typeof initLightbox === 'function') {
                    try { initLightbox(); } catch(e) {}
                }

                // Initialize layout-specific code (dense_grid is CSS-only, no JS needed)
                if (newLayout === 'magazine') {
                    setTimeout(() => {
                        if (typeof initMagazineAutoscroll === 'function') {
                            try { initMagazineAutoscroll(); } catch(e) { console.error('Magazine init:', e); }
                        }
                    }, 50);
                } else if (newLayout === 'gallery_wall') {
                    initGalleryWallScroll(galleryContainer);
                } else if (newLayout === 'creative_layout') {
                    initCreativeLayout(galleryContainer);
                } else if (newLayout === 'masonry_portfolio') {
                    initMasonryPortfolio(galleryContainer);
                } else if (newLayout === 'masonry') {
                    // Reset initialized flag and reinit
                    galleryContainer._masonryInitialized = false;
                    // Use dynamic import if module not loaded yet
                    if (typeof window.BalancedMasonryGrid !== 'undefined') {
                        window.galleryMasonry = initGalleryMasonry(galleryContainer);
                    } else {
                        // Dynamic import the module
                        import(`${window.basePath}/assets/vendor/masonry-grid/index.js`)
                            .then(module => {
                                window.BalancedMasonryGrid = module.BalancedMasonryGrid;
                                window.RegularMasonryGrid = module.RegularMasonryGrid;
                                window._masonryGridReady = true;
                                window.galleryMasonry = initGalleryMasonry(galleryContainer);
                            })
                            .catch(err => console.error('Failed to load masonry module:', err));
                    }
                }

            // STEP 10: Make visible and animate items
            setTimeout(() => {
                galleryContainer.style.opacity = '1';
                galleryContainer.style.pointerEvents = '';

                    // Force visibility on all items as fallback
                    // But DON'T touch masonry-frame transforms - the masonry library manages those!
                    const allItems = galleryContainer.querySelectorAll('.gallery-item, .masonry-frame, .dense-grid-item, .photo-item');
                    allItems.forEach((item, idx) => {
                        if (!item.hasAttribute('data-animated')) {
                            item.style.opacity = '1';
                            // Only reset transform for non-masonry items
                            // Masonry library uses translateY(%) for positioning
                            if (!item.classList.contains('masonry-frame') && !item.classList.contains('photo-item')) {
                                item.style.transform = 'none';
                            }
                        }
                    });

                    // Trigger gallery animation if available
                    if (typeof window.animateGalleryOnce === 'function') {
                        window.animateGalleryOnce();
                    }

                    // Update Lenis scroll
                    if (window.lenisResize) {
                        setTimeout(window.lenisResize, 100);
                    }
                    // Restore scroll position (template 2 was jumping to top)
                    window.scrollTo({ top: scrollY, left: 0, behavior: 'auto' });
                }, 50);
            });
        })
        .catch(err => {
            console.error('Template switch failed:', err);
            galleryContainer.className = originalClasses;
            galleryContainer.innerHTML = originalContent;
            galleryContainer.style.opacity = '1';
            galleryContainer.style.pointerEvents = '';
        })
        .finally(() => { delete el.dataset.switchInProgress; });
});

// Download button handler
document.addEventListener('click', function(event) {
    const downloadBtn = event.target.closest('[data-action="download-image"]');
    if (downloadBtn) {
        event.preventDefault();
        event.stopPropagation();
        const url = downloadBtn.dataset.downloadUrl;
        if (url) {
            window.location.href = url;
        }
    }
});

// GSAP Animations
document.addEventListener('DOMContentLoaded', function() {
    if (document.body.dataset.gsapGalleryIntroDone === '1') {
        return;
    }
    document.body.dataset.gsapGalleryIntroDone = '1';

    const allHeaderEls = document.querySelectorAll('[data-gsap="categories"], [data-gsap="title"], [data-gsap="meta"], [data-gsap="excerpt"], [data-gsap="body"], [data-gsap="equipment"]');
    allHeaderEls.forEach(el => {
        el.setAttribute('data-animated', '1');
        el.style.opacity = '1';
        el.style.transform = 'none';
    });
    if (typeof gsap !== 'undefined') {
        gsap.set(allHeaderEls, { clearProps: 'all', opacity: 1 });
    }

    // Template switcher fade in
    const templateSwitcher = document.getElementById('template-switcher');
    if (templateSwitcher && typeof gsap !== 'undefined') {
        gsap.to(templateSwitcher, {
            opacity: 1,
            x: 0,
            duration: 0.5,
            delay: 0.6,
            ease: 'power2.out'
        });
    }

    // Subtle hover enhancement for image items
    const allImageItems = document.querySelectorAll('.gallery-link');
    allImageItems.forEach(item => {
        item.addEventListener('mouseenter', function() {
            if (typeof gsap !== 'undefined') {
                gsap.to(this, {
                    scale: 1.015,
                    duration: 0.3,
                    ease: 'power2.out'
                });
            }
        });
        item.addEventListener('mouseleave', function() {
            if (typeof gsap !== 'undefined') {
                gsap.to(this, {
                    scale: 1,
                    duration: 0.3,
                    ease: 'power2.out'
                });
            }
        });
    });
});

// Handle bfcache restoration
window.addEventListener('pageshow', function(event) {
    if (event.persisted) {
        const animatedElements = document.querySelectorAll('[data-gsap]');
        animatedElements.forEach(function(el) {
            el.style.opacity = '1';
            el.style.transform = 'none';
            el.setAttribute('data-animated', '1');
        });
        if (typeof gsap !== 'undefined') {
            gsap.set(animatedElements, { clearProps: 'all', opacity: 1 });
        }
    }
});
</script>
{% if template_custom_js is defined and template_custom_js %}
{{ template_custom_js|raw }}
{% endif %}
{% endblock %}
