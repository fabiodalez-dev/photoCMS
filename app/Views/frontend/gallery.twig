{% extends "frontend/_layout.twig" %}

{% import 'frontend/_seo_macros.twig' as Seo %}
{% import 'frontend/_caption.twig' as Caption %}

{% block content %}
<style nonce="{{ csp_nonce() }}">
/* Keep content visible; no intro hides to avoid flicker */
[data-gsap="categories"],
[data-gsap="title"],
[data-gsap="meta"],
[data-gsap="excerpt"],
[data-gsap="body"],
[data-gsap="equipment"] {
    opacity: 1;
    transform: none;
}
/* Equipment section title should use body font, not heading font */
[data-gsap="equipment"] h3 {
    font-family: var(--font-body), system-ui, sans-serif !important;
    font-weight: 500 !important;
}
</style>
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  {% include 'frontend/_breadcrumbs.twig' %}
  <div class="max-w-4xl mx-auto text-center pb-12">
    <div class="mt-4 mb-4 flex flex-wrap gap-2 justify-center" data-gsap="categories">
      {% if album.categories is defined and album.categories|length > 0 %}
        {% for cat in album.categories %}
        <a href="{{ base_path }}/category/{{ cat.slug }}" class="inline-flex items-center gap-2 text-xs font-medium px-2.5 py-1 rounded-full border border-neutral-300 bg-neutral-50 text-neutral-700 hover:bg-neutral-100 hover:text-black dark:border-neutral-600 dark:bg-neutral-800 dark:text-neutral-200 dark:hover:bg-neutral-700 transition-colors" title="{{ cat.name|e }}">
          <span class="w-1.5 h-1.5 rounded-full bg-neutral-700 dark:bg-neutral-300"></span>{{ cat.name|e }}
        </a>
        {% endfor %}
      {% endif %}
      {% if album.tags is defined and album.tags|length > 0 %}
        {% for tag in album.tags %}
        <a href="{{ base_path }}/tag/{{ tag.slug }}" class="inline-flex items-center gap-2 text-xs font-medium px-2.5 py-1 rounded-full border border-blue-300 bg-blue-50 text-blue-700 hover:bg-blue-100 hover:text-blue-800 dark:border-blue-600 dark:bg-blue-900/50 dark:text-blue-200 dark:hover:bg-blue-800/50 transition-colors" title="{{ tag.name|e }}">
          <span class="w-1.5 h-1.5 rounded-full bg-blue-700 dark:bg-blue-400"></span>{{ tag.name|e }}
        </a>
        {% endfor %}
      {% endif %}
    </div>
    <h1 class="text-3xl md:text-4xl font-light text-black mb-6" data-gsap="title">{{ album.title|e }}</h1>

    {# Album metadata: date and locations #}
    {% if album.shoot_date or album.equipment.locations|length > 0 %}
    <div class="flex items-center justify-center gap-6 text-sm text-neutral-600 mb-6" data-gsap="meta">
      {% if album.shoot_date and album.show_date == 1 %}
        <div class="flex items-center gap-2">
          <i class="fas fa-calendar-alt text-neutral-500"></i>
          <time datetime="{{ album.shoot_date }}">{{ album.shoot_date|date_format }}</time>
        </div>
      {% endif %}

      {% if album.equipment.locations|length > 0 %}
        <div class="flex items-center gap-2">
          <i class="fas fa-map-marker-alt text-neutral-500"></i>
          <span>{{ album.equipment.locations|join(', ') }}</span>
        </div>
      {% endif %}
    </div>
    {% endif %}

    <p class="text-lg text-neutral-600 leading-relaxed mb-6" data-gsap="excerpt">{{ album.excerpt|e }}</p>
  </div>

  {% if album.body %}
    <div class="max-w-3xl mx-auto prose prose-neutral mb-12" data-gsap="body">{{ album.body|safe_html }}</div>
  {% endif %}

  {# Social Sharing #}
  {% include 'frontend/_social_sharing.twig' %}

  {# Count custom fields that should show in gallery #}
  {% set custom_fields_for_gallery = [] %}
  {% if album_custom_fields is defined %}
    {% for typeId, field in album_custom_fields %}
      {% if field.show_in_gallery and field.values|length > 0 %}
        {% set custom_fields_for_gallery = custom_fields_for_gallery|merge([field]) %}
      {% endif %}
    {% endfor %}
  {% endif %}

  {% if album.equipment.cameras|length > 0 or album.equipment.lenses|length > 0 or album.equipment.film|length > 0 or album.equipment.developers|length > 0 or album.equipment.labs|length > 0 or custom_fields_for_gallery|length > 0 %}
  <div class="max-w-5xl mx-auto mb-8 p-6 bg-neutral-50 dark:bg-neutral-800 rounded-lg border border-transparent dark:border-neutral-700" data-gsap="equipment">
    <h3 class="text-sm font-medium mb-3 text-left">{{ trans('album.equipment') }}</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 xl:grid-cols-5 gap-2 text-xs text-neutral-600">
      {% if album.equipment.cameras is defined and album.equipment.cameras|length > 0 %}
      <div class="flex flex-col items-start text-left">
        <i class="fas fa-camera mb-1 text-neutral-500"></i>
        <div class="space-y-1">
          {% for camera in album.equipment.cameras %}<div>{{ camera }}</div>{% endfor %}
        </div>
      </div>
      {% endif %}
      {% if album.equipment.lenses is defined and album.equipment.lenses|length > 0 %}
      <div class="flex flex-col items-start text-left">
        <i class="fas fa-dot-circle mb-1 text-neutral-500"></i>
        <div class="space-y-1">
          {% for lens in album.equipment.lenses %}<div>{{ lens }}</div>{% endfor %}
        </div>
      </div>
      {% endif %}
      {% if album.equipment.film is defined and album.equipment.film|length > 0 %}
      <div class="flex flex-col items-start text-left">
        <i class="fas fa-film mb-1 text-neutral-500"></i>
        <div class="space-y-1">
          {% for film in album.equipment.film %}<div>{% if film.name is defined %}{{ film.name }}{% if film.iso or film.format %} ({% if film.iso %}ISO {{ film.iso }}{% endif %}{% if film.iso and film.format %} - {% endif %}{% if film.format %}{{ film.format }}{% endif %}){% endif %}{% else %}{{ film }}{% endif %}</div>{% endfor %}
        </div>
      </div>
      {% endif %}
      {% if album.equipment.developers is defined and album.equipment.developers|length > 0 %}
      <div class="flex flex-col items-start text-left">
        <i class="fas fa-flask mb-1 text-neutral-500"></i>
        <div class="space-y-1">
          {% for dev in album.equipment.developers %}<div>{{ dev }}</div>{% endfor %}
        </div>
      </div>
      {% endif %}
      {% if album.equipment.labs is defined and album.equipment.labs|length > 0 %}
      <div class="flex flex-col items-start text-left">
        <i class="fas fa-industry mb-1 text-neutral-500"></i>
        <div class="space-y-1">
          {% for lab in album.equipment.labs %}<div>{{ lab }}</div>{% endfor %}
        </div>
      </div>
      {% endif %}
      {# Custom fields #}
      {% for field in custom_fields_for_gallery %}
      <div class="flex flex-col items-start text-left">
        <i class="fas {{ field.icon|default('fa-tag') }} mb-1 text-neutral-500"></i>
        <div class="space-y-1">
          {% for valueData in field.values %}<div>{{ valueData.value|e }}</div>{% endfor %}
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  {# --- Template switcher: show ABOVE the gallery content --- #}
  {% if available_templates|length > 0 %}
  <div class="max-w-7xl mx-auto mb-2">
    <div class="flex justify-end">
      <div id="template-switcher" class="inline-flex items-center gap-1 bg-white/90 backdrop-blur-sm border border-neutral-200 rounded-md p-1 shadow-sm max-md:hidden">
        {% for template in available_templates %}
        <button type="button" class="tpl-switch px-2 py-1 rounded {{ template.id == current_template_id ? 'bg-black text-white' : 'text-neutral-700 hover:bg-neutral-100' }}" data-template-id="{{ template.id }}" data-album-ref="{{ album_ref }}" title="{{ template.name }}" aria-label="{{ template.name }}">
          {% set tpl_layout = template.settings.layout|default('grid') %}
          {% set tpl_slug = template.slug|default('') %}
  {% if tpl_layout == 'magazine' %}
    <i class="fas fa-newspaper"></i>
  {% elseif tpl_layout == 'dense_grid' %}
    <i class="fas fa-th-large"></i>
  {% elseif tpl_layout == 'masonry' or tpl_slug == 'masonry-full' %}
    <i class="fas fa-columns"></i>
  {% elseif tpl_slug == 'masonry-portfolio' %}
    <i class="fas fa-border-all"></i>
  {% elseif tpl_slug == 'grid-ampia' %}
    <i class="fas fa-puzzle-piece"></i>
  {% elseif tpl_slug == 'gallery-wall-scroll' %}
    <i class="fas fa-arrows-left-right"></i>
  {% elseif tpl_slug == 'grid-compatta' or (tpl_layout == 'grid' and template.settings.columns.desktop|default(3) >= 5) %}
    <i class="fas fa-grip-horizontal"></i>
  {% elseif tpl_layout == 'grid' and template.settings.columns.desktop|default(3) <= 2 %}
    <i class="fas fa-square"></i>
  {% else %}
    <i class="fas fa-th"></i>
  {% endif %}
        </button>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}

  {# Extract unified template settings #}
  {% set custom_template_twig = template_custom_twig|default('') %}
  {% set tpl_slug = template_settings.template_slug|default('') %}
  {% set layout = template_settings.layout|default('grid') %}
  {% set cols = template_settings.columns|default({desktop: 3, tablet: 2, mobile: 1}) %}
  {% set gap = template_settings.gap|default({horizontal: 16, vertical: 16}) %}
  {% set aspect_ratio = template_settings.aspect_ratio|default('1:1') %}
  {% set style = template_settings.style|default({rounded: false, shadow: false, hover_scale: true}) %}

  {# Normalize column values #}
  {% set desktop_cols = cols.desktop|default(3)|round %}
  {% set tablet_cols = cols.tablet|default(2)|round %}
  {% set mobile_cols = cols.mobile|default(1)|round %}
  {% set gap_h = gap.horizontal|default(16)|round %}
  {% set gap_v = gap.vertical|default(16)|round %}

  {# Aspect ratio class for grid layout #}
  {% set aspect_class = 'aspect-square' %}
  {% if aspect_ratio == '4:3' %}
      {% set aspect_class = 'aspect-[4/3]' %}
  {% elseif aspect_ratio == '16:9' %}
      {% set aspect_class = 'aspect-video' %}
  {% elseif aspect_ratio == '3:2' %}
      {% set aspect_class = 'aspect-[3/2]' %}
  {% endif %}

  {# Style classes #}
  {% set rounded_class = style.rounded ? 'rounded-lg' : '' %}
  {% set shadow_class = style.shadow ? 'shadow-md hover:shadow-xl' : '' %}
  {% set hover_class = style.hover_scale ? 'group-hover:scale-105' : '' %}

  {# Custom gallery template (uploaded) #}
  {% if custom_template_twig %}
      <div id="images-gallery" class="pswp-gallery" data-layout="custom">
          {% include custom_template_twig %}
      </div>

  {# Creative Layout (template 6) #}
  {% elseif tpl_slug == 'grid-ampia' %}
      {% include 'frontend/_gallery_creative_layout.twig' with { images: images, template_settings: template_settings, album: album, base_path: base_path, site_title: site_title } %}

  {# Gallery Wall Scroll layout #}
  {% elseif tpl_slug == 'gallery-wall-scroll' %}
      {% include 'frontend/_gallery_wall_scroll.twig' with { images: images, template_settings: template_settings, album: album, base_path: base_path, site_title: site_title } %}

  {# Masonry Portfolio layout (template 2) - dedicated Masonry setup #}
  {% elseif tpl_slug == 'masonry-portfolio' %}
      {% include 'frontend/_gallery_masonry_portfolio.twig' with { images: images, template_settings: template_settings, album: album, base_path: base_path, site_title: site_title } %}

  {# Magazine layout - special handling, NOT unified #}
  {% elseif layout == 'magazine' %}
      <div id="images-gallery" class="mt-6" data-layout="magazine" data-hover-fade="{{ style.hover_fade is not defined or style.hover_fade ? '1' : '0' }}">
          {% include 'frontend/_gallery_magazine_content.twig' with { images: images, template_settings: template_settings, album: album } %}
      </div>

  {# Dense Grid layout - CSS Grid with auto-flow dense (fills gaps automatically) #}
  {% elseif layout == 'dense_grid' %}
      {% set dense = template_settings.dense_grid|default({}) %}
      {% set minDesktop = dense.minCellDesktop|default(250) %}
      {% set minTablet = dense.minCellTablet|default(150) %}
      {% set rowHeight = dense.rowHeight|default(250) %}
      {% set rowHeightTablet = dense.rowHeightTablet|default(180) %}
      {% set rowHeightMobile = dense.rowHeightMobile|default(300) %}
      {% set gridGap = dense.gap|default(8) %}
      {% set maxWidth = dense.maxWidth|default(1600) %}
      {% set adaptive = dense.adaptiveSizing|default(true) %}

      <style nonce="{{ csp_nonce() }}">
      /* Dense Grid Layout - CSS Grid with auto-flow dense */
      .dense-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax({{ minDesktop }}px, 1fr));
          grid-auto-rows: {{ rowHeight }}px;
          gap: {{ gridGap }}px;
          grid-auto-flow: dense;
          max-width: {{ maxWidth }}px;
          margin: 0 auto;
          padding: 0 {{ gridGap }}px;
          /* Establish stacking context to contain hover z-index */
          position: relative;
          z-index: 1;
          isolation: isolate;
      }
      .dense-grid-item {
          position: relative;
          overflow: hidden;
          background: #f5f5f5;
          cursor: pointer;
          transition: transform 0.3s ease, box-shadow 0.3s ease;
          z-index: 1;
      }
      .dense-grid-item:hover {
          transform: scale(1.02);
          box-shadow: 0 10px 30px rgba(0,0,0,0.15);
          z-index: 2;
      }
      .dense-grid-link {
          display: block;
          width: 100%;
          height: 100%;
      }
      .dense-grid-img {
          width: 100%;
          height: 100%;
          object-fit: cover;
          display: block;
          transition: opacity 0.3s ease;
      }
      /* Adaptive sizing classes - images span based on aspect ratio */
      .dense-grid-item.landscape {
          grid-column: span 2;
      }
      .dense-grid-item.portrait-tall {
          grid-row: span 2;
      }
      .dense-grid-item.square-large {
          grid-column: span 2;
          grid-row: span 2;
      }
      /* Tablet responsive */
      @media (max-width: 1023px) {
          .dense-grid {
              grid-template-columns: repeat(auto-fill, minmax({{ minTablet }}px, 1fr));
              grid-auto-rows: {{ rowHeightTablet }}px;
              gap: 6px;
              padding: 0 6px;
          }
      }
      /* Mobile - single/double column, no adaptive spans */
      @media (max-width: 640px) {
          .dense-grid {
              grid-template-columns: repeat(2, 1fr);
              grid-auto-rows: {{ rowHeightMobile }}px;
              gap: 4px;
              padding: 0 4px;
          }
          .dense-grid-item.landscape,
          .dense-grid-item.portrait-tall,
          .dense-grid-item.square-large {
              grid-column: span 1;
              grid-row: span 1;
          }
          .dense-grid-item:hover {
              transform: none;
              box-shadow: none;
          }
      }
      </style>

      <div id="images-gallery" class="dense-grid pswp-gallery" data-layout="dense_grid" data-adaptive="{{ adaptive ? 'true' : 'false' }}" data-hover-fade="{{ style.hover_fade is not defined or style.hover_fade ? '1' : '0' }}">
          {% for image in images %}
          <div class="dense-grid-item" data-image-id="{{ image.id }}" data-width="{{ image.width|default(0) }}" data-height="{{ image.height|default(0) }}">
              {% set lightbox_href = image.lightbox_url|default(image.original_path) %}
              {% set seo_title = Seo.seo_title(image, album, site_title)|trim %}
              <a href="{% if lightbox_href starts with '/' %}{{ base_path }}{{ lightbox_href }}{% else %}{{ lightbox_href }}{% endif %}"
                 class="pswp-link dense-grid-link"
                 title="{{ seo_title|e('html_attr') }}"
                 data-image-id="{{ image.id }}"
                 data-pswp-width="{{ image.width }}"
                 data-pswp-height="{{ image.height }}"
                 data-pswp-caption="{{ Caption.build(image)|e('html_attr') }}"
                 data-title="{{ image.caption|default('')|e }}"
                 data-alt="{{ image.alt_text|default(image.alt)|default('')|e }}"
                 data-camera="{{ image.custom_camera|default(image.camera_name)|default('')|e }}"
                 data-lens="{{ image.custom_lens|default(image.lens_name)|default('')|e }}"
                 data-film="{{ image.custom_film|default(image.film_name)|default('')|e }}"
                 data-developer="{{ image.developer_name|default('')|e }}"
                 data-lab="{{ image.lab_name|default('')|e }}"
                 data-location="{{ image.location_name|default('')|e }}"
                 data-iso="{{ image.iso|default('') }}"
                 data-shutter="{{ image.shutter_speed|default('')|e }}"
                 data-aperture="{{ image.aperture|default('') }}"
                 data-focal-length="{{ image.focal_length|default('') }}"
                 {% if image.custom_fields is defined and image.custom_fields|length > 0 %}data-custom-fields="{{ image.custom_fields|json_encode|e('html_attr') }}"{% endif %}>
                  <picture>
                      {% set variants_avif = [] %}
                      {% set variants_webp = [] %}
                      {% set variants_jpg = [] %}
                      {% set best_jpg_path = image.original_path starts with '/' ? base_path ~ image.original_path : image.original_path %}
                      {% set best_jpg_w = 0 %}
                      {% for variant in image.variants %}
                          {% set variant_url = variant.path starts with '/' ? base_path ~ variant.path : variant.path %}
                          {% if variant.format == 'avif' %}
                              {% set variants_avif = variants_avif|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
                          {% elseif variant.format == 'webp' %}
                              {% set variants_webp = variants_webp|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
                          {% elseif variant.format == 'jpg' %}
                              {% set variants_jpg = variants_jpg|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
                              {% if variant.width > best_jpg_w %}
                                  {% set best_jpg_path = variant_url %}
                                  {% set best_jpg_w = variant.width %}
                              {% endif %}
                          {% endif %}
                      {% endfor %}

                      {% if variants_avif %}
                          <source type="image/avif" srcset="{{ variants_avif|join(', ') }}" sizes="(min-width: 1200px) 33vw, (min-width: 768px) 50vw, 100vw">
                      {% endif %}
                      {% if variants_webp %}
                          <source type="image/webp" srcset="{{ variants_webp|join(', ') }}" sizes="(min-width: 1200px) 33vw, (min-width: 768px) 50vw, 100vw">
                      {% endif %}

                      <img src="{{ best_jpg_path }}"
                           alt="{{ image.alt_text|default(image.alt)|default('')|e }}"
                           title="{{ seo_title|e('html_attr') }}"
                           class="dense-grid-img"
                           loading="lazy"
                           decoding="async"
                           data-fallback="hide">
                  </picture>
              </a>
          </div>
          {% endfor %}
      </div>

  {# Masonry layout - uses @masonry-grid/vanilla for Pinterest-style waterfall #}
  {% elseif layout == 'masonry' %}
      <style nonce="{{ csp_nonce() }}">
      /* Modern Masonry Grid using @masonry-grid/vanilla */
      /* The library uses translateY(%) for positioning - margin doesn't work! */
      /* Gaps are created via inset on the inner container per library docs */
      .gallery-masonry {
          --masonry-gap-v: {{ gap_v }}px;
          --masonry-gap-h: {{ gap_h }}px;
          display: grid;
          column-gap: var(--masonry-gap-h);
          grid-template-columns: repeat({{ mobile_cols }}, 1fr);
          align-items: start; /* Required: items need natural height for masonry transforms */
          width: 100%;
          max-width: 100%;
          opacity: 0;
          transition: opacity 0.3s ease-in-out;
      }
      .gallery-masonry.masonry-ready {
          opacity: 1;
      }
      .gallery-masonry.gsap-failed {
          opacity: 1;
      }
      @media (min-width: 768px) {
          .gallery-masonry {
              grid-template-columns: repeat({{ tablet_cols }}, 1fr);
          }
      }
      @media (min-width: 1024px) {
          .gallery-masonry {
              grid-template-columns: repeat({{ desktop_cols }}, 1fr);
          }
      }
      /* Frame: NO overflow:hidden per library docs (breaks aspect-ratio calc) */
      .gallery-masonry .masonry-frame {
          position: relative;
          aspect-ratio: var(--width) / var(--height);
          min-width: 0; /* Prevent grid blowout */
          /* No margin-bottom - translateY% ignores margins */
      }
      /* Inner container uses inset to create vertical gaps */
      /* Each item has gap/2 on top and bottom = gap between items */
      .gallery-masonry .masonry-frame > .frame-content {
          position: absolute;
          inset: calc(var(--masonry-gap-v) / 2) 0;
          overflow: hidden;
      }
      .gallery-masonry .masonry-frame img {
          display: block;
          width: 100%;
          height: 100%;
          object-fit: cover;
          transition: transform 0.3s ease;
      }
      .gallery-masonry .masonry-frame:hover img {
          transform: scale(1.03);
      }
      .no-js .gallery-masonry {
          opacity: 1 !important;
      }
      @media (prefers-reduced-motion: reduce) {
          .gallery-masonry { opacity: 1 !important; transition: none !important; }
          .gallery-masonry .masonry-frame img { transition: none !important; }
      }
      </style>

      <div id="images-gallery"
           class="gallery-masonry pswp-gallery"
           data-layout="masonry"
           data-gap-h="{{ gap_h }}"
           data-gap-v="{{ gap_v }}"
           data-cols-desktop="{{ desktop_cols }}"
           data-cols-tablet="{{ tablet_cols }}"
           data-cols-mobile="{{ mobile_cols }}"
           data-rounded="{{ style.rounded ? '1' : '0' }}"
           data-shadow="{{ style.shadow ? '1' : '0' }}"
           data-hover-fade="{{ style.hover_fade is not defined or style.hover_fade ? '1' : '0' }}">
          {% for image in images %}
              {# Calculate aspect ratio for CSS variable #}
              {% set imgW = image.width|default(4) %}
              {% set imgH = image.height|default(3) %}
              <div class="masonry-frame" style="--width: {{ imgW }}; --height: {{ imgH }};">
                  <div class="frame-content group {{ rounded_class }} {{ shadow_class }}">
                      {% set lightbox_href = image.lightbox_url|default(image.original_path) %}
                      {% set seo_title = Seo.seo_title(image, album, site_title)|trim %}
                      <a href="{% if lightbox_href starts with '/' %}{{ base_path }}{{ lightbox_href }}{% else %}{{ lightbox_href }}{% endif %}"
                         class="pswp-link gallery-link block w-full h-full overflow-hidden bg-neutral-100 cursor-pointer {{ rounded_class }}"
                         title="{{ seo_title|e('html_attr') }}"
                         data-image-id="{{ image.id }}"
                         data-pswp-width="{{ image.width }}"
                         data-pswp-height="{{ image.height }}"
                         data-pswp-caption="{{ Caption.build(image)|e('html_attr') }}"
                         data-title="{{ image.caption|default('')|e }}"
                         data-alt="{{ image.alt_text|default(image.alt)|default('')|e }}"
                         data-camera="{{ image.custom_camera|default(image.camera_name)|default('')|e }}"
                         data-lens="{{ image.custom_lens|default(image.lens_name)|default('')|e }}"
                         data-film="{{ image.custom_film|default(image.film_name)|default('')|e }}"
                         data-developer="{{ image.developer_name|default('')|e }}"
                         data-lab="{{ image.lab_name|default('')|e }}"
                         data-location="{{ image.location_name|default('')|e }}"
                         data-iso="{{ image.iso|default('') }}"
                         data-shutter="{{ image.shutter_speed|default('')|e }}"
                         data-aperture="{{ image.aperture|default('') }}"
                         data-focal-length="{{ image.focal_length|default('') }}"
                         {% if image.custom_fields is defined and image.custom_fields|length > 0 %}data-custom-fields="{{ image.custom_fields|json_encode|e('html_attr') }}"{% endif %}>
                          <picture>
                              {% set variants_avif = [] %}
                              {% set variants_webp = [] %}
                              {% set variants_jpg = [] %}
                              {% set best_jpg_path = image.original_path starts with '/' ? base_path ~ image.original_path : image.original_path %}
                              {% set best_jpg_w = 0 %}
                              {% for variant in image.variants %}
                                  {% set variant_url = variant.path starts with '/' ? base_path ~ variant.path : variant.path %}
                                  {% if variant.format == 'avif' %}
                                      {% set variants_avif = variants_avif|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
                                  {% elseif variant.format == 'webp' %}
                                      {% set variants_webp = variants_webp|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
                                  {% elseif variant.format == 'jpg' %}
                                      {% set variants_jpg = variants_jpg|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
                                      {% if variant.width > best_jpg_w %}
                                          {% set best_jpg_path = variant_url %}
                                          {% set best_jpg_w = variant.width %}
                                      {% endif %}
                                  {% endif %}
                              {% endfor %}

                              {% if variants_avif %}
                                  <source type="image/avif" srcset="{{ variants_avif|join(', ') }}" sizes="(min-width: 1200px) 33vw, (min-width: 768px) 50vw, 100vw">
                              {% endif %}
                              {% if variants_webp %}
                                  <source type="image/webp" srcset="{{ variants_webp|join(', ') }}" sizes="(min-width: 1200px) 33vw, (min-width: 768px) 50vw, 100vw">
                              {% endif %}

                              <img src="{{ best_jpg_path }}"
                                   alt="{{ image.alt_text|default(image.alt)|default('')|e }}"
                                   title="{{ seo_title|e('html_attr') }}"
                                   loading="lazy"
                                   decoding="async"
                                   data-fallback="hide">
                          </picture>
                          {% if album.allow_downloads %}
                              <button type="button"
                                      class="absolute top-3 right-3 bg-black/60 text-white p-2.5 opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-10 cursor-pointer {{ rounded_class }}"
                                      title="{{ trans('image.download') }}"
                                      data-action="download-image"
                                      data-download-url="{{ base_path }}/download/image/{{ image.id }}">
                                  <i class="fa-solid fa-arrow-down text-sm"></i>
                              </button>
                          {% endif %}
                          {% if image.caption %}
                              <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent text-white text-sm p-4 pt-8 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                  {{ image.caption|e }}
                              </div>
                          {% endif %}
                      </a>
                  </div>
              </div>
          {% endfor %}
      </div>

  {# Grid layout - CSS Grid with fixed aspect ratios #}
  {% else %}
      <style nonce="{{ csp_nonce() }}">
      .gallery-grid {
          display: grid;
          gap: {{ gap_v }}px {{ gap_h }}px;
      }
      @media (min-width: 1024px) {
          .gallery-grid { grid-template-columns: repeat({{ desktop_cols }}, 1fr); }
      }
      @media (min-width: 768px) and (max-width: 1023px) {
          .gallery-grid { grid-template-columns: repeat({{ tablet_cols }}, 1fr); }
      }
      @media (max-width: 767px) {
          .gallery-grid { grid-template-columns: repeat({{ mobile_cols }}, 1fr); }
      }
      </style>

      <div id="images-gallery"
           class="gallery-grid pswp-gallery"
           data-layout="grid"
           data-gap-h="{{ gap_h }}"
           data-gap-v="{{ gap_v }}"
           data-cols-desktop="{{ desktop_cols }}"
           data-cols-tablet="{{ tablet_cols }}"
           data-cols-mobile="{{ mobile_cols }}"
           data-aspect-ratio="{{ aspect_ratio }}"
           data-hover-fade="{{ style.hover_fade is not defined or style.hover_fade ? '1' : '0' }}">
          {% for image in images %}
              <div class="gallery-item">
                  {% set lightbox_href = image.lightbox_url|default(image.original_path) %}
                  {% set seo_title = Seo.seo_title(image, album, site_title)|trim %}
                  <a href="{% if lightbox_href starts with '/' %}{{ base_path }}{{ lightbox_href }}{% else %}{{ lightbox_href }}{% endif %}"
                     class="pswp-link gallery-link group block overflow-hidden bg-neutral-100 cursor-pointer {{ aspect_class }} {{ rounded_class }} {{ shadow_class }}"
                     title="{{ seo_title|e('html_attr') }}"
                     data-image-id="{{ image.id }}"
                     data-pswp-width="{{ image.width }}"
                     data-pswp-height="{{ image.height }}"
                     data-pswp-caption="{{ Caption.build(image)|e('html_attr') }}"
                     data-title="{{ image.caption|default('')|e }}"
                     data-alt="{{ image.alt_text|default(image.alt)|default('')|e }}"
                     data-camera="{{ image.custom_camera|default(image.camera_name)|default('')|e }}"
                     data-lens="{{ image.custom_lens|default(image.lens_name)|default('')|e }}"
                     data-film="{{ image.custom_film|default(image.film_name)|default('')|e }}"
                     data-developer="{{ image.developer_name|default('')|e }}"
                     data-lab="{{ image.lab_name|default('')|e }}"
                     data-location="{{ image.location_name|default('')|e }}"
                     data-iso="{{ image.iso|default('') }}"
                     data-shutter="{{ image.shutter_speed|default('')|e }}"
                     data-aperture="{{ image.aperture|default('') }}"
                     data-focal-length="{{ image.focal_length|default('') }}"
                     {% if image.custom_fields is defined and image.custom_fields|length > 0 %}data-custom-fields="{{ image.custom_fields|json_encode|e('html_attr') }}"{% endif %}>
                      <picture>
                          {% set variants_avif = [] %}
                          {% set variants_webp = [] %}
                          {% set variants_jpg = [] %}
                          {% set best_jpg_path = image.original_path starts with '/' ? base_path ~ image.original_path : image.original_path %}
                          {% set best_jpg_w = 0 %}
                          {% for variant in image.variants %}
                              {% set variant_url = variant.path starts with '/' ? base_path ~ variant.path : variant.path %}
                              {% if variant.format == 'avif' %}
                                  {% set variants_avif = variants_avif|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
                              {% elseif variant.format == 'webp' %}
                                  {% set variants_webp = variants_webp|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
                              {% elseif variant.format == 'jpg' %}
                                  {% set variants_jpg = variants_jpg|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
                                  {% if variant.width > best_jpg_w %}
                                      {% set best_jpg_path = variant_url %}
                                      {% set best_jpg_w = variant.width %}
                                  {% endif %}
                              {% endif %}
                          {% endfor %}

                          {% if variants_avif %}
                              <source type="image/avif" srcset="{{ variants_avif|join(', ') }}" sizes="(min-width: 1200px) 33vw, (min-width: 768px) 50vw, 100vw">
                          {% endif %}
                          {% if variants_webp %}
                              <source type="image/webp" srcset="{{ variants_webp|join(', ') }}" sizes="(min-width: 1200px) 33vw, (min-width: 768px) 50vw, 100vw">
                          {% endif %}

                          <img src="{{ best_jpg_path }}"
                               alt="{{ image.alt_text|default(image.alt)|default('')|e }}"
                               title="{{ seo_title|e('html_attr') }}"
                               width="{{ image.width }}"
                               height="{{ image.height }}"
                               loading="lazy"
                               decoding="async"
                               data-fallback="hide"
                               class="w-full h-full object-cover transition-transform duration-300 {{ hover_class }}">
                      </picture>
                      {% if album.allow_downloads %}
                          <button type="button"
                                  class="absolute top-3 right-3 bg-black/60 text-white p-2.5 opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-10 cursor-pointer {{ rounded_class }}"
                                  title="{{ trans('image.download') }}"
                                  data-action="download-image"
                                  data-download-url="{{ base_path }}/download/image/{{ image.id }}">
                              <i class="fa-solid fa-arrow-down text-sm"></i>
                          </button>
                      {% endif %}
                      {% if image.caption %}
                          <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent text-white text-sm p-4 pt-8 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                              {{ image.caption|e }}
                          </div>
                      {% endif %}
                  </a>
              </div>
          {% endfor %}
      </div>
  {% endif %}

{% if images|length == 0 %}
  <div class="text-center py-20">
      <h2 class="text-2xl font-light text-neutral-600 mb-4">{{ trans('album.empty') }}</h2>
      <p class="text-neutral-500">{{ trans('album.empty_message') }}</p>
  </div>
  {% endif %}

</div>
{% endblock %}

{% block styles %}
{{ parent() }}
{% endblock %}

{% block scripts %}
{% include 'frontend/_gallery_runtime.twig' %}
{% endblock %}
