{% extends "frontend/_layout.twig" %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="max-w-4xl mx-auto text-center pb-12">
    <div class="mb-4 flex flex-wrap gap-2 justify-center">
      {% if album.categories is defined and album.categories|length > 0 %}
        {% for cat in album.categories %}
        <a href="/category/{{ cat.slug }}" class="inline-flex items-center gap-2 text-xs font-medium px-2.5 py-1 rounded-full border border-neutral-300 bg-neutral-50 text-neutral-700 hover:bg-neutral-100 hover:text-black transition-colors" title="{{ cat.name|e }}">
          <span class="w-1.5 h-1.5 rounded-full bg-neutral-700"></span>{{ cat.name|e }}
        </a>
        {% endfor %}
      {% endif %}
      {% if album.tags is defined and album.tags|length > 0 %}
        {% for tag in album.tags %}
        <span class="inline-flex items-center gap-2 text-xs font-medium px-2.5 py-1 rounded-full border border-blue-300 bg-blue-50 text-blue-700" title="{{ tag.name|e }}">
          <span class="w-1.5 h-1.5 rounded-full bg-blue-700"></span>{{ tag.name|e }}
        </span>
        {% endfor %}
      {% endif %}
    </div>
    <h1 class="text-3xl md:text-4xl font-light text-black mb-6">{{ album.title|e }}</h1>
    <p class="text-lg text-neutral-600 leading-relaxed mb-6">{{ album.excerpt|e }}</p>
  </div>

  <div class="max-w-3xl mx-auto prose prose-neutral mb-12">{{ album.body|raw }}</div>

  <div class="max-w-5xl mx-auto mb-8 p-4 bg-neutral-50 rounded-lg">
    <h3 class="text-sm font-medium mb-3 text-center">Equipment</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 text-xs text-neutral-600">
      <div><div class="font-medium mb-1 flex items-center gap-2"><i class="fas fa-camera"></i> Cameras</div>
        <div class="space-y-1">{% for camera in album.equipment.cameras %}<div>{{ camera }}</div>{% else %}<div class="text-neutral-400">—</div>{% endfor %}</div>
      </div>
      <div><div class="font-medium mb-1 flex items-center gap-2"><i class="fas fa-dot-circle"></i> Lenses</div>
        <div class="space-y-1">{% for lens in album.equipment.lenses %}<div>{{ lens }}</div>{% else %}<div class="text-neutral-400">—</div>{% endfor %}</div>
      </div>
      <div><div class="font-medium mb-1 flex items-center gap-2"><i class="fas fa-film"></i> Film</div>
        <div class="space-y-1">{% for film in album.equipment.film %}<div>{{ film }}</div>{% else %}<div class="text-neutral-400">—</div>{% endfor %}</div>
      </div>
      <div><div class="font-medium mb-1 flex items-center gap-2"><i class="fas fa-flask"></i> Developers</div>
        <div class="space-y-1">{% for dev in album.equipment.developers %}<div>{{ dev }}</div>{% else %}<div class="text-neutral-400">—</div>{% endfor %}</div>
      </div>
      <div><div class="font-medium mb-1 flex items-center gap-2"><i class="fas fa-industry"></i> Labs</div>
        <div class="space-y-1">{% for lab in album.equipment.labs %}<div>{{ lab }}</div>{% else %}<div class="text-neutral-400">—</div>{% endfor %}</div>
      </div>
    </div>
  </div>

  {% set layout = template_settings.layout|default('grid') %}
  {% set masonry = template_settings.masonry|default(false) %}
  
  {# Handle potentially nested columns structure #}
  {% set cols = template_settings.columns is defined ? template_settings.columns : {'desktop': 3, 'tablet': 2, 'mobile': 1} %}
  
  {# Extract desktop columns - handle nested structure #}
  {% if cols.desktop is iterable and cols.desktop.desktop is defined %}
    {% set desktop_cols = cols.desktop.desktop %}
  {% elseif cols.desktop is defined %}
    {% set desktop_cols = cols.desktop %}
  {% else %}
    {% set desktop_cols = 3 %}
  {% endif %}
  
  {# Extract tablet columns - handle nested structure #}
  {% if cols.tablet is iterable and cols.tablet.tablet is defined %}
    {% set tablet_cols = cols.tablet.tablet %}
  {% elseif cols.tablet is defined %}
    {% set tablet_cols = cols.tablet %}
  {% else %}
    {% set tablet_cols = 2 %}
  {% endif %}
  
  {# Extract mobile columns - handle nested structure #}
  {% if cols.mobile is iterable and cols.mobile.mobile is defined %}
    {% set mobile_cols = cols.mobile.mobile %}
  {% elseif cols.mobile is defined %}
    {% set mobile_cols = cols.mobile %}
  {% else %}
    {% set mobile_cols = 1 %}
  {% endif %}
  
  {# Ensure values are numbers #}
  {% set desktop_cols = desktop_cols|round %}
  {% set tablet_cols = tablet_cols|round %}
  {% set mobile_cols = mobile_cols|round %}
  

  {% if available_templates|length > 0 %}
  <div class="max-w-7xl mx-auto mb-2">
    <div class="flex justify-end">
      <div class="inline-flex items-center gap-1 bg-white/90 backdrop-blur-sm border border-neutral-200 rounded-md p-1 shadow-sm">
        {% for template in available_templates %}
        <a class="tpl-switch px-2 py-1 rounded {{ template.id == current_template_id ? 'bg-black text-white' : 'text-neutral-700 hover:bg-neutral-100' }}" href="/gallery?template={{ template.id }}{% if album_ref %}&album={{ album_ref }}{% endif %}" title="{{ template.name }}" data-tooltip="{{ template.name }}{% if template.settings and template.settings.columns %} — {{ template.settings.layout|default('grid') }}, {{ template.settings.columns.mobile|default(1) }}/{{ template.settings.columns.tablet|default(2) }}/{{ template.settings.columns.desktop|default(3) }}{% endif %}" data-settings="{{ template.settings|json_encode|e('html_attr') }}" data-template-id="{{ template.id }}">
          {% if template.slug is defined %}
            {# Prefer slug-based icon mapping if available. Match by containment to handle slugs like `gallery-fullscreen` #}
            {% set slug = template.slug|lower %}
            {% if 'fullscreen' in slug %}
              <i class="fas fa-expand"></i>
            {% elseif 'grid-wide' in slug or 'wide' in slug or (template.settings.layout == 'grid' and template.settings.columns.desktop|default(3) <= 2) %}
              <i class="fas fa-pause"></i>
            {% elseif 'grid-compact' in slug or 'compact' in slug or (template.settings.layout == 'grid' and template.settings.columns.desktop|default(3) >= 5) %}
              <i class="fas fa-border-all"></i>
            {% elseif 'masonry' in slug or template.settings.masonry %}
              <i class="fas fa-th-large"></i>
            {% elseif 'slideshow' in slug or template.settings.layout == 'slideshow' %}
              <i class="fas fa-images"></i>
            {% else %}
              <i class="fas fa-th"></i>
            {% endif %}
          {% elseif template.name is defined %}
            {% set name = template.name|lower %}
            {% if 'fullscreen' in name %}
              <i class="fas fa-expand"></i>
            {% elseif 'masonry' in name %}
              <i class="fas fa-th-large"></i>
            {% elseif 'slideshow' in name %}
              <i class="fas fa-images"></i>
            {% elseif 'compact' in name %}
              <i class="fas fa-border-all"></i>
            {% elseif 'wide' in name or 'ampia' in name %}
              <i class="fas fa-pause"></i>
            {% else %}
              <i class="fas fa-th"></i>
            {% endif %}
          {% elseif template.settings.layout == 'grid' %}
            {% if template.settings.masonry %}
              <i class="fas fa-th-large"></i>
            {% else %}
              {% set tpl_desktop_cols = template.settings.columns.desktop|default(3) %}
              {% if tpl_desktop_cols <= 2 %}
                <i class="fas fa-pause"></i>
              {% elseif tpl_desktop_cols == 3 %}
                <i class="fas fa-th"></i>
              {% elseif tpl_desktop_cols == 4 %}
                <i class="fas fa-th"></i>
              {% else %}
                <i class="fas fa-border-all"></i>
              {% endif %}
            {% endif %}
          {% elseif template.settings.layout == 'slideshow' %}
            <i class="fas fa-images"></i>
          {% elseif template.settings.layout == 'fullscreen' %}
            <i class="fas fa-expand"></i>
          {% elseif template.settings.layout == 'masonry' %}
            <i class="fas fa-th-large"></i>
          {% else %}
            <i class="fas fa-th"></i>
          {% endif %}
        </a>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}

  {% if layout == 'slideshow' %}
    <div id="images-gallery" class="max-w-4xl mx-auto">
      <div class="swiper gallery-swiper">
        <div class="swiper-wrapper">
          {% for image in images %}
          <div class="swiper-slide">
            <div class="image-item aspect-[4/3] bg-neutral-100 rounded-lg overflow-hidden shadow-sm hover:shadow-lg transition-shadow cursor-pointer" data-image-id="{{ image.id }}">
              <img src="{{ image.url }}" alt="{{ image.alt|default('Image')|e }}" class="w-full h-full object-cover">
              <script type="application/json" class="image-data">{{ image|json_encode|raw }}</script>
            </div>
          </div>
          {% endfor %}
        </div>
        <div class="swiper-button-next"></div>
        <div class="swiper-button-prev"></div>
        <div class="swiper-pagination"></div>
      </div>
    </div>
  {% elseif layout == 'fullscreen' %}
    <div id="images-gallery" class="grid grid-cols-1 lg:grid-cols-2 gap-2">
      {% for image in images %}
      <div class="masonry-item">
        <div class="image-item aspect-[4/3] bg-neutral-100 rounded-lg overflow-hidden shadow-sm hover:shadow-lg transition-shadow cursor-pointer group relative" data-image-id="{{ image.id }}">
          <img src="{{ image.url }}" alt="{{ image.alt|e }}" class="w-full h-full object-cover">
          <script type="application/json" class="image-data">{{ image|json_encode|raw }}</script>
        </div>
      </div>
      {% endfor %}
    </div>
  {% elseif masonry %}
    <div id="images-gallery" class="masonry-grid">
      {% for image in images %}
      <div class="masonry-item">
        <div class="image-item bg-neutral-100 rounded-lg overflow-hidden shadow-sm hover:shadow-lg transition-shadow cursor-pointer mb-4 group relative" data-image-id="{{ image.id }}">
          <img src="{{ image.url }}" alt="{{ image.alt|e }}" class="w-full h-auto object-cover">
          <script type="application/json" class="image-data">{{ image|json_encode|raw }}</script>
        </div>
      </div>
      {% endfor %}
    </div>
  {% else %}
    {% if mobile_cols == 1 %}{% set mobile_class = 'grid-cols-1' %}
    {% elseif mobile_cols == 2 %}{% set mobile_class = 'grid-cols-2' %}
    {% elseif mobile_cols == 3 %}{% set mobile_class = 'grid-cols-3' %}
    {% elseif mobile_cols == 4 %}{% set mobile_class = 'grid-cols-4' %}
    {% elseif mobile_cols == 5 %}{% set mobile_class = 'grid-cols-5' %}
    {% else %}{% set mobile_class = 'grid-cols-6' %}{% endif %}
    
    {% if tablet_cols == 1 %}{% set tablet_class = 'md:grid-cols-1' %}
    {% elseif tablet_cols == 2 %}{% set tablet_class = 'md:grid-cols-2' %}
    {% elseif tablet_cols == 3 %}{% set tablet_class = 'md:grid-cols-3' %}
    {% elseif tablet_cols == 4 %}{% set tablet_class = 'md:grid-cols-4' %}
    {% elseif tablet_cols == 5 %}{% set tablet_class = 'md:grid-cols-5' %}
    {% else %}{% set tablet_class = 'md:grid-cols-6' %}{% endif %}
    
    {% if desktop_cols == 1 %}{% set desktop_class = 'lg:grid-cols-1' %}
    {% elseif desktop_cols == 2 %}{% set desktop_class = 'lg:grid-cols-2' %}
    {% elseif desktop_cols == 3 %}{% set desktop_class = 'lg:grid-cols-3' %}
    {% elseif desktop_cols == 4 %}{% set desktop_class = 'lg:grid-cols-4' %}
    {% elseif desktop_cols == 5 %}{% set desktop_class = 'lg:grid-cols-5' %}
    {% else %}{% set desktop_class = 'lg:grid-cols-6' %}{% endif %}
    <div id="images-gallery" class="grid {{ mobile_class }} {{ tablet_class }} {{ desktop_class }} gap-4">
      {% for image in images %}
      <div class="masonry-item">
        <div class="image-item aspect-[4/3] bg-neutral-100 rounded-lg overflow-hidden shadow-sm hover:shadow-lg transition-shadow cursor-pointer group relative" data-image-id="{{ image.id }}">
          <img src="{{ image.url }}" alt="{{ image.alt|e }}" class="w-full h-full object-cover">
          <script type="application/json" class="image-data">{{ image|json_encode|raw }}</script>
        </div>
      </div>
      {% endfor %}
    </div>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
// Store template settings globally for AJAX reloads
window.templateSettings = {{ template_settings ? template_settings|json_encode|raw : '{}' }};

const layout = window.templateSettings.layout || 'grid';
const masonry = window.templateSettings.masonry || false;

if (layout === 'slideshow' && typeof Swiper !== 'undefined') {
  window.gallerySwiper = new Swiper('.gallery-swiper', { 
    navigation:{nextEl:'.swiper-button-next', prevEl:'.swiper-button-prev'}, 
    pagination:{el:'.swiper-pagination', clickable:true}, 
    loop:true, 
    autoplay:{delay:5000, disableOnInteraction:false}, 
    effect:'fade', 
    fadeEffect:{crossFade:true} 
  });
}
// Initialize Masonry only when required, otherwise ensure cleanup
(function(){
  const container = document.getElementById('images-gallery');
  if (!container) return;
  if (masonry && typeof Masonry !== 'undefined') {
    imagesLoaded(container, function(){ 
      window.galleryMasonry = new Masonry(container, { itemSelector: '.masonry-item', percentPosition: true }); 
    });
  } else {
    if (window.galleryMasonry) {
      try { window.galleryMasonry.destroy(); } catch(e){}
      window.galleryMasonry = null;
    }
    // remove any inline styles accidentally left by Masonry
    container.removeAttribute('style');
    container.querySelectorAll('.masonry-item').forEach(el=> el.removeAttribute('style'));
  }
})();

// Template switcher with AJAX
document.querySelectorAll('.tpl-switch')?.forEach(a=>{
  a.addEventListener('click', (e)=>{
    e.preventDefault();
    
    // Get the template ID from the URL
    const url = new URL(a.getAttribute('href'), window.location.origin);
    const templateId = url.searchParams.get('template');
    
    if (!templateId) return;

    // Update global template settings from data attribute
    try {
      const settingsStr = a.getAttribute('data-settings');
      if (settingsStr) {
        window.templateSettings = JSON.parse(settingsStr);
      }
    } catch (err) { console.warn('Failed to parse template settings', err); }
    
    // Get album reference (slug or ID)
    const albumRef = url.searchParams.get('album');
    
    // Add loading state
    let galleryContainer = document.getElementById('images-gallery');
    if (!galleryContainer) return;
    
    const originalContent = galleryContainer.innerHTML;
    galleryContainer.innerHTML = '<div class="flex justify-center py-12"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-black"></div></div>';
    
    // Update active state in template switcher
    document.querySelectorAll('.tpl-switch').forEach(el => {
      el.classList.remove('bg-black', 'text-white');
      el.classList.add('text-neutral-700', 'hover:bg-neutral-100');
    });
    a.classList.remove('text-neutral-700', 'hover:bg-neutral-100');
    a.classList.add('bg-black', 'text-white');
    
    // Fetch new gallery content
    const fetchUrl = `/api/gallery/template?template=${templateId}${albumRef ? '&album=' + encodeURIComponent(albumRef) : ''}`;
    
    fetch(fetchUrl, {
      headers: {
        'Accept': 'text/html',
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => {
      if (!response.ok) throw new Error('Network response was not ok');
      return response.text();
    })
    .then(html => {
      // Replace the whole container node with the snippet's top-level element
      const parent = galleryContainer.parentNode;
      const tmp = document.createElement('div');
      tmp.innerHTML = html.trim();
      let newNode = tmp.firstElementChild;
      if (!newNode) {
        newNode = document.createElement('div');
        newNode.innerHTML = html;
      }
      newNode.id = 'images-gallery';
      parent.replaceChild(newNode, galleryContainer);
      galleryContainer = newNode;
      
      // Reinitialize any JavaScript components that might be needed
      try {
        // Reload template-specific scripts
        const layout = window.templateSettings.layout || 'grid';
        const masonry = window.templateSettings.masonry || false;
        
        // Destroy existing components if present
        if (window.gallerySwiper) {
          window.gallerySwiper.destroy(true, true);
          window.gallerySwiper = null;
        }
        if (window.galleryMasonry) {
          try { window.galleryMasonry.destroy(); } catch(e){}
          window.galleryMasonry = null;
        }
        
        // Initialize new components based on template
        if (layout === 'slideshow' && typeof Swiper !== 'undefined') {
          window.gallerySwiper = new Swiper('.gallery-swiper', { 
            navigation:{nextEl:'.swiper-button-next', prevEl:'.swiper-button-prev'}, 
            pagination:{el:'.swiper-pagination', clickable:true}, 
            loop:true, 
            autoplay:{delay:5000, disableOnInteraction:false}, 
            effect:'fade', 
            fadeEffect:{crossFade:true} 
          });
        }
        if (masonry && typeof Masonry !== 'undefined') {
          imagesLoaded(galleryContainer, function(){ 
            window.galleryMasonry = new Masonry(galleryContainer, { itemSelector: '.masonry-item', percentPosition: true }); 
          });
        } else {
          galleryContainer.removeAttribute('style');
          galleryContainer.querySelectorAll('.masonry-item').forEach(el=> el.removeAttribute('style'));
        }
      } catch (e) {
        console.warn('Error reinitializing components:', e);
      }
    })
    .catch(error => {
      console.error('Error loading template:', error);
      galleryContainer.innerHTML = originalContent; // Restore original content
      alert('Error loading template. Please try again.');
    });
  });
});
{% endblock %}
