{% extends "frontend/_layout.twig" %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="max-w-4xl mx-auto text-center pb-12">
    <div class="mb-4 flex flex-wrap gap-2 justify-center">
      {% if album.categories is defined and album.categories|length > 0 %}
        {% for cat in album.categories %}
        <a href="/category/{{ cat.slug }}" class="inline-flex items-center gap-2 text-xs font-medium px-2.5 py-1 rounded-full border border-neutral-300 bg-neutral-50 text-neutral-700 hover:bg-neutral-100 hover:text-black transition-colors" title="{{ cat.name|e }}">
          <span class="w-1.5 h-1.5 rounded-full bg-neutral-700"></span>{{ cat.name|e }}
        </a>
        {% endfor %}
      {% endif %}
      {% if album.tags is defined and album.tags|length > 0 %}
        {% for tag in album.tags %}
        <span class="inline-flex items-center gap-2 text-xs font-medium px-2.5 py-1 rounded-full border border-blue-300 bg-blue-50 text-blue-700" title="{{ tag.name|e }}">
          <span class="w-1.5 h-1.5 rounded-full bg-blue-700"></span>{{ tag.name|e }}
        </span>
        {% endfor %}
      {% endif %}
    </div>
    <h1 class="text-3xl md:text-4xl font-light text-black mb-6">{{ album.title|e }}</h1>
    <p class="text-lg text-neutral-600 leading-relaxed mb-6">{{ album.excerpt|e }}</p>
  </div>

  <div class="max-w-3xl mx-auto prose prose-neutral mb-12">{{ album.body|raw }}</div>

  <div class="max-w-5xl mx-auto mb-8 p-4 bg-neutral-50 rounded-lg">
    <h3 class="text-sm font-medium mb-3 text-center">Equipment</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4 text-xs text-neutral-600">
      <div><div class="font-medium mb-1 flex items-center gap-2"><i class="fas fa-camera"></i> Cameras</div>
        <div class="space-y-1">{% for camera in album.equipment.cameras %}<div>{{ camera }}</div>{% else %}<div class="text-neutral-400">—</div>{% endfor %}</div>
      </div>
      <div><div class="font-medium mb-1 flex items-center gap-2"><i class="fas fa-dot-circle"></i> Lenses</div>
        <div class="space-y-1">{% for lens in album.equipment.lenses %}<div>{{ lens }}</div>{% else %}<div class="text-neutral-400">—</div>{% endfor %}</div>
      </div>
      <div><div class="font-medium mb-1 flex items-center gap-2"><i class="fas fa-film"></i> Film</div>
        <div class="space-y-1">{% for film in album.equipment.film %}<div>{{ film }}</div>{% else %}<div class="text-neutral-400">—</div>{% endfor %}</div>
      </div>
      <div><div class="font-medium mb-1 flex items-center gap-2"><i class="fas fa-flask"></i> Developers</div>
        <div class="space-y-1">{% for dev in album.equipment.developers %}<div>{{ dev }}</div>{% else %}<div class="text-neutral-400">—</div>{% endfor %}</div>
      </div>
      <div><div class="font-medium mb-1 flex items-center gap-2"><i class="fas fa-industry"></i> Labs</div>
        <div class="space-y-1">{% for lab in album.equipment.labs %}<div>{{ lab }}</div>{% else %}<div class="text-neutral-400">—</div>{% endfor %}</div>
      </div>
      <div><div class="font-medium mb-1 flex items-center gap-2"><i class="fas fa-map-marker-alt"></i> Locations</div>
        <div class="space-y-1">{% for loc in album.equipment.locations %}<div>{{ loc }}</div>{% else %}<div class="text-neutral-400">—</div>{% endfor %}</div>
      </div>
    </div>
  </div>

  {% set layout = template_settings.layout|default('grid') %}
  {% set masonry = template_settings.masonry|default(false) %}
  
  {# Handle potentially nested columns structure #}
  {% set cols = template_settings.columns is defined ? template_settings.columns : {'desktop': 3, 'tablet': 2, 'mobile': 1} %}
  
  {# Extract desktop columns - handle nested structure #}
  {% if cols.desktop is iterable and cols.desktop.desktop is defined %}
    {% set desktop_cols = cols.desktop.desktop %}
  {% elseif cols.desktop is defined %}
    {% set desktop_cols = cols.desktop %}
  {% else %}
    {% set desktop_cols = 3 %}
  {% endif %}
  
  {# Extract tablet columns - handle nested structure #}
  {% if cols.tablet is iterable and cols.tablet.tablet is defined %}
    {% set tablet_cols = cols.tablet.tablet %}
  {% elseif cols.tablet is defined %}
    {% set tablet_cols = cols.tablet %}
  {% else %}
    {% set tablet_cols = 2 %}
  {% endif %}
  
  {# Extract mobile columns - handle nested structure #}
  {% if cols.mobile is iterable and cols.mobile.mobile is defined %}
    {% set mobile_cols = cols.mobile.mobile %}
  {% elseif cols.mobile is defined %}
    {% set mobile_cols = cols.mobile %}
  {% else %}
    {% set mobile_cols = 1 %}
  {% endif %}
  
  {# Ensure values are numbers #}
  {% set desktop_cols = desktop_cols|round %}
  {% set tablet_cols = tablet_cols|round %}
  {% set mobile_cols = mobile_cols|round %}
  

  {% if available_templates|length > 0 %}
  <div class="max-w-7xl mx-auto mb-2">
    <div class="flex justify-end">
      <div class="inline-flex items-center gap-1 bg-white/90 backdrop-blur-sm border border-neutral-200 rounded-md p-1 shadow-sm">
        {% for template in available_templates %}
        <a class="tpl-switch px-2 py-1 rounded {{ template.id == current_template_id ? 'bg-black text-white' : 'text-neutral-700 hover:bg-neutral-100' }}" href="/gallery?template={{ template.id }}{% if album_ref %}&album={{ album_ref }}{% endif %}" title="{{ template.name }}">
          {% if template.settings.layout == 'grid' %}
            {% if template.settings.masonry %}
              <i class="fas fa-th-large"></i>
            {% else %}
              {% set tpl_desktop_cols = template.settings.columns.desktop|default(3) %}
              {% if tpl_desktop_cols <= 2 %}
                <i class="fas fa-pause"></i>
              {% elseif tpl_desktop_cols == 3 %}
                <i class="fas fa-th"></i>
              {% elseif tpl_desktop_cols == 4 %}
                <i class="fas fa-th"></i>
              {% else %}
                <i class="fas fa-border-all"></i>
              {% endif %}
            {% endif %}
          {% elseif template.settings.layout == 'slideshow' %}
            <i class="fas fa-images"></i>
          {% elseif template.settings.layout == 'fullscreen' %}
            <i class="fas fa-expand"></i>
          {% elseif template.settings.layout == 'masonry' %}
            <i class="fas fa-th-large"></i>
          {% else %}
            <i class="fas fa-th"></i>
          {% endif %}
        </a>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}

  {% if layout == 'slideshow' %}
    <div id="images-gallery" class="max-w-4xl mx-auto">
      <div class="swiper gallery-swiper">
        <div class="swiper-wrapper">
          {% for image in images %}
          <div class="swiper-slide">
            <a href="{{ image.lightbox_url|default(image.url) }}" 
               class="pswp-link image-item aspect-[4/3] bg-neutral-100 rounded-lg overflow-hidden shadow-sm hover:shadow-lg transition-shadow cursor-pointer block"
               data-pswp-width="{{ image.width|default(1600) }}"
               data-pswp-height="{{ image.height|default(1067) }}"
               data-pswp-caption="{% if image.caption %}{{ image.caption|e }}{% endif %}{% if image.custom_camera or image.camera_name or image.custom_lens or image.lens_name or image.custom_film or image.film_name %}<div class='mt-2 text-sm text-gray-300'>{% if image.custom_camera or image.camera_name %}<i class='fas fa-camera mr-1'></i>{{ image.custom_camera|default(image.camera_name)|e }}{% endif %}{% if image.custom_lens or image.lens_name %} <i class='fas fa-dot-circle mr-1'></i>{{ image.custom_lens|default(image.lens_name)|e }}{% endif %}{% if image.custom_film or image.film_name %} <i class='fas fa-film mr-1'></i>{{ image.custom_film|default(image.film_name)|e }}{% endif %}</div>{% endif %}">
              <img src="{{ image.url }}" alt="{{ image.alt|default('Image')|e }}" class="w-full h-full object-cover">
            </a>
          </div>
          {% endfor %}
        </div>
        <div class="swiper-button-next"></div>
        <div class="swiper-button-prev"></div>
        <div class="swiper-pagination"></div>
      </div>
    </div>
  {% elseif layout == 'fullscreen' %}
    <div id="images-gallery" class="grid grid-cols-1 lg:grid-cols-2 gap-2">
      {% for image in images %}
      <div class="masonry-item">
        <a href="{{ image.lightbox_url|default(image.url) }}" 
           class="pswp-link image-item aspect-[4/3] bg-neutral-100 rounded-lg overflow-hidden shadow-sm hover:shadow-lg transition-shadow cursor-pointer group relative block"
           data-pswp-width="{{ image.width|default(1600) }}"
           data-pswp-height="{{ image.height|default(1067) }}"
           data-pswp-caption="{% if image.caption %}{{ image.caption|e }}{% endif %}{% if image.custom_camera or image.camera_name or image.custom_lens or image.lens_name or image.custom_film or image.film_name %}<div class='mt-2 text-sm text-gray-300'>{% if image.custom_camera or image.camera_name %}<i class='fas fa-camera mr-1'></i>{{ image.custom_camera|default(image.camera_name)|e }}{% endif %}{% if image.custom_lens or image.lens_name %} <i class='fas fa-dot-circle mr-1'></i>{{ image.custom_lens|default(image.lens_name)|e }}{% endif %}{% if image.custom_film or image.film_name %} <i class='fas fa-film mr-1'></i>{{ image.custom_film|default(image.film_name)|e }}{% endif %}</div>{% endif %}">
          <img src="{{ image.url }}" alt="{{ image.alt|e }}" class="w-full h-full object-cover">
        </a>
      </div>
      {% endfor %}
    </div>
  {% elseif masonry %}
    <div id="images-gallery" class="masonry-grid">
      {% for image in images %}
      <div class="masonry-item">
        <a href="{{ image.lightbox_url|default(image.url) }}" 
           class="pswp-link image-item bg-neutral-100 rounded-lg overflow-hidden shadow-sm hover:shadow-lg transition-shadow cursor-pointer mb-4 group relative block"
           data-pswp-width="{{ image.width|default(1600) }}"
           data-pswp-height="{{ image.height|default(1067) }}"
           data-pswp-caption="{% if image.caption %}{{ image.caption|e }}{% endif %}{% if image.custom_camera or image.camera_name or image.custom_lens or image.lens_name or image.custom_film or image.film_name %}<div class='mt-2 text-sm text-gray-300'>{% if image.custom_camera or image.camera_name %}<i class='fas fa-camera mr-1'></i>{{ image.custom_camera|default(image.camera_name)|e }}{% endif %}{% if image.custom_lens or image.lens_name %} <i class='fas fa-dot-circle mr-1'></i>{{ image.custom_lens|default(image.lens_name)|e }}{% endif %}{% if image.custom_film or image.film_name %} <i class='fas fa-film mr-1'></i>{{ image.custom_film|default(image.film_name)|e }}{% endif %}</div>{% endif %}">
          <img src="{{ image.url }}" alt="{{ image.alt|e }}" class="w-full h-auto object-cover">
        </a>
      </div>
      {% endfor %}
    </div>
  {% else %}
    {% if mobile_cols == 1 %}{% set mobile_class = 'grid-cols-1' %}
    {% elseif mobile_cols == 2 %}{% set mobile_class = 'grid-cols-2' %}
    {% elseif mobile_cols == 3 %}{% set mobile_class = 'grid-cols-3' %}
    {% elseif mobile_cols == 4 %}{% set mobile_class = 'grid-cols-4' %}
    {% elseif mobile_cols == 5 %}{% set mobile_class = 'grid-cols-5' %}
    {% else %}{% set mobile_class = 'grid-cols-6' %}{% endif %}
    
    {% if tablet_cols == 1 %}{% set tablet_class = 'md:grid-cols-1' %}
    {% elseif tablet_cols == 2 %}{% set tablet_class = 'md:grid-cols-2' %}
    {% elseif tablet_cols == 3 %}{% set tablet_class = 'md:grid-cols-3' %}
    {% elseif tablet_cols == 4 %}{% set tablet_class = 'md:grid-cols-4' %}
    {% elseif tablet_cols == 5 %}{% set tablet_class = 'md:grid-cols-5' %}
    {% else %}{% set tablet_class = 'md:grid-cols-6' %}{% endif %}
    
    {% if desktop_cols == 1 %}{% set desktop_class = 'lg:grid-cols-1' %}
    {% elseif desktop_cols == 2 %}{% set desktop_class = 'lg:grid-cols-2' %}
    {% elseif desktop_cols == 3 %}{% set desktop_class = 'lg:grid-cols-3' %}
    {% elseif desktop_cols == 4 %}{% set desktop_class = 'lg:grid-cols-4' %}
    {% elseif desktop_cols == 5 %}{% set desktop_class = 'lg:grid-cols-5' %}
    {% else %}{% set desktop_class = 'lg:grid-cols-6' %}{% endif %}
    <div id="images-gallery" class="grid {{ mobile_class }} {{ tablet_class }} {{ desktop_class }} gap-4">
      {% for image in images %}
      <div class="masonry-item">
        <a href="{{ image.lightbox_url|default(image.url) }}" 
           class="pswp-link image-item aspect-[4/3] bg-neutral-100 rounded-lg overflow-hidden shadow-sm hover:shadow-lg transition-shadow cursor-pointer group relative block"
           data-pswp-width="{{ image.width|default(1600) }}"
           data-pswp-height="{{ image.height|default(1067) }}"
           data-pswp-caption="{% if image.caption %}{{ image.caption|e }}{% endif %}{% if image.custom_camera or image.camera_name or image.custom_lens or image.lens_name or image.custom_film or image.film_name %}<div class='mt-2 text-sm text-gray-300'>{% if image.custom_camera or image.camera_name %}<i class='fas fa-camera mr-1'></i>{{ image.custom_camera|default(image.camera_name)|e }}{% endif %}{% if image.custom_lens or image.lens_name %} <i class='fas fa-dot-circle mr-1'></i>{{ image.custom_lens|default(image.lens_name)|e }}{% endif %}{% if image.custom_film or image.film_name %} <i class='fas fa-film mr-1'></i>{{ image.custom_film|default(image.film_name)|e }}{% endif %}</div>{% endif %}">
          <img src="{{ image.url }}" alt="{{ image.alt|e }}" class="w-full h-full object-cover">
        </a>
      </div>
      {% endfor %}
    </div>
  {% endif %}

</div>
{% endblock %}

{% block scripts %}
// Store template settings globally for AJAX reloads
window.templateSettings = {{ template_settings ? template_settings|json_encode|raw : '{}' }};

const layout = window.templateSettings.layout || 'grid';
const masonry = window.templateSettings.masonry || false;

// Initialize Swiper for slideshow layout
if (layout === 'slideshow' && typeof Swiper !== 'undefined') {
  window.gallerySwiper = new Swiper('.gallery-swiper', { 
    navigation: {nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev'}, 
    pagination: {el: '.swiper-pagination', clickable: true}, 
    loop: true, 
    autoplay: {delay: 5000, disableOnInteraction: false}, 
    effect: 'fade', 
    fadeEffect: {crossFade: true} 
  });
}

// Initialize Masonry for masonry layout
if (masonry && typeof Masonry !== 'undefined') {
  const container = document.getElementById('images-gallery');
  if (container) {
    imagesLoaded(container, function(){ 
      window.galleryMasonry = new Masonry(container, { itemSelector: '.masonry-item', percentPosition: true }); 
    });
  }
}

// Template switcher functionality
document.querySelectorAll('.tpl-switch')?.forEach(a => {
  a.addEventListener('click', (e) => {
    e.preventDefault();
    
    // Get the template ID from the URL
    const url = new URL(a.getAttribute('href'), window.location.origin);
    const templateId = url.searchParams.get('template');
    
    if (!templateId) {
      // If no template ID, follow the link normally
      window.location.href = a.getAttribute('href');
      return;
    }
    
    // Get album reference (slug or ID)
    const albumRef = url.searchParams.get('album');
    
    // Get the gallery container
    const galleryContainer = document.getElementById('images-gallery');
    if (!galleryContainer) {
      // Fallback to normal navigation if container not found
      window.location.href = a.getAttribute('href');
      return;
    }
    
    // Store original content for error recovery
    const originalContent = galleryContainer.innerHTML;
    
    // Add loading state
    galleryContainer.innerHTML = '<div class="flex justify-center py-12"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-black"></div></div>';
    
    // Update active state in template switcher
    document.querySelectorAll('.tpl-switch').forEach(el => {
      el.classList.remove('bg-black', 'text-white');
      el.classList.add('text-neutral-700', 'hover:bg-neutral-100');
    });
    a.classList.remove('text-neutral-700', 'hover:bg-neutral-100');
    a.classList.add('bg-black', 'text-white');
    
    // Build the AJAX URL for fetching only the gallery content
    const fetchUrl = `/api/gallery/template?template=${templateId}${albumRef ? '&album=' + encodeURIComponent(albumRef) : ''}`;
    
    // Fetch the full page and extract the gallery content
    fetch(fetchUrl, {
      headers: {
        'Accept': 'text/html',
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => {
      if (!response.ok) throw new Error('Network response was not ok');
      return response.text();
    })
    .then(html => {
      console.log('Received HTML response, length:', html.length);
      
      // The API endpoint returns the gallery content directly, not a full HTML page
      // So we can directly use the response as the new gallery content
      galleryContainer.innerHTML = html;
      
      console.log('Updated gallery content successfully');
      
      // Update the page URL without reloading
      history.pushState(null, '', a.getAttribute('href'));
      
      // Reinitialize components based on new template settings
      setTimeout(() => {
        const layout = window.templateSettings?.layout || 'grid';
        const masonry = window.templateSettings?.masonry || false;
        
        // Re-initialize PhotoSwipe
        if (typeof initLightbox === 'function') {
          initLightbox();
        }
        
        // Destroy existing Swiper instances
        if (window.gallerySwiper && typeof window.gallerySwiper.destroy === 'function') {
          window.gallerySwiper.destroy(true, true);
          window.gallerySwiper = null;
        }
        
        // Re-initialize Swiper for slideshow layout
        if (layout === 'slideshow' && typeof Swiper !== 'undefined') {
          const swiperContainer = document.querySelector('.gallery-swiper');
          if (swiperContainer) {
            window.gallerySwiper = new Swiper('.gallery-swiper', {
              navigation: {nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev'},
              pagination: {el: '.swiper-pagination', clickable: true},
              loop: true,
              autoplay: {delay: 5000, disableOnInteraction: false},
              effect: 'fade',
              fadeEffect: {crossFade: true}
            });
          }
        }
        
        // Destroy existing Masonry instances
        if (window.galleryMasonry && typeof window.galleryMasonry.destroy === 'function') {
          window.galleryMasonry.destroy();
          window.galleryMasonry = null;
        }
        
        // Re-initialize Masonry for masonry layout
        if (masonry && typeof Masonry !== 'undefined') {
          const container = document.getElementById('images-gallery');
          if (container && container.classList.contains('masonry-grid')) {
            imagesLoaded(container, function(){
              window.galleryMasonry = new Masonry(container, {
                itemSelector: '.masonry-item',
                percentPosition: true
              });
            });
          }
        }
        
        // Trigger GSAP animations for new content
        if (typeof gsap !== 'undefined') {
          gsap.from('.image-item', {
            opacity: 0,
            y: 20,
            duration: 0.6,
            stagger: 0.1
          });
        }
      }, 100);
    })
    .catch(error => {
      console.error('Error loading template:', error);
      console.error('Failed URL:', fetchUrl);
      console.error('Error details:', {
        message: error.message,
        stack: error.stack
      });
      
      // Restore original content and button state on error
      galleryContainer.innerHTML = originalContent;
      
      // Restore button states
      document.querySelectorAll('.tpl-switch').forEach(el => {
        el.classList.remove('bg-black', 'text-white');
        el.classList.add('text-neutral-700', 'hover:bg-neutral-100');
      });
      
      // Find and restore the previously active button
      const currentUrl = window.location.href;
      document.querySelectorAll('.tpl-switch').forEach(btn => {
        if (btn.href === currentUrl || btn.classList.contains('bg-black')) {
          btn.classList.remove('text-neutral-700', 'hover:bg-neutral-100');
          btn.classList.add('bg-black', 'text-white');
        }
      });
      
      // Show more specific error message
      const errorMsg = error.message.includes('Gallery content not found') 
        ? 'Template content not found. Please refresh the page and try again.'
        : 'Error loading template. Please check your connection and try again.';
      alert(errorMsg);
    });
  });
});
{% endblock %}
