{% extends 'admin/_layout.twig' %}
{% block title %}Categories â€” photoCMS{% endblock %}
{% block content %}
  <div class="flex items-center justify-between mb-8">
    <div>
      <h1 class="text-3xl font-bold text-black">Categories</h1>
      <p class="text-gray-600 mt-1">Drag horizontally to create hierarchy</p>
    </div>
    <a href="{{ base_path }}/admin/categories/create" class="btn-primary">
      <i class="fas fa-plus mr-2"></i>New Category
    </a>
  </div>

  <div class="grid grid-cols-1 xl:grid-cols-4 gap-8">
    <div class="xl:col-span-3">
      <div class="card">
        <div class="p-6 border-b border-gray-200">
          <h2 class="text-lg font-semibold text-black flex items-center">
            <i class="fas fa-layer-group mr-3 text-gray-600"></i>
            Category Management
          </h2>
          <p class="text-gray-600 text-sm mt-1">Drag items to create hierarchy - 5 levels maximum</p>
        </div>

        <style>
          /* Clean minimal drag system */
          .categories-container {
            min-height: 300px;
            padding: 20px;
            background: #fafafa;
          }
          
          .category-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            margin-bottom: 8px;
            height: 48px;
            display: flex;
            align-items: center;
            cursor: move;
            transition: all 0.2s ease;
            position: relative;
            max-width: 600px;
          }
          
          /* Clean level indentation - 30px increments */
          .category-item[data-level="0"] { margin-left: 0; }
          .category-item[data-level="1"] { margin-left: 30px; }
          .category-item[data-level="2"] { margin-left: 60px; }
          .category-item[data-level="3"] { margin-left: 90px; }
          .category-item[data-level="4"] { margin-left: 120px; }
          
          .category-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: translateY(-1px);
          }
          
          .category-item.dragging {
            opacity: 0.8;
            transform: scale(1.02);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            z-index: 1000;
          }
          
          .drag-handle {
            width: 24px;
            height: 24px;
            margin: 0 12px;
            background: #f3f4f6;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            font-size: 12px;
            flex-shrink: 0;
            cursor: grab;
          }
          
          .drag-handle:active {
            cursor: grabbing;
          }
          
          .drag-handle:hover {
            background: #e5e7eb;
            color: #6b7280;
          }
          
          .category-icon {
            width: 32px;
            height: 32px;
            margin-right: 12px;
            border-radius: 4px;
            overflow: hidden;
            flex-shrink: 0;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
          }
          
          .category-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
          }
          
          .category-icon.placeholder {
            color: #9ca3af;
            font-size: 14px;
          }
          
          .category-name {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 12px;
          }
          
          .category-actions {
            display: flex;
            gap: 4px;
            margin-right: 12px;
            opacity: 0;
            transition: opacity 0.2s ease;
          }
          
          .category-item:hover .category-actions {
            opacity: 1;
          }
          
          .action-btn {
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            background: #f3f4f6;
            color: #374151;
          }
          
          .action-btn:hover {
            background: #e5e7eb;
            transform: scale(1.1);
          }
          
          /* Drag feedback */
          .categories-container.drag-active {
            background: repeating-linear-gradient(
              90deg,
              transparent 0px,
              transparent 28px,
              rgba(0, 0, 0, 0.05) 28px,
              rgba(0, 0, 0, 0.05) 32px
            );
          }
          
          /* Level indicator */
          .level-indicator {
            position: fixed;
            top: 50%;
            right: 30px;
            transform: translateY(-50%);
            background: #1f2937;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            z-index: 9999;
            opacity: 0;
            transition: all 0.2s ease;
            pointer-events: none;
          }
          
          .level-indicator.show {
            opacity: 1;
          }
          
          .level-indicator.max-level {
            background: #dc2626;
            animation: shake 0.5s ease-in-out;
          }
          
          @keyframes shake {
            0%, 100% { transform: translateY(-50%) translateX(0); }
            25% { transform: translateY(-50%) translateX(-3px); }
            75% { transform: translateY(-50%) translateX(3px); }
          }
          
          .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
          }
          
          .empty-state i {
            font-size: 40px;
            margin-bottom: 12px;
            color: #d1d5db;
          }
        </style>
        
        <div class="categories-container" id="categories-container">
          {% if categories is defined and categories|length > 0 %}
            {% for category in categories %}
              <div class="category-item" data-id="{{ category.id }}" data-level="{{ category.level|default(0) }}">
                <div class="drag-handle">
                  <i class="fas fa-grip-vertical"></i>
                </div>
                
                <div class="category-icon">
                  {% if category.image_path and category.image_path != '' %}
                    <img src="{{ category.image_path }}" alt="{{ category.name }}" onerror="this.style.display='none'; this.parentNode.innerHTML='<div class=&quot;placeholder&quot;><i class=&quot;fas fa-folder&quot;></i></div>';">
                  {% else %}
                    <div class="placeholder">
                      <i class="fas fa-folder"></i>
                    </div>
                  {% endif %}
                </div>
                
                <div class="category-name">{{ category.name }}</div>
                
                <div class="category-actions">
                  <button class="action-btn edit" data-edit="{{ category.id }}" title="Edit">
                    <i class="fas fa-edit"></i>
                  </button>
                  <form method="post" action="{{ base_path }}/admin/categories/{{ category.id }}/delete" class="inline" onsubmit="return confirm('Delete this category?')">
                    <input type="hidden" name="csrf" value="{{ csrf }}">
                    <button class="action-btn delete" title="Delete">
                      <i class="fas fa-trash"></i>
                    </button>
                  </form>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <div class="empty-state">
              <i class="fas fa-folder-open"></i>
              <div class="text-lg font-medium mb-2 text-gray-900">No categories yet</div>
              <div class="text-sm mb-4">Create your first category to get started</div>
              <a href="{{ base_path }}/admin/categories/create" class="btn-primary">
                <i class="fas fa-plus mr-2"></i>Create First Category
              </a>
            </div>
          {% endif %}
        </div>
        
        <!-- Level indicator -->
        <div class="level-indicator" id="level-indicator">
          Level 0
        </div>
      </div>
    </div>

    <!-- Quick Edit Panel -->
    <div class="xl:col-span-1">
      <div class="card p-6 sticky top-24">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">
          <i class="fas fa-edit mr-2 text-gray-600"></i>Quick Edit
        </h2>
        
        <form id="cat-form" method="post" action="{{ base_path }}/admin/categories" enctype="multipart/form-data" class="space-y-4">
          <input type="hidden" name="csrf" value="{{ csrf }}">
          <input type="hidden" name="id" id="cat-id" value="">
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Category Name</label>
            <input class="form-input" type="text" name="name" id="cat-name" placeholder="Enter category name..." required>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">URL Slug</label>
            <input class="form-input" type="text" name="slug" id="cat-slug" placeholder="Auto-generated if empty">
            <small class="text-gray-500 text-xs mt-1">Used in URLs, leave empty for auto-generation</small>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Parent Category</label>
            <select class="form-input" name="parent_id" id="cat-parent">
              <option value="">None (Main category)</option>
              {% for parent in byParent[0]|default([]) %}
                <option value="{{ parent.id }}">{{ parent.name }}</option>
              {% endfor %}
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Category Image</label>
            <div id="current-image" class="hidden mb-3">
              <img id="current-image-preview" class="w-full h-32 object-cover rounded-lg border" alt="Current image">
              <div class="flex items-center justify-between mt-2 p-2 bg-gray-50 rounded">
                <small class="text-gray-600">Current image</small>
                <label class="flex items-center gap-1 text-red-600 cursor-pointer text-sm">
                  <input type="checkbox" name="remove_image" value="1" class="rounded">
                  Remove image
                </label>
              </div>
            </div>
            <input class="form-input" type="file" name="image" accept="image/*" id="cat-image">
            <small class="text-gray-500 text-xs mt-1">JPG, PNG, WebP formats supported. Used in navigation menus.</small>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Sort Order</label>
            <input class="form-input" type="number" name="sort_order" id="cat-sort" value="0" min="0">
          </div>
          
          <div class="flex flex-col gap-2 pt-4">
            <button class="bg-black hover:bg-gray-800 text-white px-4 py-2 rounded-lg transition-colors w-full flex items-center justify-center" type="submit">
              <i class="fas fa-save mr-2"></i>Save Category
            </button>
            <button id="cat-reset" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg transition-colors w-full flex items-center justify-center" type="button">
              <i class="fas fa-plus mr-2"></i>New Category
            </button>
          </div>
        </form>
        
        <div class="mt-6 pt-6 border-t border-gray-200">
          <div class="text-sm text-gray-600">
            <div class="flex items-center mb-3">
              <i class="fas fa-info-circle text-gray-500 mr-2"></i>
              <strong>Drag System:</strong>
            </div>
            <ul class="space-y-2 text-xs">
              <li class="flex items-start">
                <i class="fas fa-arrows-alt-h text-gray-400 mr-2 mt-0.5"></i>
                <span><strong>Horizontal drag:</strong> Move left/right to change hierarchy level</span>
              </li>
              <li class="flex items-start">
                <i class="fas fa-arrows-alt-v text-gray-400 mr-2 mt-0.5"></i>
                <span><strong>Vertical drag:</strong> Move up/down to reorder categories</span>
              </li>
              <li class="flex items-start">
                <i class="fas fa-layer-group text-gray-400 mr-2 mt-0.5"></i>
                <span><strong>5 Levels:</strong> 0=Main, 1=Sub, 2=Sub-sub, 3=Deep, 4=Maximum</span>
              </li>
              <li class="flex items-start">
                <i class="fas fa-save text-gray-400 mr-2 mt-0.5"></i>
                <span><strong>Auto-save:</strong> Changes save automatically when you release</span>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global base path for API calls
    window.basePath = '{{ base_path }}';
    
    let csrfToken = {{ csrf|json_encode|raw }};
    
    // Clean drag system
    class DragSystem {
      constructor() {
        this.container = document.getElementById('categories-container');
        this.indicator = document.getElementById('level-indicator');
        this.isDragging = false;
        this.dragItem = null;
        this.startX = 0;
        this.startY = 0;
        this.currentLevel = 0;
        this.maxLevel = 4;
        this.levelStep = 30; // 30px steps for level changes
        
        this.init();
      }
      
      init() {
        if (!this.container) return;
        
        this.container.addEventListener('mousedown', this.handleMouseDown.bind(this));
        document.addEventListener('mousemove', this.handleMouseMove.bind(this));
        document.addEventListener('mouseup', this.handleMouseUp.bind(this));
      }
      
      handleMouseDown(e) {
        const handle = e.target.closest('.drag-handle');
        if (!handle) return;
        
        e.preventDefault();
        this.startDrag(e, handle.closest('.category-item'), e.clientX, e.clientY);
      }
      
      startDrag(e, item, x, y) {
        this.isDragging = true;
        this.dragItem = item;
        this.startX = x;
        this.startY = y;
        this.currentLevel = parseInt(item.dataset.level) || 0;
        
        item.classList.add('dragging');
        this.container.classList.add('drag-active');
        document.body.style.userSelect = 'none';
        document.body.style.cursor = 'grabbing';
        
        this.updateIndicator(this.currentLevel);
      }
      
      handleMouseMove(e) {
        if (!this.isDragging) return;
        this.updateDrag(e.clientX, e.clientY);
      }
      
      updateDrag(x, y) {
        if (!this.dragItem) return;
        
        // Calculate horizontal movement for level changes
        const deltaX = x - this.startX;
        const newLevel = Math.max(0, Math.min(this.maxLevel, 
          this.currentLevel + Math.floor(deltaX / this.levelStep)
        ));
        
        // Update visual level immediately
        this.dragItem.dataset.level = newLevel;
        this.dragItem.setAttribute('data-level', newLevel);
        
        // Calculate vertical movement for reordering
        const deltaY = y - this.startY;
        const items = Array.from(this.container.querySelectorAll('.category-item'));
        const dragIndex = items.indexOf(this.dragItem);
        
        if (Math.abs(deltaY) > 24) { // 24px threshold for reordering
          const targetIndex = deltaY > 0 ? 
            Math.min(items.length - 1, dragIndex + Math.floor(Math.abs(deltaY) / 48)) :
            Math.max(0, dragIndex - Math.floor(Math.abs(deltaY) / 48));
          
          if (targetIndex !== dragIndex) {
            const targetItem = items[targetIndex];
            if (deltaY > 0) {
              targetItem.parentNode.insertBefore(this.dragItem, targetItem.nextSibling);
            } else {
              targetItem.parentNode.insertBefore(this.dragItem, targetItem);
            }
          }
        }
        
        this.updateIndicator(newLevel);
      }
      
      handleMouseUp(e) {
        if (!this.isDragging) return;
        
        this.isDragging = false;
        document.body.style.userSelect = '';
        document.body.style.cursor = '';
        
        if (this.dragItem) {
          this.dragItem.classList.remove('dragging');
          this.dragItem = null;
        }
        
        this.container.classList.remove('drag-active');
        this.indicator.classList.remove('show');
        
        // Save the new hierarchy
        setTimeout(() => this.saveHierarchy(), 100);
      }
      
      updateIndicator(level) {
        this.indicator.textContent = `Level ${level}${level >= this.maxLevel ? ' (MAX)' : ''}`;
        this.indicator.classList.add('show');
        
        if (level >= this.maxLevel) {
          this.indicator.classList.add('max-level');
        } else {
          this.indicator.classList.remove('max-level');
        }
      }
      
      async saveHierarchy() {
        const items = this.container.querySelectorAll('.category-item');
        const hierarchy = [];
        
        items.forEach((item, index) => {
          const id = parseInt(item.dataset.id);
          let level = parseInt(item.dataset.level) || 0;
          let parentId = null;
          
          // Find parent by looking at previous items
          if (level > 0) {
            for (let i = index - 1; i >= 0; i--) {
              const prevItem = items[i];
              const prevLevel = parseInt(prevItem.dataset.level) || 0;
              
              if (prevLevel === level - 1) {
                parentId = parseInt(prevItem.dataset.id);
                break;
              }
            }
          }
          
          hierarchy.push({
            id: id,
            parent_id: parentId,
            sort_order: index,
            level: level
          });
        });
        
        try {
          const response = await fetch(window.basePath + '/admin/categories/reorder-wordpress', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': csrfToken
            },
            body: JSON.stringify({ hierarchy })
          });
          
          if (response.ok) {
            this.showToast('Categories reordered successfully!');
          } else {
            throw new Error('Failed to save');
          }
        } catch (error) {
          this.showToast('Failed to save changes', 'error');
          console.error('Save error:', error);
        }
      }
      
      showToast(message, type = 'success') {
        if (window.showToast) {
          window.showToast(message, type === 'success' ? '' : 'error');
        } else {
          alert(`${type.toUpperCase()}: ${message}`);
        }
      }
    }
    
    // Quick edit functionality
    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('[data-edit]');
      if (!btn) return;
      e.preventDefault();
      
      const id = btn.getAttribute('data-edit');
      
      try {
        const res = await fetch(window.basePath + '/admin/api/category/' + id, {
          headers: { 'Accept': 'application/json' }
        });
        
        if (!res.ok) throw new Error('Failed to fetch category data');
        
        const data = await res.json();
        
        // Populate form fields
        document.getElementById('cat-id').value = data.id;
        document.getElementById('cat-name').value = data.name || '';
        document.getElementById('cat-slug').value = data.slug || '';
        document.getElementById('cat-sort').value = data.sort_order || 0;
        document.getElementById('cat-parent').value = data.parent_id || '';
        
        // Handle image preview
        const currentImageDiv = document.getElementById('current-image');
        const currentImagePreview = document.getElementById('current-image-preview');
        
        if (data.image_path) {
          currentImagePreview.src = data.image_path;
          currentImageDiv.classList.remove('hidden');
        } else {
          currentImageDiv.classList.add('hidden');
        }
        
        // Reset remove image checkbox
        const removeImageCheckbox = document.querySelector('input[name="remove_image"]');
        if (removeImageCheckbox) {
          removeImageCheckbox.checked = false;
        }
        
        // Update form action
        const form = document.getElementById('cat-form');
        form.action = window.basePath + '/admin/categories/' + id;
        
        // Scroll to form
        document.getElementById('cat-form').scrollIntoView({ 
          behavior: 'smooth', 
          block: 'center' 
        });
        
      } catch (error) {
        console.error('Failed to load category data:', error);
      }
    });
    
    // Reset form for new category
    document.getElementById('cat-reset').addEventListener('click', () => {
      document.getElementById('cat-id').value = '';
      document.getElementById('cat-name').value = '';
      document.getElementById('cat-slug').value = '';
      document.getElementById('cat-sort').value = '0';
      document.getElementById('cat-parent').value = '';
      document.getElementById('cat-image').value = '';
      
      // Hide current image
      document.getElementById('current-image').classList.add('hidden');
      
      // Reset remove image checkbox
      const removeImageCheckbox = document.querySelector('input[name="remove_image"]');
      if (removeImageCheckbox) {
        removeImageCheckbox.checked = false;
      }
      
      // Update form action
      const form = document.getElementById('cat-form');
      form.action = window.basePath + '/admin/categories';
    });
    
    // Initialize the drag system
    document.addEventListener('DOMContentLoaded', function() {
      new DragSystem();
    });
  </script>
{% endblock %}