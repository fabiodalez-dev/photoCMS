{% extends 'admin/_layout.twig' %}
{% block title %}Modifica album — photoCMS{% endblock %}
{% block content %}
<div class="min-h-screen bg-gray-50 pb-24">
  <!-- Header -->
  <div class="bg-white border-b border-gray-200 sticky top-0 z-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold text-black">Modifica Album</h1>
          <p class="text-gray-600 mt-1">Aggiorna le informazioni e gestisci le immagini</p>
        </div>
        <div class="flex items-center gap-3">
          <a href="/admin/albums" class="btn-secondary">
            <i class="fas fa-arrow-left mr-2"></i>
            Torna agli album
          </a>
          <a href="/admin/settings" class="btn-secondary">
            <i class="fas fa-cog mr-2"></i>
            Impostazioni
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <form method="post" action="/admin/albums/{{ item.id }}" id="album-form">
      <input type="hidden" name="csrf" value="{{ csrf }}">
      
      <div class="grid grid-cols-1 xl:grid-cols-12 gap-8">
        <!-- Main Content Column -->
        <div class="xl:col-span-8 space-y-6">
          <!-- Basic Information Card -->
          <div class="card">
            <div class="p-6 border-b border-gray-200">
              <h2 class="text-lg font-semibold text-black flex items-center">
                <i class="fas fa-info-circle mr-3 text-gray-600"></i>
                Informazioni Base
              </h2>
              <p class="text-gray-600 text-sm mt-1">Titolo, descrizione e contenuto dell'album</p>
            </div>
            <div class="p-6 space-y-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-medium text-black mb-2">Titolo *</label>
                  <input class="form-input border-gray-300 focus:border-black focus:ring-black" 
                         type="text" name="title" value="{{ item.title }}" required 
                         placeholder="Inserisci il titolo dell'album">
                </div>
                <div>
                  <label class="block text-sm font-medium text-black mb-2">Slug URL</label>
                  <input class="form-input border-gray-300 focus:border-black focus:ring-black font-mono text-sm" 
                         type="text" name="slug" value="{{ item.slug }}" 
                         placeholder="url-friendly-slug">
                  <p class="text-xs text-gray-500 mt-1">Lascia vuoto per generazione automatica</p>
                </div>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-black mb-2">Descrizione Breve</label>
                <textarea class="form-input border-gray-300 focus:border-black focus:ring-black" 
                          name="excerpt" rows="4" 
                          placeholder="Breve descrizione che appare nelle anteprime...">{{ item.excerpt }}</textarea>
                <p class="text-xs text-gray-500 mt-1">Massimo 150 caratteri per una visualizzazione ottimale</p>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-black mb-2">Contenuto Completo</label>
                <textarea class="form-input richtext border-gray-300 focus:border-black focus:ring-black" 
                          name="body" rows="12" 
                          placeholder="Descrizione completa con formattazione...">{{ item.body }}</textarea>
                <p class="text-xs text-gray-500 mt-1">Supporta formattazione ricca: grassetto, corsivo, elenchi, link</p>
              </div>
            </div>
          </div>

          <!-- Images Management Card -->
          <div class="card">
            <div class="p-6 border-b border-gray-200">
              <div class="flex items-center justify-between">
                <div>
                  <h2 class="text-lg font-semibold text-black flex items-center">
                    <i class="fas fa-images mr-3 text-gray-600"></i>
                    Gestione Immagini
                  </h2>
                  <p class="text-gray-600 text-sm mt-1">Carica e organizza le immagini dell'album</p>
                </div>
                <div class="flex items-center gap-3">
                  <select id="sort-images" class="form-input text-sm py-2">
                    <option value="manual">Ordine manuale</option>
                    <option value="created_newest">Data (più recenti)</option>
                    <option value="created_oldest">Data (più vecchie)</option>
                    <option value="id_asc">ID crescente</option>
                    <option value="id_desc">ID decrescente</option>
                  </select>
                  <button id="save-order" type="button" class="btn-secondary text-sm">
                    <i class="fas fa-save mr-1"></i>
                    Salva ordine
                  </button>
                </div>
              </div>
            </div>
            
            <div class="p-6">
              <!-- Upload Area -->
              <div id="uploader" role="button" 
                   class="w-full border-2 border-dashed border-gray-300 rounded-xl bg-gray-50 hover:bg-gray-100 hover:border-gray-400 transition-all cursor-pointer flex items-center justify-center min-h-[200px] text-gray-600 group"
                   data-endpoint="/admin/albums/{{ item.id }}/upload" data-csrf="{{ csrf }}">
                <input id="file-input" type="file" multiple class="hidden" accept="image/*">
                <div class="text-center">
                  <i class="fas fa-cloud-upload-alt text-4xl mb-4 text-gray-400 group-hover:text-gray-600 transition-colors"></i>
                  <div class="text-lg font-medium mb-2">Trascina qui le immagini</div>
                  <div class="text-sm text-gray-500">oppure clicca per selezionarle dal computer</div>
                  <div class="text-xs text-gray-400 mt-2">Formati supportati: JPG, PNG, WEBP</div>
                </div>
              </div>

              {% if images %}
                <!-- Bulk Actions -->
                <div class="flex items-center justify-between mt-6 mb-4">
                  <label class="inline-flex items-center gap-2 text-sm font-medium text-gray-700">
                    <input type="checkbox" id="select-all" class="rounded border-gray-300 text-black focus:ring-black">
                    Seleziona tutto ({{ images|length }} immagini)
                  </label>
                  <button id="bulk-delete" type="button" 
                          class="btn-outline-danger text-sm disabled:opacity-50 disabled:cursor-not-allowed" 
                          disabled>
                    <i class="fas fa-trash mr-1"></i>
                    Elimina selezionate
                  </button>
                </div>

                <!-- Images Grid -->
                <div id="images-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4" 
                     data-reorder-endpoint="/admin/albums/{{ item.id }}/images/reorder" data-csrf="{{ csrf }}">
                  {% for img in images %}
                    <div class="border rounded overflow-hidden group" data-id="{{ img.id }}" data-created="{{ img.created_at }}" data-sort="{{ img.sort_order }}"
                         data-src="{{ img.original_path|replace({'/public':''}) }}" data-w="{{ img.width }}" data-h="{{ img.height }}"
                         data-alt_text="{{ img.alt_text }}" data-caption="{{ img.caption }}"
                         data-camera_id="{{ img.camera_id }}" data-lens_id="{{ img.lens_id }}" data-film_id="{{ img.film_id }}" data-developer_id="{{ img.developer_id }}" data-lab_id="{{ img.lab_id }}" data-location_id="{{ img.location_id }}"
                         data-custom_camera="{{ img.custom_camera }}" data-custom_lens="{{ img.custom_lens }}" data-custom_film="{{ img.custom_film }}" data-iso="{{ img.iso }}" data-shutter_speed="{{ img.shutter_speed }}" data-aperture="{{ img.aperture }}">
                      <div class="aspect-square overflow-hidden bg-gray-100 relative cursor-pointer hover:ring-2 hover:ring-blue-500 hover:ring-opacity-50 transition-all" title="Clicca per modificare i dettagli dell'immagine">
                        <img src="{{ img.preview_path|replace({'/public':''}) }}" class="w-full h-full object-cover" alt="">
                        <input type="checkbox" class="absolute top-2 left-2 w-4 h-4 bg-white rounded border z-10" data-select-id="{{ img.id }}">
                        <div class="absolute inset-0 bg-black/0 hover:bg-black/10 transition-all flex items-center justify-center">
                          <div class="opacity-0 group-hover:opacity-100 transition-opacity bg-white/90 text-gray-800 px-3 py-1 rounded-full text-sm font-medium">
                            <i class="fas fa-edit mr-1"></i>Modifica dettagli
                          </div>
                        </div>
                      </div>
                      <div class="p-2 flex items-center justify-between text-sm">
                        <button type="button" data-cover-id="{{ img.id }}" class="px-2 py-1 rounded border {{ item.cover_image_id == img.id ? 'bg-green-600 text-white border-green-600' : 'border-gray-300 text-gray-700' }}">Cover</button>
                        <button type="button" data-delete-id="{{ img.id }}" class="px-2 py-1 rounded border border-red-300 text-red-700"><i class="fa-solid fa-trash"></i></button>
                      </div>
                    </div>
                  {% endfor %}
                </div>
                <div class="text-gray-500 text-sm mt-2">Trascina per riordinare oppure usa il selettore per ordinare per data/ID; clicca “Salva ordine” per persistere.</div>
              {% else %}
                <p class="text-gray-500">Nessuna immagine in questo album.</p>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Sidebar -->
        <div class="xl:col-span-4 space-y-6">
          <!-- Categories and Tags Card -->
          <div class="card">
            <div class="p-6 border-b border-gray-200">
              <h2 class="text-lg font-semibold text-black flex items-center">
                <i class="fas fa-tags mr-3 text-gray-600"></i>
                Categorie e Tag
              </h2>
              <p class="text-gray-600 text-sm mt-1">Organizza l'album con categorie e tag</p>
            </div>
            <div class="p-6 space-y-4">
              <div>
                <label class="block text-sm font-medium text-black mb-2">Categorie *</label>
                <select name="categories[]" id="album-categories" class="form-input" multiple required>
                  {% set selectedCats = categoryIds|default([item.category_id]) %}
                  {% for c in categories %}
                    <option value="{{ c.id }}" {% if c.id in selectedCats %}selected{% endif %}>{{ c.name }}</option>
                  {% endfor %}
                </select>
                <p class="text-xs text-gray-500 mt-1">Seleziona una o più categorie</p>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-black mb-2">Tag</label>
                <select class="form-input" name="tags[]" id="album-tags" multiple>
                  {% for t in tags %}
                    <option value="{{ t.id }}" {% if t.id in tagIds %}selected{% endif %}>{{ t.name }}</option>
                  {% endfor %}
                </select>
                <p class="text-xs text-gray-500 mt-1">Tag opzionali per categorizzazione avanzata</p>
              </div>
            </div>
          </div>

          <!-- Publishing Settings Card -->
          <div class="card">
            <div class="p-6 border-b border-gray-200">
              <h2 class="text-lg font-semibold text-black flex items-center">
                <i class="fas fa-globe mr-3 text-gray-600"></i>
                Impostazioni Pubblicazione
              </h2>
              <p class="text-gray-600 text-sm mt-1">Data, template e visibilità</p>
            </div>
            <div class="p-6 space-y-4">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-black mb-2">Data scatto</label>
                  <input class="form-input border-gray-300 focus:border-black focus:ring-black" 
                         type="date" name="shoot_date" value="{{ item.shoot_date }}">
                </div>
                <div>
                  <label class="block text-sm font-medium text-black mb-2">Ordine</label>
                  <input class="form-input border-gray-300 focus:border-black focus:ring-black" 
                         type="number" name="sort_order" value="{{ item.sort_order }}" 
                         placeholder="0">
                </div>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-black mb-2">Template</label>
                <select class="form-input border-gray-300 focus:border-black focus:ring-black" name="template_id">
                  <option value="">Template predefinito</option>
                  {% for template in templates %}
                    <option value="{{ template.id }}" {% if template.id == item.template_id %}selected{% endif %}>{{ template.name }}</option>
                  {% endfor %}
                </select>
              </div>
              
              <div class="space-y-3">
                <label class="flex items-center gap-3">
                  <input class="h-4 w-4 text-black border-gray-300 rounded focus:ring-black" 
                         type="checkbox" name="show_date" id="show_date" 
                         {% if item.show_date %}checked{% endif %}>
                  <span class="text-sm font-medium text-gray-700">Mostra data di scatto</span>
                </label>
                
                <label class="flex items-center gap-3">
                  <input class="h-4 w-4 text-black border-gray-300 rounded focus:ring-black" 
                         type="checkbox" name="is_published" id="pub" 
                         {% if item.is_published %}checked{% endif %}>
                  <span class="text-sm font-medium text-gray-700">Album pubblicato</span>
                </label>
                
                <label class="flex items-center gap-3">
                  <input class="h-4 w-4 text-black border-gray-300 rounded focus:ring-black" 
                         type="checkbox" name="allow_downloads" id="allow_downloads" 
                         {% if item.allow_downloads %}checked{% endif %}>
                  <span class="text-sm font-medium text-gray-700">Consenti download immagini</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Equipment Card -->
          <div class="card">
            <div class="p-6 border-b border-gray-200">
              <h2 class="text-lg font-semibold text-black flex items-center">
                <i class="fas fa-camera mr-3 text-gray-600"></i>
                Equipment Fotografico
              </h2>
              <p class="text-gray-600 text-sm mt-1">Attrezzatura utilizzata per l'album</p>
            </div>
            <div class="p-6 space-y-4">
              <div>
                <label class="block text-sm font-medium text-black mb-2">Fotocamere</label>
                <select class="form-input border-gray-300 focus:border-black focus:ring-black" name="cameras[]" id="album-cameras" multiple>
                  {% for camera in cameras %}
                    <option value="{{ camera.id }}" {% if camera.id in cameraIds %}selected{% endif %}>{{ camera.make }} {{ camera.model }}</option>
                  {% endfor %}
                </select>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-black mb-2">Obiettivi</label>
                <select class="form-input border-gray-300 focus:border-black focus:ring-black" name="lenses[]" id="album-lenses" multiple>
                  {% for lens in lenses %}
                    <option value="{{ lens.id }}" {% if lens.id in lensIds %}selected{% endif %}>{{ lens.brand }} {{ lens.model }}</option>
                  {% endfor %}
                </select>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-black mb-2">Pellicole</label>
                <select class="form-input border-gray-300 focus:border-black focus:ring-black" name="films[]" id="album-films" multiple>
                  {% for film in films %}
                    <option value="{{ film.id }}" {% if film.id in filmIds %}selected{% endif %}>{{ film.brand }} {{ film.name }}</option>
                  {% endfor %}
                </select>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-black mb-2">Sviluppatori</label>
                <select class="form-input border-gray-300 focus:border-black focus:ring-black" name="developers[]" id="album-developers" multiple>
                  {% for developer in developers %}
                    <option value="{{ developer.id }}" {% if developer.id in developerIds %}selected{% endif %}>{{ developer.name }}</option>
                  {% endfor %}
                </select>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-black mb-2">Laboratori</label>
                <select class="form-input border-gray-300 focus:border-black focus:ring-black" name="labs[]" id="album-labs" multiple>
                  {% for lab in labs %}
                    <option value="{{ lab.id }}" {% if lab.id in labIds %}selected{% endif %}>{{ lab.name }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>

          <!-- Locations and Security Card -->
          <div class="card">
            <div class="p-6 border-b border-gray-200">
              <h2 class="text-lg font-semibold text-black flex items-center">
                <i class="fas fa-map-marker-alt mr-3 text-gray-600"></i>
                Luoghi e Sicurezza
              </h2>
              <p class="text-gray-600 text-sm mt-1">Posizioni e protezione dell'album</p>
            </div>
            <div class="p-6 space-y-4">
              <div>
                <label class="block text-sm font-medium text-black mb-2">Luoghi di scatto</label>
                <select class="form-input border-gray-300 focus:border-black focus:ring-black" name="locations[]" id="album-locations" multiple>
                  {% for loc in locations %}
                    <option value="{{ loc.id }}" {% if loc.id in locationIds %}selected{% endif %}>{{ loc.name }}</option>
                  {% endfor %}
                </select>
                <p class="text-xs text-gray-500 mt-1">Seleziona uno o più luoghi dove è stato girato l'album</p>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-black mb-2">Password Album</label>
                <div class="space-y-3">
                  <input class="form-input border-gray-300 focus:border-black focus:ring-black" 
                         type="password" name="password" 
                         placeholder="Nuova password (lascia vuoto per mantenere)">
                  <label class="flex items-center gap-2">
                    <input class="h-4 w-4 text-black border-gray-300 rounded focus:ring-black" 
                           type="checkbox" name="password_clear">
                    <span class="text-sm text-gray-700">Rimuovi password esistente</span>
                  </label>
                </div>
                <p class="text-xs text-gray-500 mt-1">Proteggi l'album con una password</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Sticky Footer with Action Buttons -->
<div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-50">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <button type="submit" form="album-form" class="btn-primary">
          <i class="fas fa-save mr-2"></i>
          Salva Modifiche
        </button>
        <a href="/admin/albums" class="btn-secondary">
          <i class="fas fa-times mr-2"></i>
          Annulla
        </a>
      </div>
      
      <div class="flex items-center gap-3">
        <form method="post" action="/admin/albums/{{ item.id }}/delete" class="inline" 
              onsubmit="return confirm('Sei sicuro di voler eliminare questo album? Questa azione non può essere annullata.');">
          <input type="hidden" name="csrf" value="{{ csrf }}">
          <button type="submit" class="btn-outline-danger">
            <i class="fas fa-trash mr-2"></i>
            Elimina Album
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal edit image -->
<div id="image-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4">
  <div class="bg-white w-full max-w-5xl rounded-lg shadow-xl overflow-hidden max-h-[90vh] flex flex-col">
    <div class="px-6 py-4 border-b flex items-center justify-between bg-gray-50">
      <h3 class="text-xl font-semibold text-gray-900">Modifica immagine</h3>
      <button type="button" id="image-modal-close" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
    </div>
    <div class="flex flex-1 min-h-0">
      <!-- Image preview (larger column) -->
      <div class="w-2/3 bg-gray-100 flex items-center justify-center p-6">
        <img id="modal-preview" src="" alt="" class="max-w-full max-h-full object-contain rounded-lg shadow-lg">
      </div>
      <!-- Form + Actions (smaller column) -->
      <div class="w-1/3 flex flex-col bg-white min-h-0">
        <form id="image-form" method="post" class="flex-1 flex flex-col min-h-0">
          <input type="hidden" name="csrf" value="{{ csrf }}">
          <div class="p-4 flex-1 overflow-y-auto min-h-0">
            <div class="space-y-4">
              <!-- Image Actions -->
              <div class="space-y-3">
                <h4 class="font-medium text-gray-900 border-b border-gray-200 pb-1 text-sm">Azioni</h4>
                <div class="flex gap-2">
                  <button type="button" id="modal-cover-btn" class="flex-1 px-3 py-2 text-xs rounded border border-gray-300 text-gray-700 hover:bg-gray-50">
                    <i class="fas fa-image mr-1"></i>Cover
                  </button>
                  <button type="button" id="modal-delete-btn" class="flex-1 px-3 py-2 text-xs rounded border border-red-300 text-red-700 hover:bg-red-50">
                    <i class="fas fa-trash mr-1"></i>Elimina
                  </button>
                </div>
              </div>
              
              <!-- Basic Info -->
              <div class="space-y-3">
                <h4 class="font-medium text-gray-900 border-b border-gray-200 pb-1 text-sm">Informazioni base</h4>
                <div>
                  <label class="block text-xs font-medium text-gray-700 mb-1">Alt text *</label>
                  <input type="text" name="alt_text" id="f-alt" class="form-input w-full text-sm">
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-700 mb-1">Titolo/Caption</label>
                  <input type="text" name="caption" id="f-caption" class="form-input w-full text-sm">
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-700 mb-1">Location</label>
                  <select name="location_id" id="f-location" class="form-input w-full text-sm">
                    <option value="">Seleziona location...</option>
                    {% for loc in locations %}
                      <option value="{{ loc.id }}">{{ loc.name }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>

              <!-- Equipment -->
              <div class="space-y-3">
                <h4 class="font-medium text-gray-900 border-b border-gray-200 pb-1 text-sm">Attrezzatura</h4>
                <div>
                  <label class="block text-xs font-medium text-gray-700 mb-1">Camera</label>
                  <select name="camera_id" id="f-camera" class="form-input w-full text-sm">
                    <option value="">Seleziona camera...</option>
                    {% for camera in cameras %}
                      <option value="{{ camera.id }}">{{ camera.make }} {{ camera.model }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-700 mb-1">Lens</label>
                  <select name="lens_id" id="f-lens" class="form-input w-full text-sm">
                    <option value="">Seleziona lente...</option>
                    {% for lens in lenses %}
                      <option value="{{ lens.id }}">{{ lens.brand }} {{ lens.model }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-700 mb-1">Film</label>
                  <select name="film_id" id="f-film" class="form-input w-full text-sm">
                    <option value="">Seleziona pellicola...</option>
                    {% for film in films %}
                      <option value="{{ film.id }}">{{ film.brand }} {{ film.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-700 mb-1">Developer</label>
                  <select name="developer_id" id="f-developer" class="form-input w-full text-sm">
                    <option value="">Seleziona developer...</option>
                    {% for dev in developers %}
                      <option value="{{ dev.id }}">{{ dev.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-700 mb-1">Lab</label>
                  <select name="lab_id" id="f-lab" class="form-input w-full text-sm">
                    <option value="">Seleziona lab...</option>
                    {% for lab in labs %}
                      <option value="{{ lab.id }}">{{ lab.name }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>

              <!-- Custom Fields -->
              <div class="space-y-3">
                <h4 class="font-medium text-gray-900 border-b border-gray-200 pb-1 text-sm">Campi personalizzati</h4>
                <div>
                  <label class="block text-xs font-medium text-gray-700 mb-1">Custom camera</label>
                  <input type="text" name="custom_camera" id="f-custom-camera" class="form-input w-full text-sm">
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-700 mb-1">Custom lens</label>
                  <input type="text" name="custom_lens" id="f-custom-lens" class="form-input w-full text-sm">
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-700 mb-1">Custom film</label>
                  <input type="text" name="custom_film" id="f-custom-film" class="form-input w-full text-sm">
                </div>
              </div>

              <!-- Camera Settings -->
              <div class="space-y-3">
                <h4 class="font-medium text-gray-900 border-b border-gray-200 pb-1 text-sm">Impostazioni scatto</h4>
                <div class="grid grid-cols-3 gap-2">
                  <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">ISO</label>
                    <input type="number" name="iso" id="f-iso" class="form-input w-full text-sm">
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Shutter</label>
                    <input type="text" name="shutter_speed" id="f-shutter" class="form-input w-full text-sm" placeholder="1/125">
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Aperture</label>
                    <input type="number" step="0.1" name="aperture" id="f-aperture" class="form-input w-full text-sm" placeholder="2.8">
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="px-6 py-4 border-t bg-gray-50 flex items-center justify-end gap-3">
            <button type="button" id="image-cancel" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
              Annulla
            </button>
            <button type="submit" class="px-4 py-2 bg-black text-white rounded-md text-sm font-medium hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
              Salva modifiche
            </button>
          </div>
        </form>
      </div>
    </div>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.min.css">
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tinymce@6.8.3/tinymce.min.js" referrerpolicy="no-referrer"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <script>
    // TomSelects with proper form synchronization
    const tagSelect = new TomSelect('#album-tags',{
      plugins:['remove_button'],create:false,placeholder:'Seleziona tag...',
      valueField:'id',labelField:'name',searchField:'name',
      load: (q, cb) => { fetch('/admin/api/tags?q='+encodeURIComponent(q||''),{headers:{'Accept':'application/json'}}).then(r=>r.json()).then(cb).catch(()=>cb()); }
    });
    
    const categorySelect = new TomSelect('#album-categories',{plugins:['remove_button'],create:false,placeholder:'Seleziona categorie...'});
    const cameraSelect = new TomSelect('#album-cameras',{plugins:['remove_button'],create:false,placeholder:'Seleziona cameras...'});
    const lensSelect = new TomSelect('#album-lenses',{plugins:['remove_button'],create:false,placeholder:'Seleziona lenses...'});
    const filmSelect = new TomSelect('#album-films',{plugins:['remove_button'],create:false,placeholder:'Seleziona films...'});
    const developerSelect = new TomSelect('#album-developers',{plugins:['remove_button'],create:false,placeholder:'Seleziona developers...'});
    const labSelect = new TomSelect('#album-labs',{plugins:['remove_button'],create:false,placeholder:'Seleziona labs...'});
    const locationSelect = new TomSelect('#album-locations',{plugins:['remove_button'],create:false,placeholder:'Seleziona luoghi...'});
    
    // Ensure form synchronization before submit
    document.querySelector('form').addEventListener('submit', function(e) {
      // Force TomSelect to sync with original form fields
      tagSelect.sync();
      categorySelect.sync();
      cameraSelect.sync();
      lensSelect.sync();
      filmSelect.sync();
      developerSelect.sync();
      labSelect.sync();
      locationSelect.sync();
      
      console.log('Form submitting with tags:', document.getElementById('album-tags').value);
      console.log('Form submitting with cameras:', document.getElementById('album-cameras').value);
    });

    // Initialize TinyMCE
    if (window.tinymce) {
      tinymce.init({
        selector: 'textarea.richtext',
        menubar: false,
        statusbar: false,
        branding: false,
        plugins: 'link lists autoresize',
        toolbar: 'undo redo | styles | bold italic | bullist numlist | blockquote | link | removeformat',
        block_formats: 'Paragrafo=p; Sottotitolo=h3; Titolo sezione=h2; Nota=h4',
        default_link_target: '_blank',
        link_default_protocol: 'https',
        rel_list: [{title: 'noopener', value: 'noopener'},{title:'noreferrer', value:'noreferrer'}],
        content_css: false,
        content_style: 'body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; color:#111; line-height:1.7} a{color:#000; text-decoration:underline} blockquote{border-left:3px solid #e5e7eb; margin:1rem 0; padding-left:.75rem; color:#444}',
        valid_elements: 'p,br,strong/b,em/i,ul,ol,li,blockquote,a[href|target|rel],h2,h3,h4,hr',
        height: 480,
        skin: 'oxide',
        content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; font-size: 14px; color: #111827; }',
        toolbar_mode: 'wrap',
      });
    }

    // Sortable grid
    const grid = document.getElementById('images-grid');
    if (grid) {
      new Sortable(grid, { animation: 150, draggable: '[data-id]' });
    }

    // Sort helpers
    function sortGridBy(mode){
      if (!grid) return;
      const cards = Array.from(grid.children);
      const parseDate = (s) => new Date(s || '1970-01-01T00:00:00Z').getTime();
      cards.sort((a,b) => {
        switch(mode){
          case 'created_newest': return parseDate(b.dataset.created) - parseDate(a.dataset.created);
          case 'created_oldest': return parseDate(a.dataset.created) - parseDate(b.dataset.created);
          case 'id_asc': return (parseInt(a.dataset.id,10)||0) - (parseInt(b.dataset.id,10)||0);
          case 'id_desc': return (parseInt(b.dataset.id,10)||0) - (parseInt(a.dataset.id,10)||0);
          default: return 0;
        }
      });
      cards.forEach(c => grid.appendChild(c));
    }
    document.getElementById('sort-images')?.addEventListener('change', (e)=>{
      sortGridBy(e.target.value);
    });
    document.getElementById('save-order')?.addEventListener('click', async (e)=>{
      e.preventDefault(); if (!grid) return;
      const ids = Array.from(grid.querySelectorAll('[data-id]')).map(el=>el.getAttribute('data-id'));
      await fetch(grid.dataset.reorderEndpoint, {
        method:'POST', headers:{ 'Content-Type':'application/json', 'X-CSRF-Token': grid.dataset.csrf, 'Accept':'application/json' },
        body: JSON.stringify({ order: ids })
      });
    });

    // Upload area: click & DnD multiple
    const uploader = document.getElementById('uploader');
    const input = document.getElementById('file-input');
    if (uploader && input){
      uploader.addEventListener('click', ()=> input.click());
      ['dragover','dragleave'].forEach(ev=>uploader.addEventListener(ev, e=>{ e.preventDefault(); uploader.classList.toggle('bg-gray-50', ev==='dragover'); }));
      uploader.addEventListener('drop', async e=>{ e.preventDefault(); uploader.classList.remove('bg-gray-50'); await uploadFiles(Array.from(e.dataTransfer.files)); });
      input.addEventListener('change', async ()=>{ await uploadFiles(Array.from(input.files||[])); input.value=''; });
      async function uploadFiles(files){
        for (const f of files){
          const fd = new FormData(); fd.append('file', f);
          await fetch(uploader.dataset.endpoint, { method:'POST', headers:{ 'X-CSRF-Token': uploader.dataset.csrf, 'Accept':'application/json' }, body: fd });
        }
        location.reload();
      }
    }

    // Cover + Delete actions
    document.querySelectorAll('[data-cover-id]')?.forEach(btn => {
      btn.addEventListener('click', async () => {
        const imageId = btn.getAttribute('data-cover-id');
        await fetch(`/admin/albums/{{ item.id }}/cover/${imageId}`, { method:'POST', headers: { 'X-CSRF-Token':'{{ csrf }}', 'Accept':'application/json' }});
        location.reload();
      });
    });
    document.querySelectorAll('[data-delete-id]')?.forEach(btn => {
      btn.addEventListener('click', async () => {
        if(!confirm('Eliminare questa immagine?')) return;
        const imageId = btn.getAttribute('data-delete-id');
        const res = await fetch(`/admin/albums/{{ item.id }}/images/${imageId}/delete`, { method:'POST', headers: { 'X-CSRF-Token':'{{ csrf }}', 'Accept':'application/json' }});
        if (res.ok) {
          const card = btn.closest('[data-id]');
          card?.parentNode?.removeChild(card);
          if (window.showToast) showToast('Immagine eliminata', 'success');
        } else {
          if (window.showToast) showToast('Errore eliminazione', 'error');
        }
      });
    });

    // Bulk selection & delete
    const selectAll = document.getElementById('select-all');
    const bulkBtn = document.getElementById('bulk-delete');
    function getSelectedIds(){
      return Array.from(document.querySelectorAll('[data-select-id]:checked')).map(cb=>cb.getAttribute('data-select-id'));
    }
    function updateBulk(){ const any = getSelectedIds().length>0; if (bulkBtn) bulkBtn.disabled = !any; }
    selectAll?.addEventListener('change', ()=>{
      document.querySelectorAll('[data-select-id]').forEach(cb=>{ cb.checked = selectAll.checked; });
      updateBulk();
    });
    document.querySelectorAll('[data-select-id]').forEach(cb=>cb.addEventListener('change', updateBulk));
    bulkBtn?.addEventListener('click', async ()=>{
      const ids = getSelectedIds(); if (!ids.length) return; if (!confirm('Eliminare le immagini selezionate?')) return;
      const res = await fetch('/admin/albums/{{ item.id }}/images/bulk-delete', { method:'POST', headers:{ 'Content-Type':'application/json','X-CSRF-Token':'{{ csrf }}','Accept':'application/json' }, body: JSON.stringify({ ids })});
      if (res.ok) {
        ids.forEach(id=>{ const el = document.querySelector(`[data-id="${id}"]`); el?.parentNode?.removeChild(el); });
        if (window.showToast) showToast('Immagini eliminate', 'success');
      } else {
        if (window.showToast) showToast('Errore eliminazione', 'error');
      }
    });

    // Image modal logic
    (function(){
      const modal = document.getElementById('image-modal');
      const closeBtn = document.getElementById('image-modal-close');
      const cancelBtn = document.getElementById('image-cancel');
      const form = document.getElementById('image-form');
      let currentId = null;
      function openModal(){ modal.classList.remove('hidden'); modal.classList.add('flex'); }
      function closeModal(){ modal.classList.add('hidden'); modal.classList.remove('flex'); currentId=null; }
      function fillForm(data, imageBox){
        document.getElementById('f-alt').value = data.alt_text || '';
        document.getElementById('f-caption').value = data.caption || '';
        document.getElementById('f-camera').value = data.camera_id || '';
        document.getElementById('f-lens').value = data.lens_id || '';
        document.getElementById('f-film').value = data.film_id || '';
        document.getElementById('f-developer').value = data.developer_id || '';
        document.getElementById('f-lab').value = data.lab_id || '';
        document.getElementById('f-custom-camera').value = data.custom_camera || '';
        document.getElementById('f-custom-lens').value = data.custom_lens || '';
        document.getElementById('f-custom-film').value = data.custom_film || '';
        document.getElementById('f-iso').value = data.iso || '';
        document.getElementById('f-shutter').value = data.shutter_speed || '';
        document.getElementById('f-aperture').value = data.aperture || '';
        document.getElementById('f-location').value = data.location_id || '';
        
        // Update modal preview image
        const preview = document.getElementById('modal-preview');
        const imgElement = imageBox.querySelector('img');
        if (preview && imgElement) {
          // Use the preview image src instead of original_path
          preview.src = imgElement.src;
          preview.alt = data.alt_text || imgElement.alt || '';
        }
        
        // Update cover button state
        const coverBtn = document.getElementById('modal-cover-btn');
        if (coverBtn && imageBox) {
          const isCover = imageBox.querySelector('[data-cover-id].bg-green-600');
          coverBtn.className = isCover 
            ? 'flex-1 px-3 py-2 text-xs rounded border bg-green-600 text-white border-green-600'
            : 'flex-1 px-3 py-2 text-xs rounded border border-gray-300 text-gray-700 hover:bg-gray-50';
          coverBtn.innerHTML = isCover 
            ? '<i class="fas fa-check mr-1"></i>Cover attuale'
            : '<i class="fas fa-image mr-1"></i>Imposta Cover';
        }
      }
      
      // Image click handler for opening modal
      const grid = document.getElementById('images-grid');
      grid?.addEventListener('click', (e)=>{
        // Don't interfere with button clicks
        if (e.target.closest('[data-select-id]') || e.target.closest('[data-delete-id]') || e.target.closest('[data-cover-id]')) return;
        
        // Find the clicked image box
        const box = e.target.closest('[data-id]');
        if (!box) return;
        
        // Check if we clicked on the image area (not just anywhere in the card)
        const imageArea = e.target.closest('.aspect-square');
        if (!imageArea) return;
        
        const imageId = box.getAttribute('data-id');
        currentId = imageId;
        const data = {
          alt_text: box.getAttribute('data-alt_text'),
          caption: box.getAttribute('data-caption'),
          camera_id: box.getAttribute('data-camera_id'),
          lens_id: box.getAttribute('data-lens_id'),
          film_id: box.getAttribute('data-film_id'),
          developer_id: box.getAttribute('data-developer_id'),
          lab_id: box.getAttribute('data-lab_id'),
          location_id: box.getAttribute('data-location_id'),
          custom_camera: box.getAttribute('data-custom_camera'),
          custom_lens: box.getAttribute('data-custom_lens'),
          custom_film: box.getAttribute('data-custom_film'),
          iso: box.getAttribute('data-iso'),
          shutter_speed: box.getAttribute('data-shutter_speed'),
          aperture: box.getAttribute('data-aperture'),
        };
        fillForm(data, box); 
        openModal();
        if (form) form.action = `/admin/albums/{{ item.id }}/images/${currentId}/update`;
      });
      
      // Modal action buttons
      const modalCoverBtn = document.getElementById('modal-cover-btn');
      const modalDeleteBtn = document.getElementById('modal-delete-btn');
      
      modalCoverBtn?.addEventListener('click', async () => {
        if (!currentId) return;
        await fetch(`/admin/albums/{{ item.id }}/cover/${currentId}`, { method:'POST', headers: { 'X-CSRF-Token':'{{ csrf }}', 'Accept':'application/json' }});
        location.reload(); // Refresh to update cover status
      });
      
      modalDeleteBtn?.addEventListener('click', async () => {
        if (!currentId) return;
        if (!confirm('Eliminare questa immagine?')) return;
        const res = await fetch(`/admin/albums/{{ item.id }}/images/${currentId}/delete`, { method:'POST', headers: { 'X-CSRF-Token':'{{ csrf }}', 'Accept':'application/json' }});
        if (res.ok) {
          closeModal();
          const card = document.querySelector(`[data-id="${currentId}"]`);
          card?.parentNode?.removeChild(card);
          if (window.showToast) showToast('Immagine eliminata', 'success');
        } else {
          if (window.showToast) showToast('Errore eliminazione', 'error');
        }
      });
      
      // Form submit handler
      form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!currentId) return;
        
        const formData = new FormData(form);
        try {
          const response = await fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
              'Accept': 'application/json'
            }
          });
          
          if (response.ok) {
            closeModal();
            location.reload(); // Reload to show updated data
          } else {
            if (window.showToast) showToast('Errore nel salvataggio', 'error');
          }
        } catch (error) {
          console.error('Error saving image:', error);
          if (window.showToast) showToast('Errore nel salvataggio', 'error');
        }
      });
      
      closeBtn?.addEventListener('click', closeModal);
      cancelBtn?.addEventListener('click', closeModal);
    })();
  </script>
  <style>
    /* TomSelect wrapper - no z-index, natural stacking */
    .ts-wrapper {
      position: relative !important;
      background-color: #ffffff !important;
      border-radius: 0.375rem !important;
      width: 100% !important;
      display: block !important;
    }
    
    .ts-wrapper .ts-control {
      background-color: #ffffff !important;
      border: 1px solid #d1d5db !important;
      position: relative !important;
      width: 100% !important;
      min-height: 38px !important;
    }
    
    /* Only the dropdown should have high z-index */
    .ts-dropdown { 
      z-index: 99999 !important; 
      background-color: #ffffff !important; 
      border: 1px solid #d1d5db !important;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
      position: absolute !important;
      top: 100% !important;
      left: 0 !important;
      right: 0 !important;
      width: 100% !important;
      border-radius: 0.375rem !important;
      margin-top: 1px !important;
    }
    
    .ts-dropdown-content {
      z-index: 99999 !important;
      background-color: #ffffff !important;
      max-height: 200px !important;
      overflow-y: auto !important;
      width: 100% !important;
    }
    
    .ts-dropdown .option {
      background-color: #ffffff !important;
      color: #374151 !important;
      padding: 8px 12px !important;
      cursor: pointer !important;
      border: none !important;
      width: 100% !important;
      display: block !important;
      box-sizing: border-box !important;
      white-space: nowrap !important;
      overflow: hidden !important;
      text-overflow: ellipsis !important;
    }
    
    .ts-dropdown .option:hover,
    .ts-dropdown .option.active {
      background-color: #f3f4f6 !important;
      color: #111827 !important;
    }
    
    .ts-dropdown .option.selected {
      background-color: #3b82f6 !important;
      color: #ffffff !important;
    }
    
    /* Equipment section specific - no z-index for wrappers */
    #album-cameras + .ts-wrapper,
    #album-lenses + .ts-wrapper,
    #album-films + .ts-wrapper, 
    #album-developers + .ts-wrapper,
    #album-labs + .ts-wrapper {
      background-color: #ffffff !important;
      width: 100% !important;
    }
    
    /* Only dropdowns get high z-index */
    #album-cameras + .ts-wrapper .ts-dropdown,
    #album-lenses + .ts-wrapper .ts-dropdown,
    #album-films + .ts-wrapper .ts-dropdown,
    #album-developers + .ts-wrapper .ts-dropdown,
    #album-labs + .ts-wrapper .ts-dropdown {
      z-index: 99999 !important;
      position: absolute !important;
      width: 100% !important;
    }
    
    /* Equipment section normal stacking */
    .border-t.pt-4.mt-4 {
      position: relative !important;
      background-color: #ffffff !important;
    }
    
    /* Full width for all TomSelect elements */
    .ts-wrapper,
    .ts-wrapper .ts-control,
    .ts-wrapper input {
      width: 100% !important;
      box-sizing: border-box !important;
    }
    
    /* Additional ID-based targeting for full width */
    #album-cameras-ts-dropdown,
    #album-lenses-ts-dropdown,
    #album-films-ts-dropdown,
    #album-developers-ts-dropdown,
    #album-labs-ts-dropdown {
      z-index: 99999 !important;
      background-color: #ffffff !important;
      border: 1px solid #d1d5db !important;
      border-radius: 0.375rem !important;
      position: absolute !important;
      width: 100% !important;
      left: 0 !important;
      right: 0 !important;
    }
  </style>
{% endblock %}
