{% extends 'admin/_layout.twig' %}
{% block title %}{{ trans('admin.albums.new_album') }} — Cimaise{% endblock %}
{% block content %}
{# Hook: admin_album_create_before - Before the entire create page #}
{{ do_action('admin_album_create_before', {base_path: base_path}) }}

<div class="min-h-screen bg-gray-50 pb-24">
  <!-- Header -->
  <div class="bg-white border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold text-black">{{ trans('admin.albums.new_album') }}</h1>
          <p class="text-gray-600 mt-1">{{ trans('admin.albums.description') }}</p>
        </div>
        <div class="flex items-center gap-3">
          <a href="{{ base_path }}/admin/albums" class="btn-secondary">
            <i class="fas fa-arrow-left mr-2"></i>
            {{ trans('admin.albums.back_to_albums') }}
          </a>
          {# Hook: admin_album_create_header_actions - Add custom header buttons #}
          {{ do_action('admin_album_create_header_actions', {base_path: base_path}) }}
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <form id="album-form" method="post" action="{{ base_path }}/admin/albums">
      <input type="hidden" name="csrf" value="{{ csrf }}">
      
      <div class="grid grid-cols-1 xl:grid-cols-12 gap-8">
        <!-- Main Content Column -->
        <div class="xl:col-span-9 space-y-6">
          <!-- Basic Information Card -->
          <div class="card">
            <div class="p-6 border-b border-gray-200">
              <h2 class="text-lg font-semibold text-black flex items-center">
                <i class="fas fa-info-circle mr-3 text-gray-600"></i>
                {{ trans('admin.albums.basic_info') }}
              </h2>
              <p class="text-gray-600 text-sm mt-1">{{ trans('admin.albums.basic_info_desc') }}</p>
            </div>
            <div class="p-6 space-y-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-medium text-black mb-2">{{ trans('admin.albums.title_field') }} <span class="text-red-500">*</span></label>
                  <input class="form-input border-gray-300 focus:border-black focus:ring-black"
                         type="text" name="title" required
                         placeholder="{{ trans('admin.albums.title_placeholder') }}">
                </div>
                <div>
                  <label class="block text-sm font-medium text-black mb-2">{{ trans('admin.albums.slug_url') }}</label>
                  <input class="form-input border-gray-300 focus:border-black focus:ring-black font-mono text-sm"
                         type="text" name="slug"
                         placeholder="{{ trans('admin.albums.slug_placeholder') }}">
                  <p class="text-xs text-gray-500 mt-1">{{ trans('admin.albums.slug_help') }}</p>
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-medium text-black mb-2">{{ trans('admin.albums.categories') }} <span class="text-red-500">*</span></label>
                  <select name="categories[]" id="album-categories" class="form-input" multiple required>
                    {% for c in categories %}
                      <option value="{{ c.id }}">{{ c.name }}</option>
                    {% endfor %}
                  </select>
                  <p class="text-xs text-gray-500 mt-1">{{ trans('admin.albums.categories_help') }}</p>
                </div>
                <div>
                  <label class="block text-sm font-medium text-black mb-2">{{ trans('admin.albums.tags') }}</label>
                  <select class="form-input" name="tags[]" id="album-tags" multiple>
                    {% for t in tags %}
                      <option value="{{ t.id }}">{{ t.name }}</option>
                    {% endfor %}
                  </select>
                  <p class="text-xs text-gray-500 mt-1">{{ trans('admin.albums.tags_help') }}</p>
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-black mb-2">{{ trans('admin.albums.short_description') }}</label>
                <textarea class="form-input border-gray-300 focus:border-black focus:ring-black"
                          name="excerpt" rows="4"
                          placeholder="{{ trans('admin.albums.short_desc_placeholder') }}"
                          maxlength="150"></textarea>
                <p class="text-xs text-gray-500 mt-1">{{ trans('admin.albums.short_desc_help') }}</p>
              </div>

              <div>
                <label class="block text-sm font-medium text-black mb-2">{{ trans('admin.albums.full_content') }}</label>
                <textarea class="form-input richtext border-gray-300 focus:border-black focus:ring-black"
                          name="body" rows="32"
                          placeholder="{{ trans('admin.albums.full_content_placeholder') }}"></textarea>
                <p class="text-xs text-gray-500 mt-1">{{ trans('admin.albums.full_content_help') }}</p>
              </div>

              {# Hook: admin_album_create_form_basic_info_fields - Add custom fields inside basic info card #}
              {{ do_action('admin_album_create_form_basic_info_fields', {base_path: base_path}) }}
            </div>
          </div>

          {# Hook: admin_album_create_form_basic_info_after - Add custom cards after basic info #}
          {{ do_action('admin_album_create_form_basic_info_after', {base_path: base_path}) }}

          <!-- Upload Card -->
          <div class="card">
            <div class="p-6 border-b border-gray-200">
              <h2 class="text-lg font-semibold text-black flex items-center">
                <i class="fas fa-cloud-upload-alt mr-3 text-gray-600"></i>
                {{ trans('admin.albums.image_upload') }}
              </h2>
              <p class="text-gray-600 text-sm mt-1">{{ trans('admin.albums.image_upload_desc') }}</p>
            </div>
            <div class="p-6">
              <!-- Uppy Drag & Drop Upload -->
              <div id="uploader" class="w-full border-2 border-dashed border-gray-300 rounded-xl bg-gray-50 hover:bg-gray-100 hover:border-gray-400 transition-all flex items-center justify-center min-h-[200px] text-gray-600 cursor-pointer">
                <div class="text-center py-8">
                  <i class="fas fa-cloud-upload-alt text-4xl mb-4 text-gray-400"></i>
                  <div class="text-lg font-medium mb-1">{{ trans('admin.albums.drag_images') }}</div>
                  <div class="text-sm text-gray-500">{{ trans('admin.albums.or_click') }}</div>
                  <div class="text-xs text-gray-400 mt-2">{{ trans('admin.albums.file_types') }}</div>
                  <div class="text-xs text-blue-600 mt-3 font-medium">{{ trans('admin.albums.auto_create_hint') }}</div>
                </div>
              </div>

              <input type="file" id="file-input" multiple accept="image/*" class="hidden">

              <!-- Upload Progress Container -->
              <div id="upload-progress" class="hidden mt-4 space-y-3">
                <!-- Overall Progress -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                  <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-3">
                      <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-black"></div>
                      <span class="text-sm font-medium text-gray-900">{{ trans('admin.albums.uploading') }}</span>
                    </div>
                    <span class="text-sm text-gray-600" id="progress-counter">0 / 0</span>
                  </div>
                  <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="progress-bar-total" class="bg-black h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                  </div>
                  <div class="text-xs text-gray-500 mt-2" id="progress-text">{{ trans('admin.albums.preparing_upload') }}</div>
                </div>

                <!-- Individual File Progress List -->
                <div id="file-progress-list" class="space-y-2 max-h-64 overflow-y-auto"></div>
              </div>

              <!-- Uploaded Images Preview Grid -->
              <div id="uploaded-images-container" class="hidden mt-4">
                <div class="flex items-center justify-between mb-3">
                  <h4 class="text-sm font-medium text-gray-700">
                    <i class="fas fa-check-circle text-green-500 mr-2"></i>
                    {{ trans('admin.albums.uploaded_images') }} (<span id="uploaded-count">0</span>)
                  </h4>
                  <button type="button" id="add-more-images" class="text-sm text-blue-600 hover:text-blue-800">
                    <i class="fas fa-plus mr-1"></i>{{ trans('admin.albums.add_more_images') }}
                  </button>
                </div>
                <div id="uploaded-images-grid" class="grid grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2 max-h-64 overflow-y-auto p-2 bg-gray-50 rounded-lg border border-gray-200">
                  <!-- Uploaded image thumbnails will be inserted here -->
                </div>
              </div>

              <!-- Validation Notice -->
              <div class="mt-4 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                <div class="flex items-start gap-2">
                  <i class="fas fa-info-circle text-amber-600 mt-0.5"></i>
                  <div class="text-sm text-amber-800">
                    <div class="font-medium">{{ trans('admin.albums.before_upload') }}</div>
                    <ul class="list-disc list-inside mt-1 text-xs space-y-0.5">
                      <li>{{ trans('admin.albums.select_category') }}</li>
                      <li>{{ trans('admin.albums.images_auto_upload') }}</li>
                      <li>{{ trans('admin.albums.multiple_batches') }}</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {# Hook: admin_album_create_form_main_after - Add custom cards after all main content #}
          {{ do_action('admin_album_create_form_main_after', {base_path: base_path}) }}
        </div>

        <!-- Sidebar -->
        <div class="xl:col-span-3 space-y-6">
          {# Hook: admin_album_create_sidebar_before - Before sidebar cards #}
          {{ do_action('admin_album_create_sidebar_before', {base_path: base_path}) }}

          <!-- Publishing Settings Card -->
          <div class="card">
            <div class="p-6 border-b border-gray-200">
              <h2 class="text-lg font-semibold text-black flex items-center">
                <i class="fas fa-globe mr-3 text-gray-600"></i>
                {{ trans('admin.albums.publishing') }}
              </h2>
              <p class="text-gray-600 text-sm mt-1">{{ trans('admin.albums.publishing_desc') }}</p>
            </div>
            <div class="p-6 space-y-4">
              <div>
                <label class="block text-sm font-medium text-black mb-2">{{ trans('admin.albums.shoot_date') }}</label>
                <input class="form-input border-gray-300 focus:border-black focus:ring-black"
                       type="date" name="shoot_date">
              </div>

              <div>
                <label class="block text-sm font-medium text-black mb-2">{{ trans('admin.albums.order') }}</label>
                <input class="form-input border-gray-300 focus:border-black focus:ring-black"
                       type="number" name="sort_order" value="0"
                       placeholder="0">
              </div>

              <div>
                <label class="block text-sm font-medium text-black mb-2">{{ trans('admin.albums.template') }}</label>
                <select class="form-input border-gray-300 focus:border-black focus:ring-black" name="template_id">
                  <option value="">{{ trans('admin.albums.default_template') }}</option>
                  {% for template in templates %}
                    <option value="{{ template.id }}">{{ template.name }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="space-y-3">
                <label class="flex items-center gap-3">
                  <input class="h-4 w-4 text-black border-gray-300 rounded focus:ring-black"
                         type="checkbox" name="show_date" id="show_date" checked>
                  <span class="text-sm font-medium text-gray-700">{{ trans('admin.albums.show_date') }}</span>
                </label>

                <label class="flex items-center gap-3">
                  <input class="h-4 w-4 text-black border-gray-300 rounded focus:ring-black"
                         type="checkbox" name="is_published" id="pub" checked>
                  <span class="text-sm font-medium text-gray-700">{{ trans('admin.albums.album_published') }}</span>
                </label>

                <label class="flex items-center gap-3">
                  <input class="h-4 w-4 text-black border-gray-300 rounded focus:ring-black"
                         type="checkbox" name="allow_downloads" id="allow_downloads">
                  <span class="text-sm font-medium text-gray-700">{{ trans('admin.albums.allow_downloads') }}</span>
                </label>

                <label class="flex items-center gap-3">
                  <input class="h-4 w-4 text-amber-600 border-gray-300 rounded focus:ring-amber-500"
                         type="checkbox" name="is_nsfw" id="is_nsfw">
                  <span class="text-sm font-medium text-gray-700">{{ trans('admin.albums.nsfw_content') }}</span>
                </label>
                <p class="text-xs text-gray-500 ml-7">{{ trans('admin.albums.nsfw_help') }}</p>
              </div>
            </div>
          </div>

          {# Hook: admin_album_create_sidebar_publishing_after - After publishing settings card #}
          {{ do_action('admin_album_create_sidebar_publishing_after', {base_path: base_path}) }}

          <!-- Equipment Card -->
          <div class="card">
            <div class="p-6 border-b border-gray-200">
              <h2 class="text-lg font-semibold text-black flex items-center">
                <i class="fas fa-camera mr-3 text-gray-600"></i>
                {{ trans('admin.albums.equipment') }}
              </h2>
              <p class="text-gray-600 text-sm mt-1">{{ trans('admin.albums.equipment_desc') }}</p>
            </div>
            <div class="p-6 space-y-4">
              <div>
                <label class="block text-sm font-medium text-black mb-2">{{ trans('admin.albums.cameras') }}</label>
                <select class="form-input border-gray-300 focus:border-black focus:ring-black" name="cameras[]" id="album-cameras" multiple>
                  {% for camera in cameras %}
                    <option value="{{ camera.id }}">{{ camera.make }} {{ camera.model }}</option>
                  {% endfor %}
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-black mb-2">{{ trans('admin.albums.lenses') }}</label>
                <select class="form-input border-gray-300 focus:border-black focus:ring-black" name="lenses[]" id="album-lenses" multiple>
                  {% for lens in lenses %}
                    <option value="{{ lens.id }}">{{ lens.brand }} {{ lens.model }}</option>
                  {% endfor %}
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-black mb-2">{{ trans('admin.albums.films') }}</label>
                <select class="form-input border-gray-300 focus:border-black focus:ring-black" name="films[]" id="album-films" multiple>
                  {% for film in films %}
                    <option value="{{ film.id }}">{{ film.brand }} {{ film.name }}</option>
                  {% endfor %}
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-black mb-2">{{ trans('admin.albums.developers') }}</label>
                <select class="form-input border-gray-300 focus:border-black focus:ring-black" name="developers[]" id="album-developers" multiple>
                  {% for developer in developers %}
                    <option value="{{ developer.id }}">{{ developer.name }}</option>
                  {% endfor %}
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-black mb-2">{{ trans('admin.albums.labs') }}</label>
                <select class="form-input border-gray-300 focus:border-black focus:ring-black" name="labs[]" id="album-labs" multiple>
                  {% for lab in labs %}
                    <option value="{{ lab.id }}">{{ lab.name }}</option>
                  {% endfor %}
                </select>
              </div>

              {# Hook: admin_album_create_equipment_fields - Add custom equipment fields (film types, accessories, etc.) #}
              {{ do_action('admin_album_create_equipment_fields', {base_path: base_path, cameras: cameras, lenses: lenses, films: films, developers: developers, labs: labs}) }}
            </div>
          </div>

          {# Hook: admin_album_create_sidebar_equipment_after - After equipment card (add custom metadata cards) #}
          {{ do_action('admin_album_create_sidebar_equipment_after', {base_path: base_path}) }}

          <!-- Locations and Security Card -->
          <div class="card">
            <div class="p-6 border-b border-gray-200">
              <h2 class="text-lg font-semibold text-black flex items-center">
                <i class="fas fa-map-marker-alt mr-3 text-gray-600"></i>
                {{ trans('admin.albums.locations_security') }}
              </h2>
              <p class="text-gray-600 text-sm mt-1">{{ trans('admin.albums.locations_security_desc') }}</p>
            </div>
            <div class="p-6 space-y-4">
              <div>
                <label class="block text-sm font-medium text-black mb-2">{{ trans('admin.albums.shooting_locations') }}</label>
                <select class="form-input border-gray-300 focus:border-black focus:ring-black" name="locations[]" id="album-locations" multiple>
                  {% for loc in locations %}
                    <option value="{{ loc.id }}">{{ loc.name }}</option>
                  {% endfor %}
                </select>
                <p class="text-xs text-gray-500 mt-1">{{ trans('admin.albums.locations_help') }}</p>
              </div>

              <div>
                <label class="block text-sm font-medium text-black mb-2">{{ trans('admin.albums.password') }}</label>
                <input class="form-input border-gray-300 focus:border-black focus:ring-black"
                       type="password" name="password"
                       placeholder="{{ trans('admin.albums.password_placeholder') }}" autocomplete="new-password">
                <p class="text-xs text-gray-500 mt-1">{{ trans('admin.albums.password_help') }}</p>
              </div>
            </div>
          </div>

          {# Hook: admin_album_create_sidebar_after - Add custom sidebar cards at the end #}
          {{ do_action('admin_album_create_sidebar_after', {base_path: base_path}) }}
        </div>
      </div>

      {# Hook: admin_album_create_form_end - Add hidden inputs or custom form elements #}
      {{ do_action('admin_album_create_form_end', {base_path: base_path}) }}
    </form>
  </div>
</div>

<!-- Sticky Footer with Action Buttons -->
<div class="fixed bottom-0 left-64 right-0 bg-white border-t border-gray-200 shadow-lg z-50">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <button type="submit" form="album-form" class="btn-primary">
          <i class="fas fa-save mr-2"></i>
          {{ trans('admin.albums.create_album') }}
        </button>
        <a href="{{ base_path }}/admin/albums" class="btn-secondary">
          <i class="fas fa-times mr-2"></i>
          {{ trans('admin.common.cancel') }}
        </a>
      </div>

      <div class="flex items-center gap-3">
        {# Hook: admin_album_create_footer_actions - Add custom action buttons #}
        {{ do_action('admin_album_create_footer_actions', {base_path: base_path}) }}

        <span class="text-sm text-gray-500">
          <i class="fas fa-info-circle mr-1"></i>
          {{ trans('admin.albums.footer_hint') }}
        </span>
      </div>
    </div>
  </div>
</div>

{# Hook: admin_album_create_after - After the entire page (for modals, scripts, etc.) #}
{{ do_action('admin_album_create_after', {base_path: base_path}) }}

  <!-- Modal edit image (for when images are present after upload) -->
  <div id="image-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
    <div class="bg-white w-full max-w-2xl rounded shadow-lg overflow-hidden">
      <div class="px-5 py-3 border-b flex items-center justify-between">
        <h3 class="text-lg font-medium">{{ trans('admin.albums.edit_image') }}</h3>
        <button type="button" id="image-modal-close" class="text-gray-500 hover:text-black">✕</button>
      </div>
      <form id="image-form" method="post">
        <input type="hidden" name="csrf" value="{{ csrf }}">
        <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">{{ trans('admin.albums.alt_text') }}</label>
            <input type="text" name="alt_text" id="f-alt" class="form-input">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">{{ trans('admin.albums.caption') }}</label>
            <input type="text" name="caption" id="f-caption" class="form-input">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">{{ trans('admin.albums.camera') }}</label>
            <select name="camera_id" id="f-camera" class="form-input">
              <option value="">—</option>
              {% for camera in cameras %}
                <option value="{{ camera.id }}">{{ camera.make }} {{ camera.model }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">{{ trans('admin.albums.lens') }}</label>
            <select name="lens_id" id="f-lens" class="form-input">
              <option value="">—</option>
              {% for lens in lenses %}
                <option value="{{ lens.id }}">{{ lens.brand }} {{ lens.model }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">{{ trans('admin.albums.film') }}</label>
            <select name="film_id" id="f-film" class="form-input">
              <option value="">—</option>
              {% for film in films %}
                <option value="{{ film.id }}">{{ film.brand }} {{ film.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">{{ trans('admin.albums.developer') }}</label>
            <select name="developer_id" id="f-developer" class="form-input">
              <option value="">—</option>
              {% for dev in developers %}
                <option value="{{ dev.id }}">{{ dev.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">{{ trans('admin.albums.lab') }}</label>
            <select name="lab_id" id="f-lab" class="form-input">
              <option value="">—</option>
              {% for lab in labs %}
                <option value="{{ lab.id }}">{{ lab.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">{{ trans('admin.albums.location') }}</label>
            <select name="location_id" id="f-location" class="form-input">
              <option value="">—</option>
              {% for loc in locations %}
                <option value="{{ loc.id }}">{{ loc.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">{{ trans('admin.albums.custom_camera') }}</label>
            <input type="text" name="custom_camera" id="f-custom-camera" class="form-input">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">{{ trans('admin.albums.custom_lens') }}</label>
            <input type="text" name="custom_lens" id="f-custom-lens" class="form-input">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">{{ trans('admin.albums.custom_film') }}</label>
            <input type="text" name="custom_film" id="f-custom-film" class="form-input">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">{{ trans('admin.albums.iso') }}</label>
            <input type="number" name="iso" id="f-iso" class="form-input">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">{{ trans('admin.albums.shutter') }}</label>
            <input type="text" name="shutter_speed" id="f-shutter" class="form-input" placeholder="1/125">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">{{ trans('admin.albums.aperture') }}</label>
            <input type="number" step="0.1" name="aperture" id="f-aperture" class="form-input" placeholder="2.8">
          </div>
        </div>
        <div class="px-5 py-3 border-t flex items-center justify-end gap-2">
          <button type="button" id="image-cancel" class="btn-secondary">{{ trans('admin.common.cancel') }}</button>
          <button type="submit" class="btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
  <script nonce="{{ csp_nonce() }}">
    // TomSelect + TinyMCE are initialized by the Vite bundle (resources/admin.js)
  </script>
  
  <script nonce="{{ csp_nonce() }}">
    // Album create page initialization - Compatible with SPA
    function initializeAlbumCreatePage() {
      // Prevent double initialization
      if (window.albumCreatePageInitialized) {
        console.log('Album create page already initialized, skipping...');
        return;
      }
      
      console.log('Initializing Album create page...');
      
      // Initialize upload functionality
      initUploadFunctionality();
      
      // Mark as initialized
      window.albumCreatePageInitialized = true;
      console.log('Album create page initialization completed');
    }
    
    function initUploadFunctionality() {
      // Get elements
      const form = document.getElementById('album-form');
      const uploader = document.getElementById('uploader');
      const input = document.getElementById('file-input');
      const progressDiv = document.getElementById('upload-progress');
      const progressText = document.getElementById('progress-text');
      
      if (!form || !uploader || !input) {
        console.warn('Upload elements not found');
        return;
      }
      
      // Prevent double initialization
      if (uploader._uploadInitialized) {
        console.log('Upload functionality already initialized, skipping...');
        return;
      }
      
      const csrf = form.querySelector('input[name="csrf"]')?.value;
      let createdAlbumId = null;
      let isUploading = false;

      // Progress elements
      const progressCounter = document.getElementById('progress-counter');
      const progressBarTotal = document.getElementById('progress-bar-total');
      const fileProgressList = document.getElementById('file-progress-list');

      // Uploaded images preview elements
      const uploadedContainer = document.getElementById('uploaded-images-container');
      const uploadedGrid = document.getElementById('uploaded-images-grid');
      const uploadedCount = document.getElementById('uploaded-count');
      const addMoreBtn = document.getElementById('add-more-images');
      let totalUploadedImages = 0;

      // "Add more images" button handler
      if (addMoreBtn) {
        addMoreBtn.addEventListener('click', () => {
          if (!isUploading) input.click();
        });
      }

      function showProgress(text) {
        if (progressDiv && progressText) {
          progressText.textContent = text;
          progressDiv.classList.remove('hidden');
        }
      }

      function hideProgress() {
        if (progressDiv) {
          progressDiv.classList.add('hidden');
        }
        // Clear file progress list
        if (fileProgressList) {
          fileProgressList.innerHTML = '';
        }
      }

      function updateTotalProgress(completed, total) {
        if (progressCounter) {
          progressCounter.textContent = `${completed} / ${total}`;
        }
        if (progressBarTotal) {
          const percent = total > 0 ? (completed / total) * 100 : 0;
          progressBarTotal.style.width = `${percent}%`;
        }
      }

      function createFileProgressElement(file, index) {
        // Sanitize filename to prevent XSS
        const safeName = file.name.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        const div = document.createElement('div');
        div.id = `file-progress-${index}`;
        div.className = 'bg-white border border-gray-200 rounded-lg p-3';
        div.innerHTML = `
          <div class="flex items-center justify-between mb-1">
            <span class="text-sm text-gray-700 truncate flex-1 mr-2" title="${safeName}">
              <i class="fas fa-image text-gray-400 mr-2"></i>${safeName}
            </span>
            <span class="text-xs text-gray-500 file-status">Waiting...</span>
          </div>
          <div class="w-full bg-gray-100 rounded-full h-1.5">
            <div class="file-progress-bar bg-gray-400 h-1.5 rounded-full transition-all duration-150" style="width: 0%"></div>
          </div>
        `;
        return div;
      }

      function updateFileProgress(index, percent, status) {
        const div = document.getElementById(`file-progress-${index}`);
        if (!div) return;

        const bar = div.querySelector('.file-progress-bar');
        const statusEl = div.querySelector('.file-status');

        if (bar) {
          bar.style.width = `${percent}%`;
          if (percent > 0 && percent < 100) {
            bar.className = 'file-progress-bar bg-black h-1.5 rounded-full transition-all duration-150';
          } else if (percent >= 100) {
            bar.className = 'file-progress-bar bg-green-500 h-1.5 rounded-full transition-all duration-150';
          }
        }

        if (statusEl && status) {
          statusEl.textContent = status;
          if (status.includes('Completed')) {
            statusEl.className = 'text-xs text-green-600 file-status';
          } else if (status.includes('Error')) {
            statusEl.className = 'text-xs text-red-600 file-status';
            if (bar) bar.className = 'file-progress-bar bg-red-500 h-1.5 rounded-full transition-all duration-150';
          } else {
            statusEl.className = 'text-xs text-gray-500 file-status';
          }
        }
      }

      function addImageToGrid(imageData, file) {
        if (!uploadedGrid || !uploadedContainer) return;

        // Show the container
        uploadedContainer.classList.remove('hidden');

        // Create thumbnail element
        const thumb = document.createElement('div');
        thumb.className = 'relative aspect-square bg-gray-200 rounded overflow-hidden group';

        // Use the thumbnail from response or create from file
        let imgSrc = '';
        if (imageData && imageData.thumb) {
          imgSrc = `{{ base_path }}${imageData.thumb}`;
        } else if (file) {
          imgSrc = URL.createObjectURL(file);
        }

        if (imgSrc) {
          thumb.innerHTML = `
            <img src="${imgSrc}" alt="" class="w-full h-full object-cover">
            <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition"></div>
          `;
        } else {
          thumb.innerHTML = `
            <div class="w-full h-full flex items-center justify-center">
              <i class="fas fa-image text-gray-400"></i>
            </div>
          `;
        }

        uploadedGrid.appendChild(thumb);

        // Update count
        totalUploadedImages++;
        if (uploadedCount) {
          uploadedCount.textContent = totalUploadedImages;
        }
      }

      function updateFormForEdit(albumId) {
        // Update form action to edit endpoint
        if (form) {
          form.action = `{{ base_path }}/admin/albums/${albumId}`;
          // Add method override for PUT
          let methodInput = form.querySelector('input[name="_method"]');
          if (!methodInput) {
            methodInput = document.createElement('input');
            methodInput.type = 'hidden';
            methodInput.name = '_method';
            form.appendChild(methodInput);
          }
          methodInput.value = 'PUT';
        }

        // Update submit button text
        const submitBtn = document.querySelector('button[type="submit"][form="album-form"]');
        if (submitBtn) {
          submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Save Album';
        }

        // Update page title
        const pageTitle = document.querySelector('h1.text-3xl');
        if (pageTitle) {
          pageTitle.textContent = 'Edit Album';
        }

        // Update uploader text
        const uploaderText = uploader.querySelector('.text-xs.text-blue-600');
        if (uploaderText) {
          uploaderText.textContent = 'Drop more images to add to album';
        }

        // Add "Continue to full edit" button in footer
        const footerActions = document.querySelector('.fixed.bottom-0 .flex.items-center.gap-3');
        if (footerActions && !document.getElementById('continue-edit-btn')) {
          const continueBtn = document.createElement('a');
          continueBtn.id = 'continue-edit-btn';
          continueBtn.href = `{{ base_path }}/admin/albums/${albumId}/edit`;
          continueBtn.className = 'btn-secondary';
          continueBtn.innerHTML = '<i class="fas fa-edit mr-2"></i>Full Edit Page';
          footerActions.appendChild(continueBtn);
        }
      }
      
      function gatherFormData(){
        const fd = new URLSearchParams();
        new FormData(form).forEach((v,k)=>{ 
          if(k!=='csrf') fd.append(k, typeof v === 'string' ? v : String(v)); 
        });
        return fd.toString();
      }

      function prepareCreatePayload(){
        const formData = new FormData(form);
        // Require at least one category; title is optional
        const cats = formData.getAll('categories[]');
        if (!cats || cats.length === 0) {
          throw new Error('missing_category');
        }
        // Auto-title if missing
        let title = (formData.get('title') || '').toString().trim();
        if (!title) {
          const d = new Date();
          title = 'Album ' + d.toLocaleDateString('it-IT') + ' ' + d.toLocaleTimeString('it-IT');
          formData.set('title', title);
        }
        // Build payload
        const enc = new URLSearchParams();
        formData.forEach((v,k)=>{ if (k !== 'csrf') enc.append(k, typeof v === 'string' ? v : String(v)); });
        return enc.toString();
      }
      
      async function ensureAlbumId(){
        if (createdAlbumId) return createdAlbumId;
        
        showProgress('Creating album...');
        
        let body;
        try { body = prepareCreatePayload(); } catch(e){
          if (e && e.message === 'missing_category') {
            if (window.showToast) showToast('Select at least one Category', 'error'); else alert('Select at least one Category');
            hideProgress();
            throw e;
          }
          throw e;
        }
        const res = await fetch(form.action, { 
          method:'POST', 
          headers:{ 
            'Content-Type':'application/x-www-form-urlencoded', 
            'X-CSRF-Token': csrf, 
            'Accept':'application/json' 
          }, 
          body 
        });
        
        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(`Album creation error: ${res.status} ${errorText}`);
        }
        
        const data = await res.json();
        if (!data || !data.id) throw new Error('Album creation failed');
        createdAlbumId = data.id;
        return createdAlbumId;
      }
      
      // Remove existing listeners to prevent duplicates
      uploader.removeEventListener('click', handleUploaderClick);
      uploader.removeEventListener('dragover', handleDragOver);
      uploader.removeEventListener('dragleave', handleDragLeave);
      uploader.removeEventListener('drop', handleDrop);
      input.removeEventListener('change', handleInputChange);
      
      // Add event listeners
      uploader.addEventListener('click', handleUploaderClick);
      uploader.addEventListener('dragover', handleDragOver);
      uploader.addEventListener('dragleave', handleDragLeave);
      uploader.addEventListener('drop', handleDrop);
      input.addEventListener('change', handleInputChange);
      
      function handleUploaderClick() {
        if (isUploading) return;
        input.click();
      }
      
      function handleDragOver(e) {
        e.preventDefault();
        if (!isUploading) {
          uploader.classList.add('bg-gray-100', 'border-blue-400');
        }
      }
      
      function handleDragLeave(e) {
        e.preventDefault();
        uploader.classList.remove('bg-gray-100', 'border-blue-400');
      }
      
      async function handleDrop(e) {
        e.preventDefault();
        uploader.classList.remove('bg-gray-100', 'border-blue-400');
        if (!e.dataTransfer || isUploading) return;
        const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
        await uploadFiles(files);
      }
      
      async function handleInputChange() {
        if (isUploading) return;
        const files = Array.from(input.files||[]).filter(f => f.type.startsWith('image/'));
        await uploadFiles(files);
        input.value='';
      }
      
      function uploadFileWithProgress(file, albumId, index) {
        return new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest();
          const fd = new FormData();
          fd.append('file', file);

          // Set timeout for large file uploads (5 minutes)
          xhr.timeout = 300000;

          xhr.upload.addEventListener('progress', (e) => {
            if (e.lengthComputable) {
              const percent = Math.round((e.loaded / e.total) * 100);
              updateFileProgress(index, percent, `${percent}%`);
            }
          });

          xhr.addEventListener('load', () => {
            if (xhr.status >= 200 && xhr.status < 300) {
              updateFileProgress(index, 100, 'Completed ✓');
              try {
                resolve(JSON.parse(xhr.responseText));
              } catch {
                resolve({});
              }
            } else {
              updateFileProgress(index, 100, 'Error ✗');
              reject(new Error(`Upload failed: ${xhr.status}`));
            }
          });

          xhr.addEventListener('error', () => {
            updateFileProgress(index, 100, 'Error ✗');
            reject(new Error('Network error'));
          });

          xhr.addEventListener('timeout', () => {
            updateFileProgress(index, 0, 'Timeout ✗');
            reject(new Error('Upload timeout'));
          });

          xhr.open('POST', `{{ base_path }}/admin/albums/${albumId}/upload`);
          xhr.setRequestHeader('X-CSRF-Token', csrf);
          xhr.setRequestHeader('Accept', 'application/json');
          xhr.send(fd);

          updateFileProgress(index, 0, 'Uploading...');
        });
      }

      async function uploadFiles(files){
        if (!files.length) return;
        if (isUploading) return;

        // Validation: require at least one category. Title is optional.
        const fdCheck = new FormData(form);
        const cats = fdCheck.getAll('categories[]');
        const hasCat = cats && cats.length > 0;
        if (!hasCat) {
          if (window.showToast) showToast('Select at least one Category', 'error'); else alert('Select at least one Category');
          return;
        }

        isUploading = true;
        uploader.classList.add('pointer-events-none', 'opacity-50');

        // Clear and prepare progress list
        if (fileProgressList) {
          fileProgressList.innerHTML = '';
          files.forEach((file, index) => {
            fileProgressList.appendChild(createFileProgressElement(file, index));
          });
        }

        showProgress('Preparing upload...');
        updateTotalProgress(0, files.length);

        try {
          const id = await ensureAlbumId();
          let completedCount = 0;
          let firstImageId = null;

          // Track uploaded images for grid display
          const uploadedImages = [];

          // Upload files sequentially with visual progress
          for (let i = 0; i < files.length; i++) {
            const f = files[i];
            showProgress(`Uploading ${i + 1} of ${files.length}...`);

            try {
              const result = await uploadFileWithProgress(f, id, i);
              completedCount++;
              updateTotalProgress(completedCount, files.length);

              // Save first image ID for cover (only if this is the first batch)
              if (totalUploadedImages === 0 && i === 0 && result && result.id) {
                firstImageId = result.id;
              }

              // Track for grid display
              uploadedImages.push({ data: result, file: f });
            } catch (error) {
              console.error(`Upload error ${f.name}:`, error);
              completedCount++;
              updateTotalProgress(completedCount, files.length);
            }
          }

          // Set first image as cover (only on first batch)
          if (firstImageId && totalUploadedImages === 0) {
            showProgress('Setting cover...');
            try {
              const coverRes = await fetch(`{{ base_path }}/admin/albums/${id}/cover/${firstImageId}`, {
                method: 'POST',
                headers: { 'X-CSRF-Token': csrf, 'Accept': 'application/json' }
              });
              if (!coverRes.ok) {
                console.error('Error setting cover:', coverRes.status);
              }
            } catch (coverError) {
              console.error('Error setting cover:', coverError);
              // Non-fatal: continue anyway, album is created
            }
          }

          // Add uploaded images to the preview grid
          uploadedImages.forEach(({ data, file }) => {
            addImageToGrid(data, file);
          });

          // Update form to work as edit form after first upload
          updateFormForEdit(id);

          showProgress('Upload complete!');

          // Show success message if available
          if (window.showToast) {
            showToast(`${files.length} images uploaded!`, 'success');
          }

          // Hide progress after a short delay and re-enable uploader
          setTimeout(() => {
            hideProgress();
            isUploading = false;
            uploader.classList.remove('pointer-events-none', 'opacity-50');
          }, 1500);

        } catch (error) {
          console.error('Upload error:', error);
          const message = error.message || 'Error during upload';
          if (window.showToast) {
            showToast(message, 'error');
          } else {
            alert(message);
          }

          hideProgress();
          isUploading = false;
          uploader.classList.remove('pointer-events-none', 'opacity-50');
        }
      }
      
      // Mark as initialized
      uploader._uploadInitialized = true;
      console.log('Upload functionality initialized successfully');
    }
    
    // Make initialization function globally available for SPA re-initialization
    if (!window.pageInitializers) {
      window.pageInitializers = {};
    }
    window.pageInitializers.albumsCreate = initializeAlbumCreatePage;
    
    // Single initialization - avoid duplicates
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeAlbumCreatePage);
    } else {
      initializeAlbumCreatePage();
    }
  </script>
  <style>
    /* TomSelect wrapper - no z-index, natural stacking */
    .ts-wrapper {
      position: relative !important;
      background-color: #ffffff !important;
      border-radius: 0.375rem !important;
      width: 100% !important;
      display: block !important;
    }
    
    .ts-wrapper .ts-control {
      background-color: #ffffff !important;
      border: 1px solid #d1d5db !important;
      position: relative !important;
      width: 100% !important;
      min-height: 38px !important;
    }
    
    /* Only the dropdown should have high z-index */
    .ts-dropdown { 
      z-index: 99999 !important; 
      background-color: #ffffff !important; 
      border: 1px solid #d1d5db !important;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
      position: absolute !important;
      top: 100% !important;
      left: 0 !important;
      right: 0 !important;
      width: 100% !important;
      border-radius: 0.375rem !important;
      margin-top: 1px !important;
    }
    
    .ts-dropdown-content {
      z-index: 99999 !important;
      background-color: #ffffff !important;
      max-height: 200px !important;
      overflow-y: auto !important;
      width: 100% !important;
    }
    
    .ts-dropdown .option {
      background-color: #ffffff !important;
      color: #374151 !important;
      padding: 8px 12px !important;
      cursor: pointer !important;
      border: none !important;
      width: 100% !important;
      display: block !important;
      box-sizing: border-box !important;
      white-space: nowrap !important;
      overflow: hidden !important;
      text-overflow: ellipsis !important;
    }
    
    .ts-dropdown .option:hover,
    .ts-dropdown .option.active {
      background-color: #f3f4f6 !important;
      color: #111827 !important;
    }
    
    .ts-dropdown .option.selected {
      background-color: #3b82f6 !important;
      color: #ffffff !important;
    }
    
    /* Equipment section specific - no z-index for wrappers */
    #album-cameras + .ts-wrapper,
    #album-lenses + .ts-wrapper,
    #album-films + .ts-wrapper, 
    #album-developers + .ts-wrapper,
    #album-labs + .ts-wrapper {
      background-color: #ffffff !important;
      width: 100% !important;
    }
    
    /* Only dropdowns get high z-index */
    #album-cameras + .ts-wrapper .ts-dropdown,
    #album-lenses + .ts-wrapper .ts-dropdown,
    #album-films + .ts-wrapper .ts-dropdown,
    #album-developers + .ts-wrapper .ts-dropdown,
    #album-labs + .ts-wrapper .ts-dropdown {
      z-index: 99999 !important;
      position: absolute !important;
      width: 100% !important;
    }
    
    /* Equipment section normal stacking */
    .border-t.pt-4.mt-4 {
      position: relative !important;
      background-color: #ffffff !important;
    }
    
    /* Full width for all TomSelect elements */
    .ts-wrapper,
    .ts-wrapper .ts-control,
    .ts-wrapper input {
      width: 100% !important;
      box-sizing: border-box !important;
    }
    
    /* Additional ID-based targeting for full width */
    #album-cameras-ts-dropdown,
    #album-lenses-ts-dropdown,
    #album-films-ts-dropdown,
    #album-developers-ts-dropdown,
    #album-labs-ts-dropdown {
      z-index: 99999 !important;
      background-color: #ffffff !important;
      border: 1px solid #d1d5db !important;
      border-radius: 0.375rem !important;
      position: absolute !important;
      width: 100% !important;
      left: 0 !important;
      right: 0 !important;
    }
  </style>
{% endblock %}
