{% extends 'admin/_layout.twig' %}
{% block title %}{{ trans('admin.texts.title') }} â€” {{ site_title|default('Cimaise')|e }}{% endblock %}
{% block content %}
  <div class="flex items-center justify-between mb-8">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">{{ trans('admin.texts.heading') }}</h1>
      <p class="text-gray-600 mt-1">{{ trans('admin.texts.description') }}</p>
    </div>
    <div class="flex gap-2">
      <form action="{{ base_path }}/admin/texts/seed" method="post" class="inline" data-confirm="{{ trans('admin.texts.seed_confirm')|e('html_attr') }}">
        <input type="hidden" name="csrf" value="{{ csrf }}">
        <button type="submit" class="btn-secondary">
          <i class="fas fa-seedling mr-2"></i>{{ trans('admin.texts.seed_defaults') }}
        </button>
      </form>
      <a href="{{ base_path }}/admin/texts/create" class="btn-primary">
        <i class="fas fa-plus mr-2"></i>{{ trans('admin.texts.add_text') }}
      </a>
    </div>
  </div>

  {# Scope selector tabs #}
  <div class="mb-6">
    <div class="border-b border-gray-200">
      <nav class="-mb-px flex space-x-8" aria-label="Tabs">
        <a href="{{ base_path }}/admin/texts?scope=frontend"
           class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm {{ current_scope == 'frontend' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300' }}">
          <i class="fas fa-globe mr-2"></i>{{ trans('admin.texts.scope_frontend') }}
        </a>
        <a href="{{ base_path }}/admin/texts?scope=admin"
           class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm {{ current_scope == 'admin' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300' }}">
          <i class="fas fa-cog mr-2"></i>{{ trans('admin.texts.scope_admin') }}
        </a>
      </nav>
    </div>
  </div>

  {# Import/Upload translations card #}
  <div class="card mb-6">
    <div class="card-header bg-blue-50 border-b border-blue-200 py-4 px-6 flex items-center justify-between">
      <h2 class="text-lg font-semibold text-blue-800 flex items-center">
        <i class="fas fa-language mr-2"></i>{{ trans('admin.texts.import_translations') }}
      </h2>
      <div class="flex gap-2">
        <a href="{{ base_path }}/admin/texts/export" class="btn-sm btn-secondary">
          <i class="fas fa-download mr-1"></i>{{ trans('admin.texts.download_json') }}
        </a>
        <button type="button" id="toggle-upload-btn" class="btn-sm btn-secondary">
          <i class="fas fa-upload mr-1"></i>{{ trans('admin.texts.upload_json') }}
        </button>
      </div>
    </div>
    <div class="p-4 space-y-4">
      {# Import from preset - main section #}
      <form action="{{ base_path }}/admin/texts/import" method="post">
        <input type="hidden" name="csrf" value="{{ csrf }}">
        <input type="hidden" name="scope" value="{{ current_scope }}">
        <div class="flex flex-wrap items-end gap-3">
          <div class="flex-1 min-w-[250px]">
            <label class="block text-xs font-medium text-gray-600 mb-1">{{ trans('admin.texts.language') }}</label>
            <select name="language" id="language-select" class="input w-full">
              <option value="">{{ trans('admin.texts.select_language') }}</option>
              {% for lang in languages %}
                <option value="{{ lang.code }}">{{ lang.name }} ({{ lang.code }}) - v{{ lang.version }}</option>
              {% else %}
                <option value="" disabled>{{ trans('admin.texts.no_preset_languages') }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="w-28">
            <label class="block text-xs font-medium text-gray-600 mb-1">{{ trans('admin.texts.mode') }}</label>
            <select name="mode" class="input w-full">
              <option value="merge">{{ trans('admin.texts.mode_merge') }}</option>
              <option value="replace">{{ trans('admin.texts.mode_replace') }}</option>
              <option value="skip">{{ trans('admin.texts.mode_skip') }}</option>
            </select>
          </div>
          <button type="submit" class="btn-primary">
            <i class="fas fa-file-import mr-2"></i>{{ trans('admin.texts.import') }}
          </button>
        </div>
        <p class="text-xs text-gray-500 mt-2">
          <strong>{{ trans('admin.texts.mode_merge') }}:</strong> {{ trans('admin.texts.mode_merge_desc') }} |
          <strong>{{ trans('admin.texts.mode_replace') }}:</strong> {{ trans('admin.texts.mode_replace_desc') }} |
          <strong>{{ trans('admin.texts.mode_skip') }}:</strong> {{ trans('admin.texts.mode_skip_desc') }}
        </p>
      </form>

      {# Upload custom JSON - hidden by default #}
      <div id="upload-section" class="hidden border-t border-gray-200 pt-4">
        <h3 class="text-sm font-medium text-gray-700 mb-3">{{ trans('admin.texts.upload_custom_json') }}</h3>
        <form action="{{ base_path }}/admin/texts/upload" method="post" enctype="multipart/form-data">
          <input type="hidden" name="csrf" value="{{ csrf }}">
          <div class="flex flex-wrap items-end gap-3">
            <div class="flex-1 min-w-[250px]">
              <label class="block text-xs font-medium text-gray-600 mb-1">{{ trans('admin.texts.json_file') }}</label>
              <input type="file" name="json_file" accept=".json" class="input w-full file:mr-3 file:py-1 file:px-3 file:rounded file:border-0 file:text-sm file:bg-gray-100 file:text-gray-700 hover:file:bg-gray-200">
            </div>
            <div class="w-28">
              <label class="block text-xs font-medium text-gray-600 mb-1">{{ trans('admin.texts.mode') }}</label>
              <select name="mode" class="input w-full">
                <option value="merge">{{ trans('admin.texts.mode_merge') }}</option>
                <option value="replace">{{ trans('admin.texts.mode_replace') }}</option>
                <option value="skip">{{ trans('admin.texts.mode_skip') }}</option>
              </select>
            </div>
            <button type="submit" class="btn-primary">
              <i class="fas fa-upload mr-2"></i>{{ trans('admin.texts.upload') }}
            </button>
          </div>
          <label class="flex items-center text-sm text-gray-600 mt-3">
            <input type="checkbox" name="save_file" value="1" class="mr-2 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
            {{ trans('admin.texts.save_as_preset') }}
          </label>
        </form>
      </div>
    </div>
  </div>

  {# Search and filter bar #}
  <div class="card mb-6">
    <div class="p-4">
      <form method="get" class="flex flex-wrap gap-4">
        <input type="hidden" name="scope" value="{{ current_scope }}">
        <div class="flex-1 min-w-[200px]">
          <input type="text" name="search" value="{{ search }}" placeholder="{{ trans('admin.texts.search_placeholder') }}"
                 class="input w-full">
        </div>
        <div class="w-48">
          <select name="context" class="input w-full">
            <option value="">{{ trans('admin.texts.all_contexts') }}</option>
            {% for ctx in contexts %}
              <option value="{{ ctx }}" {% if ctx == current_context %}selected{% endif %}>{{ ctx|capitalize }}</option>
            {% endfor %}
          </select>
        </div>
        <button type="submit" class="btn-primary">
          <i class="fas fa-search mr-2"></i>{{ trans('admin.common.search') }}
        </button>
        {% if search or current_context %}
          <a href="{{ base_path }}/admin/texts?scope={{ current_scope }}" class="btn-secondary">
            <i class="fas fa-times mr-2"></i>{{ trans('admin.common.clear') }}
          </a>
        {% endif %}
      </form>
    </div>
  </div>

  {# Grouped texts #}
  {% for context, texts in grouped %}
    <div class="card mb-6">
      <div class="card-header bg-blue-50 border-b border-blue-200 py-4 px-6">
        <h2 class="text-lg font-semibold text-blue-800 flex items-center">
          <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-600 mr-3 text-sm">
            {{ texts|length }}
          </span>
          {{ context|capitalize }}
        </h2>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">{{ trans('admin.texts.col_key') }}</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{{ trans('admin.texts.col_value') }}</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">{{ trans('admin.texts.col_description') }}</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-24">{{ trans('admin.texts.col_actions') }}</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            {% for text in texts %}
              <tr class="hover:bg-gray-50" data-text-id="{{ text.id }}">
                <td class="px-4 py-3">
                  <code class="text-sm bg-gray-100 px-2 py-1 rounded text-gray-800">{{ text.text_key }}</code>
                </td>
                <td class="px-4 py-3">
                  <div class="inline-edit-container" data-id="{{ text.id }}">
                    <span class="text-value text-gray-900">{{ text.text_value }}</span>
                    <input type="text" class="text-input input w-full" value="{{ text.text_value|e('html_attr') }}" style="display: none;">
                    <div class="edit-actions mt-2 flex gap-2" style="display: none;">
                      <button type="button" class="save-btn btn-sm btn-primary">{{ trans('admin.common.save') }}</button>
                      <button type="button" class="cancel-btn btn-sm btn-secondary">{{ trans('admin.common.cancel') }}</button>
                    </div>
                  </div>
                </td>
                <td class="px-4 py-3 text-sm text-gray-500">{{ text.description }}</td>
                <td class="px-4 py-3 text-right whitespace-nowrap">
                  <div class="flex items-center justify-end gap-2">
                    <button type="button" class="edit-inline-btn inline-flex items-center px-2 py-1 text-xs font-medium rounded bg-blue-50 text-blue-700 hover:bg-blue-100 border border-blue-200" title="{{ trans('admin.texts.quick_edit') }}">
                      <i class="fas fa-pen-to-square mr-1"></i>{{ trans('admin.texts.quick') }}
                    </button>
                    <a href="{{ base_path }}/admin/texts/{{ text.id }}/edit" class="inline-flex items-center px-2 py-1 text-xs font-medium rounded bg-gray-50 text-gray-700 hover:bg-gray-100 border border-gray-200" title="{{ trans('admin.texts.full_edit') }}">
                      <i class="fas fa-edit mr-1"></i>{{ trans('admin.common.edit') }}
                    </a>
                    <form action="{{ base_path }}/admin/texts/{{ text.id }}" method="post" class="inline" data-confirm="{{ trans('admin.texts.delete_confirm')|e('html_attr') }}">
                      <input type="hidden" name="csrf" value="{{ csrf }}">
                      <input type="hidden" name="_method" value="DELETE">
                      <button type="submit" class="inline-flex items-center px-2 py-1 text-xs font-medium rounded bg-red-50 text-red-700 hover:bg-red-100 border border-red-200" title="{{ trans('admin.common.delete') }}">
                        <i class="fas fa-trash mr-1"></i>{{ trans('admin.common.delete') }}
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% else %}
    <div class="card">
      <div class="p-8 text-center">
        <i class="fas fa-language text-4xl text-gray-400 mb-4"></i>
        <h3 class="text-lg font-medium text-gray-900 mb-2">{{ trans('admin.texts.no_texts_found') }}</h3>
        <p class="text-gray-600 mb-4">
          {% if search or current_context %}
            {{ trans('admin.texts.no_texts_match') }}
          {% else %}
            {{ trans('admin.texts.no_texts_hint') }}
          {% endif %}
        </p>
        <div class="flex justify-center gap-4">
          <form action="{{ base_path }}/admin/texts/seed" method="post" class="inline">
            <input type="hidden" name="csrf" value="{{ csrf }}">
            <button type="submit" class="btn-primary">
              <i class="fas fa-seedling mr-2"></i>{{ trans('admin.texts.seed_defaults') }}
            </button>
          </form>
          <a href="{{ base_path }}/admin/texts/create" class="btn-secondary">
            <i class="fas fa-plus mr-2"></i>{{ trans('admin.texts.add_text') }}
          </a>
        </div>
      </div>
    </div>
  {% endfor %}

  <script nonce="{{ csp_nonce() }}">
    document.addEventListener('DOMContentLoaded', function() {
      // Toggle upload section
      const toggleBtn = document.getElementById('toggle-upload-btn');
      const uploadSection = document.getElementById('upload-section');
      if (toggleBtn && uploadSection) {
        toggleBtn.addEventListener('click', function() {
          uploadSection.classList.toggle('hidden');
          const icon = this.querySelector('i');
          if (uploadSection.classList.contains('hidden')) {
            icon.className = 'fas fa-upload mr-1';
            this.innerHTML = '<i class="fas fa-upload mr-1"></i>{{ trans('admin.texts.upload_json')|e('js') }}';
          } else {
            this.innerHTML = '<i class="fas fa-times mr-1"></i>{{ trans('admin.texts.hide_upload')|e('js') }}';
          }
        });
      }

      // Inline editing functionality - using event delegation for reliability
      document.addEventListener('click', function(e) {
        // Quick Edit button
        if (e.target.closest('.edit-inline-btn')) {
          e.preventDefault();
          e.stopPropagation();
          const btn = e.target.closest('.edit-inline-btn');
          const row = btn.closest('tr');
          const container = row.querySelector('.inline-edit-container');
          if (container) {
            const textValue = container.querySelector('.text-value');
            const textInput = container.querySelector('.text-input');
            const editActions = container.querySelector('.edit-actions');

            // Store original value for cancel (handles HTML entities correctly)
            textInput.dataset.originalValue = textInput.value;
            textValue.style.display = 'none';
            textInput.style.display = 'block';
            editActions.style.display = 'flex';
            textInput.focus();
          }
        }

        // Cancel button
        if (e.target.closest('.cancel-btn')) {
          e.preventDefault();
          e.stopPropagation();
          const container = e.target.closest('.inline-edit-container');
          if (container) {
            const textValue = container.querySelector('.text-value');
            const textInput = container.querySelector('.text-input');
            const editActions = container.querySelector('.edit-actions');

            // Restore from stored original value (or fall back to textContent)
            textInput.value = textInput.dataset.originalValue || textValue.textContent.trim();
            textValue.style.display = '';
            textInput.style.display = 'none';
            editActions.style.display = 'none';
          }
        }

        // Save button
        if (e.target.closest('.save-btn')) {
          e.preventDefault();
          e.stopPropagation();
          const btn = e.target.closest('.save-btn');
          const container = btn.closest('.inline-edit-container');
          if (container) {
            const id = container.dataset.id;
            const textValue = container.querySelector('.text-value');
            const textInput = container.querySelector('.text-input');
            const editActions = container.querySelector('.edit-actions');

            fetch(`{{ base_path }}/admin/texts/${id}/inline`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': '{{ csrf }}'
              },
              body: JSON.stringify({ text_value: textInput.value })
            })
            .then(response => {
              if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
              }
              return response.json();
            })
            .then(result => {
              if (result.success) {
                textValue.textContent = textInput.value;
                textValue.style.display = '';
                textInput.style.display = 'none';
                editActions.style.display = 'none';
              } else {
                alert('{{ trans('admin.texts.save_failed')|e('js') }}: ' + (result.error || '{{ trans('admin.texts.unknown_error')|e('js') }}'));
              }
            })
            .catch(error => {
              alert('{{ trans('admin.texts.save_failed')|e('js') }}: ' + error.message);
            });
          }
        }
      });
    });
  </script>
{% endblock %}
