{% extends 'admin/_layout.twig' %}

{% block title %}Social Sharing â€” photoCMS{% endblock %}

{% block content %}
  <div class="flex items-center justify-between mb-8">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">Social Sharing</h1>
      <p class="text-gray-600 mt-1">Seleziona e ordina i social di condivisione</p>
    </div>
    <div class="flex items-center gap-3">
      <button type="submit" form="social-form" class="btn-primary">
        <i class="fas fa-save mr-2"></i>
        Salva Impostazioni
      </button>
      <a href="{{ base_path }}/admin" class="btn-secondary">
        <i class="fas fa-arrow-left mr-2"></i>
        Dashboard
      </a>
    </div>
  </div>

  <!-- Sticky Footer with Action Buttons -->
  <div class="fixed bottom-0 left-64 right-0 bg-white border-t border-gray-200 shadow-lg z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <button type="submit" form="social-form" class="btn-primary">
            <i class="fas fa-save mr-2"></i>
            Salva Impostazioni
          </button>
          <a href="{{ base_path }}/admin" class="btn-secondary">
            <i class="fas fa-arrow-left mr-2"></i>
            Dashboard
          </a>
        </div>
        
        <div class="text-sm text-gray-500">
          <i class="fas fa-info-circle mr-1"></i>
          Configura i social sharing del sito
        </div>
      </div>
    </div>
  </div>

  <div class="space-y-8 pb-48">
    <form id="social-form" action="{{ base_path }}/admin/social" method="post" class="space-y-8">
      <input type="hidden" name="csrf" value="{{ csrf }}">
      <input type="hidden" name="social_order" id="social-order-input" value="{{ social_order|json_encode|raw }}">

      <!-- Preview & Order -->
      <div class="card">
        <div class="p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-medium text-gray-900 flex items-center">
              <i class="fas fa-eye mr-3 text-gray-600"></i>Preview & Ordine (trascina per riordinare)
            </h3>
            <div class="text-sm text-gray-500"><span id="selected-count">{{ enabled_socials|length }}</span> selezionati</div>
          </div>
          <div id="preview-wrap" class="p-4 bg-gray-50 rounded-lg">
            <div id="preview" class="flex gap-3 flex-wrap"></div>
            <p id="preview-empty" class="text-sm text-gray-500 py-2" style="display:none">Nessun social selezionato</p>
          </div>
        </div>
      </div>

      <!-- Elenco Social -->
      <div class="card">
        <div class="p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-medium text-gray-900 flex items-center">
              <i class="fas fa-share-alt mr-3 text-gray-600"></i>Social disponibili
            </h3>
            <div class="flex items-center gap-2">
              <button type="button" id="btn-select-all" class="btn btn-sm btn-outline"><i class="fas fa-check-square mr-2"></i>Seleziona tutti</button>
              <button type="button" id="btn-deselect-all" class="btn btn-sm btn-outline"><i class="fas fa-square mr-2"></i>Deseleziona tutti</button>
              <button type="submit" class="btn btn-sm"><i class="fas fa-save mr-2"></i>Salva</button>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3" id="social-list">
            {% for key, cfg in available_socials %}
              <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer" data-social="{{ key }}">
                <input type="checkbox" class="social-checkbox mr-3 rounded border-gray-300 text-black focus:ring-black" id="social_{{ key }}" name="social_{{ key }}" {% if key in enabled_socials %}checked{% endif %}>
                <i class="{{ cfg.icon }} mr-3" style="color: {{ cfg.color }}; width: 20px; text-align:center"></i>
                <div>
                  <div class="text-sm font-medium text-gray-900">{{ cfg.name }}</div>
                  {% set url = cfg.url %}
                  {% if url == '#' or url starts with 'javascript:' %}
                    <div class="text-xs text-gray-500">Solo icona</div>
                  {% else %}
                    <div class="text-xs text-green-600">Condivisione disponibile</div>
                  {% endif %}
                </div>
              </label>
            {% endfor %}
          </div>
        </div>
      </div>
    </form>
  </div>
  <script>
(function(){
  // Data dal server
  const AVAILABLE = {{ available_socials|json_encode|raw }};
  const START_ENABLED = Array.isArray({{ enabled_socials|json_encode|raw }}) ? {{ enabled_socials|json_encode|raw }} : [];
  const START_ORDER = Array.isArray({{ social_order|json_encode|raw }}) ? {{ social_order|json_encode|raw }} : [];

  // Riferimenti DOM
  const form = document.getElementById('social-form');
  const preview = document.getElementById('preview');
  const previewEmpty = document.getElementById('preview-empty');
  const orderInput = document.getElementById('social-order-input');
  const countEl = document.getElementById('selected-count');
  const btnAll = document.getElementById('btn-select-all');
  const btnNone = document.getElementById('btn-deselect-all');
  const csrf = form.querySelector('input[name="csrf"]').value;

  // Stato
  let enabled = new Set(START_ENABLED);
  let order = normalizeOrder(START_ORDER, enabled);
  let saveTimer = null;

  // Init
  renderFromState();
  wireEvents();
  ensureSortable();

  function normalizeOrder(ord, enabledSet){
    const keys = Array.from(enabledSet);
    const out = [];
    (Array.isArray(ord) ? ord : []).forEach(k => { if (enabledSet.has(k)) out.push(k); });
    keys.forEach(k => { if (!out.includes(k)) out.push(k); });
    return out;
  }

  function renderFromState(){
    // update count
    countEl.textContent = enabled.size.toString();

    // update hidden input for non-AJAX submit
    orderInput.value = JSON.stringify(order);

    // render preview
    preview.innerHTML = '';
    if (enabled.size === 0) {
      previewEmpty.style.display = '';
    } else {
      previewEmpty.style.display = 'none';
      order.forEach(key => {
        if (!enabled.has(key) || !AVAILABLE[key]) return;
        const cfg = AVAILABLE[key];
        const el = document.createElement('div');
        el.className = 'preview-item social-btn ' + key;
        el.dataset.social = key;
        el.title = cfg.name;
        el.innerHTML = '<i class="' + cfg.icon + '"></i>';
        preview.appendChild(el);
      });
    }
  }

  function collectEnabledFromCheckboxes(){
    const out = [];
    document.querySelectorAll('.social-checkbox').forEach(cb => {
      if (cb.checked) out.push(cb.id.replace('social_', ''));
    });
    return out;
  }

  function onCheckboxChange(){
    enabled = new Set(collectEnabledFromCheckboxes());
    order = normalizeOrder(order, enabled);
    renderFromState();
    saveDebounced();
  }

  function updateOrderFromDOM(){
    const newOrder = [];
    preview.querySelectorAll('.preview-item').forEach(n => {
      const k = n.dataset.social; if (k) newOrder.push(k);
    });
    order = normalizeOrder(newOrder, enabled);
    orderInput.value = JSON.stringify(order);
    saveDebounced();
  }

  function saveDebounced(){
    if (saveTimer) clearTimeout(saveTimer);
    saveTimer = setTimeout(saveAjax, 250);
  }

  function saveAjax(){
    const payload = { enabled: Array.from(enabled), order };
    fetch('{{ base_path }}/admin/social', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRF-Token': csrf
      },
      body: JSON.stringify(payload)
    }).then(r => {
      if (!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }).then(json => {
      // Optionally, could show a toast
      // console.log('saved', json);
    }).catch(err => {
      console.warn('save error', err);
    });
  }

  function wireEvents(){
    document.querySelectorAll('.social-checkbox').forEach(cb => {
      cb.addEventListener('change', onCheckboxChange);
    });
    btnAll.addEventListener('click', function(){
      document.querySelectorAll('.social-checkbox').forEach(cb => cb.checked = true);
      onCheckboxChange();
    });
    btnNone.addEventListener('click', function(){
      document.querySelectorAll('.social-checkbox').forEach(cb => cb.checked = false);
      onCheckboxChange();
    });
    form.addEventListener('submit', function(){
      // ensure latest order is in the hidden input
      orderInput.value = JSON.stringify(order);
    });
  }

  function ensureSortable(){
    function init(){
      if (typeof Sortable === 'undefined') return false;
      Sortable.create(preview, { animation: 150, onEnd: updateOrderFromDOM });
      return true;
    }
    if (init()) return;
    var s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js';
    s.defer = true;
    s.onload = init;
    document.head.appendChild(s);
  }
})();

// SPA support: re-initialize on dynamic loads
window.pageInitializers = window.pageInitializers || {};
window.pageInitializers.social = function(){
  try {
    // Re-run the module if needed by cloning the script
    const script = document.createElement('script');
    script.textContent = '(' + (function(){
      // same code as above, but minimal rerun: just rebuild from current DOM
      const form = document.getElementById('social-form');
      if (!form) return;
      const preview = document.getElementById('preview');
      if (!preview) return;
      const evt = new Event('change');
      const cbs = document.querySelectorAll('.social-checkbox');
      if (cbs.length) {
        cbs[cbs.length-1].dispatchEvent(evt);
      }
    }).toString() + ')();';
    document.body.appendChild(script);
    setTimeout(()=>script.remove(),0);
  } catch(e) {}
};
</script>

<style>
/* preview buttons */
.social-btn { display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius:6px; color:#111; transition:transform .15s ease; cursor:move; }
.social-btn i { font-size:18px; }
.social-btn:hover { transform: translateY(-2px) scale(1.05); }
.preview-item { user-select:none; }
/* hover colors */
.social-btn.facebook:hover{color:#0866ff}
.social-btn.twitter:hover{color:#1da1f2}
.social-btn.x:hover{color:#000}
.social-btn.instagram:hover{color:#e23367}
.social-btn.whatsapp:hover{color:#25d366}
.social-btn.pinterest:hover{color:#CB2027}
.social-btn.telegram:hover{color:#179cde}
.social-btn.behance:hover{color:#1769ff}
.social-btn.bluesky:hover{color:#1083fe}
</style>
{% endblock %}
