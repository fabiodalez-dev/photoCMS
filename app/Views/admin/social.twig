{% extends 'admin/_layout.twig' %}
{% block title %}Social Sharing â€” photoCMS{% endblock %}
{% block content %}
  <div class="flex items-center justify-between mb-8">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">Social Sharing</h1>
      <p class="text-gray-600 mt-1">Configure which social networks to display on gallery pages</p>
    </div>
  </div>

  <div class="pb-48">
    <form method="post" action="{{ base_path }}/admin/social" id="social-form" class="space-y-8">
      <input type="hidden" name="csrf" value="{{ csrf }}">
      
      <!-- Preview Section -->
      <div class="card" id="preview-section">
        <div class="p-6">
          <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
            <i class="fas fa-eye mr-3 text-gray-600"></i>
            Preview & Order Management
          </h3>
          
          <div class="p-4 bg-gray-50 rounded-lg">
            <p class="text-sm text-gray-600 mb-4">Preview of social sharing buttons (drag to reorder):</p>
            <div class="social-sharing">
              <div class="social-buttons flex gap-3 flex-wrap justify-center" id="preview-buttons">
                {# Server-side initial preview so users see buttons even if JS init is delayed #}
                {% set initial_order = social_order is iterable ? social_order : [] %}
                {% set initial_enabled = enabled_socials is iterable ? enabled_socials : [] %}
                {% set has_any = false %}
                {% for s in initial_order %}
                  {% if s in initial_enabled and available_socials[s] is defined %}
                    {% set cfg = available_socials[s] %}
                    <div class="social-btn {{ s }} sortable-preview-item" data-social="{{ s }}" title="{{ cfg.name }}">
                      <i class="{{ cfg.icon }}"></i>
                    </div>
                    {% set has_any = true %}
                  {% endif %}
                {% endfor %}
                {% if not has_any %}
                  {% for s in initial_enabled %}
                    {% if available_socials[s] is defined %}
                      {% set cfg = available_socials[s] %}
                      <div class="social-btn {{ s }} sortable-preview-item" data-social="{{ s }}" title="{{ cfg.name }}">
                        <i class="{{ cfg.icon }}"></i>
                      </div>
                    {% endif %}
                  {% endfor %}
                {% endif %}
              </div>
            </div>
          </div>
          
          <input type="hidden" name="social_order" id="social-order-input" value='{{ social_order|json_encode|raw }}'>
        </div>
      </div>
      
      <div class="card">
        <div class="p-6">
          <h3 class="text-lg font-medium text-gray-900 mb-6 flex items-center">
            <i class="fas fa-share-alt mr-3 text-gray-600"></i>
            Available Social Networks
          </h3>
          
          <div class="mb-6">
            <div class="flex items-center gap-4 mb-4">
              <button type="button" id="select-all" class="btn btn-sm btn-outline">
                <i class="fas fa-check-square mr-2"></i>Select All
              </button>
              <button type="button" id="deselect-all" class="btn btn-sm btn-outline">
                <i class="fas fa-square mr-2"></i>Deselect All
              </button>
              <span class="text-sm text-gray-500" id="selected-count">
                {{ enabled_socials|length }} selected
              </span>
            </div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for social_key, social_config in available_socials %}
            <label class="flex items-center p-4 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer social-option" data-social="{{ social_key }}">
              <input type="checkbox" name="social_{{ social_key }}" id="social_{{ social_key }}" 
                     class="social-checkbox rounded border-gray-300 text-black focus:ring-black mr-3" 
                     {% if social_key in enabled_socials %}checked{% endif %}>
              <div class="flex items-center">
                <i class="{{ social_config.icon }} mr-3" style="color: {{ social_config.color }}; width: 20px; text-align: center;"></i>
                <div>
                  <div class="text-sm font-medium text-gray-900">{{ social_config.name }}</div>
                  {% if social_config.url == '#' or social_config.url starts with 'javascript:' %}
                    <div class="text-xs text-gray-500">Display only</div>
                  {% else %}
                    <div class="text-xs text-green-600">Sharing enabled</div>
                  {% endif %}
                </div>
              </div>
            </label>
            {% endfor %}
          </div>
          
          <div class="mt-8 p-4 bg-blue-50 rounded-lg">
            <div class="flex items-start">
              <i class="fas fa-info-circle text-blue-500 mt-1 mr-3"></i>
              <div class="text-sm text-blue-800">
                <p class="font-medium mb-2">How social sharing works:</p>
                <ul class="list-disc list-inside space-y-1 text-blue-700">
                  <li>Selected social networks will appear as sharing buttons on gallery pages</li>
                  <li>Buttons will show the album title, description, and cover image when shared</li>
                  <li>Some services (like Instagram, GitHub) are display-only and don't support direct web sharing</li>
                  <li>The order of buttons follows the order shown here</li>
                </ul>
              </div>
            </div>
          </div>
          
        </div>
      </div>
    </form>
  </div>

  <!-- Sticky footer with save button -->
  <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-6 py-4">
    <div class="max-w-7xl mx-auto flex justify-end">
      <button type="submit" form="social-form" class="btn btn-primary">
        <i class="fas fa-save mr-2"></i>Save Settings
      </button>
    </div>
  </div>

{% endblock %}

{% block scripts %}
<script>
// Load SortableJS for drag & drop ordering
(function loadSortable(){
  try {
    if (typeof Sortable === 'undefined') {
      var s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js';
      s.defer = true;
      s.onload = function(){
        try {
          console.log('[social] Sortable loaded');
          // If preview exists, initialize sortable now
          var previewButtons = document.getElementById('preview-buttons');
          if (previewButtons && previewButtons.children.length > 1 && typeof Sortable !== 'undefined') {
            try { Sortable.create(previewButtons, {animation:150, onEnd:function(){ var f=document.getElementById('social-order-input'); if(!f) return; var order=[]; previewButtons.querySelectorAll('.sortable-preview-item').forEach(function(n){order.push(n.dataset.social)}); f.value = JSON.stringify(order); }}); } catch(e){ console.warn('[social] onload Sortable init failed', e); }
          }
        } catch(e) {}
      };
      document.head.appendChild(s);
    }
  } catch(e) {}
})();

function initAdminSocialPage() {
  try { console.log('[social] initAdminSocialPage start'); } catch(e){}
  const checkboxes = document.querySelectorAll('.social-checkbox');
  const selectAllBtn = document.getElementById('select-all');
  const deselectAllBtn = document.getElementById('deselect-all');
  const selectedCount = document.getElementById('selected-count');
  const previewButtons = document.getElementById('preview-buttons');
  const previewSection = document.getElementById('preview-section');
  const orderInput = document.getElementById('social-order-input');
  
  const socialConfigs = {{ available_socials|json_encode|raw }};
  const currentOrder = {{ social_order|json_encode|raw }};
  const enabledFromServer = {{ enabled_socials|json_encode|raw }};
  const csrfToken = document.querySelector('input[name="csrf"]').value;

  try {
    console.log('[social] DOM elements:', {
      checkboxes: checkboxes.length,
      selectAllBtn: !!selectAllBtn,
      deselectAllBtn: !!deselectAllBtn,
      previewButtons: !!previewButtons,
      orderInput: !!orderInput
    });
    console.log('[social] configs keys:', Object.keys(socialConfigs||{}));
    console.log('[social] currentOrder:', currentOrder);
    console.log('[social] enabledFromServer:', enabledFromServer);
  } catch(e){}
  let previewSortableInstance = null;
  
  function updateCount() {
    const checked = document.querySelectorAll('.social-checkbox:checked').length;
    selectedCount.textContent = `${checked} selected`;
    try { console.log('[social] updateCount ->', checked); } catch(e){}
  }
  
  function updatePreview() {
    try { console.log('[social] updatePreview called'); } catch(e){}
    if (!previewButtons) return;
    previewButtons.innerHTML = '';
    
    // Get current order from sortable or checkboxes
    const currentSortableOrder = getCurrentOrder();
    
    // Check which socials are actually selected (checkbox checked)
    const selectedSocials = [];
    currentSortableOrder.forEach(function(social) {
      const checkbox = document.getElementById('social_' + social);
      if (checkbox && checkbox.checked) {
        selectedSocials.push(social);
      }
    });
    if (selectedSocials.length === 0 && Array.isArray(enabledFromServer) && enabledFromServer.length) {
      // Fallback: use server enabled list if no checkbox-based selection
      enabledFromServer.forEach(function(s){ if (currentSortableOrder.includes(s)) selectedSocials.push(s); });
    }
    try { console.log('[social] selectedSocials:', selectedSocials); } catch(e){}
    
    // Show/hide preview section based on actual selections
    if (selectedSocials.length > 0) {
      previewSection.style.display = 'block';
    } else {
      previewSection.style.display = 'none';
      try { console.log('[social] no selected socials -> hide preview'); } catch(e){}
      return;
    }
    
    selectedSocials.forEach(function(social) {
      const config = socialConfigs[social];
      
      if (config) {
        const button = document.createElement('div');
        button.className = 'social-btn ' + social + ' sortable-preview-item cursor-move';
        button.dataset.social = social;
        button.title = 'Share on ' + config.name + ' (drag to reorder)';
        button.innerHTML = '<i class="' + config.icon + '"></i>';
        
        previewButtons.appendChild(button);
      }
    });
    
    if (previewButtons.children.length === 0) {
      previewButtons.innerHTML = '<span class="text-gray-500 text-sm italic">No social networks selected</span>';
      previewSection.style.display = 'none';
    } else {
      // Initialize sortable for preview
      initPreviewSortable();
    }

    // Save current state in real-time
    saveRealtime();
  }
  
  function initPreviewSortable() {
    // Destroy existing instance
    if (previewSortableInstance) {
      previewSortableInstance.destroy();
    }
    
    // Only create if we have more than 1 item and Sortable is available
    if (typeof Sortable !== 'undefined' && previewButtons.children.length > 1) {
      try {
        previewSortableInstance = Sortable.create(previewButtons, {
          animation: 150,
          ghostClass: 'sortable-ghost',
          chosenClass: 'sortable-chosen',
          dragClass: 'sortable-drag',
          onEnd: function(evt) {
            updateOrderInput();
          }
        });
        try { console.log('[social] Sortable initialized'); } catch(e){}
      } catch(e) {
        try { console.warn('[social] Failed to init Sortable:', e); } catch(_){ }
      }
    } else {
      try { console.warn('[social] Sortable not available or not enough items', {sortableAvailable: typeof Sortable !== 'undefined', itemCount: previewButtons.children.length}); } catch(_){ }
      // Retry once after a short delay if Sortable isn't loaded yet
      setTimeout(function(){
        if (typeof Sortable !== 'undefined' && previewButtons.children.length > 1) {
          try {
            previewSortableInstance = Sortable.create(previewButtons, {
              animation: 150,
              onEnd: function(){ updateOrderInput(); saveRealtime(); }
            });
          } catch(e){}
        }
      }, 150);
    }

    updateOrderInput();
  }
  
  function getCurrentOrder() {
    // Get order from preview buttons if they exist
    const previewItems = previewButtons.querySelectorAll('.sortable-preview-item');
    if (previewItems.length > 0) {
      const order = [];
      previewItems.forEach(function(item) {
        order.push(item.dataset.social);
      });
      try { console.log('[social] current order from preview:', order); } catch(e){}
      return order;
    }
    
    // Fallback to current order or checked socials
    const checkedSocials = getCheckedSocials();
    if (currentOrder && currentOrder.length > 0) {
      // Filter current order to only include checked socials, then add new ones
      const orderedChecked = [];
      currentOrder.forEach(function(social) {
        if (checkedSocials.includes(social)) {
          orderedChecked.push(social);
        }
      });
      // Add newly checked socials not in current order
      checkedSocials.forEach(function(social) {
        if (!orderedChecked.includes(social)) {
          orderedChecked.push(social);
        }
      });
    try { console.log('[social] orderedChecked:', orderedChecked); } catch(e){}
    return orderedChecked;
  }
    
    return checkedSocials;
  }
  
  function getCheckedSocials() {
    const selected = [];
    checkboxes.forEach(function(checkbox) {
      if (checkbox.checked) {
        selected.push(checkbox.id.replace('social_', ''));
      }
    });
    return selected;
  }
  
  function updateOrderInput() {
    const currentOrderArray = getCurrentOrder();
    orderInput.value = JSON.stringify(currentOrderArray);
  }

  // Save via AJAX immediately when state changes
  let saveTimer = null;
  function saveRealtime() {
    const enabled = getCheckedSocials();
    const order = getCurrentOrder();
    const payload = { enabled: enabled, order: order };
    if (saveTimer) clearTimeout(saveTimer);
    saveTimer = setTimeout(function(){
      fetch('{{ base_path }}/admin/social', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept':'application/json', 'X-Requested-With': 'XMLHttpRequest', 'X-CSRF-Token': csrfToken },
        body: JSON.stringify(payload)
      }).then(r => r.json()).then(j => {
        try { console.log('[social] saved', j); } catch(e){}
      }).catch(e => { try { console.warn('[social] save error', e); } catch(_){ } });
    }, 100);
  }
  
  selectAllBtn.addEventListener('click', function() {
    checkboxes.forEach(function(checkbox) {
      checkbox.checked = true;
    });
    updateCount();
    updatePreview();
  });
  
  deselectAllBtn.addEventListener('click', function() {
    checkboxes.forEach(function(checkbox) {
      checkbox.checked = false;
    });
    updateCount();
    updatePreview();
  });
  
  checkboxes.forEach(function(checkbox) {
    checkbox.addEventListener('change', function() {
      updateCount();
      updatePreview();
    });
  });
  
  // Initialize: ensure checkboxes reflect server-enabled list
  try {
    if (Array.isArray(enabledFromServer)) {
      checkboxes.forEach(function(checkbox) {
        const key = checkbox.id.replace('social_', '');
        checkbox.checked = enabledFromServer.includes(key);
      });
    }
  } catch(e) {}

  // First render
  updateCount();
  updatePreview();
}

// Run on normal load
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initAdminSocialPage);
} else {
  initAdminSocialPage();
}

// Expose for SPA
window.pageInitializers = window.pageInitializers || {};
window.pageInitializers.social = initAdminSocialPage;
</script>

<style>
.social-option:hover input[type="checkbox"]:not(:checked) {
  border-color: #6b7280;
}

.social-option input[type="checkbox"]:checked + div {
  opacity: 1;
}

.social-option input[type="checkbox"]:not(:checked) + div {
  opacity: 0.7;
}

/* Preview social buttons styling */
.social-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  border-radius: 4px;
  color: #000;
  text-decoration: none;
  transition: all 0.2s ease;
  background: none;
  border: none;
  cursor: pointer;
}

.social-btn:hover {
  transform: translateY(-2px);
  color: #333;
}

.social-btn i {
  font-size: 16px;
}

/* Social media hover colors */
.social-btn.behance:hover { color: #1769ff; }
.social-btn.whatsapp:hover { color: #25d366; }
.social-btn.facebook:hover { color: #0866ff; }
.social-btn.x:hover { color: #000; }
.social-btn.deviantart:hover { color: #475c4d; }
.social-btn.instagram:hover { color: #e23367; }
.social-btn.pinterest:hover { color: #CB2027; }
.social-btn.telegram:hover { color: #179cde; }
.social-btn.threads:hover { color: #000; }
.social-btn.bluesky:hover { color: #1083fe; }
.social-btn.twitter:hover { color: #1da1f2; }
.social-btn.linkedin:hover { color: #0274B3; }
.social-btn.reddit:hover { color: #FF5600; }
.social-btn.email:hover { color: #666; }

/* Sortable drag and drop styles */
.sortable-preview-item {
  transition: all 0.2s ease;
  user-select: none;
  position: relative;
}

.sortable-preview-item:hover {
  transform: translateY(-2px) scale(1.05);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  z-index: 10;
}

.sortable-preview-item:hover::after {
  content: "Drag to reorder";
  position: absolute;
  top: -30px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 0, 0, 0.8);
  color: white;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 11px;
  white-space: nowrap;
  pointer-events: none;
  z-index: 20;
}

.sortable-ghost {
  opacity: 0.5;
  background-color: #e5e7eb;
}

.sortable-chosen {
  transform: rotate(5deg);
}

.sortable-drag {
  opacity: 0.8;
  transform: rotate(5deg);
}
</style>
{% endblock %}
