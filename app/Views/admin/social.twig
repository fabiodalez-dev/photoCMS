{% extends 'admin/_layout.twig' %}

{% block title %}{{ trans('admin.social.title') }} â€” Cimaise{% endblock %}

{% block content %}
  <div class="flex items-center justify-between mb-8">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">{{ trans('admin.social.title') }}</h1>
      <p class="text-gray-600 mt-1">{{ trans('admin.social.description') }}</p>
    </div>
    <div class="flex items-center gap-3">
      <button type="submit" form="social-form" class="btn-primary">
        <i class="fas fa-save mr-2"></i>
        {{ trans('admin.social.save_settings') }}
      </button>
      <a href="{{ base_path }}/admin" class="btn-secondary">
        <i class="fas fa-arrow-left mr-2"></i>
        {{ trans('admin.common.dashboard') }}
      </a>
    </div>
  </div>

  <!-- Sticky Footer with Action Buttons -->
  <div class="fixed bottom-0 left-0 lg:left-64 right-0 bg-white border-t border-gray-200 shadow-lg admin-sticky-actions">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <button type="submit" form="social-form" class="btn-primary">
            <i class="fas fa-save mr-2"></i>
            {{ trans('admin.social.save_settings') }}
          </button>
          <a href="{{ base_path }}/admin" class="btn-secondary">
            <i class="fas fa-arrow-left mr-2"></i>
            {{ trans('admin.common.dashboard') }}
          </a>
        </div>
        
        <div class="text-sm text-gray-500">
          <i class="fas fa-info-circle mr-1"></i>
          {{ trans('admin.social.configure_hint') }}
        </div>
      </div>
    </div>
  </div>

  <div class="space-y-8 pb-48">
    <!-- Section 1: Photographer Social Profiles -->
    <div class="border-l-4 border-indigo-500 pl-4 mb-2">
      <h2 class="text-xl font-bold text-gray-900">{{ trans('admin.social.profiles_section') }}</h2>
      <p class="text-gray-600 mt-1">{{ trans('admin.social.profiles_section_desc') }}</p>
    </div>

    <div class="card">
      <div class="p-6">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h3 class="text-lg font-medium text-gray-900 flex items-center">
              <i class="fas fa-user-circle mr-3 text-gray-600"></i>{{ trans('admin.social.profiles_title') }}
            </h3>
            <p class="text-sm text-gray-500 mt-1">{{ trans('admin.social.profiles_description') }}</p>
          </div>
          <button type="button" id="add-profile-btn" class="btn-primary">
            <i class="fas fa-plus mr-2"></i>{{ trans('admin.social.add_profile') }}
          </button>
        </div>

        <div id="profiles-list" class="space-y-3">
          {% for profile in photographer_profiles %}
          <div class="profile-row flex items-center gap-3 p-3 bg-gray-50 rounded-lg" data-network="{{ profile.network }}">
            <i class="fas fa-grip-vertical text-gray-400 cursor-move profile-drag-handle"></i>
            <select class="profile-network rounded-md border-gray-300 text-sm w-40">
              {% for key, net in profile_networks %}
              <option value="{{ key }}" data-icon="{{ net.icon }}" {% if key == profile.network %}selected{% endif %}>{{ net.name }}</option>
              {% endfor %}
            </select>
            <input type="url" class="profile-url flex-1 rounded-md border-gray-300 text-sm" placeholder="https://..." value="{{ profile.url }}">
            <a href="{{ profile.url }}" target="_blank" rel="noopener noreferrer" class="profile-preview text-gray-500 hover:text-gray-700" title="{{ trans('admin.social.preview') }}">
              <i class="fas fa-external-link-alt"></i>
            </a>
            <button type="button" class="profile-remove text-red-500 hover:text-red-700" title="{{ trans('admin.common.delete') }}">
              <i class="fas fa-trash"></i>
            </button>
          </div>
          {% endfor %}
        </div>

        <div id="profiles-empty" class="text-center py-8 text-gray-500 {% if photographer_profiles|length > 0 %}hidden{% endif %}">
          <i class="fas fa-link text-3xl mb-2 text-gray-300"></i>
          <p>{{ trans('admin.social.no_profiles') }}</p>
        </div>
      </div>
    </div>

    <!-- Section 2: Social Sharing -->
    <div class="border-l-4 border-green-500 pl-4 mb-2 mt-12">
      <h2 class="text-xl font-bold text-gray-900">{{ trans('admin.social.sharing_section') }}</h2>
      <p class="text-gray-600 mt-1">{{ trans('admin.social.sharing_section_desc') }}</p>
    </div>

    <form id="social-form" action="{{ base_path }}/admin/social" method="post" class="space-y-8">
      <input type="hidden" name="csrf" value="{{ csrf }}">
      <input type="hidden" name="social_order" id="social-order-input" value="{{ social_order|json_encode|raw }}">

      <!-- Preview & Order -->
      <div class="card">
        <div class="p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-medium text-gray-900 flex items-center">
              <i class="fas fa-eye mr-3 text-gray-600"></i>{{ trans('admin.social.preview_order') }}
            </h3>
            <div class="text-sm text-gray-500"><span id="selected-count">{{ enabled_socials|length }}</span> {{ trans('admin.social.selected') }}</div>
          </div>
          <div id="preview-wrap" class="p-4 bg-gray-50 rounded-lg">
            <div id="preview" class="flex gap-3 flex-wrap"></div>
            <p id="preview-empty" class="text-sm text-gray-500 py-2" style="display:none">{{ trans('admin.social.no_social_selected') }}</p>
          </div>
        </div>
      </div>

      <!-- Elenco Social -->
      <div class="card">
        <div class="p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-medium text-gray-900 flex items-center">
              <i class="fas fa-share-alt mr-3 text-gray-600"></i>{{ trans('admin.social.available') }}
            </h3>
            <div class="flex items-center gap-2">
              <button type="button" id="btn-select-all" class="btn btn-sm btn-outline"><i class="fas fa-check-square mr-2"></i>{{ trans('admin.social.select_all') }}</button>
              <button type="button" id="btn-deselect-all" class="btn btn-sm btn-outline"><i class="fas fa-square mr-2"></i>{{ trans('admin.social.deselect_all') }}</button>
              <button type="submit" class="btn btn-sm"><i class="fas fa-save mr-2"></i>{{ trans('admin.common.save') }}</button>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3" id="social-list">
            {% for key, cfg in available_socials %}
              <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer" data-social="{{ key }}">
                <input type="checkbox" class="social-checkbox mr-3 rounded border-gray-300 text-black focus:ring-black" id="social_{{ key }}" name="social_{{ key }}" {% if key in enabled_socials %}checked{% endif %}>
                <i class="{{ cfg.icon }} mr-3" style="color: {{ cfg.color }}; width: 20px; text-align:center"></i>
                <div>
                  <div class="text-sm font-medium text-gray-900">{{ cfg.name }}</div>
                  {% set url = cfg.url %}
                  {% if url == '#' or url starts with 'javascript:' %}
                    <div class="text-xs text-gray-500">{{ trans('admin.social.icon_only') }}</div>
                  {% else %}
                    <div class="text-xs text-green-600">{{ trans('admin.social.sharing_available') }}</div>
                  {% endif %}
                </div>
              </label>
            {% endfor %}
          </div>
        </div>
      </div>
    </form>
  </div>
  <script nonce="{{ csp_nonce() }}">
(function(){
  // === PHOTOGRAPHER PROFILES MANAGEMENT ===
  const PROFILE_NETWORKS = {{ profile_networks|json_encode|raw }};
  const START_PROFILES = {{ photographer_profiles|json_encode|raw }};

  const profilesList = document.getElementById('profiles-list');
  const profilesEmpty = document.getElementById('profiles-empty');
  const addProfileBtn = document.getElementById('add-profile-btn');
  const csrfToken = document.querySelector('input[name="csrf"]').value;

  let profiles = Array.isArray(START_PROFILES) ? START_PROFILES : [];
  let profileSaveTimer = null;
  let profileSortable = null;

  // XSS protection: escape HTML entities
  function escapeHtml(str) {
    if (str == null) return '';
    const div = document.createElement('div');
    div.textContent = String(str);
    return div.innerHTML;
  }

  // URL validation
  function isValidUrl(string) {
    try {
      const url = new URL(string);
      return url.protocol === 'http:' || url.protocol === 'https:';
    } catch (_) {
      return false;
    }
  }

  // Sanitize URL for href attribute
  function sanitizeUrl(url) {
    if (!url || typeof url !== 'string') return '#';
    url = url.trim();
    // Only allow http/https protocols
    if (!/^https?:\/\//i.test(url)) return '#';
    try {
      const parsed = new URL(url);
      if (parsed.protocol !== 'http:' && parsed.protocol !== 'https:') return '#';
      return parsed.href;
    } catch (_) {
      return '#';
    }
  }

  function renderProfiles() {
    profilesList.innerHTML = '';

    if (profiles.length === 0) {
      profilesEmpty.classList.remove('hidden');
    } else {
      profilesEmpty.classList.add('hidden');
      profiles.forEach((profile, index) => {
        const row = createProfileRow(profile, index);
        profilesList.appendChild(row);
      });
    }

    initProfileSortable();
  }

  function createProfileRow(profile, index) {
    const row = document.createElement('div');
    row.className = 'profile-row flex items-center gap-3 p-3 bg-gray-50 rounded-lg';
    row.dataset.index = index;

    // Build network options with proper escaping
    let optionsHtml = '';
    for (const [key, net] of Object.entries(PROFILE_NETWORKS)) {
      const selected = key === profile.network ? ' selected' : '';
      optionsHtml += `<option value="${escapeHtml(key)}" data-icon="${escapeHtml(net.icon)}"${selected}>${escapeHtml(net.name)}</option>`;
    }

    const safeUrl = sanitizeUrl(profile.url);
    const displayUrl = escapeHtml(profile.url || '');

    row.innerHTML = `
      <i class="fas fa-grip-vertical text-gray-400 cursor-move profile-drag-handle"></i>
      <select class="profile-network rounded-md border-gray-300 text-sm w-40">${optionsHtml}</select>
      <input type="url" class="profile-url flex-1 rounded-md border-gray-300 text-sm" placeholder="https://..." value="${displayUrl}">
      <a href="${safeUrl}" target="_blank" rel="noopener noreferrer" class="profile-preview text-gray-500 hover:text-gray-700 ${safeUrl === '#' ? 'pointer-events-none opacity-30' : ''}" title="{{ trans('admin.social.preview') }}">
        <i class="fas fa-external-link-alt"></i>
      </a>
      <button type="button" class="profile-remove text-red-500 hover:text-red-700" title="{{ trans('admin.common.delete') }}">
        <i class="fas fa-trash"></i>
      </button>
    `;

    // Wire events
    const select = row.querySelector('.profile-network');
    const input = row.querySelector('.profile-url');
    const previewLink = row.querySelector('.profile-preview');
    const removeBtn = row.querySelector('.profile-remove');

    select.addEventListener('change', () => {
      profiles[index].network = select.value;
      saveProfilesDebounced();
    });

    input.addEventListener('input', () => {
      const url = input.value.trim();
      profiles[index].url = url;
      const safeHref = sanitizeUrl(url);
      previewLink.href = safeHref;
      if (safeHref === '#') {
        previewLink.classList.add('pointer-events-none', 'opacity-30');
      } else {
        previewLink.classList.remove('pointer-events-none', 'opacity-30');
      }
      saveProfilesDebounced();
    });

    removeBtn.addEventListener('click', () => {
      profiles.splice(index, 1);
      renderProfiles();
      saveProfilesDebounced();
    });

    return row;
  }

  function addNewProfile() {
    profiles.push({ network: 'instagram', url: '' });
    renderProfiles();
    // Focus the new URL input
    const inputs = profilesList.querySelectorAll('.profile-url');
    if (inputs.length) inputs[inputs.length - 1].focus();
  }

  function initProfileSortable() {
    if (profileSortable) {
      profileSortable.destroy();
      profileSortable = null;
    }

    function init() {
      if (typeof Sortable === 'undefined') return false;
      if (profiles.length < 2) return true; // No need to sort single item

      profileSortable = Sortable.create(profilesList, {
        animation: 150,
        handle: '.profile-drag-handle',
        onEnd: function() {
          // Rebuild profiles array from DOM order
          const newProfiles = [];
          profilesList.querySelectorAll('.profile-row').forEach(row => {
            const idx = parseInt(row.dataset.index, 10);
            if (!isNaN(idx) && profiles[idx]) {
              newProfiles.push(profiles[idx]);
            }
          });
          profiles = newProfiles;
          // Re-render to update indices
          renderProfiles();
          saveProfilesDebounced();
        }
      });
      return true;
    }

    if (!init()) {
      // Sortable not loaded yet, it will be loaded by the social sharing code
      setTimeout(init, 500);
    }
  }

  function saveProfilesDebounced() {
    if (profileSaveTimer) clearTimeout(profileSaveTimer);
    profileSaveTimer = setTimeout(saveProfilesAjax, 300);
  }

  function saveProfilesAjax() {
    // Filter out profiles with empty URLs and validate
    const validProfiles = profiles
      .filter(p => p.url && p.url.trim() !== '')
      .map(p => ({
        network: String(p.network || 'website'),
        url: String(p.url || '').trim()
      }));

    fetch('{{ base_path }}/admin/social/profiles', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRF-Token': csrfToken
      },
      body: JSON.stringify({ profiles: validProfiles })
    }).then(r => {
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return r.json();
    }).catch(err => {
      console.warn('Profile save error', err);
    });
  }

  // Initialize profiles
  addProfileBtn.addEventListener('click', addNewProfile);
  renderProfiles();

  // === SOCIAL SHARING SETTINGS ===
  // Data dal server
  const AVAILABLE = {{ available_socials|json_encode|raw }};
  const START_ENABLED = Array.isArray({{ enabled_socials|json_encode|raw }}) ? {{ enabled_socials|json_encode|raw }} : [];
  const START_ORDER = Array.isArray({{ social_order|json_encode|raw }}) ? {{ social_order|json_encode|raw }} : [];

  // Riferimenti DOM
  const form = document.getElementById('social-form');
  const preview = document.getElementById('preview');
  const previewEmpty = document.getElementById('preview-empty');
  const orderInput = document.getElementById('social-order-input');
  const countEl = document.getElementById('selected-count');
  const btnAll = document.getElementById('btn-select-all');
  const btnNone = document.getElementById('btn-deselect-all');
  const csrf = form.querySelector('input[name="csrf"]').value;

  // Stato
  let enabled = new Set(START_ENABLED);
  let order = normalizeOrder(START_ORDER, enabled);
  let saveTimer = null;

  // Init
  renderFromState();
  wireEvents();
  ensureSortable();

  function normalizeOrder(ord, enabledSet){
    const keys = Array.from(enabledSet);
    const out = [];
    (Array.isArray(ord) ? ord : []).forEach(k => { if (enabledSet.has(k)) out.push(k); });
    keys.forEach(k => { if (!out.includes(k)) out.push(k); });
    return out;
  }

  function renderFromState(){
    // update count
    countEl.textContent = enabled.size.toString();

    // update hidden input for non-AJAX submit
    orderInput.value = JSON.stringify(order);

    // render preview
    preview.innerHTML = '';
    if (enabled.size === 0) {
      previewEmpty.style.display = '';
    } else {
      previewEmpty.style.display = 'none';
      order.forEach(key => {
        if (!enabled.has(key) || !AVAILABLE[key]) return;
        const cfg = AVAILABLE[key];
        const el = document.createElement('div');
        el.className = 'preview-item social-btn ' + key;
        el.dataset.social = key;
        el.title = cfg.name;
        el.innerHTML = '<i class="' + cfg.icon + '"></i>';
        preview.appendChild(el);
      });
    }
  }

  function collectEnabledFromCheckboxes(){
    const out = [];
    document.querySelectorAll('.social-checkbox').forEach(cb => {
      if (cb.checked) out.push(cb.id.replace('social_', ''));
    });
    return out;
  }

  function onCheckboxChange(){
    enabled = new Set(collectEnabledFromCheckboxes());
    order = normalizeOrder(order, enabled);
    renderFromState();
    saveDebounced();
  }

  function updateOrderFromDOM(){
    const newOrder = [];
    preview.querySelectorAll('.preview-item').forEach(n => {
      const k = n.dataset.social; if (k) newOrder.push(k);
    });
    order = normalizeOrder(newOrder, enabled);
    orderInput.value = JSON.stringify(order);
    saveDebounced();
  }

  function saveDebounced(){
    if (saveTimer) clearTimeout(saveTimer);
    saveTimer = setTimeout(saveAjax, 250);
  }

  function saveAjax(){
    const payload = { enabled: Array.from(enabled), order };
    fetch('{{ base_path }}/admin/social', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRF-Token': csrf
      },
      body: JSON.stringify(payload)
    }).then(r => {
      if (!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }).then(json => {
      // Optionally, could show a toast
      // console.log('saved', json);
    }).catch(err => {
      console.warn('save error', err);
    });
  }

  function wireEvents(){
    document.querySelectorAll('.social-checkbox').forEach(cb => {
      cb.addEventListener('change', onCheckboxChange);
    });
    btnAll.addEventListener('click', function(){
      document.querySelectorAll('.social-checkbox').forEach(cb => cb.checked = true);
      onCheckboxChange();
    });
    btnNone.addEventListener('click', function(){
      document.querySelectorAll('.social-checkbox').forEach(cb => cb.checked = false);
      onCheckboxChange();
    });
    form.addEventListener('submit', function(){
      // ensure latest order is in the hidden input
      orderInput.value = JSON.stringify(order);
    });
  }

  function ensureSortable(){
    function init(){
      if (typeof Sortable === 'undefined') return false;
      Sortable.create(preview, { animation: 150, onEnd: updateOrderFromDOM });
      return true;
    }
    if (init()) return;
    var s = document.createElement('script');
    s.src = (window.basePath || '') + '/assets/vendor/sortablejs/Sortable.min.js';
    s.defer = true;
    s.onload = init;
    document.head.appendChild(s);
  }
})();

// SPA support: re-initialize on dynamic loads
window.pageInitializers = window.pageInitializers || {};
window.pageInitializers.social = function(){
  const form = document.getElementById('social-form');
  if (!form) return;
  const cbs = document.querySelectorAll('.social-checkbox');
  if (cbs.length) {
    cbs[cbs.length-1].dispatchEvent(new Event('change'));
  }
};
</script>

<style nonce="{{ csp_nonce() }}">
/* preview buttons */
.social-btn { display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius:6px; color:#111; transition:transform .15s ease; cursor:move; }
.social-btn i { font-size:18px; }
.social-btn:hover { transform: translateY(-2px) scale(1.05); }
.preview-item { user-select:none; }
/* hover colors */
.social-btn.facebook:hover{color:#0866ff}
.social-btn.twitter:hover{color:#1da1f2}
.social-btn.x:hover{color:#000}
.social-btn.instagram:hover{color:#e23367}
.social-btn.whatsapp:hover{color:#25d366}
.social-btn.pinterest:hover{color:#CB2027}
.social-btn.telegram:hover{color:#179cde}
.social-btn.behance:hover{color:#1769ff}
.social-btn.bluesky:hover{color:#1083fe}
</style>
{% endblock %}
