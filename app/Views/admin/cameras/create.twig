{% extends 'admin/_layout.twig' %}
{% block title %}{{ trans('admin.cameras.new') }} — Cimaise{% endblock %}
{% block content %}
  <div class="flex items-center justify-between mb-4"><h1 class="text-2xl font-bold text-gray-900">{{ trans('admin.cameras.new') }}</h1></div>
  <form method="post" action="{{ base_path }}/admin/cameras">
    <input type="hidden" name="csrf" value="{{ csrf }}">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">{{ trans('admin.cameras.make') }}</label>
        <div class="autocomplete-wrapper relative">
          <input class="form-input" type="text" name="make" id="camera-make" required autocomplete="off" data-autocomplete="camera-make">
          <div class="autocomplete-dropdown hidden absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-48 overflow-y-auto"></div>
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">{{ trans('admin.cameras.model') }}</label>
        <div class="autocomplete-wrapper relative">
          <input class="form-input" type="text" name="model" id="camera-model" required autocomplete="off" data-autocomplete="camera-model">
          <div class="autocomplete-dropdown hidden absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-48 overflow-y-auto"></div>
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">{{ trans('admin.cameras.type') }}</label>
        <select class="form-input" name="type" id="camera-type">
          <option value="">— {{ trans('admin.common.select') }} —</option>
          {% for key, label in camera_types %}
            <option value="{{ key }}">{{ label }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
    <div class="mt-3 flex gap-3"><button class="btn-primary">{{ trans('admin.common.save') }}</button> <a class="btn-secondary" href="{{ base_path }}/admin/cameras">{{ trans('admin.common.cancel') }}</a></div>
  </form>

  <script nonce="{{ csp_nonce() }}">
  document.addEventListener('DOMContentLoaded', function() {
    const autocompleteInputs = document.querySelectorAll('[data-autocomplete]');
    let autocompleteTimeout = null;

    autocompleteInputs.forEach(input => {
      const wrapper = input.closest('.autocomplete-wrapper');
      const dropdown = wrapper.querySelector('.autocomplete-dropdown');
      const type = input.dataset.autocomplete;

      input.addEventListener('input', () => {
        const query = input.value.trim();
        clearTimeout(autocompleteTimeout);
        if (query.length < 2) { dropdown.classList.add('hidden'); return; }
        autocompleteTimeout = setTimeout(() => fetchSuggestions(query, type, dropdown, input), 300);
      });

      input.addEventListener('focus', () => {
        if (dropdown.children.length > 0 && input.value.trim().length >= 2) dropdown.classList.remove('hidden');
      });

      input.addEventListener('blur', () => setTimeout(() => dropdown.classList.add('hidden'), 200));

      input.addEventListener('keydown', (e) => {
        if (dropdown.classList.contains('hidden')) return;
        const items = dropdown.querySelectorAll('.autocomplete-item');
        const current = dropdown.querySelector('.autocomplete-item.bg-blue-100');
        let index = Array.from(items).indexOf(current);
        if (e.key === 'ArrowDown') { e.preventDefault(); index = Math.min(index + 1, items.length - 1); }
        else if (e.key === 'ArrowUp') { e.preventDefault(); index = Math.max(index - 1, 0); }
        else if (e.key === 'Enter' && current) { e.preventDefault(); selectItem(current, input, dropdown); return; }
        else if (e.key === 'Escape') { dropdown.classList.add('hidden'); return; }
        items.forEach((item, i) => item.classList.toggle('bg-blue-100', i === index));
        items[index]?.scrollIntoView({ block: 'nearest' });
      });
    });

    async function fetchSuggestions(query, type, dropdown, input) {
      let endpoint = type === 'camera-make'
        ? '{{ base_path }}/admin/api/lensfun/makers'
        : '{{ base_path }}/admin/api/lensfun/cameras';

      // Add maker filter when searching for camera models
      if (type === 'camera-model') {
        const makerInput = document.getElementById('camera-make');
        const makerValue = makerInput?.value?.trim() || '';
        if (makerValue) {
          endpoint += `?q=${encodeURIComponent(query)}&maker=${encodeURIComponent(makerValue)}&limit=15`;
        } else {
          endpoint += `?q=${encodeURIComponent(query)}&limit=15`;
        }
      } else {
        endpoint += `?q=${encodeURIComponent(query)}&limit=15`;
      }

      try {
        const response = await fetch(endpoint, { credentials: 'same-origin' });
        if (!response.ok) {
          console.error('Autocomplete fetch failed:', response.status, response.statusText);
          dropdown.classList.add('hidden');
          return;
        }
        const data = await response.json();
        if (data.success && data.results?.length > 0) {
          renderDropdown(data.results, type, dropdown, input, data.total);
        } else {
          dropdown.innerHTML = '<div class="px-3 py-2 text-xs text-gray-500 italic">{{ trans('admin.exif.no_results')|default('No results found')|e('js') }}</div>';
          dropdown.classList.remove('hidden');
        }
      } catch (error) {
        console.error('Autocomplete error:', error);
        dropdown.classList.add('hidden');
      }
    }

    function renderDropdown(results, type, dropdown, input, total) {
      dropdown.innerHTML = '';
      results.forEach(item => {
        const div = document.createElement('div');
        div.className = 'autocomplete-item px-3 py-2 text-sm cursor-pointer hover:bg-gray-100';
        if (type === 'camera-make') {
          div.textContent = item.maker;
          div.dataset.value = item.maker;
        } else {
          div.innerHTML = `<span class="font-medium">${escapeHtml(item.model)}</span> <span class="text-xs text-gray-500">(${escapeHtml(item.maker)})</span>`;
          div.dataset.value = item.model;
          div.dataset.maker = item.maker;
        }
        div.addEventListener('click', () => selectItem(div, input, dropdown));
        dropdown.appendChild(div);
      });
      // Show hint if there are more results
      if (total > results.length) {
        const hint = document.createElement('div');
        hint.className = 'px-3 py-2 text-xs text-gray-500 italic border-t border-gray-200';
        hint.textContent = '{{ trans('admin.exif.results_hint')|default('Showing {shown} of {total} - refine your search')|e('js') }}'.replace('{shown}', results.length).replace('{total}', total);
        dropdown.appendChild(hint);
      }
      dropdown.classList.remove('hidden');
    }

    function selectItem(item, input, dropdown) {
      input.value = item.dataset.value;
      dropdown.classList.add('hidden');
      // Auto-fill maker when selecting model
      if (input.dataset.autocomplete === 'camera-model' && item.dataset.maker) {
        const makeInput = document.getElementById('camera-make');
        if (makeInput && !makeInput.value) makeInput.value = item.dataset.maker;
      }
    }

    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }
  });
  </script>
{% endblock %}
