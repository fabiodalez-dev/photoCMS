{% extends "admin/_layout.twig" %}

{% block title %}Analytics Settings — Cimaise{% endblock %}

{% block content %}
<div class="p-6">
  <!-- Header -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-8">
    <div>
      <h1 class="text-2xl font-bold text-gray-900 mb-2">Analytics Settings</h1>
      <p class="text-gray-600">Configure privacy, data retention, and tracking options</p>
    </div>
    <div class="flex gap-3 mt-4 md:mt-0">
      <a href="{{ base_path }}/admin/analytics" class="btn-secondary" data-spa-link>
        <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
      </a>
    </div>
  </div>

  <!-- Flash Messages -->
  {% include 'admin/_flash_messages.twig' %}

  <!-- Settings Form -->
  <form method="post" action="{{ base_path }}/admin/analytics/settings" class="space-y-8">
    <input type="hidden" name="csrf" value="{{ csrf }}">

    <!-- Privacy & Data Collection -->
    <div class="card p-6">
      <div class="border-b border-gray-200 pb-4 mb-6">
        <h2 class="text-lg font-semibold text-gray-900">Privacy & Data Collection</h2>
        <p class="text-sm text-gray-600 mt-1">Configure how visitor data is collected and processed</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Analytics Enabled -->
        <div class="space-y-4">
          <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
            <div class="flex-1">
              <label for="analytics_enabled" class="text-sm font-medium text-gray-900">Enable Analytics</label>
              <p class="text-xs text-gray-600 mt-1">Turn analytics tracking on or off globally</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="hidden" name="analytics_enabled" value="false">
              <input type="checkbox" name="analytics_enabled" id="analytics_enabled" value="true" 
                     class="sr-only peer" {% if settings.analytics_enabled == 'true' %}checked{% endif %}>
              <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-gray-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-black"></div>
            </label>
          </div>

          <!-- IP Anonymization -->
          <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
            <div class="flex-1">
              <label for="ip_anonymization" class="text-sm font-medium text-gray-900">IP Anonymization</label>
              <p class="text-xs text-gray-600 mt-1">Anonymize visitor IP addresses for privacy compliance</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="hidden" name="ip_anonymization" value="false">
              <input type="checkbox" name="ip_anonymization" id="ip_anonymization" value="true" 
                     class="sr-only peer" {% if settings.ip_anonymization == 'true' %}checked{% endif %}>
              <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-gray-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-black"></div>
            </label>
          </div>

          <!-- Bot Detection -->
          <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
            <div class="flex-1">
              <label for="bot_detection_enabled" class="text-sm font-medium text-gray-900">Bot Detection</label>
              <p class="text-xs text-gray-600 mt-1">Filter out bot traffic from analytics data</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="hidden" name="bot_detection_enabled" value="false">
              <input type="checkbox" name="bot_detection_enabled" id="bot_detection_enabled" value="true" 
                     class="sr-only peer" {% if settings.bot_detection_enabled == 'true' %}checked{% endif %}>
              <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-gray-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-black"></div>
            </label>
          </div>
        </div>

        <div class="space-y-4">
          <!-- Geolocation -->
          <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
            <div class="flex-1">
              <label for="geolocation_enabled" class="text-sm font-medium text-gray-900">Geographic Data</label>
              <p class="text-xs text-gray-600 mt-1">Collect country and region information from IP addresses</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="hidden" name="geolocation_enabled" value="false">
              <input type="checkbox" name="geolocation_enabled" id="geolocation_enabled" value="true" 
                     class="sr-only peer" {% if settings.geolocation_enabled == 'true' %}checked{% endif %}>
              <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-gray-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-black"></div>
            </label>
          </div>

          <!-- Real-time Tracking -->
          <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
            <div class="flex-1">
              <label for="real_time_enabled" class="text-sm font-medium text-gray-900">Real-time Tracking</label>
              <p class="text-xs text-gray-600 mt-1">Enable live visitor monitoring and real-time updates</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="hidden" name="real_time_enabled" value="false">
              <input type="checkbox" name="real_time_enabled" id="real_time_enabled" value="true" 
                     class="sr-only peer" {% if settings.real_time_enabled == 'true' %}checked{% endif %}>
              <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-gray-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-black"></div>
            </label>
          </div>

          <!-- Data Export -->
          <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
            <div class="flex-1">
              <label for="export_enabled" class="text-sm font-medium text-gray-900">Data Export</label>
              <p class="text-xs text-gray-600 mt-1">Allow exporting analytics data to CSV/JSON formats</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="hidden" name="export_enabled" value="false">
              <input type="checkbox" name="export_enabled" id="export_enabled" value="true" 
                     class="sr-only peer" {% if settings.export_enabled == 'true' %}checked{% endif %}>
              <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-gray-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-black"></div>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Data Retention -->
    <div class="card p-6">
      <div class="border-b border-gray-200 pb-4 mb-6">
        <h2 class="text-lg font-semibold text-gray-900">Data Retention</h2>
        <p class="text-sm text-gray-600 mt-1">Configure how long analytics data is stored</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Data Retention Days -->
        <div>
          <label for="data_retention_days" class="block text-sm font-medium text-gray-700 mb-2">Data Retention Period</label>
          <select name="data_retention_days" id="data_retention_days" class="form-input">
            {% set retention = settings.data_retention_days|default('365') %}
            <option value="30" {% if retention == '30' %}selected{% endif %}>30 days</option>
            <option value="90" {% if retention == '90' %}selected{% endif %}>90 days</option>
            <option value="180" {% if retention == '180' %}selected{% endif %}>6 months</option>
            <option value="365" {% if retention == '365' %}selected{% endif %}>1 year</option>
            <option value="730" {% if retention == '730' %}selected{% endif %}>2 years</option>
            <option value="0" {% if retention == '0' %}selected{% endif %}>Never delete</option>
          </select>
          <p class="text-xs text-gray-500 mt-1">Older data will be automatically deleted</p>
        </div>

        <!-- Session Timeout -->
        <div>
          <label for="session_timeout_minutes" class="block text-sm font-medium text-gray-700 mb-2">Session Timeout</label>
          <select name="session_timeout_minutes" id="session_timeout_minutes" class="form-input">
            {% set timeout = settings.session_timeout_minutes|default('30') %}
            <option value="15" {% if timeout == '15' %}selected{% endif %}>15 minutes</option>
            <option value="30" {% if timeout == '30' %}selected{% endif %}>30 minutes</option>
            <option value="60" {% if timeout == '60' %}selected{% endif %}>1 hour</option>
            <option value="120" {% if timeout == '120' %}selected{% endif %}>2 hours</option>
          </select>
          <p class="text-xs text-gray-500 mt-1">Time before a session is considered ended</p>
        </div>
      </div>
    </div>

    <!-- Privacy Notice -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
      <div class="flex items-start">
        <i class="fas fa-info-circle text-blue-600 mt-1 mr-3"></i>
        <div>
          <h3 class="text-sm font-medium text-blue-800 mb-2">Privacy & GDPR Compliance</h3>
          <ul class="text-sm text-blue-700 space-y-1">
            <li>• No cookies are used for analytics tracking - data is stored in sessionStorage</li>
            <li>• IP addresses are hashed and can be anonymized for privacy compliance</li>
            <li>• Geographic data is collected from IP addresses but can be disabled</li>
            <li>• Bot traffic is automatically filtered when enabled</li>
            <li>• All data collection respects your configured retention policies</li>
          </ul>
          <div class="mt-4 pt-4 border-t border-blue-200">
            <p class="text-xs text-blue-600">
              <strong>Note:</strong> This analytics system is designed to be cookieless and privacy-first. 
              However, you should still review your local privacy laws and update your privacy policy accordingly.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Data Management -->
    <div class="card p-6">
      <div class="border-b border-gray-200 pb-4 mb-6">
        <h2 class="text-lg font-semibold text-gray-900">Data Management</h2>
        <p class="text-sm text-gray-600 mt-1">Tools for managing your analytics data</p>
      </div>

      <div class="flex flex-col sm:flex-row gap-4">
        <a href="{{ base_path }}/admin/analytics/export" class="btn-secondary flex-1 text-center">
          <i class="fas fa-download mr-2"></i>Export All Data
        </a>
        <form method="post" action="{{ base_path }}/admin/analytics/cleanup" class="flex-1" 
              onsubmit="return confirm('Are you sure you want to clean up old analytics data? This action cannot be undone.')">
          <input type="hidden" name="csrf" value="{{ csrf }}">
          <button type="submit" class="btn-secondary w-full">
            <i class="fas fa-trash-alt mr-2"></i>Clean Up Old Data
          </button>
        </form>
      </div>
      <p class="text-xs text-gray-500 mt-2 text-center">
        Cleanup removes data older than your retention period. Export includes all available data.
      </p>
    </div>

    <!-- Save Button -->
    <div class="flex justify-end">
      <button type="submit" class="btn-primary">
        <i class="fas fa-save mr-2"></i>Save Settings
      </button>
    </div>
  </form>
</div>

<style>
/* Custom toggle switch styles */
.peer:checked + div {
  background-color: #000;
}

/* Smooth transitions */
.form-input, .btn-primary, .btn-secondary {
  transition: all 0.2s ease;
}

/* Card hover effects */
.card {
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.card:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

/* Responsive improvements */
@media (max-width: 768px) {
  .grid {
    grid-template-columns: 1fr;
  }
  
  .flex-col.sm\\:flex-row {
    flex-direction: column;
  }
}
</style>

<script>
// Add interactivity for settings
document.addEventListener('DOMContentLoaded', function() {
  // Analytics enabled toggle - show/hide dependent options
  const analyticsEnabledToggle = document.getElementById('analytics_enabled');
  const dependentSettings = document.querySelectorAll('#ip_anonymization, #bot_detection_enabled, #geolocation_enabled, #real_time_enabled, #export_enabled');
  
  function toggleDependentSettings() {
    const isEnabled = analyticsEnabledToggle.checked;
    dependentSettings.forEach(setting => {
      const container = setting.closest('.bg-gray-50');
      if (container) {
        container.style.opacity = isEnabled ? '1' : '0.5';
        setting.disabled = !isEnabled;
      }
    });
  }
  
  analyticsEnabledToggle.addEventListener('change', toggleDependentSettings);
  toggleDependentSettings(); // Initial state
  
  // Form validation
  const form = document.querySelector('form');
  form.addEventListener('submit', function(e) {
    // Add any custom validation here
  });
});
</script>
{% endblock %}