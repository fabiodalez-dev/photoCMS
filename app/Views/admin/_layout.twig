<!doctype html>
<html lang="{{ admin_language|default('en')|e('html_attr') }}">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}Admin â€” Cimaise{% endblock %}</title>
  <!-- Favicon & App Icons -->
  <link rel="icon" type="image/x-icon" href="{{ base_path }}/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="{{ base_path }}/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="{{ base_path }}/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="{{ base_path }}/apple-touch-icon.png">
  <link href="{{ base_path }}/assets/app.css" rel="stylesheet">
  <link href="{{ base_path }}/assets/admin.css" rel="stylesheet">
  <link href="{{ base_path }}/assets/vendor/fontawesome/css/all.min.css" rel="stylesheet">
  <script nonce="{{ csp_nonce() }}">
    window.basePath = '{{ base_path|e('js') }}';
    window.cspNonce = '{{ csp_nonce()|e('js') }}';
    window.__ADMIN_DEBUG = {{ admin_debug|default(false) ? 'true' : 'false' }};

    // Admin i18n for static JS bundles
    // `admin_translations` is injected server-side in public/index.php when $isAdminRoute is true.
    window.adminTranslations = {{ (admin_translations|default({}))|json_encode|raw }};

    window.adminT = function(key, fallback) {
      if (window.adminTranslations && Object.prototype.hasOwnProperty.call(window.adminTranslations, key)) {
        return window.adminTranslations[key];
      }
      return fallback || key;
    };

    window.adminTf = function(key, params, fallback) {
      const tpl = window.adminT(key, fallback);
      let out = String(tpl ?? '');
      if (params && typeof params === 'object') {
        Object.keys(params).forEach((k) => {
          out = out.replaceAll(`{${k}}`, String(params[k]));
        });
      }
      return out;
    };
  </script>
  <style nonce="{{ csp_nonce() }}">
    body {
      margin: 0;
      padding: 0;
    }
    .sidebar-link {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      color: #374151;
      text-decoration: none;
      transition: background-color 0.15s ease, color 0.15s ease;
      margin-bottom: 4px;
      border-radius: 6px;
    }
    .sidebar-link:hover {
      background-color: #f3f4f6;
      color: #000;
    }
    .sidebar-link.active { 
      background-color: #000; 
      color: #fff; 
    }
    .sidebar-link i { 
      width: 20px; 
      margin-right: 12px; 
      text-align: center; 
    }
    .btn-primary { 
      background-color: #000; 
      color: #fff; 
      padding: 8px 24px; 
      border-radius: 6px; 
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      transition: background-color 0.2s;
    }
    .btn-primary:hover { 
      background-color: #374151; 
    }
    .btn-secondary { 
      background-color: #e5e7eb; 
      color: #374151; 
      padding: 8px 24px; 
      border-radius: 6px; 
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      transition: background-color 0.2s;
    }
    .btn-secondary:hover { 
      background-color: #d1d5db; 
    }
    .btn-outline-danger {
      background-color: transparent;
      color: #dc2626;
      padding: 8px 24px;
      border: 1px solid #dc2626;
      border-radius: 6px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      transition: background-color 0.15s ease, color 0.15s ease;
    }
    .btn-outline-danger:hover {
      background-color: #dc2626;
      color: white;
    }
    .btn-outline-danger:disabled { 
      opacity: 0.5; 
      cursor: not-allowed;
    }
    .admin-sticky-actions {
      z-index: 200000;
    }
    
    /* TinyMCE Toolbar Fix */
    .tox:not(.tox-tinymce-inline) .tox-editor-header {
      display: block !important;
    }
    .tox .tox-toolbar {
      display: flex !important;
      flex-wrap: wrap;
      border-bottom: 1px solid #e5e5e5;
      padding: 4px 8px;
      background: #f4f4f4;
    }
    .tox .tox-toolbar__group {
      display: flex !important;
      align-items: center;
      padding: 0 !important;
      margin: 0 !important;
      border: 0 !important;
    }
    .tox:not([dir=rtl]) .tox-toolbar__group:not(:last-of-type) {
      border-right: none !important;
    }
    .tox .tox-tbtn {
      margin: 2px 1px;
      padding: 4px 6px;
      border-radius: 3px;
    }
    .tox .tox-tbtn:hover {
      background: #e5e5e5;
    }
    .btn-sm {
      padding: 6px 12px;
      font-size: 0.875rem;
      line-height: 1.25rem;
    }
    .card { 
      background-color: #fff; 
      border-radius: 8px; 
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); 
      border: 1px solid #e5e7eb; 
    }
    .form-input {
      width: 100%;
      padding: 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }
    .form-input:focus {
      outline: none;
      border-color: #000;
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
    }
    .input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
      font-size: 14px;
    }
    .input:focus {
      outline: none;
      border-color: #000;
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
    }
    .table-row:hover { 
      background-color: #f9fafb; 
    }
    .dropdown {
      position: relative;
      display: inline-block;
    }
    .dropdown-content {
      display: none;
      position: absolute;
      right: 0;
      background-color: white;
      min-width: 280px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      z-index: 1000;
      top: 100%;
      margin-top: 8px;
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity 0.2s ease, transform 0.2s ease;
    }
    .dropdown-content.show {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }
    /* Expanded hover area to prevent accidental closing */
    .dropdown::after {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      bottom: -10px;
      left: 0;
      z-index: 999;
    }
    .dropdown-content::before {
      content: '';
      position: absolute;
      top: -10px;
      right: 0;
      left: 0;
      height: 10px;
      background: transparent;
    }
    .dropdown-item {
      color: #374151;
      padding: 12px 16px;
      text-decoration: none;
      display: flex;
      align-items: center;
      transition: background-color 0.2s;
      border-bottom: 1px solid #f3f4f6;
    }
    .dropdown-item:hover {
      background-color: #f9fafb;
    }
    .dropdown-item:last-child {
      border-bottom: none;
      border-radius: 0 0 8px 8px;
    }
    .dropdown-item:first-child {
      border-radius: 8px 8px 0 0;
    }
    .dropdown-item i {
      width: 20px;
      margin-right: 12px;
      text-align: center;
    }
    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #1f2937;
      font-weight: 400;
      font-size: 14px;
    }
    /* TomSelect: remove double border and align with form-input */
    .ts-wrapper.form-input { border: 0 !important; padding: 0 !important; background: transparent !important; }
    .ts-wrapper .ts-control { border: 1px solid #d1d5db !important; border-radius: 6px; min-height: 38px; }
    .ts-wrapper .ts-control:focus-within { outline: none; box-shadow: 0 0 0 3px rgba(0,0,0,0.1); border-color: #000; }
    .ts-wrapper .ts-control .item { background: #111; color: #fff; border-radius: 9999px; padding: 2px 8px; margin: 2px; }
    .ts-dropdown { z-index: 99999; }
  </style>
  <!-- PhotoSwipe CSS -->
  <link rel="stylesheet" href="{{ base_path }}/assets/photoswipe/dist/photoswipe.css">
</head>
<body class="bg-gray-50">
  <!-- Header -->
  <nav class="bg-white border-b border-gray-200 fixed w-full z-30 top-0">
    <div class="px-6 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <!-- Hamburger Menu Button (Mobile/Tablet) -->
          <button id="sidebar-toggle" class="lg:hidden mr-3 p-2 rounded-md text-gray-600 hover:text-black hover:bg-gray-100 transition-colors">
            <i class="fas fa-bars"></i>
          </button>
          
          {% if site_logo %}
            <img src="{{ base_path ~ site_logo }}" alt="{{ site_title|default('Cimaise')|e }}" class="h-7 w-auto mr-3">
          {% else %}
            <i class="fas fa-camera text-2xl text-black mr-3"></i>
            <h1 class="text-xl font-semibold text-black">{{ site_title|default('Cimaise') }}</h1>
          {% endif %}
        </div>
        
        <!-- User Administration Area -->
        <div class="flex items-center space-x-6">
          <!-- Frontend Link -->
          <a href="{{ base_path }}/" target="_blank" class="text-gray-600 hover:text-black transition-colors flex items-center space-x-2" title="{{ trans('admin.header.view_frontend') }}">
            <i class="fas fa-external-link-alt"></i>
            <span class="hidden md:inline text-sm">{{ trans('admin.header.frontend') }}</span>
          </a>
          
          <!-- User Dropdown -->
          <div class="dropdown">
            <button class="flex items-center space-x-3 text-gray-700 hover:text-black transition-colors cursor-pointer">
              <!-- User Avatar -->
              <div class="user-avatar">
                {% if session.admin_name %}
                  {{ session.admin_name|split(' ')|map(name => name|first)|join('')|upper|e }}
                {% else %}
                  <i class="fas fa-user"></i>
                {% endif %}
              </div>
              
              <!-- User Info -->
              <div class="hidden md:block text-left">
                <div class="text-sm font-medium">
                  {% if session.admin_name %}
                    {{ session.admin_name|e }}
                  {% else %}
                    {{ trans('admin.header.admin_user') }}
                  {% endif %}
                </div>
                <div class="text-xs text-gray-500">
                  {% if session.admin_email %}
                    {{ session.admin_email|e }}
                  {% else %}
                    {{ trans('admin.header.administrator') }}
                  {% endif %}
                </div>
              </div>
              
              <i class="fas fa-chevron-down text-xs"></i>
            </button>
            
            <!-- Dropdown Menu -->
            <div class="dropdown-content">
              <!-- User Info Header -->
              <div class="px-4 py-3 border-b border-gray-100 bg-gray-50">
                <div class="flex items-center space-x-3">
                  <div class="user-avatar">
                    {% if session.admin_name %}
                      {{ session.admin_name|split(' ')|map(name => name|first)|join('')|upper|e }}
                    {% else %}
                      <i class="fas fa-user"></i>
                    {% endif %}
                  </div>
                  <div>
                    <div class="font-medium text-gray-900">
                      {% if session.admin_name %}
                        {{ session.admin_name|e }}
                      {% else %}
                        {{ trans('admin.header.admin_user') }}
                      {% endif %}
                    </div>
                    <div class="text-sm text-gray-500">
                      {% if session.admin_email %}
                        {{ session.admin_email|e }}
                      {% else %}
                        {{ trans('admin.header.administrator') }}
                      {% endif %}
                    </div>
                    <div class="text-xs text-gray-400 mt-1">
                      <i class="fas fa-shield-alt mr-1"></i>{{ session.admin_role|default('admin')|title|e }}
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Menu Items -->
              <a href="#" data-action="open-profile-modal" class="dropdown-item">
                <i class="fas fa-user-edit"></i>
                <div>
                  <div class="font-medium">{{ trans('admin.profile.my_profile') }}</div>
                  <div class="text-xs text-gray-500">{{ trans('admin.profile.edit_personal_info') }}</div>
                </div>
              </a>

              <a href="#" data-action="open-password-modal" class="dropdown-item">
                <i class="fas fa-key"></i>
                <div>
                  <div class="font-medium">{{ trans('admin.profile.change_password') }}</div>
                  <div class="text-xs text-gray-500">{{ trans('admin.profile.update_credentials') }}</div>
                </div>
              </a>

              <div class="border-t border-gray-100 my-1"></div>

              <a href="{{ base_path }}/admin/users" class="dropdown-item">
                <i class="fas fa-users-cog"></i>
                <div>
                  <div class="font-medium">{{ trans('admin.users.title') }}</div>
                  <div class="text-xs text-gray-500">{{ trans('admin.users.manage_all') }}</div>
                </div>
              </a>

              <a href="{{ base_path }}/admin/settings" class="dropdown-item">
                <i class="fas fa-cog"></i>
                <div>
                  <div class="font-medium">{{ trans('admin.system.settings') }}</div>
                  <div class="text-xs text-gray-500">{{ trans('admin.system.configure') }}</div>
                </div>
              </a>

              <div class="border-t border-gray-100 my-1"></div>

              <form method="post" action="{{ base_path }}/admin/logout" class="m-0">
                <input type="hidden" name="csrf" value="{{ csrf }}">
                <button type="submit" class="dropdown-item text-red-600 hover:bg-red-50 w-full text-left border-0 bg-transparent cursor-pointer">
                  <i class="fas fa-sign-out-alt"></i>
                  <div>
                    <div class="font-medium">{{ trans('admin.logout') }}</div>
                    <div class="text-xs text-red-400">{{ trans('admin.logout.exit') }}</div>
                  </div>
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <div class="flex pt-16 relative">
    <!-- Sidebar Overlay (Mobile/Tablet) -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden hidden"></div>
    
    <!-- Sidebar -->
    <div id="sidebar" class="fixed lg:sticky lg:top-16 w-64 bg-white border-r border-gray-200 h-[calc(100vh-4rem)] max-h-[calc(100vh-4rem)] overflow-y-auto transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out z-50 lg:z-auto">
      <div class="p-6">
        <!-- Close Button (Mobile/Tablet) -->
        <div class="lg:hidden flex justify-end mb-4">
          <button id="sidebar-close" class="p-2 rounded-md text-gray-600 hover:text-black hover:bg-gray-100 transition-colors">
            <i class="fas fa-times"></i>
          </button>
        </div>

        {# Hook: admin_sidebar_before - Before all sidebar sections #}
        {{ do_action('admin_sidebar_before', {base_path: base_path}) }}

        <!-- Main Navigation -->
        <div class="mb-8">
          <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-4">{{ trans('admin.sidebar.navigation') }}</p>
          <div class="space-y-1">
            <a href="{{ base_path }}/admin" class="sidebar-link" data-spa-link>
              <i class="fas fa-tachometer-alt"></i>{{ trans('admin.sidebar.dashboard') }}
            </a>
            <a href="{{ base_path }}/admin/media" class="sidebar-link" data-spa-link>
              <i class="fas fa-images"></i>{{ trans('admin.sidebar.gallery') }}
            </a>
            <a href="{{ base_path }}/admin/albums" class="sidebar-link" data-spa-link>
              <i class="fas fa-images"></i>{{ trans('admin.sidebar.albums') }}
            </a>
            <a href="{{ base_path }}/admin/categories" class="sidebar-link" data-spa-link>
              <i class="fas fa-folder"></i>{{ trans('admin.sidebar.categories') }}
            </a>
            <a href="{{ base_path }}/admin/tags" class="sidebar-link" data-spa-link>
              <i class="fas fa-tags"></i>{{ trans('admin.sidebar.tags') }}
            </a>
            <a href="{{ base_path }}/admin/templates" class="sidebar-link" data-spa-link>
              <i class="fas fa-palette"></i>{{ trans('admin.sidebar.templates') }}
            </a>
            <a href="{{ base_path }}/admin/pages" class="sidebar-link" data-spa-link>
              <i class="fas fa-file-alt"></i>{{ trans('admin.sidebar.pages') }}
            </a>
            <a href="{{ base_path }}/admin/texts" class="sidebar-link" data-spa-link>
              <i class="fas fa-language"></i>{{ trans('admin.sidebar.texts') }}
            </a>
            {# Hook: admin_sidebar_navigation - Add custom navigation items #}
            {{ do_action('admin_sidebar_navigation', {base_path: base_path}) }}
          </div>
        </div>

        <!-- Metadata -->
        <div class="mb-8">
          <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-4">{{ trans('admin.sidebar.metadata') }}</p>
          <div class="space-y-1">
            <a href="{{ base_path }}/admin/cameras" class="sidebar-link" data-spa-link>
              <i class="fas fa-camera"></i>{{ trans('admin.sidebar.cameras') }}
            </a>
            <a href="{{ base_path }}/admin/lenses" class="sidebar-link" data-spa-link>
              <i class="fas fa-circle-dot"></i>{{ trans('admin.sidebar.lenses') }}
            </a>
            <a href="{{ base_path }}/admin/films" class="sidebar-link" data-spa-link>
              <i class="fas fa-film"></i>{{ trans('admin.sidebar.films') }}
            </a>
            <a href="{{ base_path }}/admin/developers" class="sidebar-link" data-spa-link>
              <i class="fas fa-flask"></i>{{ trans('admin.sidebar.developers') }}
            </a>
            <a href="{{ base_path }}/admin/labs" class="sidebar-link" data-spa-link>
              <i class="fas fa-microscope"></i>{{ trans('admin.sidebar.labs') }}
            </a>
            <a href="{{ base_path }}/admin/locations" class="sidebar-link" data-spa-link>
              <i class="fas fa-location-dot"></i>{{ trans('admin.sidebar.locations') }}
            </a>
            {# Hook: admin_sidebar_metadata - Add custom metadata menu items #}
            {{ do_action('admin_sidebar_metadata', {base_path: base_path}) }}
          </div>
        </div>

        {# Hook: admin_sidebar_section - Add a completely new sidebar section #}
        {{ do_action('admin_sidebar_section', {base_path: base_path}) }}

        <!-- System -->
        <div>
          <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-4">{{ trans('admin.sidebar.system') }}</p>
          <div class="space-y-1">
            <a href="{{ base_path }}/admin/analytics" class="sidebar-link" data-spa-link>
              <i class="fas fa-chart-line"></i>{{ trans('admin.sidebar.analytics') }}
            </a>
            <a href="{{ base_path }}/admin/plugins" class="sidebar-link" data-spa-link>
              <i class="fas fa-puzzle-piece"></i>{{ trans('admin.sidebar.plugins') }}
            </a>
            <a href="{{ base_path }}/admin/users" class="sidebar-link" data-spa-link>
              <i class="fas fa-users"></i>{{ trans('admin.sidebar.users') }}
            </a>
            <a href="{{ base_path }}/admin/settings" class="sidebar-link" data-spa-link>
              <i class="fas fa-cog"></i>{{ trans('admin.sidebar.settings') }}
            </a>
            <a href="{{ base_path }}/admin/social" class="sidebar-link" data-spa-link>
              <i class="fas fa-share-alt"></i>{{ trans('admin.sidebar.social') }}
            </a>
            <a href="{{ base_path }}/admin/seo" class="sidebar-link" data-spa-link>
              <i class="fas fa-search"></i>{{ trans('admin.sidebar.seo') }}
            </a>
            <a href="{{ base_path }}/admin/privacy" class="sidebar-link" data-spa-link>
              <i class="fas fa-shield-alt"></i>{{ trans('admin.sidebar.privacy') }}
            </a>
            <a href="{{ base_path }}/admin/filter-settings" class="sidebar-link" data-spa-link>
              <i class="fas fa-sliders-h"></i>{{ trans('admin.sidebar.filter_settings') }}
            </a>

            <a href="{{ base_path }}/admin/commands" class="sidebar-link" data-spa-link>
              <i class="fas fa-terminal"></i>{{ trans('admin.sidebar.commands') }}
            </a>
            <a href="{{ base_path }}/admin/diagnostics" class="sidebar-link" data-spa-link>
              <i class="fas fa-stethoscope"></i>{{ trans('admin.sidebar.diagnostics') }}
            </a>
            <a href="{{ base_path }}/admin/updates" class="sidebar-link" data-spa-link>
              <i class="fas fa-cloud-download-alt"></i>{{ trans('admin.sidebar.updates') }}
            </a>
            {# Hook: admin_sidebar_system - Add custom system menu items #}
            {{ do_action('admin_sidebar_system', {base_path: base_path}) }}
          </div>
        </div>

        {# Hook: admin_sidebar_after - After all sidebar sections #}
        {{ do_action('admin_sidebar_after', {base_path: base_path}) }}
      </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 lg:flex-1">
      <main class="p-4 lg:p-8" id="main-content">
        <div id="loading-indicator" class="hidden fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50">
          <div class="bg-white p-4 rounded-lg shadow-lg">
            <i class="fas fa-spinner fa-spin mr-2"></i>{{ trans('admin.common.loading') }}
          </div>
        </div>
        
        {% if flash %}
          <div id="flash-messages">
          {% for message in flash %}
            {% if message.type == 'success' %}
              <div class="flash-message mb-6 bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg shadow-sm flex items-center justify-between transition-opacity duration-300" data-auto-dismiss="8000">
                <div class="flex items-center">
                  <i class="fas fa-check-circle text-green-600 mr-3"></i>
                  <span>{{ message.message }}</span>
                </div>
                <button type="button" class="flash-close ml-4 text-green-600 hover:text-green-800 focus:outline-none" aria-label="Close">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            {% elseif message.type == 'danger' or message.type == 'error' %}
              <div class="flash-message mb-6 bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg shadow-sm flex items-center justify-between transition-opacity duration-300">
                <div class="flex items-center">
                  <i class="fas fa-exclamation-circle text-red-600 mr-3"></i>
                  <span>{{ message.message }}</span>
                </div>
                <button type="button" class="flash-close ml-4 text-red-600 hover:text-red-800 focus:outline-none" aria-label="Close">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            {% elseif message.type == 'warning' %}
              <div class="flash-message mb-6 bg-yellow-50 border border-yellow-200 text-yellow-800 px-4 py-3 rounded-lg shadow-sm flex items-center justify-between transition-opacity duration-300" data-auto-dismiss="10000">
                <div class="flex items-center">
                  <i class="fas fa-exclamation-triangle text-yellow-600 mr-3"></i>
                  <span>{{ message.message }}</span>
                </div>
                <button type="button" class="flash-close ml-4 text-yellow-600 hover:text-yellow-800 focus:outline-none" aria-label="Close">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            {% elseif message.type == 'info' %}
              <div class="flash-message mb-6 bg-blue-50 border border-blue-200 text-blue-800 px-4 py-3 rounded-lg shadow-sm flex items-center justify-between transition-opacity duration-300" data-auto-dismiss="8000">
                <div class="flex items-center">
                  <i class="fas fa-info-circle text-blue-600 mr-3"></i>
                  <span>{{ message.message }}</span>
                </div>
                <button type="button" class="flash-close ml-4 text-blue-600 hover:text-blue-800 focus:outline-none" aria-label="Close">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            {% endif %}
          {% endfor %}
          </div>
        {% endif %}

        <div id="page-content">
          {% block content %}{% endblock %}
        </div>
      </main>
    </div>
  </div>

  <!-- Toast container -->
  <div id="toast" class="fixed top-20 right-6 z-50 hidden">
    <div id="toast-inner" class="px-4 py-3 rounded shadow text-sm"></div>
  </div>

  <!-- Profile Modal -->
  <div id="profileModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen px-4">
      <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold text-gray-900">{{ trans('admin.profile.my_profile') }}</h3>
          <button data-action="close-profile-modal" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <form id="profileForm" method="post" action="{{ base_path }}/admin/profile/update">
          <input type="hidden" name="csrf" value="{{ csrf }}">
          <div class="space-y-4">
            <div>
              <label for="profile-first-name" class="block text-sm font-medium text-gray-700 mb-1">{{ trans('admin.profile.first_name') }}</label>
              <input id="profile-first-name" class="form-input" type="text" name="first_name" autocomplete="given-name" value="{{ session.admin_name|split(' ')|first }}" required>
            </div>
            <div>
              <label for="profile-last-name" class="block text-sm font-medium text-gray-700 mb-1">{{ trans('admin.profile.last_name') }}</label>
              <input id="profile-last-name" class="form-input" type="text" name="last_name" autocomplete="family-name" value="{{ session.admin_name|split(' ')|slice(1)|join(' ') }}" required>
            </div>
            <div>
              <label for="profile-email" class="block text-sm font-medium text-gray-700 mb-1">{{ trans('admin.profile.email') }}</label>
              <input id="profile-email" class="form-input" type="email" name="email" autocomplete="email" value="{{ session.admin_email }}" required>
            </div>
          </div>
          <div class="flex justify-end space-x-3 mt-6">
            <button type="button" data-action="close-profile-modal" class="btn-secondary">{{ trans('admin.profile.cancel') }}</button>
            <button type="submit" class="btn-primary">{{ trans('admin.profile.update_profile') }}</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Password Change Modal -->
  <div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen px-4">
      <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold text-gray-900">{{ trans('admin.profile.change_password') }}</h3>
          <button data-action="close-password-modal" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <form id="passwordForm" method="post" action="{{ base_path }}/admin/profile/password">
          <input type="hidden" name="csrf" value="{{ csrf }}">
          {# Hidden username field for password managers accessibility #}
          <input type="text" name="username" value="{{ session.admin_email }}" autocomplete="username" class="sr-only" tabindex="-1" aria-hidden="true">
          <div class="space-y-4">
            <div>
              <label for="current-password" class="block text-sm font-medium text-gray-700 mb-1">{{ trans('admin.profile.current_password') }}</label>
              <input id="current-password" class="form-input" type="password" name="current_password" autocomplete="current-password" required>
            </div>
            <div>
              <label for="new-password" class="block text-sm font-medium text-gray-700 mb-1">{{ trans('admin.profile.new_password') }}</label>
              <input id="new-password" class="form-input" type="password" name="new_password" autocomplete="new-password" minlength="8" required>
            </div>
            <div>
              <label for="confirm-password" class="block text-sm font-medium text-gray-700 mb-1">{{ trans('admin.profile.confirm_password') }}</label>
              <input id="confirm-password" class="form-input" type="password" name="confirm_password" autocomplete="new-password" minlength="8" required>
            </div>
          </div>
          <div class="flex justify-end space-x-3 mt-6">
            <button type="button" data-action="close-password-modal" class="btn-secondary">{{ trans('admin.profile.cancel') }}</button>
            <button type="submit" class="btn-primary">{{ trans('admin.profile.change_password') }}</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script nonce="{{ csp_nonce() }}">
    // Highlight active sidebar link
    document.addEventListener('DOMContentLoaded', function() {
      const currentPath = window.location.pathname;
      const links = document.querySelectorAll('.sidebar-link');
      
      links.forEach(link => {
        if (link.getAttribute('href') === currentPath) {
          link.classList.add('active');
        }
      });
    });

    // Simple toast helper
    window.showToast = function(msg, type){
      const box = document.getElementById('toast');
      const inner = document.getElementById('toast-inner');
      inner.textContent = msg;
      inner.className = 'px-4 py-3 rounded shadow text-sm ' + (type==='error' ? 'bg-red-600 text-white' : 'bg-black text-white');
      box.classList.remove('hidden');
      setTimeout(()=>{ box.classList.add('hidden'); }, 2000);
    }

    // Profile / Password Modal Functions
    function openProfileModal() {
      document.getElementById('profileModal')?.classList.remove('hidden');
    }
    function closeProfileModal() {
      document.getElementById('profileModal')?.classList.add('hidden');
    }
    function openPasswordModal() {
      document.getElementById('passwordModal')?.classList.remove('hidden');
    }
    function closePasswordModal() {
      document.getElementById('passwordModal')?.classList.add('hidden');
      document.getElementById('passwordForm')?.reset();
    }

    // Password confirmation validation
    document.addEventListener('DOMContentLoaded', function() {
      const passwordForm = document.getElementById('passwordForm');
      if (passwordForm) {
        passwordForm.addEventListener('submit', function(e) {
          const newPassword = document.querySelector('input[name="new_password"]').value;
          const confirmPassword = document.querySelector('input[name="confirm_password"]').value;
          
          if (newPassword !== confirmPassword) {
            e.preventDefault();
            showToast('{{ trans('admin.profile.passwords_no_match')|e('js') }}', 'error');
            return false;
          }
        });
      }
    });

    // Close modals when clicking outside
    document.addEventListener('click', function(e) {
      if (e.target.id === 'profileModal') {
        closeProfileModal();
      }
      if (e.target.id === 'passwordModal') {
        closePasswordModal();
      }
    });

    // Migrate inline handlers to JS for CSP compliance
    document.addEventListener('DOMContentLoaded', function() {
      const actions = {
        'open-profile-modal': openProfileModal,
        'close-profile-modal': closeProfileModal,
        'open-password-modal': openPasswordModal,
        'close-password-modal': closePasswordModal,
      };
      Object.entries(actions).forEach(([key, fn]) => {
        document.querySelectorAll(`[data-action="${key}"]`).forEach(el => {
          el.addEventListener('click', function(ev) {
            ev.preventDefault();
            fn();
          });
        });
      });

      // Generic confirm handler for elements with data-confirm
      document.querySelectorAll('[data-confirm]').forEach(el => {
        const msg = el.getAttribute('data-confirm');
        if (!msg) return;
        const handler = (ev) => {
          if (!confirm(msg)) {
            ev.preventDefault();
            ev.stopPropagation();
          }
        };
        if (el.tagName.toLowerCase() === 'form') {
          el.addEventListener('submit', handler);
        } else {
          el.addEventListener('click', handler);
        }
      });

      // Flash messages: close button and auto-dismiss
      initFlashMessages();
    });

    function initFlashMessages() {
      const container = document.getElementById('flash-messages');
      if (!container) return;

      const messages = container.querySelectorAll('.flash-message');
      messages.forEach(msg => {
        // Close button handler
        const closeBtn = msg.querySelector('.flash-close');
        if (closeBtn) {
          closeBtn.addEventListener('click', () => dismissFlash(msg));
        }

        // Auto-dismiss for success/info/warning (not errors)
        const autoDismiss = msg.dataset.autoDismiss;
        if (autoDismiss) {
          const delay = parseInt(autoDismiss, 10) || 8000;
          setTimeout(() => dismissFlash(msg), delay);
        }
      });
    }

    function dismissFlash(el) {
      if (!el || el.classList.contains('flash-dismissed')) return;
      el.classList.add('flash-dismissed');
      el.style.opacity = '0';
      setTimeout(() => {
        el.remove();
        // Remove container if empty
        const container = document.getElementById('flash-messages');
        if (container && container.children.length === 0) {
          container.remove();
        }
      }, 300);
    }

    // Re-init flash messages after SPA navigation
    window.initFlashMessages = initFlashMessages;

    // Enhanced dropdown behavior with delays and expanded hover areas
    document.addEventListener('DOMContentLoaded', function() {
      const dropdown = document.querySelector('.dropdown');
      const dropdownContent = document.querySelector('.dropdown-content');
      let showTimeout;
      let hideTimeout;
      
      if (dropdown && dropdownContent) {
        // Function to show dropdown
        function showDropdown() {
          clearTimeout(hideTimeout);
          showTimeout = setTimeout(() => {
            dropdownContent.classList.add('show');
          }, 100); // Small delay to prevent accidental opening
        }
        
        // Function to hide dropdown
        function hideDropdown() {
          clearTimeout(showTimeout);
          hideTimeout = setTimeout(() => {
            dropdownContent.classList.remove('show');
          }, 300); // Longer delay to prevent accidental closing
        }
        
        // Mouse events for dropdown button
        dropdown.addEventListener('mouseenter', showDropdown);
        dropdown.addEventListener('mouseleave', hideDropdown);
        
        // Mouse events for dropdown content (to keep it open when hovering over menu)
        dropdownContent.addEventListener('mouseenter', () => {
          clearTimeout(hideTimeout);
          clearTimeout(showTimeout);
        });
        
        dropdownContent.addEventListener('mouseleave', hideDropdown);
        
        // Click outside to close
        document.addEventListener('click', function(e) {
          if (!dropdown.contains(e.target)) {
            clearTimeout(showTimeout);
            clearTimeout(hideTimeout);
            dropdownContent.classList.remove('show');
          }
        });
        
        // Prevent dropdown from closing when clicking inside
        dropdown.addEventListener('click', function(e) {
          e.stopPropagation();
        });
      }
    });

    // SPA Navigation System
    document.addEventListener('DOMContentLoaded', function() {
      const pageContent = document.getElementById('page-content');
      const loadingIndicator = document.getElementById('loading-indicator');
      const sidebarLinks = document.querySelectorAll('[data-spa-link]');
      
      // Mobile Sidebar Functionality
      const sidebar = document.getElementById('sidebar');
      const sidebarOverlay = document.getElementById('sidebar-overlay');
      const sidebarToggle = document.getElementById('sidebar-toggle');
      const sidebarClose = document.getElementById('sidebar-close');
      
      function openSidebar() {
        sidebar.classList.remove('-translate-x-full');
        sidebarOverlay.classList.remove('hidden');
        document.body.classList.add('overflow-hidden'); // Prevent background scrolling
      }
      
      function closeSidebar() {
        sidebar.classList.add('-translate-x-full');
        sidebarOverlay.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
      }
      
      // Mobile sidebar toggle events
      if (sidebarToggle) {
        sidebarToggle.addEventListener('click', openSidebar);
      }
      
      if (sidebarClose) {
        sidebarClose.addEventListener('click', closeSidebar);
      }
      
      if (sidebarOverlay) {
        sidebarOverlay.addEventListener('click', closeSidebar);
      }
      
      // Close sidebar when clicking on sidebar links on mobile
      sidebarLinks.forEach(link => {
        link.addEventListener('click', function() {
          // Close sidebar on mobile after navigation
          if (window.innerWidth < 1024) {
            setTimeout(closeSidebar, 150);
          }
        });
      });
      
      // Handle window resize
      window.addEventListener('resize', function() {
        if (window.innerWidth >= 1024) {
          closeSidebar();
        }
      });
      
      // Function to update active sidebar link
      function updateActiveSidebar(currentPath) {
        sidebarLinks.forEach(link => {
          link.classList.remove('active');
          if (link.getAttribute('href') === currentPath) {
            link.classList.add('active');
          }
        });
      }
      
      // Function to show loading indicator
      function showLoading() {
        loadingIndicator.classList.remove('hidden');
      }
      
      // Function to hide loading indicator
      function hideLoading() {
        loadingIndicator.classList.add('hidden');
      }
      
      // Function to load page content via AJAX
      async function loadPageContent(url) {
        try {
          showLoading();
          
          const response = await fetch(url, {
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
              'Accept': 'text/html'
            }
          });
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          
          const html = await response.text();
          
          // Extract content from the response (assuming it's a full page)
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const content = doc.querySelector('#page-content') || doc.querySelector('main') || doc.body;
          
          if (content) {
            // Fade out current content
            pageContent.style.opacity = '0';
            
            setTimeout(() => {
              pageContent.innerHTML = content.innerHTML;

              // Execute scripts from the loaded content in order, wait for externals, then init
              (async () => {
                try {
                  // Get the current page's CSP nonce from global variable (set on page load)
                  const currentNonce = window.cspNonce || '';

                  // Collect scripts from the fetched document (not just #page-content),
                  // because Twig's "scripts" block is rendered outside #page-content.
                  const scripts = Array.from(doc.querySelectorAll('script'));
                  try { console.log('SPA: executing page scripts count =', scripts.length); } catch(e){}
                  for (const s of scripts) {
                    const sc = document.createElement('script');
                    if (s.type) sc.type = s.type;
                    // Apply current page's nonce for CSP compliance
                    if (currentNonce) sc.setAttribute('nonce', currentNonce);
                    const src = s.getAttribute('src');
                    if (src) {
                      if (src.includes('/assets/admin.js')) continue; // skip main bundle
                      sc.src = src;
                      sc.async = false;
                      const done = new Promise(resolve => {
                        sc.onload = () => resolve();
                        sc.onerror = () => resolve(); // continue on error
                      });
                      document.body.appendChild(sc);
                      await done;
                      setTimeout(() => sc.remove(), 0);
                    } else {
                      sc.text = s.textContent || '';
                      document.body.appendChild(sc);
                      setTimeout(() => sc.remove(), 0);
                    }
                  }
                } catch (e) {
                  // Keep going even if some inline scripts fail
                }

                // Reinitialize any JavaScript that might be needed
                initializePageScripts();

                // Safety fallback: if critical initializers did not attach, force a full reload
                try {
                  const href = url;
                  const needsAlbumModal = pageContent.querySelector('#images-grid');
                  const needsCategoriesDnD = pageContent.querySelector('#categories-container');
                  let fallback = false;
                  if (needsAlbumModal && typeof window.openImageModal !== 'function') {
                    fallback = true;
                  }
                  if (needsCategoriesDnD) {
                    const hasSortable = Array.isArray(window.sortableInstances) && window.sortableInstances.length > 0;
                    if (!hasSortable) fallback = true;
                  }
                  if (fallback) {
                    window.location.href = href;
                    return;
                  }
                } catch (e) {}

                // Fade in new content
                pageContent.style.opacity = '1';
                hideLoading();
              })();
            }, 150);
          } else {
            throw new Error('Could not find content in response');
          }
          
        } catch (error) {
          console.error('Failed to load page content:', error);
          hideLoading();
          showToast('{{ trans('admin.common.page_load_error')|e('js') }}', 'error');
          
          // Fallback to full page load
          setTimeout(() => {
            window.location.href = url;
          }, 1000);
        }
      }
      
      // Function to reinitialize scripts after content load
      function initializePageScripts() {
        console.log('SPA: Initializing page scripts...');

        // Re-bind any click handlers for dynamic content
        const dynamicLinks = pageContent.querySelectorAll('a[href*="/admin/"]');
        dynamicLinks.forEach(link => {
          if (!link.hasAttribute('data-spa-link') && !link.hasAttribute('target') && !link.closest('form')) {
            link.addEventListener('click', handleDynamicLinkClick);
          }
        });

        // Initialize flash messages (close buttons and auto-dismiss)
        if (window.initFlashMessages) {
          window.initFlashMessages();
        }

        // Call global admin initializer for widgets (TomSelect, Uppy, Sortable, etc.)
        if (window.AdminInit) {
          try { window.AdminInit(); } catch(e) { console.error('Admin init failed', e); }
        } else {
          // The Vite module script is deferred and might not have executed yet on first load.
          // Schedule a short retry loop so we reliably init once the bundle attaches window.AdminInit.
          if (!window._adminInitWaiter) {
            console.warn('SPA: AdminInit function not found (will retry)');
            const start = Date.now();
            window._adminInitWaiter = window.setInterval(() => {
              if (window.AdminInit) {
                window.clearInterval(window._adminInitWaiter);
                window._adminInitWaiter = null;
                try { window.AdminInit(); } catch(e) { console.error('Admin init failed', e); }
              } else if (Date.now() - start > 5000) {
                window.clearInterval(window._adminInitWaiter);
                window._adminInitWaiter = null;
                console.warn('SPA: AdminInit still missing after 5s');
              }
            }, 50);
          }
        }
        
        // Initialize any page-specific components
        initPageSpecificComponents();
        
        // Call page-specific initializers based on current page
        initPageSpecificInitializers();
        
        
      }
      
      // Initialize page-specific components
      function initPageSpecificComponents() {
        // Category/tag management pages
        if (pageContent.querySelector('#categories-table, #tags-table')) {
          initTableActions();
        }
        
        // Album edit pages
        if (pageContent.querySelector('#images-grid')) {
          initImageGridActions();
        }
        
        // Settings pages
        if (pageContent.querySelector('form[data-settings]')) {
          initSettingsForm();
        }
        
        // Analytics pages
        if (pageContent.querySelector('#analytics-charts')) {
          initAnalyticsCharts();
        }
      }
      
      // Cleanup page-specific resources when navigating away
      function cleanupPageSpecificResources() {
        // Cleanup real-time analytics if leaving analytics pages
        if (typeof window.cleanupRealTimeAnalytics === 'function' && 
            window.currentPageType === 'analytics-realtime' &&
            !window.location.pathname.includes('/admin/analytics/realtime')) {
          
          window.cleanupRealTimeAnalytics();
          window.currentPageType = null;
        }
      }
      
      // Initialize page-specific initializers
      function initPageSpecificInitializers() {
        // Cleanup any previous page-specific resources
        cleanupPageSpecificResources();
        
        if (window.pageInitializers) {
          const currentPath = window.location.pathname;
          
          // SEO settings page
          if (currentPath.includes('/admin/seo') && window.pageInitializers.seo) {
            try {
              window.pageInitializers.seo();
              
            } catch(e) {
              console.error('SPA: SEO page initializer failed', e);
            }
          }
          
          // Analytics page
          if (currentPath.includes('/admin/analytics') && window.pageInitializers.analytics) {
            try {
              window.pageInitializers.analytics();
              
            } catch(e) {
              console.error('SPA: Analytics page initializer failed', e);
            }
          }
          
          // Albums main page (index)
          if (currentPath === '/admin/albums' && window.pageInitializers.albumsIndex) {
            try {
              window.pageInitializers.albumsIndex();
              
            } catch(e) {
              console.error('SPA: Albums index page initializer failed', e);
            }
          }

          // Social settings page
          if (currentPath.includes('/admin/social') && window.pageInitializers.social) {
            try {
              window.pageInitializers.social();
            } catch(e) {
              console.error('SPA: Social page initializer failed', e);
            }
          }
          
          // Albums edit page
          if (currentPath.includes('/admin/albums/') && currentPath.includes('/edit') && window.pageInitializers.albums) {
            try {
              window.pageInitializers.albums();
              
            } catch(e) {
              console.error('SPA: Albums edit page initializer failed', e);
            }
          }
          
          // Album create page
          if (currentPath.includes('/admin/albums/create') && window.pageInitializers.albumsCreate) {
            try {
              window.pageInitializers.albumsCreate();
              
            } catch(e) {
              console.error('SPA: Album create page initializer failed', e);
            }
          }
          
          // Settings page
          if (currentPath.includes('/admin/settings') && window.pageInitializers.settings) {
            try {
              window.pageInitializers.settings();
              
            } catch(e) {
              console.error('SPA: Settings page initializer failed', e);
            }
          }
        }
      }
      // Initialize scripts for initial page load
      initializePageScripts();
      
      // Table actions for categories/tags/etc
      function initTableActions() {
        const deleteButtons = pageContent.querySelectorAll('[data-delete-id]');
        deleteButtons.forEach(btn => {
          btn.addEventListener('click', handleTableDelete);
        });
      }
      
      // Image grid actions
      function initImageGridActions() {
        // This will be handled by AdminInit -> initSortableGrid
        // But we can add additional grid-specific handlers here
        const grid = pageContent.querySelector('#images-grid');
        if (grid && !grid._gridInitialized) {
          grid._gridInitialized = true;
          // Add any additional grid event handlers
        }
      }
      
      // Settings form handlers
      function initSettingsForm() {
        const forms = pageContent.querySelectorAll('form[data-settings]');
        forms.forEach(form => {
          if (!form._settingsInitialized) {
            form._settingsInitialized = true;
            form.addEventListener('submit', handleSettingsSubmit);
          }
        });
      }
      
      // Analytics charts initialization
      function initAnalyticsCharts() {
        // Initialize Chart.js if present
        if (window.Chart && pageContent.querySelector('canvas')) {
          console.log('SPA: Initializing analytics charts');
          // Chart initialization will be handled by page-specific scripts
        }
      }
      
      // Event handlers
      function handleTableDelete(e) {
        e.preventDefault();
        const id = e.target.getAttribute('data-delete-id');
        const itemName = e.target.getAttribute('data-item-name') || 'item';
        
        if (confirm('{{ trans('admin.common.confirm_delete')|e('js') }}')) {
          // Handle delete action
          console.log(`Deleting ${itemName} with ID: ${id}`);
        }
      }
      
      function handleSettingsSubmit(e) {
        const form = e.target;
        console.log('Settings form submitted:', form);
        // Additional settings form handling if needed
      }
      
      // Handle clicks on dynamically loaded links
      function handleDynamicLinkClick(e) {
        const href = e.target.closest('a').getAttribute('href');
        if (href && href.includes('/admin/') && !href.includes('#') && !e.target.closest('form')) {
          e.preventDefault();
          loadPageContent(href);
          updateActiveSidebar(href);
          window.scrollTo({ top: 0, behavior: 'smooth' });
          history.pushState(null, '', href);
        }
      }
      
      // Handle sidebar navigation
      sidebarLinks.forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();

          const href = this.getAttribute('href');
          loadPageContent(href);
          updateActiveSidebar(href);

          // Scroll main content to top
          window.scrollTo({ top: 0, behavior: 'smooth' });

          // Update browser history
          history.pushState(null, '', href);
        });
      });
      
      // Handle browser back/forward buttons
      window.addEventListener('popstate', function() {
        const currentPath = window.location.pathname;
        loadPageContent(currentPath);
        updateActiveSidebar(currentPath);
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
      
      // Set initial active sidebar link
      updateActiveSidebar(window.location.pathname);
      
      // Add smooth transition to page content
      pageContent.style.transition = 'opacity 0.15s ease-in-out';
    });
  </script>
  <script nonce="{{ csp_nonce() }}">
    // Suppress verbose SPA/admin debug logs without affecting errors
    (function(){
      var origLog = console.log;
      var patterns = [
        /^SPA:\s*/i,
        /^AdminInit:/i,
        /Cleanup completed successfully/i,
        /Initializing TomSelects/i,
        /Initializing Sortable/i,
        /No images-grid/i,
        /Initializing TinyMCE/i,
        /No richtext areas/i,
        /completed successfully$/i
      ];
      console.log = function(){
        try {
          var str = Array.prototype.join.call(arguments, ' ');
          for (var i=0;i<patterns.length;i++) if (patterns[i].test(str)) return;
        } catch(e){}
        return origLog.apply(console, arguments);
      };
    })();
  </script>
  <script type="module" src="{{ base_path }}/assets/admin.js"></script>
</body>
</html>
