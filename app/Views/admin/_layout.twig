<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}Admin â€” photoCMS{% endblock %}</title>
  <link href="/assets/app.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    .sidebar-link { 
      display: flex; 
      align-items: center; 
      padding: 12px 16px; 
      color: #374151; 
      text-decoration: none;
      transition: all 0.2s;
      margin-bottom: 4px;
      border-radius: 6px;
    }
    .sidebar-link:hover { 
      background-color: #f3f4f6; 
      color: #000; 
    }
    .sidebar-link.active { 
      background-color: #000; 
      color: #fff; 
    }
    .sidebar-link i { 
      width: 20px; 
      margin-right: 12px; 
      text-align: center; 
    }
    .btn-primary { 
      background-color: #000; 
      color: #fff; 
      padding: 8px 24px; 
      border-radius: 6px; 
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      transition: background-color 0.2s;
    }
    .btn-primary:hover { 
      background-color: #374151; 
    }
    .btn-secondary { 
      background-color: #e5e7eb; 
      color: #374151; 
      padding: 8px 24px; 
      border-radius: 6px; 
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      transition: background-color 0.2s;
    }
    .btn-secondary:hover { 
      background-color: #d1d5db; 
    }
    .btn-sm {
      padding: 6px 12px;
      font-size: 0.875rem;
      line-height: 1.25rem;
    }
    .card { 
      background-color: #fff; 
      border-radius: 8px; 
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); 
      border: 1px solid #e5e7eb; 
    }
    .form-input { 
      width: 100%; 
      padding: 12px; 
      border: 1px solid #d1d5db; 
      border-radius: 6px; 
      transition: all 0.2s;
    }
    .form-input:focus { 
      outline: none; 
      border-color: #000; 
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1); 
    }
    .table-row:hover { 
      background-color: #f9fafb; 
    }
    .dropdown {
      position: relative;
      display: inline-block;
    }
    .dropdown-content {
      display: none;
      position: absolute;
      right: 0;
      background-color: white;
      min-width: 280px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      z-index: 1000;
      top: 100%;
      margin-top: 8px;
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity 0.2s ease, transform 0.2s ease;
    }
    .dropdown-content.show {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }
    /* Expanded hover area to prevent accidental closing */
    .dropdown::after {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      bottom: -10px;
      left: 0;
      z-index: 999;
    }
    .dropdown-content::before {
      content: '';
      position: absolute;
      top: -10px;
      right: 0;
      left: 0;
      height: 10px;
      background: transparent;
    }
    .dropdown-item {
      color: #374151;
      padding: 12px 16px;
      text-decoration: none;
      display: flex;
      align-items: center;
      transition: background-color 0.2s;
      border-bottom: 1px solid #f3f4f6;
    }
    .dropdown-item:hover {
      background-color: #f9fafb;
    }
    .dropdown-item:last-child {
      border-bottom: none;
      border-radius: 0 0 8px 8px;
    }
    .dropdown-item:first-child {
      border-radius: 8px 8px 0 0;
    }
    .dropdown-item i {
      width: 20px;
      margin-right: 12px;
      text-align: center;
    }
    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 14px;
    }
  </style>
  <!-- PhotoSwipe CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@5.4.4/dist/photoswipe.css">
</head>
<body class="bg-gray-50">
  <!-- Header -->
  <nav class="bg-white border-b border-gray-200 fixed w-full z-30 top-0">
    <div class="px-6 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <i class="fas fa-camera text-2xl text-black mr-3"></i>
          <h1 class="text-xl font-semibold text-black">photoCMS</h1>
        </div>
        
        <!-- User Administration Area -->
        <div class="flex items-center space-x-6">
          <!-- Frontend Link -->
          <a href="/" target="_blank" class="text-gray-600 hover:text-black transition-colors flex items-center space-x-2" title="Visualizza Frontend">
            <i class="fas fa-external-link-alt"></i>
            <span class="hidden md:inline text-sm">Frontend</span>
          </a>
          
          <!-- User Dropdown -->
          <div class="dropdown">
            <button class="flex items-center space-x-3 text-gray-700 hover:text-black transition-colors cursor-pointer">
              <!-- User Avatar -->
              <div class="user-avatar">
                {% if session.admin_name %}
                  {{ session.admin_name|split(' ')|map(name => name|first)|join('')|upper|e }}
                {% else %}
                  <i class="fas fa-user"></i>
                {% endif %}
              </div>
              
              <!-- User Info -->
              <div class="hidden md:block text-left">
                <div class="text-sm font-medium">
                  {% if session.admin_name %}
                    {{ session.admin_name|e }}
                  {% else %}
                    Admin User
                  {% endif %}
                </div>
                <div class="text-xs text-gray-500">
                  {% if session.admin_email %}
                    {{ session.admin_email|e }}
                  {% else %}
                    Administrator
                  {% endif %}
                </div>
              </div>
              
              <i class="fas fa-chevron-down text-xs"></i>
            </button>
            
            <!-- Dropdown Menu -->
            <div class="dropdown-content">
              <!-- User Info Header -->
              <div class="px-4 py-3 border-b border-gray-100 bg-gray-50">
                <div class="flex items-center space-x-3">
                  <div class="user-avatar">
                    {% if session.admin_name %}
                      {{ session.admin_name|split(' ')|map(name => name|first)|join('')|upper|e }}
                    {% else %}
                      <i class="fas fa-user"></i>
                    {% endif %}
                  </div>
                  <div>
                    <div class="font-medium text-gray-900">
                      {% if session.admin_name %}
                        {{ session.admin_name|e }}
                      {% else %}
                        Admin User
                      {% endif %}
                    </div>
                    <div class="text-sm text-gray-500">
                      {% if session.admin_email %}
                        {{ session.admin_email|e }}
                      {% else %}
                        Administrator
                      {% endif %}
                    </div>
                    <div class="text-xs text-gray-400 mt-1">
                      <i class="fas fa-shield-alt mr-1"></i>{{ session.admin_role|default('admin')|title|e }}
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Menu Items -->
              <a href="#" onclick="openProfileModal()" class="dropdown-item">
                <i class="fas fa-user-edit"></i>
                <div>
                  <div class="font-medium">Il Mio Profilo</div>
                  <div class="text-xs text-gray-500">Modifica informazioni personali</div>
                </div>
              </a>
              
              <a href="#" onclick="openPasswordModal()" class="dropdown-item">
                <i class="fas fa-key"></i>
                <div>
                  <div class="font-medium">Cambia Password</div>
                  <div class="text-xs text-gray-500">Aggiorna le tue credenziali</div>
                </div>
              </a>
              
              <div class="border-t border-gray-100 my-1"></div>
              
              <a href="/admin/users" class="dropdown-item">
                <i class="fas fa-users-cog"></i>
                <div>
                  <div class="font-medium">Gestione Utenti</div>
                  <div class="text-xs text-gray-500">Amministra tutti gli utenti</div>
                </div>
              </a>
              
              <a href="/admin/settings" class="dropdown-item">
                <i class="fas fa-cog"></i>
                <div>
                  <div class="font-medium">Impostazioni Sistema</div>
                  <div class="text-xs text-gray-500">Configura l'applicazione</div>
                </div>
              </a>
              
              <div class="border-t border-gray-100 my-1"></div>
              
              <form method="post" action="/admin/logout" class="m-0">
                <input type="hidden" name="csrf" value="{{ csrf }}">
                <button type="submit" class="dropdown-item text-red-600 hover:bg-red-50 w-full text-left border-0 bg-transparent cursor-pointer">
                  <i class="fas fa-sign-out-alt"></i>
                  <div>
                    <div class="font-medium">Logout</div>
                    <div class="text-xs text-red-400">Esci dall'amministrazione</div>
                  </div>
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <div class="flex h-screen pt-16">
    <!-- Sidebar -->
    <div class="w-64 bg-white border-r border-gray-200 fixed h-full overflow-y-auto">
      <div class="p-6">
        <!-- Main Navigation -->
        <div class="mb-8">
          <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-4">NAVIGATION</p>
          <div class="space-y-1">
            <a href="/admin" class="sidebar-link">
              <i class="fas fa-tachometer-alt"></i>Dashboard
            </a>
            <a href="/admin/albums" class="sidebar-link">
              <i class="fas fa-images"></i>Albums
            </a>
            <a href="/admin/categories" class="sidebar-link">
              <i class="fas fa-folder"></i>Categories
            </a>
            <a href="/admin/tags" class="sidebar-link">
              <i class="fas fa-tags"></i>Tags
            </a>
            <a href="/admin/templates" class="sidebar-link">
              <i class="fas fa-palette"></i>Templates
            </a>
            <a href="/admin/pages" class="sidebar-link">
              <i class="fas fa-file-alt"></i>Pages
            </a>
          </div>
        </div>

        <!-- Metadata -->
        <div class="mb-8">
          <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-4">METADATA</p>
          <div class="space-y-1">
            <a href="/admin/cameras" class="sidebar-link">
              <i class="fas fa-camera"></i>Cameras
            </a>
            <a href="/admin/lenses" class="sidebar-link">
              <i class="fas fa-circle-dot"></i>Lenses
            </a>
            <a href="/admin/films" class="sidebar-link">
              <i class="fas fa-film"></i>Films
            </a>
            <a href="/admin/developers" class="sidebar-link">
              <i class="fas fa-flask"></i>Developers
            </a>
            <a href="/admin/labs" class="sidebar-link">
              <i class="fas fa-microscope"></i>Labs
            </a>
            <a href="/admin/locations" class="sidebar-link">
              <i class="fas fa-location-dot"></i>Locations
            </a>
          </div>
        </div>

        <!-- System -->
        <div>
          <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-4">SYSTEM</p>
          <div class="space-y-1">
            <a href="/admin/users" class="sidebar-link">
              <i class="fas fa-users"></i>Users
            </a>
            <a href="/admin/settings" class="sidebar-link">
              <i class="fas fa-cog"></i>Settings
            </a>
            <a href="/admin/filter-settings" class="sidebar-link">
              <i class="fas fa-sliders-h"></i>Filter Settings
            </a>

            <a href="/admin/commands" class="sidebar-link">
              <i class="fas fa-terminal"></i>Commands
            </a>
            <a href="/admin/diagnostics" class="sidebar-link">
              <i class="fas fa-stethoscope"></i>Diagnostics
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 ml-64">
      <main class="p-8">
        {% if flash %}
          {% for message in flash %}
            {% if message.type == 'success' %}
              <div class="mb-6 bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg shadow-sm flex items-center">
                <i class="fas fa-check-circle text-green-600 mr-3"></i>
                <span>{{ message.message }}</span>
              </div>
            {% elseif message.type == 'danger' or message.type == 'error' %}
              <div class="mb-6 bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg shadow-sm flex items-center">
                <i class="fas fa-exclamation-circle text-red-600 mr-3"></i>
                <span>{{ message.message }}</span>
              </div>
            {% elseif message.type == 'warning' %}
              <div class="mb-6 bg-yellow-50 border border-yellow-200 text-yellow-800 px-4 py-3 rounded-lg shadow-sm flex items-center">
                <i class="fas fa-exclamation-triangle text-yellow-600 mr-3"></i>
                <span>{{ message.message }}</span>
              </div>
            {% elseif message.type == 'info' %}
              <div class="mb-6 bg-blue-50 border border-blue-200 text-blue-800 px-4 py-3 rounded-lg shadow-sm flex items-center">
                <i class="fas fa-info-circle text-blue-600 mr-3"></i>
                <span>{{ message.message }}</span>
              </div>
            {% endif %}
          {% endfor %}
        {% endif %}

        {% block content %}{% endblock %}
      </main>
    </div>
  </div>

  <!-- Toast container -->
  <div id="toast" class="fixed top-20 right-6 z-50 hidden">
    <div id="toast-inner" class="px-4 py-3 rounded shadow text-sm"></div>
  </div>

  <!-- Profile Modal -->
  <div id="profileModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen px-4">
      <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold text-gray-900">Il Mio Profilo</h3>
          <button onclick="closeProfileModal()" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <form id="profileForm" method="post" action="/admin/profile/update">
          <input type="hidden" name="csrf" value="{{ csrf }}">
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Nome</label>
              <input class="form-input" type="text" name="first_name" value="{{ session.admin_name|split(' ')|first }}" required>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Cognome</label>
              <input class="form-input" type="text" name="last_name" value="{{ session.admin_name|split(' ')|slice(1)|join(' ') }}" required>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
              <input class="form-input" type="email" name="email" value="{{ session.admin_email }}" required>
            </div>
          </div>
          <div class="flex justify-end space-x-3 mt-6">
            <button type="button" onclick="closeProfileModal()" class="btn-secondary">Annulla</button>
            <button type="submit" class="btn-primary">Aggiorna Profilo</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Password Change Modal -->
  <div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen px-4">
      <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold text-gray-900">Cambia Password</h3>
          <button onclick="closePasswordModal()" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <form id="passwordForm" method="post" action="/admin/profile/password">
          <input type="hidden" name="csrf" value="{{ csrf }}">
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Password Attuale</label>
              <input class="form-input" type="password" name="current_password" required>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Nuova Password</label>
              <input class="form-input" type="password" name="new_password" minlength="8" required>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Conferma Nuova Password</label>
              <input class="form-input" type="password" name="confirm_password" minlength="8" required>
            </div>
          </div>
          <div class="flex justify-end space-x-3 mt-6">
            <button type="button" onclick="closePasswordModal()" class="btn-secondary">Annulla</button>
            <button type="submit" class="btn-primary">Cambia Password</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // Highlight active sidebar link
    document.addEventListener('DOMContentLoaded', function() {
      const currentPath = window.location.pathname;
      const links = document.querySelectorAll('.sidebar-link');
      
      links.forEach(link => {
        if (link.getAttribute('href') === currentPath) {
          link.classList.add('active');
        }
      });
    });

    // Simple toast helper
    window.showToast = function(msg, type){
      const box = document.getElementById('toast');
      const inner = document.getElementById('toast-inner');
      inner.textContent = msg;
      inner.className = 'px-4 py-3 rounded shadow text-sm ' + (type==='error' ? 'bg-red-600 text-white' : 'bg-black text-white');
      box.classList.remove('hidden');
      setTimeout(()=>{ box.classList.add('hidden'); }, 2000);
    }

    // Profile Modal Functions
    function openProfileModal() {
      document.getElementById('profileModal').classList.remove('hidden');
    }

    function closeProfileModal() {
      document.getElementById('profileModal').classList.add('hidden');
    }

    // Password Modal Functions
    function openPasswordModal() {
      document.getElementById('passwordModal').classList.remove('hidden');
    }

    function closePasswordModal() {
      document.getElementById('passwordModal').classList.add('hidden');
      document.getElementById('passwordForm').reset();
    }

    // Password confirmation validation
    document.addEventListener('DOMContentLoaded', function() {
      const passwordForm = document.getElementById('passwordForm');
      if (passwordForm) {
        passwordForm.addEventListener('submit', function(e) {
          const newPassword = document.querySelector('input[name="new_password"]').value;
          const confirmPassword = document.querySelector('input[name="confirm_password"]').value;
          
          if (newPassword !== confirmPassword) {
            e.preventDefault();
            showToast('Le password non corrispondono', 'error');
            return false;
          }
        });
      }
    });

    // Close modals when clicking outside
    document.addEventListener('click', function(e) {
      if (e.target.id === 'profileModal') {
        closeProfileModal();
      }
      if (e.target.id === 'passwordModal') {
        closePasswordModal();
      }
    });

    // Enhanced dropdown behavior with delays and expanded hover areas
    document.addEventListener('DOMContentLoaded', function() {
      const dropdown = document.querySelector('.dropdown');
      const dropdownContent = document.querySelector('.dropdown-content');
      let showTimeout;
      let hideTimeout;
      
      if (dropdown && dropdownContent) {
        // Function to show dropdown
        function showDropdown() {
          clearTimeout(hideTimeout);
          showTimeout = setTimeout(() => {
            dropdownContent.classList.add('show');
          }, 100); // Small delay to prevent accidental opening
        }
        
        // Function to hide dropdown
        function hideDropdown() {
          clearTimeout(showTimeout);
          hideTimeout = setTimeout(() => {
            dropdownContent.classList.remove('show');
          }, 300); // Longer delay to prevent accidental closing
        }
        
        // Mouse events for dropdown button
        dropdown.addEventListener('mouseenter', showDropdown);
        dropdown.addEventListener('mouseleave', hideDropdown);
        
        // Mouse events for dropdown content (to keep it open when hovering over menu)
        dropdownContent.addEventListener('mouseenter', () => {
          clearTimeout(hideTimeout);
          clearTimeout(showTimeout);
        });
        
        dropdownContent.addEventListener('mouseleave', hideDropdown);
        
        // Click outside to close
        document.addEventListener('click', function(e) {
          if (!dropdown.contains(e.target)) {
            clearTimeout(showTimeout);
            clearTimeout(hideTimeout);
            dropdownContent.classList.remove('show');
          }
        });
        
        // Prevent dropdown from closing when clicking inside
        dropdown.addEventListener('click', function(e) {
          e.stopPropagation();
        });
      }
    });
  </script>
  <!-- PhotoSwipe JS -->
  <script src="https://cdn.jsdelivr.net/npm/photoswipe@5.4.4/dist/photoswipe.min.js"></script>
</body>
</html>
