<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}Admin â€” photoCMS{% endblock %}</title>
  <link href="{{ base_path }}/assets/app.css" rel="stylesheet">
  <link href="{{ base_path }}/assets/admin.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script>window.basePath = '{{ base_path }}';</script>
  <style>
    body {
      margin: 0;
      padding: 0;
    }
    .sidebar-link { 
      display: flex; 
      align-items: center; 
      padding: 12px 16px; 
      color: #374151; 
      text-decoration: none;
      transition: all 0.2s;
      margin-bottom: 4px;
      border-radius: 6px;
    }
    .sidebar-link:hover { 
      background-color: #f3f4f6; 
      color: #000; 
    }
    .sidebar-link.active { 
      background-color: #000; 
      color: #fff; 
    }
    .sidebar-link i { 
      width: 20px; 
      margin-right: 12px; 
      text-align: center; 
    }
    .btn-primary { 
      background-color: #000; 
      color: #fff; 
      padding: 8px 24px; 
      border-radius: 6px; 
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      transition: background-color 0.2s;
    }
    .btn-primary:hover { 
      background-color: #374151; 
    }
    .btn-secondary { 
      background-color: #e5e7eb; 
      color: #374151; 
      padding: 8px 24px; 
      border-radius: 6px; 
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      transition: background-color 0.2s;
    }
    .btn-secondary:hover { 
      background-color: #d1d5db; 
    }
    .btn-outline-danger { 
      background-color: transparent; 
      color: #dc2626; 
      padding: 8px 24px; 
      border: 1px solid #dc2626;
      border-radius: 6px; 
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      transition: all 0.2s;
    }
    .btn-outline-danger:hover { 
      background-color: #dc2626;
      color: white;
    }
    .btn-outline-danger:disabled { 
      opacity: 0.5; 
      cursor: not-allowed;
    }
    
    /* TinyMCE Toolbar Fix */
    .tox:not(.tox-tinymce-inline) .tox-editor-header { 
      display: block !important; 
    }
    .tox .tox-toolbar { 
      display: flex !important; 
      flex-wrap: wrap; 
      border-bottom: 1px solid #e5e5e5;
      padding: 4px 8px;
      background: #f4f4f4;
    }
    .tox .tox-toolbar__group { 
      display: flex !important; 
      align-items: center;
      margin-right: 12px;
    }
    .tox .tox-tbtn { 
      margin: 2px 1px;
      padding: 4px 6px;
      border-radius: 3px;
    }
    .tox .tox-tbtn:hover {
      background: #e5e5e5;
    }
    .btn-sm {
      padding: 6px 12px;
      font-size: 0.875rem;
      line-height: 1.25rem;
    }
    .card { 
      background-color: #fff; 
      border-radius: 8px; 
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); 
      border: 1px solid #e5e7eb; 
    }
    .form-input { 
      width: 100%; 
      padding: 12px; 
      border: 1px solid #d1d5db; 
      border-radius: 6px; 
      transition: all 0.2s;
    }
    .form-input:focus { 
      outline: none; 
      border-color: #000; 
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1); 
    }
    .table-row:hover { 
      background-color: #f9fafb; 
    }
    .dropdown {
      position: relative;
      display: inline-block;
    }
    .dropdown-content {
      display: none;
      position: absolute;
      right: 0;
      background-color: white;
      min-width: 280px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      z-index: 1000;
      top: 100%;
      margin-top: 8px;
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity 0.2s ease, transform 0.2s ease;
    }
    .dropdown-content.show {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }
    /* Expanded hover area to prevent accidental closing */
    .dropdown::after {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      bottom: -10px;
      left: 0;
      z-index: 999;
    }
    .dropdown-content::before {
      content: '';
      position: absolute;
      top: -10px;
      right: 0;
      left: 0;
      height: 10px;
      background: transparent;
    }
    .dropdown-item {
      color: #374151;
      padding: 12px 16px;
      text-decoration: none;
      display: flex;
      align-items: center;
      transition: background-color 0.2s;
      border-bottom: 1px solid #f3f4f6;
    }
    .dropdown-item:hover {
      background-color: #f9fafb;
    }
    .dropdown-item:last-child {
      border-bottom: none;
      border-radius: 0 0 8px 8px;
    }
    .dropdown-item:first-child {
      border-radius: 8px 8px 0 0;
    }
    .dropdown-item i {
      width: 20px;
      margin-right: 12px;
      text-align: center;
    }
    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #1f2937;
      font-weight: 400;
      font-size: 14px;
    }
    /* TomSelect: remove double border and align with form-input */
    .ts-wrapper.form-input { border: 0 !important; padding: 0 !important; background: transparent !important; }
    .ts-wrapper .ts-control { border: 1px solid #d1d5db !important; border-radius: 6px; min-height: 38px; }
    .ts-wrapper .ts-control:focus-within { outline: none; box-shadow: 0 0 0 3px rgba(0,0,0,0.1); border-color: #000; }
    .ts-wrapper .ts-control .item { background: #111; color: #fff; border-radius: 9999px; padding: 2px 8px; margin: 2px; }
    .ts-dropdown { z-index: 99999; }
  </style>
  <!-- PhotoSwipe CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@5.4.4/dist/photoswipe.css">
</head>
<body class="bg-gray-50">
  <!-- Header -->
  <nav class="bg-white border-b border-gray-200 fixed w-full z-30 top-0">
    <div class="px-6 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <!-- Hamburger Menu Button (Mobile/Tablet) -->
          <button id="sidebar-toggle" class="lg:hidden mr-3 p-2 rounded-md text-gray-600 hover:text-black hover:bg-gray-100 transition-colors">
            <i class="fas fa-bars"></i>
          </button>
          
          {% if site_logo %}
            <img src="{{ base_path ~ site_logo }}" alt="{{ site_title|default('photoCMS')|e }}" class="h-7 w-auto mr-3">
          {% else %}
            <i class="fas fa-camera text-2xl text-black mr-3"></i>
            <h1 class="text-xl font-semibold text-black">{{ site_title|default('photoCMS') }}</h1>
          {% endif %}
        </div>
        
        <!-- User Administration Area -->
        <div class="flex items-center space-x-6">
          <!-- Frontend Link -->
          <a href="{{ base_path }}/" target="_blank" class="text-gray-600 hover:text-black transition-colors flex items-center space-x-2" title="Visualizza Frontend">
            <i class="fas fa-external-link-alt"></i>
            <span class="hidden md:inline text-sm">Frontend</span>
          </a>
          
          <!-- User Dropdown -->
          <div class="dropdown">
            <button class="flex items-center space-x-3 text-gray-700 hover:text-black transition-colors cursor-pointer">
              <!-- User Avatar -->
              <div class="user-avatar">
                {% if session.admin_name %}
                  {{ session.admin_name|split(' ')|map(name => name|first)|join('')|upper|e }}
                {% else %}
                  <i class="fas fa-user"></i>
                {% endif %}
              </div>
              
              <!-- User Info -->
              <div class="hidden md:block text-left">
                <div class="text-sm font-medium">
                  {% if session.admin_name %}
                    {{ session.admin_name|e }}
                  {% else %}
                    Admin User
                  {% endif %}
                </div>
                <div class="text-xs text-gray-500">
                  {% if session.admin_email %}
                    {{ session.admin_email|e }}
                  {% else %}
                    Administrator
                  {% endif %}
                </div>
              </div>
              
              <i class="fas fa-chevron-down text-xs"></i>
            </button>
            
            <!-- Dropdown Menu -->
            <div class="dropdown-content">
              <!-- User Info Header -->
              <div class="px-4 py-3 border-b border-gray-100 bg-gray-50">
                <div class="flex items-center space-x-3">
                  <div class="user-avatar">
                    {% if session.admin_name %}
                      {{ session.admin_name|split(' ')|map(name => name|first)|join('')|upper|e }}
                    {% else %}
                      <i class="fas fa-user"></i>
                    {% endif %}
                  </div>
                  <div>
                    <div class="font-medium text-gray-900">
                      {% if session.admin_name %}
                        {{ session.admin_name|e }}
                      {% else %}
                        Admin User
                      {% endif %}
                    </div>
                    <div class="text-sm text-gray-500">
                      {% if session.admin_email %}
                        {{ session.admin_email|e }}
                      {% else %}
                        Administrator
                      {% endif %}
                    </div>
                    <div class="text-xs text-gray-400 mt-1">
                      <i class="fas fa-shield-alt mr-1"></i>{{ session.admin_role|default('admin')|title|e }}
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Menu Items -->
              <a href="#" onclick="openProfileModal()" class="dropdown-item">
                <i class="fas fa-user-edit"></i>
                <div>
                  <div class="font-medium">Il Mio Profilo</div>
                  <div class="text-xs text-gray-500">Modifica informazioni personali</div>
                </div>
              </a>
              
              <a href="#" onclick="openPasswordModal()" class="dropdown-item">
                <i class="fas fa-key"></i>
                <div>
                  <div class="font-medium">Cambia Password</div>
                  <div class="text-xs text-gray-500">Aggiorna le tue credenziali</div>
                </div>
              </a>
              
              <div class="border-t border-gray-100 my-1"></div>
              
              <a href="{{ base_path }}/admin/users" class="dropdown-item">
                <i class="fas fa-users-cog"></i>
                <div>
                  <div class="font-medium">Gestione Utenti</div>
                  <div class="text-xs text-gray-500">Amministra tutti gli utenti</div>
                </div>
              </a>
              
              <a href="{{ base_path }}/admin/settings" class="dropdown-item">
                <i class="fas fa-cog"></i>
                <div>
                  <div class="font-medium">Impostazioni Sistema</div>
                  <div class="text-xs text-gray-500">Configura l'applicazione</div>
                </div>
              </a>
              
              <div class="border-t border-gray-100 my-1"></div>
              
              <form method="post" action="{{ base_path }}/admin/logout" class="m-0">
                <input type="hidden" name="csrf" value="{{ csrf }}">
                <button type="submit" class="dropdown-item text-red-600 hover:bg-red-50 w-full text-left border-0 bg-transparent cursor-pointer">
                  <i class="fas fa-sign-out-alt"></i>
                  <div>
                    <div class="font-medium">Logout</div>
                    <div class="text-xs text-red-400">Esci dall'amministrazione</div>
                  </div>
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <div class="flex pt-16 relative">
    <!-- Sidebar Overlay (Mobile/Tablet) -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden hidden"></div>
    
    <!-- Sidebar -->
    <div id="sidebar" class="fixed lg:sticky lg:top-24 w-64 bg-white border-r border-gray-200 h-full lg:h-[calc(100vh-6rem)] overflow-y-auto transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out z-50 lg:z-auto">
      <div class="p-6">
        <!-- Close Button (Mobile/Tablet) -->
        <div class="lg:hidden flex justify-end mb-4">
          <button id="sidebar-close" class="p-2 rounded-md text-gray-600 hover:text-black hover:bg-gray-100 transition-colors">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <!-- Main Navigation -->
        <div class="mb-8">
          <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-4">NAVIGATION</p>
          <div class="space-y-1">
            <a href="{{ base_path }}/admin" class="sidebar-link" data-spa-link>
              <i class="fas fa-tachometer-alt"></i>Dashboard
            </a>
            <a href="{{ base_path }}/admin/media" class="sidebar-link" data-spa-link>
              <i class="fas fa-images"></i>Galleria
            </a>
            <a href="{{ base_path }}/admin/albums" class="sidebar-link" data-spa-link>
              <i class="fas fa-images"></i>Albums
            </a>
            <a href="{{ base_path }}/admin/categories" class="sidebar-link" data-spa-link>
              <i class="fas fa-folder"></i>Categories
            </a>
            <a href="{{ base_path }}/admin/tags" class="sidebar-link" data-spa-link>
              <i class="fas fa-tags"></i>Tags
            </a>
            <a href="{{ base_path }}/admin/templates" class="sidebar-link" data-spa-link>
              <i class="fas fa-palette"></i>Templates
            </a>
            <a href="{{ base_path }}/admin/pages" class="sidebar-link" data-spa-link>
              <i class="fas fa-file-alt"></i>Pages
            </a>
          </div>
        </div>

        <!-- Metadata -->
        <div class="mb-8">
          <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-4">METADATA</p>
          <div class="space-y-1">
            <a href="{{ base_path }}/admin/cameras" class="sidebar-link" data-spa-link>
              <i class="fas fa-camera"></i>Cameras
            </a>
            <a href="{{ base_path }}/admin/lenses" class="sidebar-link" data-spa-link>
              <i class="fas fa-circle-dot"></i>Lenses
            </a>
            <a href="{{ base_path }}/admin/films" class="sidebar-link" data-spa-link>
              <i class="fas fa-film"></i>Films
            </a>
            <a href="{{ base_path }}/admin/developers" class="sidebar-link" data-spa-link>
              <i class="fas fa-flask"></i>Developers
            </a>
            <a href="{{ base_path }}/admin/labs" class="sidebar-link" data-spa-link>
              <i class="fas fa-microscope"></i>Labs
            </a>
            <a href="{{ base_path }}/admin/locations" class="sidebar-link" data-spa-link>
              <i class="fas fa-location-dot"></i>Locations
            </a>
          </div>
        </div>

        <!-- System -->
        <div>
          <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-4">SYSTEM</p>
          <div class="space-y-1">
            <a href="{{ base_path }}/admin/analytics" class="sidebar-link" data-spa-link>
              <i class="fas fa-chart-line"></i>Analytics
            </a>
            <a href="{{ base_path }}/admin/users" class="sidebar-link" data-spa-link>
              <i class="fas fa-users"></i>Users
            </a>
            <a href="{{ base_path }}/admin/settings" class="sidebar-link" data-spa-link>
              <i class="fas fa-cog"></i>Settings
            </a>
            <a href="{{ base_path }}/admin/social" class="sidebar-link" data-spa-link>
              <i class="fas fa-share-alt"></i>Social
            </a>
            <a href="{{ base_path }}/admin/seo" class="sidebar-link" data-spa-link>
              <i class="fas fa-search"></i>SEO Settings
            </a>
            <a href="{{ base_path }}/admin/filter-settings" class="sidebar-link" data-spa-link>
              <i class="fas fa-sliders-h"></i>Filter Settings
            </a>

            <a href="{{ base_path }}/admin/commands" class="sidebar-link" data-spa-link>
              <i class="fas fa-terminal"></i>Commands
            </a>
            <a href="{{ base_path }}/admin/diagnostics" class="sidebar-link" data-spa-link>
              <i class="fas fa-stethoscope"></i>Diagnostics
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 lg:flex-1">
      <main class="p-4 lg:p-8" id="main-content">
        <div id="loading-indicator" class="hidden fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50">
          <div class="bg-white p-4 rounded-lg shadow-lg">
            <i class="fas fa-spinner fa-spin mr-2"></i>Loading...
          </div>
        </div>
        
        {% if flash %}
          {% for message in flash %}
            {% if message.type == 'success' %}
              <div class="mb-6 bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg shadow-sm flex items-center">
                <i class="fas fa-check-circle text-green-600 mr-3"></i>
                <span>{{ message.message }}</span>
              </div>
            {% elseif message.type == 'danger' or message.type == 'error' %}
              <div class="mb-6 bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg shadow-sm flex items-center">
                <i class="fas fa-exclamation-circle text-red-600 mr-3"></i>
                <span>{{ message.message }}</span>
              </div>
            {% elseif message.type == 'warning' %}
              <div class="mb-6 bg-yellow-50 border border-yellow-200 text-yellow-800 px-4 py-3 rounded-lg shadow-sm flex items-center">
                <i class="fas fa-exclamation-triangle text-yellow-600 mr-3"></i>
                <span>{{ message.message }}</span>
              </div>
            {% elseif message.type == 'info' %}
              <div class="mb-6 bg-blue-50 border border-blue-200 text-blue-800 px-4 py-3 rounded-lg shadow-sm flex items-center">
                <i class="fas fa-info-circle text-blue-600 mr-3"></i>
                <span>{{ message.message }}</span>
              </div>
            {% endif %}
          {% endfor %}
        {% endif %}

        <div id="page-content">
          {% block content %}{% endblock %}
        </div>
      </main>
    </div>
  </div>

  <!-- Toast container -->
  <div id="toast" class="fixed top-20 right-6 z-50 hidden">
    <div id="toast-inner" class="px-4 py-3 rounded shadow text-sm"></div>
  </div>

  <!-- Profile Modal -->
  <div id="profileModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen px-4">
      <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold text-gray-900">Il Mio Profilo</h3>
          <button onclick="closeProfileModal()" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <form id="profileForm" method="post" action="{{ base_path }}/admin/profile/update">
          <input type="hidden" name="csrf" value="{{ csrf }}">
          <div class="space-y-4">
            <div>
              <label for="profile-first-name" class="block text-sm font-medium text-gray-700 mb-1">Nome</label>
              <input id="profile-first-name" class="form-input" type="text" name="first_name" autocomplete="given-name" value="{{ session.admin_name|split(' ')|first }}" required>
            </div>
            <div>
              <label for="profile-last-name" class="block text-sm font-medium text-gray-700 mb-1">Cognome</label>
              <input id="profile-last-name" class="form-input" type="text" name="last_name" autocomplete="family-name" value="{{ session.admin_name|split(' ')|slice(1)|join(' ') }}" required>
            </div>
            <div>
              <label for="profile-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
              <input id="profile-email" class="form-input" type="email" name="email" autocomplete="email" value="{{ session.admin_email }}" required>
            </div>
          </div>
          <div class="flex justify-end space-x-3 mt-6">
            <button type="button" onclick="closeProfileModal()" class="btn-secondary">Annulla</button>
            <button type="submit" class="btn-primary">Aggiorna Profilo</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Password Change Modal -->
  <div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen px-4">
      <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold text-gray-900">Cambia Password</h3>
          <button onclick="closePasswordModal()" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <form id="passwordForm" method="post" action="{{ base_path }}/admin/profile/password">
          <input type="hidden" name="csrf" value="{{ csrf }}">
          <div class="space-y-4">
            <div>
              <label for="current-password" class="block text-sm font-medium text-gray-700 mb-1">Password Attuale</label>
              <input id="current-password" class="form-input" type="password" name="current_password" autocomplete="current-password" required>
            </div>
            <div>
              <label for="new-password" class="block text-sm font-medium text-gray-700 mb-1">Nuova Password</label>
              <input id="new-password" class="form-input" type="password" name="new_password" autocomplete="new-password" minlength="8" required>
            </div>
            <div>
              <label for="confirm-password" class="block text-sm font-medium text-gray-700 mb-1">Conferma Nuova Password</label>
              <input id="confirm-password" class="form-input" type="password" name="confirm_password" autocomplete="new-password" minlength="8" required>
            </div>
          </div>
          <div class="flex justify-end space-x-3 mt-6">
            <button type="button" onclick="closePasswordModal()" class="btn-secondary">Annulla</button>
            <button type="submit" class="btn-primary">Cambia Password</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // Highlight active sidebar link
    document.addEventListener('DOMContentLoaded', function() {
      const currentPath = window.location.pathname;
      const links = document.querySelectorAll('.sidebar-link');
      
      links.forEach(link => {
        if (link.getAttribute('href') === currentPath) {
          link.classList.add('active');
        }
      });
    });

    // Simple toast helper
    window.showToast = function(msg, type){
      const box = document.getElementById('toast');
      const inner = document.getElementById('toast-inner');
      inner.textContent = msg;
      inner.className = 'px-4 py-3 rounded shadow text-sm ' + (type==='error' ? 'bg-red-600 text-white' : 'bg-black text-white');
      box.classList.remove('hidden');
      setTimeout(()=>{ box.classList.add('hidden'); }, 2000);
    }

    // Profile Modal Functions
    function openProfileModal() {
      document.getElementById('profileModal').classList.remove('hidden');
    }

    function closeProfileModal() {
      document.getElementById('profileModal').classList.add('hidden');
    }

    // Password Modal Functions
    function openPasswordModal() {
      document.getElementById('passwordModal').classList.remove('hidden');
    }

    function closePasswordModal() {
      document.getElementById('passwordModal').classList.add('hidden');
      document.getElementById('passwordForm').reset();
    }

    // Password confirmation validation
    document.addEventListener('DOMContentLoaded', function() {
      const passwordForm = document.getElementById('passwordForm');
      if (passwordForm) {
        passwordForm.addEventListener('submit', function(e) {
          const newPassword = document.querySelector('input[name="new_password"]').value;
          const confirmPassword = document.querySelector('input[name="confirm_password"]').value;
          
          if (newPassword !== confirmPassword) {
            e.preventDefault();
            showToast('Le password non corrispondono', 'error');
            return false;
          }
        });
      }
    });

    // Close modals when clicking outside
    document.addEventListener('click', function(e) {
      if (e.target.id === 'profileModal') {
        closeProfileModal();
      }
      if (e.target.id === 'passwordModal') {
        closePasswordModal();
      }
    });

    // Enhanced dropdown behavior with delays and expanded hover areas
    document.addEventListener('DOMContentLoaded', function() {
      const dropdown = document.querySelector('.dropdown');
      const dropdownContent = document.querySelector('.dropdown-content');
      let showTimeout;
      let hideTimeout;
      
      if (dropdown && dropdownContent) {
        // Function to show dropdown
        function showDropdown() {
          clearTimeout(hideTimeout);
          showTimeout = setTimeout(() => {
            dropdownContent.classList.add('show');
          }, 100); // Small delay to prevent accidental opening
        }
        
        // Function to hide dropdown
        function hideDropdown() {
          clearTimeout(showTimeout);
          hideTimeout = setTimeout(() => {
            dropdownContent.classList.remove('show');
          }, 300); // Longer delay to prevent accidental closing
        }
        
        // Mouse events for dropdown button
        dropdown.addEventListener('mouseenter', showDropdown);
        dropdown.addEventListener('mouseleave', hideDropdown);
        
        // Mouse events for dropdown content (to keep it open when hovering over menu)
        dropdownContent.addEventListener('mouseenter', () => {
          clearTimeout(hideTimeout);
          clearTimeout(showTimeout);
        });
        
        dropdownContent.addEventListener('mouseleave', hideDropdown);
        
        // Click outside to close
        document.addEventListener('click', function(e) {
          if (!dropdown.contains(e.target)) {
            clearTimeout(showTimeout);
            clearTimeout(hideTimeout);
            dropdownContent.classList.remove('show');
          }
        });
        
        // Prevent dropdown from closing when clicking inside
        dropdown.addEventListener('click', function(e) {
          e.stopPropagation();
        });
      }
    });

    // SPA Navigation System
    document.addEventListener('DOMContentLoaded', function() {
      const pageContent = document.getElementById('page-content');
      const loadingIndicator = document.getElementById('loading-indicator');
      const sidebarLinks = document.querySelectorAll('[data-spa-link]');
      
      // Mobile Sidebar Functionality
      const sidebar = document.getElementById('sidebar');
      const sidebarOverlay = document.getElementById('sidebar-overlay');
      const sidebarToggle = document.getElementById('sidebar-toggle');
      const sidebarClose = document.getElementById('sidebar-close');
      
      function openSidebar() {
        sidebar.classList.remove('-translate-x-full');
        sidebarOverlay.classList.remove('hidden');
        document.body.classList.add('overflow-hidden'); // Prevent background scrolling
      }
      
      function closeSidebar() {
        sidebar.classList.add('-translate-x-full');
        sidebarOverlay.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
      }
      
      // Mobile sidebar toggle events
      if (sidebarToggle) {
        sidebarToggle.addEventListener('click', openSidebar);
      }
      
      if (sidebarClose) {
        sidebarClose.addEventListener('click', closeSidebar);
      }
      
      if (sidebarOverlay) {
        sidebarOverlay.addEventListener('click', closeSidebar);
      }
      
      // Close sidebar when clicking on sidebar links on mobile
      sidebarLinks.forEach(link => {
        link.addEventListener('click', function() {
          // Close sidebar on mobile after navigation
          if (window.innerWidth < 1024) {
            setTimeout(closeSidebar, 150);
          }
        });
      });
      
      // Handle window resize
      window.addEventListener('resize', function() {
        if (window.innerWidth >= 1024) {
          closeSidebar();
        }
      });
      
      // Function to update active sidebar link
      function updateActiveSidebar(currentPath) {
        sidebarLinks.forEach(link => {
          link.classList.remove('active');
          if (link.getAttribute('href') === currentPath) {
            link.classList.add('active');
          }
        });
      }
      
      // Function to show loading indicator
      function showLoading() {
        loadingIndicator.classList.remove('hidden');
      }
      
      // Function to hide loading indicator
      function hideLoading() {
        loadingIndicator.classList.add('hidden');
      }
      
      // Function to load page content via AJAX
      async function loadPageContent(url) {
        try {
          showLoading();
          
          const response = await fetch(url, {
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
              'Accept': 'text/html'
            }
          });
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          
          const html = await response.text();
          
          // Extract content from the response (assuming it's a full page)
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const content = doc.querySelector('#page-content') || doc.querySelector('main') || doc.body;
          
          if (content) {
            // Fade out current content
            pageContent.style.opacity = '0';
            
            setTimeout(() => {
              pageContent.innerHTML = content.innerHTML;

              // Execute scripts from the loaded content in order, wait for externals, then init
              (async () => {
                try {
                  // Collect scripts from the fetched document (not just #page-content),
                  // because Twig's "scripts" block is rendered outside #page-content.
                  const scripts = Array.from(doc.querySelectorAll('script'));
                  try { console.log('SPA: executing page scripts count =', scripts.length); } catch(e){}
                  for (const s of scripts) {
                    const sc = document.createElement('script');
                    if (s.type) sc.type = s.type;
                    const src = s.getAttribute('src');
                    if (src) {
                      if (src.includes('/assets/admin.js')) continue; // skip main bundle
                      sc.src = src;
                      sc.async = false;
                      const done = new Promise(resolve => {
                        sc.onload = () => resolve();
                        sc.onerror = () => resolve(); // continue on error
                      });
                      document.body.appendChild(sc);
                      await done;
                      setTimeout(() => sc.remove(), 0);
                    } else {
                      sc.text = s.textContent || '';
                      document.body.appendChild(sc);
                      setTimeout(() => sc.remove(), 0);
                    }
                  }
                } catch (e) {
                  // Keep going even if some inline scripts fail
                }

                // Reinitialize any JavaScript that might be needed
                initializePageScripts();

                // Safety fallback: if critical initializers did not attach, force a full reload
                try {
                  const href = url;
                  const needsAlbumModal = pageContent.querySelector('#images-grid');
                  const needsCategoriesDnD = pageContent.querySelector('#categories-container');
                  let fallback = false;
                  if (needsAlbumModal && typeof window.openImageModal !== 'function') {
                    fallback = true;
                  }
                  if (needsCategoriesDnD) {
                    const hasSortable = Array.isArray(window.sortableInstances) && window.sortableInstances.length > 0;
                    if (!hasSortable) fallback = true;
                  }
                  if (fallback) {
                    window.location.href = href;
                    return;
                  }
                } catch (e) {}

                // Fade in new content
                pageContent.style.opacity = '1';
                hideLoading();
              })();
            }, 150);
          } else {
            throw new Error('Could not find content in response');
          }
          
        } catch (error) {
          console.error('Failed to load page content:', error);
          hideLoading();
          showToast('Failed to load page content. Falling back to full page load.', 'error');
          
          // Fallback to full page load
          setTimeout(() => {
            window.location.href = url;
          }, 1000);
        }
      }
      
      // Function to reinitialize scripts after content load
      function initializePageScripts() {
        console.log('SPA: Initializing page scripts...');
        
        // Re-bind any click handlers for dynamic content
        const dynamicLinks = pageContent.querySelectorAll('a[href*="/admin/"]');
        dynamicLinks.forEach(link => {
          if (!link.hasAttribute('data-spa-link') && !link.hasAttribute('target') && !link.closest('form')) {
            link.addEventListener('click', handleDynamicLinkClick);
          }
        });

        // Call global admin initializer for widgets (TomSelect, Uppy, Sortable, etc.)
        if (window.AdminInit) {
          try { window.AdminInit(); } catch(e) { console.error('Admin init failed', e); }
        } else {
          console.warn('SPA: AdminInit function not found');
        }
        
        // Initialize any page-specific components
        initPageSpecificComponents();
        
        // Call page-specific initializers based on current page
        initPageSpecificInitializers();
        
        
      }
      
      // Initialize page-specific components
      function initPageSpecificComponents() {
        // Category/tag management pages
        if (pageContent.querySelector('#categories-table, #tags-table')) {
          initTableActions();
        }
        
        // Album edit pages
        if (pageContent.querySelector('#images-grid')) {
          initImageGridActions();
        }
        
        // Settings pages
        if (pageContent.querySelector('form[data-settings]')) {
          initSettingsForm();
        }
        
        // Analytics pages
        if (pageContent.querySelector('#analytics-charts')) {
          initAnalyticsCharts();
        }
      }
      
      // Cleanup page-specific resources when navigating away
      function cleanupPageSpecificResources() {
        // Cleanup real-time analytics if leaving analytics pages
        if (typeof window.cleanupRealTimeAnalytics === 'function' && 
            window.currentPageType === 'analytics-realtime' &&
            !window.location.pathname.includes('/admin/analytics/realtime')) {
          
          window.cleanupRealTimeAnalytics();
          window.currentPageType = null;
        }
      }
      
      // Initialize page-specific initializers
      function initPageSpecificInitializers() {
        // Cleanup any previous page-specific resources
        cleanupPageSpecificResources();
        
        if (window.pageInitializers) {
          const currentPath = window.location.pathname;
          
          // SEO settings page
          if (currentPath.includes('/admin/seo') && window.pageInitializers.seo) {
            try {
              window.pageInitializers.seo();
              
            } catch(e) {
              console.error('SPA: SEO page initializer failed', e);
            }
          }
          
          // Analytics page
          if (currentPath.includes('/admin/analytics') && window.pageInitializers.analytics) {
            try {
              window.pageInitializers.analytics();
              
            } catch(e) {
              console.error('SPA: Analytics page initializer failed', e);
            }
          }
          
          // Albums main page (index)
          if (currentPath === '/admin/albums' && window.pageInitializers.albumsIndex) {
            try {
              window.pageInitializers.albumsIndex();
              
            } catch(e) {
              console.error('SPA: Albums index page initializer failed', e);
            }
          }

          // Social settings page
          if (currentPath.includes('/admin/social') && window.pageInitializers.social) {
            try {
              window.pageInitializers.social();
            } catch(e) {
              console.error('SPA: Social page initializer failed', e);
            }
          }
          
          // Albums edit page
          if (currentPath.includes('/admin/albums/') && currentPath.includes('/edit') && window.pageInitializers.albums) {
            try {
              window.pageInitializers.albums();
              
            } catch(e) {
              console.error('SPA: Albums edit page initializer failed', e);
            }
          }
          
          // Album create page
          if (currentPath.includes('/admin/albums/create') && window.pageInitializers.albumsCreate) {
            try {
              window.pageInitializers.albumsCreate();
              
            } catch(e) {
              console.error('SPA: Album create page initializer failed', e);
            }
          }
          
          // Settings page
          if (currentPath.includes('/admin/settings') && window.pageInitializers.settings) {
            try {
              window.pageInitializers.settings();
              
            } catch(e) {
              console.error('SPA: Settings page initializer failed', e);
            }
          }
        }
      }
      // Initialize scripts for initial page load
      initializePageScripts();
      
      // Table actions for categories/tags/etc
      function initTableActions() {
        const deleteButtons = pageContent.querySelectorAll('[data-delete-id]');
        deleteButtons.forEach(btn => {
          btn.addEventListener('click', handleTableDelete);
        });
      }
      
      // Image grid actions
      function initImageGridActions() {
        // This will be handled by AdminInit -> initSortableGrid
        // But we can add additional grid-specific handlers here
        const grid = pageContent.querySelector('#images-grid');
        if (grid && !grid._gridInitialized) {
          grid._gridInitialized = true;
          // Add any additional grid event handlers
        }
      }
      
      // Settings form handlers
      function initSettingsForm() {
        const forms = pageContent.querySelectorAll('form[data-settings]');
        forms.forEach(form => {
          if (!form._settingsInitialized) {
            form._settingsInitialized = true;
            form.addEventListener('submit', handleSettingsSubmit);
          }
        });
      }
      
      // Analytics charts initialization
      function initAnalyticsCharts() {
        // Initialize Chart.js if present
        if (window.Chart && pageContent.querySelector('canvas')) {
          console.log('SPA: Initializing analytics charts');
          // Chart initialization will be handled by page-specific scripts
        }
      }
      
      // Event handlers
      function handleTableDelete(e) {
        e.preventDefault();
        const id = e.target.getAttribute('data-delete-id');
        const itemName = e.target.getAttribute('data-item-name') || 'item';
        
        if (confirm(`Are you sure you want to delete this ${itemName}?`)) {
          // Handle delete action
          console.log(`Deleting ${itemName} with ID: ${id}`);
        }
      }
      
      function handleSettingsSubmit(e) {
        const form = e.target;
        console.log('Settings form submitted:', form);
        // Additional settings form handling if needed
      }
      
      // Handle clicks on dynamically loaded links
      function handleDynamicLinkClick(e) {
        const href = e.target.closest('a').getAttribute('href');
        if (href && href.includes('/admin/') && !href.includes('#') && !e.target.closest('form')) {
          e.preventDefault();
          loadPageContent(href);
          updateActiveSidebar(href);
          
          // Update browser history
          history.pushState(null, '', href);
        }
      }
      
      // Handle sidebar navigation
      sidebarLinks.forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          
          const href = this.getAttribute('href');
          loadPageContent(href);
          updateActiveSidebar(href);
          
          // Update browser history
          history.pushState(null, '', href);
        });
      });
      
      // Handle browser back/forward buttons
      window.addEventListener('popstate', function() {
        const currentPath = window.location.pathname;
        loadPageContent(currentPath);
        updateActiveSidebar(currentPath);
      });
      
      // Set initial active sidebar link
      updateActiveSidebar(window.location.pathname);
      
      // Add smooth transition to page content
      pageContent.style.transition = 'opacity 0.15s ease-in-out';
    });
  </script>
  <script>
    // Suppress verbose SPA/admin debug logs without affecting errors
    (function(){
      var origLog = console.log;
      var patterns = [
        /^SPA:\s*/i,
        /^AdminInit:/i,
        /Cleanup completed successfully/i,
        /Initializing TomSelects/i,
        /Initializing Sortable/i,
        /No images-grid/i,
        /Initializing TinyMCE/i,
        /No richtext areas/i,
        /completed successfully$/i
      ];
      console.log = function(){
        try {
          var str = Array.prototype.join.call(arguments, ' ');
          for (var i=0;i<patterns.length;i++) if (patterns[i].test(str)) return;
        } catch(e){}
        return origLog.apply(console, arguments);
      };
    })();
  </script>
  <script type="module" src="{{ base_path }}/assets/admin.js"></script>
</body>
</html>
