{% extends 'admin/_layout.twig' %}
{% block title %}Settings — photoCMS{% endblock %}
{% block content %}
  <div class="flex items-center justify-between mb-8">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">Settings</h1>
      <p class="text-gray-600 mt-1">Configure your photoCMS installation</p>
    </div>
  </div>

  <div class="pb-48"> <!-- Increased padding bottom for sticky footer -->
    <form method="post" action="{{ base_path }}/admin/settings" id="settings-form" class="space-y-8">
    <input type="hidden" name="csrf" value="{{ csrf }}">
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Image Formats -->
      <div class="card">
        <div class="p-6">
          <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
            <i class="fas fa-image mr-3 text-gray-600"></i>
            Image Formats
          </h3>
          
          <div class="space-y-4 mb-6">
            <label class="flex items-center">
              <input type="checkbox" name="fmt_avif" id="fmt_avif" class="rounded border-gray-300 text-black focus:ring-black" {% if settings['image.formats'].avif %}checked{% endif %}>
              <span class="ml-3 text-sm text-gray-700">
                <strong>AVIF</strong> - Modern format with excellent compression
              </span>
            </label>
            
            <label class="flex items-center">
              <input type="checkbox" name="fmt_webp" id="fmt_webp" class="rounded border-gray-300 text-black focus:ring-black" {% if settings['image.formats'].webp %}checked{% endif %}>
              <span class="ml-3 text-sm text-gray-700">
                <strong>WebP</strong> - Good compression with wide support
              </span>
            </label>
            
            <label class="flex items-center">
              <input type="checkbox" name="fmt_jpg" id="fmt_jpg" class="rounded border-gray-300 text-black focus:ring-black" {% if settings['image.formats'].jpg %}checked{% endif %}>
              <span class="ml-3 text-sm text-gray-700">
                <strong>JPEG</strong> - Universal compatibility
              </span>
            </label>
          </div>

          <div class="grid grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">AVIF Quality</label>
              <input type="number" name="q_avif" min="1" max="100" value="{{ settings['image.quality'].avif }}" class="form-input">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">WebP Quality</label>
              <input type="number" name="q_webp" min="1" max="100" value="{{ settings['image.quality'].webp }}" class="form-input">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">JPEG Quality</label>
              <input type="number" name="q_jpg" min="1" max="100" value="{{ settings['image.quality'].jpg }}" class="form-input">
            </div>
          </div>
        </div>
      </div>

      <!-- Breakpoints & Preview -->
      <div class="card">
        <div class="p-6">
          <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
            <i class="fas fa-desktop mr-3 text-gray-600"></i>
            Breakpoints & Preview
          </h3>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Preview Width (px)</label>
              <input type="number" name="preview_w" value="{{ settings['image.preview'].width }}" class="form-input">
              <p class="text-xs text-gray-500 mt-1">Width for image previews in admin</p>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Responsive Breakpoints</label>
              <textarea name="breakpoints" rows="6" class="form-input font-mono text-sm">{{ settings['image.breakpoints']|json_encode(constant('JSON_PRETTY_PRINT')) }}</textarea>
              <p class="text-xs text-gray-500 mt-1">JSON format: {"sm":768,"md":1200,"lg":1920,"xl":2560,"xxl":3840}</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Site Settings -->
    <div class="card">
      <div class="p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
          <i class="fas fa-globe mr-3 text-gray-600"></i>
          Site Configuration
        </h3>
        
        <!-- Logo Upload Section (Full Width) -->
        <div class="mb-8">
          <label class="block text-sm font-medium text-gray-700 mb-2">Site Logo</label>
          <input type="hidden" id="site_logo" name="site_logo" value="{{ settings['site.logo'] ?? '' }}">
          <div class="flex flex-col md:flex-row items-start gap-6">
            <div class="w-32 h-32 border-2 border-dashed border-gray-300 rounded-lg bg-white flex items-center justify-center overflow-hidden flex-shrink-0">
              {% if settings['site.logo'] %}
                <img id="site-logo-preview" src="{{ base_path ~ settings['site.logo'] }}" alt="Logo" class="max-w-full max-h-full">
              {% else %}
                <img id="site-logo-preview" src="" alt="Logo" class="max-w-full max-h-full hidden">
                <span class="text-xs text-gray-500">Nessun logo</span>
              {% endif %}
            </div>
            <div class="flex-1">
              <div id="logo-uppy" data-endpoint="{{ base_path }}/admin/settings/logo-upload" data-csrf="{{ csrf }}" 
                   class="w-full border-2 border-dashed border-gray-300 rounded-lg p-6 text-center text-gray-600 hover:bg-gray-50 cursor-pointer transition-colors">
                <div class="flex flex-col items-center justify-center gap-2">
                  <i class="fas fa-cloud-upload-alt text-2xl text-gray-400"></i>
                  <div class="font-medium">Carica un nuovo logo</div>
                  <div class="text-sm text-gray-500">Formati supportati: PNG, JPG, WebP (dimensione consigliata: 200x200px)</div>
                </div>
              </div>
              <button id="site-logo-clear" type="button" class="mt-3 text-sm text-red-600 hover:underline {{ settings['site.logo'] ? '' : 'hidden' }}">
                <i class="fas fa-trash mr-1"></i>Rimuovi logo corrente
              </button>
            </div>
          </div>
          <p class="text-xs text-gray-500 mt-2">Se non impostato, verrà usato il titolo del sito.</p>
        </div>
        
        <!-- Other Site Settings (Grid Layout) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Site Title</label>
            <input type="text" name="site_title" value="{{ settings['site.title'] ?? 'photoCMS' }}" class="form-input">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Site Description</label>
            <input type="text" name="site_description" value="{{ settings['site.description'] ?? 'Professional Photography Portfolio' }}" class="form-input">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Copyright Notice</label>
            <input type="text" name="site_copyright" value="{{ settings['site.copyright'] ?? '© 2024 Photography Portfolio' }}" class="form-input">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Contact Email</label>
            <input type="email" name="site_email" value="{{ settings['site.email'] ?? '' }}" class="form-input">
          </div>
        </div>
      </div>
    </div>

    <!-- Gallery Page Template -->
    <div class="card">
      <div class="p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
          <i class="fas fa-palette mr-3 text-gray-700"></i>
          Template Pagina Galleria
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <label class="flex items-start gap-3 p-4 border rounded-lg hover:border-gray-300 cursor-pointer">
            <input type="radio" name="gallery_page_template" value="classic" class="mt-1" {% if settings['gallery.page_template']|default('classic') == 'classic' %}checked{% endif %}>
            <div>
              <div class="font-medium text-gray-900">Classic Grid</div>
              <div class="text-sm text-gray-600">Layout attuale minimale, B/N, con griglia o slideshow secondo template</div>
            </div>
          </label>
          <label class="flex items-start gap-3 p-4 border rounded-lg hover:border-gray-300 cursor-pointer">
            <input type="radio" name="gallery_page_template" value="hero" class="mt-1" {% if settings['gallery.page_template'] == 'hero' %}checked{% endif %}>
            <div>
              <div class="font-medium text-gray-900">Hero Cover</div>
              <div class="text-sm text-gray-600">Cover grande con overlay, titolo, data e location; galleria sotto</div>
            </div>
          </label>
          <label class="flex items-start gap-3 p-4 border rounded-lg hover:border-gray-300 cursor-pointer">
            <input type="radio" name="gallery_page_template" value="magazine" class="mt-1" {% if settings['gallery.page_template'] == 'magazine' %}checked{% endif %}>
            <div>
              <div class="font-medium text-gray-900">Magazine Split</div>
              <div class="text-sm text-gray-600">Colonna sinistra con testi/info in sticky; griglia a destra</div>
            </div>
          </label>
        </div>
      </div>
    </div>

    <!-- Default Gallery Template -->
    <div class="card">
      <div class="p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
          <i class="fas fa-th mr-3 text-gray-600"></i>
          Template Predefinito Gallery
        </h3>
        <p class="text-sm text-gray-600 mb-6">Impostazioni utilizzate quando un album non ha un template specifico assegnato</p>
        
        <!-- Debug Information -->
        <div class="default-template-container">
          <label class="block text-sm font-medium text-gray-700 mb-2">Template Predefinito</label>
          
          
          {% set pageTpl = settings['gallery.page_template']|default('classic') %}
          {% set disableDefault = pageTpl == 'magazine' %}
          <select name="default_template_id" class="form-input {{ disableDefault ? 'bg-gray-100 cursor-not-allowed' : '' }}" {{ disableDefault ? 'disabled' : '' }}>
            <option value="">Nessun template predefinito</option>
            {% for template in templates %}
              {% set isSelected = (template.id ~ '') == (settings['gallery.default_template_id'] ~ '') %}
              <option value="{{ template.id }}" {% if isSelected %}selected{% endif %}>{{ template.name }}</option>
            {% endfor %}
          </select>
          <p class="text-xs text-gray-500 mt-1">
            Template utilizzato quando un album non ha un template specifico assegnato.
            {% if disableDefault %}<br>Con <strong>Magazine Split</strong> come layout pagina, questo selettore non è applicabile e viene disabilitato.{% endif %}
          </p>
        </div>
      </div>
    </div>

    <!-- Performance Settings -->
    <div class="card">
      <div class="p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
          <i class="fas fa-tachometer-alt mr-3 text-gray-600"></i>
          Performance
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Items per Page</label>
            <input type="number" name="pagination_limit" value="{{ settings['pagination.limit'] ?? 12 }}" class="form-input" min="1" max="100">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Cache TTL (hours)</label>
            <input type="number" name="cache_ttl" value="{{ settings['cache.ttl'] ?? 24 }}" class="form-input" min="1" max="168">
          </div>
          
          <div>
            <label class="flex items-center pt-8">
              <input type="checkbox" name="enable_compression" class="rounded border-gray-300 text-black focus:ring-black" {% if settings['performance.compression'] %}checked{% endif %}>
              <span class="ml-3 text-sm text-gray-700">Enable Gzip Compression</span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Image Generation Form -->
    <div class="card mb-6">
      <div class="p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
          <i class="fas fa-images mr-3 text-gray-600"></i>
          Genera Varianti Immagini
        </h3>
        <p class="text-sm text-gray-600 mb-4">Genera automaticamente le varianti ad alta risoluzione per tutte le immagini mancanti</p>
        
        <form id="generate-images-form" method="post" action="{{ base_path }}/admin/settings/generate-images" onsubmit="return handleImageGeneration(event);" class="border-t border-gray-200 pt-4">
          <input type="hidden" name="csrf" value="{{ csrf }}">
          <button id="generate-btn" type="submit" class="btn-secondary">
            <i id="generate-icon" class="fas fa-images mr-2"></i>
            <span id="generate-text">Genera Varianti Immagini</span>
          </button>
          <div id="generate-status" class="mt-2 hidden">
            <div class="text-xs text-blue-600 flex items-center">
              <i class="fas fa-spinner fa-spin mr-2"></i>
              <span>Generazione in corso... Questa operazione potrebbe richiedere alcuni minuti.</span>
            </div>
          </div>
          <div id="generate-result" class="mt-2 hidden"></div>
        </form>
      </div>
    </div>
    
    </form>
  </div>

  <!-- Sticky Footer with Action Buttons -->
  <div class="fixed bottom-0 left-64 right-0 bg-white border-t border-gray-200 shadow-lg z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <button type="submit" form="settings-form" class="btn-primary">
            <i class="fas fa-save mr-2"></i>
            Salva Impostazioni
          </button>
          <a href="{{ base_path }}/admin" class="btn-secondary">
            <i class="fas fa-arrow-left mr-2"></i>
            Dashboard
          </a>
        </div>
        
        <div class="text-sm text-gray-500">
          <i class="fas fa-info-circle mr-1"></i>
          Configura le impostazioni del sistema
        </div>
      </div>
    </div>
  </div>

<script>
// Handle form submission to ensure checkbox values are properly sent
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('settings-form');
  if (form) {
    form.addEventListener('submit', function(e) {
      // Debug: Log form data before submission
      const formData = new FormData(form);
      console.log('Settings form data being submitted:');
      for (let [key, value] of formData.entries()) {
        console.log(key + ':', value);
      }
      
      // Specifically log the default template ID
      const templateId = formData.get('default_template_id');
      console.log('Default template ID:', templateId);
      console.log('Template ID type:', typeof templateId);
      
      // Remove any existing hidden checkbox fields to prevent conflicts
      const existingHidden = form.querySelectorAll('input[type="hidden"][data-checkbox="true"]');
      existingHidden.forEach(input => input.remove());
      
      // Ensure checkbox states are properly handled
      const checkboxes = form.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach(checkbox => {
        if (!checkbox.checked) {
          // Create hidden input for unchecked checkboxes
          const hidden = document.createElement('input');
          hidden.type = 'hidden';
          hidden.name = checkbox.name;
          hidden.value = '0';
          hidden.setAttribute('data-checkbox', 'true');
          form.appendChild(hidden);
        }
      });
    });
  }
});

function handleImageGeneration(event) {
  event.preventDefault();
  
  if (!confirm('Generare le varianti delle immagini? Questa operazione potrebbe richiedere alcuni minuti.')) {
    return false;
  }
  
  // Show loading state
  const btn = document.getElementById('generate-btn');
  const icon = document.getElementById('generate-icon');
  const text = document.getElementById('generate-text');
  const status = document.getElementById('generate-status');
  const result = document.getElementById('generate-result');
  
  btn.disabled = true;
  icon.className = 'fas fa-spinner fa-spin mr-2';
  text.textContent = 'Generando...';
  status.classList.remove('hidden');
  result.classList.add('hidden');
  
  // Submit form via fetch
  const form = document.getElementById('generate-images-form');
  const formData = new FormData(form);
  
  fetch(form.action, {
    method: 'POST',
    body: formData
  })
  .then(response => {
    // Reset button state
    btn.disabled = false;
    icon.className = 'fas fa-images mr-2';
    text.textContent = 'Genera Varianti Immagini';
    status.classList.add('hidden');
    
    // Show info result for background process
    result.innerHTML = '<div class="text-xs text-blue-600 flex items-center"><i class="fas fa-info-circle mr-2"></i><span>Processo di generazione avviato! Potrebbe richiedere alcuni minuti. Verrai notificato al completamento.</span></div>';
    result.classList.remove('hidden');
    
    // Hide result after 10 seconds
    setTimeout(() => {
      result.classList.add('hidden');
    }, 10000);
  })
  .catch(error => {
    // Reset button state
    btn.disabled = false;
    icon.className = 'fas fa-images mr-2';
    text.textContent = 'Genera Varianti Immagini';
    status.classList.add('hidden');
    
    // Show error result
    result.innerHTML = '<div class="text-xs text-red-600 flex items-center"><i class="fas fa-exclamation-circle mr-2"></i><span>Errore durante l\'avvio della generazione</span></div>';
    result.classList.remove('hidden');
  });
  
  return false;
}

// Handle page template changes for default template selector
document.addEventListener('DOMContentLoaded', function() {
  // Handle page template changes for default template selector
  const pageTemplateRadios = document.querySelectorAll('input[name="gallery_page_template"]');
  const defaultTemplateSelect = document.querySelector('select[name="default_template_id"]');
  
  if (pageTemplateRadios.length > 0 && defaultTemplateSelect) {
    // Add event listeners to all page template radios
    pageTemplateRadios.forEach(radio => {
      radio.addEventListener('change', function() {
        updateDefaultTemplateSelector(this.value);
      });
    });
    
    // Set initial state based on currently selected radio
    const selectedRadio = document.querySelector('input[name="gallery_page_template"]:checked');
    if (selectedRadio) {
      updateDefaultTemplateSelector(selectedRadio.value);
    }
  }
});

function updateDefaultTemplateSelector(selectedValue) {
  const defaultTemplateSelect = document.querySelector('select[name="default_template_id"]');
  const defaultTemplateContainer = defaultTemplateSelect?.closest('.default-template-container');
  
  if (defaultTemplateSelect && defaultTemplateContainer) {
    if (selectedValue === 'magazine') {
      // Disable the selector
      defaultTemplateSelect.disabled = true;
      defaultTemplateSelect.classList.add('bg-gray-100', 'cursor-not-allowed');
      defaultTemplateContainer.classList.add('opacity-75');
      
      // Show disabled message
      let msg = defaultTemplateContainer.querySelector('.template-disabled-message');
      if (!msg) {
        msg = document.createElement('div');
        msg.className = 'template-disabled-message text-xs text-gray-500 mt-2 p-3 bg-gray-50 rounded border border-gray-200';
        msg.innerHTML = '<i class="fas fa-info-circle mr-1"></i>Con <strong>Magazine Split</strong> come layout pagina, questo selettore non è applicabile e viene disabilitato.';
        defaultTemplateContainer.appendChild(msg);
      }
      msg.style.display = 'block';
    } else {
      // Enable the selector
      defaultTemplateSelect.disabled = false;
      defaultTemplateSelect.classList.remove('bg-gray-100', 'cursor-not-allowed');
      defaultTemplateContainer.classList.remove('opacity-75');
      
      // Hide disabled message
      const msg = defaultTemplateContainer.querySelector('.template-disabled-message');
      if (msg) {
        msg.style.display = 'none';
      }
    }
  }
}
</script>
{% endblock %}
