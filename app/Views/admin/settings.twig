{% extends 'admin/_layout.twig' %}
{% block title %}Settings — photoCMS{% endblock %}
{% block content %}
  <div class="flex items-center justify-between mb-8">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">Settings</h1>
      <p class="text-gray-600 mt-1">Configure your photoCMS installation</p>
    </div>
  </div>

  <div class="pb-48"> <!-- Increased padding bottom for sticky footer -->
    <form method="post" action="/admin/settings" id="settings-form" class="space-y-8">
    <input type="hidden" name="csrf" value="{{ csrf }}">
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Image Formats -->
      <div class="card">
        <div class="p-6">
          <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
            <i class="fas fa-image mr-3 text-gray-600"></i>
            Image Formats
          </h3>
          
          <div class="space-y-4 mb-6">
            <label class="flex items-center">
              <input type="checkbox" name="fmt_avif" id="fmt_avif" class="rounded border-gray-300 text-black focus:ring-black" {% if settings['image.formats'].avif %}checked{% endif %}>
              <span class="ml-3 text-sm text-gray-700">
                <strong>AVIF</strong> - Modern format with excellent compression
              </span>
            </label>
            
            <label class="flex items-center">
              <input type="checkbox" name="fmt_webp" id="fmt_webp" class="rounded border-gray-300 text-black focus:ring-black" {% if settings['image.formats'].webp %}checked{% endif %}>
              <span class="ml-3 text-sm text-gray-700">
                <strong>WebP</strong> - Good compression with wide support
              </span>
            </label>
            
            <label class="flex items-center">
              <input type="checkbox" name="fmt_jpg" id="fmt_jpg" class="rounded border-gray-300 text-black focus:ring-black" {% if settings['image.formats'].jpg %}checked{% endif %}>
              <span class="ml-3 text-sm text-gray-700">
                <strong>JPEG</strong> - Universal compatibility
              </span>
            </label>
          </div>

          <div class="grid grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">AVIF Quality</label>
              <input type="number" name="q_avif" min="1" max="100" value="{{ settings['image.quality'].avif }}" class="form-input">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">WebP Quality</label>
              <input type="number" name="q_webp" min="1" max="100" value="{{ settings['image.quality'].webp }}" class="form-input">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">JPEG Quality</label>
              <input type="number" name="q_jpg" min="1" max="100" value="{{ settings['image.quality'].jpg }}" class="form-input">
            </div>
          </div>
        </div>
      </div>

      <!-- Breakpoints & Preview -->
      <div class="card">
        <div class="p-6">
          <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
            <i class="fas fa-desktop mr-3 text-gray-600"></i>
            Breakpoints & Preview
          </h3>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Preview Width (px)</label>
              <input type="number" name="preview_w" value="{{ settings['image.preview'].width }}" class="form-input">
              <p class="text-xs text-gray-500 mt-1">Width for image previews in admin</p>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Responsive Breakpoints</label>
              <textarea name="breakpoints" rows="6" class="form-input font-mono text-sm">{{ settings['image.breakpoints']|json_encode(constant('JSON_PRETTY_PRINT')) }}</textarea>
              <p class="text-xs text-gray-500 mt-1">JSON format: {"sm":768,"md":1200,"lg":1920,"xl":2560,"xxl":3840}</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Site Settings -->
    <div class="card">
      <div class="p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
          <i class="fas fa-globe mr-3 text-gray-600"></i>
          Site Configuration
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Site Title</label>
            <input type="text" name="site_title" value="{{ settings['site.title'] ?? 'photoCMS' }}" class="form-input">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Site Description</label>
            <input type="text" name="site_description" value="{{ settings['site.description'] ?? 'Professional Photography Portfolio' }}" class="form-input">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Copyright Notice</label>
            <input type="text" name="site_copyright" value="{{ settings['site.copyright'] ?? '© 2024 Photography Portfolio' }}" class="form-input">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Contact Email</label>
            <input type="email" name="site_email" value="{{ settings['site.email'] ?? '' }}" class="form-input">
          </div>
        </div>
      </div>
    </div>

    <!-- Default Gallery Template -->
    <div class="card">
      <div class="p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
          <i class="fas fa-th mr-3 text-gray-600"></i>
          Template Predefinito Gallery
        </h3>
        <p class="text-sm text-gray-600 mb-6">Impostazioni utilizzate quando un album non ha un template specifico assegnato</p>
        
        <!-- Debug Information -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Template Predefinito</label>
          
          <select name="default_template_id" class="form-input">
            <option value="">Nessun template predefinito</option>
            {% for template in templates %}
              {% set isSelected = template.id == settings['gallery.default_template_id'] %}
              <option value="{{ template.id }}" {% if isSelected %}selected{% endif %}>{{ template.name }}</option>
            {% endfor %}
          </select>
          <p class="text-xs text-gray-500 mt-1">Template utilizzato quando un album non ha un template specifico assegnato</p>
        </div>
      </div>
    </div>

    <!-- Performance Settings -->
    <div class="card">
      <div class="p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
          <i class="fas fa-tachometer-alt mr-3 text-gray-600"></i>
          Performance
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Items per Page</label>
            <input type="number" name="pagination_limit" value="{{ settings['pagination.limit'] ?? 12 }}" class="form-input" min="1" max="100">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Cache TTL (hours)</label>
            <input type="number" name="cache_ttl" value="{{ settings['cache.ttl'] ?? 24 }}" class="form-input" min="1" max="168">
          </div>
          
          <div>
            <label class="flex items-center pt-8">
              <input type="checkbox" name="enable_compression" class="rounded border-gray-300 text-black focus:ring-black" {% if settings['performance.compression'] %}checked{% endif %}>
              <span class="ml-3 text-sm text-gray-700">Enable Gzip Compression</span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Image Generation Form -->
    <div class="card mb-6">
      <div class="p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
          <i class="fas fa-images mr-3 text-gray-600"></i>
          Genera Varianti Immagini
        </h3>
        <p class="text-sm text-gray-600 mb-4">Genera automaticamente le varianti ad alta risoluzione per tutte le immagini mancanti</p>
        
        <form id="generate-images-form" method="post" action="/admin/settings/generate-images" onsubmit="return handleImageGeneration(event);" class="border-t border-gray-200 pt-4">
          <input type="hidden" name="csrf" value="{{ csrf }}">
          <button id="generate-btn" type="submit" class="btn-secondary">
            <i id="generate-icon" class="fas fa-images mr-2"></i>
            <span id="generate-text">Genera Varianti Immagini</span>
          </button>
          <div id="generate-status" class="mt-2 hidden">
            <div class="text-xs text-blue-600 flex items-center">
              <i class="fas fa-spinner fa-spin mr-2"></i>
              <span>Generazione in corso... Questa operazione potrebbe richiedere alcuni minuti.</span>
            </div>
          </div>
          <div id="generate-result" class="mt-2 hidden"></div>
        </form>
      </div>
    </div>
    
    </form>
  </div>

  <!-- Sticky Footer with Action Buttons -->
  <div class="fixed bottom-0 left-64 right-0 bg-white border-t border-gray-200 shadow-lg z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <button type="submit" form="settings-form" class="btn-primary">
            <i class="fas fa-save mr-2"></i>
            Salva Impostazioni
          </button>
          <a href="/admin" class="btn-secondary">
            <i class="fas fa-arrow-left mr-2"></i>
            Dashboard
          </a>
        </div>
        
        <div class="text-sm text-gray-500">
          <i class="fas fa-info-circle mr-1"></i>
          Configura le impostazioni del sistema
        </div>
      </div>
    </div>
  </div>

<script>
// Handle form submission to ensure checkbox values are properly sent
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('settings-form');
  if (form) {
    form.addEventListener('submit', function(e) {
      // Debug: Log form data before submission
      const formData = new FormData(form);
      console.log('Settings form data being submitted:');
      for (let [key, value] of formData.entries()) {
        console.log(key + ':', value);
      }
      
      // Specifically log the default template ID
      const templateId = formData.get('default_template_id');
      console.log('Default template ID:', templateId);
      console.log('Template ID type:', typeof templateId);
      
      // Remove any existing hidden checkbox fields to prevent conflicts
      const existingHidden = form.querySelectorAll('input[type="hidden"][data-checkbox="true"]');
      existingHidden.forEach(input => input.remove());
      
      // Ensure checkbox states are properly handled
      const checkboxes = form.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach(checkbox => {
        if (!checkbox.checked) {
          // Create hidden input for unchecked checkboxes
          const hidden = document.createElement('input');
          hidden.type = 'hidden';
          hidden.name = checkbox.name;
          hidden.value = '0';
          hidden.setAttribute('data-checkbox', 'true');
          form.appendChild(hidden);
        }
      });
    });
  }
});

function handleImageGeneration(event) {
  event.preventDefault();
  
  if (!confirm('Generare le varianti delle immagini? Questa operazione potrebbe richiedere alcuni minuti.')) {
    return false;
  }
  
  // Show loading state
  const btn = document.getElementById('generate-btn');
  const icon = document.getElementById('generate-icon');
  const text = document.getElementById('generate-text');
  const status = document.getElementById('generate-status');
  const result = document.getElementById('generate-result');
  
  btn.disabled = true;
  icon.className = 'fas fa-spinner fa-spin mr-2';
  text.textContent = 'Generando...';
  status.classList.remove('hidden');
  result.classList.add('hidden');
  
  // Submit form via fetch
  const form = document.getElementById('generate-images-form');
  const formData = new FormData(form);
  
  fetch(form.action, {
    method: 'POST',
    body: formData
  })
  .then(response => {
    // Reset button state
    btn.disabled = false;
    icon.className = 'fas fa-images mr-2';
    text.textContent = 'Genera Varianti Immagini';
    status.classList.add('hidden');
    
    // Show info result for background process
    result.innerHTML = '<div class="text-xs text-blue-600 flex items-center"><i class="fas fa-info-circle mr-2"></i><span>Processo di generazione avviato! Potrebbe richiedere alcuni minuti. Verrai notificato al completamento.</span></div>';
    result.classList.remove('hidden');
    
    // Hide result after 10 seconds
    setTimeout(() => {
      result.classList.add('hidden');
    }, 10000);
  })
  .catch(error => {
    // Reset button state
    btn.disabled = false;
    icon.className = 'fas fa-images mr-2';
    text.textContent = 'Genera Varianti Immagini';
    status.classList.add('hidden');
    
    // Show error result
    result.innerHTML = '<div class="text-xs text-red-600 flex items-center"><i class="fas fa-exclamation-circle mr-2"></i><span>Errore durante l\'avvio della generazione</span></div>';
    result.classList.remove('hidden');
  });
  
  return false;
}
</script>
{% endblock %}