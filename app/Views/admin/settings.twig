{% extends 'admin/_layout.twig' %}
{% block title %}{{ trans('admin.settings.title') }} — Cimaise{% endblock %}
{% block content %}
  <div class="flex items-center justify-between mb-8">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">{{ trans('admin.settings.title') }}</h1>
      <p class="text-gray-600 mt-1">{{ trans('admin.settings.description') }}</p>
    </div>
  </div>

  <div class="pb-48"> <!-- Increased padding bottom for sticky footer -->
    <form method="post" action="{{ base_path }}/admin/settings" id="settings-form" class="space-y-8">
    <input type="hidden" name="csrf" value="{{ csrf }}">
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Image Formats -->
      <div class="card">
        <div class="p-6">
          <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
            <i class="fas fa-image mr-3 text-gray-600"></i>
            {{ trans('admin.settings.image_formats') }}
          </h3>

          <div class="space-y-4 mb-6">
            <label class="flex items-center">
              <input type="checkbox" name="fmt_avif" id="fmt_avif" class="rounded border-gray-300 text-black focus:ring-black" {% if settings['image.formats'].avif %}checked{% endif %}>
              <span class="ml-3 text-sm text-gray-700">
                <strong>AVIF</strong> - {{ trans('admin.settings.avif_desc') }}
              </span>
            </label>

            <label class="flex items-center">
              <input type="checkbox" name="fmt_webp" id="fmt_webp" class="rounded border-gray-300 text-black focus:ring-black" {% if settings['image.formats'].webp %}checked{% endif %}>
              <span class="ml-3 text-sm text-gray-700">
                <strong>WebP</strong> - {{ trans('admin.settings.webp_desc') }}
              </span>
            </label>

            <label class="flex items-center">
              <input type="checkbox" name="fmt_jpg" id="fmt_jpg" class="rounded border-gray-300 text-black focus:ring-black" {% if settings['image.formats'].jpg %}checked{% endif %}>
              <span class="ml-3 text-sm text-gray-700">
                <strong>JPEG</strong> - {{ trans('admin.settings.jpg_desc') }}
              </span>
            </label>
          </div>

          <div class="grid grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">{{ trans('admin.settings.avif_quality') }}</label>
              <input type="number" name="q_avif" min="1" max="100" value="{{ settings['image.quality'].avif }}" class="form-input">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">{{ trans('admin.settings.webp_quality') }}</label>
              <input type="number" name="q_webp" min="1" max="100" value="{{ settings['image.quality'].webp }}" class="form-input">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">{{ trans('admin.settings.jpg_quality') }}</label>
              <input type="number" name="q_jpg" min="1" max="100" value="{{ settings['image.quality'].jpg }}" class="form-input">
            </div>
          </div>
        </div>
      </div>

      <!-- Breakpoints & Preview -->
      <div class="card">
        <div class="p-6">
          <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
            <i class="fas fa-desktop mr-3 text-gray-600"></i>
            {{ trans('admin.settings.breakpoints') }}
          </h3>

          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">{{ trans('admin.settings.preview_width') }}</label>
              <input type="number" name="preview_w" value="{{ settings['image.preview'].width }}" class="form-input">
              <p class="text-xs text-gray-500 mt-1">{{ trans('admin.settings.preview_width_hint') }}</p>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-900 mb-3">{{ trans('admin.settings.responsive_breakpoints') }}</label>
              <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                <div>
                  <label class="block text-xs font-medium text-gray-600 mb-1">{{ trans('admin.settings.breakpoint_sm') }}</label>
                  <div class="flex items-center gap-2">
                    <input type="number" name="bp_sm" min="100" max="2000" value="{{ settings['image.breakpoints'].sm|default(400) }}" class="form-input text-sm" placeholder="400">
                    <span class="text-xs text-gray-500">px</span>
                  </div>
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 mb-1">{{ trans('admin.settings.breakpoint_md') }}</label>
                  <div class="flex items-center gap-2">
                    <input type="number" name="bp_md" min="100" max="2000" value="{{ settings['image.breakpoints'].md|default(800) }}" class="form-input text-sm" placeholder="800">
                    <span class="text-xs text-gray-500">px</span>
                  </div>
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 mb-1">{{ trans('admin.settings.breakpoint_lg') }}</label>
                  <div class="flex items-center gap-2">
                    <input type="number" name="bp_lg" min="100" max="3000" value="{{ settings['image.breakpoints'].lg|default(1200) }}" class="form-input text-sm" placeholder="1200">
                    <span class="text-xs text-gray-500">px</span>
                  </div>
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 mb-1">{{ trans('admin.settings.breakpoint_xl') }}</label>
                  <div class="flex items-center gap-2">
                    <input type="number" name="bp_xl" min="100" max="4000" value="{{ settings['image.breakpoints'].xl|default(1600) }}" class="form-input text-sm" placeholder="1600">
                    <span class="text-xs text-gray-500">px</span>
                  </div>
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 mb-1">{{ trans('admin.settings.breakpoint_xxl') }}</label>
                  <div class="flex items-center gap-2">
                    <input type="number" name="bp_xxl" min="100" max="5000" value="{{ settings['image.breakpoints'].xxl|default(2000) }}" class="form-input text-sm" placeholder="2000">
                    <span class="text-xs text-gray-500">px</span>
                  </div>
                </div>
              </div>
              <p class="text-xs text-gray-500 mt-3">
                <i class="fas fa-info-circle mr-1"></i>{{ trans('admin.settings.breakpoints_hint') }}
              </p>
            </div>

            <label class="flex items-start">
              <input type="checkbox" name="variants_async" class="rounded border-gray-300 text-black focus:ring-black mt-1" {% if settings['image.variants_async']|default(true) %}checked{% endif %}>
              <span class="ml-3 text-sm text-gray-700">
                <span class="font-medium">{{ trans('admin.settings.variants_async') }}</span>
                <span class="block text-xs text-gray-500 mt-1">{{ trans('admin.settings.variants_async_desc') }}</span>
              </span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Site Settings -->
    <div class="card">
      <div class="p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
          <i class="fas fa-globe mr-3 text-gray-600"></i>
          {{ trans('admin.settings.site_config') }}
        </h3>

        <!-- Logo Type Selector -->
        <div class="mb-8">
          <label class="block text-sm font-medium text-gray-700 mb-3">{{ trans('admin.settings.site_logo') }}</label>

          <!-- Logo Type Toggle -->
          <div class="flex gap-4 mb-4">
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" name="logo_type" value="text" class="text-black focus:ring-black"
                     {{ settings['site.logo_type']|default('text') == 'text' ? 'checked' : '' }}>
              <span class="text-sm text-gray-700">{{ trans('admin.settings.logo_type_text') }}</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" name="logo_type" value="image" class="text-black focus:ring-black"
                     {{ settings['site.logo_type'] == 'image' ? 'checked' : '' }}>
              <span class="text-sm text-gray-700">{{ trans('admin.settings.logo_type_image') }}</span>
            </label>
          </div>

          <!-- Image Logo Section (shown when logo_type=image) -->
          <div id="logo-image-section" class="{{ settings['site.logo_type'] == 'image' ? '' : 'hidden' }}">
            <input type="hidden" id="site_logo" name="site_logo" value="{{ settings['site.logo'] ?? '' }}">
            <div class="flex flex-col md:flex-row items-start gap-6">
              <div class="w-32 h-32 border-2 border-dashed border-gray-300 rounded-lg bg-white flex items-center justify-center overflow-hidden flex-shrink-0">
                {% if settings['site.logo'] %}
                  <img id="site-logo-preview" src="{{ base_path ~ settings['site.logo'] }}" alt="Logo" class="max-w-full max-h-full">
                  <span id="site-logo-placeholder" class="text-xs text-gray-500 hidden">{{ trans('admin.settings.no_logo') }}</span>
                {% else %}
                  <img id="site-logo-preview" src="" alt="Logo" class="max-w-full max-h-full hidden">
                  <span id="site-logo-placeholder" class="text-xs text-gray-500">{{ trans('admin.settings.no_logo') }}</span>
                {% endif %}
              </div>
              <div class="flex-1">
                <div id="logo-uppy" data-endpoint="{{ base_path }}/admin/settings/logo-upload" data-csrf="{{ csrf }}"
                     class="w-full border-2 border-dashed border-gray-300 rounded-lg p-6 text-center text-gray-600 hover:bg-gray-50 cursor-pointer transition-colors">
                  <div class="flex flex-col items-center justify-center gap-2">
                    <i class="fas fa-cloud-upload-alt text-2xl text-gray-400"></i>
                    <div class="font-medium">{{ trans('admin.settings.upload_logo') }}</div>
                    <div class="text-sm text-gray-500">{{ trans('admin.settings.logo_formats') }}</div>
                  </div>
                </div>
                <button id="site-logo-clear" type="button" class="mt-3 text-sm text-red-600 hover:underline {{ settings['site.logo'] ? '' : 'hidden' }}">
                  <i class="fas fa-trash mr-1"></i>{{ trans('admin.settings.remove_logo') }}
                </button>
              </div>
            </div>
            <p class="text-xs text-gray-500 mt-2">{{ trans('admin.settings.logo_hint') }}</p>

            <!-- Favicon Generation -->
            <div id="favicon-section" class="mt-6 p-4 bg-gray-50 border border-gray-200 rounded-lg">
              <h4 class="text-sm font-medium text-gray-900 mb-2">{{ trans('admin.settings.generate_favicons') }}</h4>
              <p class="text-xs text-gray-600 mb-3">{{ trans('admin.settings.generate_favicons_desc') }}</p>
              <button type="submit" formaction="{{ base_path }}/admin/settings/generate-favicons" formmethod="post" class="btn-secondary text-sm {{ settings['site.logo'] ? '' : 'opacity-50 cursor-not-allowed' }}" {{ settings['site.logo'] ? '' : 'disabled' }}>
                <i class="fas fa-magic mr-2"></i>{{ trans('admin.settings.generate_favicons_button') }}
              </button>
              <p class="text-xs text-gray-500 mt-2"><i class="fas fa-info-circle mr-1"></i>{{ trans('admin.settings.favicons_dont_save_note') }}</p>
              {% if not settings['site.logo'] %}
                <p class="text-xs text-amber-600 mt-2"><i class="fas fa-info-circle mr-1"></i>{{ trans('admin.settings.upload_logo_first') }}</p>
              {% endif %}
            </div>
          </div>

          <!-- Text Logo Section (shown when logo_type=text) -->
          <div id="logo-text-section" class="{{ settings['site.logo_type']|default('text') == 'text' ? '' : 'hidden' }}">
            <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg mb-6">
              <div class="flex items-start gap-3">
                <i class="fas fa-font text-blue-600 mt-0.5"></i>
                <div>
                  <p class="text-sm text-blue-800">{{ trans('admin.settings.logo_text_info') }}</p>
                  <p class="text-xs text-blue-600 mt-1">{{ trans('admin.settings.logo_text_hint') }}</p>
                </div>
              </div>
            </div>

            <!-- Favicon Source Image Upload (separate from logo) -->
            <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
              <h4 class="text-sm font-medium text-gray-900 mb-3">{{ trans('admin.settings.favicon_source') }}</h4>
              <p class="text-xs text-gray-600 mb-4">{{ trans('admin.settings.favicon_source_desc') }}</p>

              <input type="hidden" id="favicon_source" name="favicon_source" value="{{ settings['site.favicon_source'] ?? '' }}">
              <div class="flex flex-col md:flex-row items-start gap-4">
                <div class="w-24 h-24 border-2 border-dashed border-gray-300 rounded-lg bg-white flex items-center justify-center overflow-hidden flex-shrink-0">
                  {% if settings['site.favicon_source'] %}
                    <img id="favicon-source-preview" src="{{ base_path ~ settings['site.favicon_source'] }}" alt="Favicon source" class="max-w-full max-h-full">
                    <span id="favicon-source-placeholder" class="text-xs text-gray-500 hidden">{{ trans('admin.settings.no_image') }}</span>
                  {% else %}
                    <img id="favicon-source-preview" src="" alt="Favicon source" class="max-w-full max-h-full hidden">
                    <span id="favicon-source-placeholder" class="text-xs text-gray-500">{{ trans('admin.settings.no_image') }}</span>
                  {% endif %}
                </div>
                <div class="flex-1">
                  <div id="favicon-uppy" data-endpoint="{{ base_path }}/admin/settings/favicon-source-upload" data-csrf="{{ csrf }}"
                       class="w-full border-2 border-dashed border-gray-300 rounded-lg p-4 text-center text-gray-600 hover:bg-gray-50 cursor-pointer transition-colors">
                    <div class="flex flex-col items-center justify-center gap-2">
                      <i class="fas fa-cloud-upload-alt text-xl text-gray-400"></i>
                      <div class="font-medium text-sm">{{ trans('admin.settings.upload_favicon_source') }}</div>
                      <div class="text-xs text-gray-500">{{ trans('admin.settings.favicon_source_formats') }}</div>
                    </div>
                  </div>
                  <button id="favicon-source-clear" type="button" class="mt-2 text-sm text-red-600 hover:underline {{ settings['site.favicon_source'] ? '' : 'hidden' }}">
                    <i class="fas fa-trash mr-1"></i>{{ trans('admin.settings.remove_image') }}
                  </button>
                </div>
              </div>

              <!-- Generate Favicons Button -->
              <div class="mt-4 pt-4 border-t border-gray-200">
                <button type="submit" formaction="{{ base_path }}/admin/settings/generate-favicons-from-source" formmethod="post"
                        id="generate-favicons-text-btn"
                        class="btn-secondary text-sm {{ settings['site.favicon_source'] ? '' : 'opacity-50 cursor-not-allowed' }}"
                        {{ settings['site.favicon_source'] ? '' : 'disabled' }}>
                  <i class="fas fa-magic mr-2"></i>{{ trans('admin.settings.generate_favicons_button') }}
                </button>
                {% if not settings['site.favicon_source'] %}
                  <p class="text-xs text-amber-600 mt-2"><i class="fas fa-info-circle mr-1"></i>{{ trans('admin.settings.upload_favicon_source_first') }}</p>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- Other Site Settings (Grid Layout) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">{{ trans('admin.settings.site_title') }}</label>
            <input type="text" name="site_title" value="{{ settings['site.title'] ?? 'Cimaise' }}" class="form-input">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">{{ trans('admin.settings.site_description') }}</label>
            <input type="text" name="site_description" value="{{ settings['site.description'] ?? trans('admin.settings.site_description_default') }}" class="form-input">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">{{ trans('admin.settings.copyright') }}</label>
            <input type="text" name="site_copyright" value="{{ settings['site.copyright'] ?? trans('admin.settings.copyright_default') }}" class="form-input">
            <p class="text-xs text-gray-500 mt-1">{{ trans('admin.settings.copyright_hint') }}</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">{{ trans('admin.settings.contact_email') }}</label>
            <input type="email" name="site_email" value="{{ settings['site.email'] ?? '' }}" class="form-input">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">{{ trans('admin.settings.date_format') }}</label>
            <select name="date_format" class="form-input">
              <option value="Y-m-d" {{ settings['date.format']|default('Y-m-d') == 'Y-m-d' ? 'selected' }}>{{ trans('admin.settings.date_format_iso') }}</option>
              <option value="d-m-Y" {{ settings['date.format'] == 'd-m-Y' ? 'selected' }}>{{ trans('admin.settings.european') }} (DD-MM-YYYY)</option>
            </select>
            <p class="text-xs text-gray-500 mt-1">{{ trans('admin.settings.date_format_hint') }}</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">{{ trans('admin.settings.frontend_language') }}</label>
            <select name="site_language" class="form-input">
              <option value="en" {{ settings['site.language']|default('en') == 'en' ? 'selected' }}>{{ trans('admin.settings.language_en') }}</option>
              <option value="it" {{ settings['site.language'] == 'it' ? 'selected' }}>{{ trans('admin.settings.language_it') }}</option>
            </select>
            <p class="text-xs text-gray-500 mt-1">{{ trans('admin.settings.frontend_language_hint') }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Gallery Page Template -->
    <div class="card">
      <div class="p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
          <i class="fas fa-palette mr-3 text-gray-700"></i>
          {{ trans('admin.settings.gallery_page_template') }}
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <label class="flex items-start gap-3 p-4 border rounded-lg hover:border-gray-300 cursor-pointer">
            <input type="radio" name="gallery_page_template" value="classic" class="mt-1" {% if settings['gallery.page_template']|default('classic') == 'classic' %}checked{% endif %}>
            <div>
              <div class="font-medium text-gray-900">{{ trans('admin.settings.classic_grid') }}</div>
              <div class="text-sm text-gray-600">{{ trans('admin.settings.classic_grid_desc') }}</div>
            </div>
          </label>
          <label class="flex items-start gap-3 p-4 border rounded-lg hover:border-gray-300 cursor-pointer">
            <input type="radio" name="gallery_page_template" value="hero" class="mt-1" {% if settings['gallery.page_template'] == 'hero' %}checked{% endif %}>
            <div>
              <div class="font-medium text-gray-900">{{ trans('admin.settings.hero_cover') }}</div>
              <div class="text-sm text-gray-600">{{ trans('admin.settings.hero_cover_desc') }}</div>
            </div>
          </label>
          <label class="flex items-start gap-3 p-4 border rounded-lg hover:border-gray-300 cursor-pointer">
            <input type="radio" name="gallery_page_template" value="magazine" class="mt-1" {% if settings['gallery.page_template'] == 'magazine' %}checked{% endif %}>
            <div>
              <div class="font-medium text-gray-900">{{ trans('admin.settings.magazine_split') }}</div>
              <div class="text-sm text-gray-600">{{ trans('admin.settings.magazine_split_desc') }}</div>
            </div>
          </label>
        </div>
      </div>
    </div>

    <!-- Default Gallery Template -->
    <div class="card">
      <div class="p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
          <i class="fas fa-th mr-3 text-gray-600"></i>
          {{ trans('admin.settings.default_gallery_template') }}
        </h3>
        <p class="text-sm text-gray-600 mb-6">{{ trans('admin.settings.default_template_desc') }}</p>
        
        <!-- Debug Information -->
        <div class="default-template-container">
          <label class="block text-sm font-medium text-gray-700 mb-2">{{ trans('admin.settings.default_template') }}</label>
          
          
          {% set pageTpl = settings['gallery.page_template']|default('classic') %}
          {% set disableDefault = pageTpl == 'magazine' %}
          <select name="default_template_id" class="form-input {{ disableDefault ? 'bg-gray-100 cursor-not-allowed' : '' }}" {{ disableDefault ? 'disabled' : '' }}>
            <option value="">{{ trans('admin.settings.no_default_template') }}</option>
            {% for template in templates %}
              {% set isSelected = (template.id ~ '') == (settings['gallery.default_template_id'] ~ '') %}
              <option value="{{ template.id }}" {% if isSelected %}selected{% endif %}>{{ template.name }}</option>
            {% endfor %}
          </select>
          <p class="text-xs text-gray-500 mt-1">
            {{ trans('admin.settings.default_template_help') }}
            {% if disableDefault %}<br>{{ trans('admin.settings.magazine_disables_default') }}{% endif %}
          </p>
        </div>
      </div>
    </div>

    <!-- Lightbox Settings -->
    <div class="card">
      <div class="p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
          <i class="fas fa-search-plus mr-3 text-gray-600"></i>
          {{ trans('admin.settings.lightbox_settings') }}
        </h3>

        <div class="space-y-4">
          <label class="flex items-start">
            <input type="checkbox" name="show_exif_lightbox" id="show_exif_lightbox" class="rounded border-gray-300 text-black focus:ring-black mt-1" {% if settings['lightbox.show_exif'] %}checked{% endif %}>
            <span class="ml-3">
              <span class="text-sm font-medium text-gray-900 block">{{ trans('admin.settings.show_exif') }}</span>
              <span class="text-xs text-gray-600 block mt-1">{{ trans('admin.settings.show_exif_desc') }}</span>
            </span>
          </label>
        </div>
      </div>
    </div>

    <!-- Navigation Settings -->
    <div class="card">
      <div class="p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
          <i class="fas fa-bars mr-3 text-gray-600"></i>
          {{ trans('admin.settings.navigation_settings') }}
        </h3>

        <div class="space-y-4">
          <label class="flex items-start">
            <input type="checkbox" name="show_tags_in_header" id="show_tags_in_header" class="rounded border-gray-300 text-black focus:ring-black mt-1" {% if settings['navigation.show_tags_in_header'] %}checked{% endif %}>
            <span class="ml-3">
              <span class="text-sm font-medium text-gray-900 block">{{ trans('admin.settings.show_tags_in_header') }}</span>
              <span class="text-xs text-gray-600 block mt-1">{{ trans('admin.settings.show_tags_in_header_desc') }}</span>
            </span>
          </label>
        </div>
      </div>
    </div>

    <!-- NSFW Global Warning -->
    <div class="card">
      <div class="p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
          <i class="fas fa-exclamation-triangle mr-3 text-gray-600"></i>
          {{ trans('admin.privacy.nsfw_warning') }}
        </h3>
        <p class="text-sm text-gray-600 mb-4">{{ trans('admin.privacy.nsfw_warning_hint') }}</p>

        <div class="flex items-center justify-between">
          <div>
            <label class="block text-sm font-medium text-gray-700">{{ trans('admin.privacy.enable_nsfw_warning') }}</label>
            <p class="text-xs text-gray-500 mt-1">{{ trans('admin.privacy.enable_nsfw_warning_hint') }}</p>
          </div>
          <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" name="nsfw_global_warning" class="sr-only peer" {{ settings['privacy.nsfw_global_warning']|default(false) ? 'checked' : '' }}>
            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
          </label>
        </div>

        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mt-4">
          <div class="flex items-start">
            <i class="fas fa-info-circle text-blue-600 mt-0.5 mr-3"></i>
            <div class="text-sm text-blue-800">
              <strong>{{ trans('admin.privacy.nsfw_how_it_works') }}</strong> {{ trans('admin.privacy.nsfw_how_it_works_desc') }}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- reCAPTCHA Settings -->
    <div class="card">
      <div class="p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
          <i class="fas fa-shield-alt mr-3 text-gray-600"></i>
          {{ trans('admin.settings.recaptcha_title') }}
        </h3>

        <p class="text-sm text-gray-600 mb-6">{{ trans('admin.settings.recaptcha_desc') }} <a href="https://www.google.com/recaptcha/admin" target="_blank" rel="noopener" class="text-blue-600 hover:underline">google.com/recaptcha/admin</a></p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">{{ trans('admin.settings.recaptcha_site_key') }}</label>
            <input type="text" name="recaptcha_site_key" value="{{ settings['recaptcha.site_key'] ?? '' }}" class="form-input font-mono text-sm" placeholder="6Lc...">
            <p class="text-xs text-gray-500 mt-1">{{ trans('admin.settings.recaptcha_site_key_hint') }}</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">{{ trans('admin.settings.recaptcha_secret_key') }}</label>
            <input type="password" name="recaptcha_secret_key" value="" class="form-input font-mono text-sm" placeholder="{{ settings['recaptcha.secret_key'] ? '••••••••••••••••' : '6Lc...' }}" autocomplete="off">
            <p class="text-xs text-gray-500 mt-1">{{ trans('admin.settings.recaptcha_secret_key_hint') }}</p>
          </div>
        </div>

        <div class="mt-6">
          <label class="flex items-start">
            <input type="checkbox" name="recaptcha_enabled" id="recaptcha_enabled" class="rounded border-gray-300 text-black focus:ring-black mt-1" {% if settings['recaptcha.enabled'] %}checked{% endif %}>
            <span class="ml-3">
              <span class="text-sm font-medium text-gray-900 block">{{ trans('admin.settings.recaptcha_enabled') }}</span>
              <span class="text-xs text-gray-600 block mt-1">{{ trans('admin.settings.recaptcha_enabled_hint') }}</span>
            </span>
          </label>
        </div>
      </div>
    </div>

    <!-- Performance Settings -->
    <div class="card">
      <div class="p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
          <i class="fas fa-tachometer-alt mr-3 text-gray-600"></i>
          {{ trans('admin.settings.performance') }}
        </h3>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">{{ trans('admin.settings.items_per_page') }}</label>
            <input type="number" name="pagination_limit" value="{{ settings['pagination.limit'] ?? 12 }}" class="form-input" min="1" max="100">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">{{ trans('admin.settings.cache_ttl') }}</label>
            <input type="number" name="cache_ttl" value="{{ settings['cache.ttl'] ?? 24 }}" class="form-input" min="1" max="168">
          </div>

          <div>
            <label class="flex items-center pt-8">
              <input type="checkbox" name="enable_compression" class="rounded border-gray-300 text-black focus:ring-black" {% if settings['performance.compression'] %}checked{% endif %}>
              <span class="ml-3 text-sm text-gray-700">{{ trans('admin.settings.enable_compression') }}</span>
            </label>
          </div>
        </div>

        <div class="mt-6">
          <label class="flex items-start">
            <input type="checkbox" name="disable_right_click" class="rounded border-gray-300 text-black focus:ring-black mt-1" {% if settings['frontend.disable_right_click']|default(true) %}checked{% endif %}>
            <span class="ml-3">
              <span class="text-sm font-medium text-gray-900 block">{{ trans('admin.settings.disable_right_click') }}</span>
              <span class="text-xs text-gray-600 block mt-1">{{ trans('admin.settings.disable_right_click_desc') }}</span>
            </span>
          </label>
        </div>
      </div>
    </div>

    <!-- Frontend Settings -->
    <div class="card">
      <div class="p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
          <i class="fas fa-paint-brush mr-3 text-gray-600"></i>
          {{ trans('admin.settings.frontend_title') }}
        </h3>

        <!-- Dark Mode Toggle -->
        <div class="mb-6">
          <label class="flex items-start">
            <input type="checkbox" name="dark_mode" class="rounded border-gray-300 text-black focus:ring-black mt-1" {% if settings['frontend.dark_mode']|default(false) %}checked{% endif %}>
            <span class="ml-3">
              <span class="text-sm font-medium text-gray-900 block">{{ trans('admin.settings.dark_mode') }}</span>
              <span class="text-xs text-gray-600 block mt-1">{{ trans('admin.settings.dark_mode_desc') }}</span>
            </span>
          </label>
        </div>

        <!-- Custom CSS -->
        <div class="border-t border-gray-200 pt-6">
          <label class="block text-sm font-medium text-gray-900 mb-2">
            {{ trans('admin.settings.custom_css') }}
          </label>
          <p class="text-xs text-gray-600 mb-3">{{ trans('admin.settings.custom_css_desc') }}</p>

          <textarea
            name="custom_css"
            rows="12"
            class="form-input font-mono text-sm"
            placeholder="{{ trans('admin.settings.custom_css_placeholder') }}"
            maxlength="50000">{{ settings['frontend.custom_css']|default('') }}</textarea>

          <div class="mt-2 flex items-start gap-2 text-xs text-amber-600 bg-amber-50 border border-amber-200 rounded p-3">
            <i class="fas fa-exclamation-triangle mt-0.5"></i>
            <div>
              <strong>{{ trans('admin.settings.custom_css_warning') }}</strong><br>
              {{ trans('admin.settings.custom_css_warning_desc') }}
            </div>
          </div>

          <p class="text-xs text-gray-500 mt-2">
            <i class="fas fa-info-circle mr-1"></i>
            {{ trans('admin.settings.custom_css_hint') }}
          </p>
        </div>
      </div>
    </div>

    <!-- Debug / Diagnostics -->
    <div class="card">
      <div class="p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-2 flex items-center">
          <i class="fas fa-bug mr-3 text-gray-600"></i>
          {{ trans('admin.settings.debug_title') }}
        </h3>
        <p class="text-sm text-gray-600 mb-4">{{ trans('admin.settings.debug_hint') }}</p>
        <label class="flex items-center">
          <input type="checkbox" name="admin_debug_logs" class="rounded border-gray-300 text-black focus:ring-black" {% if settings['admin.debug_logs'] %}checked{% endif %}>
          <span class="ml-3 text-sm text-gray-700">{{ trans('admin.settings.debug_enable') }}</span>
        </label>
      </div>
    </div>

    <!-- Maintenance Mode (only shown when plugin is active) -->
    {% if maintenancePluginActive %}
    <div class="card">
      <div class="p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
          <i class="fas fa-tools mr-3 text-gray-600"></i>
          {{ trans('admin.maintenance.title') }}
        </h3>

        {% if settings['maintenance.enabled'] %}
        <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6">
          <div class="flex items-center">
            <i class="fas fa-exclamation-triangle text-amber-600 mr-3"></i>
            <span class="text-sm text-amber-800 font-medium">{{ trans('admin.maintenance.active_notice') }}</span>
          </div>
        </div>
        {% endif %}

        <div class="space-y-6">
          <!-- Enable Maintenance Mode Toggle -->
          <div class="flex items-center justify-between">
            <div>
              <label class="block text-sm font-medium text-gray-700">{{ trans('admin.maintenance.enabled') }}</label>
              <p class="text-xs text-gray-500 mt-1">{{ trans('admin.maintenance.enabled_hint') }}</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" name="maintenance_enabled" class="sr-only peer" {{ settings['maintenance.enabled']|default(false) ? 'checked' : '' }}>
              <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
            </label>
          </div>

          <!-- Custom Title -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">{{ trans('admin.maintenance.page_title') }}</label>
            <input type="text" name="maintenance_title" value="{{ settings['maintenance.title']|default('') }}" class="form-input" placeholder="{{ settings['site.title']|default('Site Under Construction') }}">
            <p class="text-xs text-gray-500 mt-1">{{ trans('admin.maintenance.page_title_hint') }}</p>
          </div>

          <!-- Custom Message -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">{{ trans('admin.maintenance.message') }}</label>
            <textarea name="maintenance_message" rows="3" class="form-input" placeholder="{{ trans('admin.maintenance.message_placeholder') }}">{{ settings['maintenance.message']|default('') }}</textarea>
            <p class="text-xs text-gray-500 mt-1">{{ trans('admin.maintenance.message_hint') }}</p>
          </div>

          <!-- Display Options -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <label class="flex items-start">
              <input type="checkbox" name="maintenance_show_logo" class="rounded border-gray-300 text-black focus:ring-black mt-1" {{ settings['maintenance.show_logo']|default(true) ? 'checked' : '' }}>
              <span class="ml-3">
                <span class="text-sm font-medium text-gray-900 block">{{ trans('admin.maintenance.show_logo') }}</span>
                <span class="text-xs text-gray-600 block mt-1">{{ trans('admin.maintenance.show_logo_hint') }}</span>
              </span>
            </label>

            <label class="flex items-start">
              <input type="checkbox" name="maintenance_show_countdown" class="rounded border-gray-300 text-black focus:ring-black mt-1" {{ settings['maintenance.show_countdown']|default(true) ? 'checked' : '' }}>
              <span class="ml-3">
                <span class="text-sm font-medium text-gray-900 block">{{ trans('admin.maintenance.show_animation') }}</span>
                <span class="text-xs text-gray-600 block mt-1">{{ trans('admin.maintenance.show_animation_hint') }}</span>
              </span>
            </label>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Image Generation Form -->
    <div class="card mb-6">
      <div class="p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
          <i class="fas fa-images mr-3 text-gray-600"></i>
          {{ trans('admin.settings.generate_variants') }}
        </h3>
        <p class="text-sm text-gray-600 mb-4">{{ trans('admin.settings.generate_variants_desc') }}</p>

        <div id="generate-images" class="border-t border-gray-200 pt-4">
          <button id="generate-btn" type="button" class="btn-secondary" data-endpoint="{{ base_path }}/admin/settings/generate-images">
            <i id="generate-icon" class="fas fa-images mr-2"></i>
            <span id="generate-text">{{ trans('admin.settings.generate_variants') }}</span>
          </button>
          <div id="generate-status" class="mt-2 hidden">
            <div class="text-xs text-blue-600 flex items-center">
              <i class="fas fa-spinner fa-spin mr-2"></i>
              <span>{{ trans('admin.settings.generation_in_progress') }}</span>
            </div>
          </div>
          <div id="generate-result" class="mt-2 hidden"></div>
        </div>
      </div>
    </div>

    <!-- Lensfun Database -->
    <div class="card mb-6">
      <div class="p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
          <i class="fas fa-camera-retro mr-3 text-gray-600"></i>
          {{ trans('admin.settings.lensfun_database')|default('Lensfun Database') }}
        </h3>
        <p class="text-sm text-gray-600 mb-4">{{ trans('admin.settings.lensfun_desc')|default('Camera and lens database from lensfun.github.io for EXIF autocomplete.') }}</p>

        <div id="lensfun-update" class="border-t border-gray-200 pt-4">
          <button id="lensfun-btn" type="button" class="btn-secondary">
            <i id="lensfun-icon" class="fas fa-download mr-2"></i>
            <span id="lensfun-text">{{ trans('admin.settings.update_lensfun')|default('Update Database') }}</span>
          </button>
          <div id="lensfun-status" class="mt-2 hidden">
            <div class="text-xs text-blue-600 flex items-center">
              <i class="fas fa-spinner fa-spin mr-2"></i>
              <span>{{ trans('admin.settings.downloading')|default('Downloading...') }}</span>
            </div>
          </div>
          <div id="lensfun-result" class="mt-2 hidden"></div>
          <p class="text-xs text-gray-500 mt-3">
            <i class="fas fa-info-circle mr-1"></i>
            {{ trans('admin.settings.lensfun_source')|default('Source: github.com/lensfun/lensfun') }}
          </p>
        </div>
      </div>
    </div>

    </form>
  </div>

  <!-- Sticky Footer with Action Buttons -->
  <div class="fixed bottom-0 left-0 lg:left-64 right-0 bg-white border-t border-gray-200 shadow-lg admin-sticky-actions">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <button type="submit" form="settings-form" class="btn-primary">
            <i class="fas fa-save mr-2"></i>
            {{ trans('admin.common.save') }}
          </button>
          <a href="{{ base_path }}/admin" class="btn-secondary">
            <i class="fas fa-arrow-left mr-2"></i>
            {{ trans('admin.common.dashboard') }}
          </a>
        </div>

        <div class="text-sm text-gray-500">
          <i class="fas fa-info-circle mr-1"></i>
          {{ trans('admin.settings.configure_hint') }}
        </div>
      </div>
    </div>
  </div>

<script nonce="{{ csp_nonce() }}">
// Image generation form handler - attached via addEventListener for CSP compliance
document.addEventListener('DOMContentLoaded', function() {
  const btn = document.getElementById('generate-btn');
  if (btn) {
    btn.addEventListener('click', function() {

      const confirmMessage = '{{ trans('admin.settings.confirm_generate')|e('js') }}';
      if (!confirm(confirmMessage)) {
        return;
      }

      // Show loading state
      const btn = document.getElementById('generate-btn');
      const icon = document.getElementById('generate-icon');
      const text = document.getElementById('generate-text');
      const status = document.getElementById('generate-status');
      const result = document.getElementById('generate-result');

      btn.disabled = true;
      icon.className = 'fas fa-spinner fa-spin mr-2';
      text.textContent = '{{ trans('admin.settings.generating')|e('js') }}';
      status.classList.remove('hidden');
      result.classList.add('hidden');

      // Submit request via fetch (no nested form; reuse CSRF from settings-form)
      const csrf = document.querySelector('#settings-form input[name=\"csrf\"]')?.value || '';
      const endpoint = btn.getAttribute('data-endpoint') || '{{ base_path }}/admin/settings/generate-images';
      const formData = new FormData();
      formData.append('csrf', csrf);

      fetch(endpoint, {
        method: 'POST',
        headers: {
          'Accept': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        // Reset button state
        btn.disabled = false;
        icon.className = 'fas fa-images mr-2';
        text.textContent = '{{ trans('admin.settings.generate_variants')|e('js') }}';
        status.classList.add('hidden');

        // Validate backend response
        if (data.error || data.success === false) {
          throw new Error(data.message || data.error || '{{ trans('admin.settings.generation_failed')|e('js') }}');
        }

        const message = data.message || '{{ trans('admin.settings.generate_started')|e('js') }}';
        result.innerHTML = '<div class="text-xs text-blue-600 flex items-center"><i class="fas fa-info-circle mr-2"></i><span></span></div>';
        const msgSpan = result.querySelector('span');
        if (msgSpan) msgSpan.textContent = message;
        result.classList.remove('hidden');

        // Hide result after 10 seconds
        setTimeout(() => {
          result.classList.add('hidden');
        }, 10000);
      })
      .catch(error => {
        // Reset button state
        btn.disabled = false;
        icon.className = 'fas fa-images mr-2';
        text.textContent = '{{ trans('admin.settings.generate_variants')|e('js') }}';
        status.classList.add('hidden');

        // Show error result
        result.innerHTML = `<div class="text-xs text-red-600 flex items-center"><i class="fas fa-exclamation-circle mr-2"></i><span></span></div>`;
        const errSpan = result.querySelector('span');
        if (errSpan) errSpan.textContent = `{{ trans('admin.settings.generate_error')|e('js') }}: ${error.message}`;
        result.classList.remove('hidden');
      });
    });
  }

  // Lensfun database update handler
  const lensfunBtn = document.getElementById('lensfun-btn');
  if (lensfunBtn) {
    lensfunBtn.addEventListener('click', function() {
      const icon = document.getElementById('lensfun-icon');
      const text = document.getElementById('lensfun-text');
      const status = document.getElementById('lensfun-status');
      const result = document.getElementById('lensfun-result');

      // Show loading state
      lensfunBtn.disabled = true;
      icon.className = 'fas fa-spinner fa-spin mr-2';
      text.textContent = '{{ trans('admin.settings.updating_lensfun')|default('Updating...')|e('js') }}';
      status.classList.remove('hidden');
      result.classList.add('hidden');

      // Submit request via fetch
      const csrf = document.querySelector('#settings-form input[name="csrf"]')?.value || '';
      const formData = new FormData();
      formData.append('csrf', csrf);

      fetch('{{ base_path }}/admin/settings/update-lensfun', {
        method: 'POST',
        headers: {
          'Accept': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        // Reset button state
        lensfunBtn.disabled = false;
        icon.className = 'fas fa-download mr-2';
        text.textContent = '{{ trans('admin.settings.update_lensfun')|default('Update Database')|e('js') }}';
        status.classList.add('hidden');

        if (data.error || data.success === false) {
          throw new Error(data.message || data.error || 'Update failed');
        }

        // Show success result
        const cameras = data.cameras || 0;
        const lenses = data.lenses || 0;
        const files = data.files || 0;
        const message = `{{ trans('admin.settings.lensfun_updated')|default('Database updated:')|e('js') }} ${cameras} {{ trans('admin.settings.cameras')|default('cameras')|e('js') }}, ${lenses} {{ trans('admin.settings.lenses')|default('lenses')|e('js') }} (${files} {{ trans('admin.settings.files')|default('files')|e('js') }})`;

        result.innerHTML = '<div class="text-xs text-green-600 flex items-center"><i class="fas fa-check-circle mr-2"></i><span></span></div>';
        const msgSpan = result.querySelector('span');
        if (msgSpan) msgSpan.textContent = message;
        result.classList.remove('hidden');

        // Hide result after 15 seconds
        setTimeout(() => {
          result.classList.add('hidden');
        }, 15000);
      })
      .catch(error => {
        // Reset button state
        lensfunBtn.disabled = false;
        icon.className = 'fas fa-download mr-2';
        text.textContent = '{{ trans('admin.settings.update_lensfun')|default('Update Database')|e('js') }}';
        status.classList.add('hidden');

        // Show error result
        result.innerHTML = '<div class="text-xs text-red-600 flex items-center"><i class="fas fa-exclamation-circle mr-2"></i><span></span></div>';
        const errSpan = result.querySelector('span');
        if (errSpan) errSpan.textContent = `{{ trans('admin.settings.lensfun_error')|default('Update failed')|e('js') }}: ${error.message}`;
        result.classList.remove('hidden');
      });
    });
  }
});

// Handle page template changes for default template selector
document.addEventListener('DOMContentLoaded', function() {
  // Handle page template changes for default template selector
  const pageTemplateRadios = document.querySelectorAll('input[name="gallery_page_template"]');
  const defaultTemplateSelect = document.querySelector('select[name="default_template_id"]');
  
  if (pageTemplateRadios.length > 0 && defaultTemplateSelect) {
    // Add event listeners to all page template radios
    pageTemplateRadios.forEach(radio => {
      radio.addEventListener('change', function() {
        updateDefaultTemplateSelector(this.value);
      });
    });
    
    // Set initial state based on currently selected radio
    const selectedRadio = document.querySelector('input[name="gallery_page_template"]:checked');
    if (selectedRadio) {
      updateDefaultTemplateSelector(selectedRadio.value);
    }
  }
});

function updateDefaultTemplateSelector(selectedValue) {
  const defaultTemplateSelect = document.querySelector('select[name="default_template_id"]');
  const defaultTemplateContainer = defaultTemplateSelect?.closest('.default-template-container');
  
  if (defaultTemplateSelect && defaultTemplateContainer) {
    if (selectedValue === 'magazine') {
      // Disable the selector
      defaultTemplateSelect.disabled = true;
      defaultTemplateSelect.classList.add('bg-gray-100', 'cursor-not-allowed');
      defaultTemplateContainer.classList.add('opacity-75');
      
      // Show disabled message
      let msg = defaultTemplateContainer.querySelector('.template-disabled-message');
      if (!msg) {
        msg = document.createElement('div');
        msg.className = 'template-disabled-message text-xs text-gray-500 mt-2 p-3 bg-gray-50 rounded border border-gray-200';
        const icon = document.createElement('i');
        icon.className = 'fas fa-info-circle mr-1';
        msg.appendChild(icon);
        msg.appendChild(document.createTextNode('{{ trans('admin.settings.magazine_disables_default')|e('js') }}'));
        defaultTemplateContainer.appendChild(msg);
      }
      msg.style.display = 'block';
    } else {
      // Enable the selector
      defaultTemplateSelect.disabled = false;
      defaultTemplateSelect.classList.remove('bg-gray-100', 'cursor-not-allowed');
      defaultTemplateContainer.classList.remove('opacity-75');
      
      // Hide disabled message
      const msg = defaultTemplateContainer.querySelector('.template-disabled-message');
      if (msg) {
        msg.style.display = 'none';
      }
    }
  }
}

// Logo type toggle handler
document.addEventListener('DOMContentLoaded', function() {
  const logoTypeRadios = document.querySelectorAll('input[name="logo_type"]');
  const imageSection = document.getElementById('logo-image-section');
  const textSection = document.getElementById('logo-text-section');

  if (logoTypeRadios.length > 0 && imageSection && textSection) {
    logoTypeRadios.forEach(radio => {
      radio.addEventListener('change', function() {
        if (this.value === 'image') {
          imageSection.classList.remove('hidden');
          textSection.classList.add('hidden');
        } else {
          imageSection.classList.add('hidden');
          textSection.classList.remove('hidden');
        }
      });
    });
  }
});
</script>
{% endblock %}
