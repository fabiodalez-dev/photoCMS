{% extends 'admin/_layout.twig' %}
{% block title %}Settings — photoCMS{% endblock %}
{% block content %}
  <div class="flex items-center justify-between mb-8">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">Settings</h1>
      <p class="text-gray-600 mt-1">Configure your photoCMS installation</p>
    </div>
  </div>

  <form method="post" action="/admin/settings" class="space-y-8">
    <input type="hidden" name="csrf" value="{{ csrf }}">
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Image Formats -->
      <div class="card">
        <div class="p-6">
          <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
            <i class="fas fa-image mr-3 text-gray-600"></i>
            Image Formats
          </h3>
          
          <div class="space-y-4 mb-6">
            <label class="flex items-center">
              <input type="checkbox" name="fmt_avif" id="fmt_avif" class="rounded border-gray-300 text-black focus:ring-black" {% if settings['image.formats'].avif %}checked{% endif %}>
              <span class="ml-3 text-sm text-gray-700">
                <strong>AVIF</strong> - Modern format with excellent compression
              </span>
            </label>
            
            <label class="flex items-center">
              <input type="checkbox" name="fmt_webp" id="fmt_webp" class="rounded border-gray-300 text-black focus:ring-black" {% if settings['image.formats'].webp %}checked{% endif %}>
              <span class="ml-3 text-sm text-gray-700">
                <strong>WebP</strong> - Good compression with wide support
              </span>
            </label>
            
            <label class="flex items-center">
              <input type="checkbox" name="fmt_jpg" id="fmt_jpg" class="rounded border-gray-300 text-black focus:ring-black" {% if settings['image.formats'].jpg %}checked{% endif %}>
              <span class="ml-3 text-sm text-gray-700">
                <strong>JPEG</strong> - Universal compatibility
              </span>
            </label>
          </div>

          <div class="grid grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">AVIF Quality</label>
              <input type="number" name="q_avif" min="1" max="100" value="{{ settings['image.quality'].avif }}" class="form-input">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">WebP Quality</label>
              <input type="number" name="q_webp" min="1" max="100" value="{{ settings['image.quality'].webp }}" class="form-input">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">JPEG Quality</label>
              <input type="number" name="q_jpg" min="1" max="100" value="{{ settings['image.quality'].jpg }}" class="form-input">
            </div>
          </div>
        </div>
      </div>

      <!-- Breakpoints & Preview -->
      <div class="card">
        <div class="p-6">
          <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
            <i class="fas fa-desktop mr-3 text-gray-600"></i>
            Breakpoints & Preview
          </h3>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Preview Width (px)</label>
              <input type="number" name="preview_w" value="{{ settings['image.preview'].width }}" class="form-input">
              <p class="text-xs text-gray-500 mt-1">Width for image previews in admin</p>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Responsive Breakpoints</label>
              <textarea name="breakpoints" rows="6" class="form-input font-mono text-sm">{{ settings['image.breakpoints']|json_encode(constant('JSON_PRETTY_PRINT')) }}</textarea>
              <p class="text-xs text-gray-500 mt-1">JSON format: {"sm":768,"md":1200,"lg":1920,"xl":2560,"xxl":3840}</p>
              
              <!-- Generate Images Button -->
              <div class="mt-4 pt-4 border-t border-gray-200">
                <form id="generate-images-form" method="post" action="/admin/settings/generate-images" onsubmit="return handleImageGeneration(event);">
                  <input type="hidden" name="csrf" value="{{ csrf }}">
                  <button id="generate-btn" type="submit" class="btn-secondary">
                    <i id="generate-icon" class="fas fa-images mr-2"></i>
                    <span id="generate-text">Genera Varianti Immagini</span>
                  </button>
                  <div id="generate-status" class="mt-2 hidden">
                    <div class="text-xs text-blue-600 flex items-center">
                      <i class="fas fa-spinner fa-spin mr-2"></i>
                      <span>Generazione in corso... Questa operazione potrebbe richiedere alcuni minuti.</span>
                    </div>
                  </div>
                  <div id="generate-result" class="mt-2 hidden"></div>
                  <p class="text-xs text-gray-500 mt-2">Genera automaticamente le varianti ad alta risoluzione (sm, md, lg, xl, xxl) per tutte le immagini mancanti</p>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Site Settings -->
    <div class="card">
      <div class="p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
          <i class="fas fa-globe mr-3 text-gray-600"></i>
          Site Configuration
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Site Title</label>
            <input type="text" name="site_title" value="{{ settings['site.title'] ?? 'photoCMS' }}" class="form-input">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Site Description</label>
            <input type="text" name="site_description" value="{{ settings['site.description'] ?? 'Professional Photography Portfolio' }}" class="form-input">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Copyright Notice</label>
            <input type="text" name="site_copyright" value="{{ settings['site.copyright'] ?? '© 2024 Photography Portfolio' }}" class="form-input">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Contact Email</label>
            <input type="email" name="site_email" value="{{ settings['site.email'] ?? '' }}" class="form-input">
          </div>
        </div>
      </div>
    </div>

    <!-- Default Gallery Template -->
    <div class="card">
      <div class="p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
          <i class="fas fa-th mr-3 text-gray-600"></i>
          Template Predefinito Gallery
        </h3>
        <p class="text-sm text-gray-600 mb-6">Impostazioni utilizzate quando un album non ha un template specifico assegnato</p>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Template Predefinito</label>
          <select name="default_template_id" class="form-input">
            <option value="">Nessun template predefinito</option>
            {% for template in templates %}
              <option value="{{ template.id }}" {% if template.id == settings['gallery.default_template_id'] %}selected{% endif %}>{{ template.name }}</option>
            {% endfor %}
          </select>
          <p class="text-xs text-gray-500 mt-1">Template utilizzato quando un album non ha un template specifico assegnato</p>
        </div>
      </div>
    </div>

    <!-- Performance Settings -->
    <div class="card">
      <div class="p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
          <i class="fas fa-tachometer-alt mr-3 text-gray-600"></i>
          Performance
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Items per Page</label>
            <input type="number" name="pagination_limit" value="{{ settings['pagination.limit'] ?? 12 }}" class="form-input" min="1" max="100">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Cache TTL (hours)</label>
            <input type="number" name="cache_ttl" value="{{ settings['cache.ttl'] ?? 24 }}" class="form-input" min="1" max="168">
          </div>
          
          <div>
            <label class="flex items-center pt-8">
              <input type="checkbox" name="enable_compression" class="rounded border-gray-300 text-black focus:ring-black" {% if settings['performance.compression'] %}checked{% endif %}>
              <span class="ml-3 text-sm text-gray-700">Enable Gzip Compression</span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Hidden fields for all expected form data -->
    <input type="hidden" name="fmt_avif" value="{{ settings['image.formats'].avif ? '1' : '0' }}">
    <input type="hidden" name="fmt_webp" value="{{ settings['image.formats'].webp ? '1' : '0' }}">  
    <input type="hidden" name="fmt_jpg" value="{{ settings['image.formats'].jpg ? '1' : '0' }}">
    <input type="hidden" name="q_avif" value="{{ settings['image.quality'].avif|default(50) }}">
    <input type="hidden" name="q_webp" value="{{ settings['image.quality'].webp|default(75) }}">
    <input type="hidden" name="q_jpg" value="{{ settings['image.quality'].jpg|default(85) }}">
    <input type="hidden" name="preview_w" value="{{ settings['image.preview'].width|default(480) }}">
    <input type="hidden" name="breakpoints" value="{{ settings['image.breakpoints']|json_encode }}">
    <input type="hidden" name="pagination_limit" value="{{ settings['pagination.limit']|default(12) }}">
    <input type="hidden" name="cache_ttl" value="{{ settings['cache.ttl']|default(24) }}">

    <!-- Save Button -->
    <div class="flex justify-end">
      <button type="submit" class="btn-primary">
        <i class="fas fa-save mr-2"></i>
        Save Settings
      </button>
    </div>
  </form>

<script>
function handleImageGeneration(event) {
  event.preventDefault();
  
  if (!confirm('Generare le varianti delle immagini? Questa operazione potrebbe richiedere alcuni minuti.')) {
    return false;
  }
  
  // Show loading state
  const btn = document.getElementById('generate-btn');
  const icon = document.getElementById('generate-icon');
  const text = document.getElementById('generate-text');
  const status = document.getElementById('generate-status');
  const result = document.getElementById('generate-result');
  
  btn.disabled = true;
  icon.className = 'fas fa-spinner fa-spin mr-2';
  text.textContent = 'Generando...';
  status.classList.remove('hidden');
  result.classList.add('hidden');
  
  // Submit form via fetch
  const form = document.getElementById('generate-images-form');
  const formData = new FormData(form);
  
  fetch(form.action, {
    method: 'POST',
    body: formData
  })
  .then(response => response.text())
  .then(data => {
    // Reset button state
    btn.disabled = false;
    icon.className = 'fas fa-images mr-2';
    text.textContent = 'Genera Varianti Immagini';
    status.classList.add('hidden');
    
    // Show success result
    result.innerHTML = '<div class="text-xs text-green-600 flex items-center"><i class="fas fa-check-circle mr-2"></i><span>Varianti generate con successo!</span></div>';
    result.classList.remove('hidden');
    
    // Hide result after 5 seconds
    setTimeout(() => {
      result.classList.add('hidden');
    }, 5000);
  })
  .catch(error => {
    // Reset button state
    btn.disabled = false;
    icon.className = 'fas fa-images mr-2';
    text.textContent = 'Genera Varianti Immagini';
    status.classList.add('hidden');
    
    // Show error result
    result.innerHTML = '<div class="text-xs text-red-600 flex items-center"><i class="fas fa-exclamation-circle mr-2"></i><span>Errore durante la generazione delle varianti</span></div>';
    result.classList.remove('hidden');
  });
  
  return false;
}
</script>
{% endblock %}