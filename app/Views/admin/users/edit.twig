{% extends 'admin/_layout.twig' %}
{% block title %}Modifica Utente — photoCMS{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-6">
  <div>
    <h1 class="text-2xl font-bold text-gray-900">Modifica Utente</h1>
    <p class="text-gray-600 mt-1">{{ user.first_name }} {{ user.last_name }}</p>
  </div>
</div>

<div class="card p-6">
  <form method="post" action="{{ base_path }}/admin/users/{{ user.id }}" class="space-y-6">
    <input type="hidden" name="csrf" value="{{ csrf }}">
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Nome *</label>
        <input class="form-input w-full border border-gray-300 rounded-lg" type="text" name="first_name" value="{{ user.first_name }}" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Cognome *</label>
        <input class="form-input w-full border border-gray-300 rounded-lg" type="text" name="last_name" value="{{ user.last_name }}" required>
      </div>
    </div>
    
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
      <input class="form-input w-full border border-gray-300 rounded-lg" type="email" name="email" value="{{ user.email }}" required>
    </div>
    
    <div class="border border-gray-200 rounded-lg p-4">
      <h3 class="text-lg font-medium text-gray-900 mb-3">Cambia Password</h3>
      <p class="text-sm text-gray-600 mb-3">Lascia vuoto per mantenere la password attuale</p>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Nuova Password</label>
          <input class="form-input w-full border border-gray-300 rounded-lg" type="password" name="password" minlength="8">
          <small class="text-gray-500">Minimo 8 caratteri</small>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Conferma Password</label>
          <input class="form-input w-full border border-gray-300 rounded-lg" type="password" name="confirm_password" minlength="8">
        </div>
      </div>
    </div>
    
    <div class="border border-gray-200 rounded-lg p-4">
      <h3 class="text-lg font-medium text-gray-900 mb-3">Autorizzazioni</h3>
      <div class="space-y-3">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Ruolo</label>
          <select class="form-input w-full border border-gray-300 rounded-lg" name="role">
            <option value="user" {{ user.role == 'user' ? 'selected' : '' }}>Utente - Può scaricare immagini dal frontend</option>
            <option value="admin" {{ user.role == 'admin' ? 'selected' : '' }}>Amministratore - Accesso completo al backend</option>
          </select>
        </div>
        <div class="flex items-center">
          <input type="checkbox" id="is_active" name="is_active" value="1" {{ user.is_active ? 'checked' : '' }} class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
          <label for="is_active" class="ml-2 text-sm text-gray-700">Account attivo</label>
        </div>
      </div>
    </div>
    
    <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
      <h4 class="text-sm font-medium text-gray-900 mb-2">Informazioni Account</h4>
      <div class="text-sm text-gray-600 space-y-1">
        <p><strong>Registrato:</strong> {{ user.created_at|datetime_format }}</p>
        {% if user.updated_at %}
        <p><strong>Ultimo aggiornamento:</strong> {{ user.updated_at|datetime_format }}</p>
        {% endif %}
        {% if user.last_login %}
        <p><strong>Ultimo accesso:</strong> {{ user.last_login|datetime_format }}</p>
        {% else %}
        <p><strong>Ultimo accesso:</strong> Mai</p>
        {% endif %}
      </div>
    </div>
    
    <div class="flex gap-3 pt-4 border-t">
      <button class="btn-primary" type="submit">Aggiorna Utente</button>
      <a class="btn-secondary" href="{{ base_path }}/admin/users">Annulla</a>
      {% if user.id != session.admin_id %}
      <form method="post" action="{{ base_path }}/admin/users/{{ user.id }}/delete" class="inline ml-auto" 
            onsubmit="return confirm('Eliminare questo utente? Questa azione non può essere annullata.');">
        <input type="hidden" name="csrf" value="{{ csrf }}">
        <button class="btn-secondary text-red-700" type="submit">Elimina Utente</button>
      </form>
      {% endif %}
    </div>
  </form>
</div>

<script>
// Password confirmation validation
document.addEventListener('DOMContentLoaded', function() {
  const password = document.querySelector('input[name="password"]');
  const confirmPassword = document.querySelector('input[name="confirm_password"]');
  
  function validatePasswords() {
    if (password.value && password.value !== confirmPassword.value) {
      confirmPassword.setCustomValidity('Le password non coincidono');
    } else {
      confirmPassword.setCustomValidity('');
    }
  }
  
  password.addEventListener('input', validatePasswords);
  confirmPassword.addEventListener('input', validatePasswords);
});
</script>
{% endblock %}