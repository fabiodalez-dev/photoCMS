{% extends 'admin/_layout.twig' %}
{% block title %}{{ trans('admin.users.edit_user') }} â€” Cimaise{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-6">
  <div>
    <h1 class="text-2xl font-bold text-gray-900">{{ trans('admin.users.edit_user') }}</h1>
    <p class="text-gray-600 mt-1">{{ user.first_name }} {{ user.last_name }}</p>
  </div>
</div>

<div class="card p-6">
  <form method="post" action="{{ base_path }}/admin/users/{{ user.id }}" class="space-y-6">
    <input type="hidden" name="csrf" value="{{ csrf }}">

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">{{ trans('admin.users.first_name') }} *</label>
        <input class="form-input w-full border border-gray-300 rounded-lg" type="text" name="first_name" value="{{ user.first_name }}" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">{{ trans('admin.users.last_name') }} *</label>
        <input class="form-input w-full border border-gray-300 rounded-lg" type="text" name="last_name" value="{{ user.last_name }}" required>
      </div>
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">{{ trans('admin.users.email') }} *</label>
      <input class="form-input w-full border border-gray-300 rounded-lg" type="email" name="email" value="{{ user.email }}" required>
    </div>

    <div class="border border-gray-200 rounded-lg p-4">
      <h3 class="text-lg font-medium text-gray-900 mb-3">{{ trans('admin.users.change_password') }}</h3>
      <p class="text-sm text-gray-600 mb-3">{{ trans('admin.users.change_password_hint') }}</p>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">{{ trans('admin.users.new_password') }}</label>
          <input class="form-input w-full border border-gray-300 rounded-lg" type="password" name="password" minlength="8">
          <small class="text-gray-500">{{ trans('admin.users.password_hint') }}</small>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">{{ trans('admin.users.confirm_password') }}</label>
          <input class="form-input w-full border border-gray-300 rounded-lg" type="password" name="confirm_password" minlength="8">
        </div>
      </div>
    </div>

    <div class="border border-gray-200 rounded-lg p-4">
      <h3 class="text-lg font-medium text-gray-900 mb-3">{{ trans('admin.users.permissions') }}</h3>
      <div class="space-y-3">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">{{ trans('admin.users.role') }}</label>
          <select class="form-input w-full border border-gray-300 rounded-lg" name="role">
            <option value="user" {{ user.role == 'user' ? 'selected' : '' }}>{{ trans('admin.users.role_user_desc') }}</option>
            <option value="admin" {{ user.role == 'admin' ? 'selected' : '' }}>{{ trans('admin.users.role_admin_desc') }}</option>
          </select>
        </div>
        <div class="flex items-center">
          <input type="checkbox" id="is_active" name="is_active" value="1" {{ user.is_active ? 'checked' : '' }} class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
          <label for="is_active" class="ml-2 text-sm text-gray-700">{{ trans('admin.users.account_active') }}</label>
        </div>
      </div>
    </div>

    <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
      <h4 class="text-sm font-medium text-gray-900 mb-2">{{ trans('admin.users.account_info') }}</h4>
      <div class="text-sm text-gray-600 space-y-1">
        <p><strong>{{ trans('admin.users.registered_at') }}</strong> {{ user.created_at|datetime_format }}</p>
        {% if user.updated_at %}
        <p><strong>{{ trans('admin.users.last_updated') }}</strong> {{ user.updated_at|datetime_format }}</p>
        {% endif %}
        {% if user.last_login %}
        <p><strong>{{ trans('admin.users.last_login') }}</strong> {{ user.last_login|datetime_format }}</p>
        {% else %}
        <p><strong>{{ trans('admin.users.last_login') }}</strong> {{ trans('admin.users.never') }}</p>
        {% endif %}
      </div>
    </div>

    <div class="flex gap-3 pt-4 border-t">
      <button class="btn-primary" type="submit">{{ trans('admin.users.update_user') }}</button>
      <a class="btn-secondary" href="{{ base_path }}/admin/users">{{ trans('admin.users.cancel') }}</a>
      {% if user.id != session.admin_id %}
      <form method="post" action="{{ base_path }}/admin/users/{{ user.id }}/delete" class="inline ml-auto"
            data-confirm="{{ trans('admin.users.delete_confirm')|e('js') }}">
        <input type="hidden" name="csrf" value="{{ csrf }}">
        <button class="btn-secondary text-red-700" type="submit">{{ trans('admin.users.delete_user') }}</button>
      </form>
      {% endif %}
    </div>
  </form>
</div>

<script nonce="{{ csp_nonce() }}">
// Password confirmation validation
document.addEventListener('DOMContentLoaded', function() {
  const password = document.querySelector('input[name="password"]');
  const confirmPassword = document.querySelector('input[name="confirm_password"]');

  function validatePasswords() {
    if (password.value && password.value !== confirmPassword.value) {
      confirmPassword.setCustomValidity('{{ trans('admin.users.passwords_no_match') }}');
    } else {
      confirmPassword.setCustomValidity('');
    }
  }

  password.addEventListener('input', validatePasswords);
  confirmPassword.addEventListener('input', validatePasswords);
});
</script>
{% endblock %}
