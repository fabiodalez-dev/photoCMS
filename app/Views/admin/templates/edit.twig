{% extends 'admin/_layout.twig' %}
{% block title %}Modifica Template — photoCMS{% endblock %}
{% block content %}
  <div class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">Modifica Template</h1>
      <p class="text-gray-600 mt-1">Modifica il template "{{ item.name }}"</p>
    </div>
    <a href="/admin/templates" class="btn-secondary">
      <i class="fas fa-arrow-left mr-2"></i>Torna alla lista
    </a>
  </div>

  <form method="post" action="/admin/templates/{{ item.id }}" class="space-y-6">
    <input type="hidden" name="csrf" value="{{ csrf }}">
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="lg:col-span-2 space-y-6">
        <div class="card p-6">
          <h2 class="text-lg font-medium text-gray-900 mb-4">Informazioni Generali</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Nome *</label>
              <input class="form-input" type="text" name="name" value="{{ item.name }}" required>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Slug</label>
              <input class="form-input" type="text" name="slug" value="{{ item.slug }}" placeholder="(auto se vuoto)">
            </div>
          </div>
          <div class="mt-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Descrizione</label>
            <textarea class="form-input" name="description" rows="3" placeholder="Descrizione del template...">{{ item.description }}</textarea>
          </div>
        </div>

        <div class="card p-6">
          <h2 class="text-lg font-medium text-gray-900 mb-4">Impostazioni Layout</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Tipo Layout</label>
              <select class="form-input" name="layout">
                <option value="grid"{% if item.settings.layout == 'grid' %} selected{% endif %}>Griglia</option>
                <option value="masonry"{% if item.settings.layout == 'masonry' %} selected{% endif %}>Masonry</option>
                <option value="slideshow"{% if item.settings.layout == 'slideshow' %} selected{% endif %}>Slideshow</option>
                <option value="fullscreen"{% if item.settings.layout == 'fullscreen' %} selected{% endif %}>Fullscreen</option>
              </select>
            </div>
            <div>
              <label class="flex items-center">
                <input type="checkbox" name="masonry" class="form-checkbox"{% if item.settings.masonry %} checked{% endif %}>
                <span class="ml-2 text-sm text-gray-700">Abilita layout Masonry</span>
              </label>
            </div>
          </div>
          
          <div class="border-t pt-4">
            <h3 class="text-md font-medium text-gray-800 mb-3">Colonne per Dispositivo</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              {% set cols = item.settings.columns is defined ? item.settings.columns : {'desktop': 3, 'tablet': 2, 'mobile': 1} %}
              {# Handle potentially nested columns structure #}
              {% set desktop_cols = cols.desktop is iterable and cols.desktop.desktop is defined ? cols.desktop.desktop : cols.desktop %}
              {% set tablet_cols = cols.tablet is iterable and cols.tablet.tablet is defined ? cols.tablet.tablet : cols.tablet %}
              {% set mobile_cols = cols.mobile is iterable and cols.mobile.mobile is defined ? cols.mobile.mobile : cols.mobile %}
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  <i class="fas fa-desktop text-gray-500 mr-1"></i>Desktop
                </label>
                <select class="form-input" name="columns_desktop">
                  <option value="1"{% if desktop_cols == 1 %} selected{% endif %}>1 colonna</option>
                  <option value="2"{% if desktop_cols == 2 %} selected{% endif %}>2 colonne</option>
                  <option value="3"{% if desktop_cols == 3 %} selected{% endif %}>3 colonne</option>
                  <option value="4"{% if desktop_cols == 4 %} selected{% endif %}>4 colonne</option>
                  <option value="5"{% if desktop_cols == 5 %} selected{% endif %}>5 colonne</option>
                  <option value="6"{% if desktop_cols == 6 %} selected{% endif %}>6 colonne</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  <i class="fas fa-tablet-alt text-gray-500 mr-1"></i>Tablet
                </label>
                <select class="form-input" name="columns_tablet">
                  <option value="1"{% if tablet_cols == 1 %} selected{% endif %}>1 colonna</option>
                  <option value="2"{% if tablet_cols == 2 %} selected{% endif %}>2 colonne</option>
                  <option value="3"{% if tablet_cols == 3 %} selected{% endif %}>3 colonne</option>
                  <option value="4"{% if tablet_cols == 4 %} selected{% endif %}>4 colonne</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  <i class="fas fa-mobile-alt text-gray-500 mr-1"></i>Mobile
                </label>
                <select class="form-input" name="columns_mobile">
                  <option value="1"{% if mobile_cols == 1 %} selected{% endif %}>1 colonna</option>
                  <option value="2"{% if mobile_cols == 2 %} selected{% endif %}>2 colonne</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <div class="card p-6">
          <h2 class="text-lg font-medium text-gray-900 mb-4">Impostazioni PhotoSwipe</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="space-y-3">
              <label class="flex items-center">
                <input type="checkbox" name="photoswipe_loop" class="form-checkbox"{% if item.settings.photoswipe.loop is defined and item.settings.photoswipe.loop %} checked{% elseif item.settings.photoswipe.loop is not defined %} checked{% endif %}>
                <span class="ml-2 text-sm text-gray-700">Loop infinito</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" name="photoswipe_zoom" class="form-checkbox"{% if item.settings.photoswipe.zoom is defined and item.settings.photoswipe.zoom %} checked{% elseif item.settings.photoswipe.zoom is not defined %} checked{% endif %}>
                <span class="ml-2 text-sm text-gray-700">Abilita zoom</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" name="photoswipe_share" class="form-checkbox"{% if item.settings.photoswipe.share %} checked{% endif %}>
                <span class="ml-2 text-sm text-gray-700">Pulsante condivisione</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" name="photoswipe_counter" class="form-checkbox"{% if item.settings.photoswipe.counter is defined and item.settings.photoswipe.counter %} checked{% elseif item.settings.photoswipe.counter is not defined %} checked{% endif %}>
                <span class="ml-2 text-sm text-gray-700">Contatore immagini</span>
              </label>
            </div>
            <div class="space-y-3">
              <label class="flex items-center">
                <input type="checkbox" name="photoswipe_arrowkeys" class="form-checkbox"{% if item.settings.photoswipe.arrowKeys is defined and item.settings.photoswipe.arrowKeys %} checked{% elseif item.settings.photoswipe.arrowKeys is not defined %} checked{% endif %}>
                <span class="ml-2 text-sm text-gray-700">Navigazione con frecce</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" name="photoswipe_esckey" class="form-checkbox"{% if item.settings.photoswipe.escKey is defined and item.settings.photoswipe.escKey %} checked{% elseif item.settings.photoswipe.escKey is not defined %} checked{% endif %}>
                <span class="ml-2 text-sm text-gray-700">Chiusura con ESC</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" name="photoswipe_pan_to_next" class="form-checkbox"{% if item.settings.photoswipe.allowPanToNext %} checked{% endif %}>
                <span class="ml-2 text-sm text-gray-700">Pan per immagine successiva</span>
              </label>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Opacità sfondo</label>
              <input class="form-input" type="number" name="photoswipe_bg_opacity" min="0" max="1" step="0.1" value="{{ item.settings.photoswipe.bgOpacity|default(0.8) }}">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Spaziatura immagini</label>
              <input class="form-input" type="number" name="photoswipe_spacing" min="0" max="1" step="0.01" value="{{ item.settings.photoswipe.spacing|default(0.12) }}">
            </div>
          </div>
        </div>
      </div>

      <div class="space-y-6">
        <div class="card p-6">
          <h2 class="text-lg font-medium text-gray-900 mb-4">Anteprima</h2>
          <div class="text-sm text-gray-600 space-y-2">
            <p><strong>Layout:</strong> <span id="preview-layout">{{ item.settings.layout|default('grid')|title }}</span></p>
            <p><strong>Masonry:</strong> <span id="preview-masonry">{% if item.settings.masonry %}Sì{% else %}No{% endif %}</span></p>
            <div class="mt-3">
              <p class="font-medium">Colonne:</p>
              <ul class="ml-4 space-y-1">
                <li><i class="fas fa-desktop text-gray-400 mr-1"></i>Desktop: <span id="preview-desktop">{{ desktop_cols|default(3) }}</span></li>
                <li><i class="fas fa-tablet-alt text-gray-400 mr-1"></i>Tablet: <span id="preview-tablet">{{ tablet_cols|default(2) }}</span></li>
                <li><i class="fas fa-mobile-alt text-gray-400 mr-1"></i>Mobile: <span id="preview-mobile">{{ mobile_cols|default(1) }}</span></li>
              </ul>
            </div>
            <p><strong>PhotoSwipe:</strong> Abilitato</p>
          </div>
        </div>

        <div class="card p-6">
          <div class="flex gap-2">
            <button type="submit" class="btn-primary">Salva Modifiche</button>
            <a href="/admin/templates" class="btn-secondary">Annulla</a>
          </div>
        </div>
      </div>
    </div>
  </form>

  <script>
    // Live preview updates
    const layoutSelect = document.querySelector('select[name="layout"]');
    const desktopSelect = document.querySelector('select[name="columns_desktop"]');
    const tabletSelect = document.querySelector('select[name="columns_tablet"]');
    const mobileSelect = document.querySelector('select[name="columns_mobile"]');
    const masonryCheck = document.querySelector('input[name="masonry"]');
    
    function updatePreview() {
      document.getElementById('preview-layout').textContent = layoutSelect.options[layoutSelect.selectedIndex].text;
      document.getElementById('preview-desktop').textContent = desktopSelect.value;
      document.getElementById('preview-tablet').textContent = tabletSelect.value;
      document.getElementById('preview-mobile').textContent = mobileSelect.value;
      document.getElementById('preview-masonry').textContent = masonryCheck.checked ? 'Sì' : 'No';
    }
    
    layoutSelect.addEventListener('change', updatePreview);
    desktopSelect.addEventListener('change', updatePreview);
    tabletSelect.addEventListener('change', updatePreview);
    mobileSelect.addEventListener('change', updatePreview);
    masonryCheck.addEventListener('change', updatePreview);
  </script>
{% endblock %}